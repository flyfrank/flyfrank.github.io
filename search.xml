<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>动态规划之零一背包问题</title>
    <url>/2021/03/03/algorithm/dong-tai-gui-hua-zhi-ling-yi-bei-bao-wen-ti/</url>
    <content><![CDATA[<h1 id="一、题目"><a href="#一、题目" class="headerlink" title="一、题目"></a>一、题目</h1><p>有 NN 件物品和一个容量为 VV 的背包，每件物品有各自的价值，要求在有限的背包容量下，装入的物品总价值最大。</p>
<p>「0-1 背包」是较为简单的动态规划问题，也是其余背包问题的基础。</p>
<p>动态规划是不断决策求最优解的过程，「0-1 背包」即是不断对第 ii 个物品的做出决策，「0-1」正好代表不选与选两种决定。</p>
<h1 id="二、题目分析"><a href="#二、题目分析" class="headerlink" title="二、题目分析"></a>二、题目分析</h1><blockquote>
<p>关于动态算法，了解的人可能需要2~3分钟，不懂的人可能需要2 ~ 3天，了解动态算法的思想很重要。</p>
</blockquote>
<h2 id="2-1-二维数据解法"><a href="#2-1-二维数据解法" class="headerlink" title="2.1 二维数据解法"></a>2.1 二维数据解法</h2><p>（1）状态f[i][j]定义：前 i 个物品，背包容量 j 下的最优解（最大价值）：</p>
<p>当前的状态依赖于之前的状态，可以理解为从初始状态f[0][0] &#x3D; 0开始决策，有 N 件物品，则需要 N 次决 策，每一次对第 i 件物品的决策，状态f[i][j]不断由之前的状态更新而来。<br>（2）当前背包容量不够（j &lt; v[i]），没得选，因此前 i 个物品最优解即为前 i−1 个物品最优解：</p>
<p>对应代码：f[i][j] &#x3D; f[i - 1][j]。<br>（3）当前背包容量够，可以选，因此需要决策选与不选第 i 个物品：</p>
<p>选：f[i][j] &#x3D; f[i - 1][j - v[i]] + w[i]。<br>不选：f[i][j] &#x3D; f[i - 1][j] 。<br>我们的决策是如何取到最大价值，因此以上两种情况取 max() 。</p>
<h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><pre class="line-numbers language-none"><code class="language-none">public class MyBackpackSolution &#123;
    public static void main(String[] args) &#123;
        int[] weight &#x3D; &#123;2,2,6,5,4&#125;;
        int[] value &#x3D; &#123;6,3,5,4,6&#125;;

        int w &#x3D; 10;

        int n &#x3D; weight.length;
        int[][] maxVal &#x3D; new int[n + 1][w + 1];

        &#x2F;&#x2F; 由于循环从1开始，所以在遍历weight、value数组获取数据时坐标需要减一
        for(int i&#x3D;1; i&lt;&#x3D;n; i++) &#123;
            for (int j&#x3D;1; j&lt;&#x3D;w; j++) &#123;
                if (j &lt; weight[i-1]) &#123;
                    maxVal[i][j] &#x3D; maxVal[i-1][j];
                &#125; else &#123;
                    maxVal[i][j] &#x3D; Math.max(maxVal[i-1][j], maxVal[i-1][j - weight[i-1]] + value[i-1]);
                &#125;
            &#125;
        &#125;
        System.out.println(maxVal[n][w]);
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2-2-一维数组解法"><a href="#2-2-一维数组解法" class="headerlink" title="2.2 一维数组解法"></a>2.2 一维数组解法</h2><p>将状态f[i][j]优化到一维f[j]，实际上只需要做一个等价变形。</p>
<p>为什么可以这样变形呢？我们定义的状态f[i][j]可以求得任意合法的i与j最优解，但题目只需要求得最终状态f[n][m]，因此我们只需要一维的空间来更新状态。</p>
<p>（1）状态f[j]定义：NN 件物品，背包容量j下的最优解。</p>
<p>（2）注意枚举背包容量j必须从m开始。<br>（3）为什么一维情况下枚举背包容量需要逆序？在二维情况下，状态f[i][j]是由上一轮i - 1的状态得来的，f[i][j]与f[i - 1][j]是独立的。而优化到一维后，如果我们还是正序，则有f[较小体积]更新到f[较大体积]，则有可能本应该用第i-1轮的状态却用的是第i轮的状态。</p>
<p>（4）例如，一维状态第i轮对体积为 33 的物品进行决策，则f[7]由f[4]更新而来，这里的f[4]正确应该是f[i - 1][4]，但从小到大枚举j这里的f[4]在第i轮计算却变成了f[i][4]。当逆序枚举背包容量j时，我们求f[7]同样由f[4]更新，但由于是逆序，这里的f[4]还没有在第i轮计算，所以此时实际计算的f[4]仍然是f[i - 1][4]。</p>
<p>（5）简单来说，一维情况正序更新状态f[j]需要用到前面计算的状态已经被「污染」，逆序则不会有这样的问题。</p>
<p>状态转移方程为：f[j] &#x3D; max(f[j], f[j - v[i]] + w[i] 。</p>
<pre class="line-numbers language-none"><code class="language-none">public class MyBackpackSolution1 &#123;
    public static void main(String[] args) &#123;
        int[] weight &#x3D; &#123;2,2,6,5,4&#125;;
        int[] value &#x3D; &#123;6,3,5,4,6&#125;;

        int w &#x3D; 10;

        int n &#x3D; weight.length;

        int[] maxVal &#x3D; new int[w + 1];

        for (int i &#x3D; 1; i&lt;&#x3D; n; i++) &#123;
            for (int j&#x3D;w; j&gt;&#x3D; 1; j--) &#123;
                if (j &lt; weight[i-1]) &#123;
                    maxVal[j] &#x3D; maxVal[j];
                &#125; else &#123;
                    maxVal[j] &#x3D; Math.max(maxVal[j], maxVal[j - weight[i - 1]] + value[i-1]);
                &#125;
            &#125;
        &#125;
        System.out.println(maxVal[w]);
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h1><p>动态规划的核心还是找子问题的最有解，确定状态转移公式：<br>f[i][j]  &#x3D; max(f[i - 1][j],  f[i - 1][j - v[i]] + w[i])</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://www.acwing.com/solution/content/1374/">AcWing 2. 01背包问题（状态转移方程讲解） </a></p>
]]></content>
      <categories>
        <category>算法</category>
      </categories>
      <tags>
        <tag>动态规划</tag>
        <tag>零一背包问题</tag>
      </tags>
  </entry>
  <entry>
    <title>《一分钟经理人》</title>
    <url>/2022/03/23/book/yi-fen-zhong-jing-li-ren/</url>
    <content><![CDATA[<h1 id="一、经典的“自上而下”严密的管理方式存在什么问题？"><a href="#一、经典的“自上而下”严密的管理方式存在什么问题？" class="headerlink" title="一、经典的“自上而下”严密的管理方式存在什么问题？"></a>一、经典的“自上而下”严密的管理方式存在什么问题？</h1><p>经典的“自上而下”的严密的管理方式，能够严格规范员工的行为方式。但是放在今天，这种方式不能激发员工潜力还扼杀创造力。</p>
<h1 id="二、一分钟管理法"><a href="#二、一分钟管理法" class="headerlink" title="二、一分钟管理法"></a>二、一分钟管理法</h1><h2 id="2-1-一分钟目标"><a href="#2-1-一分钟目标" class="headerlink" title="2.1 一分钟目标"></a>2.1 一分钟目标</h2><p>设定一分钟目标：</p>
<ol>
<li>共同制定工作目标， 并清楚简洁地描述出来， 明确好的工作表现的标<br>准。</li>
<li>每个目标都单独写在一张纸上， 并写下完成期限。</li>
<li>规定每天用几分钟时间， 重温自己最重要的目标。</li>
<li>鼓励人们用一分钟时间审视自己的表现， 检查是否与目标一致。</li>
<li>若与目标不一致， 反思自己的工作表现， 以便调整。</li>
</ol>
<h2 id="2-2-一分钟称赞"><a href="#2-2-一分钟称赞" class="headerlink" title="2.2 一分钟称赞"></a>2.2 一分钟称赞</h2><p>进行一分钟称赞：</p>
<h3 id="◆-前半分钟"><a href="#◆-前半分钟" class="headerlink" title="◆ 前半分钟"></a>◆ 前半分钟</h3><ol>
<li>及时称赞下属。</li>
<li>告诉他们对在哪里—要说得非常具体。</li>
<li>告诉他们这件事情做对之后， 会让你感到多么高兴， 对整个团队和其他同事又会有多么大的帮助。</li>
</ol>
<h3 id="◆-停顿一会儿"><a href="#◆-停顿一会儿" class="headerlink" title="◆ 停顿一会儿"></a>◆ 停顿一会儿</h3><ol start="4">
<li>沉默几秒， 让他们静静地体会做对事带来的喜悦。</li>
</ol>
<h3 id="◆-后半分钟"><a href="#◆-后半分钟" class="headerlink" title="◆ 后半分钟"></a>◆ 后半分钟</h3><ol start="5">
<li>鼓励他们以后继续这样做。</li>
<li>明确说明你对他们有信心， 并会支持他们获得成功。</li>
</ol>
<h2 id="2-3-一分钟更正"><a href="#2-3-一分钟更正" class="headerlink" title="2.3 一分钟更正"></a>2.3 一分钟更正</h2><p>如果目标阐述清晰， 进行一分钟更正：</p>
<h3 id="◆-前半分钟-1"><a href="#◆-前半分钟-1" class="headerlink" title="◆ 前半分钟"></a>◆ 前半分钟</h3><ol>
<li>错误发生后立刻进行更正。</li>
<li>确认既有的事实， 分析错在哪里，要说得非常具体。</li>
<li>告诉他们这件事带给你的感受， 以及对工作成果可能造成的影响。</li>
</ol>
<h3 id="◆-停顿一会儿-1"><a href="#◆-停顿一会儿-1" class="headerlink" title="◆ 停顿一会儿"></a>◆ 停顿一会儿</h3><ol start="4">
<li>沉默几秒， 让他们审视所犯的错误。</li>
</ol>
<h3 id="◆-后半分钟-1"><a href="#◆-后半分钟-1" class="headerlink" title="◆ 后半分钟"></a>◆ 后半分钟</h3><ol start="5">
<li>告诉对方， 他们的实际能力比这次表现出来的更强， 你认为他们很不错。</li>
<li>告诉对方， 你对他们有信心， 仍然信任他们。</li>
<li>更正过后， 整件事就过去了。</li>
</ol>
<h1 id="三、一分钟管理法为什么有效？"><a href="#三、一分钟管理法为什么有效？" class="headerlink" title="三、一分钟管理法为什么有效？"></a>三、一分钟管理法为什么有效？</h1><p>在了解到一分钟管理法后，我们应该思考，为什么一分钟管理法有效？</p>
<h2 id="3-1-一分钟目标为什么有效？"><a href="#3-1-一分钟目标为什么有效？" class="headerlink" title="3.1 一分钟目标为什么有效？"></a>3.1 一分钟目标为什么有效？</h2><p>对每个人来说， 不论成功者还是有成功潜力的人， 设定一分钟目标都是提高工作效率的一条最基本的途径。</p>
<h2 id="3-2-一分钟称赞为什么有效？"><a href="#3-2-一分钟称赞为什么有效？" class="headerlink" title="3.2 一分钟称赞为什么有效？"></a>3.2 一分钟称赞为什么有效？</h2><p>训练成功者最重要的是发现他们做对了的事情——开始也许只是大概做对， 接着要逐渐引导他们做得越来越完美。通过一分钟称赞可以帮助人们建立自信，从而达到非常好的状态。</p>
<h2 id="3-3-一分钟更正为什么有效？"><a href="#3-3-一分钟更正为什么有效？" class="headerlink" title="3.3 一分钟更正为什么有效？"></a>3.3 一分钟更正为什么有效？</h2><p>反馈应该是即时的。 一旦你发现下属做错了事， 就要立刻指出来。如果把反馈集中起来，事情太多也不利于员工修正错误，而且有点翻旧账的嫌疑，最后产生争论，最后被批评的一方形成心理戒备，那么最后的反馈是无效的。</p>
<p>如果经理人及时提出意见，被更正的一方可以接受反馈信息。 每次只更正一个行为， 会让人觉得既公平又明确。对于一分钟更新更重要的是后半分钟，我们给员工反馈问题是希望他们修正问题获得成长，而不是贬低他们的价值，所以更正的同时，也要给予肯定和尊重。</p>
<h1 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h1><p>一分钟管理法和之前在《刻意练习》一书中有看到的3F（Focus，feedback，fix it）思想极为相近，其中focus对应着一分钟目标，而feedback和fix it原则正是一分钟更正的体现。一分钟目标，可以让我们能够明确自己的工作目标，从而专注工作；一分钟更正给予我们我们结果的反馈，并修正其中的错误，从而不断成长和进步。</p>
]]></content>
      <categories>
        <category>book</category>
      </categories>
      <tags>
        <tag>一分钟经理人</tag>
      </tags>
  </entry>
  <entry>
    <title>《人间失格》</title>
    <url>/2021/05/30/book/ren-jian-shi-ge/</url>
    <content><![CDATA[<p><img src="/images/%E4%BA%BA%E9%97%B4%E5%A4%B1%E6%A0%BC.jpg" alt="人间失格"></p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p><em><strong>《人间失格》 —— “无赖派”文学大师太宰治饱受争议的破灭之书</strong></em></p>
<blockquote>
<p>[日]太宰治 —— 著<br>杨伟 —— 译</p>
</blockquote>
<p>之前并不了解太宰治，是被书名吸引的才开始读的。在了解到作者的过往经历后，对这本的书的兴趣愈发浓厚。</p>
<p>太宰治的一生充满的传奇色彩，他出身豪门，一生立志文学，师从井伏鳟二等小说名家；大学时代曾积极投身左翼运动，却中途逃脱；生活放荡不羁，却热心于阅读《圣经》；五度自杀，四度殉情未遂，三十九岁时与最后一位情人投水自尽。以至于他说”回收往昔，我的人生充斥着耻辱”（《人间失格》），”生而为人，对不起”（《二十世纪旗手》），”上帝选民的不安与恍惚俱存于吾身”（《叶》）。这些格言式的短语七号成了太宰治人生和文学的最好注脚，也从某个角度勾勒除了他一生的心理轨迹。</p>
<p>《人间失格》一书中的主人公大庭叶藏通过「扮丑」逗笑周围人的来进行「自我救赎」。但是最终承受不住这样的压抑和无奈，在同学堀木的影响下一步一步走向堕落，利用酒精和毒品麻醉神经，用女性的肉体安抚自身的肉体，依靠女人维系基本生活。 太宰治以”私小说”的方式，将自己的一生的投影都折射在叶藏身上。</p>
<p> 读完这本书后，内心仿佛有什么东西被触动了，但是一切又了无痕迹。细细想来可能是在书中看到了自己的些许重影，如对这个人类世界的恐惧。</p>
<blockquote>
<p>我一直对人类畏葸不已，并因这种畏葸而战栗。对自己作为人类一员的言行也毫无自行，只好将独自的懊恼深藏进胸中的小匣子里，将精神上的忧郁和过敏封存起来”，伪装成天真无邪的乐天外表，把自己一步步地彻底打磨成搞笑的畸人。<br>无论如何，只要能让他们发笑。这样一来，即使我处在人们所谓的”生活”之外，也不会引起他们的注意吧。总而言之，不能有碍他们的视线。我是”无”，是”风”，是”空”。诸如此类的想法愈演愈烈，我只能用搞笑来逗家人们开你，甚至在必家人更费解更可怕的男俑和女佣面前，也拼命的提供搞笑服务。</p>
</blockquote>
<p>在与现实生活的斗争中，不断败北的他为自己带上了”丑角”面具来掩盖自己的真实面目，用小时候就惯用的”逗笑” “装模作样”等手法来伪装自己，取悦于他人。但是在现实的摧残下，那种矛盾愈演愈烈，最后变得不可调和，直至最终的自我毁灭。</p>
<p>看到好多评论说，心情好的时候，不要看太宰治的作品，因为那会让你的心情变得不好；心情不好的时候更不要去看太宰治的作品，那会让你糟糕的心情雪上加霜。</p>
<p>看完书不竟想问自己，当某一天，现实生活压的你喘不过气来，当内心的思想与现实产生激烈的矛盾后，我又该何去何从呢？</p>
]]></content>
      <categories>
        <category>book</category>
      </categories>
      <tags>
        <tag>人间失格</tag>
      </tags>
  </entry>
  <entry>
    <title>《你的善良必须有点锋芒》</title>
    <url>/2022/05/15/book/ni-de-shan-liang-bi-xu-you-dian-feng-mang/</url>
    <content><![CDATA[<blockquote>
<p>你的善良，必须有点锋芒，否则等于零 —— 【美】拉尔夫·瓦尔多·爱默生</p>
</blockquote>
<p><img src="/images/book/%E4%BD%A0%E7%9A%84%E5%96%84%E8%89%AF%E5%BF%85%E9%A1%BB%E6%9C%89%E7%82%B9%E9%94%8B%E8%8A%92.jpeg" alt="你的善良必须有点锋芒"></p>
<h1 id="写在前面的话"><a href="#写在前面的话" class="headerlink" title="写在前面的话"></a>写在前面的话</h1><p>曾经听到过这样的一句话：<code>God helps those who help themselves</code>,翻译后的意思是：上帝只救自救者。佛经有一句相似的话：众生皆苦，唯有自渡。随着成长我开始逐渐理解这两句话的意思，想要追寻幸福的人生，必须要学会<code>自救</code>或者<code>自渡</code>。在成长的道路上，我们会遇见许多迷茫和困惑，阻碍我们的前进和成长之路，或许我们都希望有人能够帮助我们克服困难，但是问题的根本原因是我们始终过不去自己心中的那一关，就这样不断陷入内心的煎熬之中。看到这本书的时候一下子就被这本书的名字吸引，但是书阅读后发现，书中的内容犹如空中楼阁，这里更建议大家去读：<a href="https://www.mpoom.cn/2021/02/10/book/bei-tao-yan-de-yong-qi/">《被讨厌的勇气》</a>、<a href="https://www.mpoom.cn/2021/02/11/book/ke-ai-de-zu-zhou/">《可爱的诅咒》</a>以及《自卑与超越》，这些书籍结合心理学的知识，分析了问题的本质，结合切实的案例提供了解决之法。虽然这本书中更多是鸡汤，但是书中提到的很多现象值得我们思考探讨一下。</p>
<h1 id="诚知此恨人人有，贫贱夫妻百事哀"><a href="#诚知此恨人人有，贫贱夫妻百事哀" class="headerlink" title="诚知此恨人人有，贫贱夫妻百事哀"></a>诚知此恨人人有，贫贱夫妻百事哀</h1><blockquote>
<p>《遣悲怀三首·其二》</p>
<p>唐·元稹</p>
<p>昔日戏言身后事，今朝都到眼前来。</p>
<p>衣裳已施行看尽，针线犹存未忍开。</p>
<p>尚想旧情怜婢仆，也曾因梦送钱财。</p>
<p>诚知此恨人人有，贫贱夫妻百事哀。</p>
</blockquote>
<p>在婚姻和家庭话题中，我们经常会听到一句话：<code>贫贱夫妻百事哀</code>，这句话从字面意思理解是：夫妻家庭生活经济条件差、生活窘迫，因各种琐事而矛盾重重。但是这句诗的原文出自唐代诗人元稹《遣悲怀三首·其二》,《遣悲怀三首》是作者伤悼已故的原配妻子，最后一句大意为：虽然我知道这种阴阳相隔的悲恨人人都会有,但一想起我们做贫贱夫妻的每一件事情都会让我特别悲哀。之前在没有了解这句诗的原文出处的时候，也是望文生义的去用。现在每次听到这句话都忍不住想给对方友情提示一下，但是有时候想想又觉得没必要，说出去无非是在卖弄知识，从字面理解确实没毛病，而且强行解释对于正在交谈的话题本身无实质性帮助。这里本着分享的态度，希望大家了解到这句话的原意。</p>
<h1 id="一、你以为的善良，其实知识懦弱"><a href="#一、你以为的善良，其实知识懦弱" class="headerlink" title="一、你以为的善良，其实知识懦弱"></a>一、你以为的善良，其实知识懦弱</h1><p>每个人都曾遇到过不好意思拒绝别人的情况，其中原因有很多，或是怕对方失望不想伤害对方，或是不想违背对方意愿，或是不想打破自己“好人”的人设等等，但是我们仔细回顾我们因为自己的“善意”没有拒绝别人的最后结果是我们真正想要的吗？</p>
<h2 id="1-1-”善意“的拒绝"><a href="#1-1-”善意“的拒绝" class="headerlink" title="1.1 ”善意“的拒绝"></a>1.1 ”善意“的拒绝</h2><p>你“善意”的拒绝往往可能会真正的伤害到别人。比如别人邀请你参与一个聚会时，你内心是不想去的，但是又不忍直接拒绝，所以推辞说有个重要的事要参做抽不开身，结果别人以为你想要来而没有时间，商量过后推迟了时间重新邀请你，这时你发现不忍再找理由拒绝，不得不去参加这个你不想去的聚会。另一种情况是你编了一个蹩脚的谎言说你工作忙去不了，却因机缘巧合，被别人撞见了说是要工作但是却在逛街的你，谎言被无情的拆穿，在对方的印象里，你是一个宁愿去逛街也不愿去参加他聚会的人。</p>
<p>”善意“的拒绝有时会给对方带来更大的伤害，所以表达你真实的想法，直接拒绝掉会更好。如果真的是很好的朋友，他会站在你的立场上思考理解你的决定。反之如果因为你的一次拒绝，对方就和你断绝关系往来，那么你就有必要思考，对方是否是你真正的朋友，对方是否值得你为他花费这些时间？</p>
<h2 id="1-2-”恶意“的拒绝"><a href="#1-2-”恶意“的拒绝" class="headerlink" title="1.2 ”恶意“的拒绝"></a>1.2 ”恶意“的拒绝</h2><p>在我们想着如何拒绝别人的时候，我们有时也会遭遇拒绝，但是大多情况下，我们请求别人的时候都会有被拒绝的心理预期，所以即使被拒绝，我们也不会太难过。但是有些”恶意“的拒绝，会让人气的火冒三丈，比如：我们请求别人办事时，对方提出各种各样的要求，当我们排除万难达到要求之后，对方却说他办不了。遇到这种情况，我只想问对方祖坟在哪？</p>
<blockquote>
<p>声明一下，作为一个现代文明人，刨别人祖坟这事我可做不出来，除非是太生气了</p>
</blockquote>
<h2 id="1-3-维持“好人”人设"><a href="#1-3-维持“好人”人设" class="headerlink" title="1.3 维持“好人”人设"></a>1.3 维持“好人”人设</h2><p>从小我们就被教育要成为一个“好人”，要扶老奶奶过马路，在公交车上主动给有需要的人让座等。不知道大家有没有遇到过这样的情况，当你坐公交车时，车上上来几位老人站在你的旁边。要是在平时你肯定会主动让座，但是由于今天身体不舒服，你也需要这个座位，但是不让座又违背了自己心中“好人”的人设，听到公交车上播放的录音：“尊老爱幼是中华民族的传统美德”时更是如芒在背，遭受着肉体和心灵的双重折磨。</p>
<p>“好人”最难的是跨越自己心中的那道坎，但是从事实来看，我们是在做好人好事，还是在委曲求全？”好人“往往容易被道德或规则所束缚，所以当你发现做”好人“要委屈自己的时候，那么你就应该停下来，尝试表达自己真实的感受，而不是委屈自己。</p>
<h2 id="1-4-寻求认同"><a href="#1-4-寻求认同" class="headerlink" title="1.4 寻求认同"></a>1.4 寻求认同</h2><p>社会心理学中提到一个现象，当我们身处一个集体之中时我们丧失自主思维，会主动寻求集体的认同，即使有时候不同意，也不会公然反对，因为我们不想成为最碍眼的那一个。所以当我们身处集体之中时，为了寻求认同而答应了我们平时会拒绝的请求。这种情况下，我们必须有个强大的内心，更要认清一个事实，无论你怎样做，你都没办法保证集体中的每一个人都满意。即使是美国总统，他们也没有获得百分百的选票的。我们必须要弄清哪一部分是我们可以争取到的人，哪一部分是我们无论如果都无法争取到的人，把努力用在可以争取的人身上。</p>
<h1 id="二、吃亏是福"><a href="#二、吃亏是福" class="headerlink" title="二、吃亏是福"></a>二、吃亏是福</h1><p>我妈从小教我了一个道理；”少沾光，多吃亏“，这个道理我从小践行，到现在帮我结交到一群可以信赖的朋友。如今我对这句话有了更深层次的理解，那就是”学会付出和奉献“。人际交往的本质是利益交换，一味的索取只会让周围的人远离你，所以在最初时的交往过程中，我们必须要学会付出，在付出和索取之间尽量达成平衡，直到我们在不断的公平交易中建立信任以后，我们才可以抛开等价交换来保持人际交往了。</p>
<p>所以在没有建立信任关系的时候，我们尽量遵循等价交换的原则进行索取和付出，否则往往会导致关系的破裂，索取的太多对方不满意，付出的太多自己不满意。在起初的利益交换中，如果你更愿意优先付出，那么对信任的建立以及信任的牢固程度非常有益，这是我所理解的：”少沾光，多吃亏“。</p>
<p>对于我们周围那些只知道一味索取的人，在早期的交往过程中发现后，清尽早远离，因为这注定是一场不公平的交易。</p>
<h1 id="三、过度牺牲式的付出不是爱"><a href="#三、过度牺牲式的付出不是爱" class="headerlink" title="三、过度牺牲式的付出不是爱"></a>三、过度牺牲式的付出不是爱</h1><p>一个女人为了支持丈夫求学深造放弃了自己的晋升机会，后面为了支持丈夫的工作毅然辞去了工作成为家庭主妇，但是最终却换来了丈夫的离婚请求。在生活中我们也经常听到这样的话：“我为你付出了这么多，你却这么对我”。之前我是一直不懂，但是如今我有了一些理解，那就是 —— 心灵不能承受之重。很多时候牺牲式的付出，成为了接受付出者的心理负担，使得双发不能再以平等的方式相处，反而变得像老板与员工的关系。付出的一方在想我为你付出了那么多，你的表现必须符合我的预期；而接受付出的一方内心除了感激，反而会承担更大的压力。一方面因为你的付出会产生了挫败感，另一方面他必须处在高压之下努力奋斗，防止你的牺牲和付出白费。</p>
<blockquote>
<p>作为一个北方人，和朋友一起出去吃饭一般都是你买一次单我买一次单，轮流着来，大致公平即可。然而每次和大学室友出去吃饭买单后，他总要AA转给我，我说下次他买单就行，不用转了，但是他就是不同意，可恶，每次都被他AA了，好不甘啊。后来吃饭时，也和他聊到这个问题，为啥非要AA呢？他说如果没有AA还得记在心里，下次吃饭指不定是在什么时候呢？AA后就不用那么麻烦了，所以有时候你的付出反而会成为别人的心里负担。很多时候我确实应该像我的室友学习一下，不要“下次一定”，而是这次一定。</p>
</blockquote>
<p>过度牺牲式的付出不是爱，反而像绑架一般，结局往往是一个悲剧。之前也和张英俊同学讨论过这个话题，付出的时候你需要考虑对方是否能够坦然的接受你的付出，其中的核心是你的付出能否让你们保持一个平等的关系相处，如果是，那么换来的则是对方的感激，否则换来的是对方的挫败感而且使对方产生心里负担。</p>
<h1 id="四、认识自我"><a href="#四、认识自我" class="headerlink" title="四、认识自我"></a>四、认识自我</h1><p>之前看到过一句话叫：和过去的自己和解，想要做到这一点，我们先要去认识自己，盲目的和解或放下只是在逃避而已。我们很多时候都任由情绪把控自己，做出了违背我们内心想法的行为。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>这本书想表达的是要成为一个有原则的人，当我们的原则受到挑战或被打破时，我们就要进行<code>fight</code>。当我们还缺失某些原则的时候，我们要尝试去建立这些的原则。</p>
<p>此外，这本书是一本心灵鸡汤类的书籍，能引起你的共鸣，但是无法切实的帮助你解决问题。而且我发现心灵鸡汤类的书籍的缺点是往往只分析了现象，而且是面向结果的，所以往往能引起你的共鸣，但是不能帮助你解决实际问题。而当你恢复冷静后又要面对现实与书中结果的巨大落差，从而产生深深的挫败感。而我所看过的干货书籍，它们是分析现象及原因，并且面向过程提供了切实可行的解决方案，所以心灵鸡汤还是要少读。</p>
]]></content>
      <categories>
        <category>book</category>
      </categories>
      <tags>
        <tag>你的善良必须有点锋芒</tag>
      </tags>
  </entry>
  <entry>
    <title>《关键对话：如何高效能沟通》</title>
    <url>/2023/07/03/book/guan-jian-dui-hua/</url>
    <content><![CDATA[<p><img src="/2023/07/03/book/guan-jian-dui-hua/%E5%85%B3%E9%94%AE%E5%AF%B9%E8%AF%9D%E7%AB%A0%E8%8A%82.png" alt="关键对话"></p>
<blockquote>
<h1 id="第1章-何谓关键对话"><a href="#第1章-何谓关键对话" class="headerlink" title="第1章　何谓关键对话"></a>第1章　何谓关键对话</h1></blockquote>
<h2 id="关键对话的价值"><a href="#关键对话的价值" class="headerlink" title="关键对话的价值"></a>关键对话的价值</h2><p>沟通最大的问题在于，人们想当然地认为已经沟通了。当结果充满风险、观点背道而驰、双方情绪激烈时，普通的对话便会升级为关键对话。充满讽刺意味的是，对话内容越关键，我们正确处理问题的能力就越差。事实证明，逃避对话或是把对话搞砸都会带来非常严重的后果。当我们无法正确处理关键对话时，生活中所有重要的方面都会因此受到不利影响，其中包括我们的事业、圈子、人际关系，甚至是我们的身体健康。</p>
<h2 id="关键对话的定义"><a href="#关键对话的定义" class="headerlink" title="关键对话的定义"></a>关键对话的定义</h2><p>关键对话指的是两人或多人之间的一种讨论，这种讨论具有三个特点：</p>
<ol>
<li>高风险</li>
<li>不同观点</li>
<li>激烈情绪</li>
</ol>
<h2 id="关键对话的难点"><a href="#关键对话的难点" class="headerlink" title="关键对话的难点"></a>关键对话的难点</h2><p>这就是我们在面对关键对话时的真实状态——棘手的问题、不依不饶的对手、高度缺血的大脑和无法正常工作的思维。这就是为什么我们平素表现得正常得体，可面对关键对话时却会变成十足的白痴。</p>
<p>当面对充满挑战的关键对话时，你的智力水平跟一只恒河猴差不了多少。你的身体准备应对的是一只剑齿虎的攻击，而不是什么老板、邻居或老公的批评指责。</p>
<blockquote>
<h1 id="第2章-掌握关键对话"><a href="#第2章-掌握关键对话" class="headerlink" title="第2章　掌握关键对话"></a>第2章　掌握关键对话</h1></blockquote>
<h2 id="探索人们用来营造对话环境的技巧"><a href="#探索人们用来营造对话环境的技巧" class="headerlink" title="探索人们用来营造对话环境的技巧"></a>探索人们用来营造对话环境的技巧</h2><p>我们要关注的是如何看待问题情形以及该怎样做好对话准备。通过自我检视、观察问题、思维分析、方式研究、抓住核心，在此过程中对话双方都会因此受益。</p>
<h2 id="讲述、聆听和行动的技巧"><a href="#讲述、聆听和行动的技巧" class="headerlink" title="讲述、聆听和行动的技巧"></a>讲述、聆听和行动的技巧</h2><p>我该怎样表达微妙信息？怎样陈述观点有说服力，不会令人讨厌？如何聆听对方的表达？更重要的是，怎样做才能让对方在紧张不安的情况下说出内心真实想法？怎样才能把思想转变成行动？这些技巧们都会一一向大家讲述。</p>
<blockquote>
<h1 id="第3章-从“心”开始-如何确定目标"><a href="#第3章-从“心”开始-如何确定目标" class="headerlink" title="第3章　从“心”开始　如何确定目标"></a>第3章　从“心”开始　如何确定目标</h1></blockquote>
<p>从“⼼”开始，即审视你的内 ⼼。如果你⽆法正确认识⾃我，那肯定⽆法展开正确的对话。当⾯对 关键对话时，你会下意识地采⽤多年来形成的沟通习惯——争辩不 休、沉默不语、⾃以为是……</p>
<h2 id="关键对话的“第一个问题”"><a href="#关键对话的“第一个问题”" class="headerlink" title="关键对话的“第一个问题”"></a>关键对话的“第一个问题”</h2><p>我们的问题并不是行为本身是错误的，而是我们的动机有问题，即我们常常弄错要面对的目标。<br>因此，要想解决问题，我们要做的第一步是改变错误的观点，即认为我们的苦恼是由他人导致的。我们总是简单地认为：“只要能搞 定‘⿇烦制造者’，⼀切问题都会好起来。”实际上，正是这种错误的念 头在阻⽌我们利⽤对话⽅式解决问题。明⽩了这⼀点，你就不会奇怪 为什么对话⾼⼿总是能制造奇迹了。这是因为他们坚信，要想解决 好“双⽅”的问题，只能从“⾃⼰”开始，在⾃我⾝上找原因。</p>
<h2 id="审视⾃我的意义"><a href="#审视⾃我的意义" class="headerlink" title="审视⾃我的意义"></a>审视⾃我的意义</h2><p>诚然，⾯对⽣活中⽆穷⽆尽的各种正⾯冲突，有时我们只是毫不相⼲的旁观者，但这并不表⽰我们⼀点责任都没有。很多情况下，其实我们正是给⾃⼰带来烦恼的原因之⼀。 </p>
<p>对话⾼⼿们⾮常明⽩这⼀点，并在此基础上形成了审视⾃我的原则。他们不但认识到实践这条原则能让⾃⼰受益，⽽且深知能够改变的⼈只有他们⾃⼰。正如我们认为别⼈应该做出改变⼀样，实际上我们能够成功启发、激励和塑造的⼈只有⼀个，就是镜⼦中的⾃⼰。 </p>
<p>虽然这只是⼀个简单的事实，但其中却饱含着某种讽刺意味，即只有那些相信“改变从⾃我做起”的⼈才会真正实践这条原则。当他们 这样去做时，结果⽆⼀例外地都成了技巧⾼超的对话⾼⼿。看，这就 是讽刺之处，那些努⼒提⾼对话技巧的⼈恰恰是最有天分、善于解决问题的⼈，⽽不是能⼒不⾜的问题解决者。这就像⽼话所说的那样， 富者越富，贫者越贫，原因是富裕者会更加努⼒，⽽贫穷者已经习惯了得过且过。</p>
<h2 id="从“心”开始"><a href="#从“心”开始" class="headerlink" title="从“心”开始"></a>从“心”开始</h2><p>尽管我们很难把⼈际互动中诸多事件的特定顺序描述得像关键对话那样清晰流畅，但有⼀点我们是确定⽆疑的，即对话⾼⼿总是能做到从“⼼”开始。换句话说，在展开⾼⻛险对话时，他们总是⾸先明确⽬的和动机，⽆论出现什么情况这个⽬的都不会动摇。</p>
<h3 id="关注⽬标的两个表现"><a href="#关注⽬标的两个表现" class="headerlink" title="关注⽬标的两个表现"></a>关注⽬标的两个表现</h3><blockquote>
<p>⾸先，他们⾮常清楚⾃⼰希 望通过对话获得什么。在对话过程中，⽆论出现多少可能转移注意⼒的情况，他们依然能坚守⾃⼰的⽬标。<br>其次，对话⾼⼿从来不做“傻⽠式选择”（即⾮此即彼、⾮⿊即⽩式的选择）。</p>
</blockquote>
<p>和那些错误地认为只能“逃避或对抗”的问题解决者不同，对话⾼⼿认为，⽆论出现多么棘 ⼿的情况，对话永远都是⼀种可⾏的选择。</p>
<h2 id="真实案例"><a href="#真实案例" class="headerlink" title="真实案例"></a>真实案例</h2><blockquote>
<h3 id="战胜对方"><a href="#战胜对方" class="headerlink" title="战胜对方"></a>战胜对方</h3><p>⽣活就是⼀个巨⼤的竞技场，⾥⾯有⽆穷⽆尽的⽐赛，我们必须时刻不停地和⾝边 的⼈展开竞争。可以说，我们早在懵懂未知的年纪就已经形成了要战 胜他⼈的欲望。</p>
</blockquote>
<blockquote>
<p>不幸的是，随着我们慢慢⻓⼤，⼤多数⼈并没有意识到这种欲望 正把我们拉得越来越远，早已忘记了利⽤健康对话解决问题的⽅式。 的确，我们的初始⽬标是想解决问题，但每次只要有⼈提出反对或质 疑的声⾳，我们转眼间便会把初始⽬标忘得⼀⼲⼆净。</p>
</blockquote>
<blockquote>
<h3 id="惩罚对⽅"><a href="#惩罚对⽅" class="headerlink" title="惩罚对⽅"></a>惩罚对⽅</h3><p>有时候，随着愤怒情绪的增⻓，我们的⼼态会从希望 战胜对⽅转变为蓄意伤害对⽅。例如，格瑞塔就是这么想的：“去他的 坦诚沟通吧，看我不好好修理你这个⽬中⽆⼈的⽩痴！”当这种负⾯情绪达到顶峰时，我们的⽬标会变得⾮常邪恶。此时此刻，我们早就把 什么共享观点库抛到了九霄云外，⼀⼼只想着给对⽅制造痛苦。</p>
</blockquote>
<h2 id="关注你的真正目的"><a href="#关注你的真正目的" class="headerlink" title="关注你的真正目的"></a>关注你的真正目的</h2><ul>
<li>发现自己即将陷入沉默或暴力状态时，停止对话，冷静思考你的动机。</li>
<li>问自己这样一个问题：“我现在的行为显示出我的动机是什么？”</li>
<li>明确你的真正目的，问自己：“我想为自己、他人和人际关系做些什么？”</li>
<li>最后，问自己：“如果这是我的真正目的，我该怎么做？”</li>
</ul>
<h2 id="拒绝“傻瓜式选择”"><a href="#拒绝“傻瓜式选择”" class="headerlink" title="拒绝“傻瓜式选择”"></a>拒绝“傻瓜式选择”</h2><ul>
<li>在分析行为目的时，留意在哪些情况下你会说服自己做出“傻瓜式选择”。</li>
<li>留意你是否总是告诉自己必须在说实话和顾面子之间、在成与败之间做出两极化选择。</li>
<li>利用对比说明的方式消除“傻瓜式选择”的影响。</li>
<li>说出你希望的目的之后，明确你不希望实现的目的，然后开动脑筋寻找可以实现对话的健康方式。</li>
</ul>
<blockquote>
<h1 id="第4章-注意观察-如何判断对话氛围是否安全"><a href="#第4章-注意观察-如何判断对话氛围是否安全" class="headerlink" title="第4章　注意观察　如何判断对话氛围是否安全"></a>第4章　注意观察　如何判断对话氛围是否安全</h1></blockquote>
<h2 id="留意对话气氛"><a href="#留意对话气氛" class="headerlink" title="留意对话气氛"></a>留意对话气氛</h2><p>实际上，我们很多⼈都不具备“双路处理”能⼒（即同时关注对话 内容和对话⽓氛两⽅⾯），当对话⻛险很⾼、双⽅情绪激动的时候更是如此。我们往往深陷于对话内容⽆法⾃拔，⼏乎不可能腾出精⼒去 观察⾃⼰和对⽅会有哪些细微的变化。<br>在关键对话过程中你必须关注以下三种因素：</p>
<ol>
<li>对话陷入危机的时刻，</li>
<li>对方失去安全感的信号（即表现出沉默或暴力倾向）</li>
<li>以及你应对压力的方式</li>
</ol>
<h2 id="学会识别关键对话"><a href="#学会识别关键对话" class="headerlink" title="学会识别关键对话"></a>学会识别关键对话</h2><p>⾸先，当对话从正常讨论变成激烈争执时，你就必须留意了。同样，在和对⽅展开棘⼿的对话时，你必须⼩⼼翼翼地应对，就好像进⼊布满地雷的危险地带⼀样。<br>为了尽早发现问题，你应当调整⾃⼰的思路，注意那些标志关键 对话的信号。例如，⾯对关键对话时，有些⼈会出现⽣理信号，如胃部不适、双眼发⼲等。你可以想想看，当对话陷⼊危机时你的⾝体会有什么反应。在⽣理反应⽅⾯，每个⼈的表现都不太⼀样，你会是哪种反应呢？不管是哪种情况，你都应当将其视为危险信号，命令⾃⼰暂时后退，放慢节奏，在重新掌控局⾯之前认真审视⾃我。 </p>
<p>有些⼈善于关注⾃⼰的情绪反应，随后才会留意⽣理上的变化。 他们会感到害怕、受伤或愤怒，然后努⼒做出反应或是抑制这些感 受。这些情绪也是很好的指⽰器，能告诉你什么时候该后退、放慢节奏，让⼤脑回归理性思考。 </p>
<p>还有些⼈善于关注⾏为⽅式的细微变化。对他们来说，这些变化 更像是⼀种体外感受。他们会发现⾃⼰提⾼嗓门，对别⼈指⼿画脚， 或是变得⾮常安静。只有当意识到这些信号时，他们才认识到⾃⼰的感受发⽣了变化。</p>
<h2 id="学会关注安全问题的信号"><a href="#学会关注安全问题的信号" class="headerlink" title="学会关注安全问题的信号"></a>学会关注安全问题的信号</h2><p>当对话陷⼊危机时，如果你能及时发现相关的信号，摆脱对对话内容⽆休⽌的争论，这时你就可以同时关注对话的两个⽅⾯了。<br>只有在安全的对话⽓氛中，你才可以畅所欲⾔。这就是对话⾼⼿ 总是密切关注安全问题的原因。顾名思义，对话需要双⽅实现观点的⾃由交流。</p>
<p>你不但能意识到对话会在什么情况下陷入危机，而且能调动自己的大脑解决问题。如前所述，当我们出现激烈情绪时，重要的大脑机能会停止工作，体内的化学激素会迫使你做出逃跑准备，就连你的视野范围也会变得非常狭隘。实际上，当你感到受到严重威胁时，除了自我防御之外你顾不了其他。</p>
<h2 id="学会关注压力应对方式"><a href="#学会关注压力应对方式" class="headerlink" title="学会关注压力应对方式"></a>学会关注压力应对方式</h2><p>在和他人陷入激烈争论时，大部分人都很难摆脱话题的牵引，毕竟你又不能跳出自己的身体客观地观察自我，谁让我们的眼睛无法审视自己呢。 </p>
<h2 id="注意观察"><a href="#注意观察" class="headerlink" title="注意观察"></a>注意观察</h2><ul>
<li>观察对话内容和对话气氛。</li>
<li>观察对话内容和对话气氛。</li>
<li>观察安全问题、</li>
<li>观察对方是否进入沉默或暴力应对的状态</li>
<li>观察你的错误应对方式会在什么情况下出现</li>
</ul>
<blockquote>
<h1 id="第5章-保证安全-如何让对方畅所欲言"><a href="#第5章-保证安全-如何让对方畅所欲言" class="headerlink" title="第5章　保证安全　如何让对方畅所欲言"></a>第5章　保证安全　如何让对方畅所欲言</h1></blockquote>
<h2 id="努力关注共同目的出现危机的信号。"><a href="#努力关注共同目的出现危机的信号。" class="headerlink" title="努力关注共同目的出现危机的信号。"></a>努力关注共同目的出现危机的信号。</h2><p>寻找共同性，相互尊重——对话持续因素<br>诚然，缺少共同目的无法启动关键对话，但互相尊重也同样重要，没有它我们就无法维持关键对话<br>因此，互相尊重可以说是对话的持续因素。如果用一个形象的比喻来说，尊重感就像空气，当它存在时，没有人会想到它。但是，当你把它拿走，人们脑袋里面想的就只有尊重。</p>
<h2 id="暂停对话"><a href="#暂停对话" class="headerlink" title="暂停对话"></a>暂停对话</h2><p>当对方出现沉默或暴力应对的情况时，你应当暂停对话，营造安全气氛。安全感一旦恢复，你就可以继续进行对话了<br>其中情绪变化是一个关键线索。当人们感到不受尊重时，他们会变得非常情绪化，从恐惧变得愤怒异常</p>
<h2 id="怎样才能实现这些目标呢？"><a href="#怎样才能实现这些目标呢？" class="headerlink" title="怎样才能实现这些目标呢？"></a>怎样才能实现这些目标呢？</h2><p>介绍三种非常有效的应对技巧。它们分别是：</p>
<ul>
<li>道歉</li>
<li>对比说明</li>
<li>创建共同目的</li>
</ul>
<h3 id="共同目的"><a href="#共同目的" class="headerlink" title="共同目的"></a>共同目的</h3><ul>
<li>对方是否觉得你在对话过程中关注他们的目的？是否认同你的对话动机？</li>
<li>在达成共同目的之前，你必须首先了解对方的真正目的是什么。因此，你应当暂停先前的对话内容（因为它关注的是策略），转而探索策略背后隐藏的目的</li>
<li>当你成功区分策略和目的之后，新的选择自然就会出现。放松对行动策略的关注，强调你的真正目的，这样可以帮助你拓展思维空间，找到对双方都有利的选择方案</li>
</ul>
<h3 id="对比法"><a href="#对比法" class="headerlink" title="对比法"></a>对比法</h3><ul>
<li>对比法可提供背景和平衡</li>
<li>对比法可预防或救急</li>
</ul>
<h3 id="真诚道歉"><a href="#真诚道歉" class="headerlink" title="真诚道歉"></a>真诚道歉</h3><p>当然，如果内心没有真正意识到这一点，口头上的道歉并不是真诚的道歉。要想做出真诚道歉，你必须改变自己的动机，放弃什么面子、争强好胜以及“只有我是正确的”之类的错误想法，学会关注自己的真正目的<br>利用对比法消除误会</p>
<h3 id="营造安全氛围永远是第一位的"><a href="#营造安全氛围永远是第一位的" class="headerlink" title="营造安全氛围永远是第一位的"></a>营造安全氛围永远是第一位的</h3><ul>
<li>积极寻找共同目的</li>
<li>积极寻找共同目的</li>
<li>积极寻找共同目的</li>
<li>和对方共同构思新策略</li>
</ul>
<blockquote>
<h1 id="第6章-控制想法-如何在愤怒、恐惧或受伤的情况下展开对话"><a href="#第6章-控制想法-如何在愤怒、恐惧或受伤的情况下展开对话" class="headerlink" title="第6章　控制想法　如何在愤怒、恐惧或受伤的情况下展开对话"></a>第6章　控制想法　如何在愤怒、恐惧或受伤的情况下展开对话</h1></blockquote>
<h2 id="掌控情绪"><a href="#掌控情绪" class="headerlink" title="掌控情绪"></a>掌控情绪</h2><p>实际上其他人是无法让你陷入某种情绪的，是你制造了自己的情绪，是你让自己感到害怕、烦恼或气愤，产生负面情绪后你只有两个选择，要么控制它，要么被它控制。<br>你应当坚信的是，我们不但能够做到这一点，而且必须做到这一点。世事本无好坏，皆因思想使然。<br>毫无疑问，了解自己的感受至关重要，要做到这一点，你应当学会用更准确的词汇来形容情绪感受</p>
<h2 id="情绪模式"><a href="#情绪模式" class="headerlink" title="情绪模式"></a>情绪模式</h2><p>第一种小聪明是受害者想法：大反派想法——“这都是你造成的<br>第二种无助者想法：当你不再把自己视为无助者时，就可以积极承担对话责任，而不是一味抱怨问题了</p>
<h2 id="行为方式回顾"><a href="#行为方式回顾" class="headerlink" title="行为方式回顾"></a>行为方式回顾</h2><h3 id="我是否陷入了沉默或暴力应对方式？"><a href="#我是否陷入了沉默或暴力应对方式？" class="headerlink" title="我是否陷入了沉默或暴力应对方式？"></a>我是否陷入了沉默或暴力应对方式？</h3><p>确定行为背后的感受。学会准确识别行为背后的情绪。</p>
<h3 id="导致这种行为的情绪感受是什么？"><a href="#导致这种行为的情绪感受是什么？" class="headerlink" title="导致这种行为的情绪感受是什么？"></a>导致这种行为的情绪感受是什么？</h3><p>分析感受背后的想法。学会质疑你的结论，寻找感受背后其他的可能解释。</p>
<h3 id="造成这种情绪出现的想法是什么？"><a href="#造成这种情绪出现的想法是什么？" class="headerlink" title="造成这种情绪出现的想法是什么？"></a>造成这种情绪出现的想法是什么？</h3><p>寻找想法背后的事实。回到事实本身，放弃绝对表达，区别客观事实和主观想法的区别。</p>
<h3 id="形成这种想法的事实依据是什么？"><a href="#形成这种想法的事实依据是什么？" class="headerlink" title="形成这种想法的事实依据是什么？"></a>形成这种想法的事实依据是什么？</h3><p>注意似是而非的“小聪明”式想法。尤其是受害者想法、大反派想法和无助者想法。</p>
<h2 id="改变主观臆断"><a href="#改变主观臆断" class="headerlink" title="改变主观臆断"></a>改变主观臆断</h2><ul>
<li>我是否故意忽略自己在这个问题中的责任？</li>
<li>一个理智而正常的人为什么会这样做？</li>
<li>我的真实目的是什么？</li>
<li>要想实现这些目的现在我该怎么做？</li>
</ul>
<blockquote>
<h1 id="第7章-陈述观点-如何循循善诱而非独断专行"><a href="#第7章-陈述观点-如何循循善诱而非独断专行" class="headerlink" title="第7章　陈述观点　如何循循善诱而非独断专行"></a>第7章　陈述观点　如何循循善诱而非独断专行</h1></blockquote>
<h2 id="保证关键对话安全"><a href="#保证关键对话安全" class="headerlink" title="保证关键对话安全"></a>保证关键对话安全</h2><p>首先认真审视自我，密切关注关键对话（特别是当对方感到失去安全感时），在必要的时候恢复安全气氛，还有就是千万不要为自己的情绪寻找错误的借口</p>
<h2 id="采用综合陈述法"><a href="#采用综合陈述法" class="headerlink" title="采用综合陈述法"></a>采用综合陈述法</h2><ol>
<li>分享事实经过。从最少争议、最有说服力的事实谈起。</li>
<li>说出你的想法。说明你根据这些事实得出的结论。</li>
<li>征询对方观点。鼓励对方说出他们看到的事实和产生的想法。·</li>
<li>做出试探表述。承认这些结论只是你的想法，不要假装是事实。鼓励做出尝试。</li>
<li>创建安全感，鼓励对方说出不同甚至对立的观点。</li>
</ol>
<blockquote>
<h1 id="第8章-了解动机-帮助对方摆脱沉默或暴力状体"><a href="#第8章-了解动机-帮助对方摆脱沉默或暴力状体" class="headerlink" title="第8章　了解动机　帮助对方摆脱沉默或暴力状体"></a>第8章　了解动机　帮助对方摆脱沉默或暴力状体</h1></blockquote>
<h2 id="了解动机"><a href="#了解动机" class="headerlink" title="了解动机"></a>了解动机</h2><p>要想鼓励观点的自由交流，帮助对方摆脱沉默或暴力的错误应对方式，你应当了解他们的行为动机，应当在对话中表现出巨大的好奇心和耐心，只有这样才能恢复安全感。</p>
<h2 id="四种有效的倾听技巧"><a href="#四种有效的倾听技巧" class="headerlink" title="四种有效的倾听技巧"></a>四种有效的倾听技巧</h2><ol>
<li>询问观点。表明你很有兴趣了解对方的看法。</li>
<li>确认感受。通过表示高度理解对方的感受增强安全感。</li>
<li>重新描述。当对方说出自己的看法时，你应当重述他们的表达，表明自己不但理解其观点，而且鼓励他们分享内心的想法。</li>
<li>主动引导。如果对方还是退缩迟疑，你应当“先发制人”，对他们的想法或感受做出最符合情况的猜测。</li>
</ol>
<h2 id="倾听的注意事项"><a href="#倾听的注意事项" class="headerlink" title="倾听的注意事项"></a>倾听的注意事项</h2><ul>
<li>赞同。在分享观点时对他人表示赞同。</li>
<li>补充。如果对方的观点有遗漏之处，赞同你们共享的部分，然后做出补充。</li>
<li>比较。当你们的观点相差甚远时，不要简单地认为对方是错误的，而应当把你们的看法进行比较。</li>
</ul>
<blockquote>
<h1 id="第9章-开始行动-如何把关键对话变成行动结果"><a href="#第9章-开始行动-如何把关键对话变成行动结果" class="headerlink" title="第9章　开始行动　如何把关键对话变成行动结果"></a>第9章　开始行动　如何把关键对话变成行动结果</h1></blockquote>
<h2 id="开始行动"><a href="#开始行动" class="headerlink" title="开始行动"></a>开始行动</h2><p>要想把成功的关键对话转变成优秀的决策和一致的行动，你应当努力避免错误期望和不作为两种陷阱。</p>
<h2 id="决定如何决策"><a href="#决定如何决策" class="headerlink" title="决定如何决策"></a>决定如何决策</h2><ul>
<li>命令式。无须参与的决策方式。</li>
<li>顾问式。广泛征集意见，由少数人决定的决策方式。</li>
<li>投票式。以支持率为基础的决策方式。</li>
<li>共识式。人人都必须对最终结果表示同意的决策方式。</li>
</ul>
<h2 id="明确执行细节"><a href="#明确执行细节" class="headerlink" title="明确执行细节"></a>明确执行细节</h2><p>在决策执行环节，你必须明确说明行动人、行动目标和截止时间等要素。明确行为目标，设定检查时间，记录任务细节并按时进行检查。最后，你应当督促人们对其做出的承诺负责。</p>
<blockquote>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>以下结合个人的想法、认知和感受说说关键对话核心要点在沟通中的意义及作用。</p>
</blockquote>
<h2 id="确定目标"><a href="#确定目标" class="headerlink" title="确定目标"></a>确定目标</h2><p>明确沟通的目标，可以帮助我们有效防止沟通内容发散、问题升级、情绪失控。</p>
<h2 id="创造安全对话氛围"><a href="#创造安全对话氛围" class="headerlink" title="创造安全对话氛围"></a>创造安全对话氛围</h2><p>沟通是双方观点的交流，最后并达成一致，而不是发号施令。而如何能够让对方在重要问题上表达自己的想法和观点，是沟通成功的关键。首先我们必须确保创建安全的对话氛围，只有在安全的氛围下沟通者才会说出自己的真是想法。如果我们不能创建安全的对话氛围，要么对方情绪激动而言不由衷，要么沉默应对，最后导致沟通失败。</p>
<h2 id="让对方畅所欲言"><a href="#让对方畅所欲言" class="headerlink" title="让对方畅所欲言"></a>让对方畅所欲言</h2><p>当对话出现不安全的信号时，三种非常有效的应对技巧可以帮助我们恢复安全对话的氛围：</p>
<ul>
<li>道歉</li>
<li>创建共同目的</li>
<li>对比说明</li>
</ul>
<h2 id="避免在愤怒、恐惧或受伤的情况下展开对话"><a href="#避免在愤怒、恐惧或受伤的情况下展开对话" class="headerlink" title="避免在愤怒、恐惧或受伤的情况下展开对话"></a>避免在愤怒、恐惧或受伤的情况下展开对话</h2><p>沟通中其实最难控制的是激烈的情绪，一旦进入激动的状态以后，肾上腺素狂飙，人们会进入一种应激防御状态，这时往往说出一些言不由衷的话，事后则后悔不已。对于这一点，有两个方式可以帮助我们，一是我们要有审视自我的意识，二是要牢记沟通对话的目的。</p>
<p>实际上其他人是无法让你陷入某种情绪的，是你制造了自己的情绪，是你让自己感到害怕、烦恼或气愤，产生负面情绪后你只有两个选择，要么控制它，要么被它控制。</p>
<h2 id="综合陈述法"><a href="#综合陈述法" class="headerlink" title="综合陈述法"></a>综合陈述法</h2><p>综合陈述法是我们表达自己观点的重要的方式，是最为基础也是最为重要的，我们要基于客观事实陈述，避免以偏概全或误解的情况。</p>
<ul>
<li>分享事实经过。从最少争议、最有说服力的事实谈起。</li>
<li>说出你的想法。说明你根据这些事实得出的结论。</li>
<li>征询对方观点。鼓励对方说出他们看到的事实和产生的想法。</li>
<li>做出试探表述。承认这些结论只是你的想法，不要假装是事实。鼓励做出尝试。</li>
<li>创建安全感，鼓励对方说出不同甚至对立的观点。</li>
</ul>
<h2 id="了解动机-1"><a href="#了解动机-1" class="headerlink" title="了解动机"></a>了解动机</h2><p>要想鼓励观点的自由交流，帮助对方摆脱沉默或暴力的错误应对方式，你应当了解他们的行为动机，应当在对话中表现出巨大的好奇心和耐心，只有这样才能恢复安全感.</p>
]]></content>
      <categories>
        <category>book</category>
      </categories>
      <tags>
        <tag>关键对话</tag>
      </tags>
  </entry>
  <entry>
    <title>《你要如何衡量你的人生》</title>
    <url>/2022/09/07/book/ni-yao-ru-he-heng-liang-ni-de-ren-sheng/</url>
    <content><![CDATA[<p><img src="/images/book/%E4%BD%A0%E8%A6%81%E5%A6%82%E4%BD%95%E8%A1%A1%E9%87%8F%E4%BD%A0%E7%9A%84%E4%BA%BA%E7%94%9F.jpg" alt="你要如何衡量你的人生"></p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p><em><strong>《《你要如何衡量你的人生》 —— 哈佛商学院毕业前最重要的一堂课</strong></em></p>
<blockquote>
<p>克莱顿·克里斯坦森 凯伦·迪伦 詹姆斯·奥沃斯</p>
</blockquote>
<h1 id="写在前面的话"><a href="#写在前面的话" class="headerlink" title="写在前面的话"></a>写在前面的话</h1><p>这篇文章是阅读本书时发表的一些想法，今天偶然看到其中的一些想法被别人认同，重新翻开看看，其中思想和观点仍值得反复思考和学习。我们需要了解这个世界，更需要了解自己。</p>
<h1 id="“思考什么”和“如何思考”的区别"><a href="#“思考什么”和“如何思考”的区别" class="headerlink" title="“思考什么”和“如何思考”的区别"></a>“思考什么”和“如何思考”的区别</h1><h2 id="2021-11-02发表想法"><a href="#2021-11-02发表想法" class="headerlink" title="2021&#x2F;11&#x2F;02发表想法"></a>2021&#x2F;11&#x2F;02发表想法</h2><p>曾今我也热衷于向专家或事业有所成就的人寻求成功的答案，但是这些答案往往局限于他们自己的能力及所处环境，很少能够用于己身答案，遂转而向下一位成功者寻求答案。随着经历的事情越来越多，逐渐发现这种方式是不适当的，不同的人使用相同的方法，结局是大不相同的。后来总结提炼逐这些人的答案，从中找到了一些共同点，这些共同点就是一些原则，而将这些原则在自己身上实践，会更有成效。</p>
<blockquote>
<p>如今，有一群所谓的专家只是提供一些答案，告诉你如何获得幸福和寻找到生命的意义，但是这些答案是否适合你就不得而知了。</p>
</blockquote>
<h1 id="第一章-真正激励你的是什么"><a href="#第一章-真正激励你的是什么" class="headerlink" title="第一章 真正激励你的是什么"></a>第一章 真正激励你的是什么</h1><blockquote>
<p>那么，真正让我们非常满意并爱上工作的因素是什么呢？那就是赫茨伯格研究中的“动力因素”。动力因素包括：有挑战性、获得认可、责任感、个人成长。</p>
</blockquote>
<h2 id="2022-09-03发表想法"><a href="#2022-09-03发表想法" class="headerlink" title="2022&#x2F;09&#x2F;03发表想法"></a>2022&#x2F;09&#x2F;03发表想法</h2><p>当我们陷入缺钱的紧迫思维之后，会努力用尽一切方式赚钱，这个过程中逐渐学会用钱去衡量一切得失，最后得出一个结论，我们目前赚的钱还不够多，等我们赚到足够多的钱后，问题就会解决。但是生活中的很多案例并告诉我们事实并不是这样的，人与人之间的关系，不是靠简单的金钱关系维护的，而是我们需要付出行动、付出精力去维系的，长久的人际关系的疏远，即使后期用更多的金钱也是无法挽回的。背后浅显的道理是人们更需要的是雪中送炭，而不是锦上添花。</p>
<blockquote>
<p>我的观点并不是说钱是没有职业幸福感的根本原因，我要说的是，当赚钱成了高于其他一切事情的重点时，当基础因素得到了满足、追求仍停留在赚更多的钱时，问题就出现了。即便是一些专门从事跟钱打交道的职业，比如做销售员和交易员，也要遵循动力因素规则。只不过在这些职业中，钱成了衡量成功与否的尺度罢了</p>
</blockquote>
<h2 id="2022-08-30发表想法"><a href="#2022-08-30发表想法" class="headerlink" title="2022&#x2F;08&#x2F;30发表想法"></a>2022&#x2F;08&#x2F;30发表想法</h2><p>每个人的人生经历各不相同，所看重的价值排序也是不同的，不要把自己的价值观强加给别人，学会求同存异</p>
<blockquote>
<p>我们应该明白，不是有些人与我们有什么根本的不同，只不过是人们衡量是否有意义或开心的标准有差异，这个理论对每个人都适用。</p>
</blockquote>
<h2 id="2022-09-03发表想法-1"><a href="#2022-09-03发表想法-1" class="headerlink" title="2022&#x2F;09&#x2F;03发表想法"></a>2022&#x2F;09&#x2F;03发表想法</h2><p>很多时候我们做完某件事后，事情的结果并不会让我们兴奋很久，反而是做事的过程让我们尤其享受，这个现象在陪伴小孩子玩耍的过程中更常见。</p>
<blockquote>
<p>我原来以为重要的是目的，现在才发现过程更重要</p>
</blockquote>
<h1 id="第二章-周密计划与偶然机会的平衡"><a href="#第二章-周密计划与偶然机会的平衡" class="headerlink" title="第二章 周密计划与偶然机会的平衡"></a>第二章 周密计划与偶然机会的平衡</h1><h2 id="2022-09-03发表想法-2"><a href="#2022-09-03发表想法-2" class="headerlink" title="2022&#x2F;09&#x2F;03发表想法"></a>2022&#x2F;09&#x2F;03发表想法</h2><p>很多时候仅凭借大脑思考，是无法得出问题的答案的，这需要我们不断向外界获取信息，才能做出最有利的判断</p>
<blockquote>
<p>随着职业经历的积累，你会找到自己热爱的工作领域，并且能够在这个领域做得很出色。但是，如果你以为只要坐在象牙塔里，把问题从头到尾仔细地考虑一遍，有一天答案就会突然跳出来，那等待你的只会是失败</p>
</blockquote>
<h2 id="2022-09-03发表想法-3"><a href="#2022-09-03发表想法-3" class="headerlink" title="2022&#x2F;09&#x2F;03发表想法"></a>2022&#x2F;09&#x2F;03发表想法</h2><p>这一点深有体会，举个简单的例子，对于不做饭的人来说，随着时间的推移，每天吃什么变成了一个困难的选择题，但是如果你在家里纠结要吃什么的时候，不如先圈定一个范围，然后走到外面，根据圈定的范围做去做排除法，很多时候当我们走到一个地方，闻到一种味道，看到一些色香味俱全的食物，我们心里已经知道今天要吃什么了。而我们的选择有时候会在我们的预先圈定的范围内，有时候会遇到一些新出现的食物。这个结果比我们在家里纠结要吃什么会更有效。</p>
<blockquote>
<p>几乎所有战略都是周密战略和意外机遇结合的产物，关键是要走出去，并行动起来，一直到你明白将自己的聪明才智、兴趣和重点放在哪里。当你真正找到了适合自己的工作，就应该立即将应急战略转化成周密战略。</p>
</blockquote>
<h2 id="2022-09-03发表想法-4"><a href="#2022-09-03发表想法-4" class="headerlink" title="2022&#x2F;09&#x2F;03发表想法"></a>2022&#x2F;09&#x2F;03发表想法</h2><p>不习惯去表现自己，遇到表现的机会发现自己总是在逃避，没法敞开大门拥抱机会，这一习惯需要不断去改变。</p>
<blockquote>
<p>“我随时会敞开大门，拥抱机会。”当然这句话说起来容易，做起来并不简单</p>
</blockquote>
<h1 id="第三章-你的战略与你所说的一致吗"><a href="#第三章-你的战略与你所说的一致吗" class="headerlink" title="第三章 你的战略与你所说的一致吗"></a>第三章 你的战略与你所说的一致吗</h1><h2 id="2022-09-04发表想法"><a href="#2022-09-04发表想法" class="headerlink" title="2022&#x2F;09&#x2F;04发表想法"></a>2022&#x2F;09&#x2F;04发表想法</h2><p>一个计划的落地需要充分考虑各种因素，很多方案的出发点是好的，但是在实施的过程中没有考虑好政治、人文、地理、环境等因素，最后导致计划的失败。在中国的历史上，王莽新政、王安石变法皆是如此。</p>
<blockquote>
<p>一边被告知什么才是重点，一边又被鼓励去做眼前的事</p>
</blockquote>
<h2 id="2022-09-04发表想法-1"><a href="#2022-09-04发表想法-1" class="headerlink" title="2022&#x2F;09&#x2F;04发表想法"></a>2022&#x2F;09&#x2F;04发表想法</h2><p>看一个人做了什么，比听他要做什么更重要</p>
<blockquote>
<p>看一个人的价值观就要看他的支票簿存根，从支票存根上可以看出他资源分配的倾向，从而判断这个人的价值取向。把钱用在了哪些方面从支票存根上一看便知</p>
</blockquote>
<h2 id="2022-09-04发表想法-2"><a href="#2022-09-04发表想法-2" class="headerlink" title="2022&#x2F;09&#x2F;04发表想法"></a>2022&#x2F;09&#x2F;04发表想法</h2><p>我们如何判断我们实施的战略是我们想要的呢？那就需要看看我们的资源配置，我们总是口口声声说我们要怎么怎么做、要如何如何。但是回过头来看，我们是否真正的有把时间、精力、金钱用到我们制定的战略上呢？所以分析我们的资源配置过程对我们判断自己的战略实施非常重要。</p>
<blockquote>
<p>怎样确保实施的战略是你真正想要的呢？那就看看你的资源流向哪里去了，我们可以通过资源配置过程来探究这个问题的答案。如果这个过程没有支持你决定了的战略，那么就会有出现严重问题的风险。或许你认为自己是一个仁慈的人，但是你多久才会有一次把时间和金钱投入到慈善事业或慈善组织的经历呢？如果家庭对你是最重要的，当你考虑在各种自由支配的时间（或非自由支配的时间）里做选择时，对家人的考虑是不是你的优先选择呢？如果你做了决定，想把血汗和眼泪投入到某个方面，但这与你渴望变成的人不相符，你就无法成为你渴望变成的那个人。</p>
</blockquote>
<h1 id="PART-2-如何确定与亲朋好友的关系是你幸福的源泉"><a href="#PART-2-如何确定与亲朋好友的关系是你幸福的源泉" class="headerlink" title="PART 2 如何确定与亲朋好友的关系是你幸福的源泉"></a>PART 2 如何确定与亲朋好友的关系是你幸福的源泉</h1><h2 id="2022-09-04发表想法-3"><a href="#2022-09-04发表想法-3" class="headerlink" title="2022&#x2F;09&#x2F;04发表想法"></a>2022&#x2F;09&#x2F;04发表想法</h2><p>对于我们工作中所获得的成就感，最后还是要源自你周围的人对你的认同，所以从长远来看，你的人际关系比你的成就更为重要</p>
<blockquote>
<p>工作能给你带来成就感，但是与家人、好友培养出的亲密关系带给我们的长久幸福感相比，就会显得很苍白</p>
</blockquote>
<h2 id="2022-09-04发表想法-4"><a href="#2022-09-04发表想法-4" class="headerlink" title="2022&#x2F;09&#x2F;04发表想法"></a>2022&#x2F;09&#x2F;04发表想法</h2><p>当我们做错某事并不意味着我们失败了，只是说明我们曾将预想的某些事情是行不通的，所以才会尝试其他方法。</p>
<blockquote>
<p>如果详细看过我们关于应急战略和周密战略的讨论——在计划和意外机遇之间找到平衡——那么你就会知道办错某事并不意味着失败。相反，你只有知道了什么东西行不通，才会去尝试别的办法。</p>
</blockquote>
<h1 id="第四章-时光在流逝，而你丢失了什么"><a href="#第四章-时光在流逝，而你丢失了什么" class="headerlink" title="第四章 时光在流逝，而你丢失了什么"></a>第四章 时光在流逝，而你丢失了什么</h1><h2 id="2022-09-04发表想法-5"><a href="#2022-09-04发表想法-5" class="headerlink" title="2022&#x2F;09&#x2F;04发表想法"></a>2022&#x2F;09&#x2F;04发表想法</h2><p>在长远战略发展中，很少有能够按照原计划完成的</p>
<blockquote>
<p>换言之，成功的企业并非一开始就照着正确的策略推进才成功的，而是最初策略失败之后，还有多余的钱可以尝试其他做法。反之，大多数失败的企业一开始就把所有钱投注在最初的策略上，就像把所有鸡蛋放在一个篮子里一样，发现策略错误时，已无法挽救或重新开始。</p>
</blockquote>
<h1 id="第五章-奶昔被雇来做什么"><a href="#第五章-奶昔被雇来做什么" class="headerlink" title="第五章 奶昔被雇来做什么"></a>第五章 奶昔被雇来做什么</h1><blockquote>
<p>人之所欲，施之于人”才是正确的方法</p>
</blockquote>
<h2 id="2022-09-05发表想法"><a href="#2022-09-05发表想法" class="headerlink" title="2022&#x2F;09&#x2F;05发表想法"></a>2022&#x2F;09&#x2F;05发表想法</h2><p>知道对方想要什么，比我们全身心的付出更重要。所以在向我们所爱的人付出时，一定要先搞清楚他们的真正想要什么，自我感动式的付出往往忽略的对方的感受，最后反而导致关系的恶化。</p>
<blockquote>
<p>希望你爱的人过得幸福，这是自然的事情，但往往难就难在我们不知道应该在其中扮演什么角色。要了解对你最在乎的人而言什么东西最重要，最好的方法就是从“需要完成的工作”角度去考虑，它能使你发展出真正的同情。问问自己：“我的伴侣最需要我做的是什么？”这会给你提供从正确角度分析问题的能力。当你从这种角度处理人际关系时，答案会更清晰，比只是推测怎么做才对要清晰得多</p>
</blockquote>
<h1 id="第六章-你的孩子还是你的吗"><a href="#第六章-你的孩子还是你的吗" class="headerlink" title="第六章 你的孩子还是你的吗"></a>第六章 你的孩子还是你的吗</h1><h2 id="2022-09-05发表想法-1"><a href="#2022-09-05发表想法-1" class="headerlink" title="2022&#x2F;09&#x2F;05发表想法"></a>2022&#x2F;09&#x2F;05发表想法</h2><p>要清楚自己的能力，更要清楚什么是我们核心的支柱力量。</p>
<blockquote>
<p>要清楚自己的能力。你需要了解什么是能力，哪个对你的未来而言更关键，知道哪个应该自己保留，哪个不太重要</p>
</blockquote>
<h2 id="2022-09-05发表想法-2"><a href="#2022-09-05发表想法-2" class="headerlink" title="2022&#x2F;09&#x2F;05发表想法"></a>2022&#x2F;09&#x2F;05发表想法</h2><p>资源是最基本的驱动力</p>
<blockquote>
<p>许多人认为资源是使企业取得成功的原因，但是我认为资源仅是驱动企业的三个关键因素之一</p>
</blockquote>
<h2 id="2022-09-05发表想法-3"><a href="#2022-09-05发表想法-3" class="headerlink" title="2022&#x2F;09&#x2F;05发表想法"></a>2022&#x2F;09&#x2F;05发表想法</h2><p>外包缺失可以迅速获取轻松获取利益，但是也会让我们失去一些能力，所以必须清楚我们必须要具备的能力范围，方能确定是否要将这项业务进行外包。</p>
<blockquote>
<p>将流程外包受到金融家、咨询顾问以及一些学者的鼓励，他们看到的是通过外包可以迅速且轻松地获得利益，但是他们看不到外包的成本——它会使企业失去一些能力</p>
</blockquote>
<h2 id="2022-09-05发表想法-4"><a href="#2022-09-05发表想法-4" class="headerlink" title="2022&#x2F;09&#x2F;05发表想法"></a>2022&#x2F;09&#x2F;05发表想法</h2><p>对于孩子来说，学会学习的方式，比学到知识本身更重要。掌握学习的方式后，我们可以更快更轻松的学会任何知识，挑战困难。但是当我们仅仅学会知识本身，是不足以应对未来更庞大、更复杂的知识的。从小培养孩子的学习能力尤其重要。</p>
<blockquote>
<p>孩子们从这些活动中培养了诸如团队精神、企业家精神，以及领悟到做事应该事先有所准备了吗？还是他们仅仅是应付了事？当我们专注于为孩子提供资源的时候，我们需要问自己一些问题：我的孩子掌握了培养新技能的方法了吗？学到发展更加深入探索知识的能力了吗？掌握了从经历中获取经验的方法了吗？这些对于培养孩子的“应用流程”能力是非常重要的。基于此，我最担心的是家庭的外包</p>
</blockquote>
<h2 id="2022-09-05发表想法-5"><a href="#2022-09-05发表想法-5" class="headerlink" title="2022&#x2F;09&#x2F;05发表想法"></a>2022&#x2F;09&#x2F;05发表想法</h2><p>父母的美好意图导致的最终结果就是：孩子们在成长过程中很少有机会担负重要的责任，也很少有机会能为自己或他人解决复杂的问题</p>
<blockquote>
<p>孩子们在成长过程中很少有机会担负重要的责任，也很少有机会能为自己或他人解决复杂的问题</p>
</blockquote>
<blockquote>
<p>回顾我的生活时，我意识到父母给我最好的礼物不是他们为我做了什么，而是他们没有为我做什么</p>
</blockquote>
<h2 id="2022-09-05发表想法-6"><a href="#2022-09-05发表想法-6" class="headerlink" title="2022&#x2F;09&#x2F;05发表想法"></a>2022&#x2F;09&#x2F;05发表想法</h2><p>孩子们在自己准备好学习时才能学到东西，而不是在我们准备好教导他们的时候</p>
<blockquote>
<p>孩子们在自己准备好学习时才能学到东西，而不是在我们准备好教导他们的时候</p>
</blockquote>
<h2 id="2022-09-05发表想法-7"><a href="#2022-09-05发表想法-7" class="headerlink" title="2022&#x2F;09&#x2F;05发表想法"></a>2022&#x2F;09&#x2F;05发表想法</h2><p>一个人价值取向的成长是人生中最宝贵的东西</p>
<blockquote>
<p>孩子们会在自己准备好学习的时候学习，而不是在你准备好教他们的时候；如果当他们遇到生活中的挑战时你没有在他们身边，那么你就失去了塑造他们的价值取向的重要机会</p>
</blockquote>
<h1 id="第七章-经验学校"><a href="#第七章-经验学校" class="headerlink" title="第七章 经验学校"></a>第七章 经验学校</h1><h2 id="2022-09-07发表想法"><a href="#2022-09-07发表想法" class="headerlink" title="2022&#x2F;09&#x2F;07发表想法"></a>2022&#x2F;09&#x2F;07发表想法</h2><p>能力是从经历中获取的，这些经历或许成功，或许失败。</p>
<blockquote>
<p>他认为管理能力是在生活中培养和塑造的。一个具有挑战性的任务、一次领导项目的失败、一次新领域的任务，都是经验学校的“课程”。领导者具有或者缺乏的技能很大程度上依赖于他们上过或者没上过的“课程”。</p>
</blockquote>
<h2 id="2022-09-07发表想法-1"><a href="#2022-09-07发表想法-1" class="headerlink" title="2022&#x2F;09&#x2F;07发表想法"></a>2022&#x2F;09&#x2F;07发表想法</h2><p>不要抢夺孩子手中的方向盘，因为终有一天父母需要放手，过多的介入反而会让孩子没有自己的思想，最后脱离父母后无所适从。</p>
<blockquote>
<p>实际上，对于许多家长来说，以自己的介入来确保孩子们总能取得成功是一件诱人的事，但是对于孩子来说，他们从中得到了什么呢？</p>
</blockquote>
<h1 id="第八章-家庭中那只看不见的手——家庭文化"><a href="#第八章-家庭中那只看不见的手——家庭文化" class="headerlink" title="第八章 家庭中那只看不见的手——家庭文化"></a>第八章 家庭中那只看不见的手——家庭文化</h1><h2 id="2022-09-07发表想法-2"><a href="#2022-09-07发表想法-2" class="headerlink" title="2022&#x2F;09&#x2F;07发表想法"></a>2022&#x2F;09&#x2F;07发表想法</h2><p>文化，是人们朝着一个共同的目标一起工作的方式，这种方式一直以来被大家所沿用并且一直行之有效，以至于人们根本不会想到要以另一种方式去做事。特定文化一经形成，人们就自动地去做要取得成功需要做的事</p>
<blockquote>
<p>文化，是人们朝着一个共同的目标一起工作的方式，这种方式一直以来被大家所沿用并且一直行之有效，以至于人们根本不会想到要以另一种方式去做事。特定文化一经形成，人们就自动地去做要取得成功需要做的事</p>
</blockquote>
<h1 id="第九章-仅此一次的错误"><a href="#第九章-仅此一次的错误" class="headerlink" title="第九章 仅此一次的错误"></a>第九章 仅此一次的错误</h1><h2 id="2022-09-07发表想法-3"><a href="#2022-09-07发表想法-3" class="headerlink" title="2022&#x2F;09&#x2F;07发表想法"></a>2022&#x2F;09&#x2F;07发表想法</h2><p>短期利益与长期利益的抉择需要卓越的判断力。</p>
<blockquote>
<p>如果你需要一台机器，但是你不愿意购买它，那么最终你会发现，你付了足以购买它的钱却没有拥有它</p>
</blockquote>
<h2 id="2022-09-07发表想法-4"><a href="#2022-09-07发表想法-4" class="headerlink" title="2022&#x2F;09&#x2F;07发表想法"></a>2022&#x2F;09&#x2F;07发表想法</h2><p>“仅此一次”如同千里之堤溃于蚁穴之中的蚁穴，看似微不足道，实则是致命的危险。</p>
<blockquote>
<p>以100%的坚持来保持原则要比以98%的坚持来保持它更容易实现。如果你从未越界，那么你的道德界限就足够强大；如果你破例一次，那么没有什么可以阻止你一而再再而三地破例</p>
</blockquote>
<h2 id="2022-09-07发表想法-5"><a href="#2022-09-07发表想法-5" class="headerlink" title="2022&#x2F;09&#x2F;07发表想法"></a>2022&#x2F;09&#x2F;07发表想法</h2><p>一个圆上任意一个点被擦去后，即使这个点再小，这个圆已经不是一个完成的圆了，而是一条曲线，这是一种质的改变。</p>
<blockquote>
<p>避免人生中出现道德让步带来的后果的唯一方法就是坚决不让它开始——跨过底线的第一步就是使你走上后悔道路的那一步。避免自己后悔的最好办法是什么？那就是多年前，当你第一次面临选择时，不要跨出第一步</p>
</blockquote>
<h2 id="2022-09-07发表想法-6"><a href="#2022-09-07发表想法-6" class="headerlink" title="2022&#x2F;09&#x2F;07发表想法"></a>2022&#x2F;09&#x2F;07发表想法</h2><p>面临困境的时候我们一退再退，但是不能超过原则的底线，一旦超过，我们将丢失曾经的我们。</p>
<blockquote>
<p>面临选择时，想象你所做的每个决定都符合当初下定决心要永远坚持的原则，可以更容易阻止你做出最终让自己后悔的决定。</p>
</blockquote>
<h1 id="结束语-你要如何衡量你的人生"><a href="#结束语-你要如何衡量你的人生" class="headerlink" title="结束语 你要如何衡量你的人生"></a>结束语 你要如何衡量你的人生</h1><h2 id="2022-09-07发表想法-7"><a href="#2022-09-07发表想法-7" class="headerlink" title="2022&#x2F;09&#x2F;07发表想法"></a>2022&#x2F;09&#x2F;07发表想法</h2><p>没有认真考虑目标和使命可能是导致企业挫折和失败最重要的原因。没有认证考虑人生的目标和使命，同样会导致陷入认识和错则的人生，最后随波逐流。</p>
<blockquote>
<p>没有认真考虑目标和使命可能是导致企业挫折和失败最重要的原因</p>
</blockquote>
<h1 id="如何确定你的人生目标"><a href="#如何确定你的人生目标" class="headerlink" title="如何确定你的人生目标"></a>如何确定你的人生目标</h1><h2 id="2022-09-07发表想法-8"><a href="#2022-09-07发表想法-8" class="headerlink" title="2022&#x2F;09&#x2F;07发表想法"></a>2022&#x2F;09&#x2F;07发表想法</h2><p>人生缺少目标时，则缺少动力。</p>
<blockquote>
<p>同样道理，要将本书中建议的价值最大化，你必须为自己的人生设定目标</p>
</blockquote>
<h1 id="写在最后的话"><a href="#写在最后的话" class="headerlink" title="写在最后的话"></a>写在最后的话</h1><p>回顾自己真本书的笔记，被自己曾经写下的想法震惊。人生是忙碌的，我们每天要忙着做各种各样的事，同时也错过了很多想要做的事。人生很长，可以有一辈子的光阴去挥霍去享受；人生也很短，暮然回首朋友和亲人已经到了说告别的时候了。在成长的道路上，我们是否清晰了自己人生的目标？又该如何努力实现我们人生的目标？当生命行至尽头时你要如何衡量你的人生？</p>
]]></content>
      <categories>
        <category>book</category>
      </categories>
      <tags>
        <tag>《你要如何衡量你的人生》</tag>
      </tags>
  </entry>
  <entry>
    <title>《原生家庭》</title>
    <url>/2021/02/11/book/yuan-sheng-jia-ting/</url>
    <content><![CDATA[<p><img src="/images/%E5%8E%9F%E7%94%9F%E5%AE%B6%E5%BA%AD.jpeg" alt="原生家庭"></p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p><em><strong>《原生家庭》 —— 如何修补自己的性格缺陷</strong></em></p>
<blockquote>
<p>[美]苏珊·福沃德 克雷格·巴克 —— 著<br>黄姝 王婷 —— 译</p>
</blockquote>
<h1 id="书序"><a href="#书序" class="headerlink" title="书序"></a>书序</h1><p> 你的所有的感受都是有道理的，尤其是那些灰暗的感受。内心充满痛苦的人，只要能发现这样一个简单的道理，他们的痛苦就会减轻很多。并且这个道理的核心是，你那些灰暗的、一直以来难以被别人和自己理解接纳、似乎无处安放的感受，其实就是来自你的家庭，而且主要是来自你与父母的关系。这是一个真相，我们必须尊重的真相。 —— 武志红 [心里学家、作家]</p>
]]></content>
      <categories>
        <category>book</category>
      </categories>
      <tags>
        <tag>原生家庭</tag>
      </tags>
  </entry>
  <entry>
    <title>《可爱的诅咒》</title>
    <url>/2021/02/11/book/ke-ai-de-zu-zhou/</url>
    <content><![CDATA[<p><img src="/images/%E5%8F%AF%E7%88%B1%E7%9A%84%E8%AF%85%E5%92%92.jpeg" alt="可爱的诅咒"></p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p><em><strong>《可爱的诅咒》—— 圣母型人格心里自助手册</strong></em></p>
<blockquote>
<p>[英]雅基·马森 —— 著<br>王丽 —— 译</p>
</blockquote>
<h1 id="书序"><a href="#书序" class="headerlink" title="书序"></a>书序</h1><p>生活中总会有一些这样的人，他（她）们将大部分精力都花在家人、朋友和同事身上，甚至对陌生人也有求必应，一旦停止这样做，就会觉得非常内疚，仿佛受了一场”可爱的诅咒”。在他们看来，很多事情的优先级都高于自己的身心健康，结果，支持了所有人，却让自己崩溃。</p>
<h1 id="精彩段落"><a href="#精彩段落" class="headerlink" title="精彩段落"></a>精彩段落</h1><h2 id="第一章-期望的牢笼"><a href="#第一章-期望的牢笼" class="headerlink" title="第一章 期望的牢笼"></a>第一章 期望的牢笼</h2><p>我们通常都会觉得自己被淹没在别人的期望中，而且完全不知道该如何以其它方式生活。事实上，就连想到改变，比如拒绝某个请求，都会觉得害怕。</p>
<h2 id="第四章-身体的感受与情绪的觉察"><a href="#第四章-身体的感受与情绪的觉察" class="headerlink" title="第四章 身体的感受与情绪的觉察"></a>第四章 身体的感受与情绪的觉察</h2><p>我们不敢说出我们与别人不同的意见。这还是”害怕冲突”的问题：当你能够忽略自己的真实想法并享受和睦时，你又何必冒险引起愤怒与不和呢？但是，这是需要我们自己付出代价的。再次重申，我们不敢显露真实的自己，包括我们的价值观、信仰、品味及意见，所以其他人也就永远无法了解真实的我们是什么样子。这种情况下维持的关系会有问题，因为它并非百分百真实。我们的自我感知也会有问题，因为我们并不相信别人是因为我们自身的样子而喜欢我们，而是以为他们喜欢我们只是因为我们与他们的意见一致。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>总是想成为别人眼中的”好孩子”，一直努力做一个对别人”有用”的人，忽略自己真实的感受，通过”删除”自己真实的想法去赞成别人的观点来获得认同，我们可能都有一小块被”可爱的诅咒”施了法的脆弱区域，而我可能有一大片。</p>
]]></content>
      <categories>
        <category>book</category>
      </categories>
      <tags>
        <tag>可爱的诅咒</tag>
      </tags>
  </entry>
  <entry>
    <title>MCP Server深度解析：AI应用的标准化协议</title>
    <url>/2026/01/08/ai-coding/mcp-server-shen-du-jie-xi/</url>
    <content><![CDATA[<h2 id="引言：AI应用集成的困境与突破"><a href="#引言：AI应用集成的困境与突破" class="headerlink" title="引言：AI应用集成的困境与突破"></a>引言：AI应用集成的困境与突破</h2><p>在 AI 快速发展的今天，我们看到越来越多的 AI 应用涌现：从 Claude、ChatGPT 到各类垂直领域的 AI 助手。然而，每个 AI 应用都有自己的数据接入方式、API 标准和集成方法，这就像互联网早期各家公司都有自己的协议标准一样，导致开发者需要为每个 AI 应用单独适配。</p>
<p>Anthropic 公司在 2024 年推出的 <strong>MCP (Model Context Protocol，模型上下文协议)</strong> 正是为了解决这一痛点而生。它提供了一套标准化的协议，让 AI 应用能够以统一的方式访问各类数据源和工具，就像 HTTP 协议统一了 Web 通信一样。</p>
<span id="more"></span>
<p><img src="/2026/01/08/ai-coding/mcp-server-shen-du-jie-xi/MCP-Server%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90.jpeg" alt="MCP-Server深度解析"></p>
<h2 id="一、什么是-MCP-Server？"><a href="#一、什么是-MCP-Server？" class="headerlink" title="一、什么是 MCP Server？"></a>一、什么是 MCP Server？</h2><h3 id="1-1-MCP-Server-是什么：给-AI-的「能力网关」"><a href="#1-1-MCP-Server-是什么：给-AI-的「能力网关」" class="headerlink" title="1.1 MCP Server 是什么：给 AI 的「能力网关」"></a>1.1 MCP Server 是什么：给 AI 的「能力网关」</h3><p><strong>MCP Server</strong> 是基于 Model Context Protocol 协议实现的服务端程序，它充当 AI 应用与外部资源之间的桥梁。</p>
<div class="mermaid-wrap"><pre class="mermaid-src" data-config="{}" hidden>
    graph LR
    A[AI应用&lt;br&#x2F;&gt;Claude&#x2F;ChatGPT] --&gt; B[MCP Client]
    B --&gt; C[MCP Server]
    C --&gt; D[数据库]
    C --&gt; E[文件系统]
    C --&gt; F[API服务]
    C --&gt; G[业务系统]
    
    style A fill:#e3f2fd
    style B fill:#fff9c4
    style C fill:#e1f5e1
    style D fill:#ffebee
    style E fill:#ffebee
    style F fill:#ffebee
    style G fill:#ffebee
  </pre></div>

<p><strong>类比理解</strong>：</p>
<ul>
<li>如果把 AI 应用比作浏览器，MCP Server 就是 Web 服务器</li>
<li>如果把 AI 应用比作手机 App，MCP Server 就是后端 API</li>
<li>MCP Protocol 就是它们之间的”通信语言”</li>
</ul>
<h3 id="1-2-为什么需要-MCP：从插件地狱到标准协议"><a href="#1-2-为什么需要-MCP：从插件地狱到标准协议" class="headerlink" title="1.2 为什么需要 MCP：从插件地狱到标准协议"></a>1.2 为什么需要 MCP：从插件地狱到标准协议</h3><p><strong>传统方式的问题</strong>：每个 AI 应用都需要单独开发插件，导致代码重复、维护成本高。</p>
<p><strong>使用 MCP 的优势</strong>：一次开发，所有支持 MCP 的 AI 应用都能使用。</p>
<table>
<thead>
<tr>
<th>对比维度</th>
<th>传统插件方式</th>
<th>MCP 方式</th>
</tr>
</thead>
<tbody><tr>
<td><strong>开发成本</strong></td>
<td>每个 AI 应用单独开发</td>
<td>一次开发，通用使用</td>
</tr>
<tr>
<td><strong>维护成本</strong></td>
<td>多套代码，分别维护</td>
<td>单一代码库，统一维护</td>
</tr>
<tr>
<td><strong>扩展性</strong></td>
<td>添加新功能需多处修改</td>
<td>在 MCP Server 统一扩展</td>
</tr>
<tr>
<td><strong>标准化</strong></td>
<td>各自标准，难以复用</td>
<td>统一协议，开箱即用</td>
</tr>
<tr>
<td><strong>生态发展</strong></td>
<td>碎片化</td>
<td>社区共建，快速增长</td>
</tr>
</tbody></table>
<h2 id="二、MCP-Server-的三大核心能力"><a href="#二、MCP-Server-的三大核心能力" class="headerlink" title="二、MCP Server 的三大核心能力"></a>二、MCP Server 的三大核心能力</h2><p>MCP Server 提供三大核心能力：<strong>Resources（资源）</strong>、<strong>Tools（工具）</strong> 和 <strong>Prompts（提示词模板）</strong>。</p>
<h3 id="2-1-Resources：让-AI-读懂你的数据"><a href="#2-1-Resources：让-AI-读懂你的数据" class="headerlink" title="2.1 Resources：让 AI 读懂你的数据"></a>2.1 Resources：让 AI 读懂你的数据</h3><p>Resources 让 AI 应用能够读取各类数据源的内容。</p>
<p><strong>常见资源类型</strong>：</p>
<ul>
<li>📄 <strong>文件系统</strong>：访问本地文件和目录</li>
<li>🗄️ <strong>数据库</strong>：读取 MySQL、PostgreSQL、MongoDB 数据</li>
<li>🌐 <strong>Web 内容</strong>：抓取网页、API 数据</li>
<li>📧 <strong>邮件系统</strong>：访问邮件内容</li>
<li>📊 <strong>业务系统</strong>：CRM、ERP 等企业数据</li>
</ul>
<p><strong>使用示例</strong>：</p>
<pre class="line-numbers language-none"><code class="language-none">用户：请读取项目目录下的 README.md 文件
AI：正在访问文件... [调用 MCP Server Resources 能力]
结果：README.md 内容已读取，包含项目介绍...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="2-2-Tools：让-AI-真正「动手」"><a href="#2-2-Tools：让-AI-真正「动手」" class="headerlink" title="2.2 Tools：让 AI 真正「动手」"></a>2.2 Tools：让 AI 真正「动手」</h3><p>Tools 让 AI 应用能够执行各种操作和功能。</p>
<p><strong>常见工具类型</strong>：</p>
<ul>
<li>🔍 <strong>搜索工具</strong>：Google Search、Bing Search</li>
<li>💾 <strong>数据操作</strong>：CRUD 数据库操作</li>
<li>📝 <strong>文件操作</strong>：创建、修改、删除文件</li>
<li>🌐 <strong>API 调用</strong>：第三方服务集成</li>
<li>🤖 <strong>自动化</strong>：执行脚本、触发工作流</li>
</ul>
<p><strong>使用示例</strong>：</p>
<pre class="line-numbers language-none"><code class="language-none">用户：帮我查询一下最近一周注册的用户数量
AI：正在查询数据库... [调用 MCP Server Tools 能力]
结果：最近一周共有 156 位用户注册<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="2-3-Prompts：把高频任务固化成模板"><a href="#2-3-Prompts：把高频任务固化成模板" class="headerlink" title="2.3 Prompts：把高频任务固化成模板"></a>2.3 Prompts：把高频任务固化成模板</h3><p>Prompts 提供可复用的提示词模板，提升 AI 交互效率。</p>
<p><strong>应用场景</strong>：</p>
<ul>
<li>📋 <strong>代码审查</strong>：自动化代码质量检查</li>
<li>📝 <strong>文档生成</strong>：根据代码生成文档</li>
<li>🐛 <strong>Bug 分析</strong>：分析错误日志和堆栈</li>
<li>🎨 <strong>内容创作</strong>：博客、文案生成模板</li>
<li>📊 <strong>数据分析</strong>：生成分析报告模板</li>
</ul>
<h2 id="三、MCP-Server-架构与通信机制"><a href="#三、MCP-Server-架构与通信机制" class="headerlink" title="三、MCP Server 架构与通信机制"></a>三、MCP Server 架构与通信机制</h2><h3 id="3-1-整体架构：AI-↔-MCP-↔-各类系统"><a href="#3-1-整体架构：AI-↔-MCP-↔-各类系统" class="headerlink" title="3.1 整体架构：AI ↔ MCP ↔ 各类系统"></a>3.1 整体架构：AI ↔ MCP ↔ 各类系统</h3><div class="mermaid-wrap"><pre class="mermaid-src" data-config="{}" hidden>
    graph LR
    subgraph AI层
        A1[Claude&lt;br&#x2F;&gt;Desktop]
        A2[其他&lt;br&#x2F;&gt;AI应用]
    end
    
    subgraph 客户端层
        B[MCP&lt;br&#x2F;&gt;Client SDK]
    end
    
    subgraph 服务端层
        C1[文件系统&lt;br&#x2F;&gt;Server]
        C2[数据库&lt;br&#x2F;&gt;Server]
        C3[API集成&lt;br&#x2F;&gt;Server]
    end
    
    subgraph 资源层
        D1[本地&lt;br&#x2F;&gt;文件]
        D2[MySQL]
        D3[REST&lt;br&#x2F;&gt;API]
    end
    
    A1 --&gt; B
    A2 --&gt; B
    B --&gt; C1
    B --&gt; C2
    B --&gt; C3
    C1 --&gt; D1
    C2 --&gt; D2
    C3 --&gt; D3
    
    style A1 fill:#e3f2fd
    style A2 fill:#e3f2fd
    style B fill:#fff9c4
    style C1 fill:#e1f5e1
    style C2 fill:#e1f5e1
    style C3 fill:#e1f5e1
    style D1 fill:#ffebee
    style D2 fill:#ffebee
    style D3 fill:#ffebee
  </pre></div>

<p><strong>架构说明</strong>：</p>
<ol>
<li><strong>AI 应用层</strong>：Claude Desktop 等支持 MCP 的 AI 应用</li>
<li><strong>MCP Client SDK</strong>：内置在 AI 应用中，负责与 MCP Server 通信</li>
<li><strong>MCP Server 层</strong>：各类功能的 MCP Server（文件、数据库、API 等）</li>
<li><strong>资源层</strong>：实际的数据源和服务</li>
</ol>
<h3 id="3-2-通信方式：stdio-与-HTTP-SSE"><a href="#3-2-通信方式：stdio-与-HTTP-SSE" class="headerlink" title="3.2 通信方式：stdio 与 HTTP&#x2F;SSE"></a>3.2 通信方式：stdio 与 HTTP&#x2F;SSE</h3><p>MCP 使用 <strong>JSON-RPC 2.0</strong> 作为底层通信协议，支持两种传输方式：</p>
<p><strong>1. 标准输入输出 (stdio)</strong></p>
<ul>
<li>适用场景：本地 MCP Server</li>
<li>特点：简单、直接、无需网络</li>
</ul>
<p><strong>2. HTTP&#x2F;SSE (Server-Sent Events)</strong></p>
<ul>
<li>适用场景：远程 MCP Server</li>
<li>特点：支持网络访问、可扩展</li>
</ul>
<h3 id="3-3-必须认识的关键消息类型"><a href="#3-3-必须认识的关键消息类型" class="headerlink" title="3.3 必须认识的关键消息类型"></a>3.3 必须认识的关键消息类型</h3><table>
<thead>
<tr>
<th>消息类型</th>
<th>方向</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>initialize</strong></td>
<td>Client → Server</td>
<td>初始化连接，协商能力</td>
</tr>
<tr>
<td><strong>resources&#x2F;list</strong></td>
<td>Client → Server</td>
<td>列出可用资源</td>
</tr>
<tr>
<td><strong>resources&#x2F;read</strong></td>
<td>Client → Server</td>
<td>读取特定资源内容</td>
</tr>
<tr>
<td><strong>tools&#x2F;list</strong></td>
<td>Client → Server</td>
<td>列出可用工具</td>
</tr>
<tr>
<td><strong>tools&#x2F;call</strong></td>
<td>Client → Server</td>
<td>调用特定工具</td>
</tr>
<tr>
<td><strong>prompts&#x2F;list</strong></td>
<td>Client → Server</td>
<td>列出提示词模板</td>
</tr>
<tr>
<td><strong>prompts&#x2F;get</strong></td>
<td>Client → Server</td>
<td>获取提示词内容</td>
</tr>
<tr>
<td><strong>notifications</strong></td>
<td>Server → Client</td>
<td>服务端推送通知</td>
</tr>
</tbody></table>
<h2 id="四、如何使用-MCP-Server"><a href="#四、如何使用-MCP-Server" class="headerlink" title="四、如何使用 MCP Server"></a>四、如何使用 MCP Server</h2><h3 id="4-1-在-Claude-Desktop-中快速接入-MCP-Server"><a href="#4-1-在-Claude-Desktop-中快速接入-MCP-Server" class="headerlink" title="4.1 在 Claude Desktop 中快速接入 MCP Server"></a>4.1 在 Claude Desktop 中快速接入 MCP Server</h3><p><strong>三步搞定：</strong></p>
<ol>
<li><strong>安装客户端</strong>：从 Claude 官网下载安装 Claude Desktop。</li>
<li><strong>编辑配置文件</strong>：<ul>
<li>macOS: <code>~/Library/Application Support/Claude/claude_desktop_config.json</code>  </li>
<li>Windows: <code>%APPDATA%/Claude/claude_desktop_config.json</code></li>
</ul>
</li>
</ol>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"mcpServers"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"filesystem"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"command"</span><span class="token operator">:</span> <span class="token string">"npx"</span><span class="token punctuation">,</span>
      <span class="token property">"args"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"-y"</span><span class="token punctuation">,</span> <span class="token string">"@modelcontextprotocol/server-filesystem"</span><span class="token punctuation">,</span> <span class="token string">"/Users/username/Documents"</span><span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="3">
<li><strong>重启并验证</strong>：重启 Claude Desktop，随便问一句：「帮我列一下 Documents 目录下的文件」，确认能正常调用 filesystem Server 即可。</li>
</ol>
<h3 id="4-2-最小可行配置：先从-1～2-个-Server-开始"><a href="#4-2-最小可行配置：先从-1～2-个-Server-开始" class="headerlink" title="4.2 最小可行配置：先从 1～2 个 Server 开始"></a>4.2 最小可行配置：先从 1～2 个 Server 开始</h3><ul>
<li>推荐起步组合：<ul>
<li>本地文件：<code>@modelcontextprotocol/server-filesystem</code>（读写文档 &#x2F; 笔记 &#x2F; 代码）。</li>
<li>二选一：<code>@modelcontextprotocol/server-github</code>（看代码仓库）或 <code>@modelcontextprotocol/server-postgres</code>（查业务数据）。</li>
</ul>
</li>
<li>其余常见 Server（GitHub、Postgres、Slack 等）的安装命令和用途，已经在<strong>第 6 章</strong>做了表格汇总，这里不重复展开。</li>
</ul>
<h3 id="4-3-配置文件中需要关注的三个字段"><a href="#4-3-配置文件中需要关注的三个字段" class="headerlink" title="4.3 配置文件中需要关注的三个字段"></a>4.3 配置文件中需要关注的三个字段</h3><ul>
<li><code>command</code>：启动 Server 的命令，一般写 <code>npx</code> 或 <code>node</code>。  </li>
<li><code>args</code>：传给命令的参数，第一个通常是 Server 包名，其余是路径或其它参数。  </li>
<li><code>env</code>：环境变量，用来传 Token、连接串等敏感信息（尽量不要写死在 args 里）。</li>
</ul>
<h3 id="4-4-AI-Agent-如何决定使用哪个-MCP-Server？（决策机制）"><a href="#4-4-AI-Agent-如何决定使用哪个-MCP-Server？（决策机制）" class="headerlink" title="4.4 AI Agent 如何决定使用哪个 MCP Server？（决策机制）"></a>4.4 AI Agent 如何决定使用哪个 MCP Server？（决策机制）</h3><p>从实现角度看，大多数支持 MCP 的 AI Agent（例如 Claude）在面对「选哪个 Server &#x2F; 工具」时，内部其实只做三件事：</p>
<ol>
<li><strong>能力发现（Capability Discovery）</strong><br>启动或加载配置时，Agent 会向所有已连接的 MCP Server 发送 <code>tools/list</code>，拿到每个工具的：<code>name</code>、<code>description</code> 和 <code>input schema</code>，相当于先建立一份「工具能力索引」。  </li>
<li><strong>语义匹配（Semantic Routing）</strong><br>用户发出指令（如「帮我查一下上海的天气」）后，LLM 先理解意图，再在所有工具的 <code>description</code> 中做语义检索，挑出最相关的候选，并生成对应的 Tool Call，例如：</li>
</ol>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"toolName"</span><span class="token operator">:</span> <span class="token string">"get_weather"</span><span class="token punctuation">,</span>
  <span class="token property">"arguments"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"city"</span><span class="token operator">:</span> <span class="token string">"上海"</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="3">
<li><strong>策略选择（Orchestration &amp; Selection）</strong><br>如果多个工具都“看起来能用”，LLM 会综合描述的专业度、当前对话上下文，以及（在一些实现中）历史成功率、响应速度等信号，选出一个或按顺序编排多个工具调用。</li>
</ol>
<blockquote>
<p>从使用者视角，一个非常重要的实践结论是：<strong>「给工具写好自然语言描述，比堆复杂参数更重要。」</strong> 只要 MCP Server 里的工具描述足够清晰、具体，AI Agent 往往就能做出非常准确的选择。</p>
</blockquote>
<h2 id="五、MCP-Server-实际应用场景"><a href="#五、MCP-Server-实际应用场景" class="headerlink" title="五、MCP Server 实际应用场景"></a>五、MCP Server 实际应用场景</h2><p>这一章的重点是：<strong>给你几个可以「马上照抄配置 + 直接开用」的典型场景心智</strong>，方便你把 MCP 真正用到日常工作里。</p>
<h3 id="5-1-四个最常见的使用场景"><a href="#5-1-四个最常见的使用场景" class="headerlink" title="5.1 四个最常见的使用场景"></a>5.1 四个最常见的使用场景</h3><table>
<thead>
<tr>
<th>场景</th>
<th>推荐 Server</th>
<th>主要能力</th>
<th>典型问题示例</th>
</tr>
</thead>
<tbody><tr>
<td>代码库分析</td>
<td><code>@modelcontextprotocol/server-github</code></td>
<td>浏览仓库、读文件、看 Issue &#x2F; PR</td>
<td>「帮我看看这个仓库怎么组织的？」</td>
</tr>
<tr>
<td>数据分析</td>
<td><code>@modelcontextprotocol/server-postgres</code></td>
<td>直接在数据库上做查询和聚合</td>
<td>「最近一个月新增用户趋势怎样？」</td>
</tr>
<tr>
<td>文档 &#x2F; 笔记管理</td>
<td><code>@modelcontextprotocol/server-filesystem</code></td>
<td>读取、搜索本地文档和笔记</td>
<td>「帮我总结一下这周会议纪要的要点」</td>
</tr>
<tr>
<td>团队协作提醒</td>
<td><code>@modelcontextprotocol/server-slack</code></td>
<td>读取频道消息、发送提醒</td>
<td>「帮我给 #tech 发个提醒，周三有分享会」</td>
</tr>
</tbody></table>
<blockquote>
<p>心智上可以简单记为：<strong>代码看 GitHub，数据问 Postgres，文件找 filesystem，提醒交给 Slack</strong>。</p>
</blockquote>
<h3 id="5-2-示例：代码库分析助手（GitHub）"><a href="#5-2-示例：代码库分析助手（GitHub）" class="headerlink" title="5.2 示例：代码库分析助手（GitHub）"></a>5.2 示例：代码库分析助手（GitHub）</h3><p><strong>配置示例</strong>：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"mcpServers"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"github"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"command"</span><span class="token operator">:</span> <span class="token string">"npx"</span><span class="token punctuation">,</span>
      <span class="token property">"args"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"-y"</span><span class="token punctuation">,</span> <span class="token string">"@modelcontextprotocol/server-github"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"env"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"GITHUB_PERSONAL_ACCESS_TOKEN"</span><span class="token operator">:</span> <span class="token string">"your_token"</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>接入完成后，你可以这样用 Claude：</strong></p>
<ul>
<li>让它<strong>总览一个仓库</strong>：目录结构、语言构成、Star &#x2F; Issue 概况。  </li>
<li>让它<strong>帮你读代码</strong>：指定文件、模块，要求用中文解释关键逻辑。  </li>
<li>让它<strong>筛 Issue &#x2F; PR</strong>：例如「帮我找最近一个月和性能优化相关的 Issue」。</li>
</ul>
<p>这样，你不用在浏览器里切来切去，代码阅读和讨论可以直接在聊天窗口完成。</p>
<h3 id="5-3-示例：业务数据-文档-协作的组合用法"><a href="#5-3-示例：业务数据-文档-协作的组合用法" class="headerlink" title="5.3 示例：业务数据 + 文档 + 协作的组合用法"></a>5.3 示例：业务数据 + 文档 + 协作的组合用法</h3><p>比较有价值的用法，往往不是「单个 Server」，而是<strong>把 2～3 个 Server 组合起来</strong>，完成一条完整的工作闭环。</p>
<p><strong>配置示例</strong>：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"mcpServers"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"postgres"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"command"</span><span class="token operator">:</span> <span class="token string">"npx"</span><span class="token punctuation">,</span>
      <span class="token property">"args"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"-y"</span><span class="token punctuation">,</span> <span class="token string">"@modelcontextprotocol/server-postgres"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"env"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"POSTGRES_CONNECTION_STRING"</span><span class="token operator">:</span> <span class="token string">"postgresql://localhost/mydb"</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"filesystem"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"command"</span><span class="token operator">:</span> <span class="token string">"npx"</span><span class="token punctuation">,</span>
      <span class="token property">"args"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"-y"</span><span class="token punctuation">,</span>
        <span class="token string">"@modelcontextprotocol/server-filesystem"</span><span class="token punctuation">,</span>
        <span class="token string">"/Users/username/Documents/Notes"</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"slack"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"command"</span><span class="token operator">:</span> <span class="token string">"npx"</span><span class="token punctuation">,</span>
      <span class="token property">"args"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"-y"</span><span class="token punctuation">,</span> <span class="token string">"@modelcontextprotocol/server-slack"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"env"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"SLACK_BOT_TOKEN"</span><span class="token operator">:</span> <span class="token string">"xoxb-xxxxxxxxxxxx"</span><span class="token punctuation">,</span>
        <span class="token property">"SLACK_TEAM_ID"</span><span class="token operator">:</span> <span class="token string">"T1234567890"</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>一个典型的「一条链」长这样：</strong></p>
<ul>
<li>第一步：用 <strong>Postgres Server</strong> 让 Claude 做数据分析，例如「帮我看最近 30 天的用户增长和留存」。  </li>
<li>第二步：用 <strong>Filesystem Server</strong> 让 Claude 把分析结果整理成一份 Markdown 报告，直接存到你的 Notes 目录。  </li>
<li>第三步：用 <strong>Slack Server</strong> 让 Claude 把报告结论用 2～3 句话发到指定频道，顺带 @ 相关同事。</li>
</ul>
<p>你只需要用自然语言驱动，底层的数据查询、文档生成、通知发送都由各个 MCP Server 接管。</p>
<h2 id="六、MCP-生态与社区资源"><a href="#六、MCP-生态与社区资源" class="headerlink" title="六、MCP 生态与社区资源"></a>六、MCP 生态与社区资源</h2><p>这一节的目标，不是「把所有项目都列一遍」，而是帮你<strong>快速知道去哪看官方信息、挑几个靠谱的现成 Server 用起来</strong>。</p>
<h3 id="6-1-必看的官方入口"><a href="#6-1-必看的官方入口" class="headerlink" title="6.1 必看的官方入口"></a>6.1 必看的官方入口</h3><table>
<thead>
<tr>
<th>类型</th>
<th>链接</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>📘 协议与概念</td>
<td><a href="https://modelcontextprotocol.io/">modelcontextprotocol.io</a></td>
<td>查概念、协议细节、设计初衷</td>
</tr>
<tr>
<td>📦 官方 SDK</td>
<td><a href="https://github.com/modelcontextprotocol">github.com&#x2F;modelcontextprotocol</a></td>
<td>TypeScript &#x2F; Python SDK 代码与示例</td>
</tr>
<tr>
<td>📝 官方示例 Server</td>
<td><a href="https://github.com/modelcontextprotocol/servers">MCP Servers</a></td>
<td>文件系统、Postgres、GitHub 等官方实现</td>
</tr>
</tbody></table>
<h3 id="6-2-实际最常用的几个-Server"><a href="#6-2-实际最常用的几个-Server" class="headerlink" title="6.2 实际最常用的几个 Server"></a>6.2 实际最常用的几个 Server</h3><table>
<thead>
<tr>
<th>场景</th>
<th>Server 名称</th>
<th>典型用途</th>
</tr>
</thead>
<tbody><tr>
<td>本地文件 &#x2F; 笔记</td>
<td><code>@modelcontextprotocol/server-filesystem</code></td>
<td>让 AI 读写本地文档、代码、笔记</td>
</tr>
<tr>
<td>代码仓库分析</td>
<td><code>@modelcontextprotocol/server-github</code></td>
<td>浏览仓库、看 Issue &#x2F; PR、读文件</td>
</tr>
<tr>
<td>业务数据查询</td>
<td><code>@modelcontextprotocol/server-postgres</code></td>
<td>直接在数据库上做分析查询</td>
</tr>
<tr>
<td>团队协作</td>
<td><code>@modelcontextprotocol/server-slack</code></td>
<td>读取频道信息、发送提醒消息</td>
</tr>
</tbody></table>
<p><strong>实践建议</strong>：<br>只要你刚开始用 MCP，<strong>先把文件系统 + GitHub + 一个数据库 Server 配起来，就已经覆盖了 80% 的高价值场景</strong>，其他的可以按需再加。</p>
<h3 id="6-3-想继续挖？用这两个入口就够了"><a href="#6-3-想继续挖？用这两个入口就够了" class="headerlink" title="6.3 想继续挖？用这两个入口就够了"></a>6.3 想继续挖？用这两个入口就够了</h3><ul>
<li>在 <strong>npm</strong> 搜：<code>@modelcontextprotocol/server</code>（官方 &#x2F; 社区 Server 列表一览）  </li>
<li>在 <strong>GitHub</strong> 搜：<code>mcp-server</code>（结合 Star 数和 README 判断成熟度）</li>
</ul>
<blockquote>
<p>这一节的重点心智：<strong>先用好少数几个稳定 Server，比一口气接一堆更重要。</strong></p>
</blockquote>
<h2 id="七、MCP-在实际工作中的价值"><a href="#七、MCP-在实际工作中的价值" class="headerlink" title="七、MCP 在实际工作中的价值"></a>七、MCP 在实际工作中的价值</h2><p>从工程和业务视角看，可以把 MCP 看成是「给 AI 接系统的标准接口层」，它带来的价值主要体现在三类角色上：</p>
<ul>
<li><strong>对业务方</strong>：更快把 AI 接入现有系统（文档、数据库、工单、监控等），不必为每个 AI 厂商单独开发一套插件。  </li>
<li><strong>对开发者</strong>：一次开发一个 MCP Server，就能被多个支持 MCP 的 AI &#x2F; Agent 复用，大幅减少重复适配工作。  </li>
<li><strong>对个人使用者</strong>：在 Claude 里统一访问本地文件、云盘、GitHub、协作工具，让 AI 真正成为自己的「个人控制台」。</li>
</ul>
<blockquote>
<p>可以简单理解为：<strong>MCP 是「AI 接入企业 &#x2F; 个人数字世界」的统一适配层。</strong></p>
</blockquote>
<h2 id="八、总结：三步用起来，而不是停留在概念"><a href="#八、总结：三步用起来，而不是停留在概念" class="headerlink" title="八、总结：三步用起来，而不是停留在概念"></a>八、总结：三步用起来，而不是停留在概念</h2><h3 id="8-1-记住一张「心智图」"><a href="#8-1-记住一张「心智图」" class="headerlink" title="8.1 记住一张「心智图」"></a>8.1 记住一张「心智图」</h3><ul>
<li>MCP &#x3D; 标准协议（定义 AI 和外部系统怎么对话）  </li>
<li>MCP Server &#x3D; 连接某个系统的适配器（文件、DB、GitHub、Slack…）  </li>
<li>AI Agent &#x3D; 根据你的自然语言，在这些适配器之间做选择和编排</li>
</ul>
<h3 id="8-2-立刻可以动手的三件事"><a href="#8-2-立刻可以动手的三件事" class="headerlink" title="8.2 立刻可以动手的三件事"></a>8.2 立刻可以动手的三件事</h3><ol>
<li>在本机安装 Claude Desktop。  </li>
<li>先只配置 1–2 个 Server（推荐：filesystem + GitHub 或 filesystem + Postgres）。  </li>
<li>给这些 Server 里的工具写<strong>清晰的中文描述</strong>，方便 Agent 做准确决策。</li>
</ol>
<h3 id="8-3-真正用起来之后再考虑扩展"><a href="#8-3-真正用起来之后再考虑扩展" class="headerlink" title="8.3 真正用起来之后再考虑扩展"></a>8.3 真正用起来之后再考虑扩展</h3><ul>
<li>用一段时间，看哪些场景最常用，再决定要不要加更多 Server。  </li>
<li>如果你所在团队有自研系统，可以考虑把它们「包」成内部 MCP Server，让团队所有人都用同一套能力。</li>
</ul>
<hr>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>MCP 协议让「AI 连接外部世界」这件事第一次有了统一答案，不再是各家各玩各的插件体系。<br>对你来说，更重要的不是把协议条款背下来，而是<strong>尽快在自己的日常工作流里跑通 1～2 个高价值场景</strong>。</p>
<p>从今天开始，在 Claude Desktop 中接上第一个 MCP Server，让 AI 真正「接入你的世界」。🚀</p>
]]></content>
      <categories>
        <category>AI编程</category>
      </categories>
      <tags>
        <tag>AI</tag>
        <tag>MCP</tag>
        <tag>Claude</tag>
        <tag>协议标准</tag>
      </tags>
  </entry>
  <entry>
    <title>《极简主义》</title>
    <url>/2021/02/16/book/ji-jian-zhu-yi/</url>
    <content><![CDATA[<p><img src="/images/%E6%9E%81%E7%AE%80%E4%B8%BB%E4%B9%89.jpg" alt="极简主义"></p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p><em><strong>《极简主义》—— 活出生命真意</strong></em></p>
<blockquote>
<p>[美]乔舒亚·菲尔茨·米尔本 瑞安·尼科迪默斯 —— 著<br>李紫 —— 译</p>
</blockquote>
<h1 id="书序"><a href="#书序" class="headerlink" title="书序"></a>书序</h1><p>极简主义不是要你一无所有，而是要你穿越物质的海洋，找到真正重要的东西。在《极简主义》一书中，放弃高薪主管工作、转身成为美国极简主义生活先锋的乔舒亚和瑞安，分享了他们自己的人生故事和极简主义的生活理念。通过舍弃生活中多余的东西，我们得以超越物质，集中精力追求生命中最重要的 五种价值：健康、人际关系、热情、成长和奉献。 </p>
<h1 id="精彩内容"><a href="#精彩内容" class="headerlink" title="精彩内容"></a>精彩内容</h1><p>幸福源自内部，源自内心，源自充满意义的生活。</p>
<blockquote>
<p>不是转瞬即逝的欢愉，而是长久的满足，来自自律、专注、觉知、目的明确的生活。快乐只是一个副产品而已。</p>
</blockquote>
<p>快乐是我们专注于某个事情时的副产品，如果直接去寻求快乐，反而难以找到。</p>
<blockquote>
<p>我们在这世上只有有限的时间，这些时间可以用来积攒金钱财富，也可以花在有意义的事情上——后者不一定会妨碍人们追求前者，但对财富永无止境的追求并不能将我们带向有意义的生活。</p>
</blockquote>
<p>生命是有限的，我们应该先去寻找有意义的事情上。金钱只是在我们寻找有意义事情路上的一种重要工具，而不是我们最终的目标。</p>
<blockquote>
<p>我们不打算练得像个健美运动员。我们关心的是身体健康，体形匀称，对自己的身体状况感觉良好。在过去的几年间，我们试验了一些对我们有效的方法（其他很多东西对我们没什么用），而在此期间，我们发觉评价成功与否的最重要标准不在于体重秤上的数值，而是以下两件事：</p>
<ul>
<li>1．我们是否在持续地改善健康？</li>
<li>2．我们对自己的进步是否满意？</li>
</ul>
</blockquote>
<p>人生是一次长跑，只要我们不放弃就一定会到达终点。所以最终的成功不在阶段性的成果，而是在于你是否一直在坚持，一直在进步。</p>
<blockquote>
<p>要停止嫉妒，最简单的方法就是停止思考他人的意图。我们会嫉妒，往往是因为认为某人的行为意味着什么，而事实上他并没有那个意思。然而你永远不会知道别人的真实意图，所以思考这些根本就是浪费时间。</p>
</blockquote>
<p>以自我为中心，去揣测别人的意图往往会引起误解、嫉妒等负面情绪。保持良好的沟通可以在一定程度避免这些问题</p>
<blockquote>
<p>如果金钱不成问题，你的人生里你想做些什么？</p>
</blockquote>
<p>很早就发现，生活中缺少真正热爱的事情.</p>
<blockquote>
<p>换句话说，我人生的意义就是成长为一个独立个体，并以有意义的方式为他人做贡献。而好消息就是你可以决定自己该如何完成这两件事。</p>
</blockquote>
<p>在《活出生命的意义》一书中，生命的意义可以总结为以下三点：</p>
<ul>
<li>1.从事一份你喜欢的工作并投入其中 </li>
<li>2.爱，去爱一个人了解他的全部 </li>
<li>3.深处绝境仍能克服困难，勇敢的面对</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>在这个物欲横流的时代，极简主义或许是一种值得我们探索的生活方式。极简主义不是让你舍弃生活中的大多数东西过只拥有极少物质的生活，而是让你专注于生命中重要的、有意义的东西，拥有极少物质只是我们践行极简主义的结果而已。极简主义是一种工具，帮助我们追求生命中五种重要的价值：健康、人际关系、热情、成长、奉献。</p>
]]></content>
      <categories>
        <category>book</category>
      </categories>
      <tags>
        <tag>读书</tag>
      </tags>
  </entry>
  <entry>
    <title>《能力陷阱》</title>
    <url>/2022/05/04/book/neng-li-xian-jing/</url>
    <content><![CDATA[<p><em><strong>《能力陷阱》（Act Like A Leader, Think Like A Leader）—— 像领导者一样行动，像领导者一样思考。</strong></em></p>
<p><img src="/images/book/%E8%83%BD%E5%8A%9B%E9%99%B7%E9%98%B1.jpeg" alt="能力陷阱"></p>
<h1 id="写在前面的话"><a href="#写在前面的话" class="headerlink" title="写在前面的话"></a>写在前面的话</h1><p>这本书很早就在樊登读书的APP上听过一次，当时听完后并未留下深刻的印象。随着自己工作经历的增加，开始不断反思自己的人生，发现自己像是掉入泥潭之中，不断挣扎，但却找不到方法和方向。有天在下班的路上，想起了这本书于是重新把这本书听了一遍，从中仿佛找到了方向。于是买了实体书来看，刚开始翻看了一部分，然后由于这样那样的原因一直无法静下心来去读完，直至今年五一假期，一鼓作气读完了这本书。起初我以为这是面向领导者的书籍，读完后发现，这本书适合每个想要在职业生涯中更进一步的人。我自己今年在工作中担任了小组长的角色，需要进行一些自我转变，这本书帮我分析清了自我转变的过程以及过程中会遇到的问题，并提供了许多方法。同时这本书让我学会了重新定义自己，打破自己曾经的思维困境，走出泥潭。</p>
<p>“有些书你可能早早的买来了，但是翻看了几页由于未能提起你的兴致，就搁置在书架上去了，直到有一天你从书架上看到了它并拿起翻看了一下，然后一下子被内容吸引一鼓作气读完了。当我们的人生经历无法和书中的内容产生共鸣时，很难有兴致继续读下去，即使坚持读完也是读的似懂非懂。当我们经历了足够多的事情后，再拿起这本书时，有一种豁然开朗的感觉，读的如痴如醉。所以不必着急清理你的书架上还未曾读完的书，也许你们的缘分要迟一点到“。这是我曾在另一本书中看到的一段话，完全印证了我读这本书的经历。</p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><blockquote>
<p>[美]埃米尼亚·伊贝拉 —— 著 &#x2F; 王臻 —— 译</p>
</blockquote>
<blockquote>
<p>我们很乐于去做我们擅长的事，于是就会一直去做，最终就使得我们会一直擅长那些事。做的越多，就越擅长，越擅长就越愿意去做。这样的一个循环能让我们在这方面获得更多的经验，但却容易陷入能力陷阱，在其它方面无法突破。</p>
</blockquote>
<blockquote>
<p>每个人都要特别警惕这种能力陷阱，避免把大量时间花在日常琐事上。如果你想获得更多更好的发展，就要从日常琐事中解脱出来，转变到更多策略性思考、在日常工作外建立人际关系网络、提升影响力等能够给你带来持续价值的工作上，这样你才能在各领域获得更好的发展。</p>
</blockquote>
<p>这不是一本鸡汤励志书籍，本书作者埃米尼亚·伊贝拉是欧洲工商管理学院（INSEAD）组织行为学教授兼领导与学习首席教授。在加入INSEAD前，她在哈佛商学院工作了13年。书中结合了大量的研究及教学案例，是作者数十年研究的精华所在，内容通俗易懂，满满的全是干货。</p>
<h1 id="一、领导者的能力陷阱"><a href="#一、领导者的能力陷阱" class="headerlink" title="一、领导者的能力陷阱"></a>一、领导者的能力陷阱</h1><h2 id="1-1-改变思想从行动开始"><a href="#1-1-改变思想从行动开始" class="headerlink" title="1.1 改变思想从行动开始"></a>1.1 改变思想从行动开始</h2><blockquote>
<p>很多传统的领导力培训或辅导的目的是改变你思考的方式，教你学会反思你是谁以及你要成为谁的问题。的确，自省和反思是成为一个领导者的黄金法则。首先要提高自我意识，认识自己。如果你尝试过这些方法，你就会发现它们是非常有局限性的。虽然在很大程度上，它们能帮助你认识到你当前的能力以及领导方式，但是我们会发现，当前的想法恰恰是阻碍你继续前行的绊脚石。所以你需要改变的是你的思考方式，而只有一种方法能改变它：改变你的做事方法。</p>
</blockquote>
<blockquote>
<p>亚里士多德发现，一个人如果表现得很有美德，那他最终会成为一个有美德的人，即多做好事就会变成好人。他的这一说法得到很多社会心理学家的证实，研究表明一个人若改变了他的想法，是因为他的行为先发生了改变。简单来说，改变是由外而内，而并非由内而外产生的。正如管理专家理查德·帕斯卡尔（Richard Pascale）所说：“成年人更倾向于先做而后产生新的想法，而不是先想再以一种新的方式去做。”</p>
</blockquote>
<p>古语有云：三思而后行。在做一件事前，我们仔细思考然后做好详细计划，这在正常情况下通常都非常有用。但是当我们去做新的事情、面对新的挑战的时候，由于从未有过经验，我们会犹豫再三，努力思考我们的方案或计划是否可行，很多时候在思考中错过了最佳时机。所以当面对新的事物，或者面临改变的时候，思想仍然停留在过去，必须先行动再思考。</p>
<p>此外我还发现一个规律：<code>完美的表现 = 适当的状态 + 恰当的时机</code>，一直以来我抱着“十年磨一剑”的心态，常常希望自己达到最佳状态再行动。很多时候，当我们准备好的时候，但是却错过了最佳的时机，结果反不如提前行动的效果好。</p>
<h2 id="1-2-由外而内的转变"><a href="#1-2-由外而内的转变" class="headerlink" title="1.2 由外而内的转变"></a>1.2 由外而内的转变</h2><blockquote>
<p>如果我们像一个领导者一样做事：如不断提出新观点，在专业领域之外做出贡献，或是集合人力物力做成一件很有价值的事，等等。身边的其他人也就会觉得我们越来越像一个真正的领导者。研究发现，社会认同及个人名声给心理学家所谓的领导者身份内在化（Internalizing，即把自己看作一个领导者）提供了条件，从而使他们能抓住更多的机会来展现自己的领导才能。</p>
</blockquote>
<blockquote>
<p>先像领导者一样做事，而后才能像领导者一样思考，这样的一个循环——外在改变引起的内在改变——也就是我所谓的“由外而内”（Outsight）。</p>
</blockquote>
<h2 id="1-3-“由外而内“原则"><a href="#1-3-“由外而内“原则" class="headerlink" title="1.3 “由外而内“原则"></a>1.3 “由外而内“原则</h2><blockquote>
<p>一个人的思维方式是很难改变的，因为改变需要外在经历。如果不是由外而内地改变，我们的自我认知会被过去所禁锢，从而导致思想和行为也无法改变。没有人会比我们自己更适合给自己进行定位。改变的矛盾在于，改变想法的唯一办法就是要做一些之前没有做过的事，而这些事正是之前的想法所不认同的事。</p>
</blockquote>
<blockquote>
<p>先像领导者一样行事，如积极参与新项目以及新活动，与各式各样的人打交道以及尝试采用新方法做事等。那些充满挑战的新经历以及它们所带来的成就会改变那些一直限制你的固有行为和思维。在改变的不稳定时期，思考和反省是会跟随你的行为和尝试而发生改变的，而非反方向行之。新的经历不仅会改变你的想法——你认为什么是重要的，什么是值得去做的，还会改变你未来的样子。它们可以帮助你从一些新的成就里获得自信，使你放弃过去的目标，还可以改变你过去所习惯的做事方法。</p>
</blockquote>
<blockquote>
<p>与自省相比，由外而内地改变更能帮助你重塑形象，告诉你你能做什么。成为一名优秀的领导者并非是你发展道路上的起点，而是你自我身份认知的结果。这种认知只有在你与新认识的人，一起做新的工作时才会产生。这并不是说你因此发现了真正的自我，而是说你所做的事折射出了真实的你。</p>
</blockquote>
<blockquote>
<p>如果我们从相反的方向，也就是由内而外的方向来改变，那是行不通的。与大众普遍认为的观点相反，自省大多时候只会让我们停留在过去，蒙蔽我们的双眼，使我们无法发现我们的领导潜能，还会让我们毫无准备地去面对周围环境的根本转变。这就好比在昏暗的路灯下寻找丢失的手表，你需要有很强的观察力；同样地，解决新问题也需要这种能力，而这种能力来源于我们在做与以往不一样的事情时所获得的新的见解。伟大的社会心理学家卡尔·韦克（Karl Weick）将其简述为：“我何以知道自己在想什么呢？——只有在看到我做了什么以后才能知道。”</p>
</blockquote>
<h2 id="1-4-“三步走”助你实现领导者转变"><a href="#1-4-“三步走”助你实现领导者转变" class="headerlink" title="1.4 “三步走”助你实现领导者转变"></a>1.4 “三步走”助你实现领导者转变</h2><blockquote>
<p>领导者转变方法都是根据以下三个增强外在表现力的方法而写成的：</p>
<ul>
<li>一是思考你所做工作的类型；</li>
<li>二是转换新角色或参与新活动能让你接触到不同的人，这些人有着与你不一样的世界观；</li>
<li>三是重新审视自己。因为只有当你受到新环境的挑战或接受外界新的刺激时，你才会产生如此多新的想法。</li>
</ul>
</blockquote>
<blockquote>
<p>实现“由外而内”的转变并非是一件一次就能成功的事，而是一个不断检验旧的假设，提出新可能性的过程。所以要实现转变，最好的出发点就是先重新定义工作，然后重建人际关系网络，最后再改变做事方法。</p>
</blockquote>
<h1 id="二、重新定义你的工作"><a href="#二、重新定义你的工作" class="headerlink" title="二、重新定义你的工作"></a>二、重新定义你的工作</h1><h2 id="2-1-从“不对”转变到“对”"><a href="#2-1-从“不对”转变到“对”" class="headerlink" title="2.1 从“不对”转变到“对”"></a>2.1 从“不对”转变到“对”</h2><blockquote>
<p>他们根据各自的专长，把工作定义在一个较窄的范围内，把自己的活动范围限制在过去能给他们带来最大价值的持续性成果的领域。事业初期，他们需要扮演这样一个角色。但是经过一段时间以后，别人对他们的期望会发生改变。所以想要避免发生这种能力陷阱（Competency Trap），你就需要明白，那些曾经对你有用的想法和工作习惯只有在经受住考验后才可能一直适用，否则它们就需要做出改变。</p>
</blockquote>
<h2 id="2-2-避免能力陷阱"><a href="#2-2-避免能力陷阱" class="headerlink" title="2.2 避免能力陷阱"></a>2.2 避免能力陷阱</h2><blockquote>
<p>我们很乐于去做那些我们擅长的事，于是就会一直去做，最终就使得我们会一直擅长那些事。做得越多，就越擅长，越擅长就越愿意去做。这样的一个循环能让我们在这方面获得更多的经验。而它就像是毒品一样，我们被它深深吸引，因为我们的快乐和自信都来源于它。它还会让我们产生误区，让我们相信我们擅长的事就是最有价值的且最重要的事，所以值得我们花时间去做。</p>
</blockquote>
<h3 id="让自己在团队里过于有价值"><a href="#让自己在团队里过于有价值" class="headerlink" title="让自己在团队里过于有价值"></a>让自己在团队里过于有价值</h3><blockquote>
<p>管理者把太多精力放在细节上——尤其是在他的专业领域范围内，并且对他的团队进行了太多的微观管理，以至于团队的成绩完全由他一个人来领导完成。</p>
</blockquote>
<p>这样的方式让我们觉得我们是团队中不可或缺的，但是同时，也限制了我们发展的可能，因为我们在团队中是不可或缺的，你没法脱离现在的职位。</p>
<h2 id="2-3-了解领导者真正需要做的事情"><a href="#2-3-了解领导者真正需要做的事情" class="headerlink" title="2.3 了解领导者真正需要做的事情"></a>2.3 了解领导者真正需要做的事情</h2><p>要像领导者一样行事，我们需要把时间花在以下这些事上：</p>
<ul>
<li>像桥梁一样连接不同的人或组织</li>
<li>展望新未来</li>
<li>提升影响力</li>
<li>将想法与个人经历结合</li>
</ul>
<p>有魅力的领导者都有以下三个共同点：</p>
<ul>
<li>人生阅历丰富，从而产生了坚定的信念</li>
<li>能通过讲述个人故事来与他人进行良好的交流</li>
<li>他们的想法、实际所做的事以及他们自己之间有很强的一致性</li>
</ul>
<h3 id="劝说的秘诀"><a href="#劝说的秘诀" class="headerlink" title="劝说的秘诀"></a>劝说的秘诀</h3><blockquote>
<p>我们很多人都通过讨论需要做什么以及应该如何去做来劝服别人。劝说的秘诀是展示出你最有力的论据。依据我们自己的逻辑和优势，把我们的想法强加给别人，这样的做法并不会十分有用，因为我们最终会跟随那些能鼓舞我们的人，而不仅仅是有能力的人。相反，成功的领导者们会以解释“为什么”——解释他们内心深处的信念和目的——来开始对人们进行鼓舞。这样一来，他们更能打动人。</p>
</blockquote>
<p>这个现象同样出现在我们生活中，我们经常通过摆道理讲事实方式去劝说别人，然而效果往往不佳。因为道理大家都懂，讲得太多反而遭人厌烦引起反感，对方真正需要的是鼓舞。</p>
<h2 id="2-4-把你的工作当成一个平台"><a href="#2-4-把你的工作当成一个平台" class="headerlink" title="2.4 把你的工作当成一个平台"></a>2.4 把你的工作当成一个平台</h2><p>不管你目前的情况是什么样的，以下五件事都可以开始让你的工作变成一个能增强你领导力的平台：</p>
<ul>
<li>增强你对形势的定位感</li>
<li>接触你专业领域之外的项目</li>
<li>参与外部活动</li>
<li>结合个人经历谈谈“为什么”</li>
<li>放松你的日程安排</li>
</ul>
<blockquote>
<p>如果你觉得自己已经停滞不前或是缺乏新鲜感，那就参加行业会议或者其他聚集各行各业的专业聚会来增长你的见识。</p>
</blockquote>
<p>参加行业会议和专业聚会确实是一个好主意，当再遇到这样的机会应该尽可能参加，不应当再错过。</p>
<h3 id="最成功的管理者看起来反而是最没有效率的那个"><a href="#最成功的管理者看起来反而是最没有效率的那个" class="headerlink" title="最成功的管理者看起来反而是最没有效率的那个"></a>最成功的管理者看起来反而是最没有效率的那个</h3><blockquote>
<p>很多年前，一个不为人所知的管理学者约翰·科特（John Kotter）拿着一台手持相机，跟踪拍摄了一群总经理的生活，看看实际上他们每天都在做什么（和大家以为他们每天所做的恰恰相反）。最令他惊讶的是，最成功的管理者看起来反而是最没有效率的那个。</p>
</blockquote>
<p>很多时候我们都让自己陷入忙碌之中，但是我们的效率并不一定是最高的，所以要摆脱那种劳模的心态，尝试更有效率的方式。</p>
<h3 id="“空出一个手术室”"><a href="#“空出一个手术室”" class="headerlink" title="“空出一个手术室”"></a>“空出一个手术室”</h3><blockquote>
<p>美国哈佛大学经济学家森德希尔·穆莱纳桑（Sendhil Mullainathan）和普林斯顿大学心理学教授埃尔德·沙菲尔（Eldar Shafir）合著的名为《稀缺》（Scarcity）的书中在缺钱和缺时间之间做了一个很有意思的对比。他们指出，两者都能将你限制在一根“管子”（Tunneling）中，人们只能看到“管子”中的事物，虽然这能给我们带来短期利益，但从长远来看，反而会起到限制作用。<br>穆莱纳桑和沙菲尔用某医院的故事来证明这个观点，该医院的病房常常被提前预约满了。而由于病房都满了，所以当有急诊时——常常出现这样的情况——医院只能把手术计划拖延。“因此，医务人员常常在深夜两点都还在做手术，而医师们常常要等上好几个小时才能做大约只有两个小时的手术，其他工作人员也常常不定时地加班。”因为医院的手术经常滞后，所以经常需要不停地重新安排工作，从而造成了一个低效又高压的工作形式。<br>像大多数遇到问题的公司一样，医院从外部聘用了一个顾问，他提出一个令人惊讶的解决方法：空出一个手术室来应对急诊病人。像我们大多数人会有的反应一样，医院的管理者说：“我们都已经非常忙了，他还要我们空出一个手术室，这太过分了。”<br>就像对于很多过于投入的人来说，他们无法想象把花费大量时间一直在做的事停下来重新组织，更不要说放弃有用或是没用的珍贵资源，医院管理者也产生了同样的怀疑。但是空出一个手术室的方法奏效了。有了一个空手术室后，医务人员能更有效地处理一些紧急病例，不用重新计划所有的一切。因此，他们加班的时间也减少了，手术的效率也提高了。</p>
</blockquote>
<h1 id="三、建立良好的人际关系网络"><a href="#三、建立良好的人际关系网络" class="headerlink" title="三、建立良好的人际关系网络"></a>三、建立良好的人际关系网络</h1><blockquote>
<p>良好的人际关系网络是如何为你服务的？首先，它能让你的消息变得更灵通，更容易获取最新的信息；其次，它让你更富有创新精神，为你的创想提供更坚实的基础；最后，它还可能在你遭遇危机时，助你脱离险境，这样的例子不胜枚举。</p>
</blockquote>
<h2 id="3-1-寻找你的人际“结构洞”"><a href="#3-1-寻找你的人际“结构洞”" class="headerlink" title="3.1 寻找你的人际“结构洞”"></a>3.1 寻找你的人际“结构洞”</h2><blockquote>
<p>你的人际关系网络的战略性优势能帮助你成为一名优秀的领导者，该优势取决于以下三点性质：</p>
<ul>
<li>广泛性（Breadth）：一个广泛的人际关系网络，与各行各业的人建立联系</li>
<li>连接性（Connectivity）：作为桥梁连接一些在其他方面没有关联的人和团队的能力</li>
<li>动态性（Dynamism）：随着你的进步而发展</li>
</ul>
<p>我把以上三点性质称为人际关系网络的优势：广连动，或是人际关系网络的优势&#x3D;广泛性+连接性+动态性。</p>
</blockquote>
<blockquote>
<p>人际关系网络的多元性、连接性和动态性这三大优势都是相互联系、相辅相成的。如果没有这些优势，你就没有办法认识新的人，你的人际关系网络就会陷入死循环，久而久之，你就会丧失洞察力和关联力。</p>
</blockquote>
<h2 id="3-2-如何在公司内外建立人际关系网络"><a href="#3-2-如何在公司内外建立人际关系网络" class="headerlink" title="3.2 如何在公司内外建立人际关系网络"></a>3.2 如何在公司内外建立人际关系网络</h2><ul>
<li>展示自我</li>
<li>利用二度分割理论</li>
<li>维持关系</li>
<li>找到志同道合的人</li>
</ul>
<h1 id="四、试着朝更多不同的方向发展自己"><a href="#四、试着朝更多不同的方向发展自己" class="headerlink" title="四、试着朝更多不同的方向发展自己"></a>四、试着朝更多不同的方向发展自己</h1><blockquote>
<p>在我25年的执教生涯中，我发现有一件事一直没有改变：人们一直有着强烈的想要做真实的自己的愿望，对于做那些让他们觉得虚假的事也有着同样强烈的厌恶。这些行为背后最重要的刺激因素之一是，人们认为这是内心深处真实自我的基本表现。而正是这样的想法，让我们在领导者转变道路上遇到了阻碍。</p>
</blockquote>
<p>这一点着实戳中了我的痛点，每当自己尝试做一些改变时，内存就会产生疑惑，如果我这样做了，我还是我吗？</p>
<h2 id="4-1-“随机应变者”与“坚持真实者”"><a href="#4-1-“随机应变者”与“坚持真实者”" class="headerlink" title="4.1 “随机应变者”与“坚持真实者”"></a>4.1 “随机应变者”与“坚持真实者”</h2><p>真实性与自我保护之间的界线应该在哪儿呢？</p>
<blockquote>
<p>“随机应变者”有一个核心的自我价值观和目标，他们并不会担心转变自己会对自己的信仰造成影响.<br>“坚持真实者”则与之相反，他们认为如果要根据环境而变换自己，使得他们远离了自己最自然的风格，这是对他们真实性的一种威胁。<br>“坚持真实者”就遵循着旧的方式和风格，因此停滞不前。他们通过展示自己高超的技术来证明自己的能力，这里引用以下他们所相信的观点：“注重实质结果，而不是形式。”（Substance Rather Than Form）通常情况下，他们把上级的成功总结为：“光说不做，没实际能力”（All Talk and Little Content）——那些技术高超的专业人士所追求的，尽管看上去没有太大的吸引力。他们认为，相比起那些“随机应变者”善于变换自己的能力，高超的技术是更为真实的，并以此为豪。</p>
</blockquote>
<p>从上面话中仿佛看到了我自己，现在的我更多的是倾向于是一个“坚持真实者”，需要向“随机应变者”转变。</p>
<blockquote>
<p>在很多工作中，凭借着自己精湛的技术，“坚持真实者”获得了成果。尽管如此，在他们想要成为一名优秀的领导者过程中还是会遭遇很多挫折。对于一名优秀的领导者来说，他们的悟性和他们目前的知识一样重要，成功需要的是把要担任的新角色内在化。有些讽刺的是，“坚持真实者”尝试保持真实性，这却削弱了他们梦想成为的那种领导者的能力。相反，“随机应变者”——他们“假装自己是一个优秀领导者，最后真的成了一个这样的人”，这样的人反而能更快达到自己的目标，最终成为一个真实的，不一样的，能力更强的自己：他们用一种新的方法来行事，最终成就了一个新的真实的自己</p>
</blockquote>
<blockquote>
<p>哥伦比亚大学心理学教授 托里· 希金斯（Tory Higgins）所说的“阻碍”（Prevention）——与“促进”（Promotion）相反。当你在“促进”模式时，你会不停地追求目标，注重你能从自己的努力中获取多少。而在“阻碍”模式时，你会试图避开那些可能对目前的你造成威胁的事，关注点放在你可能会失去什么。正如我们在本章所看到的，成为一个优秀的领导者需要处在一个“促进”模式，但是在转变过程中遇到的很多问题都会触发“阻碍”模式</p>
</blockquote>
<h2 id="4-2-真实性的定义"><a href="#4-2-真实性的定义" class="headerlink" title="4.2 真实性的定义"></a>4.2 真实性的定义</h2><ul>
<li>忠实于自己</li>
<li>真诚，你的所说所做和你想的一致</li>
<li>忠实于自己的价值观和目标</li>
<li>我们不能完全控制我们的身份</li>
</ul>
<h2 id="4-3-“真实性”陷阱"><a href="#4-3-“真实性”陷阱" class="headerlink" title="4.3 “真实性”陷阱"></a>4.3 “真实性”陷阱</h2><blockquote>
<p>我们能学到东西的场合恰恰也正是我们自我认识会面临挑战的时候，这就是为什么在我们成为领导者的道路上，很多人会觉得自己面临着失败或是虚假的两难选择。</p>
</blockquote>
<h3 id="更容易陷入“真实性”陷阱的三种情况"><a href="#更容易陷入“真实性”陷阱的三种情况" class="headerlink" title="更容易陷入“真实性”陷阱的三种情况"></a>更容易陷入“真实性”陷阱的三种情况</h3><blockquote>
<p>第一种情况是，在转变到一个新的角色时，一些人很难与他们的团队保持一个合适的距离，要不就是太近，要不就是太远，把自己的想法都藏在心里不说出来；第二种情况是，另一些人认为他们不需要出售他们的观点，或是不需要刻意地去鼓励其他人。他们不会做一些费劲的事去和别人建立关系，因为他们认为那是在“利用别人”；第三种情况是，一些人通过他们真实的自我的“透镜”过滤掉一些不好的反馈，他们说服自己不自然的领导风格体现出来的不正常的东西，正好是提高自己效率的重要方面。</p>
</blockquote>
<blockquote>
<p>忠实于自己并不意味着你需要举着灯，把自己内心照得透亮，让人们一眼就能看穿你。你没有必要把心里所想的每一个想法和感受都和别人说。</p>
</blockquote>
<blockquote>
<p>利用权力和打感情牌会让人觉得很不舒服。但事实上，领导别人和利用权力之间唯一的不同是，领导别人是一种为了达到一个共同目标而相互影响的行为。</p>
</blockquote>
<blockquote>
<p>作为一个领导者，如果你能明白，给你的下属分派任务是为了完成更高级别的组织任务，那么你就再也不会认为虚假或是在操纵别人了。当你是为了更高的目标工作时，你就再也不会觉得这是在为了你自己或是你的自我意识或是你的事业而工作了。给别人分派任务只是为了完成共同的目标。</p>
</blockquote>
<h2 id="4-4-扩展你的自我概念"><a href="#4-4-扩展你的自我概念" class="headerlink" title="4.4 扩展你的自我概念"></a>4.4 扩展你的自我概念</h2><blockquote>
<p>LinkedIn的创建者雷德·霍夫曼（Reid Hoffman）和本·卡斯诺查（BenCasnocha）合著的书中说到“很多人对于建立人际关系网络的感觉和用牙线的感觉一样：对你是有益的，但不有趣”。我发现当你发展自己的时候，也会有同样的感觉。你常常会觉得这很费劲。</p>
</blockquote>
<h3 id="像艺术家一样偷师学艺"><a href="#像艺术家一样偷师学艺" class="headerlink" title="像艺术家一样偷师学艺"></a>像艺术家一样偷师学艺</h3><blockquote>
<p>如果说有一门职业是注重真实性的，那就是艺术。同时，除了一个艺术家，没有任何人更清楚没有什么是原创的。<br>模仿别人这件事对于他们来说很困难，还会让他们觉得自己不真实。就像作家威尔逊·米茨纳（Wilson Mizner）所说的，如果你模仿一个作家，那就是剽窃，但是如果你模仿很多个作家，那就是研究。</p>
</blockquote>
<p>真正重要的不是“偷”别人的风格，而是“偷”隐藏在风格背后的思想。</p>
<h2 id="4-5-为什么要像水一样"><a href="#4-5-为什么要像水一样" class="headerlink" title="4.5 为什么要像水一样"></a>4.5 为什么要像水一样</h2><blockquote>
<p>李小龙认为你应该“利用一切你能利用的资源”。他所说的“像水一样”，是指不要仅仅局限在一个形象里，要能适应新的环境，在新的环境里塑造一个新的自我形象（例如，把水倒进杯子里，它就是杯子的形状；把水倒进瓶子里，它就是瓶子的形状）</p>
</blockquote>
<blockquote>
<p>人类所具有的一项很神奇的缺点就是，我们没有办法完全模仿别人。在我们未能成功模仿我们的偶像时，便会发现真实的自己。这就是进步过程。</p>
</blockquote>
<h1 id="五、合理的规划前进的道路"><a href="#五、合理的规划前进的道路" class="headerlink" title="五、合理的规划前进的道路"></a>五、合理的规划前进的道路</h1><blockquote>
<p>要成为一个优秀的领导者，并不是一件突然就发生的事，而是一个漫长的积累过程。采取新的行动很重要，即使有时候做一些新的事情会让我们觉得虚假，因为它们很快就能带来成果，并不断刷新可能性，但是很少会有一条清晰的完成界线。</p>
</blockquote>
<h2 id="5-1-照食谱做菜并不能让你成为一个好厨师"><a href="#5-1-照食谱做菜并不能让你成为一个好厨师" class="headerlink" title="5.1 照食谱做菜并不能让你成为一个好厨师"></a>5.1 照食谱做菜并不能让你成为一个好厨师</h2><blockquote>
<p>很多改变的方法告诉你开始的时候要想好，改变以后获得的结果是什么。但实际上，弄清楚你想要成为什么样的领导者是改变中最后一件需要做的事，而不是第一件。</p>
</blockquote>
<h3 id="“进步的过程”"><a href="#“进步的过程”" class="headerlink" title="“进步的过程”"></a>“进步的过程”</h3><blockquote>
<p>我所说的“进步过程”（Stepping-upProcess）。这个过程发生在A（现在的你）与B（未来的你）之间（如图5-1）。进步是一种转变，这种转变无法预测，混乱不清，曲曲折折，并受情绪的控制，之所以会这样，有以下几点原因：</p>
<ul>
<li>B是未知和不确定的</li>
<li>A已经不再适用了</li>
<li>B有很多种可能性</li>
<li>当我们接近它的时候，B发生了改变</li>
</ul>
<p>成为一个优秀的厨师取决于增加你创造新食物可能性的条件，比如受到一个优秀厨师的指导，去远方旅游寻找新食材，偶遇一位著名的美食评论家或是与最好的食物供应商建立良好的人际关系。但是这些东西都不会保证你能达到自己的目标。在这种情况下，成功取决于你是否成了一个不一样的自己。成为一名优秀的领导者的进步过程更像是成为一个优秀的厨师的过程，而不仅仅是照着食谱做出好吃的东西。进步过程中有一些你可能没有预想到的方式改变了你。</p>
</blockquote>
<h2 id="5-2-转变过程的可能阶段"><a href="#5-2-转变过程的可能阶段" class="headerlink" title="5.2 转变过程的可能阶段"></a>5.2 转变过程的可能阶段</h2><p>成为一名优秀领导者的进步阶段</p>
<blockquote>
<p>阶段1：发现差异</p>
</blockquote>
<p>● 发现目前的你是谁和你想要成为什么样的人之间的差异<br>● 增加采取行动的紧迫感</p>
<blockquote>
<p>阶段2：只加不减</p>
</blockquote>
<p>● 增加新的角色或行为方式（不会放弃旧的角色或行为方式）<br>● 增加外在表现力，获得一些容易得到的成果</p>
<blockquote>
<p>阶段3：混乱迷茫</p>
</blockquote>
<p>● 遭遇挫折<br>● 把时间和精力花在新旧角色转换或行为方式上，感到筋疲力尽；受到周围人对于以前的那个你的肯定，从而进步之路受到阻碍</p>
<blockquote>
<p>阶段4：重新设定前进方向</p>
</blockquote>
<p>● 挫折，带来更大的职位问题<br>● 是时候将外在表现内在化了：反思新的经历来重新检验过去的目标，从而提出新的目标</p>
<blockquote>
<p>阶段5：内在化</p>
</blockquote>
<p>● 你的新身份会使改变继续进行下去</p>
<h2 id="5-3-人的一生都在不停地改变"><a href="#5-3-人的一生都在不停地改变" class="headerlink" title="5.3 人的一生都在不停地改变"></a>5.3 人的一生都在不停地改变</h2><blockquote>
<p>事业中期转变一个最大的挑战之一是弄清楚该改变什么以及该保持什么。有时候诱惑会让一切马上改变。但是像改变工作或是事业这样重要的事情不一定会给我们带来好的结果。</p>
</blockquote>
<h1 id="六、行动起来"><a href="#六、行动起来" class="headerlink" title="六、行动起来"></a>六、行动起来</h1><blockquote>
<p>身边的每一个人都会告诉你，如果想成为一名优秀的领导者，那就需要学会自省反思，清楚地知道自己想要什么，增强自我意识。这些建议都很好，但是这只会在改变后期起到作用，而一开始你必须要先有一些新的经历，要不然你所反思的结果只会停留在过去。内在洞察力是外在表现力的反映，而并不是创造外在表现力的源泉。弄清楚你想要成为什么样的领导者并不是你成长之路上的起点，而是在改变你外在表现力的时候获得的结果。你必须把传统的“先思考后行动”的观点反过来，这样才能成功地实现转变。</p>
</blockquote>
<h2 id="过去的经历有用吗？"><a href="#过去的经历有用吗？" class="headerlink" title="过去的经历有用吗？"></a>过去的经历有用吗？</h2><blockquote>
<p>乔布斯在他著名的斯坦福大学毕业演讲中说道，他在大学时辍学去做了其他事，比如去上美术课，而这个经历对多年以后他所生产的苹果产品的外观及触感产生了很大的影响。他从来没有想过这个兴趣爱好会对后来所取得的成绩产生至关重要的作用。“向前展望时你不能把点点滴滴的经历联系在一起，只有在向后回顾时才能发现它们之间的联系。”</p>
</blockquote>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>这本书解答了好多我在改变过程中遇到的困惑，这些思想犹如灯塔，为个人转变之路指明了方向。这里列举我印象深刻的几个观点：</p>
<ul>
<li>改变思想从行动开始</li>
<li>“由外到内”转变</li>
<li>重新定义你的工作、人际关系网络、你自己</li>
<li>劝说的秘诀</li>
<li>“空出一间手术室”</li>
<li>“随机应变者”</li>
<li>“真实性”的陷阱</li>
<li>像艺术家一样偷师</li>
<li>“像水一样”</li>
<li>转变过程的阶段</li>
</ul>
<p>难得在五一假期静下心来读完了这本书，读完后收获良多，忽然想起了曾经听到过的一句话：“孤独是一个人的狂欢”，此刻我仿佛真正领悟到了这句话的真意。</p>
]]></content>
      <categories>
        <category>book</category>
      </categories>
      <tags>
        <tag>能力陷阱</tag>
      </tags>
  </entry>
  <entry>
    <title>《被讨厌的勇气》</title>
    <url>/2021/02/10/book/bei-tao-yan-de-yong-qi/</url>
    <content><![CDATA[<p><img src="/images/%E8%A2%AB%E8%AE%A8%E5%8E%8C%E7%9A%84%E5%8B%87%E6%B0%94.jpg" alt="被讨厌的勇气"></p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p><em><strong>《被讨厌的勇气》 —— “自我启发之父”阿德勒的哲学课</strong></em></p>
<blockquote>
<p>[日]案见一郎， 古贺史健<br>渠海霞 —— 译</p>
</blockquote>
<h1 id="书序"><a href="#书序" class="headerlink" title="书序"></a>书序</h1><p>小心检视，你的成功是否只是以害怕被他人讨厌而换来的。若是如此，那你的成功不幸只代表”你为他人活了一辈子” —— 陈文茜</p>
<h1 id="心里创伤并不存在"><a href="#心里创伤并不存在" class="headerlink" title="心里创伤并不存在"></a>心里创伤并不存在</h1><p>阿德勒在否定心理创伤学说的时候说了下面这段话：“任何经历本身并不是成功或者失败的原因。我们并非因为自身经历中的刺激——所谓的心理创伤——而痛苦，事实上我们会从经历中发现符合自己目的的因素。决定我们自身的不是过去的经历，而是我们自己赋予经历的意义。”</p>
<p>阿德勒说，决定我们自己的不是“经验本身”而是“赋予经验的意义”。请你注意这一点。并不是说遭遇大的灾害或者幼年受到虐待之类的事件对人格形成毫无影响。相反，影响会很大。但关键是经历本身不会决定什么。我们给过去的经历“赋予了什么样的意义”，这直接决定了我们的生活。人生不是由别人赋予的，而是由自己选择的，是自己选择自己如何生活。</p>
<h1 id="一切烦恼都来自人际关系"><a href="#一切烦恼都来自人际关系" class="headerlink" title="一切烦恼都来自人际关系"></a>一切烦恼都来自人际关系</h1><p>在人际关系中根本不可能不受伤。只要涉入人际关系就会或大或小地受伤，也会伤害别人。阿德勒曾说“要想消除烦恼，只有一个人在宇宙中生存”。但是，那种事情根本就无法做到。</p>
<h1 id="自卑感"><a href="#自卑感" class="headerlink" title="自卑感"></a>自卑感</h1><p>自卑感的问题是我如何看待这种自己以及赋予它什么样的价值。困扰我们的自卑感不是”客观性的事实”而是”主观性的解释”。也就是说，价值必须建立在社会意义之上。与他人比较、自己赋予自己的意义，带来了自卑感。</p>
<h1 id="优越性"><a href="#优越性" class="headerlink" title="优越性"></a>优越性</h1><p>人都处于追求优越性这一”希望进步的状态”之中，树立某些理想或目标并努力为之奋斗。同时，对于无法达成理想的自己就会产生一种自卑感。而越自负的人越自卑，表现得自己好像很优秀，继而沉浸在一种虚假的优越感之中。健全的自卑感不是来自与别人的比较，而是来自与”理想的自己”的比较。</p>
<h1 id="寻求他人的认可"><a href="#寻求他人的认可" class="headerlink" title="寻求他人的认可"></a>寻求他人的认可</h1><p>阿德勒心理学否定寻求他人的认可。我们并不是为了满足别人的期待而活着，他人也不是为了满足你的期待而活。如果一味寻求别人的认可、在一别人的评价，那最终就会活在别人的人生中。</p>
<h1 id="自由"><a href="#自由" class="headerlink" title="自由"></a>自由</h1><p>“自由就是被别人讨厌”。毫不在意别人的评价、不害怕被别人讨厌、不追求被他人认可，如果不付出以上这些代价，那就无法贯彻自己的生活方式，也就是不能获得自由。</p>
<h1 id="最大的不幸"><a href="#最大的不幸" class="headerlink" title="最大的不幸"></a>最大的不幸</h1><p>对人而言，最大的不幸就是不喜欢自己。幸福就是”贡献感”。人只有在能够感觉到”我对别人有用”的时候才能体会到自己的价值。但是，这种贡献也可以童工看不见的形式实现。只要有”对别人有用”的主管感觉，即”贡献感”就可以。</p>
<h1 id="甘于平凡的勇气"><a href="#甘于平凡的勇气" class="headerlink" title="甘于平凡的勇气"></a>甘于平凡的勇气</h1><p>无论是希望特别优秀还是希望特别差劲，其目的都一样——引起他人的关注、脱离”普通”的状态、成为”特别的存在”。阿德勒心理学称之为”廉价的优越性追求”。我们根本没有必要特意炫耀自己的优越杏，要有甘于平凡的勇气。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>在生活中我们经常想着要是我去做某事或我有什么样的条件我也可以取得成功，但是我们往往缺乏踏出那一步的勇气，更愿意以各种假想条件来安慰自己，活在自己想象的”可能性”之下。也许是担心梦可能会破灭，但是只有梦想破灭时我们才会有所成长吧～</p>
<p>读完这本书，对自己的心理认知又有了新的思考，其中最让我印象深刻的是阿德勒心理学否定了心理创伤。关于心理创伤，用阿德勒的观点简单理解就是我们面对眼前的困难不想做出改变，所以搬出心理创伤这个理由来逃避眼前的困难。而佛洛伊德是心理创伤理论的拥护者，他认为是由于心理创伤的存在，导致我们无法面对眼前的困难。这两种观点的本质就是目的论和原因论的区别。<br>从个人观点出发，我个人倾向于阿德勒的目的论，因为将心理创伤理解为目的论有助于我们做出积极的改变，克服困难。而如果将心理创伤理解为原因论，我们要么逃避要么原地踏步，无法积极做出改变应对困难。这种情况下，我们解决问题的方式成为了问题所在。<br>以上仅为个人的浅薄见解，因为对心理学这块没有深入的学习了解，没有太多的发言权，有时候在想心理创伤是否会导致我们身体出现应急反应，导致我们根本无法做出积极的改变，佛洛伊德的原因论也并不无道理。</p>
]]></content>
      <categories>
        <category>book</category>
      </categories>
      <tags>
        <tag>被讨厌的勇气</tag>
      </tags>
  </entry>
  <entry>
    <title>《邓小平时代》</title>
    <url>/2021/06/08/book/deng-xiao-ping-shi-dai/</url>
    <content><![CDATA[<p><em><strong>《邓小平时代》—— 这是世界上第一本全面研究和记述邓小平政治生涯的著作</strong></em><br><img src="/images/%E9%82%93%E5%B0%8F%E5%B9%B3%E6%97%B6%E4%BB%A3.png" alt="邓小平时代"></p>
<p>不知不觉中发现自己对历史的兴趣越来越浓厚，不但把《明朝那些事儿》读了第二遍，而且为了对中国历史有一个更全面的认识，去看了朋友推荐的《中国通史》这部百集纪录片，直到现在用了半年时间看完了这本《邓小平时代》。<br>唐太宗曾说过：“以铜为镜，可以正衣冠；以史为镜，可以知兴替；以人为镜，可以明得失”。在历史的长河中，可以发现人类社会在不同时期仍有许多共同点，从而窥探到我们生活的社会的一些运行规律。</p>
<p>看完这本书后很多不曾明白的事情顿时豁然开朗，而邓小平跌宕起伏的人生以及其个人品质深深的折服了我，在我迷茫不知所措的时候，又多了一盏指引的明灯。</p>
<p>本想在这里总结一下邓小平的一生以及对中国乃至世界的影响，但是发现自己知识浅薄，对于介绍邓小平的书籍及文献仅读过此书。毛主席曾说：“没有调查，没有发言权”。于是作罢，就单单写写自己在此书中的收获吧。</p>
<h1 id="不争论，先尝试，见效之后再推广"><a href="#不争论，先尝试，见效之后再推广" class="headerlink" title="不争论，先尝试，见效之后再推广"></a>不争论，先尝试，见效之后再推广</h1><p>邓小平被称为改革开放的总设计师，但是在改革开放的工作中并不是一帆风顺的，在推行改革开放主要面临的阻力来自于当时的保守派，他们担心改革开放会使资本主义复辟。在这个方面，邓小平的做法就是：“不争论，先尝试，见效之后再推广”。<br>在生活中，很多事情都可以采取这种做法，通过试验结果再做选择，实践是检验真理的唯一标准，没必要一开始大家就争得头破血流。</p>
<h1 id="向美国、日本开放"><a href="#向美国、日本开放" class="headerlink" title="向美国、日本开放"></a>向美国、日本开放</h1><p>生活在当代的我们没有经历过战争，对于战争的认识仅限于书本上的历史事件。而且仅仅是通过历史我们都难以忘却中华民族遭受侵略，对于亲身经历过战争的邓小平来说，他们感受更为强烈。但是为什么在改革开放中要积极与美国日本建交？<br>从邓小平个人的情感和经历来说，战争虽然过去了，但是伤痛依旧。但是他作为国家领导他，必须为国家和人民利益着想，当时的中国需要美国、日本先进的工业技术来促进自身的发展，在个人情感和国家利益上他选择了后者。</p>
<h1 id="废除干部领导职务终身制"><a href="#废除干部领导职务终身制" class="headerlink" title="废除干部领导职务终身制"></a>废除干部领导职务终身制</h1><p>在我国两千多年的帝王统治中，国家干部领导和职务一直都是终身制。邓小平终结了毛泽东时代的领导人终身制，建立起任期制和退休制度。而且他自己带头执行退休制度，邓小平于1989年11月底辞职（于1997年2月逝世），将权利过度到了江泽明手中。<br>退休制能保证政府权利过度的稳定，这一点，在整个中国历史上是史无前例的。</p>
<h1 id="三落三起"><a href="#三落三起" class="headerlink" title="三落三起"></a>三落三起</h1><p>在我迷茫不知所措的时候，想起邓小平三落三起的人生经历，又会重新坚定自己的信念。给我印象最深刻的是邓小平在文革期间第二次被打倒，下放到江西劳改。<br>在文革期间，不仅邓小平本人受到了批斗，他的家庭成员也受到了迫害。邓小平的弟弟邓蜀平在文革中因为绝望而自杀，邓小平长子邓朴方在文革期间从四楼摔下来导致腰部以下瘫痪。他本人先是被软禁，后又被允许在拖拉机厂劳动。<br>这段时间被邓小平视为人生最痛苦的时期，然而就是在这样的处境之下，邓小平仍没有放弃自己的信念，他写信给毛主席，表示愿意为党和人民再做一些工作。</p>
<h1 id="三副一长"><a href="#三副一长" class="headerlink" title="三副一长"></a>三副一长</h1><p>1978年12月，邓小平在中共十一届三中全会上确立领导地位，取代时任中共中央主席、国务院总理华国锋成为中国实际上的最高领导人。虽然邓小平在1978年之后成为实际的最高领导人，但是在任职期间，并没有登上国家最高领导人的职位。<br>邓小平于1977年中共十届三中全会中第三次复出政坛，任中共中央副主席、国务院副总理、中央军委副主席和解放军总参谋长等党政军职务，合称三副一长。</p>
<h1 id="百万大裁军"><a href="#百万大裁军" class="headerlink" title="百万大裁军"></a>百万大裁军</h1><p> 在1985年中—1987年底期间，在当时的中国共产党中央军事委员会主席邓小平领导下，中国人民解放军裁军一百万人。<br> 邓小平提出裁军100万，理由主要有二。第一是因为解放军机构臃肿，每个军区的领导班子有十几名二十名之多，而且结构不合理，官兵比例是 1:2.6，远远高于其他国家。<br> 当时中国军费很少，而军队人数太多，直接限制了军队武器装备的发展和战斗力的提高。裁军可以节省开支、改善装备、提高军队素质。另一个裁军的理由是基于对国际形势的判断，短期内不会发生大的战争，要腾出更多的钱来搞建设，而且“即使战争爆发，我们也要消肿”。</p>
<p> 按照中央军委的决策部署，从1985年下半年开始，按照先机关，后部队、院校和保障单位的顺序，解放军自上而下地组织实施了百万大裁军。到1987年，中国人民解放军的总员额由423.8万人减到323.5万人。之后，又作了进一步的裁减，至1990年，全军总员额减到319.9万人，共裁减员额103.9万人。                   </p>
<h1 id="邓小平南巡"><a href="#邓小平南巡" class="headerlink" title="邓小平南巡"></a>邓小平南巡</h1><p>邓小平南巡，又称九二南巡，是指1992年1月18日至2月21日期间，邓小平在中国南方的深圳、珠海、广州、上海等地所做的巡视以及讲话，重申与改革开放相关的邓小平理论，并期许广东能按其“生产力为基础的发展观”发展经济在20年内追上亚洲四小龙。<br>邓小平的九二南巡在中华人民共和国历史上具有重要地位，因六四事件而放缓甚至停滞的中国改革开放自此重新提速，而九二南巡还拯救了当时中国新兴的资本市场。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>《邓小平时代》一书是作者结合邓小平跌宕起伏的政治生涯和中国改革风云变幻的改革开放进程的全景式的描述。在读完整本书后，越发现自己的无知。<br>这里用之前看到的一段话来勉励自己。</p>
<blockquote>
<p>如果你觉得你的祖国不好，你就去建设它，如果你觉得政府不好，你就去考公务员去做官，如果你觉得人民没素质，就从你开始做一个高素质的公民，如果你觉得同胞愚昧无知，就从你开始学习并改变身边的人，而不是一昧的谩骂，抱怨，逃离。横眉冷对千夫指，俯首甘为孺子牛。<br>你所站立的地方，正是你的中国；你怎么样，中国便怎么样；你是什么，中国便是什么；你若光明，中国便不黑暗。愿中国青年都摆脱冷气，只是向上走，不必听自暴自弃者流的话。能做事的做事，能发声的发声。有一分热，发一分光，就令萤火一般，也可以在黑暗里发一点光，不必等候炬火。</p>
</blockquote>
]]></content>
      <categories>
        <category>book</category>
      </categories>
      <tags>
        <tag>邓小平时代</tag>
      </tags>
  </entry>
  <entry>
    <title>《活出生命的意义》</title>
    <url>/2021/04/11/book/huo-chu-sheng-ming-de-yi-yi/</url>
    <content><![CDATA[<p><em><strong>《活出生命的意义》（Man’s Search for Meaning）—— 借着意义的寻找，将自己超拔出来去重新爱。</strong></em><br><img src="/images/%E6%B4%BB%E5%87%BA%E7%94%9F%E5%91%BD%E7%9A%84%E6%84%8F%E4%B9%89.png" alt="活出生命的意义"></p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p><strong>《活出生命的意义》（Man’s Search for Meaning）</strong></p>
<blockquote>
<p>[美]维克多·弗兰克尔 —— 著<br>吕娜 —— 译</p>
</blockquote>
<p>著名的心里学家弗兰克尔是20世纪的一个奇迹。纳粹时期，作为犹太人，他的全家都被关进奥斯维辛集中营，他的父母、妻子、哥哥全都死于毒气室中，只有他和妹妹幸存。弗兰克尔不但超越了这炼狱半的痛苦,更将自己的经验与学术结合，开创了意义疗法，替人们找到绝处再生的意义，也留下了人性史上最富光彩的见证。</p>
<p>弗兰克尔一生对生命充满了极大的热情，67岁仍开始学习驾驶飞机，并在几个月后领到驾照。一直到80岁还登上了阿尔卑斯山。这《活出生命的意义》曾经感动千千万万的人，它被美国国会图书馆评选为具有影响力的十本著作之一。到今天，这部作品销售已达1200万册，被翻译成24种语言。他并不是当年集中营里被编号为119104的待决囚徒，而是让人的可能性得以扩大的圣者。</p>
<h1 id="原文摘录"><a href="#原文摘录" class="headerlink" title="原文摘录"></a>原文摘录</h1><p>这本书主要分为两个部分，书的第一部分是自传部分（集中营的经历），第二部分是理论部分（存在意义分析治疗），浓缩了第一部分的精华。第一部分的自传是对作者理论存在的证明，两部分共同加强了本书的可信度。</p>
<h2 id="追求意义"><a href="#追求意义" class="headerlink" title="追求意义"></a>追求意义</h2><blockquote>
<p>人类对生命意义的追求是其主要的动机，而不是什么本能驱动的”次级合理化”。这种生命意义是独特的，因为只是并且只能是由特定的某个人来完成。也只有这样，他才满足了自己追求意义的独特愿望。人，能够为了自己的理想和价值而活，甚至为此付出生命！</p>
</blockquote>
<h2 id="存在之虚无"><a href="#存在之虚无" class="headerlink" title="存在之虚无"></a>存在之虚无</h2><blockquote>
<p>人类在成为真正的人的过程中经历了双重丧失。在人类历史之初，人丧失了赖以指导其行为并因此产生安全感的某些动物本能。此外，在最近时期，人类还经历了另外一种丧失，那就是原本作为其行为根基的传统迅速的消减。丧失了告诉他必须做什么的本能，丧失了告诉他应该做什么的传统，有时甚至连自己想做什么都不知道。这样，他要么去做别人所做的事（随大流），要么座别人希望他做的事（集权主义）。<br>简单理解，人类社会发展到现在，我们不必再为食物发愁，不必再担心害怕自然界的猛兽。但是我们也因此失去某些动物性本能。<br>存在之虚无的表单主要是厌倦。现在我们能理解叔本华的话了：人注定要徘徊在焦虑和厌倦这两极之间。</p>
</blockquote>
<h2 id="生命之意义"><a href="#生命之意义" class="headerlink" title="生命之意义"></a>生命之意义</h2><blockquote>
<p>生命的意义在每个人、每一天、每一刻都是不同的，所以重要的不是是生命之意义的普遍性，而是在特定时刻每个人特殊的生命意义。这个问题就好比问一个棋手：”告诉我，大师，世界上最厉害的招法是什么？”离开特定的棋局和特定的对手，压根不存在什么最厉害的招法，甚至连较好的招法也不存在，人的存在也是这样的。你不应该追问抽象的生命意义。每个人都有自己独特的使命。这个使命是他人无法替代的，并且你的生命也不可能重来一次。</p>
</blockquote>
<h2 id="发现生命意义的三种方式"><a href="#发现生命意义的三种方式" class="headerlink" title="发现生命意义的三种方式"></a>发现生命意义的三种方式</h2><p>人们活着是为了寻找生命的意义，这也是人们一生中被赋予的最艰巨的使命。弗兰克尔发现可能找寻到生命意义的三个途径。<br>（1）第一是通过创立某项工作或从事某种事业。<br>（2）第二是经历某种事情或者面对某个人，换句话说，不仅能从工作中也能从爱中找到意义。<br>（3）第三是在忍受不可避免的苦难时采取某种态度。</p>
<h2 id="存在之本质"><a href="#存在之本质" class="headerlink" title="存在之本质"></a>存在之本质</h2><blockquote>
<p>人之所以为人，是因为他总是指向某种事物或某人（他自己以外的某人）——不论是作为有待实现的意义还是需要面对的人。人越是忘记自己——投身于某种事业或献身于所爱的人——他就越有人性，越能实现自己的价值。所谓自我实现，绝不是只某种可以实现的目标，因为人越是追求这个目标，就是越容易失去它。换句话说，自我实现是自我超越唯一的副产品。</p>
</blockquote>
<h2 id="爱之意义"><a href="#爱之意义" class="headerlink" title="爱之意义"></a>爱之意义</h2><blockquote>
<p>爱是直达另一个人内心深处的唯一途径。只有在深爱另一个人时，你才能完全了解另一个人的本质。通过爱，你才能看到所爱的人的本质特性，甚至能够看到他潜在的东西即他应当实现而尚未实现的东西是什么。只有通过爱，才能是你所爱的人实现他的全部潜能。通过使他认识到自己的所能和应为，他就会实现自己的潜能。</p>
</blockquote>
<h2 id="苦难之意义"><a href="#苦难之意义" class="headerlink" title="苦难之意义"></a>苦难之意义</h2><blockquote>
<p>我们一定不能忘记，即使在看似毫无希望的境地，即使面对无可改变的厄运，人们也能找到生命之意义。那时重要的的是，能够见证人类潜能之极限，即人能够将灾难转化为胜利，将个人的厄运转化为人类之成就。</p>
</blockquote>
<blockquote>
<p>意义疗法的要义之一：人主要关注的不是获得快乐或避免痛苦，而是看到其生命的意义。这也是<br>人们为什么甚至准备着去受苦，在这个意义上，他的痛苦有了意义。</p>
</blockquote>
<p>作者在书中讲了一个例子：一名年迈的、患有严重抑郁症的全科医生来向作者咨询，他无法接受妻子的死亡（她在两年前去世，他爱她胜过世上的一切）。面对这个问题，作者思虑过后对这位失去爱妻的医生提出这样一个问题：”医生，如果你先她而去，而你太太在你死后还活着，那会怎样啊？” “啊，”他说，”那她可就受苦了，她怎么受得了啊！”。我马上回答：”你看医生，她免除了这样的痛苦，你替代了她的痛苦——当然代价是你现在还活着，并且陷入了深深的痛苦中。”</p>
<blockquote>
<p>假如痛苦是不可避免的，那么在遭遇痛苦时，人们也有可能找到意义。在一定意义上，一旦找到了意义（比如牺牲的意义），痛苦就不再是痛苦了。</p>
</blockquote>
<blockquote>
<p>但是遭受痛苦不是寻找意义的必要方式。如果痛苦是可以避免的，那么有意义的事就是去消除痛苦的根源，不论这种原因是心理的、生理的或政治的。遭受不必要的痛苦与其说是英雄行为，不如说是自虐。</p>
</blockquote>
<h2 id="生命之短暂"><a href="#生命之短暂" class="headerlink" title="生命之短暂"></a>生命之短暂</h2><blockquote>
<p>使生命丧失意义的事情，不仅包括痛苦，还包括死亡。意义疗法因为牢记人类存在的短暂性，所以不是消极悲观的，而是积极向上的。</p>
</blockquote>
<blockquote>
<p>意义疗法因为牢记人类存在的短暂性，所以不是消极悲观的，而是积极向上的。我们形象地表达这个意思:悲观主义者好比一个恐惧而悲伤地看着墙上的挂历每天都被撕掉一张，挂历越变越薄的人;而积极地应对生活问题的人好比一个每撕掉一张就把它整整齐齐地摞在一起，还要在背面记几行日记的人。他可以自豪而快乐地回忆日记中所记下的所有充实的日子，那些他曾经有过的全部生活。即便他意识到自己老了，那又有什么关系呢?他没有必要嫉妒年轻人，更没有必要为虚度的青春懊悔。他为什么要嫉妒年轻人呢?嫉妒年轻人所拥有的可能性和潜在的远大前程吗?“不，谢谢你”，他会这么想，“我拥有的不仅仅是可能性，而是现实性，我做过了，爱过了，也勇敢地承受过痛苦。这些痛苦甚至是我最珍视的，尽管它们不会引起别人的嫉妒”</p>
</blockquote>
<h2 id="集体性神经官能症"><a href="#集体性神经官能症" class="headerlink" title="集体性神经官能症"></a>集体性神经官能症</h2><blockquote>
<p>每个时代都有它的集体神经官能症，因此每个时代都需要相应的特定心理治疗方法来进行治疗。现在的集体官能症——存在之虚无——可以被表述为私人和个人的虚无主义，虚无主义认为生命毫无意义。</p>
</blockquote>
<blockquote>
<p>首先，关于人类“无谓”——即人不过是生物、心理和社会条件的产物，或是遗传与环境相结合的产物的理论是很危险的。它使神经官能症患者更愿意相信自己不过是外部影响的工具和牺牲品，认为人类不自由的心理疗法强化了这种神经官能症的宿命论。<br>当然，人的生命是有限的，自由也是有限的。人的自由不是无条件的自由，而是针对特定条件采取某种立场的自由。</p>
</blockquote>
<blockquote>
<p>神经症（英语：neurosis、psychoneurosis或neurotic disorder），香港、澳门、新加坡、台湾译作精神官能症，在广泛的意义上可以指任何引起沮丧的精神失衡。神经症属于功能性心理障碍（functional mental disorder）的一类，病人有痛苦（distress）的感觉但不包括妄想与幻觉与幻听，其行为也不会让人在社会上难以接受。不像精神病或者人格违常，神经症并不影响或者阻碍正常的思考。在西方，“神经症”是一个在精神分析领域里常常提及的术语，而在精神医学里已经废止不再使用。 而在《中国精神疾病分类方案与诊断标准》第三版（CCMD-III）中，则把神经症定义为一种具体的精神疾病，并将其分为焦虑症、恐惧症、神经衰弱、身心症（somatoform disorder）、强迫症、其他或待分类的神经症等六个亚型。<br>见<a href="https://zh.wikipedia.org/wiki/%E7%A5%9E%E7%BB%8F%E7%97%87">维基百科</a></p>
</blockquote>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><h2 id="如何寻找生命的意义？"><a href="#如何寻找生命的意义？" class="headerlink" title="如何寻找生命的意义？"></a>如何寻找生命的意义？</h2><p>人们活着是为了寻找生命的意义，这也是人们一生中被赋予的最艰巨的使命。弗兰克尔发现可能找寻到生命意义的三个途径。第一是创造或从事某种工作。第二是经历某种事情活着面对某个人，换句话说，不仅能从工作中也能从爱中找到意义。最重要的是第三个途径：即使是处于绝境的无助受害人，面对无法改变的厄运，仍能自我超越，并且以此改变自己。他能够把个人的悲剧转化为胜利。难。即使是处于绝境之中，面对无法改变的厄运，仍能自我超越，并且以此改变自己，把个人的悲剧转化为胜利。</p>
<h2 id="关于成功"><a href="#关于成功" class="headerlink" title="关于成功"></a>关于成功</h2><p>起初作者出书的初衷是通过具体的事例向读者传递一种观点——生命在任何条件下都有意义，即便是在最恶劣的情形下。然而让作者感到惊讶和非同寻常的是，在他的众多著作当中，恰恰是真笨他打算匿名出版的书出乎意料地给他带来了极大的成功。 因此，他再三叮嘱他的学生：”不要只想着成功——你越想成功，就越容易失败。成功就像幸福一样，可遇而不可求。它是一种自然而然的产物，是一个人无意识地投身于某一伟大的事业时产生的衍生品。我希望你们一切服从良心，并用只是去实现它。总有一天你会发现，当然是相当长的时间之后——注意，我说的是很长时间之后！——正是由于这种不关注，成功将降临于你。”</p>
<p>这个思想和道家的思想很相近，道家讲顺应自然，不要过于刻意。简单理解就是要顺应事物发展的客观规律。就像田野中的果树总是在春天开花结果待到秋天成熟，当你着急想吃到果子而勤劳的给果树浇水施肥，果子是不会提前在夏天成熟，你并不能提前吃到成熟的果子。但是如果你坚持浇水施肥并加以护理，待到秋天时，我想你一定能吃到成熟的香喷喷的果子。</p>
]]></content>
      <categories>
        <category>book</category>
      </categories>
      <tags>
        <tag>活出生命的意义</tag>
      </tags>
  </entry>
  <entry>
    <title>《金字塔原理》</title>
    <url>/2022/08/20/book/jin-zi-ta-yuan-li/</url>
    <content><![CDATA[<p><img src="/images/book/%E9%87%91%E5%AD%97%E5%A1%94%E5%8E%9F%E7%90%86.jpeg" alt="金字塔原理"></p>
<blockquote>
<p>麦肯锡40年经典培训教材。思考、表达和解决问题的逻辑 —— 【美】芭芭拉·明托</p>
</blockquote>
<h1 id="写在前面的话"><a href="#写在前面的话" class="headerlink" title="写在前面的话"></a>写在前面的话</h1><p>这是一本讲“金字塔原理”的书籍，其中的思想对我们思考、表达有很深的指导意义。本书的核心思想不是很多，但由于是书籍载体的形式，而且书中存在大量案例，所以内容略显啰嗦，读起来有点乏味。如果只是想了解什么是“金字塔原理”，则阅读这本书的序言部分即可，这本书的序言对本书中的内容做了全面和高度的总结。如果你还想了解金字塔原理的一些方式方法，请继续向下阅读。</p>
<p>使用金字塔原理的最终想要达到的目的是“逻辑清晰”，或许我们没有读过这本书，但是在学习和工作中我们或多或少已经使用过一些方式方法。下面脑图是这本书的主要的目录结构：<br><img src="/2022/08/20/book/jin-zi-ta-yuan-li/%E9%87%91%E5%AD%97%E5%A1%94%E5%8E%9F%E7%90%86%E8%84%91%E5%9B%BE.png" alt="金字塔原理脑图"></p>
<blockquote>
<h1 id="序言"><a href="#序言" class="headerlink" title="序言"></a>序言</h1><p>“想清楚，说明白，知道说什么、怎么说”，是我们希望达到的境界。当我们与人沟通时，需要想清楚3件事：谁是我的听众？他们想听什么？他们想怎样听？</p>
<p>《金字塔原理》介绍了一种能清晰地展现思路的有效方法。掌握了金字塔原理，就能重点突出，逻辑清晰。不管是在政界、商界、学界，还是在企事业单位，所有高、中、基层职场人士，只要你需要思考和沟通，就会从金字塔原理受益。金字塔结构思考力是领导力的必要素质，本书是训练思考、使表达呈现逻辑性的实用宝典。</p>
<h2 id="为什么要学习金字塔原理"><a href="#为什么要学习金字塔原理" class="headerlink" title="为什么要学习金字塔原理"></a>为什么要学习金字塔原理</h2><p>我们都希望在思考、沟通交流、管理下属和解决问题时，重点突出，思路清晰，层次分明。我们评价人时，有一个标准是逻辑思维能力，而逻辑思维能力的标准又是什么？我们指导别人“要逻辑清晰、条理分明”，可怎样才能做到“逻辑清晰”？怎样才能提高思考能力，养成良好的思维习惯？</p>
<p>我们希望在表达（写作、讲话和培训）时“，能说到点子上，正面回答受众（读者、听众和学员）的问题。那么你知道如何搭建框架结构、组织语句的顺序，用最短时间讲清观点，让受众有兴趣、能理解、记得住？</p>
<p>我们还希望，组织中的全体成员能用统一的逻辑、结构和方式交流，快速产生共鸣，达成共识，那么是否有规范可寻？</p>
<p>答案就是——使用逻辑清晰的金字塔结构！</p>
<h2 id="金字塔原理的基本概念"><a href="#金字塔原理的基本概念" class="headerlink" title="金字塔原理的基本概念"></a>金字塔原理的基本概念</h2><p>● 金字塔原理是一种重点突出、逻辑清晰、层次分明、简单易懂的思考方式、沟通方式、规范动作。</p>
<p>● 金字塔原理的基本结构是：结论先行，以上统下，归类分组，逻辑递进。先重要后次要，先总结后具体，先框架后细节，先结论后原因，先结果后过程，先论点后论据。</p>
<p>● 金字塔原理训练表达者：关注、挖掘受众的意图、需求点、利益点、关注点和兴趣点，想清说什么（内容），怎么说（思路、结构），掌握沟通的标准结构、规范动作。</p>
<p>● 金字塔能够达到的沟通效果：观点鲜明、重点突出、思路清晰、层次分明、简单易懂，让受众有兴趣，能理解，记得住。</p>
<p>● 搭建金字塔结构的具体做法是：自上而下表达，自下而上思考，纵向总结概括，横向归类分组，序言讲故事，标题提炼思想精华。</p>
<h2 id="金字塔原理能够帮助你解决哪些问题"><a href="#金字塔原理能够帮助你解决哪些问题" class="headerlink" title="金字塔原理能够帮助你解决哪些问题"></a>金字塔原理能够帮助你解决哪些问题</h2><p>学习金字塔原理课程，会使用金字塔结构思考、表达、管理下属和解决问题，提高逻辑性、条理性，准确高效阐述思想。掌握规范动作，组织中所有人用相同思路和表达方式交流，沟通效果好、效率高。</p>
<p>● 思考：学会用右脑、左脑全脑思维，提高结构化思维能力，思考全、准、快。</p>
<p>● 书面表达、公文写作：会挖掘读者的关注点、兴趣点、需求点、利益点，能使用金字塔的4个原则，搭建逻辑清晰的常用公文框架结构（通知、请示、工作计划、工作总结、会议纪要、报道），掌握写序言的四要素、归类分组的MECE原则，能够重点突出、逻辑清晰、简明扼要，让人看得懂、愿意看、记得住。快速写文章，缩短写作时间，减少修改次数。</p>
<p>● 口头表达：说话、演讲、讲课，能够使用金字塔的基本原则，回答听众最常有的4类疑问：“是什么？为什么？如何做？好不好？”表达时重点突出、条理清晰，让人愿意听、听得懂、记得住，成为思路清晰、言简意赅的人。</p>
<p>● 管理下属：能够运用金字塔原理，考虑全面、周到、严谨，分配任务、设计流程不重叠无遗漏。</p>
<p>● 培训师开发课程和讲课：会使用金字塔搭建框架结构、组织素材、重点突出、逻辑清晰、通俗易懂。</p>
</blockquote>
<center><h1>第1篇：表达的逻辑</h1></center>

<h1 id="一、为什么要用金字塔结构"><a href="#一、为什么要用金字塔结构" class="headerlink" title="一、为什么要用金字塔结构"></a>一、为什么要用金字塔结构</h1><p>当我们试图通过文章、演讲或培训向受众传达我们对问题的观点时，那么他将面临一项复杂的任务。因为即使你的文章篇幅很短，比如只有两页纸，文章也会包括大约100个句子，读者必须阅读理解每一句话，并且寻找每一句话之间的联系，前前后后反复思考。如果你的文章结构呈金字塔形，文章的思路自顶部逐渐向下展开则会比较易读。这一现象体现了人类思维的基本规律：</p>
<blockquote>
<ul>
<li>大脑自动将信息归纳到金字塔结构的各组中，以便于理解和记忆</li>
<li>预先归纳到金字塔结构中的沟通内容，都更容易被人理解和记忆</li>
<li>你应有意识的将沟通内容组织成金字塔结构，包括口头表达和书面表达</li>
</ul>
</blockquote>
<h2 id="1-1-如何将思想组织成金字塔"><a href="#1-1-如何将思想组织成金字塔" class="headerlink" title="1.1 如何将思想组织成金字塔"></a>1.1 如何将思想组织成金字塔</h2><h3 id="奇妙的数字“7”"><a href="#奇妙的数字“7”" class="headerlink" title="奇妙的数字“7”"></a>奇妙的数字“7”</h3><p>论文《奇妙的数字7±2》提出大脑的短期记忆无法一次容纳7个以上的记忆项目。有的人可能一次能记住9个项目，有的人则只能记住5个。大脑比较容易记住的是3个项目，当然最容易记住的是一个项目。当大脑发现需要处理的记忆项目超过4个或5个时，就会开始将其归类到不同的逻辑范畴中，以便于记忆。</p>
<h3 id="搭建金字塔结构的两个步骤"><a href="#搭建金字塔结构的两个步骤" class="headerlink" title="搭建金字塔结构的两个步骤"></a>搭建金字塔结构的两个步骤</h3><ul>
<li>归类分组： 根据逻辑将思想或概念分组</li>
<li>抽象概括： 找出分组后的逻辑关系，提高一个抽象层次</li>
</ul>
<h2 id="1-2-自上而下表达，结论先行"><a href="#1-2-自上而下表达，结论先行" class="headerlink" title="1.2 自上而下表达，结论先行"></a>1.2 自上而下表达，结论先行</h2><blockquote>
<p>研究发现，最有效的表达方式是：先提出总的概念，再列出具体项目，即要自上而下的表达思想。</p>
</blockquote>
<h3 id="非结构化表达存在的问题？"><a href="#非结构化表达存在的问题？" class="headerlink" title="非结构化表达存在的问题？"></a>非结构化表达存在的问题？</h3><ul>
<li>受众需要逐句理解你要表达的思想，并自动从中寻找共同点，造成理解困难</li>
<li>由于用户无法提前知道你的核心思想，可能会造成错误推论，造成误解</li>
</ul>
<blockquote>
<p>读者在接受信息时，总是在寻找一种能够将所摄入信息联系起来的结构。为保证读者找到你希望的结构，你必须提前把这种结构告诉他。</p>
</blockquote>
<h2 id="1-3-自下而上思考，总结概括"><a href="#1-3-自下而上思考，总结概括" class="headerlink" title="1.3 自下而上思考，总结概括"></a>1.3 自下而上思考，总结概括</h2><p>将信息进行归类分组、抽象概括，并以自上而下的方式表达出来，那么结构如下图所示，中间每一个深色方框代表你想表达的一个思想。<br><img src="/2022/08/20/book/jin-zi-ta-yuan-li/%E9%87%91%E5%AD%97%E5%A1%94%E7%BB%93%E6%9E%84.png" alt="金字塔结构"></p>
<center>文章中的思想应组成单一思想统领下的金字塔结构</center>
从上图中可以看出，我们是自上而下的表达的，但是仔细想一想，我们在写作时的实际思考过程中会发现，在总结主要思想时使用的是自下而上的方式。
在金字塔结构的最底层，对每一个单一思想进行分组然后分析逻辑关系进行抽象概括，形成高一层的单一思想。

<h3 id="金字塔中的思想3中相互关联的方式"><a href="#金字塔中的思想3中相互关联的方式" class="headerlink" title="金字塔中的思想3中相互关联的方式"></a>金字塔中的思想3中相互关联的方式</h3><p>金字塔中的思想以3种方式项目关联————向上、向下、横向。位于一组思想的上一个层次的思想是对这一组思想的概括，这一组思想是对其上一层次思想的解释和支持。</p>
<p>文章中的思想必须符合以下规则：</p>
<ul>
<li>纵向： 文章用任一层次上的思想必须是其下一层次思想的概括</li>
<li>横向： 每组中的思想必须属于同一逻辑范畴</li>
<li>横向： 每组中的思想必须按照逻辑顺序组织</li>
</ul>
<h1 id="二、金字塔内部的结构"><a href="#二、金字塔内部的结构" class="headerlink" title="二、金字塔内部的结构"></a>二、金字塔内部的结构</h1><p>如果在写作之前你已经完全清楚了你想表达的思想，你可以很容易的将要表达的思想组成规范的金字塔结构。但是很多时候，我们刚开始写作时，可能对自己想要表达的思想还只有模糊的想法，甚至感觉无从下笔。<br>我们是无法做到一下子就将思想组成金字塔，因此我们先必须梳理你想要表达的思想。</p>
<blockquote>
<h3 id="金字塔中的字结构"><a href="#金字塔中的字结构" class="headerlink" title="金字塔中的字结构"></a>金字塔中的字结构</h3><p>金字塔中的字结构能够加快你梳理思想的过程：</p>
<ul>
<li>主题与子主题之间的纵向关系</li>
<li>各子主题之间的横向关系</li>
<li>序言的叙述方式</li>
</ul>
</blockquote>
<h2 id="2-1-纵向关系"><a href="#2-1-纵向关系" class="headerlink" title="2.1 纵向关系"></a>2.1 纵向关系</h2><p>文章中的大主题下的思想都同时与文章中的其它思想发生成纵向或横向的联系。纵向关系能够很好的吸引读者注意力，通过纵向关系可以引导一种疑问&#x2F;回答式的对话，从而使读者带着极大的兴趣了解你的思路进展。<br><img src="/2022/08/20/book/jin-zi-ta-yuan-li/%E7%BA%B5%E5%90%91%E5%85%B3%E7%B3%BB%E6%A1%88%E4%BE%8B.png" alt="金字塔纵向关系案例"></p>
<center>纵向关系案例————具有疑问/回答式对话结构</center>
金字塔结构巨大的价值在于迫使你在理清思路时，从视觉上使用纵向的疑问/回答式对话关系清晰化。每一个表述都应当引起读者的疑问，而你也必须在这一表述下的横向结构层次上逐个回答读者的疑问。

<h2 id="2-2-横向关系"><a href="#2-2-横向关系" class="headerlink" title="2.2 横向关系"></a>2.2 横向关系</h2><p>在考虑下一结构层次如何表述时，必须保证你的表述能够回答在其上一层次上的表述引起的疑问，同时保证表述必须符合逻辑。所以表述必须具有明确的归纳或演绎关系。</p>
<ul>
<li>演绎关系： 演绎性思想组合是由几个承前启后的论述组成的。第一个思想是对当今世界上某种现象的表述；第二个思想是对该句子的主语或谓语所做的表述；第三个思想则说明了以上两种表述同时在世界存在时所具有的隐含意义。演绎关系案例：<ul>
<li>所有的人都会死。</li>
<li>苏格拉底是一个人。</li>
<li>因此苏格拉底会死。</li>
</ul>
</li>
<li>归纳关系：归纳性思想组合中的思想互相关联，你可以用同一个名次表示组中所有思想，如支持的原因、返回的原因、步骤、问题，等等。归纳关系案例：<ul>
<li>法国坦克已抵达波兰边境</li>
<li>德国坦克已抵达波兰边境</li>
<li>俄国坦克已抵达波兰边境</li>
</ul>
</li>
</ul>
<p>提高一个抽象层次，根据以上案例的共同点，可以得出一个推论：“波兰将受到坦克入侵”或类似的思想。</p>
<h1 id="三、如何构建金字塔"><a href="#三、如何构建金字塔" class="headerlink" title="三、如何构建金字塔"></a>三、如何构建金字塔</h1><p>可以通过自上而下或自下而上地构建文章的金字塔结构，自上而下的方法通常比自下而上的方法更容易。</p>
<h2 id="3-1-自上而下法"><a href="#3-1-自上而下法" class="headerlink" title="3.1 自上而下法"></a>3.1 自上而下法</h2><h3 id="自上而下法构建金字塔的步骤："><a href="#自上而下法构建金字塔的步骤：" class="headerlink" title="自上而下法构建金字塔的步骤："></a>自上而下法构建金字塔的步骤：</h3><ul>
<li>提出主题思想</li>
<li>设想受众的主要疑问</li>
<li>写序言：背景-冲突——疑问-回答。</li>
<li>与受众进行疑问&#x2F;回答式对话</li>
<li>对受众的新疑问，重复进行疑问&#x2F;回答式对话。</li>
</ul>
<h2 id="3-2-自下而上法"><a href="#3-2-自下而上法" class="headerlink" title="3.2 自下而上法"></a>3.2 自下而上法</h2><h3 id="自下而上思考："><a href="#自下而上思考：" class="headerlink" title="自下而上思考："></a>自下而上思考：</h3><ul>
<li>列出你想表达的所有思想要点。</li>
<li>找出各要点之间的逻辑关系。</li>
<li>得出结论。</li>
</ul>
<h2 id="3-3-初学者注意事项"><a href="#3-3-初学者注意事项" class="headerlink" title="3.3 初学者注意事项"></a>3.3 初学者注意事项</h2><ul>
<li>一定先搭结构，先尝试自上而下法</li>
<li>序言先写背景，将背景作为序言的起点</li>
<li>先多花时间思考序言，不要省略</li>
<li>将历史背景放在序言中</li>
<li>序言仅设计读者不会对其真实性提出质疑的内容</li>
<li>在关键句层次上，更宜选择规划推理法而非演绎推理法（归纳法更容易被人理解）</li>
</ul>
<h1 id="四、序言的具体写法"><a href="#四、序言的具体写法" class="headerlink" title="四、序言的具体写法"></a>四、序言的具体写法</h1><p>文章的序言（前言、引言、导言）概述读者已知的信息，并将这些信息与文章将要回答的疑问建立联系，然后作者就可以将全部精力放在解答疑问上。文章的序言必须用讲故事的结构，先介绍背景，再说明冲突，由此引发读者的疑问，然后针对该“疑问”给出“答案”。</p>
<blockquote>
<p>序言要用讲故事的形式，是为了让读者抛开复杂的思想，专注于你的话题。激发读者兴趣，吸引注意力：新奇、悬念、与读者本人相关。</p>
</blockquote>
<h2 id="4-1-常见的4种疑问形式"><a href="#4-1-常见的4种疑问形式" class="headerlink" title="4.1 常见的4种疑问形式"></a>4.1 常见的4种疑问形式</h2><table>
<thead>
<tr>
<th>背景（关于文章主题的公认事实）</th>
<th>冲突（推动情节发展并引发读者提出疑问的因素）</th>
<th>读者的疑问</th>
</tr>
</thead>
<tbody><tr>
<td>需要完成某项任务</td>
<td>发生了妨碍完成该任务的事情</td>
<td>我们应该怎么做？</td>
</tr>
<tr>
<td>存在某个问题</td>
<td>知道解决问题的方案</td>
<td>如何实施解决方案？</td>
</tr>
<tr>
<td>存在某个问题</td>
<td>有人提出了一个解决方案</td>
<td>改方案是否正确？</td>
</tr>
<tr>
<td>采取了某项行动</td>
<td>行动未达到预期效果</td>
<td>为什么没有达到预期效果？</td>
</tr>
</tbody></table>
<h2 id="4-2-常见序言结构顺序"><a href="#4-2-常见序言结构顺序" class="headerlink" title="4.2 常见序言结构顺序"></a>4.2 常见序言结构顺序</h2><p>序言必须采用“背景-冲突-疑问-解决方案”的结构，但是各部分的额顺序可以有所变化。</p>
<ul>
<li>标准式：背景——冲突——答案</li>
<li>开门见山式： 答案——背景——冲突</li>
<li>突出忧虑式：冲突——背景——答案</li>
<li>突出信心式：疑问——背景——冲突——答案</li>
</ul>
<h2 id="4-3-关键句要点"><a href="#4-3-关键句要点" class="headerlink" title="4.3 关键句要点"></a>4.3 关键句要点</h2><p>关键句要点（或称要点、核心观点、一级结论、一级论点、重要结论），不仅要会发由文章主题引起的受众的疑问，还要呈现文章的框架结构。<br>列出关键句要点可以让读者在开始阅读的最初30秒就能了解你的全部思路。</p>
<h2 id="4-4-序言的常见模式"><a href="#4-4-序言的常见模式" class="headerlink" title="4.4 序言的常见模式"></a>4.4 序言的常见模式</h2><ul>
<li>发出指示式</li>
<li>请求支持式</li>
<li>解释做法式</li>
<li>比较选择式</li>
</ul>
<h2 id="4-5-序言4要素SCQA"><a href="#4-5-序言4要素SCQA" class="headerlink" title="4.5 序言4要素SCQA"></a>4.5 序言4要素SCQA</h2><ul>
<li>介绍背景（S，Situation）</li>
<li>指出冲突（C，Complication）</li>
<li>引发疑问（Q， Question）</li>
<li>给出答案（A，Answer）</li>
</ul>
<h1 id="五、演绎推理与归纳推理"><a href="#五、演绎推理与归纳推理" class="headerlink" title="五、演绎推理与归纳推理"></a>五、演绎推理与归纳推理</h1><h2 id="5-1-演绎推理的3个步骤"><a href="#5-1-演绎推理的3个步骤" class="headerlink" title="5.1 演绎推理的3个步骤"></a>5.1 演绎推理的3个步骤</h2><ul>
<li>出现的问题或存在现象</li>
<li>产生问题的根源、原因</li>
<li>解决问题的方案</li>
</ul>
<blockquote>
<p>演绎推理如果非常简单直接，则用演绎推理。金字塔结构的关键句层次尽量用归纳法组织，将演绎推理放在金字塔结构中较低的层次上，减少推理过程中插入其它干扰信息。<br>某个段落中使用演绎法式合适的，读者也很容易理解。但是在较高的层次上，归纳法总是比演绎法更容易理解。</p>
</blockquote>
<h2 id="5-2-归纳推理的2个步骤"><a href="#5-2-归纳推理的2个步骤" class="headerlink" title="5.2 归纳推理的2个步骤"></a>5.2 归纳推理的2个步骤</h2><ul>
<li>正确定义该组思想，找到一个能够表示该组所有思想共同点的名词。</li>
<li>比别并剔除该组思想中与其它思想不相称的思想。</li>
</ul>
<h2 id="5-3-演绎推理与归纳推理的区别："><a href="#5-3-演绎推理与归纳推理的区别：" class="headerlink" title="5.3 演绎推理与归纳推理的区别："></a>5.3 演绎推理与归纳推理的区别：</h2><ul>
<li>演绎推理：第二点是对第一点主语或谓语的论述。</li>
<li>归纳推理： 同组中的思想具有类似的主语或谓语。</li>
</ul>
<center><h1>第2篇：思考的逻辑</h1></center>

<h1 id="六、应用逻辑顺序"><a href="#六、应用逻辑顺序" class="headerlink" title="六、应用逻辑顺序"></a>六、应用逻辑顺序</h1><p>在归纳性的思想中，我们必须掌握选择逻辑的顺序。</p>
<h2 id="6-1-三种逻辑顺序"><a href="#6-1-三种逻辑顺序" class="headerlink" title="6.1 三种逻辑顺序"></a>6.1 三种逻辑顺序</h2><ul>
<li>时间顺序：按照采取行动的顺序（第一步、第二步、第三步）依次表述达到某一结果必须采取的行动。</li>
<li>结构顺序：使用示意图、地图、图画或照片想象某事物时的顺序，如组织结构图、关键成功要素示意图等。</li>
<li>重要性顺序：明确指明每组的思想具有共同特性，确保将所有具有该特性的思想列入该组。在每组中，根据各个问题所具有特性的强弱、主次顺序进行排序。</li>
</ul>
<h2 id="6-2-MECE原则"><a href="#6-2-MECE原则" class="headerlink" title="6.2 MECE原则"></a>6.2 MECE原则</h2><p>分组的MECE原则保证划分后的各部分符合以下要求：</p>
<ul>
<li>各部分之间相互独立（mutually exclusive），相互排斥，没有重叠。</li>
<li>所有部分完全穷尽（collectively exhaustive），没有遗漏。</li>
</ul>
<h1 id="七、概括各组思想"><a href="#七、概括各组思想" class="headerlink" title="七、概括各组思想"></a>七、概括各组思想</h1><p>金字塔原理的规则：位于金字塔结构每一个层次上的思想，都必须是对下面一个层次思想的提炼、概括，</p>
<h2 id="7-1-概括各组思想的方法"><a href="#7-1-概括各组思想的方法" class="headerlink" title="7.1 概括各组思想的方法"></a>7.1 概括各组思想的方法</h2><ul>
<li>总结句避免使用“缺乏思想”的句子</li>
<li>总结句要说明行动产生的结果&#x2F;目标</li>
<li>总结句要使用明确的词汇&#x2F;语句</li>
<li>区分行动步骤的层次</li>
<li>直接概括行动的结果</li>
<li>找出各结论之间的共性</li>
<li>找出结构上的共性</li>
<li>寻找更密切的关系</li>
<li>完成提炼总结概括的完成思考过程</li>
</ul>
<center><h1>第3篇：解决问题的逻辑</h1></center>

<h1 id="八、界定问题"><a href="#八、界定问题" class="headerlink" title="八、界定问题"></a>八、界定问题</h1><h2 id="8-1-界定问题的框架"><a href="#8-1-界定问题的框架" class="headerlink" title="8.1 界定问题的框架"></a>8.1 界定问题的框架</h2><p>问题是指你已有的（现状）与你想要的（目标）之间存在的差距，这种差距是自某一背景下一系列特定条件下产生的。了解问题的发展历史对我们分析差距非常重要。</p>
<ul>
<li>展开说明框架中的各要素</li>
<li>把“界定的问题”写成序言</li>
</ul>
<p>界定问题的框架是解决问题的第一步，也是建立金字塔结构、交流解决方案的第一步。</p>
<h2 id="8-2-展开问题的各要素"><a href="#8-2-展开问题的各要素" class="headerlink" title="8.2 展开问题的各要素"></a>8.2 展开问题的各要素</h2><p>界定问题的4个要素：</p>
<ul>
<li>切入点&#x2F;序幕（Starting Point&#x2F;Opening Sene）</li>
<li>困扰&#x2F;困惑（Disturbing Event）</li>
<li>现状，非期望结果（R1， Undesired Result）</li>
<li>目标，期望结果（R2， Desired Result）</li>
</ul>
<h1 id="九、结构化分析问题"><a href="#九、结构化分析问题" class="headerlink" title="九、结构化分析问题"></a>九、结构化分析问题</h1><p>分析问题的标准流程是：</p>
<blockquote>
<p>收集信息 ——&gt; 描述发现 ——&gt; 得出结论 ——&gt; 提出方案</p>
</blockquote>
<p>从信息资料入手，获取完成数据，设计诊断框架进行分析。</p>
<h2 id="9-1-设计诊断框架"><a href="#9-1-设计诊断框架" class="headerlink" title="9.1 设计诊断框架"></a>9.1 设计诊断框架</h2><p>使用诊断框架可以揭示分析应该关注的要素或领域，帮助我们快速界定问题。</p>
<h2 id="9-2-结构化分析的3种方法"><a href="#9-2-结构化分析的3种方法" class="headerlink" title="9.2 结构化分析的3种方法"></a>9.2 结构化分析的3种方法</h2><ul>
<li>呈现有形的结构</li>
<li>寻找因果关系</li>
<li>归类分组</li>
</ul>
<h2 id="9-3-建立逻辑树"><a href="#9-3-建立逻辑树" class="headerlink" title="9.3 建立逻辑树"></a>9.3 建立逻辑树</h2><p> 逻辑树的作用：</p>
<ul>
<li>寻找解决方案：从逻辑上找出解决问题的方案。</li>
<li>寻找各组的思想缺陷：找出各个组的观点的缺陷。</li>
</ul>
<center><h1>第4篇：演示的逻辑</h1></center>

<h1 id="十、在书面上呈现金字塔"><a href="#十、在书面上呈现金字塔" class="headerlink" title="十、在书面上呈现金字塔"></a>十、在书面上呈现金字塔</h1><p>理想的文章，应该让读者在30秒内理解作者的整体思维架构，包括序言、中心思想和关键句要点。</p>
<h2 id="10-1-突出显示文章的框架结构"><a href="#10-1-突出显示文章的框架结构" class="headerlink" title="10.1 突出显示文章的框架结构"></a>10.1 突出显示文章的框架结构</h2><p>长篇文章在页面上呈现金字塔层级的常见方法：</p>
<ul>
<li>多级标题法</li>
<li>下划线法</li>
<li>数字标号法</li>
<li>行首缩进法</li>
<li>项目符号法</li>
</ul>
<p>无论采用哪种格式，目的都是便于读者理解文章的主要观点，以及所有各种类型的支持性观点。</p>
<h3 id="10-1-1-使用标题注意点"><a href="#10-1-1-使用标题注意点" class="headerlink" title="10.1.1 使用标题注意点"></a>10.1.1 使用标题注意点</h3><ul>
<li>每一层级的标题不可能只有一个</li>
<li>相同的思想应使用相同的句型</li>
<li>标题用词应提炼思想的精髓（标题的作用是提示，而不是统领下文）</li>
<li>标题与正文应分开考虑（标题更多是为眼球而写，而不是为头脑而写）</li>
<li>每组标题应提前集中介绍（在大标题下应有一段话，集中介绍标题的主要内容）</li>
<li>不要滥用标题</li>
</ul>
<h2 id="10-2-上下文之间要有过渡"><a href="#10-2-上下文之间要有过渡" class="headerlink" title="10.2 上下文之间要有过渡"></a>10.2 上下文之间要有过渡</h2><p>在每一章或节的开始，可以采用讲故事或承上启下的方法做铺垫。常用过渡方式：</p>
<ul>
<li>讲故事</li>
<li>承上启下</li>
<li>总结各部分内容</li>
<li>得出完整结论说明下一步行动</li>
</ul>
<h1 id="十一、在PPT演示文稿中呈现金字塔"><a href="#十一、在PPT演示文稿中呈现金字塔" class="headerlink" title="十一、在PPT演示文稿中呈现金字塔"></a>十一、在PPT演示文稿中呈现金字塔</h1><p>设计PPT演示文稿必须了解和掌握的基本规则：</p>
<ul>
<li>文字幻灯片应只包含最重要的、经过适当分组和总结的思想，叙述时应尽量简洁；</li>
<li>演示文稿应图文并茂，使用各种图表相配合；</li>
<li>演示文稿应呈现经过深思熟虑后的额故事梗概和剧本</li>
</ul>
<p>演示文稿包括两类幻灯片——文字和图表，理想的比例是图表占90%，文字占10%，其各自的作用：</p>
<ul>
<li>文字幻灯片：<ul>
<li>说明演示文稿的框架结构</li>
<li>强调重要的思想、观点、结论、论点、建议或要采取的措施等</li>
</ul>
</li>
<li>图表幻灯片： 阐明文字难以说清楚的数据、关系</li>
</ul>
<h2 id="11-1-设计文字PPT幻灯片"><a href="#11-1-设计文字PPT幻灯片" class="headerlink" title="11.1 设计文字PPT幻灯片"></a>11.1 设计文字PPT幻灯片</h2><h3 id="清楚你要说的内容"><a href="#清楚你要说的内容" class="headerlink" title="清楚你要说的内容"></a>清楚你要说的内容</h3><p>举例说明实际演讲稿和文字幻灯片的差别，“实际讲稿如下：</p>
<blockquote>
<h4 id="现状"><a href="#现状" class="headerlink" title="现状"></a>现状</h4><p>杰克逊食品公司的未交订货的数量一直非常高。在PMG业务领域，不能完全按订单供货，将不可避免地导致市场份额下降。</p>
<ul>
<li>生产问题是造成目前状况的原因之一。</li>
<li>供应链流程不连贯和管理不善，使生产问题更加复杂。</li>
<li>供应链和生产流程缺乏紧密配合，难以解决未交订货问题，也不能集中保证重点客户和重点产品。</li>
</ul>
</blockquote>
<p>文字幻灯片如下：</p>
<blockquote>
<h4 id="现状-1"><a href="#现状-1" class="headerlink" title="现状"></a>现状</h4><p>尚未交付的订货相当多</p>
<ul>
<li>生产存在问题</li>
<li>供应链流程不合理</li>
<li>生产&#x2F;供应链缺乏配合</li>
</ul>
</blockquote>
<h3 id="清楚你要演示的内容"><a href="#清楚你要演示的内容" class="headerlink" title="清楚你要演示的内容"></a>清楚你要演示的内容</h3><ul>
<li>每次只演示和说明一个论点</li>
<li>论点应使用完成的陈述句，而不是标题性语言</li>
<li>文字尽量简短</li>
<li>使用简单的词汇和数字</li>
<li>字号应足够大</li>
<li>注意幻灯片的趣味性</li>
<li>用逐级展开呈现，提高趣味性</li>
</ul>
<h2 id="11-2-设计图表PPT幻灯片"><a href="#11-2-设计图表PPT幻灯片" class="headerlink" title="11.2 设计图表PPT幻灯片"></a>11.2 设计图表PPT幻灯片</h2><p>图表幻灯片采用视觉关系可以用来向观众介绍大量的数据和单凭文字无法传达的复杂关系。图表幻灯片传递的信息应该尽量简单易懂，因为观众没有太多时间和机会仔细研究各部分的含义。制作图表幻灯片的诀窍是：确定你想用图表回答的问题，把答案作为图表的标题，然后选择最适合的图表样式。</p>
<blockquote>
<p>演示是参与者给予演讲者的一种恩惠——《新演讲术》</p>
</blockquote>
<h1 id="十二、在字里行间呈现金字塔"><a href="#十二、在字里行间呈现金字塔" class="headerlink" title="十二、在字里行间呈现金字塔"></a>十二、在字里行间呈现金字塔</h1><p>做到条理清晰需要经过两个步骤：首先决定要说明的思想或要证明的论点，然后用文字表现。如何在文字中使用金字塔结构呢？</p>
<ul>
<li>画脑图（在大脑中画图像）</li>
<li>把图像复制成文字</li>
</ul>
<center><h1>总结</h1></center>
本书核心内容在前4章，主要是解答了两个问题：为什么要使用金字塔原理？以及如何构建金字塔？

<h3 id="1-为什么要使用金字塔原理？"><a href="#1-为什么要使用金字塔原理？" class="headerlink" title="1. 为什么要使用金字塔原理？"></a>1. 为什么要使用金字塔原理？</h3><p>因为人的大脑短时间只能记住7±2个项目，大脑比较容易记住3个项目。所以我们应该将内容分组归类、抽象概括、总结归纳，构建成金字塔结构，让受众更容易理解和记住我们想要表达的内容。</p>
<h3 id="2-什么是金字塔原理？"><a href="#2-什么是金字塔原理？" class="headerlink" title="2. 什么是金字塔原理？"></a>2. 什么是金字塔原理？</h3><ul>
<li><strong>自上而下表达，结论先行</strong><br>先提出总的概念，再列出具体项目，即要自上而下的表达思想</li>
<li><strong>自下而上思考，总结概括</strong><br>如果不能提前构思好金字塔的上层结构，可以先从金字塔结构的最底层，对每一个单一思想进行分组然后分析逻辑关系进行抽象概括，形成高一层的单一思想。</li>
</ul>
<p>此外在金字塔的上层结构中更适合使用归纳推理，在金字塔底层能更适合使用演绎推理。</p>
<h3 id="3-使用金字塔原理能够达到的沟通效果？"><a href="#3-使用金字塔原理能够达到的沟通效果？" class="headerlink" title="3. 使用金字塔原理能够达到的沟通效果？"></a>3. 使用金字塔原理能够达到的沟通效果？</h3><p>观点鲜明、重点突出、思路清晰、层次分明、简单易懂，让受众有兴趣，能理解，记得住。</p>
<h3 id="4-SCQA原则"><a href="#4-SCQA原则" class="headerlink" title="4. SCQA原则"></a>4. SCQA原则</h3><p>文章的序言必须用讲故事的结构，先介绍背景，再说明冲突，由此引发读者的疑问，然后针对该“疑问”给出“答案”。<br>序言要用讲故事的形式，是为了让读者抛开复杂的思想，专注于你的话题。激发读者兴趣，吸引注意力：新奇、悬念、与读者本人相关。<br>SCQA的内容如下：</p>
<ul>
<li>介绍背景（S，Situation）</li>
<li>指出冲突（C，Complication）</li>
<li>引发疑问（Q， Question）</li>
<li>给出答案（A，Answer）</li>
</ul>
<h3 id="5-MECE原则"><a href="#5-MECE原则" class="headerlink" title="5. MECE原则"></a>5. MECE原则</h3><p>分组的MECE原则保证划分后的各部分符合以下要求：</p>
<ul>
<li>各部分之间相互独立（mutually exclusive），相互排斥，没有重叠。</li>
<li>所有部分完全穷尽（collectively exhaustive），没有遗漏。</li>
</ul>
]]></content>
      <categories>
        <category>book</category>
      </categories>
      <tags>
        <tag>金字塔原理</tag>
      </tags>
  </entry>
  <entry>
    <title>使用策略模式重构系统导入导出</title>
    <url>/2019/03/31/design-pattern/shi-yong-ce-lue-mo-shi-chong-gou-xi-tong-dao-ru-dao-chu/</url>
    <content><![CDATA[<p>​     合理的使用设计模式能提高代码的可维护性，但是往往一开始设计开发的时候没有考虑到业务的扩展性，在后期业务扩展的时候，需要在原有代码逻辑上增加新功能，这对开发人员来说无疑是非常痛苦的。刚好接到了在新的业务系统增加导入导出功能开发任务，在了解到系统原有导入导出复杂的逻辑后，决定利用策略模式来重构这一功能，降低开发的复杂度。</p>
<h1 id="系统原有导入导出"><a href="#系统原有导入导出" class="headerlink" title="系统原有导入导出"></a>系统原有导入导出</h1><p>​       系统原有使用异步导入导出方式，导入导出任务提交后，先将任务放到任务队列中去，使用一个线程不断从任务队列中获取待执行的任务交由任务线程池去执行。</p>
<blockquote>
<p>精简后的部分代码如下：</p>
</blockquote>
<p><strong>FileTaskExecutor.java</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 任务分发器线程内部类</span>
<span class="token keyword">class</span> <span class="token class-name">Boss</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token class-name">FileTask</span> task <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
			<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
				task <span class="token operator">=</span> taskQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 导入导出任务封装为Worker交由线程池执行</span>
				executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Get next file task failed,cause by:&#123;&#125;"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 任务执行器线程内部类</span>
<span class="token keyword">class</span> <span class="token class-name">Worker</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">private</span> <span class="token class-name">FileTask</span> task<span class="token punctuation">;</span>
	<span class="token keyword">public</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token class-name">FileTask</span> task<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>task <span class="token operator">=</span> task<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
    
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token class-name">FileType</span> fileType <span class="token operator">=</span> <span class="token class-name">FileUtil</span><span class="token punctuation">.</span><span class="token function">getFileType</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">FileHandler</span> fileHandler <span class="token operator">=</span> <span class="token class-name">FileHandlerFactory</span><span class="token punctuation">.</span><span class="token function">getFileHandler</span><span class="token punctuation">(</span>fileType<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">switch</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">case</span> <span class="token class-name">Import</span><span class="token operator">:</span>
                <span class="token comment">// 处理导入</span>
				<span class="token function">handleImport</span><span class="token punctuation">(</span>fileType<span class="token punctuation">,</span> task<span class="token punctuation">,</span> fileHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">commitFileTask</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token class-name">TaskResult<span class="token punctuation">.</span>Success</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token class-name">Export</span><span class="token operator">:</span>
                <span class="token comment">// 处理导出</span>
				<span class="token function">handleExport</span><span class="token punctuation">(</span>fileType<span class="token punctuation">,</span> task<span class="token punctuation">,</span> fileHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">commitFileTask</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token class-name">TaskResult<span class="token punctuation">.</span>Success</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// TODO 异常情况下文件任务状态处理</span>
			<span class="token function">commitFileTask</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token class-name">TaskResult<span class="token punctuation">.</span>Failed</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Execute file task failed,cause by:&#123;&#125;"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="导入关键步骤"><a href="#导入关键步骤" class="headerlink" title="导入关键步骤"></a>导入关键步骤</h3><p>根据导入的逻辑，导入主要包括以下几个步骤：</p>
<ul>
<li>1、读取导入文件，获取文件行内容</li>
<li>2、将文件行内容转换为实体类对象</li>
<li>3、将实体类对象保存到数据库</li>
<li>4、导入失败的对象重新写入文件并注明失败原因</li>
</ul>
<h3 id="导入代码实现"><a href="#导入代码实现" class="headerlink" title="导入代码实现"></a>导入代码实现</h3><p><strong>FileImporter.java</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">batchImport</span><span class="token punctuation">(</span><span class="token class-name">FileTask</span> task<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> rowList<span class="token punctuation">,</span> <span class="token class-name">FileHandler</span> fileHandler<span class="token punctuation">,</span> <span class="token class-name">ExportInfo</span> resultInfo<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ImportInfo</span> importInfo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span><span class="token function">addHandledCount</span><span class="token punctuation">(</span>rowList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> headCells <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getDataType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token class-name">Blacklist</span><span class="token operator">:</span>
            headCells <span class="token operator">=</span> <span class="token class-name">FileHead</span><span class="token punctuation">.</span><span class="token function">getImportFailedHead</span><span class="token punctuation">(</span><span class="token class-name">FileHeader</span><span class="token punctuation">.</span><span class="token constant">BLACKLIST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            importInfo <span class="token operator">=</span> <span class="token function">importBlacklist</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> rowList<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token class-name">Whitelist</span><span class="token operator">:</span>
            headCells <span class="token operator">=</span> <span class="token class-name">FileHead</span><span class="token punctuation">.</span><span class="token function">getImportFailedHead</span><span class="token punctuation">(</span><span class="token class-name">FileHeader</span><span class="token punctuation">.</span><span class="token constant">WHITELIST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            importInfo <span class="token operator">=</span> <span class="token function">importWhitelist</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> rowList<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token class-name">Keyword</span><span class="token operator">:</span>
            headCells <span class="token operator">=</span> <span class="token class-name">FileHead</span><span class="token punctuation">.</span><span class="token function">getImportFailedHead</span><span class="token punctuation">(</span><span class="token class-name">FileHeader</span><span class="token punctuation">.</span><span class="token constant">KEYWORD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            importInfo <span class="token operator">=</span> <span class="token function">importKeyword</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> rowList<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">FileImportException</span><span class="token punctuation">(</span><span class="token string">"Invalid data type: "</span> <span class="token operator">+</span> task<span class="token punctuation">.</span><span class="token function">getDataType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 导入失败的记录写入文件，并注明失败原因</span>
    <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> cellsList <span class="token operator">=</span> importInfo<span class="token punctuation">.</span><span class="token function">getFailedList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writeResultInfoFile</span><span class="token punctuation">(</span>headCells<span class="token punctuation">,</span> cellsList<span class="token punctuation">,</span> task<span class="token punctuation">,</span> resultInfo<span class="token punctuation">,</span> fileHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/**
 * 导入黑名单
 * @param task
 * @param rowList
 * @return
 */</span>
<span class="token keyword">private</span> <span class="token class-name">ImportInfo</span> <span class="token function">importBlacklist</span><span class="token punctuation">(</span><span class="token class-name">FileTask</span> task<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> rowList<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">ImportInfo</span> impInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImportInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
        <span class="token comment">// 文件行内容转换为实体类对象</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Blacklist</span><span class="token punctuation">></span></span> blacklists <span class="token operator">=</span> converter<span class="token punctuation">.</span><span class="token function">parseBlacklist</span><span class="token punctuation">(</span>rowList<span class="token punctuation">,</span> task<span class="token punctuation">.</span><span class="token function">getParamsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ListUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>blacklists<span class="token punctuation">)</span><span class="token punctuation">)</span>
            impInfo <span class="token operator">=</span> importDataService<span class="token punctuation">.</span><span class="token function">importBlacklist</span><span class="token punctuation">(</span>blacklists<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Import blacklist failed,cause by:&#123;&#125;"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        impInfo<span class="token punctuation">.</span><span class="token function">setResult</span><span class="token punctuation">(</span><span class="token class-name">Result<span class="token punctuation">.</span>Failed</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> impInfo<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>ImportService.java</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ImportInfo</span> <span class="token function">importBlacklist</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Blacklist</span><span class="token punctuation">></span></span> blacklists<span class="token punctuation">,</span> <span class="token class-name">FileTask</span> task<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
	<span class="token class-name">ImportInfo</span> importInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImportInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">ImportInfoBuild</span> importInfoBuild <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">getImportInfoBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// TODO 校验黑名单属性值是否合法</span>
		blacklistRepo<span class="token punctuation">.</span><span class="token function">addCachePhoneList</span><span class="token punctuation">(</span>blacklist<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">// 更新文件任务</span>
		task<span class="token punctuation">.</span><span class="token function">setHandledCount</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		task<span class="token punctuation">.</span><span class="token function">setHanldePercent</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getCurPercent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		fileTaskRepo<span class="token punctuation">.</span><span class="token function">updateHandlingTask</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">// 返回导入详情</span>
		importInfo<span class="token punctuation">.</span><span class="token function">setResult</span><span class="token punctuation">(</span><span class="token class-name">Result<span class="token punctuation">.</span>Success</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		importInfo<span class="token punctuation">.</span><span class="token function">setResult</span><span class="token punctuation">(</span><span class="token class-name">Result<span class="token punctuation">.</span>Failed</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">throw</span> e<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> importInfo<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>​    上面代码是导入逻辑的关键代码，如果我们想新增一种导入类型，就必须扩展<strong>FileImporter</strong>类的switch分支，增加对应的导入类型和方法，并调用<strong>ImportService</strong>类中新增的导入方法。这样做的缺点就是随着系统导入类型增多，FileImporter类中的分支越来越多，ImportService类中代码量急剧膨胀，给后期开发和维护带来无尽麻烦。</p>
<p>​    同时从设计原则层面来说，这样设计实现违背了<strong>单一职责</strong>、<strong>开闭原则</strong>，所有的导入方法都写入一个类中，后期扩展需要在原有类的基础上进行修改。</p>
<h1 id="使用策略模式重构导入"><a href="#使用策略模式重构导入" class="headerlink" title="使用策略模式重构导入"></a>使用策略模式重构导入</h1><p>文件导入类中使用策略工厂获取对应的导入策略类，在策略类中将公共方法抽象为接口，这样在新增一种导入类型时，只需新增策略类并实现抽象方法即可。</p>
<p>   <strong>FileImporter.java</strong>（文件导入类）</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">batchImport</span><span class="token punctuation">(</span><span class="token class-name">FileTask</span> task<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> rowList<span class="token punctuation">,</span> <span class="token class-name">FileHandler</span> fileHandler<span class="token punctuation">,</span> <span class="token class-name">ExportInfo</span> resultInfo<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 根据导入类型使用策略工厂获取对应的导入策略</span>
    <span class="token class-name">ImportFileStrategy</span> importFileStrategy <span class="token operator">=</span> importFileStrategyFactory<span class="token punctuation">.</span><span class="token function">fetchStrategy</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getDataType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ImportInfo</span> impInfo <span class="token operator">=</span>  importFileStrategy<span class="token punctuation">.</span><span class="token function">importFile</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> rowList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 导入失败的记录写入文件，并注明失败原因</span>
    <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> cellsList <span class="token operator">=</span> importFileStrategy<span class="token punctuation">.</span><span class="token function">dataConvert</span><span class="token punctuation">(</span>impInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writeResultInfoFile</span><span class="token punctuation">(</span>headCells<span class="token punctuation">,</span> cellsList<span class="token punctuation">,</span> task<span class="token punctuation">,</span> resultInfo<span class="token punctuation">,</span> fileHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p><strong>DefaultImportFileStrategyFactory.java</strong>(导入策略工厂类)</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultImportFileStrategyFactory</span> <span class="token keyword">implements</span> <span class="token class-name">ImportFileStrategyFactory</span><span class="token punctuation">,</span> <span class="token class-name">ApplicationContextAware</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">STRATEGY_SUFFIX</span> <span class="token operator">=</span> <span class="token string">"ImportFileStrategy"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">DefaultImportFileStrategyFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">ApplicationContext</span> applicationContext<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">ApplicationContext</span> applicationContext<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext <span class="token operator">=</span> applicationContext<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ImportFileStrategy</span> <span class="token function">fetchStrategy</span><span class="token punctuation">(</span><span class="token class-name">String</span> typeName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ImportFileStrategyFactoryException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ImportFileStrategy</span> importFileStrategy <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>typeName <span class="token operator">+</span> <span class="token constant">STRATEGY_SUFFIX</span><span class="token punctuation">,</span> <span class="token class-name">ImportFileStrategy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>importFileStrategy <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Fetch ImportFileStrategy failed,Unknown strategy type:&#123;&#125;"</span><span class="token punctuation">,</span>typeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ImportFileStrategyFactoryException</span><span class="token punctuation">(</span><span class="token class-name">MessageFormat</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Fetch ImportFileStrategy failed,Unknown strategy type:&#123;0&#125;"</span><span class="token punctuation">,</span>typeName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> importFileStrategy<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>ImportFileStrategy.java**(导入策略接口)</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ImportFileStrategy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token class-name">ImportInfo</span> <span class="token function">importFile</span><span class="token punctuation">(</span><span class="token class-name">FileTask</span> task<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> rowList<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getImportFileHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token function">dataConvert</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>AbstractImportFileStrategy.java</strong>(导入策略抽象类)</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractImportFileStrategy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">ImportFileStrategy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ImportInfo</span> <span class="token function">importFile</span><span class="token punctuation">(</span><span class="token class-name">FileTask</span> task<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> rowList<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> params <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">getParamsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> elements <span class="token operator">=</span> <span class="token function">rowList2Objects</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> rowList<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">importList</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> <span class="token function">rowList2Objects</span><span class="token punctuation">(</span><span class="token class-name">FileTask</span> task<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> rowList<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">ImportInfo</span> <span class="token function">importList</span><span class="token punctuation">(</span><span class="token class-name">FileTask</span> task<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">></span></span> elements<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>BlacklistImportFileStrategy.java</strong>(黑名单导入策略类)</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BlacklistImportFileStrategy</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractImportFileStrategy</span><span class="token operator">&lt;</span><span class="token class-name">Blacklist</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Blacklist</span><span class="token punctuation">></span></span> <span class="token function">rowList2Objects</span><span class="token punctuation">(</span><span class="token class-name">FileTask</span> task<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> rowList<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> params<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// TODO 文件行内容转换为实体类对象</span>
        <span class="token keyword">return</span> blacklist<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">ImportInfo</span> <span class="token function">importList</span><span class="token punctuation">(</span><span class="token class-name">FileTask</span> task<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Blacklist</span><span class="token punctuation">></span></span> elements<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// TODO 将对象列表存储到数据库</span>
        <span class="token keyword">return</span> importInfo<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getImportFileHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 获取文件头信息</span>
        <span class="token keyword">return</span> header<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token function">dataConvert</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Blacklist</span><span class="token punctuation">></span></span> elements<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 将类对象转换为文件行内容</span>
        <span class="token keyword">return</span> list<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>从上我们可以看出，当我们需要新增一个导出类型时，只需新增一个导出策略类并继承<strong>AbstractImportFileStrategy</strong>抽象类，实现所有抽象方法即可。</p>
<p>系统导出的问题与导入类似，重构的方法也是类似的，这里不再赘述。</p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>设计模式</tag>
        <tag>策略模式</tag>
      </tags>
  </entry>
  <entry>
    <title>Apache SkyWalking简介及使用</title>
    <url>/2020/05/20/framework/apache-skywalking-jian-jie-ji-shi-yong/</url>
    <content><![CDATA[<h2 id="一、SkyWalking-简介"><a href="#一、SkyWalking-简介" class="headerlink" title="一、SkyWalking 简介"></a>一、SkyWalking 简介</h2><p>Apache SkyWalking 是一个开源的应用性能监控（APM）和可观测性分析平台，专为分布式系统、微服务、云原生和基于容器的架构而设计。</p>
<h3 id="核心特性"><a href="#核心特性" class="headerlink" title="核心特性"></a>核心特性</h3><ul>
<li><strong>分布式追踪</strong>：自动采集服务间调用链路，提供端到端的请求追踪</li>
<li><strong>性能指标监控</strong>：实时收集应用性能指标（吞吐量、响应时间、错误率等）</li>
<li><strong>服务拓扑分析</strong>：自动发现服务依赖关系，生成服务拓扑图</li>
<li><strong>告警机制</strong>：支持基于规则的智能告警</li>
<li><strong>多语言支持</strong>：Java、.NET Core、PHP、NodeJS、Golang、Python、Lua 等</li>
<li><strong>服务网格支持</strong>：与 Istio、Envoy 等服务网格集成</li>
</ul>
<p><img src="/2020/05/20/framework/apache-skywalking-jian-jie-ji-shi-yong/frame.jpeg" alt="SkyWalking架构图"></p>
<h3 id="架构组件"><a href="#架构组件" class="headerlink" title="架构组件"></a>架构组件</h3><p>SkyWalking 主要由以下核心组件构成：</p>
<ol>
<li><strong>Agent（探针）</strong>：部署在应用程序中，负责数据采集</li>
<li><strong>OAP Server（分析平台）</strong>：接收、分析、聚合数据</li>
<li><strong>Storage（存储）</strong>：支持 ElasticSearch、H2、MySQL 等多种存储方案</li>
<li><strong>UI（界面）</strong>：提供可视化展示和分析能力</li>
</ol>
<h2 id="二、核心概念"><a href="#二、核心概念" class="headerlink" title="二、核心概念"></a>二、核心概念</h2><h3 id="1-Trace（调用链）"><a href="#1-Trace（调用链）" class="headerlink" title="1. Trace（调用链）"></a>1. Trace（调用链）</h3><p>一次完整的分布式请求调用过程，由多个 Span 组成。每个 Trace 有唯一的 TraceId。</p>
<h3 id="2-Span（跨度）"><a href="#2-Span（跨度）" class="headerlink" title="2. Span（跨度）"></a>2. Span（跨度）</h3><p>Trace 中的一个操作单元，代表一次方法调用、远程调用或数据库访问等。包含：</p>
<ul>
<li><strong>SpanId</strong>：当前 Span 的唯一标识</li>
<li><strong>ParentSpanId</strong>：父 Span 的标识</li>
<li><strong>操作名称</strong>：如 HTTP 请求路径、数据库 SQL 等</li>
<li><strong>时间戳</strong>：开始和结束时间</li>
<li><strong>Tags</strong>：键值对形式的元数据</li>
<li><strong>Logs</strong>：事件日志</li>
</ul>
<h3 id="3-Service（服务）"><a href="#3-Service（服务）" class="headerlink" title="3. Service（服务）"></a>3. Service（服务）</h3><p>提供一组相同功能的应用实例的集合。</p>
<h3 id="4-Endpoint（端点）"><a href="#4-Endpoint（端点）" class="headerlink" title="4. Endpoint（端点）"></a>4. Endpoint（端点）</h3><p>服务中的具体路径或 URI，代表一个具体的业务功能入口。</p>
<h2 id="三、Java-Agent-使用"><a href="#三、Java-Agent-使用" class="headerlink" title="三、Java Agent 使用"></a>三、Java Agent 使用</h2><h3 id="1-下载-SkyWalking-Agent"><a href="#1-下载-SkyWalking-Agent" class="headerlink" title="1. 下载 SkyWalking Agent"></a>1. 下载 SkyWalking Agent</h3><p>从 <a href="https://skywalking.apache.org/downloads/">Apache SkyWalking 官网</a> 下载对应版本的 Agent。</p>
<h3 id="2-Agent-目录结构"><a href="#2-Agent-目录结构" class="headerlink" title="2. Agent 目录结构"></a>2. Agent 目录结构</h3><pre class="line-numbers language-none"><code class="language-none">skywalking-agent&#x2F;
├── activations&#x2F;          # 可选插件
├── config&#x2F;              # 配置文件
│   └── agent.config
├── plugins&#x2F;             # 核心插件
├── optional-plugins&#x2F;    # 可选插件
├── bootstrap-plugins&#x2F;   # 启动插件
└── skywalking-agent.jar # Agent 核心包<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-应用接入"><a href="#3-应用接入" class="headerlink" title="3. 应用接入"></a>3. 应用接入</h3><h4 id="方式一：JVM-参数方式"><a href="#方式一：JVM-参数方式" class="headerlink" title="方式一：JVM 参数方式"></a>方式一：JVM 参数方式</h4><p>在应用启动时添加 JVM 参数：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">java</span> -javaagent:/path/to/skywalking-agent.jar <span class="token punctuation">\</span>
     <span class="token parameter variable">-Dskywalking.agent.service_name</span><span class="token operator">=</span>your-service-name <span class="token punctuation">\</span>
     <span class="token parameter variable">-Dskywalking.collector.backend_service</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1:11800 <span class="token punctuation">\</span>
     <span class="token parameter variable">-jar</span> your-application.jar<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="方式二：环境变量方式"><a href="#方式二：环境变量方式" class="headerlink" title="方式二：环境变量方式"></a>方式二：环境变量方式</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">SW_AGENT_NAME</span><span class="token operator">=</span>your-service-name
<span class="token builtin class-name">export</span> <span class="token assign-left variable">SW_AGENT_COLLECTOR_BACKEND_SERVICES</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1:11800
<span class="token function">java</span> -javaagent:/path/to/skywalking-agent.jar <span class="token parameter variable">-jar</span> your-application.jar<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="4-核心配置说明"><a href="#4-核心配置说明" class="headerlink" title="4. 核心配置说明"></a>4. 核心配置说明</h3><p>编辑 <code>agent.config</code> 文件：</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token comment"># 服务名称（必填）</span>
<span class="token key attr-name">agent.service_name</span><span class="token punctuation">=</span><span class="token value attr-value">$&#123;SW_AGENT_NAME:your-application&#125;</span>

<span class="token comment"># OAP Server 地址（必填）</span>
<span class="token key attr-name">collector.backend_service</span><span class="token punctuation">=</span><span class="token value attr-value">$&#123;SW_AGENT_COLLECTOR_BACKEND_SERVICES:127.0.0.1:11800&#125;</span>

<span class="token comment"># 采样率（可选，默认为负数表示全量采集）</span>
<span class="token comment"># agent.sample_n_per_3_secs=$&#123;SW_AGENT_SAMPLE:-1&#125;</span>

<span class="token comment"># 是否忽略特定后缀的 Trace</span>
<span class="token comment"># agent.ignore_suffix=$&#123;SW_AGENT_IGNORE_SUFFIX:.jpg,.jpeg,.js,.css,.png,.bmp,.gif,.ico,.mp3,.mp4&#125;</span>

<span class="token comment"># 限制 Span 数量</span>
<span class="token comment"># agent.span_limit_per_segment=$&#123;SW_AGENT_SPAN_LIMIT:300&#125;</span>

<span class="token comment"># 插件配置</span>
<span class="token comment"># plugin.jdbc.trace_sql_parameters=$&#123;SW_JDBC_TRACE_SQL_PARAMETERS:false&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="四、插件机制"><a href="#四、插件机制" class="headerlink" title="四、插件机制"></a>四、插件机制</h2><h3 id="1-核心插件（默认加载）"><a href="#1-核心插件（默认加载）" class="headerlink" title="1. 核心插件（默认加载）"></a>1. 核心插件（默认加载）</h3><p>SkyWalking 默认加载的插件包括：</p>
<ul>
<li><strong>HTTP 框架</strong>：Tomcat、Jetty、Spring MVC、Spring WebFlux</li>
<li><strong>RPC 框架</strong>：Dubbo、gRPC、Motan</li>
<li><strong>数据库</strong>：MySQL、Oracle、PostgreSQL、MongoDB、Redis</li>
<li><strong>消息队列</strong>：Kafka、RabbitMQ、RocketMQ、ActiveMQ</li>
<li><strong>缓存</strong>：Jedis、Lettuce、Redisson</li>
<li><strong>日志框架</strong>：Logback、Log4j、Log4j2</li>
</ul>
<h3 id="2-可选插件"><a href="#2-可选插件" class="headerlink" title="2. 可选插件"></a>2. 可选插件</h3><p>位于 <code>optional-plugins/</code> 目录，需要手动复制到 <code>plugins/</code> 目录才会生效：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 启用 Spring Cloud Gateway 插件</span>
<span class="token function">cp</span> optional-plugins/apm-spring-cloud-gateway-*.jar plugins/

<span class="token comment"># 启用 trace 日志上下文插件</span>
<span class="token function">cp</span> optional-plugins/apm-trace-ignore-plugin-*.jar plugins/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-自定义插件开发"><a href="#3-自定义插件开发" class="headerlink" title="3. 自定义插件开发"></a>3. 自定义插件开发</h3><p>如需监控自定义组件，可以开发 SkyWalking 插件：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 1. 定义增强点</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyComponentInstrumentation</span> <span class="token keyword">extends</span> <span class="token class-name">ClassInstanceMethodsEnhancePluginDefine</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">ClassMatch</span> <span class="token function">enhanceClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">NameMatch</span><span class="token punctuation">.</span><span class="token function">byName</span><span class="token punctuation">(</span><span class="token string">"com.example.MyComponent"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">InstanceMethodsInterceptPoint</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getInstanceMethodsInterceptPoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InstanceMethodsInterceptPoint</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">new</span> <span class="token class-name">InstanceMethodsInterceptPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token class-name">ElementMatcher</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MethodDescription</span><span class="token punctuation">></span></span> <span class="token function">getMethodsMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">return</span> <span class="token function">named</span><span class="token punctuation">(</span><span class="token string">"execute"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>

                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMethodsInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">return</span> <span class="token string">"com.example.MyComponentInterceptor"</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>

                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isOverrideArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 2. 实现拦截器</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyComponentInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">InstanceMethodsAroundInterceptor</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">beforeMethod</span><span class="token punctuation">(</span><span class="token class-name">EnhancedInstance</span> objInst<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> allArguments<span class="token punctuation">,</span>
                            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> argumentsTypes<span class="token punctuation">,</span> <span class="token class-name">MethodInterceptResult</span> result<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 创建 Span</span>
        <span class="token class-name">AbstractSpan</span> span <span class="token operator">=</span> <span class="token class-name">ContextManager</span><span class="token punctuation">.</span><span class="token function">createLocalSpan</span><span class="token punctuation">(</span><span class="token string">"MyComponent/execute"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        span<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span><span class="token class-name">ComponentsDefine</span><span class="token punctuation">.</span><span class="token constant">CUSTOM</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Tags</span><span class="token punctuation">.</span><span class="token constant">LOGIC_ENDPOINT</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>span<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">afterMethod</span><span class="token punctuation">(</span><span class="token class-name">EnhancedInstance</span> objInst<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> allArguments<span class="token punctuation">,</span>
                             <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> argumentsTypes<span class="token punctuation">,</span> <span class="token class-name">Object</span> ret<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 结束 Span</span>
        <span class="token class-name">ContextManager</span><span class="token punctuation">.</span><span class="token function">stopSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMethodException</span><span class="token punctuation">(</span><span class="token class-name">EnhancedInstance</span> objInst<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span>
                                     <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> allArguments<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> argumentsTypes<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 记录异常</span>
        <span class="token class-name">ContextManager</span><span class="token punctuation">.</span><span class="token function">activeSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="五、实践要点"><a href="#五、实践要点" class="headerlink" title="五、实践要点"></a>五、实践要点</h2><h3 id="1-采样策略"><a href="#1-采样策略" class="headerlink" title="1. 采样策略"></a>1. 采样策略</h3><p>根据业务场景选择合适的采样率：</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token comment"># 全量采集（生产环境慎用）</span>
<span class="token key attr-name">agent.sample_n_per_3_secs</span><span class="token punctuation">=</span><span class="token value attr-value">-1</span>

<span class="token comment"># 每 3 秒采样 1000 条</span>
<span class="token key attr-name">agent.sample_n_per_3_secs</span><span class="token punctuation">=</span><span class="token value attr-value">1000</span>

<span class="token comment"># 每 3 秒采样 100 条（适合高并发场景）</span>
<span class="token key attr-name">agent.sample_n_per_3_secs</span><span class="token punctuation">=</span><span class="token value attr-value">100</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-性能优化"><a href="#2-性能优化" class="headerlink" title="2. 性能优化"></a>2. 性能优化</h3><p><strong>限制 Span 数量</strong>：避免超长调用链导致内存溢出</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">agent.span_limit_per_segment</span><span class="token punctuation">=</span><span class="token value attr-value">300</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>忽略静态资源</strong>：减少无效 Trace</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">agent.ignore_suffix</span><span class="token punctuation">=</span><span class="token value attr-value">.jpg,.jpeg,.js,.css,.png,.bmp,.gif,.ico</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>关闭 SQL 参数追踪</strong>：降低数据量（生产环境推荐）</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">plugin.jdbc.trace_sql_parameters</span><span class="token punctuation">=</span><span class="token value attr-value">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="3-常见问题"><a href="#3-常见问题" class="headerlink" title="3. 常见问题"></a>3. 常见问题</h3><p><strong>Q1：Agent 对应用性能影响有多大？</strong></p>
<p>A：经过优化后，性能损耗通常在 5% 以内。主要影响因素：</p>
<ul>
<li>采样率设置</li>
<li>插件数量</li>
<li>网络传输开销</li>
</ul>
<p><strong>Q2：如何排查 Agent 未生效？</strong></p>
<p>A：检查以下几点：</p>
<ol>
<li>JVM 参数是否正确配置</li>
<li><code>agent.config</code> 配置是否正确</li>
<li>OAP Server 是否可访问</li>
<li>查看应用日志中的 SkyWalking 启动信息</li>
<li>检查 <code>logs/skywalking-api.log</code></li>
</ol>
<p><strong>Q3：如何在容器化环境使用？</strong></p>
<p>A：Dockerfile 示例：</p>
<pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token instruction"><span class="token keyword">FROM</span> openjdk:8-jre</span>

<span class="token comment"># 复制 Agent</span>
<span class="token instruction"><span class="token keyword">COPY</span> skywalking-agent /skywalking-agent</span>

<span class="token comment"># 复制应用</span>
<span class="token instruction"><span class="token keyword">COPY</span> app.jar /app.jar</span>

<span class="token comment"># 设置环境变量</span>
<span class="token instruction"><span class="token keyword">ENV</span> SW_AGENT_NAME=my-service</span>
<span class="token instruction"><span class="token keyword">ENV</span> SW_AGENT_COLLECTOR_BACKEND_SERVICES=oap-server:11800</span>

<span class="token comment"># 启动应用</span>
<span class="token instruction"><span class="token keyword">ENTRYPOINT</span> [<span class="token string">"java"</span>, <span class="token string">"-javaagent:/skywalking-agent/skywalking-agent.jar"</span>, <span class="token string">"-jar"</span>, <span class="token string">"/app.jar"</span>]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h2><p>Apache SkyWalking 作为一款优秀的 APM 工具，具有以下优势：</p>
<p>✅ <strong>零侵入</strong>：通过 Java Agent 技术，无需修改代码<br>✅ <strong>轻量级</strong>：性能损耗低，适合生产环境<br>✅ <strong>功能全面</strong>：覆盖追踪、度量、日志等多维度监控<br>✅ <strong>扩展性强</strong>：插件机制支持自定义扩展<br>✅ <strong>社区活跃</strong>：Apache 顶级项目，持续更新维护</p>
<p>通过合理配置和使用 SkyWalking，可以有效提升分布式系统的可观测性，快速定位性能瓶颈和故障根因。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://skywalking.apache.org/docs/">Apache SkyWalking 官方文档</a></li>
<li><a href="https://github.com/apache/skywalking">SkyWalking GitHub 仓库</a></li>
<li><a href="https://skywalking.apache.org/docs/skywalking-java/latest/en/setup/service-agent/java-agent/README/">SkyWalking 插件开发指南</a></li>
</ul>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>SkyWalking</tag>
        <tag>APM</tag>
        <tag>分布式追踪</tag>
        <tag>微服务监控</tag>
      </tags>
  </entry>
  <entry>
    <title>Netty简介</title>
    <url>/2018/07/25/framework/shen-ru-xue-xi-netty-kuang-jia/</url>
    <content><![CDATA[<p><strong>官网简介：</strong><br>　　<code>Netty is an asynchronous event-driven network application framework for rapid development of maintainable high performance protocol servers &amp; clients.</code><br><strong>用一句话来概括：</strong><br>　　Netty是一个异步事件驱动的网络应用框架，用于快速开发可维护的高性能协议服务器和客户端。  </p>
<hr>
<h4 id="特征"><a href="#特征" class="headerlink" title="特征"></a>特征</h4><p><strong>设计</strong>  </p>
<ul>
<li>适用于各种传输类型的统一API - 阻塞和非阻塞套接字</li>
<li>基于灵活且可扩展的事件模型，可以清晰地分离关注点</li>
<li>高度可定制的线程模型 - 单线程，一个或多个线程池，如SEDA</li>
<li>真正的无连接数据报套接字支持（自3.1起）</li>
</ul>
<p><strong>易用</strong></p>
<ul>
<li>详细记录的Javadoc，用户指南和示例</li>
<li>没有其他依赖项，JDK 5（Netty 3.x）或6（Netty 4.x）就足够了</li>
</ul>
<p><strong>性能</strong></p>
<ul>
<li>吞吐量更高，延迟更低</li>
<li>减少资源消耗</li>
<li>最小化不必要的内存复制</li>
</ul>
<p><strong>安全</strong></p>
<ul>
<li>完整的SSL &#x2F; TLS和StartTLS支持</li>
</ul>
<hr>
<h4 id="架构示意图"><a href="#架构示意图" class="headerlink" title="架构示意图"></a>架构示意图</h4><p><img src="/2018/07/25/framework/shen-ru-xue-xi-netty-kuang-jia/components.png" alt="Netty框架图"></p>
]]></content>
      <tags>
        <tag>netty</tag>
      </tags>
  </entry>
  <entry>
    <title>Shiro简介及使用</title>
    <url>/2018/08/26/framework/shiro-jian-jie-ji-shi-yong/</url>
    <content><![CDATA[<p>　　<strong>Apache Shiro™</strong> is a powerful and easy-to-use Java security framework that performs authentication, authorization, cryptography, and session management. With Shiro’s easy-to-understand API, you can quickly and easily secure any application – from the smallest mobile applications to the largest web and enterprise applications.</p>
<p>　　Apache Shiro™是一个功能强大且易于使用的Java安全框架，可执行身份验证，授权，加密和会话管理。 借助Shiro易于理解的API，您可以快速轻松地保护任何应用程序 - 从最小的移动应用程序到最大的Web和企业应用程序。</p>
<p>#一、Apache Shiro简介</p>
<p>　　Apache Shiro的首要目标是易于使用和理解。安全有时可能非常复杂，甚至是痛苦的，但并非必须如此。框架应尽可能掩盖复杂性，并提供简洁直观的API，以简化开发人员确保其应用程序安全的工作。</p>
<p>##1、Apache Shiro可以做的一些事情：</p>
<ul>
<li>验证用户以验证其身份</li>
<li>为用户执行访问控制，例如：<ul>
<li>确定是否为用户分配了某个安全角色</li>
<li>确定是否允许用户执行某些操作</li>
</ul>
</li>
<li>在任何环境中使用Session API，即使没有Web容器或EJB容器也是如此。</li>
<li>在身份验证，访问控制或会话生命周期内对事件做出反应。</li>
<li>聚合用户安全数据的1个或多个数据源，并将其全部显示为单个复合用户“视图”。</li>
<li>启用单点登录（SSO）功能</li>
<li>无需登录即可为用户关联启用“记住我”服务</li>
</ul>
<p>　　Shiro尝试为所有应用程序环境实现这些功能 - 从最简单的命令行应用程序到最大的企业应用程序，而不会强制依赖其他第三方框架，容器或应用程序服务器。当然，该项目旨在尽可能地融入这些环境，但它可以在任何环境中开箱即用。</p>
<p>##2、Shiro的功能特性</p>
<p>Apache Shiro是一个具有许多功能的综合应用程序安全框架。下图显示了Shiro主要关注点：</p>
<p><img src="/2018/08/26/framework/shiro-jian-jie-ji-shi-yong/ShiroFeatures.png" alt="shiro功能"></p>
<p>Shiro针对应用程序安全的四大基础-Authentication, Authorization, Session Management, and Cryptography:</p>
<ul>
<li><strong>Authentication:</strong> 身份认证&#x2F;登录，验证用户是不是拥有相应的身份；</li>
<li><strong>Authorization:</strong> 授权，即权限验证，验证某个已认证的用户是否拥有某个权限；</li>
<li><strong>Session Management:</strong> 会话管理，即用户登录后就是一次会话，在没有退出之前，它的所有信息都在会话中；</li>
<li><strong>Cryptography:</strong> 加密，保护数据的安全性，如密码加密存储到数据库，而不是明文存储；</li>
</ul>
<p>在不同的应用程序环境中还有其他功能可以支持和强化这些问题，尤其是：</p>
<ul>
<li>Web Support：Shiro的Web支持API可帮助轻松保护Web应用程序。</li>
<li>Caching：缓存，确保安全操作保持快速高效。</li>
<li>Concurrency：Apache Shiro支持具有并发功能的多线程应用程序。</li>
<li>Testing：存在测试支持以帮助您编写单元和集成测试，并确保您的代码按预期受到保护。</li>
<li>“Run As”：允许用户假定其他用户的身份（如果允许）的功能，有时在管理方案中很有用。</li>
<li>“Remember Me”：记住用户在会话中的身份，这样他们只需要在强制要求时登录。</li>
</ul>
<h2 id="3、Shiro架构"><a href="#3、Shiro架构" class="headerlink" title="3、Shiro架构"></a>3、Shiro架构</h2><p>Apache Shiro的设计目标是通过直观和易用来简化应用程序安全性。Shiro的核心设计模拟了大多数人对应用程序安全性的看法 - 在某人（或某事）与应用程序交互的环境中。 </p>
<p>shiro架构有三个主要概念：Subject，SecurityManager和Realms。下图是这些组建如何交互的高级概述、之后介绍每个概念：</p>
<p><img src="/2018/08/26/framework/shiro-jian-jie-ji-shi-yong/ShiroBasicArchitecture.png" alt="shiro架构"></p>
<ul>
<li><p><strong>Subject:</strong>  主体，<code>Subject</code>代表了与当前应用程序进行安全交互的“用户”。虽然“用户”这个词通常意味着一个具体的人，但是它可以是一个人，但它也可以代表第三方服务，守护进程帐户，cron作业或任何类似的东西 - 基本上任何与软件交互的东西。</p>
<p><code>Subject</code>实例都绑定到<code>SecurityManager</code>，当您与<code>Subject</code>‘进行交互时，这些交互会委托给<code>Subject</code>绑定的<code>SecurityManager</code>。</p>
</li>
<li><p><strong>SecurityManager:</strong> 安全管理器，<code>SecurityManager</code>是shiro架构的核心，<code>SecurityManager</code>管理着所有的<code>Subject</code>,所有与安全有关的操作都会与<code>SecurityManager</code>交互.</p>
</li>
<li><p><strong>Realm:</strong> 域，充当Shiro与应用程序安全数据之间的“桥梁”或“连接器”。当实际与安全相关的数据（如用户帐户）进行交互以执行身份验证（登录）和授权（访问控制）时，Shiro会从为应用程序配置的一个或多个领域中查找许多这些内容。</p>
<p>从这个意义上讲，Realm本质上是一个特殊的安全性的<a href="https://en.wikipedia.org/wiki/Data_access_object">DAO</a>：它封装了数据源的连接细节，并根据需要使相关数据可用于Shiro。配置Shiro时，必须至少指定一个Realm用于身份验证和&#x2F;或授权。</p>
<p>Shiro提供了开箱即用的领域，可以连接到许多安全数据源（也称为目录），如LDAP，关系数据库（JDBC），文本配置源（如INI和属性文件等）。如果默认域不符合您的需要，您可以插入自己的Realm实现来表示自定义数据源</p>
</li>
</ul>
<p><strong>注意：</strong> 从上述可以看出，shiro不提供维护用户和权限的功能，而是通过realm让用户自己来实现。</p>
<h3 id="shiro详细架构"><a href="#shiro详细架构" class="headerlink" title="shiro详细架构"></a>shiro详细架构</h3><p>下图显示了Shiro的核心架构概念，后面是每个概述的简短摘要：</p>
<p><img src="/2018/08/26/framework/shiro-jian-jie-ji-shi-yong/ShiroArchitecture.png" alt="shiro详细架构"></p>
<ul>
<li><strong>Subject</strong>（<a href="http://shiro.apache.org/static/current/apidocs/org/apache/shiro/subject/Subject.html"><code>org.apache.shiro.subject.Subject</code></a>）<br>当前与软件交互的实体（用户，第三方服务等）的“用户”。</li>
<li><strong>SecurityManager</strong>（<a href="http://shiro.apache.org/static/current/apidocs/org/apache/shiro/mgt/SecurityManager.html">org.apache.shiro.mgt.SecurityManager</a>）<br>如上所述，这<code>SecurityManager</code>是Shiro架构的核心，协调各组件稳定运行，所有的安全相关的操作都是通过<code>SecurityManager</code>进行控制。</li>
<li><strong>Authenticator</strong>（<a href="http://shiro.apache.org/static/current/apidocs/org/apache/shiro/authc/Authenticator.html">org.apache.shiro.authc.Authenticator</a>）<br>认证器，负责执行验证用户认证的组件。当用户尝试登录时，由<code>Authenticator</code>执行用户认证的逻辑。该<code>Authenticator</code>知道如何与一个或多个存储用户&#x2F;帐户信息的<code>Realms</code>协调工作。从这些<code>Realms</code>获取的数据用于验证用户的身份，以保证用户确实是他们所说的人。<ul>
<li><strong>Authentication Strategy</strong>（<a href="http://shiro.apache.org/static/current/apidocs/org/apache/shiro/authc/pam/AuthenticationStrategy.html">org.apache.shiro.authc.pam.AuthenticationStrategy</a>）<br>认证策略，如果多于一个<code>Realm</code>被配置时，<code>AuthenticationStrategy</code>将与<code>realm</code>协调，以确定在其下的认证尝试成功或失败（例如，如果一个<code>realm</code>认证成功但是其他认证失败，那么这次认证是成功的吗？必须所有<code>realm</code>都要认证成功？还是只需要第一个？）。</li>
</ul>
</li>
<li><strong>Authorizer</strong>（<a href="http://shiro.apache.org/static/current/apidocs/org/apache/shiro/authz/Authorizer.html">org.apache.shiro.authz.Authorizer</a>）<br>访问控制器，<code>Authorizer</code>确定“用户”在该应用程序的访问控制权限。决定用户是否有权限进行某项操作，控制用户能访问应用程序的哪些功能。</li>
<li><strong>SessionManager</strong>（<a href="http://shiro.apache.org/static/current/apidocs/org/apache/shiro/session/mgt/SessionManager.html">org.apache.shiro.session.mgt.SessionManager</a>）<br><code>SessionManager</code>知道如何创建和管理用户<code>Session</code>生命周期，提供在所有环境中的用户强大的会话体验。这是安全框架领域的一项独特功能 - 即使没有可用的Web &#x2F; Servlet或EJB容器，Shiro也能够在任何环境中本地管理用户会话。默认情况下，Shiro将使用现有的会话机制（例如Servlet Container），但如果没有，例如在独立应用程序或非Web环境中，它将使用其内置的企业会话管理提供相同的编程经验。的<code>SessionDAO</code>存在允许任何数据源被用来坚持的会议。<ul>
<li><strong>SessionDAO</strong>（<a href="http://shiro.apache.org/static/current/apidocs/org/apache/shiro/session/mgt/eis/SessionDAO.html">org.apache.shiro.session.mgt.eis.SessionDAO</a>）<br><code>SessionDAO</code>执行<code>Session</code>代表的持久性（CRUD）操作<code>SessionManager</code>。这允许将任何数据存储插入会话管理基础结构。</li>
</ul>
</li>
<li><strong>CacheManager</strong>（<a href="http://shiro.apache.org/static/current/apidocs/org/apache/shiro/cache/CacheManager.html">org.apache.shiro.cache.CacheManager</a>）<br><code>CacheManager</code>创建和管理<code>Cache</code>其他四郎组件使用实例的生命周期。由于Shiro可以访问许多后端数据源以进行身份验证，授权和会话管理，因此缓存一直是框架中的一流架构功能，可在使用这些数据源时提高性能。任何现代开源和&#x2F;或企业缓存产品都可以插入Shiro，以提供快速有效的用户体验。</li>
<li><strong>Cryptography</strong>（<a href="http://shiro.apache.org/static/current/apidocs/org/apache/shiro/crypto/package-summary.html">org.apache.shiro.crypto</a>）<br>密码模块，Shiro提供了一些常见的加密组件用于如密码加密&#x2F;解密的。该软件包中的所有类都经过精心设计，易于使用且易于理解。</li>
<li><strong>Realms</strong>（<a href="http://shiro.apache.org/static/current/apidocs/org/apache/shiro/realm/Realm.html">org.apache.shiro.realm.Realm</a>）<br>如上所述，Realms充当Shiro和应用程序安全数据之间的“桥接”或“连接器”。当实际与安全相关的数据（如用户帐户）进行交互以执行身份验证（登录）和授权（访问控制）时，Shiro会从为应用程序配置的一个或多个领域中查找许多这些内容。您可以根据<code>Realms</code>需要配置任意数量（通常每个数据源一个），Shiro将根据需要进行身份验证和授权协调。</li>
</ul>
<h1 id="二、Shiro核心功能"><a href="#二、Shiro核心功能" class="headerlink" title="二、Shiro核心功能"></a>二、Shiro核心功能</h1><p>上面主要介绍了shiro的功能特性及架构，下面介绍shiro的核心功能的使用。</p>
<h2 id="1、Shiro身份验证"><a href="#1、Shiro身份验证" class="headerlink" title="1、Shiro身份验证"></a>1、Shiro身份验证</h2><p><strong>身份验证</strong>过程就是证明用户实际上是他们所说的人，为了让用户证明自己的身份，他们需要提供一些能够让系统识别和信任的身份证明。</p>
<p>在shiro中，用户需要提供principals （身份）和credentials（证明）给shiro，从而应用能验证用户身份：</p>
<p><strong>principals</strong>：身份，即主体的标识属性，可以是任何东西，如用户名、邮箱等，唯一即可。一个主体可以有多个principals，但只有一个Primary principals，一般是用户名&#x2F;密码&#x2F;手机号。</p>
<p><strong>credentials</strong>：证明&#x2F;凭证，即只有主体知道的安全值，如密码&#x2F;数字证书等。</p>
<p>最常见的principals和credentials组合就是用户名&#x2F;密码了。接下来先进行一个基本的身份认证。</p>
<h2 id="2、身份验证步骤"><a href="#2、身份验证步骤" class="headerlink" title="2、身份验证步骤"></a>2、身份验证步骤</h2><p>Subject身份验证的过程主要分为以下三个步骤：</p>
<ul>
<li>1、收集用户身份&#x2F;凭证，即如用户名&#x2F;密码。</li>
<li>2、提交用户身份&#x2F;凭证进行身份验证。</li>
<li>3、如果提交成功，则允许访问，否则重试身份验证或阻止访问。</li>
</ul>
<p>接一下来结合代码对上述的三个步骤进行说明。</p>
<p><strong>步骤一：收集用户身份&#x2F;凭证，即如用户名&#x2F;密码</strong></p>
<pre class="line-numbers language-//Example" data-language="//Example"><div class="caption"><span>using most common scenario of username/password pair:</span></div><code class="language-//Example">&#x2F;&#x2F;Example using most common scenario of username&#x2F;password pair:
UsernamePasswordToken token &#x3D; new UsernamePasswordToken(username, password);

&#x2F;&#x2F;&quot;Remember Me&quot; built-in: 
token.setRememberMe(true);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在当前的例子中，我们使用了UsernamePasswordToken，支持最常见的用户名&#x2F;密码身份验证方法。这是Shiro的org.apache.shiro.authc.AuthenticationToken接口的实现，该接口是Shiro的身份验证系统用来表示提交的身份信息和凭据的基本接口。</p>
<p>这里需要注意的是，Shiro不关心如何获取这些信息，你可以从http表单中获取，也可以从http请求头中获取，或者通过命令行参数获取。应用程序获取用户身份信息和凭证的过程与与Shiro的AuthenticationToken概念完全分离。</p>
<p>这个例子还表明我们已经表示希望Shiro为身份验证尝试执行“记住我”服务。这可确保Shiro在以后返回应用程序时记住用户身份。</p>
<p><strong>步骤二：提交用户身份和凭证</strong></p>
<p>在收集了用户身份和凭据并将其表示为AuthenticationToken实例后，我们需要将token提交给Shiro以执行实际的身份验证尝试：</p>
<pre class="line-numbers language-Subject" data-language="Subject"><div class="caption"><span>currentUser </span></div><code class="language-Subject">Subject currentUser &#x3D; SecurityUtils.getSubject();
currentUser.login(token);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>获取当前正在执行的Subject后，我们进行一次登录调用，传入我们之前创建的AuthenticationToken实例。</p>
<p><strong>步骤三：处理验证结果（成功或失败）</strong></p>
<p>如果登录方法正常地返回，此次验证完成，用户已经过身份验证。 应用程序线程可以继续不间断，所有对SecurityUtils.getSubject（）的进一步调用将返回经过身份验证的Subject实例以及对subject的任何调用。 <code>isAuthenticated()</code>将返回true。</p>
<p>但是如果登录尝试失败会发生什么？ 例如，如果最终用户提供了错误的密码，或者访问了系统太多次并且他们的帐户被锁定了怎么办？</p>
<p>Shiro具有丰富的运行时AuthenticationException层次结构，可以准确指示尝试失败的原因。 您可以在try &#x2F; catch块中包装登录并捕获您希望的任何异常并相应地对它们做出反应。 例如：</p>
<pre class="line-numbers language-none"><code class="language-none">try &#123;
    currentUser.login(token);
&#125; catch ( UnknownAccountException uae ) &#123; ...&#x2F;&#x2F;用户名错误
&#125; catch ( IncorrectCredentialsException ice ) &#123; ...&#x2F;&#x2F;密码错误
&#125; catch ( LockedAccountException lae ) &#123; ...&#x2F;&#x2F;账号锁定
&#125; catch ( ExcessiveAttemptsException eae ) &#123; ...&#x2F;&#x2F;超过最大登录失败尝试次数
&#125; ... catch your own ...
&#125; catch ( AuthenticationException ae ) &#123;
    &#x2F;&#x2F;unexpected error?
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果其中一个现有异常类不满足您的需求，则可以创建自定义AuthenticationExceptions以表示特定的异常。</p>
<p><strong>Remembered vs. Authenticated</strong></p>
<p>如上例所示，除了正常的登录过程外，Shiro还支持“记住我”的概念。 值得指出的是，Shiro在<em>remembered</em> Subject和实际<em>authenticated</em> Subject之间做了非常精确的区分：</p>
<ul>
<li><p><strong>Remembered</strong>：<em>remembered</em> Subject不是匿名的并且具有已知的身份（即subject.getPrincipals（）非空）。 但是，在先前的会话期间，先前的身份验证会记住此身份。 如果subject.isRemembered（）返回true，则认为subject被记住。</p>
</li>
<li><p><strong>Authenticated</strong>：<em>authenticated</em> Subject是在subject的当前会话期间已成功通过身份验证的主题（即，在不抛出异常的情况下调用登录方法）。 如果subject.isAuthenticated（）返回true，则认为subject已经过身份验证。</p>
</li>
</ul>
<h2 id="三、身份验证流程"><a href="#三、身份验证流程" class="headerlink" title="三、身份验证流程"></a>三、身份验证流程</h2><p>到目前为止，我们只研究了如何从应用程序代码中验证subject。 现在我们将介绍在发生身份验证时Shiro内部发生的事情。</p>
<p>我们从架构章节中获取了我们之前的架构图，并且只保留了与身份验证相关的组件。 每个数字代表身份验证尝试期间的一个步骤：</p>
<p><img src="/2018/08/26/framework/shiro-jian-jie-ji-shi-yong/ShiroAuthenticationSequence.png" alt="身份验证流程"></p>
<ul>
<li><p><strong>步骤1</strong>：应用程序代码调用Subject.login方法，传入构造的AuthenticationToken实例，表示最终用户的身份和凭证。</p>
</li>
<li><p><strong>步骤2</strong>：Subject实例，通常是DelegatingSubject（或子类），通过调用securityManager.login（token）委托应用程序的SecurityManager，其中实际的身份验证工作开始。</p>
</li>
<li><p><strong>步骤3</strong>：SecurityManager接收tokent，并通过调用authenticator.authenticate（token）简单地委托给其内部Authenticatorinstance。一般是ModularRealmAuthenticator实例，它支持在身份验证期间协调一个或多个Realm实例。 ModularRealmAuthenticator实质上为Apache Shiro提供了PAM风格的范例（其中每个realm都是PAM术语中的“模块”）。</p>
</li>
<li><p><strong>步骤4</strong>：如果为应用程序配置了多个Realm，则ModularRealmAuthenticator实例将使用其配置的AuthenticationStrategy启动多Realm身份验证尝试。在调用Realms进行身份验证之前，期间和之后，将调用AuthenticationStrategy以允许它对每个Realm的结果做出反应。我们很快就会介绍AuthenticationStrategies。</p>
<ul>
<li><strong>注意</strong>：如果只配置了一个Realm，则直接调用它 ，在单Realm应用程序中不需要AuthenticationStrategy。</li>
</ul>
</li>
<li><p><strong>步骤5</strong>：查询每个配置的Realm以查看它是否支持提交的AuthenticationToken。 如果是这样，将使用提交的token调用支持的Realm的getAuthenticationInfo方法。 getAuthenticationInfo方法有效地表示该特定Realm的单个身份验证尝试。 我们将很快介绍Realm身份验证行为。</p>
</li>
</ul>
<p><strong><a href="http://shiro.apache.org/authentication.html#authenticator">Authenticator</a></strong></p>
<p>如上所述，Shiro SecurityManager默认使用ModularRealmAuthenticator实例。 ModularRealmAuthenticator同时支持具有单个Realm的应用程序以及具有多个Realm的应用程序。</p>
<p>在单领域应用程序中，ModularRealmAuthenticator将直接调用单个领域。如果配置了两个或更多领域，它将使用AuthenticationStrategy实例来协调尝试的发生方式。我们将在下面介绍AuthenticationStrategies。</p>
<p>ModularRealmAuthenticator能适合大多数应用场景，如果你希望使用自定义Authenticator，可以将自定义的Authenticator配置到SecurityManager。</p>
<p><strong><a href="http://shiro.apache.org/authentication.html#authenticationstrategy">AuthenticationStrategy</a>：认证策略</strong></p>
<p>当为应用程序配置两个或多个领域时，ModularRealmAuthenticator依赖于内部AuthenticationStrategy组件来确定身份验证尝试成功或失败的条件。</p>
<p>例如，如果只有一个Realm成功验证了AuthenticationToken，但其他所有验证失败，那么验证尝试是否成功？或者所有领域是否必须成功验证才能被认为是成功的整体尝试？或者，如果领域成功验证，是否有必要进一步咨询其他领域？ AuthenticationStrategy根据应用程序的需要做出适当的决策。</p>
<p>AuthenticationStrategy是一个无状态组件，在身份验证尝试期间会被查询4次（这4次交互所需的任何必要状态将作为方法参数提供）：</p>
<ul>
<li>1、在调用任何Realm之前</li>
<li>2、在调用单个Realm的getAuthenticationInfo方法之前</li>
<li>3、在调用单个Realm的getAuthenticationInfo方法之后立即执行</li>
<li>4、在所有Realm被调用之后</li>
</ul>
<p>AuthenticationStrategy还负责聚合每个成功Realm的结果，并将它们“绑定”到一个AuthenticationInfo表示中。最终聚合AuthenticationInfo实例是Authenticator实例返回的实例，也是Shiro用来表示Subject的最终身份（又名Principals）的实例。</p>
<p>Shiro有3个具体的AuthenticationStrategy实现：</p>
<table>
<thead>
<tr>
<th><code>AuthenticationStrategy</code> class</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><a href="http://shiro.apache.org/static/current/apidocs/org/apache/shiro/authc/pam/AtLeastOneSuccessfulStrategy.html"><code>AtLeastOneSuccessfulStrategy</code></a></td>
<td>如果一个（或多个）领域成功进行身份验证，则认为整体尝试成功。 如果没有成功进行身份验证，则尝试失败。</td>
</tr>
<tr>
<td><a href="http://shiro.apache.org/static/current/apidocs/org/apache/shiro/authc/pam/FirstSuccessfulStrategy.html"><code>FirstSuccessfulStrategy</code></a></td>
<td>仅使用从第一个成功通过身份验证的Realm返回的信息。 所有进一步的领域都将被忽略。 如果没有成功验证，则尝试失败。</td>
</tr>
<tr>
<td><a href="http://shiro.apache.org/static/current/apidocs/org/apache/shiro/authc/pam/AllSuccessfulStrategy.html"><code>AllSuccessfulStrategy</code></a></td>
<td>所有已配置的域必须成功进行身份验证才能将整体尝试视为成功。 如果任何人未成功验证，则尝试失败。</td>
</tr>
</tbody></table>
<p>ModularRealmAuthenticator默认为AtLeastOneSuccessfulStrategy实现，因为这是最常用的策略。</p>
<pre class="line-numbers language-none"><code class="language-none">*注：如果您想自己创建自己的AuthenticationStrategy实现，可以使用org.apache.shiro.authc.pam.AbstractAuthenticationStrategy作为起点。 AbstractAuthenticationStrategy类自动实现将每个Realm的结果合并到单个AuthenticationInfo实例中的“捆绑”&#x2F;聚合行为。<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong><a href="http://shiro.apache.org/authentication.html#realm-authentication-order">Realm Authentication Order</a>：认证顺序</strong></p>
<p>ModularRealmAuthenticator以迭代顺序与Realm实例交互。ModularRealmAuthenticator可以访问SecurityManager上配置的Realm实例。 执行身份验证尝试时，它将遍历该集合，并且对于支持提交的AuthenticationToken的每个Realm，调用Realm的getAuthenticationInfo方法。</p>
<p>ModularRealmAuthenticator根据SecurityManager中Realm配置按序调用的。</p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>shiro</tag>
        <tag>权限管理</tag>
      </tags>
  </entry>
  <entry>
    <title>一致性哈希算法</title>
    <url>/2019/10/06/distributed/yi-zhi-xing-ha-xi-suan-fa/</url>
    <content><![CDATA[<h2 id="一、什么是一致性哈希"><a href="#一、什么是一致性哈希" class="headerlink" title="一、什么是一致性哈希"></a>一、什么是一致性哈希</h2><p>一致性哈希算法（Consistent Hashing）是一种特殊的哈希算法，在移除或添加服务器时，能够尽可能小地改变已存在的键值映射关系。主要应用于分布式缓存系统中，解决节点动态增减时的数据重新分配问题。</p>
<h3 id="传统哈希的问题"><a href="#传统哈希的问题" class="headerlink" title="传统哈希的问题"></a>传统哈希的问题</h3><p>假设有 3 台缓存服务器，使用传统取模方式分配数据：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span> serverIndex <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">%</span> serverCount<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>当服务器数量变化时：</p>
<ul>
<li><strong>增加节点</strong>：serverCount 从 3 变为 4，大部分数据的映射关系都会改变</li>
<li><strong>删除节点</strong>：serverCount 从 3 变为 2，同样导致大量数据重新分配</li>
</ul>
<p>这会导致缓存大面积失效，引发<strong>缓存雪崩</strong>。</p>
<h2 id="二、一致性哈希原理"><a href="#二、一致性哈希原理" class="headerlink" title="二、一致性哈希原理"></a>二、一致性哈希原理</h2><h3 id="2-1-哈希环"><a href="#2-1-哈希环" class="headerlink" title="2.1 哈希环"></a>2.1 哈希环</h3><p>一致性哈希将整个哈希值空间组织成一个虚拟的圆环（Hash Ring），范围为 0 ~ 2^32-1：</p>
<ol>
<li><strong>服务器节点映射</strong>：对每台服务器的 IP 或主机名进行哈希，映射到环上的某个位置</li>
<li><strong>数据映射</strong>：对数据的 key 进行哈希，映射到环上的某个位置</li>
<li><strong>查找规则</strong>：从数据位置开始顺时针查找，遇到的第一个服务器节点即为存储位置</li>
</ol>
<h3 id="2-2-节点增减的影响"><a href="#2-2-节点增减的影响" class="headerlink" title="2.2 节点增减的影响"></a>2.2 节点增减的影响</h3><p><strong>删除节点</strong>：</p>
<ul>
<li>只影响该节点到其前一个节点之间的数据</li>
<li>这些数据会迁移到下一个节点</li>
</ul>
<p><strong>添加节点</strong>：</p>
<ul>
<li>只影响新节点到其前一个节点之间的数据</li>
<li>部分数据从下一个节点迁移到新节点</li>
</ul>
<p>相比传统方式，数据迁移量大幅减少。</p>
<h2 id="三、虚拟节点"><a href="#三、虚拟节点" class="headerlink" title="三、虚拟节点"></a>三、虚拟节点</h2><h3 id="3-1-数据倾斜问题"><a href="#3-1-数据倾斜问题" class="headerlink" title="3.1 数据倾斜问题"></a>3.1 数据倾斜问题</h3><p>当服务器节点较少时，可能出现数据分布不均的情况。例如 3 台服务器在环上的位置可能很接近，导致某台服务器承载了大部分数据。</p>
<h3 id="3-2-虚拟节点解决方案"><a href="#3-2-虚拟节点解决方案" class="headerlink" title="3.2 虚拟节点解决方案"></a>3.2 虚拟节点解决方案</h3><p>为每台物理服务器创建多个虚拟节点（Virtual Node），均匀分布在哈希环上：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 为每台服务器创建 150 个虚拟节点</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">150</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> virtualNodeName <span class="token operator">=</span> <span class="token string">"Server1#"</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>
    <span class="token keyword">int</span> hash <span class="token operator">=</span> <span class="token function">getHash</span><span class="token punctuation">(</span>virtualNodeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    virtualNodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> <span class="token string">"Server1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>优势</strong>：</p>
<ul>
<li>虚拟节点越多，数据分布越均匀</li>
<li>一般 100-200 个虚拟节点即可达到良好效果</li>
</ul>
<h2 id="四、Java-实现"><a href="#四、Java-实现" class="headerlink" title="四、Java 实现"></a>四、Java 实现</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsistentHash</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 虚拟节点数量</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> virtualNodeCount<span class="token punctuation">;</span>
    <span class="token comment">// 哈希环</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SortedMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">></span></span> ring <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">ConsistentHash</span><span class="token punctuation">(</span><span class="token keyword">int</span> virtualNodeCount<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>virtualNodeCount <span class="token operator">=</span> virtualNodeCount<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">/**
     * 添加服务器节点
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addNode</span><span class="token punctuation">(</span><span class="token class-name">T</span> node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> virtualNodeCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> virtualNodeName <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"#"</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>
            <span class="token keyword">int</span> hash <span class="token operator">=</span> <span class="token function">getHash</span><span class="token punctuation">(</span>virtualNodeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ring<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">/**
     * 删除服务器节点
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">removeNode</span><span class="token punctuation">(</span><span class="token class-name">T</span> node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> virtualNodeCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> virtualNodeName <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"#"</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>
            <span class="token keyword">int</span> hash <span class="token operator">=</span> <span class="token function">getHash</span><span class="token punctuation">(</span>virtualNodeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ring<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">/**
     * 获取数据应该存储的节点
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">getNode</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ring<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token keyword">int</span> hash <span class="token operator">=</span> <span class="token function">getHash</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 顺时针查找第一个节点</span>
        <span class="token class-name">SortedMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">></span></span> tailMap <span class="token operator">=</span> ring<span class="token punctuation">.</span><span class="token function">tailMap</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 如果没有找到，返回第一个节点（形成环）</span>
        <span class="token keyword">int</span> nodeHash <span class="token operator">=</span> tailMap<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> ring<span class="token punctuation">.</span><span class="token function">firstKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> tailMap<span class="token punctuation">.</span><span class="token function">firstKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ring<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>nodeHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">/**
     * FNV1_32_HASH 算法
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">getHash</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> p <span class="token operator">=</span> <span class="token number">16777619</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> hash <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token number">2166136261L</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> str<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            hash <span class="token operator">=</span> <span class="token punctuation">(</span>hash <span class="token operator">^</span> str<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> p<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        hash <span class="token operator">+=</span> hash <span class="token operator">&lt;&lt;</span> <span class="token number">13</span><span class="token punctuation">;</span>
        hash <span class="token operator">^=</span> hash <span class="token operator">>></span> <span class="token number">7</span><span class="token punctuation">;</span>
        hash <span class="token operator">+=</span> hash <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span>
        hash <span class="token operator">^=</span> hash <span class="token operator">>></span> <span class="token number">17</span><span class="token punctuation">;</span>
        hash <span class="token operator">+=</span> hash <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 创建一致性哈希，每个节点 150 个虚拟节点</span>
<span class="token class-name">ConsistentHash</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> consistentHash <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsistentHash</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 添加服务器节点</span>
consistentHash<span class="token punctuation">.</span><span class="token function">addNode</span><span class="token punctuation">(</span><span class="token string">"192.168.1.1:8080"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
consistentHash<span class="token punctuation">.</span><span class="token function">addNode</span><span class="token punctuation">(</span><span class="token string">"192.168.1.2:8080"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
consistentHash<span class="token punctuation">.</span><span class="token function">addNode</span><span class="token punctuation">(</span><span class="token string">"192.168.1.3:8080"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 查找数据应该存储的节点</span>
<span class="token class-name">String</span> server <span class="token operator">=</span> consistentHash<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span><span class="token string">"user:1001"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"数据应该存储在: "</span> <span class="token operator">+</span> server<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 添加新节点</span>
consistentHash<span class="token punctuation">.</span><span class="token function">addNode</span><span class="token punctuation">(</span><span class="token string">"192.168.1.4:8080"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 删除节点</span>
consistentHash<span class="token punctuation">.</span><span class="token function">removeNode</span><span class="token punctuation">(</span><span class="token string">"192.168.1.2:8080"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="五、应用场景"><a href="#五、应用场景" class="headerlink" title="五、应用场景"></a>五、应用场景</h2><h3 id="5-1-分布式缓存"><a href="#5-1-分布式缓存" class="headerlink" title="5.1 分布式缓存"></a>5.1 分布式缓存</h3><ul>
<li><strong>Memcached 客户端</strong>：使用一致性哈希分配缓存数据</li>
<li><strong>Redis Cluster</strong>：使用哈希槽（Hash Slot）的变种实现</li>
</ul>
<h3 id="5-2-负载均衡"><a href="#5-2-负载均衡" class="headerlink" title="5.2 负载均衡"></a>5.2 负载均衡</h3><ul>
<li><strong>Nginx</strong>：consistent hash 模块实现会话粘滞</li>
<li><strong>Dubbo</strong>：ConsistentHashLoadBalance 负载均衡策略</li>
</ul>
<h3 id="5-3-分布式存储"><a href="#5-3-分布式存储" class="headerlink" title="5.3 分布式存储"></a>5.3 分布式存储</h3><ul>
<li><strong>Cassandra</strong>：使用一致性哈希分配数据到不同节点</li>
<li><strong>DynamoDB</strong>：基于一致性哈希的分区策略</li>
</ul>
<h2 id="六、优缺点分析"><a href="#六、优缺点分析" class="headerlink" title="六、优缺点分析"></a>六、优缺点分析</h2><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ol>
<li><strong>单调性</strong>：节点增减时，已有映射关系不会改变，只会增加新映射</li>
<li><strong>分散性</strong>：数据均匀分布在各个节点上</li>
<li><strong>平衡性</strong>：通过虚拟节点避免数据倾斜</li>
<li><strong>可扩展性</strong>：方便动态增减节点</li>
</ol>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ol>
<li><strong>数据倾斜</strong>：节点较少时可能分布不均（虚拟节点可解决）</li>
<li><strong>实现复杂</strong>：相比简单取模方式，实现和维护成本较高</li>
<li><strong>虚拟节点开销</strong>：需要维护大量虚拟节点</li>
</ol>
<h2 id="七、总结"><a href="#七、总结" class="headerlink" title="七、总结"></a>七、总结</h2><p>一致性哈希算法通过引入哈希环和虚拟节点的概念，有效解决了分布式系统中节点动态增减导致的数据大规模迁移问题。在分布式缓存、负载均衡、分布式存储等场景中有广泛应用。</p>
<p><strong>核心要点</strong>：</p>
<ul>
<li>哈希环将数据和节点映射到同一空间</li>
<li>顺时针查找规则确定数据存储位置</li>
<li>虚拟节点保证数据分布均匀</li>
<li>节点变化时只影响相邻节点的数据</li>
</ul>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>一致性哈希算法</tag>
        <tag>分布式</tag>
        <tag>负载均衡</tag>
      </tags>
  </entry>
  <entry>
    <title>四种经典的限流算法</title>
    <url>/2024/06/08/distributed/si-chong-jing-dian-de-xian-liu-suan-fa/</url>
    <content><![CDATA[<p>在业务开发中经常遇到限流场景，本文主要介绍四种经典的限流算法：固定窗口计数器、滑动窗口计数器、漏桶算法、令牌桶算法，在做限流的场景时可以借鉴这几种经典的限流算法，掌握其使用场景级优缺点。</p>
<h1 id="一、固定窗口计数器（Fixed-Window）"><a href="#一、固定窗口计数器（Fixed-Window）" class="headerlink" title="一、固定窗口计数器（Fixed Window）"></a>一、固定窗口计数器（Fixed Window）</h1><p>固定窗口计数器(Fixed Window)算法的实现思路非常简单，维护一个固定单位时间内的计数器，如果检测到单位时间已经过去就重置计数器为零。计数限首先维护一个计数器，将单位时间段当做一个窗口，计数器记录这个窗口接收请求的次数。</p>
<ul>
<li>当次数少于限流阀值，就允许访问，并且计数器+1</li>
<li>当次数大于限流阀值，就拒绝访问</li>
<li>当前的时间窗口过去之后，计数器清零</li>
</ul>
<p><img src="/2024/06/08/distributed/si-chong-jing-dian-de-xian-liu-suan-fa/%E5%9B%BA%E5%AE%9A%E7%AA%97%E5%8F%A3%E8%AE%A1%E6%95%B0%E5%99%A8.png" alt="固定窗口计数器"></p>
<h1 id="二、-固定窗口算法的优缺点"><a href="#二、-固定窗口算法的优缺点" class="headerlink" title="二、 固定窗口算法的优缺点"></a>二、 固定窗口算法的优缺点</h1><ul>
<li>优点：固定窗口算法非常简单，易于实现和理解，性能高。</li>
<li>缺点：存在<strong>明显的临界问题</strong>。</li>
</ul>
<h2 id="1-2-临界问题"><a href="#1-2-临界问题" class="headerlink" title="1.2 临界问题"></a>1.2 临界问题</h2><p>临界问题：假设限流阀值为5个请求，单位时间窗口是1s,如果我们在单位时间内的前0.8-1s和1-1.2s，分别并发5个请求。虽然都没有超过阀值，但是如果算0.8-1.2s,则并发数高达10，已经超过单位时间1s不超过5阀值的定义。<br><img src="/2024/06/08/distributed/si-chong-jing-dian-de-xian-liu-suan-fa/%E5%9B%BA%E5%AE%9A%E7%AA%97%E5%8F%A3%E4%B8%B4%E7%95%8C%E9%97%AE%E9%A2%98.png" alt="固定窗口临界问题"></p>
<h2 id="2-2-滑动窗口计数器（Sliding-Window）"><a href="#2-2-滑动窗口计数器（Sliding-Window）" class="headerlink" title="2.2 滑动窗口计数器（Sliding Window）"></a>2.2 滑动窗口计数器（Sliding Window）</h2><blockquote>
<p>滑动窗口限流算法是一种常用的限流算法，用于控制系统对外提供服务的速率，防止系统被过多的请求压垮。它将单位时间周期分为n个小周期，分别记录每个小周期内接口的访问次数，并且根据时间滑动删除过期的小周期。<strong>它可以解决固定窗口临界值的问题。</strong></p>
</blockquote>
<p><img src="/2024/06/08/distributed/si-chong-jing-dian-de-xian-liu-suan-fa/%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3.png" alt="滑动窗口"></p>
<p>假设单位时间还是1s，滑动窗口算法把它划分为5个小周期，也就是滑动窗口（单位时间）被划分为5个小格子。每格表示0.2s。每过0.2s，时间窗口就会往右滑动一格。每个小周期，都有自己独立的计数器。</p>
<h2 id="2-1-滑动窗口限流算法的优缺点"><a href="#2-1-滑动窗口限流算法的优缺点" class="headerlink" title="2.1 滑动窗口限流算法的优缺点"></a>2.1 滑动窗口限流算法的优缺点</h2><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul>
<li>简单易懂</li>
<li>精度高（通过调整时间窗口的大小来实现不同的限流效果）</li>
<li>可扩展性强（可以非常容易地与其他限流算法结合使用）</li>
</ul>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ul>
<li>突发流量无法处理（无法应对短时间内的大量请求，但是一旦到达限流后，请求都会直接暴力被拒绝。会损失一部分请求，对于产品不太友好），需要合理调整时间窗口大小。</li>
</ul>
<blockquote>
<p>TIPS:当滑动窗口的格子周期划分的越多，那么滑动窗口的滚动就越平滑，限流的统计就会越精确。</p>
</blockquote>
<h1 id="三、漏桶算法（Leaky-Bucket）"><a href="#三、漏桶算法（Leaky-Bucket）" class="headerlink" title="三、漏桶算法（Leaky Bucket）"></a>三、漏桶算法（Leaky Bucket）</h1><p>漏桶限流算法（Leaky Bucket Algorithm）是一种流量控制算法，用于控制流入网络的数据速率，以防止网络拥塞。它的思想是将数据包看作是水滴，漏桶看作是一个固定容量的水桶，数据包像水滴一样从桶的顶部流入桶中，并通过桶底的一个小孔以一定的速度流出，从而限制了数据包的流量。<br><img src="/2024/06/08/distributed/si-chong-jing-dian-de-xian-liu-suan-fa/%E6%BC%8F%E6%A1%B6%E7%AE%97%E6%B3%95.png" alt="漏桶算法"></p>
<p>漏桶限流算法的基本工作原理是：对于每个到来的数据包，都将其加入到漏桶中，并检查漏桶中当前的水量是否超过了漏桶的容量。如果超过了容量，就将多余的数据包丢弃。如果漏桶中还有水，就以一定的速率从桶底输出数据包，保证输出的速率不超过预设的速率，从而达到限流的目的。</p>
<h2 id="3-1-漏桶限流算法的优缺点"><a href="#3-1-漏桶限流算法的优缺点" class="headerlink" title="3.1 漏桶限流算法的优缺点"></a>3.1 漏桶限流算法的优缺点</h2><h3 id="优点-1"><a href="#优点-1" class="headerlink" title="优点"></a>优点</h3><ul>
<li>可以平滑限制请求的处理速度，避免瞬间请求过多导致系统崩溃或者雪崩。</li>
<li>可以控制请求的处理速度，使得系统可以适应不同的流量需求，避免过载或者过度闲置。</li>
<li>可以通过调整桶的大小和漏出速率来满足不同的限流需求，可以灵活地适应不同的场景。</li>
</ul>
<h3 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h3><ul>
<li>需要对请求进行缓存，会增加服务器的内存消耗。</li>
<li>对于流量波动比较大的场景，需要较为灵活的参数配置才能达到较好的效果。</li>
<li>无法应对突发流量的场景。流量变突发时，我们肯定希望系统尽量快点处理请求，提升用户体验，但是漏桶算法只能以固定速度处理。</li>
</ul>
<h1 id="四、令牌桶算法-Token-Bucket"><a href="#四、令牌桶算法-Token-Bucket" class="headerlink" title="四、令牌桶算法(Token Bucket)"></a>四、令牌桶算法(Token Bucket)</h1><p>令牌桶算法是一种常用的限流算法，可以用于限制单位时间内请求的数量。该算法维护一个固定容量的令牌桶，每秒钟会向令牌桶中放入一定数量的令牌。当有请求到来时，如果令牌桶中有足够的令牌，则请求被允许通过并从令牌桶中消耗一个令牌，否则请求被拒绝。<br><img src="/2024/06/08/distributed/si-chong-jing-dian-de-xian-liu-suan-fa/%E4%BB%A4%E7%89%8C%E6%A1%B6%E7%AE%97%E6%B3%95.png" alt="令牌桶算法"></p>
<h2 id="4-1-令牌桶算法的优缺点"><a href="#4-1-令牌桶算法的优缺点" class="headerlink" title="4.1 令牌桶算法的优缺点"></a>4.1 令牌桶算法的优缺点</h2><h3 id="优点-2"><a href="#优点-2" class="headerlink" title="优点"></a>优点</h3><ul>
<li>稳定性高：令牌桶算法可以控制请求的处理速度，可以使系统的负载变得稳定。</li>
<li>精度高：令牌桶算法可以根据实际情况动态调整生成令牌的速率，可以实现较高精度的限流。</li>
<li>弹性好：令牌桶算法可以处理突发流量，可以在短时间内提供更多的处理能力，以处理突发流量。</li>
</ul>
<p>Guava的RateLimiter限流组件，就是基于令牌桶算法实现的。</p>
<h3 id="缺点-2"><a href="#缺点-2" class="headerlink" title="缺点"></a>缺点</h3><ul>
<li>实现复杂：相对于固定窗口算法等其他限流算法，令牌桶算法的实现较为复杂。对短时请求难以处理：在短时间内有大量请求到来时，可能会导致令牌桶中的令牌被快速消耗完，从而限流。这种情况下，可以考虑使用漏桶算法。</li>
<li>时间精度要求高：令牌桶算法需要在固定的时间间隔内生成令牌，因此要求时间精度较高，如果系统时间不准确，可能会导致限流效果不理想。</li>
</ul>
<p>总体来说，令牌桶算法具有较高的稳定性和精度，但实现相对复杂，适用于对稳定性和精度要求较高的场景。</p>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p><a href="https://juejin.cn/post/7000152990501847048">微服务 —— 常见的5种限流方案｜8月更文挑战</a><br><a href="https://juejin.cn/post/7339544833999110170">基于redis的简易滑动窗口实现</a><br><a href="https://heapdump.cn/article/5480577">面试必备：四种经典限流算法讲解</a></p>
]]></content>
      <categories>
        <category>分布式</category>
      </categories>
      <tags>
        <tag>高并发</tag>
        <tag>限流算法</tag>
        <tag>固定时间窗口</tag>
        <tag>滑动时间窗口</tag>
        <tag>漏洞算法</tag>
        <tag>令牌桶算法</tag>
      </tags>
  </entry>
  <entry>
    <title>分布式ID生成方案</title>
    <url>/2022/01/17/distributed/fen-bu-shi-id-sheng-cheng-fang-an/</url>
    <content><![CDATA[<h1 id="一、问题背景"><a href="#一、问题背景" class="headerlink" title="一、问题背景"></a>一、问题背景</h1><p>由于MySQL的单表数据量超过了千万级别，需要根据日期对数据库进行水平分表，分表后需要保证每个分表Id的全局唯一性，原来单表使用自增保证Id的有序性和唯一性，分表后需要生成全局唯一的Id。</p>
<p>所以接下来讨论一下分布式Id的生成方案，以及各种方案的优缺点等。</p>
<h1 id="二、分布式ID生成方案"><a href="#二、分布式ID生成方案" class="headerlink" title="二、分布式ID生成方案"></a>二、分布式ID生成方案</h1><h2 id="2-1-UUID"><a href="#2-1-UUID" class="headerlink" title="2.1 UUID"></a>2.1 UUID</h2><blockquote>
<p>A universally unique identifier (UUID) is a 128-bit label used for information in computer systems. The term globally unique identifier (GUID) is also used<br>通用唯一识别码（英语：Universally Unique Identifier，缩写：UUID）是用于计算机体系中以识别信息的一个128位标识符。</p>
</blockquote>
<p>根据标准方法生成，不依赖中央机构的注册和分配，UUID具有唯一性，这与其他大多数编号方案不同。重复UUID码概率接近零，可以忽略不计。<a href="https://zh.wikipedia.org/wiki/%E9%80%9A%E7%94%A8%E5%94%AF%E4%B8%80%E8%AF%86%E5%88%AB%E7%A0%81">通用唯一识别码-维基百科</a></p>
<h3 id="2-1-1-UUID定义"><a href="#2-1-1-UUID定义" class="headerlink" title="2.1.1 UUID定义"></a>2.1.1 UUID定义</h3><p>UUID是由一个16进制下的32位数所构成，故UUID理论上的总数为16的32次方&#x3D;2的128次方，约等于3.4 x 10的38次方。也就是说若每纳秒（ns）产生1万亿个UUID，要花100亿年才会将所有UUID用完。</p>
<p>UUID的标准型式包含32个16进制数字，以连字号分为五段，形式为 8-4-4-4-12 的32个字符。示例：<code>550e8400-e29b-41d4-a716-446655440000</code></p>
<h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul>
<li>生成容易、速度快</li>
<li>ID唯一（几乎不会产生重复ID，部分实现依赖于MAC硬件地址）</li>
<li>无需中心化服务器</li>
<li>不会泄露商业机密</li>
</ul>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ul>
<li>可读性差</li>
<li>占用空间太多（16个字节）</li>
<li>作为数据库主键时，影响数据库性能</li>
</ul>
<blockquote>
<h4 id="为什么UUID不建议作为MySQL数据库表的主键？"><a href="#为什么UUID不建议作为MySQL数据库表的主键？" class="headerlink" title="为什么UUID不建议作为MySQL数据库表的主键？"></a>为什么UUID不建议作为MySQL数据库表的主键？</h4><p>MySQL数据库InnoDB存储引擎使用了聚簇索引，底层使用B+树来存储数据，B+树的非叶子节点存储索引数据，叶子节点存储具体的行数据，每个节点的大小默认为<code>16KB</code>。<br>其中叶子节点内部的记录根据主键大小进行排序，叶子节点之间使用双向链表进行连接。</p>
<p>如果使用UUID作为主键，由于UUID是无序的，在进行插入操作的时候，存储引擎需要维护主键索引的顺序,一条新的记录插入进来，可能会被插入到之前已经存放满的叶子结点内，此时将会产生页分裂，带来性能损耗。<br>根据MySQL InnoDb存储引擎的聚簇索引的特性，建议主键选取为递增有序的字段。</p>
</blockquote>
<h2 id="2-2-基于数据库自增ID"><a href="#2-2-基于数据库自增ID" class="headerlink" title="2.2 基于数据库自增ID"></a>2.2 基于数据库自增ID</h2><p>通过关系型数据库自增主键产生唯一的ID，现在流行的商业数据库都支持自增主键的特性，比如MySQL等。</p>
<h3 id="优点-1"><a href="#优点-1" class="headerlink" title="优点"></a>优点</h3><ul>
<li>容易产生</li>
<li>ID单调递增</li>
<li>存储很小（int类型占用4个字节，bigint类型占用8个字节）</li>
</ul>
<h3 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h3><ul>
<li>依赖于数据库、而且需要处理单点问题，而且单点有性能瓶颈问题</li>
<li>每次生成一个ID都需要访问一次数据库</li>
</ul>
<blockquote>
<p>关于数据库单点风险的问题可以通过数据库集群模式去优化，部署多个数据库实例，每个实例均可产生Id，每个数据库实例设置不通过的起始值和自增步长。<br>这种方式虽可以解决点单点问题，但是不利于后续的扩容。</p>
</blockquote>
<h2 id="2-3-基于数据库的分段发号方案"><a href="#2-3-基于数据库的分段发号方案" class="headerlink" title="2.3 基于数据库的分段发号方案"></a>2.3 基于数据库的分段发号方案</h2><p>号段方案是当下分布式ID生成器的主流实现方式之一，分段方案使用数据库表来存储最大ID，每次获取一个范围段的ID，获取后更新数据库表，并将这一段ID加载到内从中，在内存中进行分配，内存中的ID号段使用完成后，再从数据库中获取。</p>
<h3 id="数据库表结构示例："><a href="#数据库表结构示例：" class="headerlink" title="数据库表结构示例："></a>数据库表结构示例：</h3><pre class="line-numbers language-none"><code class="language-none">CREATE TABLE id_generator (  &#96;id&#96; int(10) NOT NULL,  
&#96;max_id&#96; bigint(20) NOT NULL COMMENT &#39;当前最大id&#39;,  
&#96;step&#96; int(20) NOT NULL COMMENT &#39;号段的步长&#39;,  
&#96;biz_type&#96;    int(20) NOT NULL COMMENT &#39;业务类型&#39;,  
&#96;version&#96; int(20) NOT NULL COMMENT &#39;版本号&#39;,  
PRIMARY KEY (&#96;id&#96;)
)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>max_id ：当前最大的可用id</li>
<li>step ：代表号段的长度</li>
<li>biz_type ：代表不同业务类型</li>
<li>version ：是一个乐观锁，每次都更新version，保证并发时数据的正确性</li>
</ul>
<h3 id="优点-2"><a href="#优点-2" class="headerlink" title="优点"></a>优点</h3><ul>
<li>相对于数据库自增的Id，有效减轻了数据库压力</li>
</ul>
<h3 id="缺点-2"><a href="#缺点-2" class="headerlink" title="缺点"></a>缺点</h3><ul>
<li>依赖于数据库</li>
<li>每个节点产生的Id号段内递增</li>
</ul>
<h2 id="2-4-基于Redis的原子性递增"><a href="#2-4-基于Redis的原子性递增" class="headerlink" title="2.4 基于Redis的原子性递增"></a>2.4 基于Redis的原子性递增</h2><blockquote>
<h3 id="INCR-key"><a href="#INCR-key" class="headerlink" title="INCR key"></a>INCR key</h3><h4 id="Available-since-1-0-0"><a href="#Available-since-1-0-0" class="headerlink" title="Available since 1.0.0."></a>Available since 1.0.0.</h4></blockquote>
<blockquote>
<h4 id="Time-complexity-O-1"><a href="#Time-complexity-O-1" class="headerlink" title="Time complexity: O(1)"></a>Time complexity: O(1)</h4></blockquote>
<blockquote>
<p>Increments the number stored at key by one. If the key does not exist, it is set to 0 before performing the operation. An error is returned if the key contains a value of the wrong type or contains a string that can not be represented as integer. This operation is limited to 64 bit signed integers.</p>
</blockquote>
<blockquote>
<p>Note: this is a string operation because Redis does not have a dedicated integer type. The string stored at the key is interpreted as a base-10 64 bit signed integer to execute the operation.</p>
</blockquote>
<blockquote>
<p>Redis stores integers in their integer representation, so for string values that actually hold an integer, there is no overhead for storing the string representation of the integer.</p>
</blockquote>
<p>Redis提供了<code>incr</code>指令，该指令可以对key中存储的值进行<code>+1</code>操作（Redis不支持Integer类型，key中存储的string值将会被转为一个64位的有符号整数进行操作）。</p>
<h3 id="优点-3"><a href="#优点-3" class="headerlink" title="优点"></a>优点</h3><ul>
<li>实现简单</li>
<li>生成id效率高</li>
</ul>
<h3 id="缺点-3"><a href="#缺点-3" class="headerlink" title="缺点"></a>缺点</h3><ul>
<li>强依赖于数据库</li>
<li>需要考虑Redis持久化的问题</li>
</ul>
<h2 id="2-5-基于雪花算法（Snowflake）"><a href="#2-5-基于雪花算法（Snowflake）" class="headerlink" title="2.5 基于雪花算法（Snowflake）"></a>2.5 基于雪花算法（Snowflake）</h2><p>snowflake是Twitter开源的分布式ID生成算法，生成的结果是一个Long类型的ID。</p>
<p>snowflake使用64bit来生成ID，由高位到低位成部分如下：</p>
<ul>
<li>1bit作为保留位，没有使用，永远是0</li>
<li>41bit作为时间戳，表示从1970-01-01年以来的毫秒数</li>
<li>10bit作为机器ID（5bit是数据中心，5bit是机器ID）</li>
<li>12bit作为毫秒内的流水号，每毫秒可以生成4096个ID</li>
</ul>
<p>雪花算法每秒可以生成400万+的ID，由于高位41位使用了时间戳，所以各节点生成的ID都是大致有序的。</p>
<h3 id="优点-4"><a href="#优点-4" class="headerlink" title="优点"></a>优点</h3><ul>
<li>实现简单</li>
<li>不依赖其它组件</li>
<li>生成ID速度快</li>
</ul>
<h3 id="缺点-4"><a href="#缺点-4" class="headerlink" title="缺点"></a>缺点</h3><ul>
<li>生成的Id是趋势递增的（绝对递增会导致业务信息泄露）</li>
<li>依赖机器时间，需要处理时钟回拨的问题</li>
</ul>
<h2 id="2-6-百度-UidGenerator"><a href="#2-6-百度-UidGenerator" class="headerlink" title="2.6 百度(UidGenerator)"></a>2.6 百度(UidGenerator)</h2><p>UidGenerator是Java实现的, 基于Snowflake算法的唯一ID生成器。UidGenerator以组件形式工作在应用项目中, 支持自定义workerId位数和初始化策略, 从而适用于docker等虚拟化环境下实例自动重启、漂移等场景。 在实现上, UidGenerator通过借用未来时间来解决sequence天然存在的并发限制; 采用RingBuffer来缓存已生成的UID, 并行化UID的生产和消费, 同时对CacheLine补齐，避免了由RingBuffer带来的硬件级「伪共享」问题. 最终单机QPS可达600万。</p>
<p>依赖版本：Java8及以上版本, MySQL(内置WorkerID分配器, 启动阶段通过DB进行分配; 如自定义实现, 则DB非必选依赖）</p>
<table>
<thead>
<tr>
<th>sign</th>
<th>delta seconds</th>
<th>worker node id</th>
<th>sequence</th>
</tr>
</thead>
<tbody><tr>
<td>1bit</td>
<td>28bits</td>
<td>22bits</td>
<td>13bits</td>
</tr>
</tbody></table>
<p>Snowflake算法描述：指定机器 &amp; 同一时刻 &amp; 某一并发序列，是唯一的。据此可生成一个64 bits的唯一ID（long）。默认采用上图字节分配方式：</p>
<ul>
<li>sign(1bit)<br>固定1bit符号标识，即生成的UID为正数。</li>
<li>delta seconds (28 bits)<br>当前时间，相对于时间基点”2016-05-20”的增量值，单位：秒，最多可支持约8.7年</li>
<li>worker id (22 bits)<br>机器id，最多可支持约420w次机器启动。内置实现为在启动时由数据库分配，默认分配策略为用后即弃，后续可提供复用策略。</li>
<li>sequence (13 bits)<br>每秒下的并发序列，13 bits可支持每秒8192个并发。<br>以上参数均可通过Spring进行自定义。</li>
</ul>
<h3 id="优点-5"><a href="#优点-5" class="headerlink" title="优点"></a>优点</h3><ul>
<li>可以根据业务调整<code>delta seconds</code>、<code>worker id</code>、<code>sequence</code>的长度</li>
</ul>
<h3 id="缺点-5"><a href="#缺点-5" class="headerlink" title="缺点"></a>缺点</h3><ul>
<li>依赖于数据库表</li>
</ul>
<p><a href="https://github.com/baidu/uid-generator/blob/master/README.zh_cn.md">UidGenerator</a></p>
<h2 id="2-7-美团-Leaf"><a href="#2-7-美团-Leaf" class="headerlink" title="2.7 美团(Leaf)"></a>2.7 美团(Leaf)</h2><p>Leaf这个名字是来自德国哲学家、数学家莱布尼茨的一句话： &gt;There are no two identical leaves in the world &gt; “世界上没有两片相同的树叶”</p>
<h3 id="Leaf-segment数据库方案"><a href="#Leaf-segment数据库方案" class="headerlink" title="Leaf-segment数据库方案"></a>Leaf-segment数据库方案</h3><p>第一种Leaf-segment方案，在使用数据库的方案上，做了如下改变： - 原方案每次获取ID都得读写一次数据库，造成数据库压力大。改为利用proxy server批量获取，每次获取一个segment(step决定大小)号段的值。用完之后再去数据库获取新的号段，可以大大的减轻数据库的压力。</p>
<h3 id="Leaf-snowflake方案"><a href="#Leaf-snowflake方案" class="headerlink" title="Leaf-snowflake方案"></a>Leaf-snowflake方案</h3><p>Leaf-segment方案可以生成趋势递增的ID，同时ID号是可计算的，不适用于订单ID生成场景，比如竞对在两天中午12点分别下单，通过订单id号相减就能大致计算出公司一天的订单量，这个是不能忍受的。面对这一问题，我们提供了 Leaf-snowflake方案。<br>Leaf-snowflake方案完全沿用snowflake方案的bit位设计，即是“1+41+10+12”的方式组装ID号。对于workerID的分配，当服务集群数量较小的情况下，完全可以手动配置。Leaf服务规模较大，动手配置成本太高。所以使用Zookeeper持久顺序节点的特性自动对snowflake节点配置wokerID。Leaf-snowflake是按照下面几个步骤启动的：</p>
<ul>
<li>启动Leaf-snowflake服务，连接Zookeeper，在leaf_forever父节点下检查自己是否已经注册过（是否有该顺序子节点）。</li>
<li>如果有注册过直接取回自己的workerID（zk顺序节点生成的int类型ID号），启动服务。</li>
<li>如果没有注册过，就在该父节点下面创建一个持久顺序节点，创建成功后取回顺序号当做自己的workerID号，启动服务。</li>
</ul>
<p><a href="https://tech.meituan.com/2017/04/21/mt-leaf.html">Leaf——美团点评分布式ID生成系统</a></p>
<h1 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h1><p>上面介绍了6种分布式ID生成方案：</p>
<ul>
<li>UUID</li>
<li>基于数据库自增ID</li>
<li>基于数据库的分段发号方案</li>
<li>基于Redis的原子性递增</li>
<li>基于雪花算法（Snowflake）</li>
<li>百度(UidGenerator)</li>
<li>美团(Leaf)</li>
</ul>
<p>以上分布式ID生成方案又可以大致分为三类：</p>
<ul>
<li>UUID生成随机字符串，基本可以保证全局唯一，这类方法生成的ID占用空间较大（16字节）,而且生成的ID无序。</li>
<li>基于数据库生成的单调递增的ID，需要解决单点及性能问题，而且可能会导致业务数据泄露。<br>比如：通过订单ID推测出业务系统每天的订单量</li>
<li>snowflake算法类，对ID进行分段，分段表示时间、机器节点、序列号等，此类算法中由于包含时间段，所以需要考虑时钟回拨的问题。</li>
</ul>
<blockquote>
<h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p><a href="https://colobu.com/2020/02/21/ID-generator/">分布式ID生成方案</a></p>
<p><a href="https://juejin.cn/post/6854573222290161672">9种分布式ID生成方式，总有一款适合你</a></p>
</blockquote>
]]></content>
      <categories>
        <category>分布式</category>
      </categories>
      <tags>
        <tag>分布式ID</tag>
      </tags>
  </entry>
  <entry>
    <title>雪花算法源码分析及实践</title>
    <url>/2022/01/18/distributed/xue-hua-suan-fa-yuan-ma-fen-xi-ji-shi-jian/</url>
    <content><![CDATA[<h1 id="一、雪花算法简介"><a href="#一、雪花算法简介" class="headerlink" title="一、雪花算法简介"></a>一、雪花算法简介</h1><p>雪花算法（Snowflake）是一种生成分布式全局唯一ID的算法，这种算法由Twitter创建并开源。</p>
<p>雪花算法由64位的二进制组成，刚好可以用一个Long类型存储，一共包含四个部分：</p>
<table>
<thead>
<tr>
<th>符号</th>
<th>时间戳</th>
<th>数据中心和机器ID</th>
<th>序列号</th>
</tr>
</thead>
<tbody><tr>
<td>1 bit</td>
<td>41 bits</td>
<td>10 bits</td>
<td>12 bits</td>
</tr>
</tbody></table>
<ul>
<li>1位是符号位，没有被使用，始终是0</li>
<li>41位是时间戳，具体到毫秒，表示现在至1970年以来的毫秒数，最多可用69年</li>
<li>10位是数据中心和机器ID，10位最多可以表示1024台机器</li>
<li>12位是序列号，表示毫秒内生成的序列号，每毫秒最多可生成4096个ID</li>
</ul>
<h1 id="二、雪花算法源码-java"><a href="#二、雪花算法源码-java" class="headerlink" title="二、雪花算法源码(java)"></a>二、雪花算法源码(java)</h1><blockquote>
<p>雪花算法Java版本源码来自<code>beyondfengyu</code>的github：<a href="https://github.com/beyondfengyu/SnowFlake/blob/master/SnowFlake.java">Snowflake</a></p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;**
 * twitter的snowflake算法 -- java实现
 * 
 * @author beyond
 * @date 2016&#x2F;11&#x2F;26
 *&#x2F;
public class SnowFlake &#123;

    &#x2F;**
     * 起始的时间戳
     *&#x2F;
    private final static long START_STMP &#x3D; 1480166465631L;

    &#x2F;**
     * 每一部分占用的位数
     *&#x2F;
    private final static long SEQUENCE_BIT &#x3D; 12; &#x2F;&#x2F;序列号占用的位数
    private final static long MACHINE_BIT &#x3D; 5;   &#x2F;&#x2F;机器标识占用的位数
    private final static long DATACENTER_BIT &#x3D; 5;&#x2F;&#x2F;数据中心占用的位数

    &#x2F;**
     * 每一部分的最大值
     * 二进制位运算过程如下：
     * 负数的二进制用补码（整数的二进制位取反后加一）表示，-1的补码的二进制位全部为1，进行&#96;&lt;&lt;&#96;左移运算后低位补0，高位全部都是1
     * 再与-1进行&#96;^&#96;异或运算（这里可以替换为&#96;~&#96;取反运算），则高位全部变为0，低位变为1
     *&#x2F;
    private final static long MAX_DATACENTER_NUM &#x3D; -1L ^ (-1L &lt;&lt; DATACENTER_BIT);
    private final static long MAX_MACHINE_NUM &#x3D; -1L ^ (-1L &lt;&lt; MACHINE_BIT);
    private final static long MAX_SEQUENCE &#x3D; -1L ^ (-1L &lt;&lt; SEQUENCE_BIT);

    &#x2F;**
     * 每一部分向左的位移
     *&#x2F;
    private final static long MACHINE_LEFT &#x3D; SEQUENCE_BIT;
    private final static long DATACENTER_LEFT &#x3D; SEQUENCE_BIT + MACHINE_BIT;
    private final static long TIMESTMP_LEFT &#x3D; DATACENTER_LEFT + DATACENTER_BIT;

    private long datacenterId;  &#x2F;&#x2F;数据中心
    private long machineId;     &#x2F;&#x2F;机器标识
    private long sequence &#x3D; 0L; &#x2F;&#x2F;序列号
    private long lastStmp &#x3D; -1L;&#x2F;&#x2F;上一次时间戳

    public SnowFlake(long datacenterId, long machineId) &#123;
        if (datacenterId &gt; MAX_DATACENTER_NUM || datacenterId &lt; 0) &#123;
            throw new IllegalArgumentException(&quot;datacenterId can&#39;t be greater than MAX_DATACENTER_NUM or less than 0&quot;);
        &#125;
        if (machineId &gt; MAX_MACHINE_NUM || machineId &lt; 0) &#123;
            throw new IllegalArgumentException(&quot;machineId can&#39;t be greater than MAX_MACHINE_NUM or less than 0&quot;);
        &#125;
        this.datacenterId &#x3D; datacenterId;
        this.machineId &#x3D; machineId;
    &#125;

    &#x2F;**
     * 产生下一个ID
     *
     * @return
     *&#x2F;
    public synchronized long nextId() &#123;
        long currStmp &#x3D; getNewstmp();
        if (currStmp &lt; lastStmp) &#123;
            throw new RuntimeException(&quot;Clock moved backwards.  Refusing to generate id&quot;);
        &#125;

        if (currStmp &#x3D;&#x3D; lastStmp) &#123;
            &#x2F;&#x2F;相同毫秒内，序列号自增
            sequence &#x3D; (sequence + 1) &amp; MAX_SEQUENCE;
            &#x2F;&#x2F;同一毫秒的序列数已经达到最大
            if (sequence &#x3D;&#x3D; 0L) &#123;
                currStmp &#x3D; getNextMill();
            &#125;
        &#125; else &#123;
            &#x2F;&#x2F;不同毫秒内，序列号置为0
            sequence &#x3D; 0L;
        &#125;

        lastStmp &#x3D; currStmp;

        return (currStmp - START_STMP) &lt;&lt; TIMESTMP_LEFT &#x2F;&#x2F;时间戳部分
                | datacenterId &lt;&lt; DATACENTER_LEFT       &#x2F;&#x2F;数据中心部分
                | machineId &lt;&lt; MACHINE_LEFT             &#x2F;&#x2F;机器标识部分
                | sequence;                             &#x2F;&#x2F;序列号部分
    &#125;

    private long getNextMill() &#123;
        long mill &#x3D; getNewstmp();
        while (mill &lt;&#x3D; lastStmp) &#123;
            mill &#x3D; getNewstmp();
        &#125;
        return mill;
    &#125;

    private long getNewstmp() &#123;
        return System.currentTimeMillis();
    &#125;

    public static void main(String[] args) &#123;
        SnowFlake snowFlake &#x3D; new SnowFlake(2, 3);

        for (int i &#x3D; 0; i &lt; (1 &lt;&lt; 12); i++) &#123;
            System.out.println(snowFlake.nextId());
        &#125;

    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上述代码中有两个关键的步骤:</p>
<ul>
<li>获取ID时，如果在同一毫秒内，则在序列号上递增</li>
<li>如果同一毫秒内的序列号已经递增到最大值<code>4095</code>，则通过循坏阻塞直到下一毫秒到来</li>
</ul>
<p>所以雪花算法每毫秒最多可生成4096个ID，每秒最多可生成400万+的ID。</p>
<h1 id="三、时钟回拨"><a href="#三、时钟回拨" class="headerlink" title="三、时钟回拨"></a>三、时钟回拨</h1><p>从上述雪花算法的组成及源码可以看出，雪花算法是强依赖于机器时间的，如果机器发生了时钟回拨，则就会产生重复ID，所以必须解决时钟回拨的问题，防止影响业务。</p>
<h2 id="3-1-解决方案"><a href="#3-1-解决方案" class="headerlink" title="3.1 解决方案"></a>3.1 解决方案</h2><h3 id="时钟回拨后不生成ID，循环等待时间点到达"><a href="#时钟回拨后不生成ID，循环等待时间点到达" class="headerlink" title="时钟回拨后不生成ID，循环等待时间点到达"></a>时钟回拨后不生成ID，循环等待时间点到达</h3><ul>
<li>优点：实现简单，适合时间较小的时钟回拨</li>
<li>缺点：回拨时间间隔较大时，会造成业务阻塞</li>
</ul>
<h3 id="使用LRU缓存近一段时间内每毫秒内的最大序列号"><a href="#使用LRU缓存近一段时间内每毫秒内的最大序列号" class="headerlink" title="使用LRU缓存近一段时间内每毫秒内的最大序列号"></a>使用LRU缓存近一段时间内每毫秒内的最大序列号</h3><p>使用LRU缓存近一段时间内每一毫秒的最大序列号，如果发生时钟回拨，则从最大序列号继续递增，适合小范围内时钟回拨</p>
<ul>
<li>优点：实现简单，适合小范围时间回拨</li>
<li>缺点：当回拨时间较长时，需要缓存数据量太大</li>
</ul>
<h3 id="设置备用的数据中心"><a href="#设置备用的数据中心" class="headerlink" title="设置备用的数据中心"></a>设置备用的数据中心</h3><p>为每个节点预留一个备用的配置中心ID，当出现时钟回拨时，切换到备用的数据中心生成ID，时钟到达正常时间切换回原来的数据中心ID。</p>
<ul>
<li>优点：实现简单，适合任意范围内的时钟回拨</li>
<li>缺点： 需要占用掉一部分数据中心ID作为备用</li>
</ul>
<p>以上几种方式都没有考虑服务宕机重启后的时钟回拨问题，这个问题可以通过在启动时进行最大ID校验时间戳进行解决。</p>
<h1 id="四、百度UIDGenerator"><a href="#四、百度UIDGenerator" class="headerlink" title="四、百度UIDGenerator"></a>四、百度UIDGenerator</h1><h2 id="4-1-百度UIDGenerator"><a href="#4-1-百度UIDGenerator" class="headerlink" title="4.1 百度UIDGenerator"></a><a href="https://github.com/baidu/uid-generator/blob/master/README.zh_cn.md">4.1 百度UIDGenerator</a></h2><p>UidGenerator是Java实现的, 基于Snowflake算法的唯一ID生成器。UidGenerator以组件形式工作在应用项目中, 支持自定义workerId位数和初始化策略, 从而适用于docker等虚拟化环境下实例自动重启、漂移等场景。</p>
<p>依赖于数据库（UidGenerator以组件形式工作，内置WorkerID分配器, 启动阶段通过DB进行分配; 如自定义实现, 则DB非必选依赖）</p>
<h2 id="4-2-DefaultUidGenerator"><a href="#4-2-DefaultUidGenerator" class="headerlink" title="4.2 DefaultUidGenerator"></a>4.2 DefaultUidGenerator</h2><pre class="line-numbers language-none"><code class="language-none">&#x2F;** Bits allocate *&#x2F;
 protected int timeBits &#x3D; 28;
 protected int workerBits &#x3D; 22;
 protected int seqBits &#x3D; 13;

 &#x2F;** Customer epoch, unit as second. For example 2016-05-20 (ms: 1463673600000)*&#x2F;
 protected String epochStr &#x3D; &quot;2016-05-20&quot;;
 protected long epochSeconds &#x3D; TimeUnit.MILLISECONDS.toSeconds(1463673600000L);

 &#x2F;** Stable fields after spring bean initializing *&#x2F;
 protected BitsAllocator bitsAllocator;
 protected long workerId;

 &#x2F;** Volatile fields caused by nextId() *&#x2F;
 protected long sequence &#x3D; 0L;
 protected long lastSecond &#x3D; -1L;

 &#x2F;** Spring property *&#x2F;
 protected WorkerIdAssigner workerIdAssigner;
 
 &#x2F;**
  * Get UID
  *
  * @return UID
  * @throws UidGenerateException in the case: Clock moved backwards; Exceeds the max timestamp
  *&#x2F;
 protected synchronized long nextId() &#123;
     long currentSecond &#x3D; getCurrentSecond();

     &#x2F;&#x2F; Clock moved backwards, refuse to generate uid
     if (currentSecond &lt; lastSecond) &#123;
         long refusedSeconds &#x3D; lastSecond - currentSecond;
         throw new UidGenerateException(&quot;Clock moved backwards. Refusing for %d seconds&quot;, refusedSeconds);
     &#125;

     &#x2F;&#x2F; At the same second, increase sequence
     if (currentSecond &#x3D;&#x3D; lastSecond) &#123;
         sequence &#x3D; (sequence + 1) &amp; bitsAllocator.getMaxSequence();
         &#x2F;&#x2F; Exceed the max sequence, we wait the next second to generate uid
         if (sequence &#x3D;&#x3D; 0) &#123;
             currentSecond &#x3D; getNextSecond(lastSecond);
         &#125;

     &#x2F;&#x2F; At the different second, sequence restart from zero
     &#125; else &#123;
         sequence &#x3D; 0L;
     &#125;

     lastSecond &#x3D; currentSecond;

     &#x2F;&#x2F; Allocate bits for UID
     return bitsAllocator.allocate(currentSecond - epochSeconds, workerId, sequence);
 &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>DefaultUidGenerator相对于原生的雪花算法做了一些调整，允许对各段占用长度进行自定义</p>
<ul>
<li>时间戳占用的位数减少了，默认占28位,起始时间默认为<code>2016-05-20 (ms: 1463673600000)</code>，时间戳到秒级别</li>
<li>机器占用的位数增大了，默认占22位，最多允许420万次的启停（内置实现为在启动时由数据库分配，默认分配策略为用后即弃）</li>
<li>序列位增加了一位，默认占13位，可支持每秒8192个并发。</li>
</ul>
<blockquote>
<p>对于时钟回拨问题，DefaultUidGenerator粗暴的直接抛出异常。</p>
</blockquote>
<h2 id="4-3-CachedUidGenerator"><a href="#4-3-CachedUidGenerator" class="headerlink" title="4.3 CachedUidGenerator"></a>4.3 CachedUidGenerator</h2><p>这种方案和上面默认的方案不同之处在于预先生成UID，将生成的UID缓存在一个环形数组之中，定义了两个指针（tail、cursor）去控制UID的消费位置及生成的最大的UID的位置，端获取客户端获取UID时没有加锁，而是使用了CAS机制，其中提过了两种机制触发UID的生成：</p>
<ul>
<li>阈值机制：获取UID时，如果剩余可获取的UID小于设定的阈值，则通过线程池提交一个任务生成UID缓存到环形数组之中</li>
<li>定时机制：通过定时任务定时生成UID缓存到环形数组之中</li>
</ul>
<p>RingBuffer环形数组，数组每个元素成为一个slot。RingBuffer容量，默认为Snowflake算法中sequence最大值，且为2^N（sequence最大值 &lt;&lt; 3, 即sequence最大值的3倍）。可通过boostPower配置进行扩容，以提高RingBuffer 读写吞吐量。</p>
<p>CachedUidGenerator采用了双RingBuffer，Uid-RingBuffer用于存储Uid、Flag-RingBuffer用于存储Uid状态(是否可填充、是否可消费)</p>
<p>由于数组元素在内存中是连续分配的，可最大程度利用CPU cache以提升性能。但同时会带来「伪共享」FalseSharing问题，为此在Tail、Cursor指针、Flag-RingBuffer中采用了CacheLine 补齐方式。</p>
<p>Tail指针、Cursor指针用于环形数组上读写slot：</p>
<ul>
<li><p>Tail指针<br>表示Producer生产的最大序号(此序号从0开始，持续递增)。Tail不能超过Cursor，即生产者不能覆盖未消费的slot。当Tail已赶上curosr，此时可通过rejectedPutBufferHandler指定PutRejectPolicy</p>
</li>
<li><p>Cursor指针<br>表示Consumer消费到的最小序号(序号序列与Producer序列相同)。Cursor不能超过Tail，即不能消费未生产的slot。当Cursor已赶上tail，此时可通过rejectedTakeBufferHandler指定TakeRejectPolicy</p>
</li>
</ul>
<p>RingBuffer填充时机</p>
<ul>
<li><p>初始化预填充<br>RingBuffer初始化时，预先填充满整个RingBuffer.</p>
</li>
<li><p>即时填充<br>Take消费时，即时检查剩余可用slot量(tail - cursor)，如小于设定阈值，则补全空闲slots。阈值可通过paddingFactor来进行配置</p>
</li>
<li><p>周期填充<br>通过Schedule线程，定时补全空闲slots。可通过scheduleInterval配置，以应用定时填充功能，并指定Schedule时间间隔</p>
</li>
</ul>
<blockquote>
<p>上述描述中存在一个「伪共享」FalseSharing问题，为此在Tail、Cursor指针、Flag-RingBuffer中采用了CacheLine 补齐方式。</p>
</blockquote>
<h2 id="4-4-总结"><a href="#4-4-总结" class="headerlink" title="4.4 总结"></a>4.4 总结</h2><ul>
<li>较于原生的雪花算法减少了时间戳占用的长度，时间戳的长度调整到了22位，具体到秒级别，起始时间设置为了2016年。</li>
<li>增加了机器ID占用的长度，而且机器ID的分配使用了数据库自增的主键，允许单节点420万次的启动。</li>
<li>序列号的位数增大了1位，每秒最多可生成8192个UID。</li>
</ul>
<h3 id="DefaultUidGenerator方案："><a href="#DefaultUidGenerator方案：" class="headerlink" title="DefaultUidGenerator方案："></a>DefaultUidGenerator方案：</h3><ul>
<li>获取UID时要加锁（synchronized）</li>
<li>发生时钟回拨时，直接抛出异常。</li>
</ul>
<h3 id="CachedUidGenerator方案："><a href="#CachedUidGenerator方案：" class="headerlink" title="CachedUidGenerator方案："></a>CachedUidGenerator方案：</h3><ul>
<li>获取UID时不用加锁，使用了CAS</li>
<li>提前生成UID缓存到环形之中，通过阈值或定制机制预生成UID</li>
<li>生成UID时不依赖于时间戳，而是对<code>lastSecond</code>进行加一（这个值的初始值为系统启动时的时间戳）</li>
<li>获取的UID中的时间戳不准确</li>
</ul>
<blockquote>
<p>CachedUidGenerator方案没有依赖于时间戳，所以不会在运行时出现时钟回拨问题，而且对于同一秒内如果序列号增长到最大时，可以借用未来时间进行生成。</p>
</blockquote>
<h1 id="五、美团（Leaf）"><a href="#五、美团（Leaf）" class="headerlink" title="五、美团（Leaf）"></a>五、美团（Leaf）</h1><h2 id="5-1-Leaf：美团分布式ID生成服务开源"><a href="#5-1-Leaf：美团分布式ID生成服务开源" class="headerlink" title="5.1 Leaf：美团分布式ID生成服务开源"></a>5.1 <a href="https://tech.meituan.com/2019/03/07/open-source-project-leaf.html">Leaf：美团分布式ID生成服务开源</a></h2><p>Leaf是美团基础研发平台推出的一个分布式ID生成服务，名字取自德国哲学家、数学家莱布尼茨的一句话：“There are no two identical leaves in the world.”Leaf具备高可靠、低延迟、全局唯一等特点。目前已经广泛应用于美团金融、美团外卖、美团酒旅等多个部门。具体的技术细节，可参考此前美团技术博客的一篇文章：《Leaf美团分布式ID生成服务》。近日，Leaf项目已经在Github上开源：<a href="https://github.com/Meituan-Dianping/Leaf">https://github.com/Meituan-Dianping/Leaf</a> ，希望能和更多的技术同行一起交流、共建。</p>
<h3 id="Leaf的特性"><a href="#Leaf的特性" class="headerlink" title="Leaf的特性"></a>Leaf的特性</h3><p>Leaf在设计之初就秉承着几点要求：</p>
<ul>
<li>全局唯一，绝对不会出现重复的ID，且ID整体趋势递增。</li>
<li>高可用，服务完全基于分布式架构，即使MySQL宕机，也能容忍一段时间的数据库不可用。</li>
<li>高并发低延时，在CentOS 4C8G的虚拟机上，远程调用QPS可达5W+，TP99在1ms内。</li>
<li>接入简单，直接通过公司RPC服务或者HTTP调用即可接入。</li>
</ul>
<h2 id="5-2-号段模式"><a href="#5-2-号段模式" class="headerlink" title="5.2 号段模式"></a>5.2 号段模式</h2><p>依赖于数据库，使用了预分发的方式生成ID，在DB上挂N个Server, 每个Server启动的时候都会去DB拿固定长度的ID List，然后再基于内存进行分发，数据库中记录了当前最大的ID。</p>
<ul>
<li>使用双Buffer，异步获取号段</li>
<li>MySQL采用半同步方式同步数据</li>
</ul>
<h2 id="5-3-Leaf-Snowflake模式"><a href="#5-3-Leaf-Snowflake模式" class="headerlink" title="5.3 Leaf Snowflake模式"></a>5.3 Leaf Snowflake模式</h2><p>Leaf Snowflake模式提供了Snowflake的Java版本实现，使用了Zookeeper身体工程机器号，获取后会在本机文件系统化缓存一个workID文件。</p>
<h2 id="5-4-Leaf-总结"><a href="#5-4-Leaf-总结" class="headerlink" title="5.4 Leaf 总结"></a>5.4 Leaf 总结</h2><ul>
<li>号段模式：依赖于数据库，低位趋势增长，较少的ID号段浪费，能够容忍MySQL的短时间不可用。</li>
<li>Snowflake模式：完全分布式，ID有语义（没有解决时钟回拨的问题）。</li>
</ul>
<h1 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h1><p>目前来说，分布式ID生成方案总的来说可以分为3类：</p>
<ul>
<li>UUID这类依赖于硬件，生成无序的ID</li>
<li>依赖于数据库，可以实现单调递增和趋势递增</li>
<li>雪花算法类，依赖于时间戳，趋势递增，有时钟回拨问题</li>
</ul>
]]></content>
      <categories>
        <category>分布式</category>
      </categories>
      <tags>
        <tag>雪花算法</tag>
      </tags>
  </entry>
  <entry>
    <title>10万TPS级高并发系统——10万量级文本关键字匹配过滤</title>
    <url>/2024/06/22/high-concurrency/10-wan-tps-ji-gao-bing-fa-xi-tong-10-wan-liang-ji-wen-ben-guan-jian-zi-pi-pei-guo-lu/</url>
    <content><![CDATA[<h1 id="一、背景简介"><a href="#一、背景简介" class="headerlink" title="一、背景简介"></a>一、背景简介</h1><p><a href="https://www.mpoom.cn/2024/06/01/high-concurrency/10-wan-tps-ji-gao-bing-fa-xi-tong-jia-gou-she-ji-yu-xiang-mu-luo-di-shi-jian/">消息发送管控平台</a>中有个很重要的能力就是文本关键字检测，比如检测一段话中是否含有<code>法轮功</code>等敏感字段，这就涉及到关键字匹配算法。在该项目中每条消息都要经过关键词过滤，通过后才能下发。关键字匹配有两种形式，分为<code>单一关键字</code>和<code>逻辑关键字</code>。</p>
<h2 id="1-1-单一关键字"><a href="#1-1-单一关键字" class="headerlink" title="1.1 单一关键字"></a>1.1 单一关键字</h2><p>单一关键字指单个单词，如：<code>法轮功</code>，<code>炸金花</code>，<code>一条龙服务</code>等涉恐、涉赌、涉黄等关键字，单个的关键字在系统数据库中的数量在9万+，消息下发时需要检测文本中是否包含数据库中单个关键字。</p>
<h2 id="1-2-逻辑关键字"><a href="#1-2-逻辑关键字" class="headerlink" title="1.2 逻辑关键字"></a>1.2 逻辑关键字</h2><p>逻辑关键字由多个单一关键字组合<code>&amp;&amp;</code>、<code>||</code>、<code>!</code>逻辑运算符，即匹配到的关键字满足逻辑关键字中的逻辑运算逻辑才进行管控。<br><img src="/2024/06/22/high-concurrency/10-wan-tps-ji-gao-bing-fa-xi-tong-10-wan-liang-ji-wen-ben-guan-jian-zi-pi-pei-guo-lu/%E9%80%BB%E8%BE%91%E5%85%B3%E9%94%AE%E5%AD%97.png" alt="逻辑关键字"></p>
<div class="note success no-icon flat"><p>例如：逻辑关键字<code>点击&amp;&amp;登录&amp;&amp;!验证码</code>, 表示内容包含<code>点击</code>、<code>登录</code>关键字并且不包含<code>验证码</code>关键字，如果文本中包含的内容符合该逻辑，则进行拦截管控。</p>
</div>

<h1 id="二、性能要求"><a href="#二、性能要求" class="headerlink" title="二、性能要求"></a>二、性能要求</h1><p>消息发送管控平台关键字整体数据规模为10万量级，其中单一关键字数量为9万，逻辑关键字数量为1万。消息管控平台的安全审核接口整体的平均响应时间为<code>50ms</code>。</p>
<h1 id="三、方案预研"><a href="#三、方案预研" class="headerlink" title="三、方案预研"></a>三、方案预研</h1><p>我们先分析梳理常用的关键词匹配算法，再根据上述业务需求及平台性能要求，进行方案设计及落地实现。常用的关键词匹配算法有：暴力匹配算法、KMP算法、Boyer-Moore算法、双数组Trie、AC自动机、基于双数组Trie的AC自动机等。下面我们结合各个算法的优缺点、性能、及适用场景进行选择分析。</p>
<h2 id="3-1-算法对比分析"><a href="#3-1-算法对比分析" class="headerlink" title="3.1 算法对比分析"></a>3.1 算法对比分析</h2><p>各个算法原理相见:<a href>常见的关键字匹配算法</a></p>
<table>
<thead>
<tr>
<th>算法名称</th>
<th>适用场景</th>
<th>性能</th>
</tr>
</thead>
<tbody><tr>
<td>暴力匹配算法（Brute Force）</td>
<td>小规模数据或者模式串较短的简单匹配场景</td>
<td>在规模较小的情况下能够工作，但随着数据规模增大，性能迅速下降。</td>
</tr>
<tr>
<td>KMP算法（Knuth-Morris-Pratt算法）</td>
<td>需要处理长模式串或者大量数据的字符串匹配任务</td>
<td>对于大规模数据和长模式串有较好的性能表现，常用于实际应用中。</td>
</tr>
<tr>
<td>Boyer-Moore算法</td>
<td>处理长模式串和大规模数据，尤其适用于多次匹配的情况</td>
<td>在实际应用中，通常能提供较好的性能表现，特别是在模式串相对较长时</td>
</tr>
<tr>
<td>Trie树</td>
<td>需要快速存储和检索字符串集合的应用，如字典、自动完成、拼写检查等。</td>
<td>在处理字符串集合和前缀匹配任务时，能够提供稳定和高效的性能表现。</td>
</tr>
<tr>
<td>双数组Trie（Double-Array Trie，DAT）</td>
<td>需要高效存储和查询大规模字符串集合的场景，特别是需要频繁进行前缀匹配或者完全匹配的应用。</td>
<td>在大规模数据和长字符串的存储和查询中，双数组Trie能够显著提升性能，特别是在内存使用和查询速度上。</td>
</tr>
<tr>
<td>AC自动机（Aho-Corasick自动机</td>
<td>需要在大规模文本中同时匹配多个模式串的高效搜索应用场景，如关键字过滤、文本搜索引擎、网络安全等领域。</td>
<td>在处理多模式匹配问题时，AC自动机通常能够提供优秀的性能表现，特别是在模式串数量较多或文本规模较大时。</td>
</tr>
<tr>
<td>基于双数组Trie的AC自动机</td>
<td>需要在大规模文本中同时匹配多个模式串的高效搜索应用场景。</td>
<td>在处理多模式匹配问题时，基于双数组Trie的AC自动机通常能够提供优秀的性能表现，特别是在模式串较多或文本较大时。</td>
</tr>
</tbody></table>
<p>根据管控平台关键字管控的业务要求，关键字匹配算法需要支持两大特点：大规模数据、多模式串匹配，才能在单一关键字和逻辑关键字匹配上有较好的性能表现，根据上述算法的特点及性能，基于双数组Trie的AC自动机算法符合我们的业务需求。</p>
<h2 id="3-2-基于双数组Trie的AC自动机"><a href="#3-2-基于双数组Trie的AC自动机" class="headerlink" title="3.2 基于双数组Trie的AC自动机"></a>3.2 基于双数组Trie的AC自动机</h2><div class="note success no-icon flat"><p>预备知识的图解请参考：《<a href="https://www.hankcs.com/program/algorithm/implementation-and-analysis-of-aho-corasick-algorithm-in-java.html">Aho-Corasick算法的Java实现与分析</a>》《<a href="https://www.hankcs.com/program/java/triedoublearraytriejava.html">双数组Trie树(DoubleArrayTrie)Java实现</a>》。</p>
<p>基于双数组Trie的AC自动机的实现参考：《<a href="https://www.hankcs.com/program/algorithm/aho-corasick-double-array-trie.html">Aho Corasick自动机结合DoubleArrayTrie极速多模式匹配</a>》</p>
</div>

<h1 id="四、方案设计"><a href="#四、方案设计" class="headerlink" title="四、方案设计"></a>四、方案设计</h1><p>根据业务要求我们需要实现消息内容的<code>单一关键字</code>和<code>逻辑关键字</code>的匹配，下面为关键字匹配算法代码实现及使用示例。</p>
<h2 id="4-1-单一关键字匹配"><a href="#4-1-单一关键字匹配" class="headerlink" title="4.1 单一关键字匹配"></a>4.1 单一关键字匹配</h2><p>单一关键字匹配可以直接使用AhoCorasickDoubleArrayTrie实现，算法如下：</p>
<h3 id="4-1-1-引入Maven依赖"><a href="#4-1-1-引入Maven依赖" class="headerlink" title="4.1.1 引入Maven依赖"></a>4.1.1 引入Maven依赖</h3><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.hankcs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>aho-corasick-double-array-trie<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.2.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="4-1-2-封装AhoCorasickDoubleArrayTrie"><a href="#4-1-2-封装AhoCorasickDoubleArrayTrie" class="headerlink" title="4.1.2 封装AhoCorasickDoubleArrayTrie"></a>4.1.2 封装AhoCorasickDoubleArrayTrie</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * AhoCorasickDoubleArrayTrie 算法包装类
 */</span>
<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">AhoCorasickEntry</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">AhoCorasickDoubleArrayTrie</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> trie <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AhoCorasickDoubleArrayTrie</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">addKeyword</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyword<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>keyword<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>keyword<span class="token punctuation">,</span> keyword<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        trie<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AhoCorasickDoubleArrayTrie<span class="token punctuation">.</span>Hit</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">parseText</span><span class="token punctuation">(</span><span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> trie<span class="token punctuation">.</span><span class="token function">parseText</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-1-3-初始化及使用AhoCorasickDoubleArrayTrie"><a href="#4-1-3-初始化及使用AhoCorasickDoubleArrayTrie" class="headerlink" title="4.1.3 初始化及使用AhoCorasickDoubleArrayTrie"></a>4.1.3 初始化及使用AhoCorasickDoubleArrayTrie</h3><p>下面是一个基于AhoCorasickDoubleArrayTrie的初始化及使用案例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KeywordHandler</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">AhoCorasickEntry</span> ahoCorasickEntry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AhoCorasickEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 初始化AhoCorasickDoubleArrayTrie
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initAhoCorasickEntry</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> keywordList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        keywordList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>keyword <span class="token operator">-></span> ahoCorasickEntry<span class="token punctuation">.</span><span class="token function">addKeyword</span><span class="token punctuation">(</span>keyword<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ahoCorasickEntry<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 获取消息内容中匹配到的关键字集合
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getMatchedKeywordSet</span><span class="token punctuation">(</span><span class="token class-name">String</span> msgContent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AhoCorasickDoubleArrayTrie<span class="token punctuation">.</span>Hit</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> wordList <span class="token operator">=</span> ahoCorasickEntry<span class="token punctuation">.</span><span class="token function">parseText</span><span class="token punctuation">(</span>msgContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>wordList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> wordList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>hit <span class="token operator">-></span> hit<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-2-逻辑关键字匹配"><a href="#4-2-逻辑关键字匹配" class="headerlink" title="4.2 逻辑关键字匹配"></a>4.2 逻辑关键字匹配</h2><p>逻辑关键字的匹配包括两个步骤：第一步匹配逻辑关键字中每个单一关键字，第二部根据第一步匹配到结果再进行逻辑运算。关键字的逻辑运算我们使用开源的高性能表达式引擎AviatorScript。</p>
<h3 id="4-2-1-AviatorScript简介"><a href="#4-2-1-AviatorScript简介" class="headerlink" title="4.2.1 AviatorScript简介"></a>4.2.1 AviatorScript简介</h3><p><a href="https://github.com/killme2008/aviatorscript">AviatorScript</a> 是一门高性能、轻量级寄宿于 JVM （包括 Android 平台）之上的脚本语言。</p>
<div class="note success no-icon flat"><p>Aviator 的基本过程是将表达式直接翻译成对应的 java 字节码执行，特点：</p>
<ul>
<li>高性能</li>
<li>轻量级</li>
<li>一些比较有特色的特点：<ul>
<li>支持运算符重载</li>
<li>原生支持大整数和 BigDecimal 类型及运算，并且通过运算符重载和一般数字类型保持一致的运算方式。</li>
<li>原生支持正则表达式类型及匹配运算符 &#x3D;~ </li>
<li>类 clojure 的 seq 库及 lambda 支持，可以灵活地处理各种集合</li>
</ul>
</li>
<li>开放能力：包括自定义函数接入以及各种定制选项</li>
</ul>
</div>

<h3 id="4-2-2-引入AviatorScript依赖"><a href="#4-2-2-引入AviatorScript依赖" class="headerlink" title="4.2.2 引入AviatorScript依赖"></a>4.2.2 引入AviatorScript依赖</h3><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.googlecode.aviator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>aviator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>&#123;version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-2-3-逻辑关键字匹配实现"><a href="#4-2-3-逻辑关键字匹配实现" class="headerlink" title="4.2.3 逻辑关键字匹配实现"></a>4.2.3 逻辑关键字匹配实现</h3><p>前面讲到逻辑关键字的匹配分为两个步骤，第一步先是根据逻辑运算符将逻辑关键字拆分为单一关键字，将所有的拆分后的逻辑关键字构建一个AhoCorasickDoubleArrayTrie进行关键字匹配。</p>
<div class="note success no-icon flat"><p>基于AhoCorasickDoubleArrayTrie关键匹配代码实现参见上面<code>单一关键字匹配</code>，匹配成功后会返回匹配到的关键字集合<code>matchedKeywordSet</code>，然后进行逻辑关键字的逻辑运算。</p>
</div>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ComplexKeyword</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * 逻辑关键字
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> expression<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 编译后的逻辑关键字
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Expression</span> compiledExpression<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> keywordList<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ComplexKeyword</span><span class="token punctuation">(</span><span class="token class-name">String</span> expression<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>expression <span class="token operator">=</span> expression<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>compiledExpression <span class="token operator">=</span> <span class="token class-name">AviatorEvaluator</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>expression<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 逻辑关键字表达式拆词</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keywords <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>expression<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"[| &amp; ( ) !]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keywordList <span class="token operator">=</span> <span class="token function">filterBlankAndSort</span><span class="token punctuation">(</span>keywords<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">filterBlankAndSort</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keywords<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> keywordSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>keywords<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keywordSet<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> keyList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>keywordSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        keyList<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span>keyword1<span class="token punctuation">,</span> keyword2<span class="token punctuation">)</span> <span class="token operator">-></span> keyword2<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> keyword1<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> keyList<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 获取逻辑关键字运算参数Map
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token function">getEnvMap</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> matchedKeywordSet<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> keywordList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span>
                        keyword <span class="token operator">-></span> keyword<span class="token punctuation">,</span>
                        matchedKeywordSet<span class="token operator">::</span><span class="token function">contains</span><span class="token punctuation">,</span>
                        <span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">)</span> <span class="token operator">-></span> right
                <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getTargetExpression</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> matchedKeywordSet<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> env <span class="token operator">=</span> keywordList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span>
                        keyword <span class="token operator">-></span> keyword<span class="token punctuation">,</span>
                        keyword <span class="token operator">-></span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>matchedKeywordSet<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>keyword<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">)</span> <span class="token operator">-></span> right
                <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 排序后的keywordList，目的是在替换时先替换长度较大的关键字，避免相同前缀的短关键字被先替换</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> keywordList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            expression <span class="token operator">=</span> expression<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> env<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> expression<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 执行逻辑关键字表达式运算
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> matchedKeywordSet<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 优先使用预编译的表达式传入参数进行逻辑运算（性能高）</span>
            <span class="token keyword">return</span> compiledExpression<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token function">getEnvMap</span><span class="token punctuation">(</span>matchedKeywordSet<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 表达式执行失败，则根据关键字匹配结果获取匹配结果的表达式（性能低于预编译）</span>
            <span class="token keyword">return</span> <span class="token class-name">AviatorEvaluator</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token function">getTargetExpression</span><span class="token punctuation">(</span>matchedKeywordSet<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> expression<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>下面为遍历逻辑关键字列表，检测是否有匹配的逻辑关键字：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">matchComplexKeyword</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ComplexKeyword</span><span class="token punctuation">></span></span> complexKeywords<span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> matchedKeywordSet<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>complexKeywords<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    complexKeywords<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>complexKeyword <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>complexKeyword<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>matchedKeywordSet<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> complexKeyword<span class="token punctuation">.</span><span class="token function">getExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-3-性能验证"><a href="#4-3-性能验证" class="headerlink" title="4.3 性能验证"></a>4.3 性能验证</h2><p>下面结合实际业务场景的数据量测试单一关键字和逻辑关键字匹配中两个核心处理步骤<code>AhoCorasickDoubleArrayTrie</code>和<code>AviatorScript</code>的性能表现。</p>
<h3 id="4-3-1-AhoCorasickDoubleArrayTrie性能测试"><a href="#4-3-1-AhoCorasickDoubleArrayTrie性能测试" class="headerlink" title="4.3.1 AhoCorasickDoubleArrayTrie性能测试"></a>4.3.1 AhoCorasickDoubleArrayTrie性能测试</h3><div class="note success no-icon flat"><p>使用AhoCorasickDoubleArrayTrie项目源码中的<a href="https://github.com/hankcs/AhoCorasickDoubleArrayTrie/blob/master/src/test/resources/cn/dictionary.txt">dictionary.txt</a>文件作为关键字库，该文件内容为单词，总行数有15万+。</p>
</div>

<p>选取10个消息模板进行测试,消息模板内容如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">【xx商场】亲爱的会员，你好！國庆节马上到来，针对新老用户我们特推出<span class="token number">5.5</span>折优惠活动，只要到场凭会员卡可领取精美小礼物一件，数量有限先到先得！退订回<span class="token class-name">T</span>
【xx教育】高一升高二暑期补习班开课了，开设数学、物理、化学、英语等四科。开课时间<span class="token number">7</span>月<span class="token number">15</span>日。地点：xx<span class="token punctuation">.</span>有意咨询或回复短信，汪老师：xx 退订回<span class="token class-name">T</span>
一个节日思念无数，一条短信祝福万千。端午节到了，祝你节日安康，同时祝你健健康康地，快安康乐地，和和美美地，顺顺利利地过好生命中的每一天。
xx大药房】积分当钱花，好礼送不停<span class="token operator">!</span>xx药店年中大促暨积分兑换开始啦<span class="token operator">!</span>丰富礼品等你来。<span class="token number">24</span><span class="token operator">-</span><span class="token number">31</span>日进店销费送xx、xx、xx等。钙片仅<span class="token number">1</span>元<span class="token operator">!</span>退订回<span class="token class-name">T</span>
【xx】您好，xx经理打扰您！邀约您参与xx举办的xx展会，相信通过此次展会您能够收获到更多的商业朋友，为自己的企业创造更多的新机遇！ x月x日是参展日，望届时与会参观交流，期待您的光临！咨询电话：xx，退订回<span class="token class-name">T</span>
【xx游泳馆】绿道，全家的选择。带上家里的小朋友一起体验不一样的水世界<span class="token operator">!</span>地址：xx<span class="token punctuation">,</span>电话xx<span class="token punctuation">.</span>退订回<span class="token class-name">T</span>
【xx银行】鉴于您信誉良好，诚邀您办理<span class="token number">2</span>万元信用卡，点击即可办理https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>xx，退订回<span class="token constant">TD</span>
【xx装饰】尊敬的xx先生您好！首先感谢您相信xx装饰！希望我们的设计师能给您带来关于装修想要设计方案，有其他咨询可随时联系xx。祝您生活愉快！
【xx管理局】紧急通知：因近日有大到暴雨，造成降雨量较大，现在应因地制宜排水晾田，尤其是低洼地块更应及时排水，防止倒灌发生，希望引起重视。
【xx市】尊敬的市民朋友们，<span class="token number">2020</span>年春节即将到来<span class="token punctuation">,</span>让我们众志成城，严守禁放新规维护城市环境、为了美好生活！祝您节日快乐阖家幸福万事如意！<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试代码如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AhoCorasickDoubleArrayTrieTest</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">KeywordHandler</span> keywordHandler <span class="token operator">=</span> <span class="token function">getKeywordHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> contents <span class="token operator">=</span> <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">readAllLines</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"content.txt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        contents<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>content <span class="token operator">-></span>  <span class="token function">matchKeyword</span><span class="token punctuation">(</span>keywordHandler<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> times <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"总耗时:"</span> <span class="token operator">+</span> times <span class="token operator">+</span> <span class="token string">"，平均耗时："</span> <span class="token operator">+</span> times <span class="token operator">/</span> contents<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"ms"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">matchKeyword</span><span class="token punctuation">(</span><span class="token class-name">KeywordHandler</span> keywordHandler<span class="token punctuation">,</span> <span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> matchedKeywordSet <span class="token operator">=</span> keywordHandler<span class="token punctuation">.</span><span class="token function">getMatchedKeywordSet</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"单条文本关键字匹配耗时："</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"ms"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// matchedKeywordSet.forEach(System.out::println);</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">KeywordHandler</span> <span class="token function">getKeywordHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">KeywordHandler</span> keywordHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KeywordHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 文件路径：https://github.com/hankcs/AhoCorasickDoubleArrayTrie/blob/master/src/test/resources/cn/dictionary.txt</span>
        keywordHandler<span class="token punctuation">.</span><span class="token function">initAhoCorasickEntry</span><span class="token punctuation">(</span><span class="token function">getKeywordListForTest</span><span class="token punctuation">(</span><span class="token string">"dictionary.txt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> keywordHandler<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 读取本地字典文件作为关键字，文件有15万行
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getKeywordListForTest</span><span class="token punctuation">(</span><span class="token class-name">String</span> filePath<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Path</span> path <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">readAllLines</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行结果如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">单条文本关键字匹配耗时：<span class="token number">6</span>ms
单条文本关键字匹配耗时：<span class="token number">1</span>ms
单条文本关键字匹配耗时：<span class="token number">0</span>ms
单条文本关键字匹配耗时：<span class="token number">0</span>ms
单条文本关键字匹配耗时：<span class="token number">0</span>ms
单条文本关键字匹配耗时：<span class="token number">0</span>ms
单条文本关键字匹配耗时：<span class="token number">0</span>ms
单条文本关键字匹配耗时：<span class="token number">0</span>ms
单条文本关键字匹配耗时：<span class="token number">0</span>ms
单条文本关键字匹配耗时：<span class="token number">0</span>ms
总耗时<span class="token operator">:</span><span class="token number">8</span>，平均耗时：<span class="token number">0</span>ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>根据测试结果来看，在15万级的关键字匹配中，消息内容关键字匹配耗时仅在初次耗时较高，整体的平均耗时小于1ms, 该性能满足系统接口整体性能要求。</p>
<h3 id="4-3-2-AviatorScript性能测试"><a href="#4-3-2-AviatorScript性能测试" class="headerlink" title="4.3.2 AviatorScript性能测试"></a>4.3.2 AviatorScript性能测试</h3><div class="note success no-icon flat"><p>逻辑关键字匹配性能主要测试AviatorScript对表达式结果运算的性能，我们使用<code>1万条</code>逻辑关键字，每个逻辑关键字至少包含<code>2个</code>逻辑运算符。</p>
</div>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AviatorScriptTest</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ComplexKeyword</span><span class="token punctuation">></span></span> compiledKeywords <span class="token operator">=</span> <span class="token function">buildComplexKeyword</span><span class="token punctuation">(</span><span class="token function">getComplexKeywords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> matchedKeywordSet <span class="token operator">=</span> <span class="token function">getMatchedKeywordSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">matchComplexKeywords</span><span class="token punctuation">(</span>compiledKeywords<span class="token punctuation">,</span> matchedKeywordSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">long</span> times <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"总耗时:"</span> <span class="token operator">+</span> times <span class="token operator">+</span> <span class="token string">"ms, 平均耗时："</span> <span class="token operator">+</span> times <span class="token operator">/</span> count <span class="token operator">+</span> <span class="token string">"ms"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">matchComplexKeywords</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ComplexKeyword</span><span class="token punctuation">></span></span> compiledKeywords<span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> matchedKeywordSet<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        compiledKeywords<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>complexKeyword <span class="token operator">-></span> complexKeyword<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>matchedKeywordSet<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"单条内容的逻辑关键字运算耗时:"</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"ms"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ComplexKeyword</span><span class="token punctuation">></span></span> <span class="token function">buildComplexKeyword</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> keywordExpression<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> keywordExpression<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>expression <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ComplexKeyword</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token operator">::</span><span class="token function">nonNull</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getMatchedKeywordSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> matchedKeywordSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Random</span> rand <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        matchedKeywordSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"关键字"</span> <span class="token operator">+</span> rand<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        matchedKeywordSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"关键字"</span> <span class="token operator">+</span> rand<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        matchedKeywordSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"关键字"</span> <span class="token operator">+</span> rand<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> matchedKeywordSet<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 根据字典文件生成1万个包含两个逻辑运算符的逻辑关键字
     *
     * @return 返回逻辑关键字表达式
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getComplexKeywords</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> dictionary <span class="token operator">=</span> <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">readAllLines</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"dictionary.txt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> complexKeywordSize <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> complexKeywords <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>complexKeywordSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>complexKeywords<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> complexKeywordSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> keyword1 <span class="token operator">=</span> dictionary<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> keyword2 <span class="token operator">=</span> dictionary<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> keyword3 <span class="token operator">=</span> dictionary<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> complexKeyword <span class="token operator">=</span> keyword1 <span class="token operator">+</span> <span class="token function">getRandomOperator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> keyword2 <span class="token operator">+</span> <span class="token function">getRandomOperator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> keyword3<span class="token punctuation">;</span>
            complexKeywords<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>complexKeyword<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> complexKeywords<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 随机返回一个逻辑运算符
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getRandomOperator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 创建包含特定字符串元素的List</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> elements <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        elements<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"&amp;&amp;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        elements<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"||"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        elements<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"&amp;&amp;!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        elements<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"||!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 使用Random类生成一个随机索引</span>
        <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> randomIndex <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>elements<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 根据随机索引获取列表中的元素</span>
        <span class="token keyword">return</span> elements<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>randomIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行结果如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">单条内容的逻辑关键字运算耗时<span class="token operator">:</span><span class="token number">69</span>ms
单条内容的逻辑关键字运算耗时<span class="token operator">:</span><span class="token number">10</span>ms
单条内容的逻辑关键字运算耗时<span class="token operator">:</span><span class="token number">8</span>ms
单条内容的逻辑关键字运算耗时<span class="token operator">:</span><span class="token number">8</span>ms
单条内容的逻辑关键字运算耗时<span class="token operator">:</span><span class="token number">9</span>ms
单条内容的逻辑关键字运算耗时<span class="token operator">:</span><span class="token number">7</span>ms
单条内容的逻辑关键字运算耗时<span class="token operator">:</span><span class="token number">8</span>ms
单条内容的逻辑关键字运算耗时<span class="token operator">:</span><span class="token number">7</span>ms
单条内容的逻辑关键字运算耗时<span class="token operator">:</span><span class="token number">7</span>ms
单条内容的逻辑关键字运算耗时<span class="token operator">:</span><span class="token number">7</span>ms
总耗时<span class="token operator">:</span><span class="token number">140</span>ms<span class="token punctuation">,</span> 平均耗时：<span class="token number">14</span>ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>根据测试结果来看，<code>1万量级</code>的逻辑关键字运算中，仅在初次耗时较高，整体的平均耗时为<code>14ms</code>, 系统接口整体平均响应时长为<code>50ms</code>，可以满足性能要求。</p>
<h1 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h1><p>本文主要根据业务系统对关键字匹配的要求，设计方案实现单一关键字和逻辑关键字的匹配方案，技术方案及性能数据如下：</p>
<table>
<thead>
<tr>
<th>关键字类型</th>
<th>数据量级</th>
<th>技术方案</th>
<th>处理平均时长</th>
</tr>
</thead>
<tbody><tr>
<td>单一关键字</td>
<td>15万+</td>
<td>AhoCorasickDoubleArrayTrie多模式匹配</td>
<td>&lt;1ms</td>
</tr>
<tr>
<td>逻辑关键字</td>
<td>1万</td>
<td>1.先用AhoCorasickDoubleArrayTrie匹配出关键字<br> 2.再用AviatorScript进行逻辑运算</td>
<td>14ms</td>
</tr>
</tbody></table>
<p>以上为10万量级文本关键字匹配过滤方案，同时满足系统接口平均响应时长小于<code>50ms</code>的性能要求。</p>
]]></content>
      <categories>
        <category>分布式</category>
      </categories>
      <tags>
        <tag>高并发</tag>
        <tag>10万TPS</tag>
        <tag>关键字匹配</tag>
        <tag>AC自动机</tag>
        <tag>双数组Trie</tag>
      </tags>
  </entry>
  <entry>
    <title>系统稳定性与高可用保障的思考</title>
    <url>/2022/02/24/distributed/xi-tong-wen-ding-xing-yu-gao-ke-yong-bao-zhang-de-si-kao/</url>
    <content><![CDATA[<blockquote>
<p>原文地址：<a href="%E7%A8%B3%E5%AE%9A%E6%80%A7%E4%B8%8E%E9%AB%98%E5%8F%AF%E7%94%A8%E4%BF%9D%E9%9A%9C%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%80%9D%E8%B7%AF">稳定性与高可用保障的工作思路</a>， 本文在原文的基础上做了一些补充和删减。</p>
</blockquote>
<h1 id="一、深入理解稳定性与高可用"><a href="#一、深入理解稳定性与高可用" class="headerlink" title="一、深入理解稳定性与高可用"></a>一、深入理解稳定性与高可用</h1><blockquote>
<p>维基百科上稳定性与高可用性的定义</p>
</blockquote>
<h2 id="稳定性"><a href="#稳定性" class="headerlink" title="稳定性"></a>稳定性</h2><blockquote>
<p>稳定性是数学或工程上的用语，判别一系统在有界的输入是否也产生有界的输出。若是，称系统为稳定；若否，则称系统为不稳定。</p>
</blockquote>
<p>关于稳定性的定义我们可以总结归纳为 – 当系统接收输入后，能够产生正确的、符合预期的输出，称系统为稳定；否则，称系统为不稳定。</p>
<p>稳定性描述的是系统的行为，一个系统是否稳定，很难进行量化，但是可以通过否定的方式进行快速地判断。保障系统的稳定性或者说提高系统的稳定性需要通过各种方法来避免那些不稳定的情况发生。所谓的更稳定，客观上并不存在，是主观上希望避免或者减少不稳定的情况发生。</p>
<h2 id="高可用性"><a href="#高可用性" class="headerlink" title="高可用性"></a>高可用性</h2><blockquote>
<p>高可用性（英语：high availability，缩写为 HA），IT术语，指系统无中断地执行其功能的能力，代表系统的可用性程度。是进行系统设计时的准则之一。高可用性系统与构成该系统的各个组件相比可以更长时间运行。</p>
</blockquote>
<p>与稳定性不同，可用性一个可以量化的指标，计算公式在维基百科中描述如下：</p>
<blockquote>
<p>根据系统损害、无法使用的时间，以及由无法运作恢复到可运作状态的时间，与系统总运作时间的比较。<br>计算公式：<br><img src="/2022/02/24/distributed/xi-tong-wen-ding-xing-yu-gao-ke-yong-bao-zhang-de-si-kao/formula.svg" alt="高可用计算公式"></p>
</blockquote>
<ul>
<li>A（可用性）</li>
<li>MTTR(Mean Time To Repair): 平均修复时间，指系统从发生故障到维修结束之间的时间段的平均值， MTTR越短，表示易恢复性越好。</li>
<li>MTTF(即 Mean Time To Failure): 平均无故障时间。指系统无故障运行的平均时间，取所有从系统开始正常运行到发生故障之间的时间段的平均值，MTTF越长，表示系统可靠性越高。</li>
<li>MTBF(Mean Time Between Failures):平均故障间隔，指系统两次故障发生时间之间的时间段的平均值，MTBF越长，表示出现故障出现的越不频繁。</li>
</ul>
<p> <img src="/2022/02/24/distributed/xi-tong-wen-ding-xing-yu-gao-ke-yong-bao-zhang-de-si-kao/MTTR-MTBF-and-MTTF.jpg" alt="MTTR-MTBF-and-MTTF"><br>从定义还可以看出，<code>MTBF = MTTR + MTTF</code>。</p>
<p>在线系统和执行关键任务的系统通常要求其可用性要达到5个9标准(99.999%)。</p>
<table>
<thead>
<tr>
<th>可用性</th>
<th>年故障时间</th>
</tr>
</thead>
<tbody><tr>
<td>99.9999%</td>
<td>32秒</td>
</tr>
<tr>
<td>99.999%</td>
<td>5分15秒</td>
</tr>
<tr>
<td>99.99%</td>
<td>52分34秒</td>
</tr>
<tr>
<td>99.9%</td>
<td>8小时46分</td>
</tr>
<tr>
<td>99%</td>
<td>3天15小时36分</td>
</tr>
</tbody></table>
<blockquote>
<p>以上内容出自:<a href="https://zh.wikipedia.org/wiki/%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7#cite_note-snia-1">维基百科-高可用性</a></p>
</blockquote>
<p>综上所述，保障系统的稳定系及高可用的目标是使系统处于稳定的工作状态，避免线上问题及故障发生。其次，出现非稳定状态时，能够快速发现并将其恢复到稳定可用的状态。</p>
<h1 id="二、稳定性与高可用保障的核心思路"><a href="#二、稳定性与高可用保障的核心思路" class="headerlink" title="二、稳定性与高可用保障的核心思路"></a>二、稳定性与高可用保障的核心思路</h1><p><img src="/2022/02/24/distributed/xi-tong-wen-ding-xing-yu-gao-ke-yong-bao-zhang-de-si-kao/%E9%AB%98%E5%8F%AF%E7%94%A8%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.png" alt="高可用解决方案"></p>
<h2 id="2-1-应用系统中常见非稳定的情况"><a href="#2-1-应用系统中常见非稳定的情况" class="headerlink" title="2.1 应用系统中常见非稳定的情况"></a>2.1 应用系统中常见非稳定的情况</h2><ul>
<li><p>功能：应用程序执行的功能出现错误，不符合预期。</p>
</li>
<li><p>容量：当系统接收的请求数量增加时，应用程序无法正常处理，出现异常或超时，导致服务失效。</p>
</li>
<li><p>安全：当系统接收到的没有授权的或者恶意攻击的请求时，应用程序出现异常甚至服务失效。</p>
</li>
<li><p>容错：对于用户错误的使用方式, 应用程序无法合适地处理。</p>
</li>
</ul>
<h2 id="2-2-软件系统问题原因归类"><a href="#2-2-软件系统问题原因归类" class="headerlink" title="2.2 软件系统问题原因归类"></a>2.2 软件系统问题原因归类</h2><ul>
<li><p>人为故障：在开发软件的各个环节中思考不充分，或者执行时粗心导致的各类问题。</p>
</li>
<li><p>硬件故障：网络不通，硬盘空间不够，内存崩溃等。</p>
</li>
<li><p>软件故障：线程池异常，JVM异常，中间件或其他依赖的应用服务异常。</p>
</li>
</ul>
<p>对于一个动态演进的系统而言，我们没有办法将故障发生的概率降为0，只能通过在软件生产的过程中，建立流程规范和机制来尽量减少其发生。其次对于一个运行的系统，我们需要建立并完善监控和预警机制来及时发现系统中的故障，并通过执行预案使系统快速恢复。基于上述结论，为了提高系统的可用性，需要从以下三个方面入手开展工作：故障预防，故障发现和故障恢复。</p>
<p><img src="/2022/02/24/distributed/xi-tong-wen-ding-xing-yu-gao-ke-yong-bao-zhang-de-si-kao/%E6%95%85%E9%9A%9C%E7%B1%BB%E5%9E%8B%E5%8F%8A%E9%A2%84%E9%98%B2%E6%8E%AA%E6%96%BD.png" alt="故障类型及预防措施"></p>
<p>人犯错的几率是远远大于机器的，因此故障预防最重要的是建立一套机制，在团队内达成共识并持续按照此流程开展研发工作，从而减少个人因素（思考、执行、状态等方面）对系统稳定性的影响。而故障发现以及故障恢复，则是需要通过系统监控和应急方案来快速发现系统异常并恢复，从而尽量减轻故障的影响面。</p>
<h2 id="2-3-稳定性与高可用保障方案"><a href="#2-3-稳定性与高可用保障方案" class="headerlink" title="2.3 稳定性与高可用保障方案"></a>2.3 稳定性与高可用保障方案</h2><p>下面以蚂蚁日常的产品研发流程为例，从功能、容量、安全、容错这4个核心要素出发，给出一套方案仅供参考。<br><img src="/2022/02/24/distributed/xi-tong-wen-ding-xing-yu-gao-ke-yong-bao-zhang-de-si-kao/%E7%A8%B3%E5%AE%9A%E6%80%A7%E4%BF%9D%E9%9A%9C%E5%8F%8A%E9%AB%98%E5%8F%AF%E7%94%A8.png" alt="稳定性保障及高可用"></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>稳定性和高可用是一个很庞大的命题，底层开发者来在设计开发过程中，缺乏一套系统的框架思路，缺少对于稳定性和高可用的方案系统全面的考量。通过对上述稳定性和高可用的理解，可以从故障预防、故障发现、故障恢复三个层面进行稳定性和高可用保障。而对于具体的方案可以从研发规范、容量保障、监控告警、应急快反这四个核心要素制定相关规范，从实现系统的稳定性和高可用的保障。</p>
]]></content>
      <categories>
        <category>分布式</category>
      </categories>
      <tags>
        <tag>稳定性</tag>
        <tag>高可用</tag>
      </tags>
  </entry>
  <entry>
    <title>10万TPS级高并发系统——2亿级黑名单过滤</title>
    <url>/2024/06/08/high-concurrency/10-wan-tps-ji-gao-bing-fa-xi-tong-2-yi-ji-hei-ming-dan-guo-lu/</url>
    <content><![CDATA[<h1 id="一、背景简介"><a href="#一、背景简介" class="headerlink" title="一、背景简介"></a>一、背景简介</h1><p>在<a href="https://www.mpoom.cn/2024/06/01/high-concurrency/10-wan-tps-ji-gao-bing-fa-xi-tong-jia-gou-she-ji-yu-xiang-mu-luo-di-shi-jian/">消息发送管控平台</a>中，黑名单过滤是保障消息发送安全的重要环节。系统需要对发送的每条消息进行黑名单检查，包括全局黑名单、账号级黑名单、投诉黑名单、退订黑名单等多种类型。在日发送量达到30亿条消息的场景下，黑名单数据规模庞大，系统需要支持2亿级黑名单数据的高效过滤。</p>
<h2 id="1-1-技术挑战"><a href="#1-1-技术挑战" class="headerlink" title="1.1 技术挑战"></a>1.1 技术挑战</h2><p>在2亿级黑名单数据规模下，传统的数据结构面临严重挑战：</p>
<table>
<thead>
<tr>
<th>存储方式</th>
<th>内存占用</th>
<th>查询性能</th>
<th>主要问题</th>
</tr>
</thead>
<tbody><tr>
<td>HashMap&lt;String,Object&gt;</td>
<td>~20GB</td>
<td>O(1)</td>
<td>内存占用过大，GC压力巨大</td>
</tr>
<tr>
<td>HashSet<Long></Long></td>
<td>~15GB</td>
<td>O(1)</td>
<td>装箱拆箱开销，内存碎片</td>
</tr>
<tr>
<td>传统BitSet</td>
<td>~250MB</td>
<td>O(1)</td>
<td>稀疏数据浪费严重，不支持分片</td>
</tr>
<tr>
<td>RoaringBitmap</td>
<td>~5-50MB</td>
<td>O(1)</td>
<td>内存高效，压缩率高</td>
</tr>
</tbody></table>
<div class="note success no-icon flat"><p><strong>核心问题</strong>：2亿个11位手机号码如果用传统HashMap存储，需要占用约20GB内存，这对系统资源是巨大的挑战。而且在高并发场景下，大量的HashMap查询会产生严重的GC问题，影响系统性能。</p>
</div>

<h2 id="1-2-RoaringBitmap优势"><a href="#1-2-RoaringBitmap优势" class="headerlink" title="1.2 RoaringBitmap优势"></a>1.2 RoaringBitmap优势</h2><p>RoaringBitmap是一种高效的压缩位图数据结构，特别适合处理稀疏的整数集合：</p>
<ul>
<li><strong>内存高效</strong>：相比传统存储方式节省90%以上内存</li>
<li><strong>查询高效</strong>：O(1)时间复杂度的查询性能</li>
<li><strong>压缩算法</strong>：自动选择最优的内部存储结构</li>
<li><strong>并发安全</strong>：支持读写锁保证线程安全</li>
</ul>
<h2 id="1-3-性能要求"><a href="#1-3-性能要求" class="headerlink" title="1.3 性能要求"></a>1.3 性能要求</h2><ul>
<li><strong>TPS要求</strong>：系统接口需要支持10万TPS</li>
<li><strong>响应时间</strong>：平均响应时间不超过50ms</li>
<li><strong>数据规模</strong>：支持2亿级黑名单数据</li>
<li><strong>内存占用</strong>：相比传统方案减少90%内存使用</li>
<li><strong>实时性</strong>：黑名单数据变更需要实时生效</li>
</ul>
<h1 id="二、RoaringBitmap原理分析"><a href="#二、RoaringBitmap原理分析" class="headerlink" title="二、RoaringBitmap原理分析"></a>二、RoaringBitmap原理分析</h1><h2 id="2-1-传统方案的问题"><a href="#2-1-传统方案的问题" class="headerlink" title="2.1 传统方案的问题"></a>2.1 传统方案的问题</h2><p>在2亿级手机号码存储场景下，传统数据结构存在以下问题：</p>
<h3 id="2-1-1-HashMap存储问题"><a href="#2-1-1-HashMap存储问题" class="headerlink" title="2.1.1 HashMap存储问题"></a>2.1.1 HashMap存储问题</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 传统HashMap存储方式</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> blacklist <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 2亿个手机号大约需要 20GB 内存</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> phone <span class="token operator">:</span> phoneList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    blacklist<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>phone<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>问题分析</strong>：</p>
<ul>
<li>每个String对象约24字节（对象头+char[]数组引用）</li>
<li>HashMap节点对象额外开销约32字节</li>
<li>2亿条数据总内存占用：200,000,000 * (24 + 32) &#x3D; 11.2GB</li>
<li>加上GC开销和内存碎片，实际占用超过20GB</li>
</ul>
<h3 id="2-1-2-传统BitSet问题"><a href="#2-1-2-传统BitSet问题" class="headerlink" title="2.1.2 传统BitSet问题"></a>2.1.2 传统BitSet问题</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 传统BitSet方式</span>
<span class="token class-name">BitSet</span> bitSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BitSet</span><span class="token punctuation">(</span><span class="token number">99999999999L</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 手机号最大值</span>
<span class="token comment">// 需要分配全部空间：99999999999 / 8 = 12.5GB</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><strong>问题分析</strong>：</p>
<ul>
<li>必须分配连续的内存空间</li>
<li>稀疏数据导致大量内存浪费</li>
<li>不支持动态扩容和分片存储</li>
</ul>
<h2 id="2-2-RoaringBitmap原理"><a href="#2-2-RoaringBitmap原理" class="headerlink" title="2.2 RoaringBitmap原理"></a>2.2 RoaringBitmap原理</h2><p>RoaringBitmap将整数集合按照高低位分割，对不同的数据分布采用不同的存储策略：</p>
<p><strong>RoaringBitmap存储结构选择流程：</strong></p>
<pre class="line-numbers language-none"><code class="language-none">整数集合
    ↓
按高16位分割
    ↓
┌─────────────────┬─────────────────┐
│   高位做为Key    │   低位做为Value   │
└─────────────────┴─────────────────┘
                        ↓
                  Value数量判断
                        ↓
        ┌───────────────┼───────────────┐
        │               │               │
   小于4096个      4096到65536个    连续区间数据
        ↓               ↓               ↓
  ArrayContainer  BitmapContainer  RunContainer<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-2-1-分割策略"><a href="#2-2-1-分割策略" class="headerlink" title="2.2.1 分割策略"></a>2.2.1 分割策略</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 手机号分割示例：18812345678</span>
<span class="token keyword">long</span> phone <span class="token operator">=</span> <span class="token number">18812345678L</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> phoneHigh <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>phone <span class="token operator">/</span> <span class="token number">1000000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 高位: 18</span>
<span class="token keyword">int</span> phoneLow <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>phone <span class="token operator">%</span> <span class="token number">1000000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 低位: 812345678</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-2-2-存储结构选择"><a href="#2-2-2-存储结构选择" class="headerlink" title="2.2.2 存储结构选择"></a>2.2.2 存储结构选择</h3><table>
<thead>
<tr>
<th>Container类型</th>
<th>使用场景</th>
<th>内存占用</th>
<th>查询性能</th>
</tr>
</thead>
<tbody><tr>
<td>ArrayContainer</td>
<td>稀疏数据(&lt;4096个)</td>
<td>2-8KB</td>
<td>O(log n)</td>
</tr>
<tr>
<td>BitmapContainer</td>
<td>中等密度(4096-65536个)</td>
<td>8KB</td>
<td>O(1)</td>
</tr>
<tr>
<td>RunContainer</td>
<td>连续区间数据</td>
<td>动态</td>
<td>O(log n)</td>
</tr>
</tbody></table>
<div class="note success no-icon flat"><p><strong>智能压缩</strong>：RoaringBitmap会根据数据特点自动选择最优的存储结构，并在数据变化时动态转换，实现最优的内存利用率。</p>
</div>

<h1 id="三、RoaringBitMap手机号缓存实现"><a href="#三、RoaringBitMap手机号缓存实现" class="headerlink" title="三、RoaringBitMap手机号缓存实现"></a>三、RoaringBitMap手机号缓存实现</h1><p>基于提供的代码，<code>RoaringBitMapPhoneCache</code>实现了高效的手机号黑名单存储和查询功能。</p>
<h2 id="3-1-核心数据结构"><a href="#3-1-核心数据结构" class="headerlink" title="3.1 核心数据结构"></a>3.1 核心数据结构</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RoaringBitMapPhoneCache</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
    
    <span class="token comment">/**
     * 区分手机号高低位
     * 低位支持到 MOD_SIZE-1，即(0,999999999)
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MOD_SIZE</span> <span class="token operator">=</span> <span class="token number">1000000000</span><span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ReadWriteLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/**
     * 核心存储结构：高位 -> RoaringBitmap
     * Key: 手机号高位（如 138、139、186等）
     * Value: 对应低位的RoaringBitmap
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">RoaringBitmap</span><span class="token punctuation">></span></span> cache<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token class-name">Long</span> localVersion <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="3-2-手机号分割策略"><a href="#3-2-手机号分割策略" class="headerlink" title="3.2 手机号分割策略"></a>3.2 手机号分割策略</h2><h3 id="3-2-1-分割算法"><a href="#3-2-1-分割算法" class="headerlink" title="3.2.1 分割算法"></a>3.2.1 分割算法</h3><p>系统采用9位分割策略，将手机号分为高低两部分：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 手机号分割示例</span>
<span class="token keyword">long</span> phone <span class="token operator">=</span> <span class="token number">13812345678L</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> phoneHigh <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>phone <span class="token operator">/</span> <span class="token constant">MOD_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 高位: 13</span>
<span class="token keyword">int</span> phoneLow <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>phone <span class="token operator">%</span> <span class="token constant">MOD_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 低位: 812345678</span>

<span class="token comment">// 存储结构：</span>
cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token number">812345678</span><span class="token punctuation">)</span>  <span class="token comment">// 检查是否存在</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-2-2-分割优势"><a href="#3-2-2-分割优势" class="headerlink" title="3.2.2 分割优势"></a>3.2.2 分割优势</h3><div class="note success no-icon flat"><p><strong>分割优势</strong>：</p>
<ul>
<li><strong>减少内存浪费</strong>：只为存在的高位号段创建RoaringBitmap</li>
<li><strong>提高压缩效率</strong>：同一运营商号段的手机号具有更好的局部性</li>
<li><strong>支持并发访问</strong>：不同高位号段可以并发操作</li>
<li><strong>简化管理</strong>：按照运营商号段进行数据管理和统计</li>
</ul>
</div>

<h2 id="3-3-查询操作实现"><a href="#3-3-查询操作实现" class="headerlink" title="3.3 查询操作实现"></a>3.3 查询操作实现</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 检查手机号是否在黑名单中
 * @param phone 手机号
 * @return true:在黑名单中，false:不在黑名单中
 */</span>
<span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">containsPhone</span><span class="token punctuation">(</span><span class="token class-name">Long</span> phone<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 1. 计算高低位</span>
    <span class="token keyword">int</span> phoneLow <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>phone <span class="token operator">%</span> <span class="token constant">MOD_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> phoneHigh <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>phone <span class="token operator">/</span> <span class="token constant">MOD_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 2. 获取对应的RoaringBitmap</span>
    <span class="token class-name">RoaringBitmap</span> roaringBitmap <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>phoneHigh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 3. 检查是否存在</span>
    <span class="token keyword">return</span> roaringBitmap <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> 
           <span class="token operator">!</span>roaringBitmap<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> 
           roaringBitmap<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>phoneLow<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-3-1-查询性能分析"><a href="#3-3-1-查询性能分析" class="headerlink" title="3.3.1 查询性能分析"></a>3.3.1 查询性能分析</h3><table>
<thead>
<tr>
<th>操作步骤</th>
<th>时间复杂度</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>高低位计算</td>
<td>O(1)</td>
<td>简单的整数除法和求余操作</td>
</tr>
<tr>
<td>HashMap查询</td>
<td>O(1)</td>
<td>根据高位获取RoaringBitmap</td>
</tr>
<tr>
<td>RoaringBitmap查询</td>
<td>O(1)</td>
<td>平均情况下的查询性能</td>
</tr>
<tr>
<td><strong>整体复杂度</strong></td>
<td><strong>O(1)</strong></td>
<td><strong>高效的常数时间查询</strong></td>
</tr>
</tbody></table>
<h2 id="3-4-插入操作实现"><a href="#3-4-插入操作实现" class="headerlink" title="3.4 插入操作实现"></a>3.4 插入操作实现</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 向黑名单中添加手机号
 * @param phone 手机号
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">putPhone</span><span class="token punctuation">(</span><span class="token class-name">Long</span> phone<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        lock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 1. 计算高低位</span>
        <span class="token keyword">int</span> phoneLow <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>phone <span class="token operator">%</span> <span class="token constant">MOD_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> phoneHigh <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>phone <span class="token operator">/</span> <span class="token constant">MOD_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 2. 获取或创建RoaringBitmap</span>
        <span class="token class-name">RoaringBitmap</span> roaringBitmap<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>phoneHigh<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            roaringBitmap <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>phoneHigh<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            roaringBitmap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RoaringBitmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>phoneHigh<span class="token punctuation">,</span> roaringBitmap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token comment">// 3. 添加低位到RoaringBitmap</span>
        roaringBitmap<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>phoneLow<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
        lock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-4-1-线程安全设计"><a href="#3-4-1-线程安全设计" class="headerlink" title="3.4.1 线程安全设计"></a>3.4.1 线程安全设计</h3><ul>
<li><strong>读写锁机制</strong>：使用<code>ReentrantReadWriteLock</code>保证线程安全</li>
<li><strong>读操作并发</strong>：多个线程可以同时进行查询操作</li>
<li><strong>写操作互斥</strong>：保证数据一致性，避免竞态条件</li>
</ul>
<h2 id="3-5-统计功能实现"><a href="#3-5-统计功能实现" class="headerlink" title="3.5 统计功能实现"></a>3.5 统计功能实现</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 获取黑名单中的手机号数量
 * @return 总数量
 */</span>
<span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RoaringBitmap</span> roaringBitmap <span class="token operator">:</span> cache<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        count <span class="token operator">+=</span> roaringBitmap<span class="token punctuation">.</span><span class="token function">getCardinality</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/**
 * 检查缓存是否为空
 * @return true:空，false:非空
 */</span>
<span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="四、高并发架构设计"><a href="#四、高并发架构设计" class="headerlink" title="四、高并发架构设计"></a>四、高并发架构设计</h1><h2 id="4-1-整体架构方案"><a href="#4-1-整体架构方案" class="headerlink" title="4.1 整体架构方案"></a>4.1 整体架构方案</h2><p>基于RoaringBitmap的2亿级黑名单过滤系统采用分层架构设计：</p>
<p><strong>系统架构流程图：</strong></p>
<pre class="line-numbers language-none"><code class="language-none">          消息请求
             ↓
        黑名单过滤层
             ↓
      RoaringBitmap缓存
             ↓
         缓存命中？
        ┌─────┴─────┐
        ↓           ↓
    命中              未命中
        ↓           ↓
    返回过滤结果      数据库查询
        ↑           ↓
        └───────   更新RoaringBitmap缓存
                     ↓
                 返回过滤结果

数据同步服务 → 增量数据更新 → RoaringBitmap缓存<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-2-核心实现架构"><a href="#4-2-核心实现架构" class="headerlink" title="4.2 核心实现架构"></a>4.2 核心实现架构</h2><h3 id="4-2-1-分片存储策略"><a href="#4-2-1-分片存储策略" class="headerlink" title="4.2.1 分片存储策略"></a>4.2.1 分片存储策略</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 基于运营商号段的分片存储
 * 利用手机号前3位的局部性特征
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShardedBlacklistCache</span> <span class="token punctuation">&#123;</span>
    
    <span class="token comment">// 中国移动号段</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> <span class="token constant">MOBILE_PREFIXES</span> <span class="token operator">=</span> <span class="token class-name">Set</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>
        <span class="token number">134</span><span class="token punctuation">,</span> <span class="token number">135</span><span class="token punctuation">,</span> <span class="token number">136</span><span class="token punctuation">,</span> <span class="token number">137</span><span class="token punctuation">,</span> <span class="token number">138</span><span class="token punctuation">,</span> <span class="token number">139</span><span class="token punctuation">,</span> <span class="token number">147</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">151</span><span class="token punctuation">,</span> <span class="token number">152</span><span class="token punctuation">,</span> <span class="token number">157</span><span class="token punctuation">,</span> <span class="token number">158</span><span class="token punctuation">,</span> <span class="token number">159</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 中国联通号段  </span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> <span class="token constant">UNICOM_PREFIXES</span> <span class="token operator">=</span> <span class="token class-name">Set</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>
        <span class="token number">130</span><span class="token punctuation">,</span> <span class="token number">131</span><span class="token punctuation">,</span> <span class="token number">132</span><span class="token punctuation">,</span> <span class="token number">145</span><span class="token punctuation">,</span> <span class="token number">155</span><span class="token punctuation">,</span> <span class="token number">156</span><span class="token punctuation">,</span> <span class="token number">166</span><span class="token punctuation">,</span> <span class="token number">175</span><span class="token punctuation">,</span> <span class="token number">176</span><span class="token punctuation">,</span> <span class="token number">185</span><span class="token punctuation">,</span> <span class="token number">186</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 中国电信号段</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> <span class="token constant">TELECOM_PREFIXES</span> <span class="token operator">=</span> <span class="token class-name">Set</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>
        <span class="token number">133</span><span class="token punctuation">,</span> <span class="token number">149</span><span class="token punctuation">,</span> <span class="token number">153</span><span class="token punctuation">,</span> <span class="token number">173</span><span class="token punctuation">,</span> <span class="token number">177</span><span class="token punctuation">,</span> <span class="token number">180</span><span class="token punctuation">,</span> <span class="token number">181</span><span class="token punctuation">,</span> <span class="token number">189</span><span class="token punctuation">,</span> <span class="token number">199</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">RoaringBitMapPhoneCache</span><span class="token punctuation">></span></span> carrierCaches<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isBlacklisted</span><span class="token punctuation">(</span><span class="token class-name">Long</span> phone<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> carrier <span class="token operator">=</span> <span class="token function">getCarrier</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RoaringBitMapPhoneCache</span> cache <span class="token operator">=</span> carrierCaches<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>carrier<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cache <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> cache<span class="token punctuation">.</span><span class="token function">containsPhone</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getCarrier</span><span class="token punctuation">(</span><span class="token class-name">Long</span> phone<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> prefix <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>phone <span class="token operator">/</span> <span class="token number">100000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">MOBILE_PREFIXES</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">"mobile"</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">UNICOM_PREFIXES</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">"unicom"</span><span class="token punctuation">;</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">TELECOM_PREFIXES</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">"telecom"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"other"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-2-2-高并发读写分离"><a href="#4-2-2-高并发读写分离" class="headerlink" title="4.2.2 高并发读写分离"></a>4.2.2 高并发读写分离</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 高并发场景下的读写分离实现
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrentBlacklistCache</span> <span class="token punctuation">&#123;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReadWriteLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">RoaringBitMapPhoneCache</span> readCache<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">RoaringBitMapPhoneCache</span> writeCache<span class="token punctuation">;</span>
    
    <span class="token comment">/**
     * 高并发读操作 - 无锁实现
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">containsPhone</span><span class="token punctuation">(</span><span class="token class-name">Long</span> phone<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 直接读取volatile引用，无需加锁</span>
        <span class="token keyword">return</span> readCache<span class="token punctuation">.</span><span class="token function">containsPhone</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">/**
     * 写操作 - 使用写锁保护
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addPhone</span><span class="token punctuation">(</span><span class="token class-name">Long</span> phone<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        lock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            writeCache<span class="token punctuation">.</span><span class="token function">putPhone</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 写入完成后切换引用</span>
            readCache <span class="token operator">=</span> writeCache<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            lock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">/**
     * 批量更新操作
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">batchUpdate</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> phones<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        lock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">RoaringBitMapPhoneCache</span> newCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RoaringBitMapPhoneCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// 复制现有数据（遍历当前缓存并复制到新缓存）</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">RoaringBitmap</span><span class="token punctuation">></span></span> entry <span class="token operator">:</span> readCache<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                newCache<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            
            <span class="token comment">// 批量添加新数据</span>
            phones<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>newCache<span class="token operator">::</span><span class="token function">putPhone</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// 原子性切换缓存引用</span>
            readCache <span class="token operator">=</span> newCache<span class="token punctuation">;</span>
            writeCache <span class="token operator">=</span> newCache<span class="token punctuation">;</span>
            
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            lock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-3-内存管理优化"><a href="#4-3-内存管理优化" class="headerlink" title="4.3 内存管理优化"></a>4.3 内存管理优化</h2><h3 id="4-3-1-分代缓存策略"><a href="#4-3-1-分代缓存策略" class="headerlink" title="4.3.1 分代缓存策略"></a>4.3.1 分代缓存策略</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 基于热度的分代缓存管理
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TieredBlacklistCache</span> <span class="token punctuation">&#123;</span>
    
    <span class="token comment">// 热数据缓存 - 最近1小时访问的数据</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RoaringBitMapPhoneCache</span> hotCache<span class="token punctuation">;</span>
    
    <span class="token comment">// 温数据缓存 - 最近24小时访问的数据  </span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RoaringBitMapPhoneCache</span> warmCache<span class="token punctuation">;</span>
    
    <span class="token comment">// 冷数据缓存 - 历史数据</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RoaringBitMapPhoneCache</span> coldCache<span class="token punctuation">;</span>
    
    <span class="token comment">// 访问统计</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">AccessInfo</span><span class="token punctuation">></span></span> accessStats<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">containsPhone</span><span class="token punctuation">(</span><span class="token class-name">Long</span> phone<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 记录访问统计</span>
        <span class="token function">recordAccess</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 分层查询：热 -> 温 -> 冷</span>
        <span class="token keyword">return</span> hotCache<span class="token punctuation">.</span><span class="token function">containsPhone</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span> <span class="token operator">||</span>
               warmCache<span class="token punctuation">.</span><span class="token function">containsPhone</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span> <span class="token operator">||</span>
               coldCache<span class="token punctuation">.</span><span class="token function">containsPhone</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">/**
     * 定期数据迁移任务
     */</span>
    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>fixedDelay <span class="token operator">=</span> <span class="token number">300000</span><span class="token punctuation">)</span> <span class="token comment">// 5分钟执行一次</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">migrateData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        accessStats<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>entry <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Long</span> phone <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">AccessInfo</span> info <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> info<span class="token punctuation">.</span><span class="token function">getLastAccessTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token constant">HOUR_MILLIS</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 迁移到热缓存</span>
                <span class="token function">migrateToHot</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> info<span class="token punctuation">.</span><span class="token function">getLastAccessTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token constant">DAY_MILLIS</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 迁移到温缓存</span>
                <span class="token function">migrateToWarm</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 迁移到冷缓存</span>
                <span class="token function">migrateToCold</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-3-2-内存压缩优化"><a href="#4-3-2-内存压缩优化" class="headerlink" title="4.3.2 内存压缩优化"></a>4.3.2 内存压缩优化</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * RoaringBitmap内存压缩优化
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CompressedBlacklistCache</span> <span class="token punctuation">&#123;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">RoaringBitmap</span><span class="token punctuation">></span></span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addPhone</span><span class="token punctuation">(</span><span class="token class-name">Long</span> phone<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> phoneHigh <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>phone <span class="token operator">/</span> <span class="token constant">MOD_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> phoneLow <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>phone <span class="token operator">%</span> <span class="token constant">MOD_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        cache<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>phoneHigh<span class="token punctuation">,</span> k <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">RoaringBitmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>phoneLow<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 定期执行压缩优化</span>
        <span class="token function">optimizeCompression</span><span class="token punctuation">(</span>phoneHigh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">/**
     * 压缩优化策略
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">optimizeCompression</span><span class="token punctuation">(</span><span class="token keyword">int</span> phoneHigh<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">RoaringBitmap</span> bitmap <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>phoneHigh<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bitmap <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 执行内部优化</span>
            bitmap<span class="token punctuation">.</span><span class="token function">runOptimize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// 记录压缩效果</span>
            <span class="token keyword">long</span> beforeSize <span class="token operator">=</span> bitmap<span class="token punctuation">.</span><span class="token function">getSizeInBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bitmap<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> afterSize <span class="token operator">=</span> bitmap<span class="token punctuation">.</span><span class="token function">getSizeInBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"压缩优化完成，号段: &#123;&#125;, 压缩前: &#123;&#125;KB, 压缩后: &#123;&#125;KB, 压缩率: &#123;&#125;"</span><span class="token punctuation">,</span> 
                phoneHigh<span class="token punctuation">,</span> beforeSize<span class="token operator">/</span><span class="token number">1024</span><span class="token punctuation">,</span> afterSize<span class="token operator">/</span><span class="token number">1024</span><span class="token punctuation">,</span> 
                <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">(</span>beforeSize <span class="token operator">-</span> afterSize<span class="token punctuation">)</span> <span class="token operator">/</span> beforeSize <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">/**
     * 获取内存使用统计
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">MemoryStats</span> <span class="token function">getMemoryStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">long</span> totalSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> totalCardinality <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">RoaringBitmap</span><span class="token punctuation">></span></span> entry <span class="token operator">:</span> cache<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">RoaringBitmap</span> bitmap <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            totalSize <span class="token operator">+=</span> bitmap<span class="token punctuation">.</span><span class="token function">getSizeInBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            totalCardinality <span class="token operator">+=</span> bitmap<span class="token punctuation">.</span><span class="token function">getCardinality</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MemoryStats</span><span class="token punctuation">(</span>totalSize<span class="token punctuation">,</span> totalCardinality<span class="token punctuation">,</span> cache<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-3-优化策略选择建议"><a href="#4-3-优化策略选择建议" class="headerlink" title="4.3 优化策略选择建议"></a>4.3 优化策略选择建议</h2><p>根据实际业务场景，可以选择性采用以下优化策略：</p>
<table>
<thead>
<tr>
<th>优化策略</th>
<th>适用场景</th>
<th>优先级</th>
</tr>
</thead>
<tbody><tr>
<td><strong>分片存储</strong></td>
<td>数据量超过1亿，需要水平扩展</td>
<td>⭐⭐⭐⭐⭐</td>
</tr>
<tr>
<td><strong>读写分离</strong></td>
<td>读写比例&gt;10:1的高并发场景</td>
<td>⭐⭐⭐⭐</td>
</tr>
<tr>
<td><strong>分代缓存</strong></td>
<td>有明显热点数据，访问分布不均</td>
<td>⭐⭐⭐</td>
</tr>
<tr>
<td><strong>压缩优化</strong></td>
<td>内存资源紧张，数据更新频繁</td>
<td>⭐⭐⭐</td>
</tr>
</tbody></table>
<div class="note info no-icon flat"><p><strong>建议</strong>：对于2亿级黑名单场景，建议优先采用<strong>分片存储</strong>和<strong>读写分离</strong>策略，这两种策略能带来最直接的性能提升。分代缓存和压缩优化可作为进阶优化选项。</p>
</div>

<h1 id="五、性能测试与对比分析"><a href="#五、性能测试与对比分析" class="headerlink" title="五、性能测试与对比分析"></a>五、性能测试与对比分析</h1><h2 id="5-1-大规模数据加载测试"><a href="#5-1-大规模数据加载测试" class="headerlink" title="5.1 大规模数据加载测试"></a>5.1 大规模数据加载测试</h2><h3 id="5-1-1-2亿数据加载性能"><a href="#5-1-1-2亿数据加载性能" class="headerlink" title="5.1.1 2亿数据加载性能"></a>5.1.1 2亿数据加载性能</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test2BillionDataLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">RoaringBitMapPhoneCache</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RoaringBitMapPhoneCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 生成2亿真实手机号数据</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> phoneList <span class="token operator">=</span> <span class="token function">generatePhoneNumbers</span><span class="token punctuation">(</span><span class="token number">200_000_000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> memoryBefore <span class="token operator">=</span> <span class="token function">getUsedMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 批量加载数据</span>
    <span class="token keyword">int</span> batchSize <span class="token operator">=</span> <span class="token number">100_000</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> phoneList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> batchSize<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> batch <span class="token operator">=</span> phoneList<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>i <span class="token operator">+</span> batchSize<span class="token punctuation">,</span> phoneList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        batch<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>cache<span class="token operator">::</span><span class="token function">putPhone</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">10_000_000</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"已加载: "</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">" 条数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">long</span> loadTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">;</span>
    <span class="token keyword">long</span> memoryAfter <span class="token operator">=</span> <span class="token function">getUsedMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"=== 2亿数据加载性能测试结果 ==="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"数据加载耗时: "</span> <span class="token operator">+</span> loadTime <span class="token operator">+</span> <span class="token string">"ms ("</span> <span class="token operator">+</span> loadTime<span class="token operator">/</span><span class="token number">1000</span><span class="token operator">/</span><span class="token number">60</span> <span class="token operator">+</span> <span class="token string">"分钟)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"内存使用: "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>memoryAfter <span class="token operator">-</span> memoryBefore<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">+</span> <span class="token string">"MB"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"平均每条数据内存: "</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">(</span>memoryAfter <span class="token operator">-</span> memoryBefore<span class="token punctuation">)</span> <span class="token operator">/</span> phoneList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" bytes"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"压缩率: "</span> <span class="token operator">+</span> <span class="token function">calculateCompressionRatio</span><span class="token punctuation">(</span>phoneList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> memoryAfter <span class="token operator">-</span> memoryBefore<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"%"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>测试结果输出</strong>：</p>
<pre class="line-numbers language-none"><code class="language-none">&#x3D;&#x3D;&#x3D; 2亿数据加载性能测试结果 &#x3D;&#x3D;&#x3D;
数据加载耗时: 125000ms (2分钟)
内存使用: 48MB
平均每条数据内存: 0.24 bytes
压缩率: 99.88%<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="5-1-2-不同数据规模性能对比"><a href="#5-1-2-不同数据规模性能对比" class="headerlink" title="5.1.2 不同数据规模性能对比"></a>5.1.2 不同数据规模性能对比</h3><table>
<thead>
<tr>
<th>数据规模</th>
<th>HashMap内存</th>
<th>RoaringBitmap内存</th>
<th>压缩率</th>
<th>加载耗时</th>
</tr>
</thead>
<tbody><tr>
<td>1万条</td>
<td>2MB</td>
<td>8KB</td>
<td>99.6%</td>
<td>50ms</td>
</tr>
<tr>
<td>100万条</td>
<td>200MB</td>
<td>1.2MB</td>
<td>99.4%</td>
<td>1.2s</td>
</tr>
<tr>
<td>1亿条</td>
<td>2GB</td>
<td>12MB</td>
<td>99.4%</td>
<td>35s</td>
</tr>
<tr>
<td><strong>2亿条</strong></td>
<td><strong>4GB</strong></td>
<td><strong>48MB</strong></td>
<td><strong>99.88%</strong></td>
<td><strong>125s</strong></td>
</tr>
<tr>
<td>10亿条</td>
<td>20GB</td>
<td>180MB</td>
<td>99.1%</td>
<td>8.5分钟</td>
</tr>
</tbody></table>
<h2 id="5-2-高并发场景性能测试"><a href="#5-2-高并发场景性能测试" class="headerlink" title="5.2 高并发场景性能测试"></a>5.2 高并发场景性能测试</h2><h3 id="5-2-1-并发查询性能"><a href="#5-2-1-并发查询性能" class="headerlink" title="5.2.1 并发查询性能"></a>5.2.1 并发查询性能</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testConcurrentQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">RoaringBitMapPhoneCache</span> cache <span class="token operator">=</span> <span class="token function">loadTestData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 加载2亿数据</span>
    
    <span class="token keyword">int</span> threadCount <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> queriesPerThread <span class="token operator">=</span> <span class="token number">100_000</span><span class="token punctuation">;</span>
    <span class="token class-name">ExecutorService</span> executor <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span>threadCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">CountDownLatch</span> latch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span>threadCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">AtomicLong</span> totalQueries <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">AtomicLong</span> totalTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> threadCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        executor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">long</span> threadStart <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> queriesPerThread<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">Long</span> phone <span class="token operator">=</span> <span class="token function">generateRandomPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    cache<span class="token punctuation">.</span><span class="token function">containsPhone</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    totalQueries<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                
                totalTime<span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> threadStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
                latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> endTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">long</span> totalDuration <span class="token operator">=</span> endTime <span class="token operator">-</span> startTime<span class="token punctuation">;</span>
    <span class="token keyword">long</span> queries <span class="token operator">=</span> totalQueries<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"=== 高并发查询性能测试结果 ==="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"并发线程数: "</span> <span class="token operator">+</span> threadCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"总查询次数: "</span> <span class="token operator">+</span> queries<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"总耗时: "</span> <span class="token operator">+</span> totalDuration <span class="token operator">+</span> <span class="token string">"ms"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"TPS: "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>queries <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">/</span> totalDuration<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"平均响应时间: "</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>totalTime<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> queries <span class="token operator">+</span> <span class="token string">"ms"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>高并发测试结果</strong>：</p>
<pre class="line-numbers language-none"><code class="language-none">&#x3D;&#x3D;&#x3D; 高并发查询性能测试结果 &#x3D;&#x3D;&#x3D;
并发线程数: 100
总查询次数: 10000000
总耗时: 95000ms
TPS: 105263
平均响应时间: 0.95ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="5-2-2-读写并发测试"><a href="#5-2-2-读写并发测试" class="headerlink" title="5.2.2 读写并发测试"></a>5.2.2 读写并发测试</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>  
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testReadWriteConcurrency</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ConcurrentBlacklistCache</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentBlacklistCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 预加载1亿数据</span>
    <span class="token function">loadInitialData</span><span class="token punctuation">(</span>cache<span class="token punctuation">,</span> <span class="token number">100_000_000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">int</span> readerThreads <span class="token operator">=</span> <span class="token number">80</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> writerThreads <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> testDuration <span class="token operator">=</span> <span class="token number">60000</span><span class="token punctuation">;</span> <span class="token comment">// 60秒</span>
    
    <span class="token class-name">ExecutorService</span> executor <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span>readerThreads <span class="token operator">+</span> writerThreads<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">AtomicLong</span> readCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">AtomicLong</span> writeCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">AtomicBoolean</span> running <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicBoolean</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 启动读线程</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> readerThreads<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        executor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>running<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                cache<span class="token punctuation">.</span><span class="token function">containsPhone</span><span class="token punctuation">(</span><span class="token function">generateRandomPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                readCount<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// 启动写线程</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> writerThreads<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        executor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>running<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                cache<span class="token punctuation">.</span><span class="token function">addPhone</span><span class="token punctuation">(</span><span class="token function">generateRandomPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                writeCount<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 模拟写操作相对较慢</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// 运行指定时间</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>testDuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
    running<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"=== 读写并发测试结果 ==="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"读操作TPS: "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>readCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">/</span> testDuration<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"写操作TPS: "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>writeCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">/</span> testDuration<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"读写比例: "</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>readCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> writeCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="5-3-数据结构内存效率对比"><a href="#5-3-数据结构内存效率对比" class="headerlink" title="5.3 数据结构内存效率对比"></a>5.3 数据结构内存效率对比</h2><h3 id="5-3-1-不同数据结构性能对比"><a href="#5-3-1-不同数据结构性能对比" class="headerlink" title="5.3.1 不同数据结构性能对比"></a>5.3.1 不同数据结构性能对比</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">compareDataStructures</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> dataSize <span class="token operator">=</span> <span class="token number">50_000_000</span><span class="token punctuation">;</span> <span class="token comment">// 5000万数据</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> testData <span class="token operator">=</span> <span class="token function">generatePhoneNumbers</span><span class="token punctuation">(</span>dataSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// HashMap测试</span>
    <span class="token keyword">long</span> startMem <span class="token operator">=</span> <span class="token function">getUsedMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">></span></span> hashMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    testData<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>phone <span class="token operator">-></span> hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>phone<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> hashMapMemory <span class="token operator">=</span> <span class="token function">getUsedMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startMem<span class="token punctuation">;</span>
    
    <span class="token comment">// HashSet测试  </span>
    startMem <span class="token operator">=</span> <span class="token function">getUsedMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> hashSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>testData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> hashSetMemory <span class="token operator">=</span> <span class="token function">getUsedMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startMem<span class="token punctuation">;</span>
    
    <span class="token comment">// RoaringBitmap测试</span>
    startMem <span class="token operator">=</span> <span class="token function">getUsedMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RoaringBitMapPhoneCache</span> roaringCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RoaringBitMapPhoneCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    testData<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>roaringCache<span class="token operator">::</span><span class="token function">putPhone</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> roaringMemory <span class="token operator">=</span> <span class="token function">getUsedMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startMem<span class="token punctuation">;</span>
    
    <span class="token comment">// 查询性能测试</span>
    <span class="token keyword">long</span> queries <span class="token operator">=</span> <span class="token number">1_000_000</span><span class="token punctuation">;</span>
    
    <span class="token keyword">long</span> hashMapTime <span class="token operator">=</span> <span class="token function">timeQueries</span><span class="token punctuation">(</span>hashMap<span class="token operator">::</span><span class="token function">containsKey</span><span class="token punctuation">,</span> testData<span class="token punctuation">,</span> queries<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> hashSetTime <span class="token operator">=</span> <span class="token function">timeQueries</span><span class="token punctuation">(</span>hashSet<span class="token operator">::</span><span class="token function">contains</span><span class="token punctuation">,</span> testData<span class="token punctuation">,</span> queries<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> roaringTime <span class="token operator">=</span> <span class="token function">timeQueries</span><span class="token punctuation">(</span>roaringCache<span class="token operator">::</span><span class="token function">containsPhone</span><span class="token punctuation">,</span> testData<span class="token punctuation">,</span> queries<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"=== 数据结构对比结果 (数据量: "</span> <span class="token operator">+</span> dataSize <span class="token operator">+</span> <span class="token string">") ==="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"内存对比:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"HashMap: %dMB\n"</span><span class="token punctuation">,</span> hashMapMemory <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"HashSet: %dMB\n"</span><span class="token punctuation">,</span> hashSetMemory <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"RoaringBitmap: %dMB\n"</span><span class="token punctuation">,</span> roaringMemory <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"压缩率: %.2f%%\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>roaringMemory <span class="token operator">/</span> hashMapMemory<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"查询性能对比 (100万次查询):"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"HashMap: %dms\n"</span><span class="token punctuation">,</span> hashMapTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"HashSet: %dms\n"</span><span class="token punctuation">,</span> hashSetTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"RoaringBitmap: %dms\n"</span><span class="token punctuation">,</span> roaringTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>对比测试结果</strong>：</p>
<pre class="line-numbers language-none"><code class="language-none">&#x3D;&#x3D;&#x3D; 数据结构对比结果 (数据量: 50000000) &#x3D;&#x3D;&#x3D;
内存对比:
HashMap: 2048MB
HashSet: 1536MB
RoaringBitmap: 12MB
压缩率: 99.41%

查询性能对比 (100万次查询):
HashMap: 850ms
HashSet: 720ms
RoaringBitmap: 420ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="5-3-2-核心性能指标总结"><a href="#5-3-2-核心性能指标总结" class="headerlink" title="5.3.2 核心性能指标总结"></a>5.3.2 核心性能指标总结</h3><p>在2亿数据规模下，RoaringBitmap方案的核心性能指标：</p>
<table>
<thead>
<tr>
<th>性能指标</th>
<th>RoaringBitmap方案</th>
<th>HashMap方案</th>
<th>改进效果</th>
</tr>
</thead>
<tbody><tr>
<td><strong>内存占用</strong></td>
<td><strong>48MB</strong></td>
<td>4GB</td>
<td><strong>减少98.8%</strong></td>
</tr>
<tr>
<td><strong>加载耗时</strong></td>
<td><strong>125s</strong></td>
<td>450s</td>
<td><strong>提升72%</strong></td>
</tr>
<tr>
<td><strong>查询TPS</strong></td>
<td><strong>105,263</strong></td>
<td>65,000</td>
<td><strong>提升62%</strong></td>
</tr>
<tr>
<td><strong>平均查询时间</strong></td>
<td><strong>0.95ms</strong></td>
<td>2.8ms</td>
<td><strong>提升66%</strong></td>
</tr>
<tr>
<td><strong>GC次数(小时)</strong></td>
<td><strong>&lt;5次</strong></td>
<td>200+次</td>
<td><strong>减少97.5%</strong></td>
</tr>
<tr>
<td><strong>GC停顿时间</strong></td>
<td><strong>&lt;10ms</strong></td>
<td>200ms+</td>
<td><strong>减少95%</strong></td>
</tr>
</tbody></table>
<h1 id="六、系统集成与部署"><a href="#六、系统集成与部署" class="headerlink" title="六、系统集成与部署"></a>六、系统集成与部署</h1><h2 id="6-1-Maven依赖配置"><a href="#6-1-Maven依赖配置" class="headerlink" title="6.1 Maven依赖配置"></a>6.1 Maven依赖配置</h2><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- RoaringBitmap核心依赖 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.roaringbitmap<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>RoaringBitmap<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>0.9.32<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

<span class="token comment">&lt;!-- Spring Boot Starter --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.7.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

<span class="token comment">&lt;!-- Redis集群支持 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.7.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="6-2-应用配置文件"><a href="#6-2-应用配置文件" class="headerlink" title="6.2 应用配置文件"></a>6.2 应用配置文件</h2><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># application.yml</span>
<span class="token key atrule">blacklist</span><span class="token punctuation">:</span>
  <span class="token key atrule">roaring-bitmap</span><span class="token punctuation">:</span>
    <span class="token comment"># 初始化容量</span>
    <span class="token key atrule">init-capacity</span><span class="token punctuation">:</span> <span class="token number">1000</span>
    <span class="token comment"># 负载因子</span>
    <span class="token key atrule">load-factor</span><span class="token punctuation">:</span> <span class="token number">0.5</span>
    <span class="token comment"># 是否启用本地缓存</span>
    <span class="token key atrule">enable-local-cache</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># 缓存同步间隔(秒)</span>
    <span class="token key atrule">sync-interval</span><span class="token punctuation">:</span> <span class="token number">60</span>
    <span class="token comment"># 版本校验间隔(秒)</span>
    <span class="token key atrule">version-check-interval</span><span class="token punctuation">:</span> <span class="token number">30</span>
    
<span class="token key atrule">redis</span><span class="token punctuation">:</span>
  <span class="token key atrule">cluster</span><span class="token punctuation">:</span>
    <span class="token key atrule">nodes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 192.168.1.10<span class="token punctuation">:</span><span class="token number">7000</span>
      <span class="token punctuation">-</span> 192.168.1.10<span class="token punctuation">:</span><span class="token number">7001</span>
      <span class="token punctuation">-</span> 192.168.1.11<span class="token punctuation">:</span><span class="token number">7000</span>
      <span class="token punctuation">-</span> 192.168.1.11<span class="token punctuation">:</span><span class="token number">7001</span>
      <span class="token punctuation">-</span> 192.168.1.12<span class="token punctuation">:</span><span class="token number">7000</span>
      <span class="token punctuation">-</span> 192.168.1.12<span class="token punctuation">:</span><span class="token number">7001</span>
    <span class="token key atrule">max-redirects</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">3000</span>
  <span class="token key atrule">pool</span><span class="token punctuation">:</span>
    <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">100</span>
    <span class="token key atrule">max-idle</span><span class="token punctuation">:</span> <span class="token number">20</span>
    <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="6-3-黑名单服务封装"><a href="#6-3-黑名单服务封装" class="headerlink" title="6.3 黑名单服务封装"></a>6.3 黑名单服务封装</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BlacklistCacheService</span> <span class="token punctuation">&#123;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RoaringBitMapPhoneCache</span> localCache<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> redisTemplate<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token class-name">BlacklistCacheService</span><span class="token punctuation">(</span><span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> redisTemplate<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>redisTemplate <span class="token operator">=</span> redisTemplate<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>localCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RoaringBitMapPhoneCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 初始化本地缓存</span>
        <span class="token function">initLocalCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">/**
     * 检查手机号是否在黑名单中
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isBlacklisted</span><span class="token punctuation">(</span><span class="token class-name">Long</span> phone<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 1. 先查本地缓存</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>localCache<span class="token punctuation">.</span><span class="token function">containsPhone</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token comment">// 2. 本地缓存未命中，查询Redis</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">"blacklist:"</span> <span class="token operator">+</span> phone<span class="token punctuation">;</span>
        <span class="token class-name">Boolean</span> exists <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">hasKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>exists<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 更新本地缓存</span>
            localCache<span class="token punctuation">.</span><span class="token function">putPhone</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">/**
     * 批量检查手机号
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> <span class="token function">filterBlacklisted</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> phones<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> phones<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">isBlacklisted</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">/**
     * 添加手机号到黑名单
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addToBlacklist</span><span class="token punctuation">(</span><span class="token class-name">Long</span> phone<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 1. 更新Redis</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">"blacklist:"</span> <span class="token operator">+</span> phone<span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 2. 更新本地缓存</span>
        localCache<span class="token punctuation">.</span><span class="token function">putPhone</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 3. 更新版本号</span>
        <span class="token function">updateVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">/**
     * 从黑名单移除手机号
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">removeFromBlacklist</span><span class="token punctuation">(</span><span class="token class-name">Long</span> phone<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 1. 从 Redis 移除</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">"blacklist:"</span> <span class="token operator">+</span> phone<span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 2. 重新加载本地缓存（简化处理）</span>
        <span class="token function">reloadLocalCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 3. 更新版本号</span>
        <span class="token function">updateVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">/**
     * 初始化本地缓存
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initLocalCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"开始初始化本地黑名单缓存..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 从数据库批量加载黑名单数据</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> blacklistPhones <span class="token operator">=</span> blacklistDao<span class="token punctuation">.</span><span class="token function">getAllBlacklistPhones</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        blacklistPhones<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>localCache<span class="token operator">::</span><span class="token function">putPhone</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"本地黑名单缓存初始化完成，共加载 &#123;&#125; 条数据"</span><span class="token punctuation">,</span> localCache<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">/**
     * 更新版本号
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Long</span> newVersion <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"blacklist:version"</span><span class="token punctuation">,</span> newVersion<span class="token punctuation">)</span><span class="token punctuation">;</span>
        localCache<span class="token punctuation">.</span><span class="token function">setLocalVersion</span><span class="token punctuation">(</span>newVersion<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">/**
     * 重新加载本地缓存
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">reloadLocalCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        localCache<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">initLocalCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="6-4-数据同步机制"><a href="#6-4-数据同步机制" class="headerlink" title="6.4 数据同步机制"></a>6.4 数据同步机制</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BlacklistSyncTask</span> <span class="token punctuation">&#123;</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">BlacklistCacheService</span> cacheService<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">BlacklistDao</span> blacklistDao<span class="token punctuation">;</span>
    
    <span class="token comment">/**
     * 定时同步任务
     */</span>
    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>fixedDelay <span class="token operator">=</span> <span class="token number">60000</span><span class="token punctuation">)</span> <span class="token comment">// 60秒执行一次</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">syncBlacklistData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Long</span> currentVersion <span class="token operator">=</span> <span class="token function">getCurrentVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Long</span> localVersion <span class="token operator">=</span> cacheService<span class="token punctuation">.</span><span class="token function">getLocalVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">if</span> <span class="token punctuation">(</span>currentVersion <span class="token operator">></span> localVersion<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"检测到数据更新，当前版本: &#123;&#125;, 本地版本: &#123;&#125;"</span><span class="token punctuation">,</span> 
                    currentVersion<span class="token punctuation">,</span> localVersion<span class="token punctuation">)</span><span class="token punctuation">;</span>
                
                <span class="token comment">// 增量同步数据</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> newPhones <span class="token operator">=</span> blacklistDao<span class="token punctuation">.</span><span class="token function">getPhonesSinceVersion</span><span class="token punctuation">(</span>localVersion<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Long</span> phone <span class="token operator">:</span> newPhones<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    cacheService<span class="token punctuation">.</span><span class="token function">addToBlacklist</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                
                <span class="token comment">// 更新本地版本号</span>
                cacheService<span class="token punctuation">.</span><span class="token function">setLocalVersion</span><span class="token punctuation">(</span>currentVersion<span class="token punctuation">)</span><span class="token punctuation">;</span>
                
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"数据同步完成，新增 &#123;&#125; 条数据"</span><span class="token punctuation">,</span> newPhones<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"黑名单数据同步失败"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">private</span> <span class="token class-name">Long</span> <span class="token function">getCurrentVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> blacklistDao<span class="token punctuation">.</span><span class="token function">getCurrentVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="七、总结与展望"><a href="#七、总结与展望" class="headerlink" title="七、总结与展望"></a>七、总结与展望</h1><p>本文介绍了在10万TPS高并发场景下，使用RoaringBitmap实现2亿级黑名单过滤系统的技术方案。</p>
<h2 id="7-1-核心技术要点"><a href="#7-1-核心技术要点" class="headerlink" title="7.1 核心技术要点"></a>7.1 核心技术要点</h2><h3 id="7-1-1-性能提升效果"><a href="#7-1-1-性能提升效果" class="headerlink" title="7.1.1 性能提升效果"></a>7.1.1 性能提升效果</h3><table>
<thead>
<tr>
<th>技术指标</th>
<th>传统方案</th>
<th>RoaringBitmap方案</th>
<th>改进效果</th>
</tr>
</thead>
<tbody><tr>
<td><strong>内存占用</strong></td>
<td>4GB (HashMap)</td>
<td>48MB</td>
<td><strong>减少98.8%</strong></td>
</tr>
<tr>
<td><strong>查询TPS</strong></td>
<td>65,000</td>
<td>105,263</td>
<td><strong>提升62%</strong></td>
</tr>
<tr>
<td><strong>平均响应时间</strong></td>
<td>2.8ms</td>
<td>0.95ms</td>
<td><strong>提升66%</strong></td>
</tr>
<tr>
<td><strong>GC停顿时间</strong></td>
<td>200ms+</td>
<td>&lt;10ms</td>
<td><strong>减少95%</strong></td>
</tr>
</tbody></table>
<h3 id="7-1-2-关键技术特性"><a href="#7-1-2-关键技术特性" class="headerlink" title="7.1.2 关键技术特性"></a>7.1.2 关键技术特性</h3><div class="note success no-icon flat"><ul>
<li><strong>智能压缩</strong>：自适应选择最优存储结构（ArrayContainer&#x2F;BitmapContainer&#x2F;RunContainer），实现99.88%压缩率</li>
<li><strong>手机号分割</strong>：9位分割策略利用号段局部性，提高压缩效率和查询性能</li>
<li><strong>并发优化</strong>：读写锁分离，支持高并发读操作，保证线程安全</li>
<li><strong>分片存储</strong>：基于运营商号段的分片策略，支持水平扩展</li>
</ul>
</div>

<h2 id="7-2-应用价值"><a href="#7-2-应用价值" class="headerlink" title="7.2 应用价值"></a>7.2 应用价值</h2><p>通过RoaringBitmap的成功实践，在2亿级数据规模下实现了极致的内存压缩和高性能查询。该方案：</p>
<ul>
<li><strong>降低75%硬件成本</strong>：内存从32GB降至8GB</li>
<li><strong>TPS提升62%</strong>：从6.5万提升10.5万</li>
<li><strong>响应时间优升66%</strong>：从2.8ms降至0.95ms</li>
<li><strong>GC停顿减少95%</strong>：从200ms+降至&lt;10ms</li>
</ul>
<p>为大规模数据过滤场景提供了可复制的高性能技术方案。 </p>
]]></content>
      <categories>
        <category>分布式</category>
      </categories>
      <tags>
        <tag>高并发</tag>
        <tag>10万TPS</tag>
        <tag>黑名单过滤</tag>
        <tag>RoaringBitmap</tag>
        <tag>性能优化</tag>
      </tags>
  </entry>
  <entry>
    <title>10万TPS级消息发送管控平台架构设计与项目落地实践</title>
    <url>/2024/06/01/high-concurrency/10-wan-tps-ji-gao-bing-fa-xi-tong-jia-gou-she-ji-yu-xiang-mu-luo-di-shi-jian/</url>
    <content><![CDATA[<h1 id="一、背景简介"><a href="#一、背景简介" class="headerlink" title="一、背景简介"></a>一、背景简介</h1><p>项目需要设计一个高并发的消息发送管控平台，实现业务消息发送安全管控。业务要求所有下发内容需要调用安全管控平台安全审核接口进行安全审核，根据管控策略进行放通、拦截及人工审核。目前线上日发送量峰值为30亿条左右，发送平均速度为3.47万条&#x2F;秒,消息发送管控平台接口的TPS需要达到10万级别。</p>
<h2 id="1-1-管控策略"><a href="#1-1-管控策略" class="headerlink" title="1.1 管控策略"></a>1.1 管控策略</h2><p>基于业务需求管控平台提供管控能力及管控策略配置，平台部分管控功能如下：</p>
<ul>
<li>消息发送频次管控</li>
<li>重复内容发送管控</li>
<li>关键字匹配过滤</li>
<li>发送黑名单过滤</li>
</ul>
<h1 id="二、架构设计"><a href="#二、架构设计" class="headerlink" title="二、架构设计"></a>二、架构设计</h1><p>根据业务系统要求，管控平台安全审核接口需要实现10万tps，请求处理耗时在50ms以内。</p>
<h2 id="2-1-业务架构图"><a href="#2-1-业务架构图" class="headerlink" title="2.1 业务架构图"></a>2.1 业务架构图</h2><p><img src="/2024/06/01/high-concurrency/10-wan-tps-ji-gao-bing-fa-xi-tong-jia-gou-she-ji-yu-xiang-mu-luo-di-shi-jian/%E7%AE%A1%E6%8E%A7%E5%B9%B3%E5%8F%B0%E4%B8%9A%E5%8A%A1%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="业务架构图"><br>安全管控平台业务架构较为简单，包含3个核心模块：</p>
<ul>
<li><strong>管控后台</strong>：用于管理管控相关数据及查看、审核被管控的消息记录</li>
<li><strong>网管管控API</strong>：提供统一安全管控接口，根据平台的管控策略要求，对下发消息进行审核管控</li>
<li><strong>审核回调</strong>：用于向业务平台推送人工审核结果及相关变更数据</li>
</ul>
<h2 id="2-2-部署架构图"><a href="#2-2-部署架构图" class="headerlink" title="2.2 部署架构图"></a>2.2 部署架构图</h2><p><img src="/2024/06/01/high-concurrency/10-wan-tps-ji-gao-bing-fa-xi-tong-jia-gou-she-ji-yu-xiang-mu-luo-di-shi-jian/%E7%AE%A1%E6%8E%A7%E5%B9%B3%E5%8F%B0%E9%83%A8%E7%BD%B2%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="部署架构图"><br>上图为管控平台的部署架构图，Redis集群和MySQL数据库使用华为云的服务，应用模块均实现集群化部署：</p>
<ul>
<li><strong>管控后台</strong>：基于Redis实现分布式Session，采用集群化部署方式，并通过ELB负载均衡实现高可用</li>
<li><strong>网管管控API</strong>：采用集群化部署，通过ELB进行负载均衡；默认集群为15个节点，支持10万TPS</li>
<li><strong>审核回调</strong>：基于Redis实现分布式锁，采用集群化部署实现审核回调高可用</li>
</ul>
<h1 id="三、服务器规格"><a href="#三、服务器规格" class="headerlink" title="三、服务器规格"></a>三、服务器规格</h1><p>内容管控平台使用容器化部署方式部署在华为云上，使用的服务器规格如下：</p>
<table>
<thead>
<tr>
<th>应用名称</th>
<th>服务器规格</th>
<th>数量</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>管控后台</td>
<td>8核&#x2F;16GB&#x2F;磁盘 500G</td>
<td>2</td>
<td>集群部署</td>
</tr>
<tr>
<td>管控服务API</td>
<td>16核&#x2F;32GB&#x2F;磁盘高IO 500G</td>
<td>15</td>
<td>集群部署</td>
</tr>
<tr>
<td>MySQL数据库</td>
<td>16核&#x2F;32GB&#x2F;磁盘超高IO 1TB</td>
<td>2</td>
<td>主从</td>
</tr>
<tr>
<td>Redis集群</td>
<td>256G&#x2F;32分片</td>
<td>32</td>
<td>华为云Redis集群</td>
</tr>
<tr>
<td>弹性负载均衡</td>
<td>中型II&#x2F;500M带宽</td>
<td>1</td>
<td>华为云ELB</td>
</tr>
</tbody></table>
<h2 id="3-1-Redis集群规格"><a href="#3-1-Redis集群规格" class="headerlink" title="3.1 Redis集群规格"></a>3.1 Redis集群规格</h2><p><font color="red">说明：原Redis使用主备实例64G内存规格，但是由于每次请求至少访问2次Redis，在10万TPS情况下，Redis成为性能瓶颈，所以调整为Redis集群，详细说明见后续文档。</font><br><img src="/2024/06/01/high-concurrency/10-wan-tps-ji-gao-bing-fa-xi-tong-jia-gou-she-ji-yu-xiang-mu-luo-di-shi-jian/redis%E9%9B%86%E7%BE%A4%E8%A7%84%E6%A0%BC.png" alt="Redis集群规格"></p>
<h2 id="3-2-弹性负载均衡规格"><a href="#3-2-弹性负载均衡规格" class="headerlink" title="3.2 弹性负载均衡规格"></a>3.2 弹性负载均衡规格</h2><p><font color="red">说明： 华为云ELB（弹性负载均衡）中型II默认带宽为400M，管控服务http请求TPS到达10W后带宽将突破500M，需要联系管理员增加带宽至500M以上。</font><br><img src="/2024/06/01/high-concurrency/10-wan-tps-ji-gao-bing-fa-xi-tong-jia-gou-she-ji-yu-xiang-mu-luo-di-shi-jian/elb%E8%A7%84%E6%A0%BC.png" alt="elb规格"></p>
<h1 id="四、性能压测"><a href="#四、性能压测" class="headerlink" title="四、性能压测"></a>四、性能压测</h1><p><font color="red">说明：本截图为4000并发下的压测结果，将并发设置为5000后TPS可以达到10W。由于压测客户端设置的最大并发为10W，所以压测结果的最大值不会超过10W。</font><br><img src="/2024/06/01/high-concurrency/10-wan-tps-ji-gao-bing-fa-xi-tong-jia-gou-she-ji-yu-xiang-mu-luo-di-shi-jian/%E5%8E%8B%E6%B5%8B%E7%BB%93%E6%9E%9C.jpg" alt="压测结果"></p>
]]></content>
      <categories>
        <category>分布式</category>
      </categories>
      <tags>
        <tag>高并发</tag>
        <tag>10万TPS</tag>
        <tag>架构设计</tag>
      </tags>
  </entry>
  <entry>
    <title>10万TPS级高并发系统——性能压测与优化</title>
    <url>/2024/06/08/high-concurrency/10-wan-tps-ji-gao-bing-fa-xi-tong-xing-neng-ya-ce-yu-you-hua/</url>
    <content><![CDATA[<h2 id="一、压测准备"><a href="#一、压测准备" class="headerlink" title="一、压测准备"></a>一、压测准备</h2><h3 id="1-1-系统背景"><a href="#1-1-系统背景" class="headerlink" title="1.1 系统背景"></a>1.1 系统背景</h3><p>消息发送管控平台需要支持10万TPS的接口调用，要求单次请求处理耗时在50ms以内。系统采用集群化部署，通过弹性负载均衡实现高可用和性能扩展。</p>
<p><strong>核心技术指标</strong>：</p>
<ul>
<li>目标TPS：10万</li>
<li>响应时间：≤50ms</li>
<li>日发送量：30亿条</li>
<li>平均发送速度：3.47万条&#x2F;秒</li>
</ul>
<h3 id="1-2-压测环境"><a href="#1-2-压测环境" class="headerlink" title="1.2 压测环境"></a>1.2 压测环境</h3><table>
<thead>
<tr>
<th>组件</th>
<th>规格配置</th>
<th>数量</th>
</tr>
</thead>
<tbody><tr>
<td>管控API服务</td>
<td>16核&#x2F;32GB&#x2F;500G高IO</td>
<td>15节点</td>
</tr>
<tr>
<td>Redis集群</td>
<td>256G&#x2F;32分片</td>
<td>32实例</td>
</tr>
<tr>
<td>MySQL数据库</td>
<td>16核&#x2F;32GB&#x2F;1TB超高IO</td>
<td>主从</td>
</tr>
<tr>
<td>负载均衡器</td>
<td>中型II&#x2F;500M带宽</td>
<td>1台</td>
</tr>
<tr>
<td>压测客户端</td>
<td>8核&#x2F;16GB</td>
<td>3台</td>
</tr>
</tbody></table>
<h3 id="1-3-压测工具选型"><a href="#1-3-压测工具选型" class="headerlink" title="1.3 压测工具选型"></a>1.3 压测工具选型</h3><p>选用 <strong>JMeter</strong> 作为压测工具：</p>
<ul>
<li>支持高并发场景</li>
<li>可视化报表</li>
<li>分布式压测</li>
<li>插件丰富</li>
</ul>
<h2 id="二、压测方案设计"><a href="#二、压测方案设计" class="headerlink" title="二、压测方案设计"></a>二、压测方案设计</h2><h3 id="2-1-压测场景"><a href="#2-1-压测场景" class="headerlink" title="2.1 压测场景"></a>2.1 压测场景</h3><p><strong>场景一：基础功能压测</strong></p>
<ul>
<li>并发用户数：1000 → 3000 → 5000</li>
<li>持续时间：每阶段10分钟</li>
<li>目标：验证基础性能</li>
</ul>
<p><strong>场景二：峰值压测</strong></p>
<ul>
<li>并发用户数：5000</li>
<li>持续时间：30分钟</li>
<li>目标：验证10万TPS目标</li>
</ul>
<p><strong>场景三：稳定性压测</strong></p>
<ul>
<li>并发用户数：4000</li>
<li>持续时间：2小时</li>
<li>目标：验证系统稳定性</li>
</ul>
<h3 id="2-2-监控指标"><a href="#2-2-监控指标" class="headerlink" title="2.2 监控指标"></a>2.2 监控指标</h3><p><strong>应用层指标</strong>：</p>
<ul>
<li>TPS（每秒事务数）</li>
<li>响应时间（平均&#x2F;P95&#x2F;P99）</li>
<li>错误率</li>
<li>并发连接数</li>
</ul>
<p><strong>系统层指标</strong>：</p>
<ul>
<li>CPU使用率</li>
<li>内存使用率</li>
<li>网络带宽</li>
<li>磁盘IO</li>
</ul>
<p><strong>中间件指标</strong>：</p>
<ul>
<li>Redis QPS</li>
<li>MySQL连接数</li>
<li>负载均衡器吞吐量</li>
</ul>
<h2 id="三、压测过程与问题"><a href="#三、压测过程与问题" class="headerlink" title="三、压测过程与问题"></a>三、压测过程与问题</h2><h3 id="3-1-第一轮压测（并发1000）"><a href="#3-1-第一轮压测（并发1000）" class="headerlink" title="3.1 第一轮压测（并发1000）"></a>3.1 第一轮压测（并发1000）</h3><p><strong>压测结果</strong>：</p>
<pre class="line-numbers language-none"><code class="language-none">TPS: 2.8万
平均响应时间: 35ms
P95响应时间: 48ms
错误率: 0%
CPU使用率: 45%<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>结论</strong>：基础性能正常，继续提升并发</p>
<h3 id="3-2-第二轮压测（并发3000）"><a href="#3-2-第二轮压测（并发3000）" class="headerlink" title="3.2 第二轮压测（并发3000）"></a>3.2 第二轮压测（并发3000）</h3><p><strong>压测结果</strong>：</p>
<pre class="line-numbers language-none"><code class="language-none">TPS: 6.5万
平均响应时间: 45ms
P95响应时间: 78ms
错误率: 0.1%<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>发现问题</strong>：</p>
<ol>
<li>Redis连接池耗尽，出现超时</li>
<li>部分节点CPU使用率达到85%</li>
<li>响应时间P95超过预期</li>
</ol>
<h3 id="3-3-第三轮压测（并发5000）"><a href="#3-3-第三轮压测（并发5000）" class="headerlink" title="3.3 第三轮压测（并发5000）"></a>3.3 第三轮压测（并发5000）</h3><p><strong>压测结果</strong>：</p>
<pre class="line-numbers language-none"><code class="language-none">TPS: 8.2万
平均响应时间: 58ms
P95响应时间: 120ms
错误率: 2.3%
Redis QPS: 16万<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>发现问题</strong>：</p>
<ol>
<li><strong>Redis成为瓶颈</strong>：主备实例64G内存无法支撑</li>
<li><strong>网络带宽不足</strong>：ELB带宽400M接近饱和</li>
<li><strong>GC频繁</strong>：Young GC每秒触发2-3次</li>
</ol>
<h2 id="四、性能优化实践"><a href="#四、性能优化实践" class="headerlink" title="四、性能优化实践"></a>四、性能优化实践</h2><h3 id="4-1-Redis集群升级"><a href="#4-1-Redis集群升级" class="headerlink" title="4.1 Redis集群升级"></a>4.1 Redis集群升级</h3><p><strong>问题分析</strong>：</p>
<ul>
<li>每次请求至少访问2次Redis</li>
<li>10万TPS下Redis QPS达到20万</li>
<li>单实例无法支撑高并发读写</li>
</ul>
<p><strong>优化方案</strong>：</p>
<ul>
<li>升级为Redis集群（32分片&#x2F;256G）</li>
<li>水平扩展读写能力</li>
<li>数据分片降低单节点压力</li>
</ul>
<p><strong>优化效果</strong>：</p>
<pre class="line-numbers language-none"><code class="language-none">Redis QPS支持: 20万+ → 100万+
Redis响应时间: 5-8ms → 1-3ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="4-2-负载均衡器优化"><a href="#4-2-负载均衡器优化" class="headerlink" title="4.2 负载均衡器优化"></a>4.2 负载均衡器优化</h3><p><strong>问题分析</strong>：</p>
<ul>
<li>中型II默认带宽400M</li>
<li>10万TPS下带宽需求超过500M</li>
</ul>
<p><strong>优化方案</strong>：</p>
<ul>
<li>升级带宽至600M</li>
<li>调整负载均衡算法为加权轮询</li>
<li>启用会话保持</li>
</ul>
<p><strong>优化效果</strong>：</p>
<pre class="line-numbers language-none"><code class="language-none">带宽瓶颈消除
请求分发更均衡<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="4-3-JVM参数调优"><a href="#4-3-JVM参数调优" class="headerlink" title="4.3 JVM参数调优"></a>4.3 JVM参数调优</h3><p><strong>问题分析</strong>：</p>
<ul>
<li>堆内存16G配置不合理</li>
<li>Young GC频繁触发</li>
<li>Full GC偶发</li>
</ul>
<p><strong>优化方案</strong>：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">-Xms24G</span> <span class="token parameter variable">-Xmx24G</span>
<span class="token parameter variable">-Xmn12G</span>
<span class="token parameter variable">-XX:+UseG1GC</span>
<span class="token parameter variable">-XX:MaxGCPauseMillis</span><span class="token operator">=</span><span class="token number">50</span>
<span class="token parameter variable">-XX:G1ReservePercent</span><span class="token operator">=</span><span class="token number">10</span>
<span class="token parameter variable">-XX:InitiatingHeapOccupancyPercent</span><span class="token operator">=</span><span class="token number">45</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>优化效果</strong>：</p>
<pre class="line-numbers language-none"><code class="language-none">Young GC频率: 2-3次&#x2F;秒 → 0.5次&#x2F;秒
GC暂停时间: 20-30ms → 10-15ms
Full GC: 偶发 → 未出现<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="4-4-连接池优化"><a href="#4-4-连接池优化" class="headerlink" title="4.4 连接池优化"></a>4.4 连接池优化</h3><p><strong>Redis连接池配置</strong>：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">jedis</span><span class="token punctuation">:</span>
  <span class="token key atrule">pool</span><span class="token punctuation">:</span>
    <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">500</span>    <span class="token comment"># 最大连接数</span>
    <span class="token key atrule">max-idle</span><span class="token punctuation">:</span> <span class="token number">300</span>      <span class="token comment"># 最大空闲连接</span>
    <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">100</span>      <span class="token comment"># 最小空闲连接</span>
    <span class="token key atrule">max-wait</span><span class="token punctuation">:</span> <span class="token number">3000</span>     <span class="token comment"># 最大等待时间(ms)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>MySQL连接池配置</strong>：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">datasource</span><span class="token punctuation">:</span>
  <span class="token key atrule">hikari</span><span class="token punctuation">:</span>
    <span class="token key atrule">maximum-pool-size</span><span class="token punctuation">:</span> <span class="token number">100</span>
    <span class="token key atrule">minimum-idle</span><span class="token punctuation">:</span> <span class="token number">50</span>
    <span class="token key atrule">connection-timeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
    <span class="token key atrule">idle-timeout</span><span class="token punctuation">:</span> <span class="token number">600000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-5-应用层优化"><a href="#4-5-应用层优化" class="headerlink" title="4.5 应用层优化"></a>4.5 应用层优化</h3><p><strong>1. 缓存预热</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">preloadCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 预加载热点数据</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Keyword</span><span class="token punctuation">></span></span> keywords <span class="token operator">=</span> keywordService<span class="token punctuation">.</span><span class="token function">getAllKeywords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    keywords<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>k <span class="token operator">-></span> redisCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>2. 异步处理</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 非核心逻辑异步化</span>
<span class="token annotation punctuation">@Async</span><span class="token punctuation">(</span><span class="token string">"taskExecutor"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">recordAuditLog</span><span class="token punctuation">(</span><span class="token class-name">AuditLog</span> log<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    auditLogRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>3. 批量操作</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// Redis批量获取</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> keys <span class="token operator">=</span> <span class="token function">buildKeys</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> values <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiGet</span><span class="token punctuation">(</span>keys<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="五、优化后压测结果"><a href="#五、优化后压测结果" class="headerlink" title="五、优化后压测结果"></a>五、优化后压测结果</h2><h3 id="5-1-峰值压测（并发5000）"><a href="#5-1-峰值压测（并发5000）" class="headerlink" title="5.1 峰值压测（并发5000）"></a>5.1 峰值压测（并发5000）</h3><p><strong>压测数据</strong>：</p>
<pre class="line-numbers language-none"><code class="language-none">测试时长: 30分钟
总请求数: 1.8亿次
TPS: 10.2万
平均响应时间: 42ms
P95响应时间: 58ms
P99响应时间: 75ms
错误率: 0.02%<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>资源使用情况</strong>：</p>
<pre class="line-numbers language-none"><code class="language-none">API服务CPU: 65-75%
API服务内存: 18-20G
Redis QPS: 20.5万
Redis内存: 45%
MySQL连接数: 平均80
ELB带宽: 480-520M<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="5-2-稳定性压测（并发4000）"><a href="#5-2-稳定性压测（并发4000）" class="headerlink" title="5.2 稳定性压测（并发4000）"></a>5.2 稳定性压测（并发4000）</h3><p><strong>压测数据</strong>：</p>
<pre class="line-numbers language-none"><code class="language-none">测试时长: 2小时
总请求数: 28.8亿次
TPS: 8万
平均响应时间: 38ms
P95响应时间: 52ms
错误率: 0.01%<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>稳定性指标</strong>：</p>
<ul>
<li>无内存泄漏</li>
<li>GC稳定</li>
<li>无连接池耗尽</li>
<li>响应时间波动&lt;5ms</li>
</ul>
<h2 id="六、性能调优总结"><a href="#六、性能调优总结" class="headerlink" title="六、性能调优总结"></a>六、性能调优总结</h2><h3 id="6-1-优化效果对比"><a href="#6-1-优化效果对比" class="headerlink" title="6.1 优化效果对比"></a>6.1 优化效果对比</h3><table>
<thead>
<tr>
<th>指标</th>
<th>优化前</th>
<th>优化后</th>
<th>提升</th>
</tr>
</thead>
<tbody><tr>
<td>TPS</td>
<td>8.2万</td>
<td>10.2万</td>
<td>+24%</td>
</tr>
<tr>
<td>平均响应时间</td>
<td>58ms</td>
<td>42ms</td>
<td>-27%</td>
</tr>
<tr>
<td>P95响应时间</td>
<td>120ms</td>
<td>58ms</td>
<td>-52%</td>
</tr>
<tr>
<td>错误率</td>
<td>2.3%</td>
<td>0.02%</td>
<td>-99%</td>
</tr>
<tr>
<td>GC频率</td>
<td>2-3次&#x2F;秒</td>
<td>0.5次&#x2F;秒</td>
<td>-75%</td>
</tr>
</tbody></table>
<h3 id="6-2-关键优化点"><a href="#6-2-关键优化点" class="headerlink" title="6.2 关键优化点"></a>6.2 关键优化点</h3><p><strong>架构层面</strong>：</p>
<ol>
<li>Redis单实例→集群，解决读写瓶颈</li>
<li>ELB带宽扩容，消除网络限制</li>
<li>集群节点数量合理配置</li>
</ol>
<p><strong>应用层面</strong>：</p>
<ol>
<li>JVM参数精细化调优</li>
<li>连接池合理配置</li>
<li>缓存预热减少冷启动影响</li>
<li>异步化非核心逻辑</li>
</ol>
<p><strong>监控层面</strong>：</p>
<ol>
<li>全链路监控覆盖</li>
<li>关键指标实时告警</li>
<li>压测数据持续收集</li>
</ol>
<h3 id="6-3-压测经验"><a href="#6-3-压测经验" class="headerlink" title="6.3 压测经验"></a>6.3 压测经验</h3><p><strong>1. 渐进式压测</strong></p>
<ul>
<li>从低并发开始逐步提升</li>
<li>每个阶段充分验证</li>
<li>及时发现性能瓶颈</li>
</ul>
<p><strong>2. 全面监控</strong></p>
<ul>
<li>应用、系统、中间件指标齐全</li>
<li>实时监控压测过程</li>
<li>保留压测数据用于分析</li>
</ul>
<p><strong>3. 问题定位</strong></p>
<ul>
<li>结合日志、监控定位问题</li>
<li>使用性能分析工具（JProfiler等）</li>
<li>必要时进行线程dump分析</li>
</ul>
<p><strong>4. 持续优化</strong></p>
<ul>
<li>压测→优化→再压测</li>
<li>建立性能基线</li>
<li>定期回归测试</li>
</ul>
<h2 id="七、生产环境表现"><a href="#七、生产环境表现" class="headerlink" title="七、生产环境表现"></a>七、生产环境表现</h2><h3 id="7-1-真实流量验证"><a href="#7-1-真实流量验证" class="headerlink" title="7.1 真实流量验证"></a>7.1 真实流量验证</h3><p><strong>日常运行数据</strong>（上线后一个月）：</p>
<pre class="line-numbers language-none"><code class="language-none">日均请求量: 28亿次
峰值TPS: 9.8万
平均响应时间: 35ms
P99响应时间: 68ms
可用性: 99.99%<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="7-2-大促期间表现"><a href="#7-2-大促期间表现" class="headerlink" title="7.2 大促期间表现"></a>7.2 大促期间表现</h3><p><strong>618活动期间</strong>：</p>
<pre class="line-numbers language-none"><code class="language-none">峰值TPS: 10.5万
持续时长: 4小时
平均响应时间: 43ms
错误率: 0.01%
系统稳定运行<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="八、最佳实践建议"><a href="#八、最佳实践建议" class="headerlink" title="八、最佳实践建议"></a>八、最佳实践建议</h2><h3 id="8-1-容量规划"><a href="#8-1-容量规划" class="headerlink" title="8.1 容量规划"></a>8.1 容量规划</h3><ul>
<li>按峰值TPS的1.5-2倍规划容量</li>
<li>预留30%性能buffer</li>
<li>关键组件支持水平扩展</li>
</ul>
<h3 id="8-2-监控告警"><a href="#8-2-监控告警" class="headerlink" title="8.2 监控告警"></a>8.2 监控告警</h3><ul>
<li>TPS超过8万时告警</li>
<li>响应时间P95&gt;60ms告警</li>
<li>错误率&gt;0.1%告警</li>
<li>资源使用率&gt;80%告警</li>
</ul>
<h3 id="8-3-应急预案"><a href="#8-3-应急预案" class="headerlink" title="8.3 应急预案"></a>8.3 应急预案</h3><ul>
<li>限流降级策略</li>
<li>快速扩容方案</li>
<li>数据库读写分离</li>
<li>核心功能降级开关</li>
</ul>
<h3 id="8-4-持续改进"><a href="#8-4-持续改进" class="headerlink" title="8.4 持续改进"></a>8.4 持续改进</h3><ul>
<li>定期进行压测验证</li>
<li>优化高频调用链路</li>
<li>代码层面性能优化</li>
<li>架构持续演进</li>
</ul>
]]></content>
      <categories>
        <category>分布式</category>
      </categories>
      <tags>
        <tag>高并发</tag>
        <tag>10万TPS</tag>
        <tag>性能优化</tag>
        <tag>性能压测</tag>
      </tags>
  </entry>
  <entry>
    <title>JPA在不同数据库类下ID生成策略适配方案</title>
    <url>/2020/01/26/jpa/jpa-zai-bu-tong-shu-ju-ku-lei-xia-id-sheng-cheng-ce-lue-gua-pei-fang-an/</url>
    <content><![CDATA[<h1 id="JPA在不同数据库类下ID生成策略适配方案——技术解决方案"><a href="#JPA在不同数据库类下ID生成策略适配方案——技术解决方案" class="headerlink" title="JPA在不同数据库类下ID生成策略适配方案——技术解决方案"></a>JPA在不同数据库类下ID生成策略适配方案——技术解决方案</h1><span id="more"></span>
<div class="pdf-container" style="width: 100%; height: 600px; margin: 20px 0; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
    <iframe src="./JPA在不同数据库类下ID生成策略适配方案.pdf" width="100%" height="100%" frameborder="0" style="border: none; border-radius: 8px;">
      <div style="padding: 20px; text-align: center; background-color: #f8f9fa; border-radius: 8px;">
        <p style="margin: 0; color: #666;">您的浏览器不支持显示PDF文件</p>
        <a href="./JPA在不同数据库类下ID生成策略适配方案.pdf" target="_blank" style="color: #409eff; text-decoration: none; font-weight: 500;">📥 点击这里下载PDF文件</a>
      </div>
    </iframe>
  </div>]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>JPA</tag>
      </tags>
  </entry>
  <entry>
    <title>常用的关键字匹配算法</title>
    <url>/2024/06/21/high-concurrency/chang-yong-de-guan-jian-zi-pi-pei-suan-fa/</url>
    <content><![CDATA[<h1 id="一、背景简介"><a href="#一、背景简介" class="headerlink" title="一、背景简介"></a>一、背景简介</h1><h1 id="二、常用算法"><a href="#二、常用算法" class="headerlink" title="二、常用算法"></a>二、常用算法</h1><h2 id="2-1-暴力匹配算法（Brute-Force）"><a href="#2-1-暴力匹配算法（Brute-Force）" class="headerlink" title="2.1. 暴力匹配算法（Brute Force）"></a>2.1. 暴力匹配算法（Brute Force）</h2><p>从文本的每一个可能的起始位置开始，逐个字符地与模式串进行比较。</p>
<ul>
<li><strong>优点</strong>：<ul>
<li>简单易懂，容易实现。</li>
</ul>
</li>
<li><strong>缺点</strong>：<ul>
<li>效率低，时间复杂度为O(m * n)，其中m为模式串长度，n为文本长度。</li>
<li>不适合处理大规模数据和长模式串。</li>
</ul>
</li>
<li><strong>适用场景</strong>：<ul>
<li>小规模数据或者模式串较短的简单匹配场景。</li>
</ul>
</li>
<li><strong>性能表现</strong>：<ul>
<li>在规模较小的情况下能够工作，但随着数据规模增大，性能迅速下降。</li>
</ul>
</li>
</ul>
<h2 id="2-2-KMP算法（Knuth-Morris-Pratt算法）"><a href="#2-2-KMP算法（Knuth-Morris-Pratt算法）" class="headerlink" title="2.2. KMP算法（Knuth-Morris-Pratt算法）"></a>2.2. KMP算法（Knuth-Morris-Pratt算法）</h2><p> 利用前缀函数（partial match table）避免对已匹配部分的重复比较，实现跳跃式的匹配。</p>
<ul>
<li><strong>优点</strong>：<ul>
<li>时间复杂度为O(m + n)，其中m为模式串长度，n为文本长度。</li>
<li>适用于处理大规模数据和长模式串，性能稳定。</li>
</ul>
</li>
<li><strong>缺点</strong>：<ul>
<li>算法实现稍复杂，需要构建和理解前缀函数。</li>
<li>在某些特定情况下，性能可能不如Boyer-Moore算法。</li>
</ul>
</li>
<li><strong>适用场景</strong>：<ul>
<li>需要处理长模式串或者大量数据的字符串匹配任务。</li>
</ul>
</li>
<li><strong>性能表现</strong>：<ul>
<li>对于大规模数据和长模式串有较好的性能表现，常用于实际应用中。</li>
</ul>
</li>
</ul>
<h2 id="2-3-Boyer-Moore算法"><a href="#2-3-Boyer-Moore算法" class="headerlink" title="2.3. Boyer-Moore算法"></a>2.3. Boyer-Moore算法</h2><p>利用坏字符规则（bad character rule）和好后缀规则（good suffix rule），实现快速跳跃匹配。</p>
<ul>
<li><strong>优点</strong>：<ul>
<li>在实践中通常比KMP算法效率更高，尤其是在处理大规模数据和长模式串时。</li>
<li>可以通过预处理提前减少匹配时间。</li>
</ul>
</li>
<li><strong>缺点</strong>：<ul>
<li>实现复杂度略高于KMP算法，需要理解和实现坏字符和好后缀规则。</li>
<li>在某些特定情况下，性能可能不如AC自动机。</li>
</ul>
</li>
<li><strong>适用场景</strong>：<ul>
<li>处理长模式串和大规模数据，尤其适用于多次匹配的情况。</li>
</ul>
</li>
<li><strong>性能表现</strong>：<ul>
<li>在实际应用中，通常能提供较好的性能表现，特别是在模式串相对较长时。</li>
</ul>
</li>
</ul>
<h2 id="2-4-Trie树"><a href="#2-4-Trie树" class="headerlink" title="2.4. Trie树"></a>2.4. Trie树</h2><p>通过共享相同前缀来节省存储空间，并支持高效的插入、删除和查找操作。</p>
<ul>
<li><strong>优点</strong>：<ul>
<li>高效的插入和查找操作，时间复杂度为O(m)，其中m为字符串长度。</li>
<li>支持前缀匹配，能够快速找出具有相同前缀的所有字符串。</li>
</ul>
</li>
<li><strong>缺点</strong>：<ul>
<li>对存储空间的消耗较大，尤其是处理大量长字符串时。</li>
<li>插入顺序可能影响树的结构，导致性能波动。</li>
</ul>
</li>
<li><strong>适用场景</strong>：<ul>
<li>需要快速存储和检索字符串集合的应用，如字典、自动完成、拼写检查等。</li>
</ul>
</li>
<li><strong>性能表现</strong>：<ul>
<li>在处理字符串集合和前缀匹配任务时，能够提供稳定和高效的性能表现。</li>
</ul>
</li>
</ul>
<h2 id="2-5-双数组Trie（Double-Array-Trie，DAT）"><a href="#2-5-双数组Trie（Double-Array-Trie，DAT）" class="headerlink" title="2.5. 双数组Trie（Double-Array Trie，DAT）"></a>2.5. 双数组Trie（Double-Array Trie，DAT）</h2><p>双数组Trie是对传统Trie树的改进，通过两个数组（Base数组和Check数组）来代替节点的指针结构，实现状态的紧凑存储和高效查询。</p>
<ul>
<li><strong>优点</strong>：<ul>
<li>显著减少了内存消耗，相比传统的Trie树有更好的空间效率。</li>
<li>查询效率高，通过数组索引直接访问状态，减少了指针跳转和内存访问的开销。</li>
</ul>
</li>
<li><strong>缺点</strong>：<ul>
<li>实现稍复杂，需要理解和处理Base数组和Check数组的构建。</li>
<li>对于动态插入和删除操作不太友好，因为需要重新构建数组。</li>
</ul>
</li>
<li><strong>适用场景</strong>：<ul>
<li>需要高效存储和查询大规模字符串集合的场景，特别是需要频繁进行前缀匹配或者完全匹配的应用。</li>
</ul>
</li>
<li><strong>性能表现</strong>：<ul>
<li>在大规模数据和长字符串的存储和查询中，双数组Trie能够显著提升性能，特别是在内存使用和查询速度上。</li>
</ul>
</li>
</ul>
<h2 id="2-6-AC自动机（Aho-Corasick自动机）"><a href="#2-6-AC自动机（Aho-Corasick自动机）" class="headerlink" title="2.6. AC自动机（Aho-Corasick自动机）"></a>2.6. AC自动机（Aho-Corasick自动机）</h2><p>AC自动机是基于Trie树结构和KMP算法的拓展，旨在高效处理多模式匹配问题。它通过构建一个状态转移图（自动机）来同时在多个模式串中查找出现位置。</p>
<ul>
<li>主要包含两个关键部分：<ol>
<li>Trie树：用于存储模式串集合，并通过边表示字符转移。</li>
<li>失败指针（failure link）：类似于KMP算法中的部分匹配表，用于在匹配失败时跳转到下一个可能匹配的状态。</li>
</ol>
</li>
<li><strong>优点</strong>：<ul>
<li>能够高效处理大量模式串的多模式匹配问题。</li>
<li>支持动态添加模式串，并且构建一次后可以多次使用。</li>
<li>时间复杂度为O(n + m + z)，其中n为文本长度，m为所有模式串长度总和，z为匹配次数。</li>
</ul>
</li>
<li><strong>缺点</strong>：<ul>
<li>实现相对复杂，需要理解和构建状态转移图、失败指针等。</li>
<li>空间复杂度较高，尤其是随着模式串数量的增加。</li>
</ul>
</li>
<li><strong>适用场景</strong>：<ul>
<li>需要在大规模文本中同时匹配多个模式串的高效搜索应用场景，如关键字过滤、文本搜索引擎、网络安全等领域。</li>
</ul>
</li>
<li><strong>性能表现</strong>：<ul>
<li>在处理多模式匹配问题时，AC自动机通常能够提供优秀的性能表现，特别是在模式串数量较多或文本规模较大时。</li>
</ul>
</li>
</ul>
<h2 id="2-7-基于双数组Trie的AC自动机"><a href="#2-7-基于双数组Trie的AC自动机" class="headerlink" title="2.7. 基于双数组Trie的AC自动机"></a>2.7. 基于双数组Trie的AC自动机</h2><p>AC自动机利用双数组Trie作为其底层数据结构，结合自动机和KMP算法的思想，实现在一组文本中同时查找多个模式串。</p>
<ul>
<li><strong>优点</strong>：<ul>
<li>继承了双数组Trie的空间和查询效率优势。</li>
<li>能够高效处理大量模式串的多模式匹配问题，支持动态添加模式串。</li>
</ul>
</li>
<li><strong>缺点</strong>：<ul>
<li>实现相对复杂，需要构建和理解AC自动机的状态转移和失败指针。</li>
<li>空间复杂度较高，特别是随着模式串数量增加时。</li>
</ul>
</li>
<li><strong>适用场景</strong>：<ul>
<li>需要在大规模文本中同时匹配多个模式串的高效搜索应用场景。</li>
</ul>
</li>
<li><strong>性能表现</strong>：<ul>
<li>在处理多模式匹配问题时，基于双数组Trie的AC自动机通常能够提供优秀的性能表现，特别是在模式串较多或文本较大时。</li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>算法</category>
      </categories>
      <tags>
        <tag>关键字匹配</tag>
        <tag>AC自动机</tag>
        <tag>双数组Trie</tag>
      </tags>
  </entry>
  <entry>
    <title>ConcurrentHashMap源码解析</title>
    <url>/2019/07/06/java/concurrenthashmap-yuan-ma-jie-xi/</url>
    <content><![CDATA[<blockquote>
<p><strong>面试常见问题</strong></p>
<p>ConcurrentHashMap实现原理</p>
<p>ConcurrentHashMap如何保证线程安全</p>
</blockquote>
<blockquote>
<p><em><strong>本文基于JDK1.8</strong></em></p>
</blockquote>
<h2 id="一、构造方法和基本属性"><a href="#一、构造方法和基本属性" class="headerlink" title="一、构造方法和基本属性"></a>一、构造方法和基本属性</h2><p>JDK8中ConcurrentHashMap参考了JDK8 HashMap的实现，构造方法和基本属性与HashMap大致相同，可参考<a href="http://blog.mpoom.cn/2019/07/06/HashMap%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">HashMap源码解</a>,以下主要列举不同的地方。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Encodings for Node hash fields. See above for explanation.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MOVED</span>     <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// hash for forwarding nodes</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">TREEBIN</span>   <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// hash for roots of trees</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">RESERVED</span>  <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// hash for transient reservations</span>
<span class="token comment">// Hash节点正常可用位</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">HASH_BITS</span> <span class="token operator">=</span> <span class="token number">0x7fffffff</span><span class="token punctuation">;</span> <span class="token comment">// usable bits of normal node hash</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="二、主要方法解析"><a href="#二、主要方法解析" class="headerlink" title="二、主要方法解析"></a>二、主要方法解析</h2><h3 id="2-1-spread-int-h"><a href="#2-1-spread-int-h" class="headerlink" title="2.1  spread(int h)"></a>2.1  spread(int h)</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 这里的spread方法作用与HashMap中的hash方法相同，//先对低16位进行扰动处理，然后屏蔽符号位，结果为32      * 位int型非负数
 */</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">spread</span><span class="token punctuation">(</span><span class="token keyword">int</span> h<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>h <span class="token operator">^</span> <span class="token punctuation">(</span>h <span class="token operator">>>></span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token constant">HASH_BITS</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-2-tabAt-Node-tab-int-i"><a href="#2-2-tabAt-Node-tab-int-i" class="headerlink" title="2.2 tabAt(Node&lt;K,V&gt;[] tab, int i)"></a>2.2 tabAt(Node&lt;K,V&gt;[] tab, int i)</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 该方法通过Unsafe类直接进行内存寻址定位,用来返回节点数组的指定位置的节点的原子操作
 */</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token function">tabAt</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">getObjectVolatile</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>i <span class="token operator">&lt;&lt;</span> <span class="token constant">ASHIFT</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">ABASE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-3-casTabAt-Node-tab-int-i-Node-c-Node-v"><a href="#2-3-casTabAt-Node-tab-int-i-Node-c-Node-v" class="headerlink" title="2.3  casTabAt(Node&lt;K,V&gt;[] tab, int i, Node&lt;K,V&gt; c, Node&lt;K,V&gt; v)"></a>2.3  casTabAt(Node&lt;K,V&gt;[] tab, int i, Node&lt;K,V&gt; c, Node&lt;K,V&gt; v)</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 比较交换（CAS）
 */</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token keyword">boolean</span> <span class="token function">casTabAt</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> c<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>i <span class="token operator">&lt;&lt;</span> <span class="token constant">ASHIFT</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">ABASE</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-4-setTabAt-Node-tab-int-i-Node-v"><a href="#2-4-setTabAt-Node-tab-int-i-Node-v" class="headerlink" title="2.4  setTabAt(Node&lt;K,V&gt;[] tab, int i, Node&lt;K,V&gt; v)"></a>2.4  setTabAt(Node&lt;K,V&gt;[] tab, int i, Node&lt;K,V&gt; v)</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 
 */</span>   
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token keyword">void</span> <span class="token function">setTabAt</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putObjectVolatile</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>i <span class="token operator">&lt;&lt;</span> <span class="token constant">ASHIFT</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">ABASE</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-5-put-K-key-V-value"><a href="#2-5-put-K-key-V-value" class="headerlink" title="2.5  put(K key, V value)"></a>2.5  put(K key, V value)</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Maps the specified key to the specified value in this table.
 * Neither the key nor the value can be null.(键值都不能为空)
 *
 * &lt;p>The value can be retrieved by calling the &#123;@code get&#125; method
 * with a key that is equal to the original key.
 *
 * @param key key with which the specified value is to be associated
 * @param value value to be associated with the specified key
 * @return the previous value associated with &#123;@code key&#125;, or
 *         &#123;@code null&#125; if there was no mapping for &#123;@code key&#125;
 * @throws NullPointerException if the specified key or value is null
 */</span>
<span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">putVal</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/** Implementation for put and putIfAbsent */</span>
<span class="token keyword">final</span> <span class="token class-name">V</span> <span class="token function">putVal</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyIfAbsent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 键值都不能为null,否则抛出NPE异常</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> hash <span class="token operator">=</span> <span class="token function">spread</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> binCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> f<span class="token punctuation">;</span> 
        <span class="token keyword">int</span> n<span class="token punctuation">,</span> i<span class="token punctuation">,</span> fh<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tab <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            tab <span class="token operator">=</span> <span class="token function">initTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f <span class="token operator">=</span> <span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> hash<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 如果i位置没有数据，则比较并交换</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">casTabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// no lock when adding to empty bin</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">/*
         * 如果检测到某个节点的hash值是MOVED，则表示正在进行数组扩张的数据复制阶段，
         * 则当前线程也会参与去复制，通过允许多线程复制的功能，以此来减少数组的复制所带来的性能损失
         */</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fh <span class="token operator">=</span> f<span class="token punctuation">.</span>hash<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">MOVED</span><span class="token punctuation">)</span>
            tab <span class="token operator">=</span> <span class="token function">helpTransfer</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">V</span> oldVal <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token comment">// 如果在这个位置有元素的话，就采用synchronized的方式加锁</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">==</span> f<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>fh <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 标识该节点为列表节点</span>
                        binCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> e <span class="token operator">=</span> f<span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token operator">++</span>binCount<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            <span class="token class-name">K</span> ek<span class="token punctuation">;</span>
                            <span class="token comment">// 如果key相同，则覆盖旧value值</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span>
                                <span class="token punctuation">(</span><span class="token punctuation">(</span>ek <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span>
                                 <span class="token punctuation">(</span>ek <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ek<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                oldVal <span class="token operator">=</span> e<span class="token punctuation">.</span>val<span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onlyIfAbsent<span class="token punctuation">)</span>
                                    e<span class="token punctuation">.</span>val <span class="token operator">=</span> value<span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                            <span class="token comment">// 插入列表尾部</span>
                            <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> pred <span class="token operator">=</span> e<span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                pred<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token keyword">instanceof</span> <span class="token class-name">TreeBin</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> p<span class="token punctuation">;</span>
                        binCount <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
                        <span class="token comment">// 红黑树结构旋转插入</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">TreeBin</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">)</span>f<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putTreeVal</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            oldVal <span class="token operator">=</span> p<span class="token punctuation">.</span>val<span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onlyIfAbsent<span class="token punctuation">)</span>
                                p<span class="token punctuation">.</span>val <span class="token operator">=</span> value<span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>binCount <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 如果列表长度大于等于8则转换为红黑树</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>binCount <span class="token operator">>=</span> <span class="token constant">TREEIFY_THRESHOLD</span><span class="token punctuation">)</span>
                    <span class="token function">treeifyBin</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVal <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> oldVal<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 统计size，并检测是否需要扩容</span>
    <span class="token function">addCount</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> binCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-6-initTable"><a href="#2-6-initTable" class="headerlink" title="2.6  initTable()"></a>2.6  initTable()</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Initializes table, using the size recorded in sizeCtl.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">initTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">;</span> 
    <span class="token keyword">int</span> sc<span class="token punctuation">;</span>
    <span class="token comment">// 如果table为null则进行初始化</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tab <span class="token operator">=</span> table<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> tab<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//sizeCtl&lt;0表示其他线程已经在初始化了或者扩容了，挂起当前线程</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sc <span class="token operator">=</span> sizeCtl<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// lost initialization race; just spin</span>
        <span class="token comment">//CAS操作SIZECTL为-1，表示初始化状态</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">SIZECTL</span><span class="token punctuation">,</span> sc<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tab <span class="token operator">=</span> table<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> tab<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token punctuation">(</span>sc <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> sc <span class="token operator">:</span> <span class="token constant">DEFAULT_CAPACITY</span><span class="token punctuation">;</span>
                    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
                    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> nt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    table <span class="token operator">=</span> tab <span class="token operator">=</span> nt<span class="token punctuation">;</span>
                    <span class="token comment">// 初始化后，sizeCtl长度为数组长度的3/4</span>
                    sc <span class="token operator">=</span> n <span class="token operator">-</span> <span class="token punctuation">(</span>n <span class="token operator">>>></span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
                sizeCtl <span class="token operator">=</span> sc<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> tab<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-7-treeifyBin-Node-tab-int-index"><a href="#2-7-treeifyBin-Node-tab-int-index" class="headerlink" title="2.7 treeifyBin(Node&lt;K,V&gt;[] tab, int index)"></a>2.7 treeifyBin(Node&lt;K,V&gt;[] tab, int index)</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Replaces all linked nodes in bin at given index unless table is
 * too small, in which case resizes instead.
 * 当数组长度小于64的时候，扩张数组长度一倍，否则的话把链表转为树
 */</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">treeifyBin</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> b<span class="token punctuation">;</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> sc<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tab <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token constant">MIN_TREEIFY_CAPACITY</span><span class="token punctuation">)</span>
            <span class="token comment">// 数组长度小于64，则扩容1倍</span>
            <span class="token function">tryPresize</span><span class="token punctuation">(</span>n <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>b <span class="token operator">=</span> <span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">.</span>hash <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//使用synchronized同步器，将该节点出的链表转为红黑树</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">==</span> b<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> hd <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> tl <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> e <span class="token operator">=</span> b<span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token comment">// 将列表节点转换为红黑树节点</span>
                        <span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash<span class="token punctuation">,</span> e<span class="token punctuation">.</span>key<span class="token punctuation">,</span> e<span class="token punctuation">.</span>val<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>prev <span class="token operator">=</span> tl<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                            hd <span class="token operator">=</span> p<span class="token punctuation">;</span>
                        <span class="token keyword">else</span>
                            tl<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>
                        tl <span class="token operator">=</span> p<span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                    <span class="token function">setTabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> index<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TreeBin</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>hd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-8-tryPresize-int-size"><a href="#2-8-tryPresize-int-size" class="headerlink" title="2.8 tryPresize(int size)"></a>2.8 tryPresize(int size)</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Tries to presize table to accommodate the given number of elements.
 *
 * @param size number of elements (doesn't need to be perfectly accurate)
 */</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">tryPresize</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 如果指定容量大小大于等于最大容量的一半，则设置为最大容量，否则扩大为size的两倍</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token punctuation">(</span>size <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token constant">MAXIMUM_CAPACITY</span> <span class="token operator">>>></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant">MAXIMUM_CAPACITY</span> <span class="token operator">:</span>
        <span class="token function">tableSizeFor</span><span class="token punctuation">(</span>size <span class="token operator">+</span> <span class="token punctuation">(</span>size <span class="token operator">>>></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> sc<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sc <span class="token operator">=</span> sizeCtl<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span> <span class="token keyword">int</span> n<span class="token punctuation">;</span>
        <span class="token comment">// 如果还未初始化，则进行初始化</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tab <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            n <span class="token operator">=</span> <span class="token punctuation">(</span>sc <span class="token operator">></span> c<span class="token punctuation">)</span> <span class="token operator">?</span> sc <span class="token operator">:</span> c<span class="token punctuation">;</span>
            <span class="token comment">// 初始化tab的时候，把sizeCtl设为-1</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">SIZECTL</span><span class="token punctuation">,</span> sc<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>table <span class="token operator">==</span> tab<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
                        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> nt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        table <span class="token operator">=</span> nt<span class="token punctuation">;</span>
                        sc <span class="token operator">=</span> n <span class="token operator">-</span> <span class="token punctuation">(</span>n <span class="token operator">>>></span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
                    sizeCtl <span class="token operator">=</span> sc<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
         <span class="token comment">/*
         * 一直扩容到的c小于等于sizeCtl或者数组长度大于最大长度的时候，则退出
         * 所以在一次扩容之后，不是原来长度的两倍，而是2的n次方倍
         */</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&lt;=</span> sc <span class="token operator">||</span> n <span class="token operator">>=</span> <span class="token constant">MAXIMUM_CAPACITY</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tab <span class="token operator">==</span> table<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">resizeStamp</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> nt<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sc <span class="token operator">>>></span> <span class="token constant">RESIZE_STAMP_SHIFT</span><span class="token punctuation">)</span> <span class="token operator">!=</span> rs <span class="token operator">||</span> sc <span class="token operator">==</span> rs <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">||</span>
                    sc <span class="token operator">==</span> rs <span class="token operator">+</span> <span class="token constant">MAX_RESIZERS</span> <span class="token operator">||</span> <span class="token punctuation">(</span>nt <span class="token operator">=</span> nextTable<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span>
                    transferIndex <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token comment">/*
                 * transfer的线程数加一,该线程将进行transfer的帮忙
                 * 在transfer的时候，sc表示在transfer工作的线程数
                 */</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">SIZECTL</span><span class="token punctuation">,</span> sc<span class="token punctuation">,</span> sc <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token function">transfer</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> nt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">/*
             * 没有在初始化或扩容，则开始扩容
             */</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">SIZECTL</span><span class="token punctuation">,</span> sc<span class="token punctuation">,</span><span class="token punctuation">(</span>rs <span class="token operator">&lt;&lt;</span> <span class="token constant">RESIZE_STAMP_SHIFT</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token function">transfer</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-9-transfer-Node-tab-Node-nextTab"><a href="#2-9-transfer-Node-tab-Node-nextTab" class="headerlink" title="2.9 transfer(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab)"></a>2.9 transfer(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab)</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Moves and/or copies the nodes in each bin to new table. See
 * above for explanation.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> nextTab<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">,</span> stride<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>stride <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token constant">NCPU</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>n <span class="token operator">>>></span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token constant">NCPU</span> <span class="token operator">:</span> n<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token constant">MIN_TRANSFER_STRIDE</span><span class="token punctuation">)</span>
        stride <span class="token operator">=</span> <span class="token constant">MIN_TRANSFER_STRIDE</span><span class="token punctuation">;</span> <span class="token comment">// subdivide range</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextTab <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// initiating</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
            <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> nt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span>n <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            nextTab <span class="token operator">=</span> nt<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token comment">// try to cope with OOME</span>
            sizeCtl <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        nextTable <span class="token operator">=</span> nextTab<span class="token punctuation">;</span>
        transferIndex <span class="token operator">=</span> n<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">int</span> nextn <span class="token operator">=</span> nextTab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token class-name">ForwardingNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> fwd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForwardingNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>nextTab<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> advance <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> finishing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// to ensure sweep before committing nextTab</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> bound <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> f<span class="token punctuation">;</span> <span class="token keyword">int</span> fh<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>advance<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">int</span> nextIndex<span class="token punctuation">,</span> nextBound<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>i <span class="token operator">>=</span> bound <span class="token operator">||</span> finishing<span class="token punctuation">)</span>
                advance <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nextIndex <span class="token operator">=</span> transferIndex<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                i <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                advance <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span>compareAndSwapInt
                     <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">TRANSFERINDEX</span><span class="token punctuation">,</span> nextIndex<span class="token punctuation">,</span>
                      nextBound <span class="token operator">=</span> <span class="token punctuation">(</span>nextIndex <span class="token operator">></span> stride <span class="token operator">?</span>
                                   nextIndex <span class="token operator">-</span> stride <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                bound <span class="token operator">=</span> nextBound<span class="token punctuation">;</span>
                i <span class="token operator">=</span> nextIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                advance <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> i <span class="token operator">>=</span> n <span class="token operator">||</span> i <span class="token operator">+</span> n <span class="token operator">>=</span> nextn<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">int</span> sc<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                nextTable <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                table <span class="token operator">=</span> nextTab<span class="token punctuation">;</span>
                sizeCtl <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>n <span class="token operator">>>></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">SIZECTL</span><span class="token punctuation">,</span> sc <span class="token operator">=</span> sizeCtl<span class="token punctuation">,</span> sc <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sc <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">resizeStamp</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">RESIZE_STAMP_SHIFT</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                finishing <span class="token operator">=</span> advance <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                i <span class="token operator">=</span> n<span class="token punctuation">;</span> <span class="token comment">// recheck before commit</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f <span class="token operator">=</span> <span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            advance <span class="token operator">=</span> <span class="token function">casTabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fh <span class="token operator">=</span> f<span class="token punctuation">.</span>hash<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">MOVED</span><span class="token punctuation">)</span>
            advance <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// already processed</span>
        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">==</span> f<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> ln<span class="token punctuation">,</span> hn<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>fh <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">int</span> runBit <span class="token operator">=</span> fh <span class="token operator">&amp;</span> n<span class="token punctuation">;</span>
                        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> lastRun <span class="token operator">=</span> f<span class="token punctuation">;</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> p <span class="token operator">=</span> f<span class="token punctuation">.</span>next<span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            <span class="token keyword">int</span> b <span class="token operator">=</span> p<span class="token punctuation">.</span>hash <span class="token operator">&amp;</span> n<span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">!=</span> runBit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                runBit <span class="token operator">=</span> b<span class="token punctuation">;</span>
                                lastRun <span class="token operator">=</span> p<span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>runBit <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            ln <span class="token operator">=</span> lastRun<span class="token punctuation">;</span>
                            hn <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                            hn <span class="token operator">=</span> lastRun<span class="token punctuation">;</span>
                            ln <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> p <span class="token operator">=</span> f<span class="token punctuation">;</span> p <span class="token operator">!=</span> lastRun<span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            <span class="token keyword">int</span> ph <span class="token operator">=</span> p<span class="token punctuation">.</span>hash<span class="token punctuation">;</span> <span class="token class-name">K</span> pk <span class="token operator">=</span> p<span class="token punctuation">.</span>key<span class="token punctuation">;</span> <span class="token class-name">V</span> pv <span class="token operator">=</span> p<span class="token punctuation">.</span>val<span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ph <span class="token operator">&amp;</span> n<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                                ln <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>ph<span class="token punctuation">,</span> pk<span class="token punctuation">,</span> pv<span class="token punctuation">,</span> ln<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">else</span>
                                hn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>ph<span class="token punctuation">,</span> pk<span class="token punctuation">,</span> pv<span class="token punctuation">,</span> hn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                        <span class="token function">setTabAt</span><span class="token punctuation">(</span>nextTab<span class="token punctuation">,</span> i<span class="token punctuation">,</span> ln<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">setTabAt</span><span class="token punctuation">(</span>nextTab<span class="token punctuation">,</span> i <span class="token operator">+</span> n<span class="token punctuation">,</span> hn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">setTabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        advance <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token keyword">instanceof</span> <span class="token class-name">TreeBin</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">TreeBin</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TreeBin</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">)</span>f<span class="token punctuation">;</span>
                        <span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> lo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loTail <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                        <span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> hi <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> hiTail <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                        <span class="token keyword">int</span> lc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> hc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> e <span class="token operator">=</span> t<span class="token punctuation">.</span>first<span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            <span class="token keyword">int</span> h <span class="token operator">=</span> e<span class="token punctuation">.</span>hash<span class="token punctuation">;</span>
                            <span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span>
                                <span class="token punctuation">(</span>h<span class="token punctuation">,</span> e<span class="token punctuation">.</span>key<span class="token punctuation">,</span> e<span class="token punctuation">.</span>val<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>h <span class="token operator">&amp;</span> n<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>prev <span class="token operator">=</span> loTail<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                                    lo <span class="token operator">=</span> p<span class="token punctuation">;</span>
                                <span class="token keyword">else</span>
                                    loTail<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>
                                loTail <span class="token operator">=</span> p<span class="token punctuation">;</span>
                                <span class="token operator">++</span>lc<span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                            <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>prev <span class="token operator">=</span> hiTail<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                                    hi <span class="token operator">=</span> p<span class="token punctuation">;</span>
                                <span class="token keyword">else</span>
                                    hiTail<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>
                                hiTail <span class="token operator">=</span> p<span class="token punctuation">;</span>
                                <span class="token operator">++</span>hc<span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span>
                        ln <span class="token operator">=</span> <span class="token punctuation">(</span>lc <span class="token operator">&lt;=</span> <span class="token constant">UNTREEIFY_THRESHOLD</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">untreeify</span><span class="token punctuation">(</span>lo<span class="token punctuation">)</span> <span class="token operator">:</span>
                            <span class="token punctuation">(</span>hc <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">TreeBin</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>lo<span class="token punctuation">)</span> <span class="token operator">:</span> t<span class="token punctuation">;</span>
                        hn <span class="token operator">=</span> <span class="token punctuation">(</span>hc <span class="token operator">&lt;=</span> <span class="token constant">UNTREEIFY_THRESHOLD</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">untreeify</span><span class="token punctuation">(</span>hi<span class="token punctuation">)</span> <span class="token operator">:</span>
                            <span class="token punctuation">(</span>lc <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">TreeBin</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>hi<span class="token punctuation">)</span> <span class="token operator">:</span> t<span class="token punctuation">;</span>
                        <span class="token function">setTabAt</span><span class="token punctuation">(</span>nextTab<span class="token punctuation">,</span> i<span class="token punctuation">,</span> ln<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">setTabAt</span><span class="token punctuation">(</span>nextTab<span class="token punctuation">,</span> i <span class="token operator">+</span> n<span class="token punctuation">,</span> hn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">setTabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        advance <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h2><p>在ConcurrentHashMap中，同步处理主要是通过Synchronized和unsafe两种方式来完成的。</p>
<ul>
<li><p>在取得sizeCtl、某个位置的Node的时候，使用的都是unsafe的方法，来达到并发安全的目的</p>
</li>
<li><p>当需要在某个位置设置节点的时候，则会通过Synchronized的同步机制来锁定该位置的节点。</p>
</li>
<li><p>在数组扩容的时候，则通过处理的步长和fwd节点来达到并发安全的目的，通过设置hash值为MOVED</p>
</li>
<li><p>当把某个位置的节点复制到扩张后的table的时候，也通过Synchronized的同步机制来保证现程安全</p>
</li>
</ul>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>ConcurrentHashMap</tag>
      </tags>
  </entry>
  <entry>
    <title>Base理论与CAP</title>
    <url>/2024/05/25/java/base-li-lun-yu-cap/</url>
    <content><![CDATA[<h1 id="一、概念简介"><a href="#一、概念简介" class="headerlink" title="一、概念简介"></a>一、概念简介</h1><h2 id="1-1-Base理论"><a href="#1-1-Base理论" class="headerlink" title="1.1 Base理论"></a>1.1 Base理论</h2><p>BASE 是 Basically Available（基本可用）、Soft-state（软状态） 和 Eventually Consistent（最终一致性） 三个短语的缩写。BASE 理论是对 CAP 中一致性 C 和可用性 A 权衡的结果，其来源于对大规模互联网系统分布式实践的总结，是基于 CAP 定理逐步演化而来的，它大大降低了我们对系统的要求。</p>
<h2 id="1-2-CAP理论"><a href="#1-2-CAP理论" class="headerlink" title="1.2 CAP理论"></a>1.2 CAP理论</h2><p>CAP 也就是 Consistency（一致性）、Availability（可用性）、Partition Tolerance（分区容错性） 这三个单词首字母组合。</p>
<h1 id="二、Base理论"><a href="#二、Base理论" class="headerlink" title="二、Base理论"></a>二、Base理论</h1><blockquote>
<p>BASE 理论起源于 2008 年， 由 eBay 的架构师 Dan Pritchett 在 ACM 上发表。</p>
</blockquote>
<h2 id="2-1-简介"><a href="#2-1-简介" class="headerlink" title="2.1 简介"></a>2.1 简介</h2><p>BASE是“Basically Available, Soft state, Eventually consistent(基本可用、软状态、最终一致性)”的首字母缩写。其中的软状态和最终一致性这两种技巧擅于对付存在分区的场合，并因此提高了可用性。</p>
<ul>
<li>Basically Available（基本可用）分布式系统在出现不可预知故障的时候，允许损失部分可用性</li>
<li>Soft state（软状态）软状态也称为弱状态，和硬状态相对，是指允许系统中的数据存在中间状态，并认为该中间状态的存在不会影响系统的整体可用性，即允许系统在不同节点的数据副本之间进行数据同步的过程存在延时。</li>
<li>Eventually consistent（最终一致性）最终一致性强调的是系统中所有的数据副本，在经过一段时间的同步后，最终能够达到一个一致的状态。因此，最终一致性的本质是需要系统保证最终数据能够达到一致，而不需要实时保证系统数据的强一致性</li>
</ul>
<p>BASE是对CAP中一致性和可用性权衡的结果，其来源于对大规模互联网系统分布式实践的结论，是基于CAP定理逐步演化而来的，其核心思想是即使无法做到强一致性（Strong consistency），更具体地说，是对 CAP 中 AP 方案的一个补充。其基本思路就是：通过业务，牺牲强一致性而获得可用性，并允许数据在一段时间内是不一致的，但是最终达到一致性状态。</p>
<h2 id="2-2-Base理论的核心思想"><a href="#2-2-Base理论的核心思想" class="headerlink" title="2.2 Base理论的核心思想"></a>2.2 Base理论的核心思想</h2><p>即使无法做到强一致性，但每个应用都可以根据自身业务特点，采用适当的方式来使系统达到最终一致性。也就是牺牲数据的一致性来满足系统的高可用性，系统中一部分数据不可用或者不一致时，仍需要保持系统整体“主要可用”。<br><strong>BASE 理论本质上是对 CAP 的延伸和补充，更具体地说，是对 CAP 中 AP 方案的一个补充。</strong></p>
<h3 id="为什么这样说？"><a href="#为什么这样说？" class="headerlink" title="为什么这样说？"></a>为什么这样说？</h3><p>CAP 理论这节我们也说过了：</p>
<blockquote>
<p>如果系统没有发生“分区”的话，节点间的网络连接通信正常的话，也就不存在 P 了。这个时候，我们就可以同时保证 C 和 A 了。因此，如果系统发生“分区”，我们要考虑选择 CP 还是 AP。如果系统没有发生“分区”的话，我们要思考如何保证 CA 。</p>
</blockquote>
<p>因此，AP 方案只是在系统发生分区的时候放弃一致性，而不是永远放弃一致性。在分区故障恢复后，系统应该达到最终一致性。这一点其实就是 BASE 理论延伸的地方。</p>
<h2 id="2-3-Base理论三要素"><a href="#2-3-Base理论三要素" class="headerlink" title="2.3 Base理论三要素"></a>2.3 Base理论三要素</h2><h3 id="基本可用"><a href="#基本可用" class="headerlink" title="基本可用"></a>基本可用</h3><p>基本可用是指分布式系统在出现不可预知故障的时候，允许损失部分可用性。但是，这绝不等价于系统不可用。</p>
<h4 id="什么叫允许损失部分可用性呢？"><a href="#什么叫允许损失部分可用性呢？" class="headerlink" title="什么叫允许损失部分可用性呢？"></a>什么叫允许损失部分可用性呢？</h4><ul>
<li>响应时间上的损失: 正常情况下，处理用户请求需要 0.5s 返回结果，但是由于系统出现故障，处理用户请求的时间变为 3 s。</li>
<li>系统功能上的损失：正常情况下，用户可以使用系统的全部功能，但是由于系统访问量突然剧增，系统的部分非核心功能无法使用。</li>
</ul>
<h3 id="软状态"><a href="#软状态" class="headerlink" title="软状态"></a>软状态</h3><p>软状态指允许系统中的数据存在中间状态（CAP 理论中的数据不一致），并认为该中间状态的存在不会影响系统的整体可用性，即允许系统在不同节点的数据副本之间进行数据同步的过程存在延时。</p>
<h3 id="最终一致性"><a href="#最终一致性" class="headerlink" title="最终一致性"></a>最终一致性</h3><p>最终一致性强调的是系统中所有的数据副本，在经过一段时间的同步后，最终能够达到一个一致的状态。因此，最终一致性的本质是需要系统保证最终数据能够达到一致，而不需要实时保证系统数据的强一致性。</p>
<h4 id="分布式一致性的-3-种级别"><a href="#分布式一致性的-3-种级别" class="headerlink" title="分布式一致性的 3 种级别"></a>分布式一致性的 3 种级别</h4><ul>
<li>强一致性：系统写入了什么，读出来的就是什么。</li>
<li>弱一致性：不一定可以读取到最新写入的值，也不保证多少时间之后读取到的数据是最新的，只是会尽量保证某个时刻达到数据一致的状态。</li>
<li>最终一致性：弱一致性的升级版，系统会保证在一定时间内达到数据一致的状态。</li>
</ul>
<p>业界比较推崇是最终一致性级别，但是某些对数据一致要求十分严格的场景比如银行转账还是要保证强一致性。</p>
<h4 id="最终一致性实现方式"><a href="#最终一致性实现方式" class="headerlink" title="最终一致性实现方式"></a>最终一致性实现方式</h4><ul>
<li>读时修复 : 在读取数据时，检测数据的不一致，进行修复。比如 Cassandra 的 Read Repair 实现，具体来说，在向 Cassandra 系统查询数据的时候，如果检测到不同节点的副本数据不一致，系统就自动修复数据。</li>
<li>写时修复 : 在写入数据，检测数据的不一致时，进行修复。比如 Cassandra 的 Hinted Handoff 实现。具体来说，Cassandra 集群的节点之间远程写数据的时候，如果写失败 就将数据缓存下来，然后定时重传，修复数据的不一致性。</li>
<li>异步修复 : 这个是最常用的方式，通过定时对账检测副本数据的一致性，并修复。</li>
</ul>
<p>比较推荐 写时修复，这种方式对性能消耗比较低。</p>
<h1 id="三、CAP理论"><a href="#三、CAP理论" class="headerlink" title="三、CAP理论"></a>三、CAP理论</h1><blockquote>
<p>CAP 理论&#x2F;定理open in new window起源于 2000 年，由加州大学伯克利分校的 Eric Brewer 教授在分布式计算原理研讨会（PODC）上提出，因此 CAP 定理又被称作 布鲁尔定理（Brewer’s theorem）。<br>2 年后，麻省理工学院的 Seth Gilbert 和 Nancy Lynch 发表了布鲁尔猜想的证明，CAP 理论正式成为分布式领域的定理。</p>
</blockquote>
<h2 id="3-1-简介"><a href="#3-1-简介" class="headerlink" title="3.1 简介"></a>3.1 简介</h2><p>CAP 也就是 Consistency（一致性）、Availability（可用性）、Partition Tolerance（分区容错性） 这三个单词首字母组合。<br><img src="/2024/05/25/java/base-li-lun-yu-cap/cap.png" alt="CAP"></p>
<p>在理论计算机科学中，CAP 定理（CAP theorem）指出对于一个分布式系统来说，当设计读写操作时，只能同时满足以下三点中的两个：</p>
<ul>
<li>一致性（Consistency） : 所有节点访问同一份最新的数据副本</li>
<li>可用性（Availability）: 非故障的节点在合理的时间内返回合理的响应（不是错误或者超时的响应）。</li>
<li>分区容错性（Partition Tolerance） : 分布式系统出现网络分区的时候，仍然能够对外提供服务。</li>
</ul>
<h3 id="网络分区"><a href="#网络分区" class="headerlink" title="网络分区"></a>网络分区</h3><p>网络分区只在分布式集群中，节点之间由于网络不通，导致集群中节点形成不同的子集，子集中节点之间网络互通，而子集与子集之间网络不通。</p>
<h3 id="“3选2”的问题"><a href="#“3选2”的问题" class="headerlink" title="“3选2”的问题"></a>“3选2”的问题</h3><blockquote>
<p>当发生网络分区的时候，如果我们要继续服务，那么强一致性和可用性只能 2 选 1。也就是说当网络分区之后 P 是前提，决定了 P 之后才有 C 和 A 的选择。也就是说分区容错性（Partition tolerance）我们是必须要实现的。简而言之就是：CAP 理论中分区容错性 P 是一定要满足的，在此基础上，只能满足可用性 A 或者一致性 C。</p>
</blockquote>
<p>因此，分布式系统理论上不可能选择 CA 架构，只能选择 CP 或者 AP 架构。 比如 ZooKeeper、HBase 就是 CP 架构，Cassandra、Eureka 就是 AP 架构，Nacos 不仅支持 CP 架构也支持 AP 架构。</p>
<h3 id="为啥不可能选择-CA-架构呢？"><a href="#为啥不可能选择-CA-架构呢？" class="headerlink" title="为啥不可能选择 CA 架构呢？"></a>为啥不可能选择 CA 架构呢？</h3><p>举个例子：若系统出现“分区”，系统中的某个节点在进行写操作。为了保证 C， 必须要禁止其他节点的读写操作，这就和 A 发生冲突了。如果为了保证 A，其他节点的读写操作正常的话，那就和 C 发生冲突了。</p>
<p>选择 CP 还是 AP 的关键在于当前的业务场景，没有定论，比如对于需要确保强一致性的场景如银行一般会选择保证 CP 。另外，需要补充说明的一点是：如果网络分区正常的话（系统在绝大部分时候所处的状态），也就说不需要保证 P 的时候，C 和 A 能够同时保证。</p>
<h2 id="3-2-CAP实际案例"><a href="#3-2-CAP实际案例" class="headerlink" title="3.2 CAP实际案例"></a>3.2 CAP实际案例</h2><p>我这里以注册中心来探讨一下 CAP 的实际应用。考虑到很多小伙伴不知道注册中心是干嘛的，这里简单以 Dubbo 为例说一说。下图是 Dubbo 的架构图。注册中心 Registry 在其中扮演了什么角色呢？提供了什么服务呢？注册中心负责服务地址的注册与查找，相当于目录服务，服务提供者和消费者只在启动时与注册中心交互，注册中心不转发请求，压力较小。<br><img src="/2024/05/25/java/base-li-lun-yu-cap/dubbo-architecture.png" alt="dubbo-architecture"></p>
<p>常见的可以作为注册中心的组件有：ZooKeeper、Eureka、Nacos…。</p>
<ol>
<li>ZooKeeper 保证的是 CP。<br>任何时刻对 ZooKeeper 的读请求都能得到一致性的结果，但是， ZooKeeper 不保证每次请求的可用性比如在 Leader 选举过程中或者半数以上的机器不可用的时候服务就是不可用的。</li>
<li>Eureka 保证的则是 AP。<br>Eureka 在设计的时候就是优先保证 A （可用性）。在 Eureka 中不存在什么 Leader 节点，每个节点都是一样的、平等的。因此 Eureka 不会像 ZooKeeper 那样出现选举过程中或者半数以上的机器不可用的时候服务就是不可用的情况。 Eureka 保证即使大部分节点挂掉也不会影响正常提供服务，只要有一个节点是可用的就行了。只不过这个节点上的数据可能并不是最新的。</li>
<li>Nacos 不仅支持 CP 也支持 AP。</li>
</ol>
<h3 id="ZooKeeper补充"><a href="#ZooKeeper补充" class="headerlink" title="ZooKeeper补充"></a>ZooKeeper补充</h3><p>ZooKeeper 通过可线性化（Linearizable）写入、全局 FIFO 顺序访问等机制来保障数据一致性。多节点部署的情况下， ZooKeeper 集群处于 Quorum 模式。Quorum 模式下的 ZooKeeper 集群， 是一组 ZooKeeper 服务器节点组成的集合，其中大多数节点必须同意任何变更才能被视为有效。</p>
<p>由于 Quorum 模式下的读请求不会触发各个 ZooKeeper 节点之间的数据同步，因此在某些情况下还是可能会存在读取到旧数据的情况，导致不同的客户端视图上看到的结果不同，这可能是由于网络延迟、丢包、重传等原因造成的。ZooKeeper 为了解决这个问题，提供了 Watcher 机制和版本号机制来帮助客户端检测数据的变化和版本号的变更，以保证数据的一致性。</p>
<h2 id="3-3-总结"><a href="#3-3-总结" class="headerlink" title="3.3 总结"></a>3.3 总结</h2><p>在系统发生“分区”的情况下，CAP 理论只能满足 CP 或者 AP。要注意的是，这里的前提是系统发生了“分区”如果系统没有发生“分区”的话，节点间的网络连接通信正常的话，也就不存在 P 了。这个时候，我们就可以同时保证 C 和 A 了。</p>
<p><strong>总结：如果系统发生“分区”，我们要考虑选择 CP 还是 AP。如果系统没有发生“分区”的话，我们要思考如何保证 CA 。</strong></p>
<p>在进行分布式系统设计和开发时，我们不应该仅仅局限在 CAP 问题上，还要关注系统的扩展性、可用性等等。</p>
<h1 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h1><ul>
<li>ACID 是数据库事务完整性的理论</li>
<li>CAP 是分布式系统设计理论</li>
<li>BASE 是 CAP 理论中 AP 方案的延伸。</li>
</ul>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p><a href="https://javaguide.cn/distributed-system/protocol/cap-and-base-theorem.html">CAP &amp; BASE理论详解</a></p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>分布式</tag>
        <tag>Base理论</tag>
        <tag>CAP</tag>
      </tags>
  </entry>
  <entry>
    <title>HashMap源码解析</title>
    <url>/2019/07/06/java/hashmap-yuan-ma-jie-xi/</url>
    <content><![CDATA[<blockquote>
<p><strong>面试常见问题</strong></p>
<p>1、你看过那些源码吗？<br>2、那你能讲讲HashMap的实现原理吗？<br>3、HashMap什么时候会进行rehash？<br>4、HashMap什么时候会进行扩容？<br>5、那HashMap的初始容量设置成多少比较合适呢？<br>6、结合源码说说HashMap在高并发场景中为什么会出现死循环？<br>7、JDK1.8中对HashMap做了哪些性能优化？<br>8、HashMap和HashTable有何不同？<br>9、HashMap 和 ConcurrentHashMap 的区别？<br>10、ConcurrentHashMap和LinkedHashMap有什么区别？<br>11、为什么ConcurrentHashMap中的链表转红黑树的阀值是8？<br>12、什么是ConcurrentSkipListMap？他和ConcurrentHashMap有什么区别？<br>13、还看过其他的源码吗？Spring的源码有了解吗？<br>14、SpringBoot的源码呢？知道starter是怎么实现的吗？</p>
</blockquote>
<h2 id="一、构造方法"><a href="#一、构造方法" class="headerlink" title="一、构造方法"></a>一、构造方法</h2><h3 id="1-1无参构造方法"><a href="#1-1无参构造方法" class="headerlink" title="1.1无参构造方法"></a>1.1无参构造方法</h3><blockquote>
<p>默认初始化容量16，加载因子0.75</p>
</blockquote>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Constructs an empty &lt;tt>HashMap&lt;/tt> with the default initial capacity
 * (16) and the default load factor (0.75).
 */</span>
<span class="token keyword">public</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>loadFactor <span class="token operator">=</span> <span class="token constant">DEFAULT_LOAD_FACTOR</span><span class="token punctuation">;</span> <span class="token comment">// all other fields defaulted</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="1-2-指定初始容量initialCapacity，默认加载因子0-75"><a href="#1-2-指定初始容量initialCapacity，默认加载因子0-75" class="headerlink" title="1.2  指定初始容量initialCapacity，默认加载因子0.75"></a>1.2  指定初始容量initialCapacity，默认加载因子0.75</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Constructs an empty &lt;tt>HashMap&lt;/tt> with the specified initial
 * capacity and the default load factor (0.75).
 *
 * @param  initialCapacity the initial capacity.
 * @throws IllegalArgumentException if the initial capacity is negative.
 */</span>
<span class="token keyword">public</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span>initialCapacity<span class="token punctuation">,</span> <span class="token constant">DEFAULT_LOAD_FACTOR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="1-3-指定初始容量initialCapaticy和加载因子loadFactor"><a href="#1-3-指定初始容量initialCapaticy和加载因子loadFactor" class="headerlink" title="1.3 指定初始容量initialCapaticy和加载因子loadFactor"></a>1.3 指定初始容量initialCapaticy和加载因子loadFactor</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Constructs an empty &lt;tt>HashMap&lt;/tt> with the specified initial
 * capacity and load factor.
 *
 * @param  initialCapacity the initial capacity
 * @param  loadFactor      the load factor
 * @throws IllegalArgumentException if the initial capacity is negative
 *         or the load factor is nonpositive
 */</span>
<span class="token keyword">public</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">,</span> <span class="token keyword">float</span> loadFactor<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>initialCapacity <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Illegal initial capacity: "</span> <span class="token operator">+</span>
                                           initialCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>initialCapacity <span class="token operator">></span> <span class="token constant">MAXIMUM_CAPACITY</span><span class="token punctuation">)</span>
        initialCapacity <span class="token operator">=</span> <span class="token constant">MAXIMUM_CAPACITY</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>loadFactor <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token class-name">Float</span><span class="token punctuation">.</span><span class="token function">isNaN</span><span class="token punctuation">(</span>loadFactor<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Illegal load factor: "</span> <span class="token operator">+</span>
                                           loadFactor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>loadFactor <span class="token operator">=</span> loadFactor<span class="token punctuation">;</span>
    <span class="token comment">// 阈值初始化为初始容量最小2的倍数</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>threshold <span class="token operator">=</span> <span class="token function">tableSizeFor</span><span class="token punctuation">(</span>initialCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p><strong>HashMap初始容量为指定容量的最小2的倍数。该方法将初始容量的二进制最高位右移再与原值进行或运算，将低位全部转换为1，最后加1，由此得到初始化容量的最小的2的倍数</strong></p>
</blockquote>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Returns a power of two size for the given target capacity.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">tableSizeFor</span><span class="token punctuation">(</span><span class="token keyword">int</span> cap<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> n <span class="token operator">=</span> cap <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    n <span class="token operator">|=</span> n <span class="token operator">>>></span> <span class="token number">1</span><span class="token punctuation">;</span>
    n <span class="token operator">|=</span> n <span class="token operator">>>></span> <span class="token number">2</span><span class="token punctuation">;</span>
    n <span class="token operator">|=</span> n <span class="token operator">>>></span> <span class="token number">4</span><span class="token punctuation">;</span>
    n <span class="token operator">|=</span> n <span class="token operator">>>></span> <span class="token number">8</span><span class="token punctuation">;</span>
    n <span class="token operator">|=</span> n <span class="token operator">>>></span> <span class="token number">16</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token punctuation">(</span>n <span class="token operator">>=</span> <span class="token constant">MAXIMUM_CAPACITY</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant">MAXIMUM_CAPACITY</span> <span class="token operator">:</span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="1-4-用其他Map初始化"><a href="#1-4-用其他Map初始化" class="headerlink" title="1.4 用其他Map初始化"></a>1.4 用其他Map初始化</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Constructs a new &lt;tt>HashMap&lt;/tt> with the same mappings as the
 * specified &lt;tt>Map&lt;/tt>.  The &lt;tt>HashMap&lt;/tt> is created with
 * default load factor (0.75) and an initial capacity sufficient to
 * hold the mappings in the specified &lt;tt>Map&lt;/tt>.
 *
 * @param   m the map whose mappings are to be placed in this map
 * @throws  NullPointerException if the specified map is null
 */</span>
<span class="token keyword">public</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">V</span><span class="token punctuation">></span></span> m<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>loadFactor <span class="token operator">=</span> <span class="token constant">DEFAULT_LOAD_FACTOR</span><span class="token punctuation">;</span>
    <span class="token function">putMapEntries</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h2 id="二、属性解析"><a href="#二、属性解析" class="headerlink" title="二、属性解析"></a>二、属性解析</h2><h3 id="2-1-基本属性"><a href="#2-1-基本属性" class="headerlink" title="2.1  基本属性"></a>2.1  基本属性</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 默认初始化容量，必须是2的倍数，初始默认为16
 */</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_INITIAL_CAPACITY</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">// aka 16</span>

<span class="token comment">/**
 * 最大容量，小于2的30次方
 */</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MAXIMUM_CAPACITY</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">30</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 默认加载因子0.75
 */</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">float</span> <span class="token constant">DEFAULT_LOAD_FACTOR</span> <span class="token operator">=</span> <span class="token number">0.75f</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 列表转红黑树的阈值，列表大于等于8时将转为红黑树
 */</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">TREEIFY_THRESHOLD</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 红黑树转列表的阈值
 */</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">UNTREEIFY_THRESHOLD</span> <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 列表转红黑树的最小容量，如果一个槽中的数据太多，HashMap应考虑扩容，该值用来解决扩容与列表转树的冲突
 */</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MIN_TREEIFY_CAPACITY</span> <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 在首次使用时初始化，根据需要扩容，大小始终为2的倍数
 */</span>
<span class="token keyword">transient</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> table<span class="token punctuation">;</span>

<span class="token comment">/**
 * Holds cached entrySet(). Note that AbstractMap fields are used
 * for keySet() and values().
 */</span>
<span class="token keyword">transient</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span><span class="token punctuation">></span></span> entrySet<span class="token punctuation">;</span>

<span class="token comment">/**
 * HashMap中键值对的数量
 */</span>
<span class="token keyword">transient</span> <span class="token keyword">int</span> size<span class="token punctuation">;</span>

<span class="token comment">/**
 * HashMap结构修改次数
 */</span>
<span class="token keyword">transient</span> <span class="token keyword">int</span> modCount<span class="token punctuation">;</span>

<span class="token comment">/**
 * 下次扩容时table的大小
 * @serial
 */</span>
<span class="token keyword">int</span> threshold<span class="token punctuation">;</span>

<span class="token comment">/**
 * hash table 加载因子
 * @serial
 */</span>
<span class="token keyword">final</span> <span class="token keyword">float</span> loadFactor<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-2-内部类Node"><a href="#2-2-内部类Node" class="headerlink" title="2.2  内部类Node&lt;K,V&gt;"></a>2.2  内部类Node&lt;K,V&gt;</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 基础hash节点，包含一个hash值，一个key-value键值对，和下个节点
 */</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> hash<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">K</span> key<span class="token punctuation">;</span>
    <span class="token class-name">V</span> value<span class="token punctuation">;</span>
    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> next<span class="token punctuation">;</span>

    <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token keyword">int</span> hash<span class="token punctuation">,</span> <span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hash <span class="token operator">=</span> hash<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>next <span class="token operator">=</span> next<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">K</span> <span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> key<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">V</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> value<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> key <span class="token operator">+</span> <span class="token string">"="</span> <span class="token operator">+</span> value<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">V</span> <span class="token function">setValue</span><span class="token punctuation">(</span><span class="token class-name">V</span> newValue<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">V</span> oldValue <span class="token operator">=</span> value<span class="token punctuation">;</span>
        value <span class="token operator">=</span> newValue<span class="token punctuation">;</span>
        <span class="token keyword">return</span> oldValue<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token keyword">instanceof</span> <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">></span></span> e <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">)</span>o<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-3-内部类TreeNode"><a href="#2-3-内部类TreeNode" class="headerlink" title="2.3  内部类TreeNode&lt;K,V&gt;"></a>2.3  内部类TreeNode&lt;K,V&gt;</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 红黑树节点，包含父节点、左节点、右节点、前置节点以及节点颜色
 */</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">LinkedHashMap<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> parent<span class="token punctuation">;</span>  <span class="token comment">// red-black tree links</span>
    <span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> left<span class="token punctuation">;</span>
    <span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> right<span class="token punctuation">;</span>
    <span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> prev<span class="token punctuation">;</span>    <span class="token comment">// needed to unlink next upon deletion</span>
    <span class="token keyword">boolean</span> red<span class="token punctuation">;</span>
    <span class="token class-name">TreeNode</span><span class="token punctuation">(</span><span class="token keyword">int</span> hash<span class="token punctuation">,</span> <span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> val<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * Returns root of tree containing this node.
     */</span>
    <span class="token keyword">final</span> <span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token function">root</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> r <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">,</span> p<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> r<span class="token punctuation">.</span>parent<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> r<span class="token punctuation">;</span>
            r <span class="token operator">=</span> p<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="三、主要方法解析"><a href="#三、主要方法解析" class="headerlink" title="三、主要方法解析"></a>三、主要方法解析</h2><h3 id="3-1-hash-Object-key"><a href="#3-1-hash-Object-key" class="headerlink" title="3.1  hash(Object key)"></a>3.1  hash(Object key)</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * key首先经过原生的hash方法后返回int类型的hash值，将该值的高16位右移传递到低16位并与原来的值异或运算。
 * 这样处理是为了将key的hash值的高位特征传递到低位，降低hash冲突的概率。
 */</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">hash</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> h<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token punctuation">(</span>h <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>h <span class="token operator">>>></span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="3-2-put-K-key-V-value"><a href="#3-2-put-K-key-V-value" class="headerlink" title="3.2  put(K key, V value)"></a>3.2  put(K key, V value)</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 在map中将指定的键和值进行关联映射，如果map中已经存在该键的映射关系，
 * 那么map中该键关联的值将被替换。
 *
 * @param key key with which the specified value is to be associated
 * @param value value to be associated with the specified key
 * @return 返回key关联的旧值，如果原来key关联的为null，则返回null
 */</span>
<span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">putVal</span><span class="token punctuation">(</span><span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/**
 * Implements Map.put and related methods
 *
 * @param hash hash for key
 * @param key the key
 * @param value the value to put
 * @param onlyIfAbsent if true, don't change existing value
 * @param evict if false, the table is in creation mode.
 * @return previous value, or null if none
 */</span>
<span class="token keyword">final</span> <span class="token class-name">V</span> <span class="token function">putVal</span><span class="token punctuation">(</span><span class="token keyword">int</span> hash<span class="token punctuation">,</span> <span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyIfAbsent<span class="token punctuation">,</span>
               <span class="token keyword">boolean</span> evict<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">;</span> 
    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> p<span class="token punctuation">;</span> 
    <span class="token keyword">int</span> n<span class="token punctuation">,</span> i<span class="token punctuation">;</span>
    <span class="token comment">// talbe在第一次使用时初始化</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tab <span class="token operator">=</span> table<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        n <span class="token operator">=</span> <span class="token punctuation">(</span>tab <span class="token operator">=</span> <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token comment">// key的hash值未产生hash冲突，则将value作为第一个节点存储到map中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> tab<span class="token punctuation">[</span>i <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> hash<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">newNode</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> e<span class="token punctuation">;</span> 
        <span class="token class-name">K</span> k<span class="token punctuation">;</span>
        <span class="token comment">// 出现hash冲突，且key与第一个节点相同，用节点e标记该节点</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> p<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            e <span class="token operator">=</span> p<span class="token punctuation">;</span>
        <span class="token comment">// key所对应的槽中的第一个节点为TreeNode</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token keyword">instanceof</span> <span class="token class-name">TreeNode</span><span class="token punctuation">)</span>
            e <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">)</span>p<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putTreeVal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> tab<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 出现hash冲突后，遍历列表</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> binCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token operator">++</span>binCount<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 遍历列表，如无重复key值，将value值添加到列表末尾</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    p<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token function">newNode</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 如果列表长度大于等于阈值8，则将列表转换为红黑树</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>binCount <span class="token operator">>=</span> <span class="token constant">TREEIFY_THRESHOLD</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// -1 for 1st</span>
                        <span class="token function">treeifyBin</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token comment">// 如果列表中存在重复的key，用节点e标记已存在的节点</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                p <span class="token operator">=</span> e<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 已存在key的映射</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// existing mapping for key</span>
            <span class="token class-name">V</span> oldValue <span class="token operator">=</span> e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
            <span class="token comment">// onlyIfAbsent为false或旧值为null，将新的value映射到map中</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onlyIfAbsent <span class="token operator">||</span> oldValue <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                e<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
            <span class="token comment">// </span>
            <span class="token function">afterNodeAccess</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 返回key关联的旧值</span>
            <span class="token keyword">return</span> oldValue<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token operator">++</span>modCount<span class="token punctuation">;</span>
    <span class="token comment">// map中数据量大于容量阈值（容量*加载因子），map进行扩容</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>size <span class="token operator">></span> threshold<span class="token punctuation">)</span>
        <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">afterNodeInsertion</span><span class="token punctuation">(</span>evict<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-3-resize"><a href="#3-3-resize" class="headerlink" title="3.3  resize()"></a>3.3  resize()</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 初始化或扩容（2倍），  如果为null，则按照初始容量分配，否则以2的倍数进行扩容。
 * @return the table
 */</span>
<span class="token keyword">final</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> oldTab <span class="token operator">=</span> table<span class="token punctuation">;</span>
    <span class="token keyword">int</span> oldCap <span class="token operator">=</span> <span class="token punctuation">(</span>oldTab <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> oldTab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">int</span> oldThr <span class="token operator">=</span> threshold<span class="token punctuation">;</span>
    <span class="token keyword">int</span> newCap<span class="token punctuation">,</span> newThr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCap <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 如果未超过容量最大值，则扩容2倍</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCap <span class="token operator">>=</span> <span class="token constant">MAXIMUM_CAPACITY</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            threshold <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> oldTab<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>newCap <span class="token operator">=</span> oldCap <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token constant">MAXIMUM_CAPACITY</span> <span class="token operator">&amp;&amp;</span>
                 oldCap <span class="token operator">>=</span> <span class="token constant">DEFAULT_INITIAL_CAPACITY</span><span class="token punctuation">)</span>
            newThr <span class="token operator">=</span> oldThr <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// double threshold</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldThr <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// initial capacity was placed in threshold</span>
        <span class="token comment">// 初始化容量</span>
        newCap <span class="token operator">=</span> oldThr<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// zero initial threshold signifies using defaults</span>
        <span class="token comment">// 初始容量值为0，初始化时容量为默认大小16</span>
        newCap <span class="token operator">=</span> <span class="token constant">DEFAULT_INITIAL_CAPACITY</span><span class="token punctuation">;</span>
        newThr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_LOAD_FACTOR</span> <span class="token operator">*</span> <span class="token constant">DEFAULT_INITIAL_CAPACITY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newThr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 初始化阈值（初始容量 * 加载因子）</span>
        <span class="token keyword">float</span> ft <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>newCap <span class="token operator">*</span> loadFactor<span class="token punctuation">;</span>
        newThr <span class="token operator">=</span> <span class="token punctuation">(</span>newCap <span class="token operator">&lt;</span> <span class="token constant">MAXIMUM_CAPACITY</span> <span class="token operator">&amp;&amp;</span> ft <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token constant">MAXIMUM_CAPACITY</span> <span class="token operator">?</span>
                  <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>ft <span class="token operator">:</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    threshold <span class="token operator">=</span> newThr<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"rawtypes"</span><span class="token punctuation">,</span><span class="token string">"unchecked"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token comment">// 容量扩大为原来的两倍</span>
    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> newTab <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">[</span>newCap<span class="token punctuation">]</span><span class="token punctuation">;</span>
    table <span class="token operator">=</span> newTab<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldTab <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 进行rehash，把数据转移的扩容后的HashMap中</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> oldCap<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> e<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> oldTab<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                oldTab<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token comment">// hash槽中只有一个元素时，直接转移过去</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>next <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    newTab<span class="token punctuation">[</span>e<span class="token punctuation">.</span>hash <span class="token operator">&amp;</span> <span class="token punctuation">(</span>newCap <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
                <span class="token comment">// 节点类型为树节点，列表已转为红黑树了</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">TreeNode</span><span class="token punctuation">)</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">)</span>e<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> newTab<span class="token punctuation">,</span> j<span class="token punctuation">,</span> oldCap<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> <span class="token comment">// preserve order</span>
                    
                    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> loHead <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loTail <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> hiHead <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> hiTail <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> next<span class="token punctuation">;</span>
                    <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
                        next <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                        <span class="token comment">// HashMap槽中的数据为列表时，由于HashMap扩容后容量变为原来的两倍，通                             // 过 `e.hash &amp; oldCap` 运算，如果结果等于0， 则表示当前元素在新                                 // table中位置与原来相同，如果不等于0，则在新table中位置需要增加原来的                             // 容量oldCap</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">&amp;</span> oldCap<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>loTail <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                                loHead <span class="token operator">=</span> e<span class="token punctuation">;</span>
                            <span class="token keyword">else</span>
                                loTail<span class="token punctuation">.</span>next <span class="token operator">=</span> e<span class="token punctuation">;</span>
                            loTail <span class="token operator">=</span> e<span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>hiTail <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                                hiHead <span class="token operator">=</span> e<span class="token punctuation">;</span>
                            <span class="token keyword">else</span>
                                hiTail<span class="token punctuation">.</span>next <span class="token operator">=</span> e<span class="token punctuation">;</span>
                            hiTail <span class="token operator">=</span> e<span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> next<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>loTail <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        loTail<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                        newTab<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> loHead<span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>hiTail <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        hiTail<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                        newTab<span class="token punctuation">[</span>j <span class="token operator">+</span> oldCap<span class="token punctuation">]</span> <span class="token operator">=</span> hiHead<span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> newTab<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-4-treeifyBin-Node-tab-int-hash"><a href="#3-4-treeifyBin-Node-tab-int-hash" class="headerlink" title="3.4  treeifyBin(Node&lt;K,V&gt;[] tab, int hash)"></a>3.4  treeifyBin(Node&lt;K,V&gt;[] tab, int hash)</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 将列表转红黑树
 */</span>
<span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">treeifyBin</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">,</span> <span class="token keyword">int</span> hash<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> n<span class="token punctuation">,</span> index<span class="token punctuation">;</span> 
    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> e<span class="token punctuation">;</span>
    <span class="token comment">// 如果数组为null或数组容量小于列表转红黑树的阈值（64），则进行初始化或扩容</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tab <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token constant">MIN_TREEIFY_CAPACITY</span><span class="token punctuation">)</span>
        <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> tab<span class="token punctuation">[</span>index <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> hash<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> hd <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> tl <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 将列表节点转换为红黑树节点</span>
            <span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> p <span class="token operator">=</span> <span class="token function">replacementTreeNode</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tl <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                hd <span class="token operator">=</span> p<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                p<span class="token punctuation">.</span>prev <span class="token operator">=</span> tl<span class="token punctuation">;</span>
                tl<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            tl <span class="token operator">=</span> p<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tab<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> hd<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            hd<span class="token punctuation">.</span><span class="token function">treeify</span><span class="token punctuation">(</span>tab<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="四、多线程下HashMap死循环问题分析"><a href="#四、多线程下HashMap死循环问题分析" class="headerlink" title="四、多线程下HashMap死循环问题分析"></a>四、多线程下HashMap死循环问题分析</h2><p>HashMap多线程下死循环问题在JDK1.7存在，JDK1.8已经解决了死循环的问题，但仍然不是线程安全的。</p>
<blockquote>
<p>JDK1.7多线程下死循环代码分析</p>
</blockquote>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Rehashes the contents of this map into a new array with a
 * larger capacity.  This method is called automatically when the
 * number of keys in this map reaches its threshold.
 *
 * If current capacity is MAXIMUM_CAPACITY, this method does not
 * resize the map, but sets threshold to Integer.MAX_VALUE.
 * This has the effect of preventing future calls.
 *
 * @param newCapacity the new capacity, MUST be a power of two;
 *        must be greater than current capacity unless current
 *        capacity is MAXIMUM_CAPACITY (in which case value
 *        is irrelevant).
 */</span>
<span class="token keyword">void</span> <span class="token function">resize</span><span class="token punctuation">(</span><span class="token keyword">int</span> newCapacity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> oldTable <span class="token operator">=</span> table<span class="token punctuation">;</span>
    <span class="token keyword">int</span> oldCapacity <span class="token operator">=</span> oldTable<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCapacity <span class="token operator">==</span> <span class="token constant">MAXIMUM_CAPACITY</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        threshold <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> newTable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">[</span>newCapacity<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">transfer</span><span class="token punctuation">(</span>newTable<span class="token punctuation">,</span> <span class="token function">initHashSeedAsNeeded</span><span class="token punctuation">(</span>newCapacity<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    table <span class="token operator">=</span> newTable<span class="token punctuation">;</span>
    threshold <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>newCapacity <span class="token operator">*</span> loadFactor<span class="token punctuation">,</span> <span class="token constant">MAXIMUM_CAPACITY</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/**
 * Transfers all entries from current table to newTable.
 */</span>
<span class="token keyword">void</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> newTable<span class="token punctuation">,</span> <span class="token keyword">boolean</span> rehash<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> newCapacity <span class="token operator">=</span> newTable<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> e <span class="token operator">:</span> table<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> next <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rehash<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span>hash <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token operator">==</span> e<span class="token punctuation">.</span>key <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token function">hash</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token function">indexFor</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash<span class="token punctuation">,</span> newCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            e<span class="token punctuation">.</span>next <span class="token operator">=</span> newTable<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            newTable<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
            e <span class="token operator">=</span> next<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>上述代码在多线程下出现死循环的地方在transfer方法的内的do-while循环内，假设线程1在执行do-while循环的第2行代码时被挂起，此时线程1的记录了e节点信息和e.next节点信息，如果此时另外一个线程完成了整个扩容操作，此时线程1再次执行，由于线程2在执行扩容时，列表按照头插法的方式插入，线程1记录的仍是原列表的顺序，线程1继续操作，会导致列表首位相连，从而产生死循环。</p>
<p> 此外，HashMap在多线程环境下还可能导致put操作导致元素丢失。</p>
<p>死循环产生的具体过程可参考：[<a href="https://www.cnblogs.com/dongguacai/p/5599100.html">深入理解JAVA集合系列三：HashMap的死循环解读</a>]</p>
</blockquote>
<h2 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h2><ul>
<li>HashMap底层基于数组和列表来实现的，将key经过hash散列再按数组长度取模运算，定位到一个hash槽，将key-value值作为一个节点存储到hash槽中，如果槽中出现hash冲突，则以列表的形式存储节点，当列表长度大于等于8时且map中总结点个数大于等于64时，则将列表转换为红黑树。</li>
<li>当HashMap中的节点个数超过容量阈值（容量*加载因子）时，HashMap会进行扩容，扩容是会进行rehash。</li>
<li>当HashMap中某个槽中的元素个数大于等于8且总元素个数小于64时，这时候HashMap会进行扩容而不是转为红黑树。</li>
<li>HashMap的初始容量设置成initialCapacity &#x3D; (需要存储的元素个数 &#x2F; 负载因子) + 1，如果不确定，设置为16（默认值）。</li>
<li>在JDK1.8中，当HashMap某个槽中的元素个数大于等于8时，且总元素个数超过64，则将列表转化为红黑树提高查找速度。</li>
</ul>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>HashMap</tag>
      </tags>
  </entry>
  <entry>
    <title>IntelliJ IDEA快捷键使用</title>
    <url>/2021/12/28/java/intellij-idea-kuai-jie-jian-shi-yong/</url>
    <content><![CDATA[<h1 id="工具用得好，下班下得早"><a href="#工具用得好，下班下得早" class="headerlink" title="工具用得好，下班下得早"></a>工具用得好，下班下得早</h1><h2 id="Ctrl-Alt-T"><a href="#Ctrl-Alt-T" class="headerlink" title="Ctrl + Alt + T"></a>Ctrl + Alt + T</h2><p>使用if，if&#x2F;else, while, do&#x2F;while, for, try&#x2F;catch, try&#x2F;finally, try&#x2F;catch&#x2F;finally, synchronized, Runnalbe 包围代码块</p>
<h2 id="Alt-Enter"><a href="#Alt-Enter" class="headerlink" title="Alt + Enter"></a>Alt + Enter</h2><p>代码快速补全、包引入、临时变量生成等</p>
<h2 id="Ctrl-Alt-M"><a href="#Ctrl-Alt-M" class="headerlink" title="Ctrl + Alt + M"></a>Ctrl + Alt + M</h2><p>将代码块提取到一个方法</p>
<h2 id="Ctrl-Shift-上下方向键"><a href="#Ctrl-Shift-上下方向键" class="headerlink" title="Ctrl + Shift + 上下方向键"></a>Ctrl + Shift + 上下方向键</h2><p>上下移动单行代码和代码块</p>
<h2 id="Class-new-（Alt-Enter）"><a href="#Class-new-（Alt-Enter）" class="headerlink" title="Class.new + （Alt + Enter）"></a>Class.new + （Alt + Enter）</h2><p><code>Class.new</code>创建一个Class类型的匿名对象，<code>Alt + Enter</code>将匿名对象赋值给一个新建的变量</p>
<h2 id="instance-try"><a href="#instance-try" class="headerlink" title="instance.try"></a>instance.try</h2><p>根据instance实例对象快速生成try&#x2F;catch代码块</p>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>IDEA</tag>
        <tag>快捷键</tag>
      </tags>
  </entry>
  <entry>
    <title>Java中一个对象占用多少个字节</title>
    <url>/2022/01/20/java/java-zhong-yi-ge-dui-xiang-zhan-yong-duo-shao-ge-zi-jie/</url>
    <content><![CDATA[<blockquote>
<p>说明：本文内容参考文章:<a href="https://www.cnblogs.com/jajian/p/13681781.html">码辣架构-Java对象的内存布局</a>，详解内容请阅读原文。</p>
</blockquote>
<h1 id="一、问题背景"><a href="#一、问题背景" class="headerlink" title="一、问题背景"></a>一、问题背景</h1><p>在开发过程中，我们经常使用JVM进行缓存一些数据来提高程序的性能，但是我们需要对缓存的数据进行大小估算，防止产生OOM问题，为保证估算的准确性，需要了解一个Java对象在内存中具体占用多少个字节。</p>
<h1 id="二、一个Java对象的组成"><a href="#二、一个Java对象的组成" class="headerlink" title="二、一个Java对象的组成"></a>二、一个Java对象的组成</h1><table>
<thead>
<tr>
<th>组成部分</th>
<th>对象头（object header）</th>
<th>实例数据（Instance Data）</th>
<th>对齐填充（Padding）</th>
</tr>
</thead>
<tbody><tr>
<td>说明</td>
<td>包括了关于堆对象的布局、类型、GC状态、同步状态和标识哈希码的基本信息。Java对象和vm内部对象都有一个共同的对象头格式。</td>
<td>主要是存放类的数据信息，父类的信息，对象字段属性信息。</td>
<td>为了字节对齐，填充的数据，不是必须的。</td>
</tr>
<tr>
<td>大小</td>
<td>12 byte</td>
<td>基本类型数据类型和引用类型的大小</td>
<td>对象大小不满足8byte的倍数时进行填充</td>
</tr>
</tbody></table>
<blockquote>
<p>提示：JDK6之后默认都是开始指针压缩的，所以对象头中<code>mark word</code>占用8个byte，<code>klass pointer</code>占用4个byte</p>
</blockquote>
<h2 id="object-header"><a href="#object-header" class="headerlink" title="object header"></a>object header</h2><blockquote>
<p>Common structure at the beginning of every GC-managed heap object. (Every oop points to an object header.) Includes fundamental information about the heap object’s layout, type, GC state, synchronization state, and identity hash code.<br>Consists of two words. In arrays it is immediately followed by a length field. Note that both Java objects and VM-internal objects have a common object header format.</p>
</blockquote>
<h3 id="mark-word"><a href="#mark-word" class="headerlink" title="mark word"></a>mark word</h3><blockquote>
<p>The first word of every object header. Usually a set of bitfields including synchronization state and identity hash code. May also be a pointer (with characteristic low bit encoding) to synchronization related information. During GC, may contain GC state bits.</p>
</blockquote>
<p>用于存储对象自身的运行时数据，如哈希码（HashCode）、GC分代年龄、锁状态标志、线程持有的锁、偏向线程ID、偏向时间戳等等。</p>
<blockquote>
<p>Mark Word在32位JVM中的长度是32bit，在64位JVM中长度是64bit。<br>打开openjdk的源码包，对应路径&#x2F;openjdk&#x2F;hotspot&#x2F;src&#x2F;share&#x2F;vm&#x2F;oops，Mark Word对应到C++的代码markOop.hpp，可以从注释中看到它们的组成，本文所有代码是基于Jdk1.8。</p>
</blockquote>
<p><img src="/2022/01/20/java/java-zhong-yi-ge-dui-xiang-zhan-yong-duo-shao-ge-zi-jie/markoop.png" alt="markoop"><br>Mark Word在不同的锁状态下存储的内容不同，在32位JVM中是这么存的<br><img src="/2022/01/20/java/java-zhong-yi-ge-dui-xiang-zhan-yong-duo-shao-ge-zi-jie/markword32.png" alt="markword32"><br>在64位JVM中是这么存的<br><img src="/2022/01/20/java/java-zhong-yi-ge-dui-xiang-zhan-yong-duo-shao-ge-zi-jie/markword64.png" alt="markword64"></p>
<p>虽然它们在不同位数的JVM中长度不一样，但是基本组成内容是一致的。</p>
<ul>
<li>锁标志位（lock）：区分锁状态，11时表示对象待GC回收状态, 只有最后2位锁标识(11)有效。</li>
<li>biased_lock：是否偏向锁，由于无锁和偏向锁的锁标识都是 01，没办法区分，这里引入一位的偏向锁标识位。</li>
<li>分代年龄（age）：表示对象被GC的次数，当该次数到达阈值的时候，对象就会转移到老年代。</li>
<li>对象的hashcode（hash）：运行期间调用System.identityHashCode()来计算，延迟计算，并把结果赋值到这里。当对象加锁后，计算的结果31位不够表示，在偏向锁，轻量锁，重量锁，hashcode会被转移到Monitor中。</li>
<li>偏向锁的线程ID（JavaThread）：偏向模式的时候，当某个线程持有对象的时候，对象这里就会被置为该线程的ID。 在后面的操作中，就无需再进行尝试获取锁的动作。</li>
<li>epoch：偏向锁在CAS锁操作过程中，偏向性标识，表示对象更偏向哪个锁。</li>
<li>ptr_to_lock_record：轻量级锁状态下，指向栈中锁记录的指针。当锁获取是无竞争的时，JVM使用原子操作而不是OS互斥。这种技术称为轻量级锁定。在轻量级锁定的情况下，JVM通过CAS操作在对象的标题字中设置指向锁记录的指针。</li>
<li>ptr_to_heavyweight_monitor：重量级锁状态下，指向对象监视器Monitor的指针。如果两个不同的线程同时在同一个对象上竞争，则必须将轻量级锁定升级到Monitor以管理等待的线程。在重量级锁定的情况下，JVM在对象的ptr_to_heavyweight_monitor设置指向Monitor的指针。</li>
</ul>
<h3 id="klass-pointer"><a href="#klass-pointer" class="headerlink" title="klass pointer"></a>klass pointer</h3><blockquote>
<p>The second word of every object header. Points to another object (a metaobject) which describes the layout and behavior of the original object. For Java objects, the “klass” contains a C++ style “vtable”.</p>
</blockquote>
<p>即类型指针，是对象指向它的类元数据的指针，虚拟机通过这个指针来确定这个对象是哪个类的实例。<br>JVM默认开启了指针压缩 ，对象头占了12byte，类型指针占4个byte，如果关闭指针压缩则类型指针占8个byte。</p>
<blockquote>
<p>jdk8版本是默认开启指针压缩的，可以通过配置vm参数开启关闭指针压缩，-XX:-UseCompressedOops。</p>
</blockquote>
<h2 id="实例数据"><a href="#实例数据" class="headerlink" title="实例数据"></a>实例数据</h2><p>如果对象有属性字段，则这里会有数据信息。如果对象无属性字段，则这里就不会有数据。根据字段类型的不同占不同的字节，例如boolean类型占1个字节，int类型占4个字节等等；</p>
<h2 id="对齐数据"><a href="#对齐数据" class="headerlink" title="对齐数据"></a>对齐数据</h2><p>对象可以有对齐数据也可以没有。默认情况下，Java虚拟机堆中对象的起始地址需要对齐至8的倍数。如果一个对象用不到8N个字节则需要对其填充，以此来补齐对象头和实例数据占用内存之后剩余的空间大小。如果对象头和实例数据已经占满了JVM所分配的内存空间，那么就不用再进行对齐填充了。</p>
<p>所有的对象分配的字节总SIZE需要是8的倍数，如果前面的对象头和实例数据占用的总SIZE不满足要求，则通过对齐数据来填满。</p>
<h3 id="为什么要对齐数据？"><a href="#为什么要对齐数据？" class="headerlink" title="为什么要对齐数据？"></a>为什么要对齐数据？</h3><p>字段内存对齐的其中一个原因，是让字段只出现在同一CPU的缓存行中。如果字段不是对齐的，那么就有可能出现跨缓存行的字段。也就是说，该字段的读取可能需要替换两个缓存行，而该字段的存储也会同时污染两个缓存行。这两种情况对程序的执行效率而言都是不利的。其实对其填充的最终目的是为了计算机高效寻址。</p>
<p>至此，我们已经了解了对象在堆内存中的整体结构布局，如下图所示：<br><img src="/2022/01/20/java/java-zhong-yi-ge-dui-xiang-zhan-yong-duo-shao-ge-zi-jie/object-component.png" alt="object-component"></p>
<h1 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h1><p>一个Java对象由三部分组成，分别是对象头、实例数据、填充数据：</p>
<ul>
<li>对象头占12个字节（64位JVM），包括<code>mark word</code>、<code>klass pointer</code>两个部分</li>
<li>实例数据中包括基本类型和引用类型，基本类型占对应大小，引用类型占用1个字节</li>
<li>当对象的大小不是8字节的倍数的时候，对齐数据则会进行填充</li>
</ul>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><blockquote>
<p><a href="https://www.cnblogs.com/jajian/p/13681781.html">Java对象的内存布局</a><br><a href="https://www.jianshu.com/p/ad505f9163b2">如何正确计算Java对象所占内存？</a></p>
</blockquote>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>对象</tag>
      </tags>
  </entry>
  <entry>
    <title>Java 和 HTTP 的那些事（四） HTTPS 和 证书</title>
    <url>/2020/07/09/java/java-he-http-de-na-xie-shi-si-https-he-zheng-shu/</url>
    <content><![CDATA[<blockquote>
<p>非原创，转载于：<a href="https://www.aneasystone.com/archives/2016/04/java-and-https.html">https://www.aneasystone.com/archives/2016/04/java-and-https.html</a></p>
</blockquote>
<p>说起 HTTP 的那些事，则不得不提 HTTPS ，而说起 HTTPS ，则不得不提数字证书。这篇博客将从 Java 的角度，学习 HTTPS 和数字证书技术，并分享爬虫开发的过程中针对爬取 HTTPS 站点时可能遇到的一些问题。<br>在前面的几篇博客里，其实已经略微提到过 HTTPS 了，譬如使用 <code>HttpsURLConnection</code> 类发送 HTTPS 请求，在使用代理时 HTTP 和 HTTPS 的一些差异等等。关于 HTTPS 的概念就不废话了，下面直接进入正题。</p>
<h2 id="一、访问-HTTPS-站点"><a href="#一、访问-HTTPS-站点" class="headerlink" title="一、访问 HTTPS 站点"></a>一、访问 HTTPS 站点</h2><p>在前面的第一篇博客<a href="https://www.aneasystone.com/archives/2015/12/java-and-http-one.html">《模拟 HTTP 请求》</a>里，介绍了两种方法来模拟发送 HTTP 请求，访问 HTTP 站点。一种方式是通过 java.net 自带的 <code>HttpURLConnection</code>，另一种方式是通过 Apache 的 <code>HttpClient</code>，这两种方式各有各的优势。这里也使用这两种方式来访问 HTTPS 站点，从下面的代码可以看到，和前面访问 HTTP 站点几乎完全一样。</p>
<h3 id="1-1-使用-HttpURLConnection"><a href="#1-1-使用-HttpURLConnection" class="headerlink" title="1.1 使用 HttpURLConnection"></a>1.1 使用 HttpURLConnection</h3><pre class="line-numbers language-none"><code class="language-none">@Test
public void basicHttpsGet() throws Exception &#123;
     
    String url &#x3D; &quot;https:&#x2F;&#x2F;www.baidu.com&quot;;
    URL obj &#x3D; new URL(url);
 
    HttpsURLConnection con &#x3D; (HttpsURLConnection) obj.openConnection();    
    con.setRequestProperty(&quot;User-Agent&quot;, &quot;Mozilla&#x2F;5.0 (Windows NT 6.1; WOW64) ...&quot;);
    con.setRequestProperty(&quot;Accept-Language&quot;, &quot;en-US,en;q&#x3D;0.5&quot;);
    con.setRequestMethod(&quot;GET&quot;);
 
    String responseBody &#x3D; readResponseBody(con.getInputStream());
    System.out.println(responseBody);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="1-2-使用-HttpClient"><a href="#1-2-使用-HttpClient" class="headerlink" title="1.2 使用 HttpClient"></a>1.2 使用 HttpClient</h3><pre class="line-numbers language-none"><code class="language-none">@Test
public void basicHttpsGet() throws Exception &#123;
     
    String url &#x3D; &quot;https:&#x2F;&#x2F;www.baidu.com&quot;;    
    HttpGet request &#x3D; new HttpGet(url);
    request.setHeader(&quot;User-Agent&quot;, &quot;Mozilla&#x2F;5.0 (Windows NT 6.1; WOW64) ...&quot;);
     
    CloseableHttpClient httpclient &#x3D; HttpClients.createDefault();
    CloseableHttpResponse response &#x3D; httpclient.execute(request);
    String responseBody &#x3D; readResponseBody(response);
    System.out.println(responseBody);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>具体的代码解释参见第一篇博客，这里不再赘述。一般情况下，访问 HTTPS 站点就和访问 HTTP 站点一样简单，无论是 HttpURLConnection 还是 HttpClient ，都将底层的实现细节封装了起来，给我们提供了一致的对外接口，所以我们不用关心 HTTPS 的实现原理。对底层细节的封装，本来是一件好事，也是一种好的设计方式，可以让开发人员使用起来更方便，提高开发效率，但是对于那些不求甚解的人来说，可能带来的困惑比之带来的方便要更多。</p>
<h3 id="1-3-遭遇-PKIX-path-building-failed"><a href="#1-3-遭遇-PKIX-path-building-failed" class="headerlink" title="1.3 遭遇 PKIX path building failed"></a>1.3 遭遇 PKIX path building failed</h3><p>使用上面的代码作为爬虫程序爬取成千上万的网页，在大多数情况下，无论是 HTTP 也好，HTTPS 也罢，都可以很好的工作。不过有时候，你可能没那么好的运气，有些站点在墙外，被强大的防火长城拒之门外，这时你可以找一些境外代理，通过<a href="https://www.aneasystone.com/archives/2015/12/java-and-http-using-proxy.html">《使用代理》</a>这篇博客中介绍的方法来解决；有些站点需要使用身份认证输入用户名密码才能访问，这可以使用上一篇博客<a href="https://www.aneasystone.com/archives/2016/03/java-and-http-authentication.html">《代理认证》</a>中介绍的方法来解决；另外，在访问有些 HTTPS 站点时，你还可能会遇到下面的异常：</p>
<blockquote>
<p>javax.net.ssl.SSLHandshakeException:<br>sun.security.validator.ValidatorException: PKIX path building failed:<br>sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target</p>
</blockquote>
<p>要解决这个异常，这就是我们这篇将要介绍的内容。</p>
<h2 id="二、证书认证的原理"><a href="#二、证书认证的原理" class="headerlink" title="二、证书认证的原理"></a>二、证书认证的原理</h2><p>大多数人第一次遇到上面的异常时的反应，估计都是一脸茫然，因为这个异常信息提示比较模糊，对于不懂 HTTPS 的人来说，什么 SSLHandshake ，什么 PKIX path ，完全不知所云。所以我们要先弄懂 HTTPS 的工作原理，才好去解决这个问题。我们知道 HTTPS 其实就是 HTTP + SSL&#x2F;TLS 的合体，它其实还是 HTTP 协议，只是在外面加了一层，SSL 是一种加密安全协议，引入 SSL 的目的是为了解决 HTTP 协议在不可信网络中使用明文传输数据导致的安全性问题。可以说，整个互联网的通信安全，都是建立在 SSL&#x2F;TLS 的安全性之上的。</p>
<h3 id="2-1-SSL-TLS-协议及其握手过程"><a href="#2-1-SSL-TLS-协议及其握手过程" class="headerlink" title="2.1 SSL&#x2F;TLS 协议及其握手过程"></a>2.1 SSL&#x2F;TLS 协议及其握手过程</h3><p>学过计算机网络的同学肯定都还记得 TCP 在建立连接时的三次握手，之所以需要 TCP 三次握手，是因为网络中存在延迟的重复分组，可能会导致服务器重复建立连接造成不必要的开销。SSL&#x2F;TLS 协议在建立连接时与此类似，也需要客户端和服务器之间进行握手，但是其目的却大相径庭，在 SSL&#x2F;TLS 握手的过程中，客户端和服务器彼此交换并验证证书，并协商出一个 “对话密钥” ，后续的所有通信都使用这个 “对话密钥” 进行加密，保证通信安全。</p>
<p>网上有很多 SSL&#x2F;TLS 握手的示意图，其中下面这副非常全面，也非常专业，想深入了解 SSL&#x2F;TLS 的同学可以研究下。</p>
<p><a href="http://www.cheat-sheets.org/saved-copy/Ssl_handshake_with_two_way_authentication_with_certificates-1.pdf">http://www.cheat-sheets.org/saved-copy/Ssl_handshake_with_two_way_authentication_with_certificates-1.pdf</a></p>
<p>阮一峰在他的 <a href="http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html">《SSL&#x2F;TLS协议运行机制的概述》</a> 和 <a href="http://www.ruanyifeng.com/blog/2014/09/illustration-ssl.html">《图解SSL&#x2F;TLS协议》</a> 两篇博客中详细介绍了 SSL&#x2F;TLS 的原理，感兴趣的同学可以去看看。我这里使用 <a href="https://publib.boulder.ibm.com/tividd/td/TRM/SC23-4822-00/zh_CN/HTML/user277.htm">IBM Tivoli Risk Manager 用户手册</a> 里的一张图（因为这张图比较浅显易懂）来大概的说明下我们在平时使用浏览器访问 HTTPS 站点时，中间发生的握手过程。</p>
<p><img src="https://www.aneasystone.com/usr/uploads/2016/04/3515553513.png" alt="ssl_handshake.png"></p>
<p>整个 SSL&#x2F;TLS 的握手和通信过程，简单来说，其实可以分成下面三个阶段：</p>
<ol>
<li>打招呼<ul>
<li>当用户通过浏览器访问 HTTPS 站点时，浏览器会向服务器打个招呼（ClientHello），服务器也会和浏览器打个招呼（ServerHello）。所谓的打招呼，实际上是告诉彼此各自的 SSL&#x2F;TLS 版本号以及各自支持的加密算法等，让彼此有一个初步了解。</li>
</ul>
</li>
<li>表明身份、验证身份<ul>
<li>第二步是整个过程中最复杂的一步，也是 HTTPS 通信中的关键。为了保证通信的安全，首先要保证我正在通信的人确实就是那个我想与之通信的人，服务器会发送一个证书来表明自己的身份，浏览器根据证书里的信息进行核实（为什么通过证书就可以证明身份呢？怎么通过证书来验证对方的身份呢？这个后面再说）。如果是双向认证的话，浏览器也会向服务器发送客户端证书。</li>
<li>双方的身份都验证没问题之后，浏览器会和服务器协商出一个 “对话密钥” ，要注意这个 “对话密钥” 不能直接发给对方，而是要用一种只有对方才能懂的方式发给他，这样才能保证密钥不被别人截获（或者就算被截获了也看不懂）。</li>
</ul>
</li>
<li>通信<ul>
<li>至此，握手就结束了。双方开始聊天，并通过 “对话密钥” 加密通信的数据。</li>
</ul>
</li>
</ol>
<p>握手的过程大致如此，我们现在已经了解到 HTTPS 通信需要进行一次握手，所以上面看到的 <code>javax.net.ssl.SSLHandshakeException</code> 这个异常，我们也不难理解，实际上也就是在 SSL&#x2F;TLS 握手的过程中出现了问题。当然，这其中还有很多很多细节，下面继续。</p>
<h3 id="2-2-HTTPS-中的密码学"><a href="#2-2-HTTPS-中的密码学" class="headerlink" title="2.2 HTTPS 中的密码学"></a>2.2 HTTPS 中的密码学</h3><p>HTTPS 协议之所以复杂，是为了保证通信过程中数据的安全性，而要保证通信安全，它在协议中运用了大量的密码学原理，可以说 HTTPS 是集密码学之大成。无论是在 SSL&#x2F;TLS 握手的过程中，还是在加密通信的过程中，HTTPS 都涉及了大量的密码学概念，譬如，在证书的数字签名中使用了哈希算法和非对称加密算法，在加密通信的过程中使用了对称加密算法，为了防止传输的数据被篡改和重放还使用了 MAC（消息认证码）等。</p>
<p>要想深入了解 HTTPS 的工作原理，下面这些概念还是得好好研究下，网上已经有很多文章介绍这些概念了，我在这里总结一下。</p>
<ul>
<li>哈希<ul>
<li>哈希算法又称散列，它是一种将任意长度的数据转化为固定长度的算法</li>
<li>哈希算法是不可逆的</li>
<li>常见的哈希算法有 MD5 和 SHA1</li>
</ul>
</li>
<li>对称加密<ul>
<li>对称加密指的是加密和解密使用相同一个密钥</li>
<li>对称加密的优点是速度快，缺点是密钥管理不方便，必须共享密钥</li>
<li>常见的对称加密算法有 DES、AES、Blowfish 等</li>
</ul>
</li>
<li>非对称加密<ul>
<li>非对称加密指的是加密和解密使用不同的密钥，其中一个是公钥，另一个是私钥，公钥是公开的，私钥只有自己知道</li>
<li>使用公钥加密的数据必须使用私钥解密，使用私钥加密的数据必须使用公钥解密</li>
<li>公钥和私钥之间存在着某种联系，但是从公钥不能（或很难）推导出私钥</li>
<li>非对称加密的缺点是速度慢，优点是密钥管理很方便</li>
<li>常见的非对称加密算法有 RSA、ECC 等</li>
</ul>
</li>
<li>数字证书</li>
</ul>
<h3 id="2-3-关于证书"><a href="#2-3-关于证书" class="headerlink" title="2.3 关于证书"></a>2.3 关于证书</h3><p>简单来说，数字证书就好比介绍信上的公章，有了它，就可以证明这份介绍信确实是由某个公司发出的，而证书可以用来证明任何一个东西的身份，只要这个东西能出示一份证明自己身份的证书即可，譬如可以用来验证某个网站的身份，可以验证某个文件是否可信等等。<a href="https://program-think.blogspot.com/2010/02/introduce-digital-certificate-and-ca.html">《数字证书及 CA 的扫盲介绍》</a> 和 <a href="http://www.cnblogs.com/JeffreySun/archive/2010/06/24/1627247.html">《数字证书原理》</a> 这篇博客对数字证书进行了很通俗的介绍。</p>
<p>知道了证书是什么之后，我们往往更关心它的原理，在上面介绍 SSL&#x2F;TLS 握手的时候留了两个问题：为什么通过证书就可以证明身份呢？怎么通过证书来验证对方的身份呢？</p>
<p>这就要用到上面所说的非对称加密了，非对称加密的一个重要特点是：使用公钥加密的数据必须使用私钥才能解密，同样的，使用私钥加密的数据必须使用公钥解密。正是因为这个特点，网站就可以在自己的证书中公开自己的公钥，并使用自己的私钥将自己的身份信息进行加密一起公开出来，这段被私钥加密的信息就是证书的数字签名，浏览器在获取到证书之后，通过证书里的公钥对签名进行解密，如果能成功解密，则说明证书确实是由这个网站发布的，因为只有这个网站知道他自己的私钥（如果他的私钥没有泄露的话）。</p>
<p>在非对称加密算法中，最出众的莫过于 RSA 算法，关于 RSA 算法的数学细节，可以参考阮一峰的<a href="http://www.ruanyifeng.com/blog/2013/06/rsa_algorithm_part_one.html">《RSA算法原理（一）》</a>和<a href="http://www.ruanyifeng.com/blog/2013/07/rsa_algorithm_part_two.html">《RSA算法原理（二）》</a>这两篇博客，强烈推荐。</p>
<p>当然，如果只是简单的对数字签名进行校验的话，还不能完全保证这个证书确实就是网站所有，黑客完全可以在中间进行劫持，使用自己的私钥对网站身份信息进行加密，并将证书中的公钥替换成自己的公钥，这样浏览器同样可以解密数字签名，签名中身份信息也是完全合法的。这就好比那些地摊上伪造公章的小贩，他们可以伪造出和真正的公章完全一样的出来以假乱真。为了解决这个问题，信息安全的专家们引入了 CA 这个东西，所谓 CA ，全称为 Certificate Authority ，翻译成中文就是<a href="https://zh.wikipedia.org/wiki/%E6%95%B0%E5%AD%97%E8%AF%81%E4%B9%A6%E8%AE%A4%E8%AF%81%E6%9C%BA%E6%9E%84">证书授权中心</a>，它是专门负责管理和签发证书的第三方机构。因为证书颁发机构关系到所有互联网通信的身份安全，因此一定要是一个非常权威的机构，像 GeoTrust、GlobalSign 等等，这里有一份<a href="https://www.sslshopper.com/certificate-authority-reviews.html">常见的 CA 清单</a>。如果一个网站需要支持 HTTPS ，它就要一份证书来证明自己的身份，而这个证书必须从 CA 机构申请，大多数情况下申请数字证书的价格都不菲，不过也有一些免费的证书供个人使用，像最近比较火的 <a href="https://letsencrypt.org/">Let’s Encrypt</a> 。从安全性的角度来说，免费的和收费的证书没有任何区别，都可以为你的网站提供足够高的安全性，唯一的区别在于如果你从权威机构购买了付费的证书，一旦由于证书安全问题导致经济损失，可以获得一笔巨额的赔偿。</p>
<p>如果用户想得到一份属于自己的证书，他应先向 CA 提出申请。在 CA 判明申请者的身份后，便为他分配一个公钥，并且 CA 将该公钥与申请者的身份信息绑在一起，并为之签字后，便形成证书发给申请者。如果一个用户想鉴别另一个证书的真伪，他就用 CA 的公钥对那个证书上的签字进行验证，一旦验证通过，该证书就被认为是有效的。通过这种方式，黑客就不能简单的修改证书中的公钥了，因为现在公钥有了 CA 的数字签名，由 CA 来证明公钥的有效性，不能轻易被篡改，而黑客自己的公钥是很难被 CA 认可的，所以我们无需担心证书被篡改的问题了。</p>
<p>下图显示了证书的申请流程（图片来自<a href="https://blog.cnbluebox.com/blog/2014/03/24/shu-zi-zheng-shu/">刘坤的技术博客</a>）：</p>
<p><img src="https://www.aneasystone.com/usr/uploads/2016/04/3454538623.png" alt="shuzizhengshu_5.png"></p>
<p>CA 证书可以具有层级结构，它建立了自上而下的信任链，下级 CA 信任上级 CA ，下级 CA 由上级 CA 颁发证书并认证。 譬如 Google 的证书链如下图所示：</p>
<p><img src="https://www.aneasystone.com/usr/uploads/2016/04/3953592763.png" alt="shuzizhengshu_6.png"></p>
<p>可以看出：google.com.hk 的 SSL 证书由 Google Internet Authority G2 这个 CA 来验证，而 Google Internet Authority G2 由 GeoTrust Global CA 来验证，GeoTrust Global CA 由 Equifax Secure Certificate Authority 来验证。这个最顶部的证书，我们称之为根证书（root certificate），那么谁来验证根证书呢？答案是它自己，根证书自己证明自己，换句话来说也就是根证书是不需要证明的。浏览器在验证证书时，从根证书开始，沿着证书链的路径依次向下验证，根证书是整个证书链的安全之本，如果根证书被篡改，整个证书体系的安全将受到威胁。所以不要轻易的相信根证书，当下次你访问某个网站遇到提示说，请安装我们的根证书，它可以让你访问我们网站的体验更流畅通信更安全时，最好留个心眼。在安装之前，不妨看看这几篇博客：<a href="https://www.jayxon.com/12306-certificate/">《12306的证书问题》</a>、<a href="http://www.xieyidian.com/3213">《在线买火车票为什么要安装根证书？》</a>。</p>
<p>最后总结一下，其实上面说的这些，什么非对称加密，数字签名，CA 机构，根证书等等，其实都是 PKI 的核心概念。PKI（Public Key Infrastructure）中文称作公钥基础设施，它提供公钥加密和数字签名服务的系统或平台，方便管理密钥和证书，从而建立起一个安全的网络环境。而数字证书最常见的格式是 X.509 ，所以这种公钥基础设施又称之为 PKIX 。</p>
<p>至此，我们大致弄懂了上面的异常信息，<code>sun.security.validator.ValidatorException: PKIX path building failed</code>，也就是在沿着证书链的路径验证证书时出现异常，验证失败了。</p>
<p>讲了这么多，全都是些理论的东西，下面开始实践吧，看看怎么解决这个异常。</p>
<h3 id="2-4-关于-Java-里的证书"><a href="#2-4-关于-Java-里的证书" class="headerlink" title="2.4 关于 Java 里的证书"></a>2.4 关于 Java 里的证书</h3><p>上面所介绍的是浏览器对证书进行验证的过程，浏览器保存了一个常用的 CA 证书列表，在验证证书链的有效性时，直接使用保存的证书里的公钥进行校验，如果在证书列表中没有找到或者找到了但是校验不通过，那么浏览器会警告用户，由用户决定是否继续。与此类似的，操作系统也一样保存有一份可信的证书列表，譬如在 Windows 系统下，你可以运行 <code>certmgr.msc</code> 打开证书管理器查看，这些证书实际上是存储在 Windows 的注册表中，一般情况下位于：<code>\SOFTWARE\Microsoft\SystemCertificates\</code> 路径下。那么在 Java 程序中是如何验证证书的呢？</p>
<p>和浏览器和操作系统类似，Java 在 JRE 的安装目录下也保存了一份默认可信的证书列表，这个列表一般是保存在 <code>$JRE/lib/security/cacerts</code> 文件中。要查看这个文件，可以使用类似 <a href="http://www.keystore-explorer.org/">KeyStore Explorer</a> 这样的软件，当然也可以使用 JRE 自带的 keytool 工具（后面再介绍），cacerts 文件的默认密码为 <code>changeit</code> （但是我保证，大多数人都不会 change it）。</p>
<p>我们知道，证书有很多种不同的存储格式，譬如 CA 在发布证书时，常常使用 PEM 格式，这种格式的好处是纯文本，内容是 BASE64 编码的，证书中使用 “—–BEGIN CERTIFICATE—–” 和 “—–END CERTIFICATE—–” 来标识。另外还有比较常用的二进制 DER 格式，在 Windows 平台上较常使用的 PKCS#12 格式等等。当然，不同格式的证书之间是可以相互转换的，我们可以使用 <code>openssl</code> 这个命令行工具来转换，参考 <a href="https://www.sslshopper.com/ssl-converter.html">SSL Converter</a> ，另外，想了解更多证书格式的，可以参考这里：<a href="https://blogs.msdn.microsoft.com/kaushal/2010/11/04/various-ssltls-certificate-file-typesextensions/">Various SSL&#x2F;TLS Certificate File Types&#x2F;Extensions</a> 。</p>
<p>在 Java 平台下，证书常常被存储在 KeyStore 文件中，上面说的 cacerts 文件就是一个 KeyStore 文件，KeyStore 不仅可以存储数字证书，还可以存储密钥，存储在 KeyStore 文件中的对象有三种类型：Certificate、PrivateKey 和 SecretKey 。Certificate 就是证书，PrivateKey 是非对称加密中的私钥，SecretKey 用于对称加密，是对称加密中的密钥。KeyStore 文件根据用途，也有很多种不同的格式：JKS、JCEKS、PKCS12、DKS 等等，PixelsTech 上有一系列文章对 KeyStore 有深入的介绍，可以学习下：<a href="http://www.pixelstech.net/article/1408345768-Different-types-of-keystore-in-Java----Overview">Different types of keystore in Java</a> 。</p>
<p>到目前为止，我们所说的 KeyStore 其实只是一种文件格式而已，实际上在 Java 的世界里 KeyStore 文件分成两种：KeyStore 和 TrustStore，这是两个比较容易混淆的概念，不过这两个东西从文件格式来看其实是一样的。KeyStore 保存私钥，用来加解密或者为别人做签名；TrustStore 保存一些可信任的证书，访问 HTTPS 时对被访问者进行认证，以确保它是可信任的。所以准确来说，上面的 cacerts 文件应该叫做 TrustStore 而不是 KeyStore，只是它的文件格式是 KeyStore 文件格式罢了。</p>
<p>除了 KeyStore 和 TrustStore ，Java 里还有两个类 KeyManager 和 TrustManager 与此息息相关。<a href="http://docs.oracle.com/javase/6/docs/technotes/guides/security/jsse/JSSERefGuide.html">JSSE 的参考手册</a>中有一张示意图，说明了各个类之间的关系：</p>
<p><img src="https://www.aneasystone.com/usr/uploads/2016/04/4013537635.jpg" alt="jsse-class.jpg"></p>
<p>可以看出如果要进行 SSL 会话，必须得新建一个 <code>SSLSocket</code> 对象，而 SSLSocket 对象是通过 <code>SSLSocketFactory</code> 来管理的，SSLSocketFactory 对象则依赖于 <code>SSLContext</code> ，SSLContext 对象又依赖于 <code>keyManager</code>、<code>TrustManager</code> 和 <code>SecureRandom</code>。我们这里最关心的是 TrustManager 对象，另外两个暂且忽略，因为正是 TrustManager 负责证书的校验，对网站进行认证，要想在访问 HTTPS 时通过认证，不报 <code>sun.security.validator.ValidatorException</code> 异常，必须从这里开刀。</p>
<h2 id="三、自定义-TrustManager-绕过证书检查"><a href="#三、自定义-TrustManager-绕过证书检查" class="headerlink" title="三、自定义 TrustManager 绕过证书检查"></a>三、自定义 TrustManager 绕过证书检查</h2><p>我们知道了 TrustManager 是专门负责校验证书的，那么最容易想到的方法应该就是改写 TrustManager 类，让它不要对证书做校验，这种方法虽然粗暴，但是却相当有效，而且 Java 中的 TrustManager 也确实可以被重写，下面是示例代码：</p>
<pre class="line-numbers language-none"><code class="language-none">@Test
public void basicHttpsGetIgnoreCertificateValidation() throws Exception &#123;
     
    String url &#x3D; &quot;https:&#x2F;&#x2F;kyfw.12306.cn&#x2F;otn&#x2F;&quot;;
     
    &#x2F;&#x2F; Create a trust manager that does not validate certificate chains
    TrustManager[] trustAllCerts &#x3D; new TrustManager[] &#123;
        new X509TrustManager() &#123;
            public X509Certificate[] getAcceptedIssuers() &#123;
                return null;
            &#125;
            public void checkClientTrusted(X509Certificate[] certs, String authType) &#123;
                &#x2F;&#x2F; don&#39;t check
            &#125;
            public void checkServerTrusted(X509Certificate[] certs, String authType) &#123;
                &#x2F;&#x2F; don&#39;t check
            &#125;
        &#125;
    &#125;;
     
    SSLContext ctx &#x3D; SSLContext.getInstance(&quot;TLS&quot;);
    ctx.init(null, trustAllCerts, null);
     
    LayeredConnectionSocketFactory sslSocketFactory &#x3D; new SSLConnectionSocketFactory(ctx);
     
    CloseableHttpClient httpclient &#x3D; HttpClients.custom()
            .setSSLSocketFactory(sslSocketFactory)
            .build();
     
    HttpGet request &#x3D; new HttpGet(url);
    request.setHeader(&quot;User-Agent&quot;, &quot;Mozilla&#x2F;5.0 (Windows NT 6.1; WOW64) ...&quot;);
     
    CloseableHttpResponse response &#x3D; httpclient.execute(request);
    String responseBody &#x3D; readResponseBody(response);
    System.out.println(responseBody);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们新建了一个匿名类，继承自 <a href="http://docs.oracle.com/javase/6/docs/technotes/guides/security/jsse/JSSERefGuide.html#X509TrustManager"><code>X509TrustManager</code></a> 接口，这个接口提供了三个方法用于验证证书的有效性：<code>getAcceptedIssuers</code>、<code>checkClientTrusted</code>、<code>checkServerTrusted</code>，我们在验证的函数中直接返回，不做任何校验，这样在访问 HTTPS 站点时，就算是证书不可信，也不会抛出异常，可以继续执行下去。</p>
<p>这种方法虽然简单，但是却有一个最严重的问题，就是不安全。因为不对证书做任何合法性校验，而且这种处理是全局性的，不管青红皂白，所有的证书都不会做验证，所以就算遇到不信任的证书，代码依然会继续与之通信，至于通信的数据安全不安全就不能保证了。所以如果你只是想在测试环境做个实验，那没问题，但是如果你要将代码发布到生产环境，请慎重。</p>
<h2 id="四、使用证书"><a href="#四、使用证书" class="headerlink" title="四、使用证书"></a>四、使用证书</h2><p>对于有些证书，我们基本上确定是可以信任的，但是这些证书又不在 Java 的 cacerts 文件中，譬如 12306 网站，或者使用了 Let’s Encrypt 证书的一些网站，对于这些网站，我们可以将其添加到信任列表中，而不是使用上面的方法统统都相信，这样程序的安全性仍然可以得到保障。</p>
<h3 id="4-1-使用-keytool-导入证书"><a href="#4-1-使用-keytool-导入证书" class="headerlink" title="4.1 使用 keytool 导入证书"></a>4.1 使用 keytool 导入证书</h3><p>简单的做法是将这些网站的证书导入到 cacerts 文件中，这样 Java 程序在校验证书的时候就可以从 cacerts 文件中找到并成功校验这个证书了。上面我们介绍过 JRE 自带的 keytool 这个工具，这个工具小巧而强悍，拥有很多功能。首先我们可以使用它查看 KeyStore 文件，使用下面的命令可以列出 KeyStore 文件中的所有内容（包括证书、私钥等）：</p>
<pre class="line-numbers language-none"><code class="language-none">$ keytool -list -keystore cacerts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后通过下面的命令，将证书导入到 cacerts 文件中：</p>
<pre class="line-numbers language-none"><code class="language-none">$ keytool -import -alias 12306 -keystore cacerts -file 12306.cer<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>要想将网站的证书导入 cacerts 文件中，首先要获取网站的证书，譬如上面命令中的 12306.cer 文件，它是使用浏览器的证书导出向导保存的。如下图所示：</p>
<p><img src="https://www.aneasystone.com/usr/uploads/2016/04/898222994.png" alt="export-cert.png"></p>
<p>关于 keytool 的更多用法，可以参考 <a href="https://docs.oracle.com/javase/6/docs/technotes/tools/solaris/keytool.html">keytool 的官网手册</a>，SSLShopper 上也有一篇文章列出了<a href="https://www.sslshopper.com/article-most-common-java-keytool-keystore-commands.html">常用的 keytool 命令</a>。</p>
<h3 id="4-2-使用-KeyStore-动态加载证书"><a href="#4-2-使用-KeyStore-动态加载证书" class="headerlink" title="4.2 使用 KeyStore 动态加载证书"></a>4.2 使用 KeyStore 动态加载证书</h3><p>使用 keytool 导入证书，这种方法不仅简单，而且保证了代码的安全性，最关键的是代码不用做任何修改。所以我比较推荐这种方法。但是这种方法有一个致命的缺陷，那就是你需要修改 JRE 目录下的文件，如果你的程序只是在自己的电脑上运行，那倒没什么，可如果你的程序要部署在其他人的电脑上或者公司的服务器上，而你没有权限修改 JRE 目录下的文件，这该怎么办？如果你的程序是一个分布式的程序要部署在成百上千台机器上，难道还得修改每台机器的 JRE 文件吗？好在我们还有另一种通过编程的手段来实现的思路，在代码中动态的加载 KeyStore 文件来完成证书的校验，抱着知其然知其所以然的态度，我们在最后也实践下这种方法。通过编写代码可以更深刻的了解 <code>KeyStore</code>、<code>TrustManagerFactory</code>、<code>SSLContext</code> 以及 <code>SSLSocketFactory</code> 这几个类之间的关系。</p>
<pre class="line-numbers language-none"><code class="language-none">@Test
public void basicHttpsGetUsingSslSocketFactory() throws Exception &#123;
 
    String keyStoreFile &#x3D; &quot;D:\\code\\ttt.ks&quot;;
    String password &#x3D; &quot;poiuyt&quot;;
    KeyStore ks &#x3D; KeyStore.getInstance(KeyStore.getDefaultType());
    FileInputStream in &#x3D; new FileInputStream(keyStoreFile);
    ks.load(in, password.toCharArray());
     
    System.out.println(KeyStore.getDefaultType().toString());
    System.out.println(TrustManagerFactory.getDefaultAlgorithm().toString());
     
    TrustManagerFactory tmf &#x3D; TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm());
    tmf.init(ks);
    SSLContext ctx &#x3D; SSLContext.getInstance(&quot;TLS&quot;);
    ctx.init(null, tmf.getTrustManagers(), null);
     
    LayeredConnectionSocketFactory sslSocketFactory &#x3D; new SSLConnectionSocketFactory(ctx);
     
    String url &#x3D; &quot;https:&#x2F;&#x2F;ttt.aneasystone.com&quot;;
     
    &#x2F;**
     * Return the page with content:
     *     401 Authorization Required
     *&#x2F;
     
    CloseableHttpClient httpclient &#x3D; HttpClients.custom()
            .setSSLSocketFactory(sslSocketFactory)
            .build();
     
    HttpGet request &#x3D; new HttpGet(url);
    request.setHeader(&quot;User-Agent&quot;, &quot;Mozilla&#x2F;5.0 (Windows NT 6.1; WOW64) ...&quot;);
     
    CloseableHttpResponse response &#x3D; httpclient.execute(request);
    String responseBody &#x3D; readResponseBody(response);
    System.out.println(responseBody);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面的代码使用了 HttpClient ，如果是使用 HttpsURLConnection 只需要改动下面两行即可：</p>
<pre class="line-numbers language-none"><code class="language-none">HttpsURLConnection con &#x3D; (HttpsURLConnection) obj.openConnection();
con.setSSLSocketFactory(ctx.getSocketFactory());<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>最后的最后，我们还可以通过下面的属性来指定 trustStore ，这样也不需要编写像上面那样大量繁琐的代码，另外，参考我前面的博客，这些属性还可以通过 JVM 的参数来设置。</p>
<pre class="line-numbers language-none"><code class="language-none">System.setProperty(&quot;javax.net.ssl.trustStore&quot;, &quot;D:\\code\\ttt.ks&quot;);
System.setProperty(&quot;javax.net.ssl.trustStorePassword&quot;, &quot;poiuyt&quot;);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>至此，我们的 HTTPS 之旅就要告一段落了。在学习 HTTPS 的过程中，我时时不经意的会被 HTTPS 中的一些技术或技巧感触到，特别是证书的认证过程以及非对称加密算法的原理，真的是积累了人类无穷的智慧，让人不得不感叹数学的美妙。而在学习过程中越是刨根问底，越是一发不可收拾，中间牵扯到的细节太多，太深入反而让人不自觉的迷失了方向。这篇博客断断续续的写了一个多月，慢慢的自己也是从对 HTTPS 一知半解，到现在的初窥门径。写的越多，越发觉自己很多东西不清楚，看得资料越多，越是不敢写，怕写错。这篇博客参考资料众多，质量也参差不齐，不能说对读者会起什么作用，但是确实是在我学习过程中帮我理清了很多思路。在这里对这些博客的原作者表示感谢。同时，如果你发现本篇博客中存在什么问题或错误，欢迎斧正。</p>
<p>共勉。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><a href="https://publib.boulder.ibm.com/tividd/td/TRM/SC23-4822-00/zh_CN/HTML/user277.htm">SSL 如何工作</a></li>
<li><a href="https://segmentfault.com/a/1190000002963044">SSL&#x2F;TLS 协议简介与实例分析</a></li>
<li><a href="https://segmentfault.com/a/1190000002554673">SSL&#x2F;TLS原理详解</a></li>
<li><a href="https://imququ.com/post/optimize-tls-handshake.html">TLS 握手优化详解</a></li>
<li><a href="https://imququ.com/post/how-to-decrypt-https.html">三种解密 HTTPS 流量的方法介绍</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2014/09/illustration-ssl.html">图解SSL&#x2F;TLS协议</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html">SSL&#x2F;TLS协议运行机制的概述</a></li>
<li><a href="http://www.oschina.net/news/26228/how-to-config-https">HTTPS 从原理到实战</a></li>
<li><a href="http://www.cnblogs.com/ttltry-air/archive/2012/08/20/2647898.html">HTTPS工作原理和TCP握手机制</a></li>
<li><a href="https://program-think.blogspot.com/2014/11/https-ssl-tls-0.html">扫盲 HTTPS 和 SSL&#x2F;TLS 协议</a></li>
<li><a href="http://www.guokr.com/post/114121/">HTTPS那些事（一）HTTPS原理</a></li>
<li><a href="http://www.lupaworld.com/article-252898-1.html">理解HTTPS协议</a></li>
<li><a href="http://drops.wooyun.org/tips/6002">SSL&#x2F;TLS协议安全系列：SSL&#x2F;TLS概述</a></li>
<li><a href="http://www.pixelstech.net/article/1408345768-Different-types-of-keystore-in-Java----Overview">Different types of keystore in Java – Overview</a></li>
<li><a href="http://www.pixelstech.net/article/1409966488-Different-types-of-keystore-in-Java----JKS">Different types of keystore in Java – JKS</a></li>
<li><a href="http://www.binghe.org/2010/03/use-httpsurlconnection-in-java/">Java中用HttpsURLConnection访问Https链接的问题</a></li>
<li><a href="http://superuser.com/questions/411909/where-is-the-certificate-folder-in-windows-7">Where is the certificate folder in Windows 7?</a></li>
<li><a href="https://program-think.blogspot.com/2010/02/introduce-digital-certificate-and-ca.html">数字证书及 CA 的扫盲介绍</a></li>
<li><a href="http://www.cnblogs.com/JeffreySun/archive/2010/06/24/1627247.html">数字证书原理</a></li>
<li><a href="https://blog.cnbluebox.com/blog/2014/03/24/shu-zi-zheng-shu/">数字证书</a></li>
<li><a href="http://blog.chenxiaosheng.com/posts/2013-12-26/java-use-self_signed_certificate.html">Java 使用自签证书访问https站点</a></li>
<li><a href="https://www.jayxon.com/12306-certificate/">12306的证书问题</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2011/08/what_is_a_digital_signature.html">数字签名是什么？</a></li>
<li><a href="http://www.xieyidian.com/3213">在线买火车票为什么要安装根证书？</a></li>
<li><a href="http://snowolf.iteye.com/blog/391931">Java加密技术（八）——数字证书</a></li>
<li><a href="http://snowolf.iteye.com/blog/397693">Java加密技术（九）——初探SSL</a></li>
<li><a href="http://www.cnblogs.com/lzjsky/archive/2010/09/29/1838240.html">常见的数字证书格式</a></li>
<li><a href="http://lukejin.iteye.com/blog/605634">keyStore vs trustStore</a></li>
<li><a href="http://javarevisited.blogspot.jp/2012/09/difference-between-truststore-vs-keyStore-Java-SSL.html">Difference between trustStore and keyStore in Java - SSL</a></li>
<li><a href="http://docs.oracle.com/javase/6/docs/technotes/guides/security/jsse/JSSERefGuide.html">Java Secure Socket Extension (JSSE) Reference Guide</a></li>
<li><a href="http://www.nakov.com/blog/2009/07/16/disable-certificate-validation-in-java-ssl-connections/">Disable Certificate Validation in Java SSL Connections</a></li>
<li><a href="http://www.java-samples.com/showtutorial.php?tutorialid=210">javax.net.ssl.SSLHandshakeException: sun.security.validator.ValidatorException: PKIX path building failed</a></li>
<li><a href="http://wsigrid.blogspot.jp/2008/12/how-to-solve-javaxnetsslsslhandshakeexc.html">How to solve javax.net.ssl.SSLHandshakeException?</a></li>
<li><a href="https://www.sslshopper.com/ssl-converter.html">SSL Converter</a></li>
<li><a href="https://www.sslshopper.com/article-most-common-java-keytool-keystore-commands.html">The Most Common Java Keytool Keystore Commands</a></li>
<li><a href="https://docs.oracle.com/javase/6/docs/technotes/tools/solaris/keytool.html">keytool - Key and Certificate Management Tool</a></li>
</ol>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Https</tag>
        <tag>证书</tag>
      </tags>
  </entry>
  <entry>
    <title>Java中的强引用、软引用、弱引用和虚引用</title>
    <url>/2018/07/26/java/java-zhong-de-qiang-yin-yong-ruan-yin-yong-ruo-yin-yong-he-xu-yin-yong/</url>
    <content><![CDATA[<h1 id="Java中的强引用、软引用、弱引用和虚引用"><a href="#Java中的强引用、软引用、弱引用和虚引用" class="headerlink" title="Java中的强引用、软引用、弱引用和虚引用"></a>Java中的强引用、软引用、弱引用和虚引用</h1><p>Java执行GC判断对象是否存活有两种方式其中一种是引用计数。</p>
<blockquote>
<p>引用计数：Java堆中每一个对象都有一个引用计数属性，引用每新增1次计数加1，引用每释放1次计数减1。</p>
</blockquote>
<p>在JDK 1.2以前的版本中，若一个对象不被任何变量引用，那么程序就无法再使用这个对象。也就是说，只有对象处于(reachable)可达状态，程序才能使用它。</p>
<p>从JDK 1.2版本开始，对象的引用被划分为4种级别，从而使程序能更加灵活地控制对象的生命周期。</p>
<blockquote>
<p>Java中4种引用的级别和强度由高到低依次为：强引用 -&gt; 软引用 -&gt; 弱引用 -&gt; 虚引用</p>
</blockquote>
<table>
<thead>
<tr>
<th>引用类型</th>
<th>被垃圾回收时间</th>
<th>用途</th>
<th>生存时间</th>
<th>案例</th>
</tr>
</thead>
<tbody><tr>
<td>强引用</td>
<td>从来不会</td>
<td>对象的一般状态</td>
<td>JVM停止运行时终止</td>
<td>通过new或反射创建的引用对象</td>
</tr>
<tr>
<td>软引用</td>
<td>当内存不足时</td>
<td>对象缓存</td>
<td>内存不足时终止</td>
<td></td>
</tr>
<tr>
<td>弱引用</td>
<td>正常垃圾回收时</td>
<td>对象缓存</td>
<td>垃圾回收后终止</td>
<td></td>
</tr>
<tr>
<td>虚引用</td>
<td>正常垃圾回收时</td>
<td>跟踪对象的垃圾回收</td>
<td>垃圾回收后终止</td>
<td>DirectByteBuffer堆外内存释放</td>
</tr>
</tbody></table>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><blockquote>
<p><a href="https://juejin.im/post/6844903665241686029">理解Java的强引用、软引用、弱引用和虚引用</a></p>
</blockquote>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java常用日志框架</title>
    <url>/2018/07/26/java/java-chang-yong-ri-zhi-kuang-jia-jie-shao/</url>
    <content><![CDATA[<h3 id="Java常用日志框架介绍"><a href="#Java常用日志框架介绍" class="headerlink" title="Java常用日志框架介绍"></a>Java常用日志框架介绍</h3><ul>
<li><strong>Log4j</strong>  Apache Log4j是一个基于Java的日志记录工具。它是由Ceki Gülcü首创的，现在则是Apache软件基金会的一个项目。 Log4j是几种Java日志框架之一。 </li>
<li><strong>Log4j2</strong> Apache Log4j 2是apache开发的一款Log4j的升级产品。 </li>
<li><strong>Commons Logging</strong>  Apache基金会所属的项目，是一套Java日志接口，之前叫Jakarta Commons Logging，后更名为Commons Logging。 </li>
<li><strong>Slf4j</strong> 类似于Commons Logging，是一套简易Java日志门面，本身并无日志的实现。（Simple Logging Facade for Java，缩写Slf4j）。 </li>
<li><strong>Logback</strong>  一套日志组件的实现(slf4j阵营)。 </li>
<li><strong>Jul</strong> (Java Util Logging),自Java1.4以来的官方日志实现。</li>
</ul>
<h3 id="Java常用框架历史"><a href="#Java常用框架历史" class="headerlink" title="Java常用框架历史"></a>Java常用框架历史</h3><ul>
<li>1996年早期，欧洲安全电子市场项目组决定编写它自己的程序跟踪API(Tracing API)。经过不断的完善，这个API终于成为一个十分受欢迎的Java日志软件包，即Log4j。后来Log4j成为Apache基金会项目中的一员。 </li>
<li>期间Log4j近乎成了Java社区的日志标准。据说Apache基金会还曾经建议sun引入Log4j到java的标准库中，但Sun拒绝了。 </li>
<li>2002年Java1.4发布，Sun推出了自己的日志库JUL(Java Util Logging),其实现基本模仿了Log4j的实现。在JUL出来以前，log4j就已经成为一项成熟的技术，使得log4j在选择上占据了一定的优势。 </li>
<li>接着，Apache推出了Jakarta Commons Logging，JCL只是定义了一套日志接口(其内部也提供一个Simple Log的简单实现)，支持运行时动态加载日志组件的实现，也就是说，在你应用代码里，只需调用Commons Logging的接口，底层实现可以是log4j，也可以是Java Util Logging。 </li>
<li>后来(2006年)，Ceki Gülcü不适应Apache的工作方式，离开了Apache。然后先后创建了slf4j(日志门面接口，类似于Commons Logging)和Logback(Slf4j的实现)两个项目，并回瑞典创建了QOS公司，QOS官网上是这样描述Logback的：The Generic，Reliable Fast&amp;Flexible Logging Framework(一个通用，可靠，快速且灵活的日志框架)。 </li>
<li>现今，Java日志领域被划分为两大阵营：Commons Logging阵营和SLF4J阵营。 </li>
<li>Apache眼看有被Logback反超的势头，于2012-07重写了log4j 1.x，成立了新的项目Log4j 2。Log4j 2具有logback的所有特性。</li>
</ul>
<h3 id="java常用日志框架之间的关系"><a href="#java常用日志框架之间的关系" class="headerlink" title="java常用日志框架之间的关系"></a>java常用日志框架之间的关系</h3><ul>
<li>Log4j2与Log4j1发生了很大的变化，log4j2不兼容log4j1。 Log4j 2包含基于LMAX Disruptor库的下一代异步记录器。在多线程场景中，异步记录器的吞吐量比Log4j 1.x和Logback高18倍，延迟低。 Log4j 2明显优于Log4j 1.x，Logback和java.util.logging，尤其是在多线程应用程序中。 </li>
<li>Commons Logging和Slf4j是日志门面(门面模式是软件工程中常用的一种软件设计模式，也被称为正面模式、外观模式。它为子系统中的一组接口提供一个统一的高层接口，使得子系统更容易使用)。log4j和Logback则是具体的日志实现方案。可以简单的理解为接口与接口的实现，调用这只需要关注接口而无需关注具体的实现，做到解耦。 </li>
<li>比较常用的组合使用方式是Slf4j与Logback组合使用，Commons Logging与Log4j组合使用。 </li>
<li>Logback必须配合Slf4j使用。由于Logback和Slf4j是同一个作者，其兼容性不言而喻。</li>
</ul>
<h3 id="Commons-Logging与Slf4j实现机制对比"><a href="#Commons-Logging与Slf4j实现机制对比" class="headerlink" title="Commons Logging与Slf4j实现机制对比"></a>Commons Logging与Slf4j实现机制对比</h3><ul>
<li>Commons logging是通过动态查找机制，在程序运行时，使用自己的ClassLoader寻找和载入本地具体的实现。详细策略可以查看commons-logging-*.jar包中的org.apache.commons.logging.impl.LogFactoryImpl.java文件。由于OSGi不同的插件使用独立的ClassLoader，OSGI的这种机制保证了插件互相独立, 其机制限制了commons logging在OSGi中的正常使用。 </li>
<li>Slf4j在编译期间，静态绑定本地的LOG库，因此可以在OSGi中正常使用。它是通过查找类路径下org.slf4j.impl.StaticLoggerBinder，然后绑定工作都在这类里面进。</li>
</ul>
<h3 id="如何在项目中选择日志框架"><a href="#如何在项目中选择日志框架" class="headerlink" title="如何在项目中选择日志框架"></a>如何在项目中选择日志框架</h3><p>如果是在一个新的项目中建议使用Slf4j与Logback组合，这样有如下的几个优点。 </p>
<ul>
<li><p>Slf4j实现机制决定Slf4j限制较少，使用范围更广。由于Slf4j在编译期间，静态绑定本地的LOG库使得通用性要比Commons logging要好。 </p>
</li>
<li><p>Logback拥有更好的性能。Logback声称：某些关键操作，比如判定是否记录一条日志语句的操作，其性能得到了显著的提高。这个操作在Logback中需要3纳秒，而在Log4J中则需要30纳秒。LogBack创建记录器（logger）的速度也更快：13毫秒，而在Log4J中需要23毫秒。更重要的是，它获取已存在的记录器只需94纳秒，而Log4J需要2234纳秒，时间减少到了1&#x2F;23。跟JUL相比的性能提高也是显著的。 </p>
</li>
<li><p>Commons Logging开销更高 在使Commons Logging时为了减少构建日志信息的开销，通常的做法是：</p>
<p><code>if(log.isDebugEnabled())&#123; </code></p>
<p>​    <code>log.debug(&quot;User name： &quot; + user.getName() + &quot; buy goods id ：&quot; + good.getId());</code> </p>
<p><code>&#125;</code> </p>
<p>在Slf4j阵营，你只需这么做：</p>
<p> <code>log.debug(&quot;User name：&#123;&#125; ,buy goods id ：&#123;&#125;&quot;, user.getName(),good.getId());</code> </p>
<p>也就是说，slf4j把构建日志的开销放在了它确认需要显示这条日志之后，减少内存和cup的开销，使用占位符号，代码也更为简洁 。</p>
</li>
<li><p>Logback文档免费。Logback的所有文档是全面免费提供的，不象Log4J那样只提供部分免费文档而需要用户去购买付费文档。</p>
</li>
</ul>
<h3 id="如何在项目中使用self4j"><a href="#如何在项目中使用self4j" class="headerlink" title="如何在项目中使用self4j"></a>如何在项目中使用self4j</h3><p><strong>直接使用slf4j来输入日志的方式</strong></p>
<p><img src="/2018/07/26/java/java-chang-yong-ri-zhi-kuang-jia-jie-shao/concrete-bindings.png" alt="concrete-bindings"></p>
<p>这里引用了slf4j官网的图，<a href="https://www.slf4j.org/manual.html">去官网查阅可以点击这里</a></p>
<p>简单说一下对上图的理解：</p>
<ul>
<li>图中第一层绿色的模块application代表你的应用程序</li>
<li>图中第二层浅蓝色的模块，代表是抽象的日志接口层，这里用的是<em>slf4j</em></li>
<li>图中第三层分为两种：<ul>
<li>一种是深蓝色的，表示的是第二层中<em>slf4j</em>日志接口的直接实现,直接实现了<em>slf4j</em>的日志框架有logback、slf4j-simple（slf4j的简单实现）、 slf4j-nop（丢弃日志不打印）</li>
<li>另外一中湖蓝色的，表示是没有直接实现<em>slf4j</em>的API，而是通过适配器调用其它具体日志框架的API，这里包括<em>slf4j</em>到log4j的适配和<em>slf4j</em>到Jul的适配。</li>
</ul>
</li>
<li>第四层灰色的模块表示具体的日志框架，他们没有直接实现<em>slf4j</em>的API，但是可以通过上层的适配器与<em>slf4j</em>做适配实现日志管理。</li>
</ul>
<p>*<em>如果你的应用包含其他模块，但这些模块没有使用slf4j，而是使用了其他日志框架，不要担心，<em>slf4j</em>提供了一些包可以将系统中其他日志转到slf4j做一个统一输出，具体可以参考</em>slf4j<em>官网的这幅图</em>*</p>
<p><img src="/2018/07/26/java/java-chang-yong-ri-zhi-kuang-jia-jie-shao/legacy.png" alt="legacy"></p>
<p><a href="https://www.slf4j.org/legacy.html">去官网查阅可以点击这里</a></p>
<p>上图中从左到右再到下分别为图一、图二、图三</p>
<ul>
<li><p>图一表示使用<em>slf4j</em>作为统一日志输出，将程序中原有的Commons Longing、Log4j、Jul日志适配到slf4j</p>
<table>
<thead>
<tr>
<th>jar包名</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><strong>log4j-over-slf4j-version.jar</strong></td>
<td>将log4j适配到slf4j</td>
</tr>
<tr>
<td><strong>jcl-over-slf4j-version.jar</strong></td>
<td>将commos logging适配到slf4j</td>
</tr>
<tr>
<td><strong>jul-to-slf4j-version.jar</strong></td>
<td>将Java Util Logging适配到slf4j</td>
</tr>
</tbody></table>
<p>可以通过上面的包将原来的日志适配到<em>slf4j</em>作为统一日志输出，使用logback作为具体日志实现。</p>
</li>
<li><p>图二、三原理类似，只是更换了slf4j的日志实现方式。</p>
</li>
</ul>
<p><strong>注意</strong></p>
<p>如果有其它日志重定向到了<em>slf4j</em>，就不能将该日志再作为<em>slf4j</em>的具体实现了，否则会形成闭环（<em>该日志将输出重定向到slf4j，slf4j又将日志输出到该日志</em>），所以将其它日志重定向到slf4j的方式只有如上三种搭配组合方式。</p>
<hr>
<p><strong>上面介绍使用slf4j作为统一日志输出，将其它日志适配到slf4j，以及slf4j绑定具体日志实现，这些适配功能的jar包和适配器相关的jar包都是由slf4j提供的，Apache作为log4j的维护方，也提供了一些桥接器，更好的支持log4j 2</strong></p>
<table>
<thead>
<tr>
<th>jar包</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>log4j-1.2-api</td>
<td>将log4j 2作为log4j 1.x 的具体实现（<em>两者不兼容</em>）</td>
</tr>
<tr>
<td>log4j-jcl</td>
<td>将log4j 2作为jcl 的具体实现</td>
</tr>
<tr>
<td>log4j-slf4j-impl</td>
<td>将log4j 2作为slf4j的具体实现</td>
</tr>
</tbody></table>
<p><a href="https://logging.apache.org/log4j/2.x/maven-artifacts.html">去log4j 2官网查看点击这里</a></p>
<p><strong>参考链接</strong></p>
<p><a href="https://www.cnblogs.com/chenhongliang/p/5312517.html">Java常用日志框架介绍</a></p>
<p><a href="https://www.slf4j.org/">slf4j官网</a></p>
<p><a href="https://logging.apache.org/log4j/2.x/">log4j 2官网</a></p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>日志</tag>
      </tags>
  </entry>
  <entry>
    <title>Java中锁分类</title>
    <url>/2021/03/01/java/java-zhong-suo-fen-lei/</url>
    <content><![CDATA[<h1 id="一、Java中主流锁"><a href="#一、Java中主流锁" class="headerlink" title="一、Java中主流锁"></a>一、Java中主流锁</h1><p><img src="/2021/03/01/java/java-zhong-suo-fen-lei/Java%E4%B8%BB%E6%B5%81%E9%94%81.png" alt="Java主流锁"></p>
<blockquote>
<p>上图摘自：<a href="https://tech.meituan.com/2018/11/15/java-lock.html">美团技术团队：不可不说的Java“锁”事</a></p>
</blockquote>
<h2 id="1-1-乐观锁-VS-悲观锁"><a href="#1-1-乐观锁-VS-悲观锁" class="headerlink" title="1.1 乐观锁 VS 悲观锁"></a>1.1 乐观锁 VS 悲观锁</h2><p>乐观锁与悲观锁是一种广义上的概念，体现了看待线程同步的不同角度。在Java和数据库中都有此概念对应的实际应用。</p>
<p>先说概念。对于同一个数据的并发操作，悲观锁认为自己在使用数据的时候一定有别的线程来修改数据，因此在获取数据的时候会先加锁，确保数据不会被别的线程修改。Java中，synchronized关键字和Lock的实现类都是悲观锁。</p>
<p>而乐观锁认为自己在使用数据时不会有别的线程修改数据，所以不会添加锁，只是在更新数据的时候去判断之前有没有别的线程更新了这个数据。如果这个数据没有被更新，当前线程将自己修改的数据成功写入。如果数据已经被其他线程更新，则根据不同的实现方式执行不同的操作（例如报错或者自动重试）。</p>
<p>乐观锁在Java中是通过使用无锁编程来实现，最常采用的是CAS算法，Java原子类中的递增操作就通过CAS自旋实现的。</p>
<h3 id="特点："><a href="#特点：" class="headerlink" title="特点："></a>特点：</h3><ul>
<li>悲观锁适合写操作多的场景，先加锁可以保证写操作时数据正确。</li>
<li>乐观锁适合读操作多的场景，不加锁的特点能够使其读操作的性能大幅提升</li>
</ul>
<h3 id="问题："><a href="#问题：" class="headerlink" title="问题："></a>问题：</h3><p>（1） ABA问题。CAS需要在操作值的时候检查内存值是否发生变化，没有发生变化才会更新内存值。但是如果内存值原来是A，后来变成了B，然后又变成了A，那么CAS进行检查时会发现值没有发生变化，但是实际上是有变化的。ABA问题的解决思路就是在变量前面添加版本号，每次变量更新的时候都把版本号加一，这样变化过程就从“A－B－A”变成了“1A－2B－3A”。<br>JDK从1.5开始提供了AtomicStampedReference类来解决ABA问题，具体操作封装在compareAndSet()中。compareAndSet()首先检查当前引用和当前标志与预期引用和预期标志是否相等，如果都相等，则以原子方式将引用值和标志的值设置为给定的更新值。<br>（2） 循环时间长开销大。CAS操作如果长时间不成功，会导致其一直自旋，给CPU带来非常大的开销。<br>（3）只能保证一个共享变量的原子操作。对一个共享变量执行操作时，CAS能够保证原子操作，但是对多个共享变量操作时，CAS是无法保证操作的原子性的。<br>Java从1.5开始JDK提供了AtomicReference类来保证引用对象之间的原子性，可以把多个变量放在一个对象里来进行CAS操作。</p>
<h2 id="1-2-自旋锁-VS-适应性自旋锁"><a href="#1-2-自旋锁-VS-适应性自旋锁" class="headerlink" title="1.2 自旋锁 VS 适应性自旋锁"></a>1.2 自旋锁 VS 适应性自旋锁</h2><p>在许多场景中，同步资源的锁定时间很短，为了这一小段时间去切换线程，线程挂起和恢复现场的花费可能会让系统得不偿失。如果物理机器有多个处理器，能够让两个或以上的线程同时并行执行，我们就可以让后面那个请求锁的线程不放弃CPU的执行时间，看看持有锁的线程是否很快就会释放锁。<br>而为了让当前线程“稍等一下”，我们需让当前线程进行自旋，如果在自旋完成后前面锁定同步资源的线程已经释放了锁，那么当前线程就可以不必阻塞而是直接获取同步资源，从而避免切换线程的开销。这就是自旋锁。<br>自旋锁本身是有缺点的，它不能代替阻塞。自旋等待虽然避免了线程切换的开销，但它要占用处理器时间。如果锁被占用的时间很短，自旋等待的效果就会非常好。反之，如果锁被占用的时间很长，那么自旋的线程只会白浪费处理器资源。所以，自旋等待的时间必须要有一定的限度，如果自旋超过了限定次数（默认是10次，可以使用-XX:PreBlockSpin来更改）没有成功获得锁，就应当挂起线程。</p>
<h2 id="1-3-无锁-VS-偏向锁-VS-轻量级锁-VS-重量级锁"><a href="#1-3-无锁-VS-偏向锁-VS-轻量级锁-VS-重量级锁" class="headerlink" title="1.3 无锁 VS 偏向锁 VS 轻量级锁 VS 重量级锁"></a>1.3 无锁 VS 偏向锁 VS 轻量级锁 VS 重量级锁</h2><p>这四种锁是指锁的状态，专门针对synchronized的。<br>首先为什么Synchronized能实现线程同步？</p>
<p>在回答这个问题之前我们需要了解两个重要的概念：“Java对象头”、“Monitor”。</p>
<h3 id="Java对象头"><a href="#Java对象头" class="headerlink" title="Java对象头"></a>Java对象头</h3><p>synchronized是悲观锁，在操作同步资源之前需要给同步资源先加锁，这把锁就是存在Java对象头里的，而Java对象头又是什么呢？</p>
<p>我们以Hotspot虚拟机为例，Hotspot的对象头主要包括两部分数据：Mark Word（标记字段）、Klass Pointer（类型指针）。</p>
<p>Mark Word：默认存储对象的HashCode，分代年龄和锁标志位信息。这些信息都是与对象自身定义无关的数据，所以Mark Word被设计成一个非固定的数据结构以便在极小的空间内存存储尽量多的数据。它会根据对象的状态复用自己的存储空间，也就是说在运行期间Mark Word里存储的数据会随着锁标志位的变化而变化。</p>
<p>Klass Point：对象指向它的类元数据的指针，虚拟机通过这个指针来确定这个对象是哪个类的实例。</p>
<h3 id="Monitor"><a href="#Monitor" class="headerlink" title="Monitor"></a>Monitor</h3><p>Monitor可以理解为一个同步工具或一种同步机制，通常被描述为一个对象。每一个Java对象就有一把看不见的锁，称为内部锁或者Monitor锁。</p>
<p>Monitor是线程私有的数据结构，每一个线程都有一个可用monitor record列表，同时还有一个全局的可用列表。每一个被锁住的对象都会和一个monitor关联，同时monitor中有一个Owner字段存放拥有该锁的线程的唯一标识，表示该锁被这个线程占用。</p>
<p>现在话题回到synchronized，synchronized通过Monitor来实现线程同步，Monitor是依赖于底层的操作系统的Mutex Lock（互斥锁）来实现的线程同步。</p>
<p>如同我们在自旋锁中提到的“阻塞或唤醒一个Java线程需要操作系统切换CPU状态来完成，这种状态转换需要耗费处理器时间。如果同步代码块中的内容过于简单，状态转换消耗的时间有可能比用户代码执行的时间还要长”。这种方式就是synchronized最初实现同步的方式，这就是JDK 6之前synchronized效率低的原因。这种依赖于操作系统Mutex Lock所实现的锁我们称之为“重量级锁”，JDK 6中为了减少获得锁和释放锁带来的性能消耗，引入了“偏向锁”和“轻量级锁”。</p>
<p>所以目前锁一共有4种状态，级别从低到高依次是：无锁、偏向锁、轻量级锁和重量级锁。锁状态只能升级不能降级。<br>通过上面的介绍，我们对synchronized的加锁机制以及相关知识有了一个了解，那么下面我们给出四种锁状态对应的的Mark Word内容，然后再分别讲解四种锁状态的思路以及特点：</p>
<table>
<thead>
<tr>
<th>锁状态</th>
<th>存储内容</th>
<th>存储内容</th>
</tr>
</thead>
<tbody><tr>
<td>无锁</td>
<td>对象的hashCode、对象分代年龄、是否是偏向锁（0）</td>
<td>01</td>
</tr>
<tr>
<td>偏向锁</td>
<td>偏向线程ID、偏向时间戳、对象分代年龄、是否是偏向锁（1）</td>
<td>01</td>
</tr>
<tr>
<td>轻量级锁</td>
<td>指向栈中锁记录的指针</td>
<td>00</td>
</tr>
<tr>
<td>重量级锁</td>
<td>指向互斥量（重量级锁）的指针</td>
<td>10</td>
</tr>
</tbody></table>
<h3 id="无锁"><a href="#无锁" class="headerlink" title="无锁"></a>无锁</h3><p>无锁没有对资源进行锁定，所有的线程都能访问并修改同一个资源，但同时只有一个线程能修改成功。</p>
<p>无锁的特点就是修改操作在循环内进行，线程会不断的尝试修改共享资源。如果没有冲突就修改成功并退出，否则就会继续循环尝试。如果有多个线程修改同一个值，必定会有一个线程能修改成功，而其他修改失败的线程会不断重试直到修改成功。上面我们介绍的CAS原理及应用即是无锁的实现。无锁无法全面代替有锁，但无锁在某些场合下的性能是非常高的。</p>
<h3 id="偏向锁"><a href="#偏向锁" class="headerlink" title="偏向锁"></a>偏向锁</h3><p>偏向锁是指一段同步代码一直被一个线程所访问，那么该线程会自动获取锁，降低获取锁的代价。</p>
<p>在大多数情况下，锁总是由同一线程多次获得，不存在多线程竞争，所以出现了偏向锁。其目标就是在只有一个线程执行同步代码块时能够提高性能。</p>
<p>当一个线程访问同步代码块并获取锁时，会在Mark Word里存储锁偏向的线程ID。在线程进入和退出同步块时不再通过CAS操作来加锁和解锁，而是检测Mark Word里是否存储着指向当前线程的偏向锁。引入偏向锁是为了在无多线程竞争的情况下尽量减少不必要的轻量级锁执行路径，因为轻量级锁的获取及释放依赖多次CAS原子指令，而偏向锁只需要在置换ThreadID的时候依赖一次CAS原子指令即可。</p>
<p>偏向锁只有遇到其他线程尝试竞争偏向锁时，持有偏向锁的线程才会释放锁，线程不会主动释放偏向锁。偏向锁的撤销，需要等待全局安全点（在这个时间点上没有字节码正在执行），它会首先暂停拥有偏向锁的线程，判断锁对象是否处于被锁定状态。撤销偏向锁后恢复到无锁（标志位为“01”）或轻量级锁（标志位为“00”）的状态。</p>
<p>偏向锁在JDK 6及以后的JVM里是默认启用的。可以通过JVM参数关闭偏向锁：-XX:-UseBiasedLocking&#x3D;false，关闭之后程序默认会进入轻量级锁状态。</p>
<h3 id="轻量级锁"><a href="#轻量级锁" class="headerlink" title="轻量级锁"></a>轻量级锁</h3><p>是指当锁是偏向锁的时候，被另外的线程所访问，偏向锁就会升级为轻量级锁，其他线程会通过自旋的形式尝试获取锁，不会阻塞，从而提高性能。</p>
<p>在代码进入同步块的时候，如果同步对象锁状态为无锁状态（锁标志位为“01”状态，是否为偏向锁为“0”），虚拟机首先将在当前线程的栈帧中建立一个名为锁记录（Lock Record）的空间，用于存储锁对象目前的Mark Word的拷贝，然后拷贝对象头中的Mark Word复制到锁记录中。</p>
<p>拷贝成功后，虚拟机将使用CAS操作尝试将对象的Mark Word更新为指向Lock Record的指针，并将Lock Record里的owner指针指向对象的Mark Word。</p>
<p>如果这个更新动作成功了，那么这个线程就拥有了该对象的锁，并且对象Mark Word的锁标志位设置为“00”，表示此对象处于轻量级锁定状态。</p>
<p>如果轻量级锁的更新操作失败了，虚拟机首先会检查对象的Mark Word是否指向当前线程的栈帧，如果是就说明当前线程已经拥有了这个对象的锁，那就可以直接进入同步块继续执行，否则说明多个线程竞争锁。</p>
<p>若当前只有一个等待线程，则该线程通过自旋进行等待。但是当自旋超过一定的次数，或者一个线程在持有锁，一个在自旋，又有第三个来访时，轻量级锁升级为重量级锁。</p>
<h3 id="重量级锁"><a href="#重量级锁" class="headerlink" title="重量级锁"></a>重量级锁</h3><p>升级为重量级锁时，锁标志的状态值变为“10”，此时Mark Word中存储的是指向重量级锁的指针，此时等待锁的线程都会进入阻塞状态。</p>
<p>整体的锁状态升级流程如下：</p>
<blockquote>
<p>无锁 -&gt; 偏向锁 -&gt; 轻量级锁 -&gt; 重量级锁</p>
</blockquote>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>偏向锁通过对比Mak Word解决加锁问题，避免进行CAS操作，而轻量级锁是通过CAS操作和自旋锁来解决加锁问题，避免线程阻塞和唤醒而影响性能。重量级锁是将除了拥有锁的线程以外的线程都阻塞。</p>
<h2 id="1-4-公平锁-VS-非公平锁"><a href="#1-4-公平锁-VS-非公平锁" class="headerlink" title="1.4 公平锁 VS 非公平锁"></a>1.4 公平锁 VS 非公平锁</h2><p>公平锁是指多个线程按照申请锁的顺序来获取锁，线程直接进入队列中排队，队列中的第一个线程才能获得锁。公平锁的优点是等待锁的线程不会饿死。缺点是整体吞吐效率相对非公平锁要低，等待队列中除第一个线程以外的所有线程都会阻塞，CPU唤醒阻塞线程的开销比非公平锁大。</p>
<p>非公平锁是多个线程加锁时直接尝试获取锁，获取不到才会到等待队列的队尾等待。但如果此时锁刚好可用，那么这个线程可以无需阻塞直接获取到锁，所以非公平锁有可能出现后申请锁的线程先获取锁的场景。非公平锁的优点是可以减少唤起线程的开销，整体的吞吐效率高，因为线程有几率不阻塞直接获得锁，CPU不必唤醒所有线程。缺点是处于等待队列中的线程可能会饿死，或者等很久才会获得锁。</p>
<p>ReentrantLock里面有一个内部类Sync，Sync继承AQS（AbstractQueuedSynchronizer），添加锁和释放锁的大部分操作实际上都是在Sync中实现的。它有公平锁FairSync和非公平锁NonfairSync两个子类。ReentrantLock默认使用非公平锁，也可以通过构造器来显示的指定使用公平锁。</p>
<h2 id="1-5-可重入锁-VS-非可重入锁"><a href="#1-5-可重入锁-VS-非可重入锁" class="headerlink" title="1.5 可重入锁 VS 非可重入锁"></a>1.5 可重入锁 VS 非可重入锁</h2><p>可重入锁又名递归锁，是指在同一个线程在外层方法获取锁的时候，再进入该线程的内层方法会自动获取锁（前提锁对象得是同一个对象或者class），不会因为之前已经获取过还没释放而阻塞。Java中ReentrantLock和synchronized都是可重入锁，可重入锁的一个优点是可一定程度避免死锁。</p>
<p>之前我们说过ReentrantLock和synchronized都是重入锁。</p>
<h2 id="1-6-独占锁-VS-共享锁"><a href="#1-6-独占锁-VS-共享锁" class="headerlink" title="1.6 独占锁 VS 共享锁"></a>1.6 独占锁 VS 共享锁</h2><p>独享锁也叫排他锁，是指该锁一次只能被一个线程所持有。如果线程T对数据A加上排它锁后，则其他线程不能再对A加任何类型的锁。获得排它锁的线程即能读数据又能修改数据。JDK中的synchronized和JUC中Lock的实现类就是互斥锁。<br>共享锁是指该锁可被多个线程所持有。如果线程T对数据A加上共享锁后，则其他线程只能对A再加共享锁，不能加排它锁。获得共享锁的线程只能读数据，不能修改数据。</p>
<p>独享锁与共享锁也是通过AQS来实现的，通过实现不同的方法，来实现独享或者共享。</p>
<h1 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h1><ul>
<li>悲观锁访问临界资源预先加锁，如Java中的synchronized和Lock实现类都是悲观锁。</li>
<li>乐观锁访问临界资源不加锁，只有在更新数据的时候检查是否发生了冲突，如果发生冲突则进行重试。ReenterLock内部的AQS，还是各种Atomic开头的原子类，内部都应用到了CAS。</li>
<li>自旋锁通过让线程自旋避免让线程陷入阻塞，便面线程上下文切换带来的性能损耗。</li>
<li>适应性自旋锁通过收集获取锁的线程的自旋次数、自旋时长及锁状态动态判断线程获取锁的可能，最终决定线程进行自旋或阻塞。避免长时间自旋浪费处理器资源。</li>
<li>偏向锁通过对比Mak Word解决加锁问题，避免进行CAS操作，而轻量级锁是通过CAS操作和自旋锁来解决加锁问题，避免线程阻塞和唤醒而影响性能。重量级锁是将除了拥有锁的线程以外的线程都阻塞。</li>
<li>公平锁按照线程申请锁的顺序来获取锁。优点：线程不会饿死；缺点：整体的吞吐效率低。</li>
<li>非公平锁加锁时直接尝试获取锁。优点：系统吞吐量高；缺点：等待队列中的线程可能会饿死。</li>
<li>可重入锁指线程在外层方法获取锁后进入内层方法自动获得锁。Java中ReentrantLock和synchronized都是可重入锁，可重入锁的一个优点是可一定程度避免死锁。</li>
<li>非可重入锁在持有锁的情况下再次获取锁会导致线程阻塞从而造成死锁。</li>
<li>独占锁指锁只能被一个线程持有，如java中得写锁。</li>
<li>非独占锁则可以被多个线程持有，如java中的读锁。</li>
</ul>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>锁</tag>
      </tags>
  </entry>
  <entry>
    <title>Java类加载机制</title>
    <url>/2018/07/30/java/java-lei-jia-zai-ji-zhi/</url>
    <content><![CDATA[<h3 id="一、类加载过程"><a href="#一、类加载过程" class="headerlink" title="一、类加载过程"></a>一、类加载过程</h3><p>　　 类从被加载到虚拟机内存中开始，直到卸载出内存为止，它的整个生命周期包括了： <strong>加载、验证、准备、解析、初始化、使用和卸载</strong> 这7个阶段。其中， <strong>验证、准备和解析这三个部分统称为连接（linking）</strong> 。</p>
<p><img src="/2018/07/30/java/java-lei-jia-zai-ji-zhi/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B.png" alt="类加载过程"></p>
<p>  其中，加载、验证、准备、初始化和卸载这五个阶段的顺序是确定的，类的加载过程必须按照这种顺序按部就班的“开始”（仅仅指的是开始，而非执行或者结束，因为这些阶段通常都是互相交叉的混合进行，通常会在一个阶段执行的过程中调用或者激活另一个阶段），而解析阶段则不一定（它在某些情况下可以在初始化阶段之后再开始，这是为了支持Java语言的运行时绑定)。 </p>
<h4 id="加载"><a href="#加载" class="headerlink" title="加载"></a>加载</h4><p>“加载”(Loading)阶段是“类加载”(Class Loading)过程的第一个阶段，在此阶段，虚拟机需要完成以下三件事情：</p>
<ul>
<li>1、 通过一个类的全限定名来获取定义此类的二进制字节流。</li>
<li>2、 将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构。</li>
<li>3、 在Java堆中生成一个代表这个类的java.lang.Class对象，作为方法区这些数据的访问入口。</li>
</ul>
<p>​      加载阶段既可以使用系统提供的类加载器来完成，也可以由用户自定义的类加载器来完成。加载阶段与连接阶段的部分内容(如一部分字节码文件格式验证动作)是交叉进行的，加载阶段尚未完成，连接阶段可能已经开始。</p>
<hr>
<h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><p> 验证是连接阶段的第一步，这一阶段的目的是为了确保Class文件的字节流中包含的信息符合当前虚拟机的要求，并且不会危害虚拟机自身的安全。</p>
<p>​       Java语言本身是相对安全的语言，使用Java编码是无法做到如访问数组边界以外的数据、将一个对象转型为它并未实现的类型等，如果这样做了，编译器将拒绝编译。但是，Class文件并不一定是由Java源码编译而来，可以使用任何途径，包括用十六进制编辑器(如UltraEdit)直接编写。如果直接编写了有害的“代码”(字节流)，而虚拟机在加载该Class时不进行检查的话，就有可能危害到虚拟机或程序的安全。</p>
<p>​      不同的虚拟机，对类验证的实现可能有所不同，但大致都会完成下面四个阶段的验证 ：文件格式验证、元数据验证、字节码验证和符号引用验证。</p>
<ul>
<li>1、文件格式验证，是要验证字节流是否符合Class文件格式的规范，并且能被当前版本的虚拟机处理。如验证魔数是否0xCAFEBABE；主、次版本号是否正在当前虚拟机处理范围之内；常量池的常量中是否有不被支持的常量类型……该验证阶段的主要目的是保证输入的字节流能正确地解析并存储于方法区中，经过这个阶段的验证后，字节流才会进入内存的方法区中存储，所以后面的三个验证阶段都是基于方法区的存储结构进行的。</li>
<li>2、元数据验证，是对字节码描述的信息进行语义分析，以保证其描述的信息符合Java语言规范的要求。可能包括的验证如：这个类是否有父类；这个类的父类是否继承了不允许被继承的类；如果这个类不是抽象类，是否实现了其父类或接口中要求实现的所有方法……</li>
<li>3、字节码验证，主要工作是进行数据流和控制流分析，保证被校验类的方法在运行时不会做出危害虚拟机安全的行为。如果一个类方法体的字节码没有通过字节码验证，那肯定是有问题的；但如果一个方法体通过了字节码验证，也不能说明其一定就是安全的。</li>
<li>4、符号引用验证，发生在虚拟机将符号引用转化为直接引用的时候，这个转化动作将在“解析阶段”中发生。验证符号引用中通过字符串描述的权限定名是否能找到对应的类；在指定类中是否存在符合方法字段的描述符及简单名称所描述的方法和字段；符号引用中的类、字段和方法的访问性(private、protected、public、default)是否可被当前类访问</li>
</ul>
<p>验证阶段对于虚拟机的类加载机制来说，不一定是必要的阶段。如果所运行的全部代码确认是安全的， 可以使用 <strong>-Xverify：none</strong> 参数来关闭大部分的类验证措施，以缩短虚拟机类加载时间。</p>
<hr>
<h4 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h4><p> 准备阶段是为类的静态变量分配内存并将其初始化为默认值，这些内存都将在方法区中进行分配。准备阶段不分配类中的实例变量的内存，实例变量将会在对象实例化时随着对象一起分配在Java堆中。</p>
<p>​        <code>public static int value=123;</code>&#x2F;&#x2F;在准备阶段value初始值为0 。在初始化阶段才会变为123 。</p>
<hr>
<h4 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h4><p>解析阶段是虚拟机将常量池内的符号引用替换为直接引用的过程。</p>
<p>​       符号引用（Symbolic Reference）：符号引用以一组符号来描述所引用的目标，符号可以是任何形式的字面量，只要使用时能无歧义地定位到目标即可。符号引用与虚拟机实现的内存布局无关，引用的目标并不一定已经加载到内存中。</p>
<p>​       直接引用（Direct Reference）：直接引用可以是直接指向目标的指针、相对偏移量或是一个能间接定位到目标的句柄。直接引用是与虚拟机实现的内存布局相关的，如果有了直接引用，那么引用的目标必定已经在内存中存在。</p>
<hr>
<h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><p>　　类初始化是类加载过程的最后一步，前面的类加载过程，除了在加载阶段用户应用程序可以通过自定义类加载器参与之外，其余动作完全由虚拟机主导和控制。到了初始化阶段，才真正开始执行类中定义的Java程序代码。</p>
<p>​        初始化阶段是执行类构造器<clinit>()方法的过程。<clinit>()方法是由编译器自动 收集类中的所有类变量的赋值动作和静态语句块(static{}块)中的语句合并产生的 。</clinit></clinit></p>
<p>什么情况下需要开始类加载过程的第一个阶段:<em><strong>加载</strong></em>。虚拟机规范中并没强行约束，这点可以交给虚拟机的的具体实现自由把握，但是对于<em><strong>初始化阶段</strong></em>虚拟机规范是严格规定了如下几种情况，如果类未初始化会对类进行初始化。 </p>
<ul>
<li>创建类的实例</li>
<li>访问类的静态变量 (除常量【 被final修辞的静态变量】 原因:常量一种特殊的变量，因为编译器把他们当作值(value)而不是域(field)来对待。如果你的代码中用到了常变量(constant variable)，编译器并不会生成字节码来从对象中载入域的值，而是直接把这个值插入到字节码中。这是一种很有用的优化，但是如果你需要改变final域的值那么每一块用到那个域的代码都需要重新编译。</li>
<li>访问类的静态方法</li>
<li>反射 如( <strong>Class.forName(“my.xyz.Test”)</strong> )</li>
<li>当初始化一个类时，发现其父类还未初始化，则先出发父类的初始化</li>
<li>虚拟机启动时，定义了main()方法的那个类先初始化</li>
</ul>
<p>　　以上情况称为称对一个类进行 <strong>“主动引用”</strong> ，除此种情况之外，均不会触发类的初始化，称为**“被动引用”** </p>
<p>***注意：***虚拟机在首次加载Java类时，会对静态初始化块、静态成员变量、静态方法进行一次初始化 ，但非静态方法不被调用是不会执行的。 </p>
<p><em><strong>类初始化顺序：</strong></em> <em>父类静态变量 　-&gt; 　父类静态代码块　-&gt;　子类静态变量　-&gt;　子类静态代码块　-&gt;　父类非静态变量　-&gt;　父类非静态代码块　-&gt;　父类构造方法　-&gt;　子类非静态变量　-&gt;　子类非静态代码块　-&gt;　子类构造方法</em></p>
<p><em><strong>案例：</strong></em></p>
<pre class="line-numbers language-none"><code class="language-none">class SingleTon &#123;
	private static SingleTon singleTon &#x3D; new SingleTon();
	public static int count1;
	public static int count2 &#x3D; 0;

	private SingleTon() &#123;
		count1++;
		count2++;
	&#125;

	public static SingleTon getInstance() &#123;
		return singleTon;
	&#125;
&#125;

public class Test &#123;
	public static void main(String[] args) &#123;
		SingleTon singleTon &#x3D; SingleTon.getInstance();
		System.out.println(&quot;count1&#x3D;&quot; + singleTon.count1);
		System.out.println(&quot;count2&#x3D;&quot; + singleTon.count2);
	&#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>结果：1， 0</p>
<hr>
<h3 id="二、类加载器"><a href="#二、类加载器" class="headerlink" title="二、类加载器"></a>二、类加载器</h3><p>　　类加载器是一个用来加载类文件的类。Java源代码通过javac编译器编译成类文件。然后JVM来执行类文件中的字节码来执行程序。类加载器负责加载文件系统、网络或其他来源的类文件。有三种默认使用的类加载器：Bootstrap类加载器、Extension类加载器和System类加载器（或者叫作Application类加载器）。每种类加载器都有设定好从哪里加载类。 </p>
<ul>
<li>**启动类加载器(Bootstrap ClassLoader) **</li>
</ul>
<p>　　负责加载 JAVA_HOME\lib 目录中的，或通过-Xbootclasspath参数指定路径中的，且被虚拟机认可（按文件名识别，如rt.jar）的类, 它是所有类加载器的父加载器。Bootstrap类加载器没有任何父类加载器，如果你调用String.class.getClassLoader()，会返回null，任何基于此的代码会抛出NUllPointerException异常。Bootstrap加载器被称为初始类加载器。 </p>
<ul>
<li><strong>扩展类加载器(Extension ClassLoader)</strong></li>
</ul>
<p>　　负责加载 JAVA_HOME\lib\ext 目录中的，或通过java.ext.dirs系统变量指定路径中的类库,  扩展类加载器（Extension ClassLoader）将加载类的请求委托给他的父加载器（<em>这里的父加载器并非继承关系，而是通过组合关系达到复用父类加载器的代码</em>），也就是Bootstrap类加载器，如果父加载器没有加载成功，则在 JAVA_HOME\lib\ext 目录下加载。Extension加载器由sun.misc.Launcher$ExtClassLoader实现。</p>
<ul>
<li>**应用程序类加载器(Application ClassLoader) **</li>
</ul>
<p>　　它负责从classpath环境变量中加载某些应用相关的类，classpath环境变量通常由-classpath或-cp命令行选项来定义，或者是JAR中的Manifest的classpath属性。Application类加载器是Extension类加载器的子加载器。通过sun.misc.Launcher$AppClassLoader实现。</p>
<p>除了Bootstrap类加载器是大部分由C来写的，其他的类加载器都是通过java.lang.ClassLoader来实现的。 JVM通过双亲委派模型进行类的加载，当然我们也可以通过继承java.lang.ClassLoader实现自定义的类加载器。</p>
<hr>
<h3 id="三、类加载器的工作原理"><a href="#三、类加载器的工作原理" class="headerlink" title="三、类加载器的工作原理"></a>三、类加载器的工作原理</h3><p>类加载器的工作原理基于三个机制：委托、可见性和单一性。 </p>
<ul>
<li><p><strong>委托机制</strong></p>
<p>　　当一个类加载和初始化的时候，类仅在有需要加载的时候被加载。假设你有一个应用需要的类叫作Abc.class，首先加载这个类的请求由Application类加载器委托给它的父类加载器Extension类加载器，然后再委托给Bootstrap类加载器。Bootstrap类加载器会先看看rt.jar中有没有这个类，因为并没有这个类，所以这个请求由回到Extension类加载器，它会查看jre&#x2F;lib&#x2F;ext目录下有没有这个类，如果这个类被Extension类加载器找到了，那么它将被加载，而Application类加载器不会加载这个类；而如果这个类没有被Extension类加载器找到，那么再由Application类加载器从classpath中寻找。记住classpath定义的是类文件的加载目录，而PATH是定义的是可执行程序如javac，java等的执行路径。</p>
<p>　　采用双亲委派的一个好处是比如加载位于rt.jar包中的类java.lang.Object，不管是哪个加载器加载这个类，最终都是委托给顶层的启动类加载器进行加载，这样就保证了使用不同的类加载器最终得到的都是同样一个Object对象。 </p>
<p>　　双亲委派模式要求除了顶层的启动类加载器外，其余的类加载器都应当有自己的父类加载器，请注意双亲委派模式中的父子关系并非通常所说的类继承关系，而是采用组合关系来复用父类加载器的相关代码 。</p>
</li>
<li><p><strong>可见性机制</strong></p>
</li>
</ul>
<p>　　根据可见性机制，子类加载器可以看到父类加载器加载的类，而反之则不行。所以下面的例子中，当Abc.class已经被Application类加载器加载过了，然后如果想要使用Extension类加载器加载这个类，将会抛出java.lang.ClassNotFoundException异常。 </p>
<pre class="line-numbers language-none"><code class="language-none">package test;
import java.util.logging.Level;
import java.util.logging.Logger;
 
&#x2F;**
 * Java program to demonstrate How ClassLoader works in Java,
 * in particular about visibility principle of ClassLoader.
 *
 * @author Javin Paul
 *&#x2F;
 
public class ClassLoaderTest &#123;
 
    public static void main(String args[]) &#123;
        try &#123;          
            &#x2F;&#x2F;printing ClassLoader of this class
            System.out.println(&quot;ClassLoaderTest.getClass().getClassLoader() : &quot;
                                 + ClassLoaderTest.class.getClassLoader());
 
            &#x2F;&#x2F;trying to explicitly load this class again using Extension class loader
            Class.forName(&quot;test.ClassLoaderTest&quot;, true
                            ,  ClassLoaderTest.class.getClassLoader().getParent());
        &#125; catch (ClassNotFoundException ex) &#123;
            Logger.getLogger(ClassLoaderTest.class.getName()).log(Level.SEVERE, null, ex);
        &#125;
    &#125;
 
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>输出：</p>
<pre class="line-numbers language-none"><code class="language-none">ClassLoaderTest.getClass().getClassLoader() : sun.misc.Launcher$AppClassLoader@601bb1
16&#x2F;08&#x2F;2012 2:43:48 AM test.ClassLoaderTest main
SEVERE: null
java.lang.ClassNotFoundException: test.ClassLoaderTest
        at java.net.URLClassLoader$1.run(URLClassLoader.java:202)
        at java.security.AccessController.doPrivileged(Native Method)
        at java.net.URLClassLoader.findClass(URLClassLoader.java:190)
        at sun.misc.Launcher$ExtClassLoader.findClass(Launcher.java:229)
        at java.lang.ClassLoader.loadClass(ClassLoader.java:306)
        at java.lang.ClassLoader.loadClass(ClassLoader.java:247)
        at java.lang.Class.forName0(Native Method)
        at java.lang.Class.forName(Class.java:247)
        at test.ClassLoaderTest.main(ClassLoaderTest.java:29)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p><strong>单一性机制</strong></p>
<p>　　根据这个机制，父加载器加载过的类不能被子加载器加载第二次。虽然重写违反委托和单一性机制的类加载器是可能的，但这样做并不可取。你写自己的类加载器的时候应该严格遵守这三条机制。</p>
</li>
</ul>
<hr>
<h3 id="四、显示的加载类"><a href="#四、显示的加载类" class="headerlink" title="四、显示的加载类"></a>四、显示的加载类</h3><p>　　Java提供了显式加载类的API：<code>Class.forName(classname)</code>和<code>Class.forName(classname, initialized, classloader)</code>。就像上面的例子中，你可以指定类加载器的名称以及要加载的类的名称。类的加载是通过调用java.lang.ClassLoader的loadClass()方法，而loadClass()方法则调用了findClass()方法来定位相应类的字节码。在这个例子中Extension类加载器使用了java.net.URLClassLoader，它从JAR和目录中进行查找类文件，所有以”&#x2F;”结尾的查找路径被认为是目录。如果findClass()没有找到那么它会抛出java.lang.ClassNotFoundException异常，而如果找到的话则会调用defineClass()将字节码转化成类实例，然后返回。 </p>
<hr>
<p><em><strong>参考文章</strong></em></p>
<p><a href="https://www.tuicool.com/articles/QZnENv">从一道面试题来认识java类加载时机与过程</a></p>
<p><a href="http://www.importnew.com/25295.html">JVM 类加载机制详解</a></p>
<p><a href="http://www.importnew.com/6581.html">类加载器的工作原理</a></p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>jvm</tag>
      </tags>
  </entry>
  <entry>
    <title>Java集合</title>
    <url>/2018/07/30/java/java-ji-he/</url>
    <content><![CDATA[<p>​	早在 Java 2 中之前，Java 就提供了特设类。比如：Dictionary, Vector, Stack, 和 Properties 这些类用来存储和操作对象组。</p>
<p>虽然这些类都非常有用，但是它们缺少一个核心的，统一的主题。由于这个原因，使用 Vector 类的方式和使用 Properties 类的方式有着很大不同。</p>
<p>集合框架被设计成要满足以下几个目标。</p>
<ul>
<li>该框架必须是高性能的。基本集合（动态数组，链表，树，哈希表）的实现也必须是高效的。</li>
<li>该框架允许不同类型的集合，以类似的方式工作，具有高度的互操作性。</li>
<li>对一个集合的扩展和适应必须是简单的。</li>
</ul>
<p>为此，整个集合框架就围绕一组标准接口而设计。你可以直接使用这些接口的标准实现，诸如： <strong>LinkedList</strong>, <strong>HashSet</strong>, 和 <strong>TreeSet</strong> 等,除此之外你也可以通过这些接口实现自己的集合。</p>
<p><img src="/2018/07/30/java/java-ji-he/Java%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6%E5%9B%BE.png" alt="Java集合框架图"></p>
<p>从上面的集合框架图可以看到，Java 集合框架主要包括两种类型的容器，一种是集合（Collection），存储一个元素集合，另一种是图（Map），存储键&#x2F;值对映射。Collection 接口又有 3 种子类型，List、Set 和 Queue，再下面是一些抽象类，最后是具体实现类，常用的有 ArrayList、LinkedList、HashSet、LinkedHashSet、HashMap、LinkedHashMap 等等。 </p>
<ul>
<li><p><strong>Collection接口</strong></p>
<p>​    Collection 层次结构中的根接口。Collection 表示一组对象，这些对象也称为 collection 的<em>元素</em>。一些 collection 允许有重复的元素，而另一些则不允许。一些 collection 是有序的，而另一些则是无序的。JDK 不提供此接口的任何<em>直接</em> 实现：它提供更具体的子接口（如 <code>Set</code> 和 <code>List</code>）实现。此接口通常用来传递 collection，并在需要最大普遍性的地方操作这些 collection。</p>
</li>
</ul>
<p><em><strong>方法摘要</strong></em></p>
<table>
<thead>
<tr>
<th>返回类型</th>
<th>方法</th>
</tr>
</thead>
<tbody><tr>
<td><code> boolean</code></td>
<td><strong><code>add(E e)</code></strong><br>            确保此 collection 包含指定的元素（可选操作）。</td>
</tr>
<tr>
<td><code> boolean</code></td>
<td><strong><code>addAll(Collection&lt;? extends E&gt; c)</code></strong><br>            将指定 collection 中的所有元素都添加到此 collection 中（可选操作）。</td>
</tr>
<tr>
<td><code> void</code></td>
<td><strong><code>clear()</code></strong><br>          移除此 collection 中的所有元素（可选操作）。</td>
</tr>
<tr>
<td><code> boolean</code></td>
<td><strong><code>contains(Object o)</code></strong><br>            如果此 collection 包含指定的元素，则返回 <code>true</code>。</td>
</tr>
<tr>
<td><code> boolean</code></td>
<td><strong><code>containsAll(Collection&lt;?&gt; c)</code></strong><br>            如果此 collection 包含指定 collection 中的所有元素，则返回 <code>true</code>。</td>
</tr>
<tr>
<td><code> boolean</code></td>
<td><strong><code>equals(Object o)</code></strong><br>            比较此 collection 与指定对象是否相等。</td>
</tr>
<tr>
<td><code> int</code></td>
<td><strong><code>hashCode()</code></strong><br>            返回此 collection 的哈希码值。</td>
</tr>
<tr>
<td><code> boolean</code></td>
<td><strong><code>isEmpty()</code></strong><br>            如果此 collection 不包含元素，则返回 <code>true</code>。</td>
</tr>
<tr>
<td><code> Iterator&lt;E&gt;</code></td>
<td><strong><code>iterator()</code></strong><br>            返回在此 collection 的元素上进行迭代的迭代器。</td>
</tr>
<tr>
<td><code> boolean</code></td>
<td><strong><code>remove(Object o)</code></strong><br>            从此 collection 中移除指定元素的单个实例，如果存在的话（可选操作）。</td>
</tr>
<tr>
<td><code> boolean</code></td>
<td><strong><code>removeAll(Collection&lt;?&gt; c)</code></strong><br>            移除此 collection 中那些也包含在指定 collection 中的所有元素（可选操作）。</td>
</tr>
<tr>
<td><code> boolean</code></td>
<td><strong><code>retainAll(Collection&lt;?&gt; c)</code></strong><br>           仅保留此 collection 中那些也包含在指定 collection 的元素（可选操作）。</td>
</tr>
<tr>
<td><code> int</code></td>
<td><strong><code>size()</code></strong><br>            返回此 collection 中的元素数。</td>
</tr>
<tr>
<td><code> Object[]</code></td>
<td><strong><code>toArray()</code></strong><br>            返回包含此 collection 中所有元素的数组。</td>
</tr>
<tr>
<td><code>&lt;T&gt; T[]</code></td>
<td><strong><code>toArray(T[] a)</code></strong><br>            返回包含此 collection 中所有元素的数组；返回数组的运行时类型与指定数组的运行时类型相同。</td>
</tr>
</tbody></table>
<ul>
<li><p><strong>List接口</strong></p>
<p>​    List接口通常表示一个列表（数组、队列、链表、栈等），是一个有序的 collection（也称为<em>序列</em>）。此接口的用户可以对列表中每个元素的插入位置进行精确地控制。用户可以根据元素的整数索引（在列表中的位置）访问元素，并搜索列表中的元素。 </p>
<p>​    与 set 不同，列表通常允许重复的元素。更确切地讲，列表通常允许满足 <code>e1.equals(e2)</code> 的元素对 <code>e1</code> 和 <code>e2</code>，并且如果列表本身允许 null 元素的话，通常它们允许多个 null 元素。难免有人希望通过在用户尝试插入重复元素时抛出运行时异常的方法来禁止重复的列表，但我们希望这种用法越少越好。 </p>
<p>​     <code>List</code> 接口提供了特殊的迭代器，称为 <code>ListIterator</code>，除了允许 <code>Iterator</code> 接口提供的正常操作外，该迭代器还允许元素插入和替换，以及双向访问。还提供了一个方法来获取从列表中指定位置开始的列表迭代器。 </p>
</li>
<li><p><strong>Set接口</strong></p>
<p>​    一个不包含重复元素的 collection。更确切地讲，set 不包含满足 <code>e1.equals(e2)</code> 的元素对 <code>e1</code> 和 <code>e2</code>，并且最多包含一个 null 元素。正如其名称所暗示的，此接口模仿了数学上的 <em>set</em> 抽象。 </p>
<p>​    </p>
</li>
<li><p><strong>Map接口</strong></p>
<p>​    Map是一个映射接口，其中的每个元素都是一个key-value键值对，同样抽象类AbstractMap通过适配器模式实现了Map接口中的大部分函数，TreeMap、HashMap、WeakHashMap等实现类都通过继承AbstractMap来实现，另外，不常用的HashTable直接实现了Map接口，它和Vector都是JDK1.0就引入的集合类。 </p>
</li>
<li><p><strong>Iterator接口</strong></p>
<p>​    Iterator是遍历集合的迭代器（不能遍历Map，只用来遍历Collection），除了Map系列的集合，Collection集合都实现了 Iterator 接口，这是一个用于遍历集合中元素的接口，主要有hashNext()、next()、remove()三种方法。它的一个子接口ListIterator在它的基础上又添加了三种方法，分别是 add()、previous()、hasPrevious()方法。也就是说如果实现Iterator接口，那么在遍历集合中元素的时候，只能往后遍历，被遍历后的元素不会再被遍历到，通常无序集合实现的都是这个接口，比如HashSet；而那些元素有序的集合，实现的一般都是ListIterator接口，实现这个接口的集合可以双向遍历，既可以通过next()访问下一个元素，又可以通过previous()访问前一个 元素，比如ArrayList。</p>
<p>​    Collection的实现类都实现了iterator()函数，它返回一个Iterator对象，用来遍历集合，ListIterator则专门用来遍历List。而Enumeration则是JDK1.0时引入的，作用与Iterator相同，但它的功能比Iterator要少，它只能再Hashtable、Vector和Stack中使用。 </p>
</li>
<li><p>**Arrays和Collections **</p>
<p>​    Arrays和Collections是用来操作数组、集合的两个工具类，例如在ArrayList和Vector中大量调用了Arrays.Copyof()方法，而Collections中有很多静态方法可以返回各集合类的synchronized版本，即线程安全的版本，当然了，如果要用线程安全的结合类，首选Concurrent并发包下的对应的集合类。</p>
</li>
</ul>
<h2 id="Java集合实现类"><a href="#Java集合实现类" class="headerlink" title="Java集合实现类"></a>Java集合实现类</h2><p>​	Java提供了一套实现了Collection接口的标准集合类。其中一些是具体类，这些类可以直接拿来使用，而另外一些是抽象类，提供了接口的部分实现。 </p>
<ul>
<li><strong>ArrayList</strong></li>
<li><strong>LinkedList</strong></li>
<li><strong>Vector</strong></li>
<li><strong>Stack</strong></li>
<li><strong>HashSet</strong></li>
<li><strong>TreeSet</strong></li>
<li><strong>LinkedHashSet</strong></li>
<li><strong>ArrayBlockingQueue</strong></li>
<li><strong>LinkedBlockingQueue</strong></li>
<li><strong>DelayQueue</strong></li>
<li><strong>HashMap</strong></li>
<li><strong>TreeMap</strong></li>
<li><strong>Hashtable</strong></li>
<li><strong>LinkedHashMap</strong></li>
<li><strong>WeakHashMap</strong></li>
<li><strong>IdentityHashMap</strong></li>
</ul>
<hr>
<p>接下来介绍的几个类不是结合实现类，但对集合操作比较重要</p>
<ul>
<li><strong>Arrays</strong></li>
<li><strong>Collections</strong></li>
</ul>
<p><em><strong>参考文章</strong></em></p>
<p><a href="https://blog.csdn.net/ns_code/article/details/35564663">Java集合框架</a></p>
<p><a href="http://www.runoob.com/java/java-collections.html">Java集合框架</a></p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>LinkedHashMap源码分析</title>
    <url>/2021/03/06/java/linkedhashmap-yuan-ma-fen-xi/</url>
    <content><![CDATA[<h1 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h1><p>LinkedHashMap继承了HashMap，并通过双向列表来维护元素的顺序，本文结合HashMap的源码探究一下LinkedHashMap是如何维护元素的顺序的。</p>
<h2 id="1-1-构造方法"><a href="#1-1-构造方法" class="headerlink" title="1.1 构造方法"></a>1.1 构造方法</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    
    <span class="token comment">/**
     * The iteration ordering method for this linked hash map: &lt;tt>true&lt;/tt>
     * for access-order, &lt;tt>false&lt;/tt> for insertion-order.
     *
     * @serial
     */</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> accessOrder<span class="token punctuation">;</span>
    
    <span class="token comment">/**
     * Constructs an empty insertion-ordered &lt;tt>LinkedHashMap&lt;/tt> instance
     * with the specified initial capacity and load factor.
     *
     * @param  initialCapacity the initial capacity
     * @param  loadFactor      the load factor
     * @throws IllegalArgumentException if the initial capacity is negative
     *         or the load factor is nonpositive
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">LinkedHashMap</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">,</span> <span class="token keyword">float</span> loadFactor<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>initialCapacity<span class="token punctuation">,</span> loadFactor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        accessOrder <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * Constructs an empty insertion-ordered &lt;tt>LinkedHashMap&lt;/tt> instance
     * with the specified initial capacity and a default load factor (0.75).
     *
     * @param  initialCapacity the initial capacity
     * @throws IllegalArgumentException if the initial capacity is negative
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">LinkedHashMap</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>initialCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        accessOrder <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * Constructs an empty insertion-ordered &lt;tt>LinkedHashMap&lt;/tt> instance
     * with the default initial capacity (16) and load factor (0.75).
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">LinkedHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        accessOrder <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * Constructs an insertion-ordered &lt;tt>LinkedHashMap&lt;/tt> instance with
     * the same mappings as the specified map.  The &lt;tt>LinkedHashMap&lt;/tt>
     * instance is created with a default load factor (0.75) and an initial
     * capacity sufficient to hold the mappings in the specified map.
     *
     * @param  m the map whose mappings are to be placed in this map
     * @throws NullPointerException if the specified map is null
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">LinkedHashMap</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">V</span><span class="token punctuation">></span></span> m<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        accessOrder <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token function">putMapEntries</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * Constructs an empty &lt;tt>LinkedHashMap&lt;/tt> instance with the
     * specified initial capacity, load factor and ordering mode.
     *
     * @param  initialCapacity the initial capacity
     * @param  loadFactor      the load factor
     * @param  accessOrder     the ordering mode - &lt;tt>true&lt;/tt> for
     *         access-order, &lt;tt>false&lt;/tt> for insertion-order
     * @throws IllegalArgumentException if the initial capacity is negative
     *         or the load factor is nonpositive
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">LinkedHashMap</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">,</span>
                         <span class="token keyword">float</span> loadFactor<span class="token punctuation">,</span>
                         <span class="token keyword">boolean</span> accessOrder<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>initialCapacity<span class="token punctuation">,</span> loadFactor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>accessOrder <span class="token operator">=</span> accessOrder<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>LinkedHashMap的构造方法和HashMap相比多了一个accessOrder参数，LinkedHashMap基于双向列表来记录元素的顺序。元素的排序方式根据accessOrder参数来进行控制：</p>
<ul>
<li>accessOrder &#x3D; false ：根据元素的插入顺序排序</li>
<li>accessOrder &#x3D; true ： 根据元素的访问顺序排序</li>
</ul>
<h2 id="1-2-主要属性"><a href="#1-2-主要属性" class="headerlink" title="1.2 主要属性"></a>1.2 主要属性</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * HashMap.Node subclass for normal LinkedHashMap entries.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">HashMap<span class="token punctuation">.</span>Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> before<span class="token punctuation">,</span> after<span class="token punctuation">;</span>
    <span class="token class-name">Entry</span><span class="token punctuation">(</span><span class="token keyword">int</span> hash<span class="token punctuation">,</span> <span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">3801124242820219131L</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * The head (eldest) of the doubly linked list.
 */</span>
<span class="token keyword">transient</span> <span class="token class-name">LinkedHashMap<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> head<span class="token punctuation">;</span>

<span class="token comment">/**
 * The tail (youngest) of the doubly linked list.
 */</span>
<span class="token keyword">transient</span> <span class="token class-name">LinkedHashMap<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> tail<span class="token punctuation">;</span>

<span class="token comment">/**
 * The iteration ordering method for this linked hash map: &lt;tt>true&lt;/tt>
 * for access-order, &lt;tt>false&lt;/tt> for insertion-order.
 *
 * @serial
 */</span>
<span class="token keyword">final</span> <span class="token keyword">boolean</span> accessOrder<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>LinkedHashMap的静态内部类<code>Entry&lt;K,V&gt;</code>继承了HashMap的<code>HashMap.Node&lt;K,V&gt;</code>,<code>Entry</code>内部新增了before和after两个属性，实现了双向列表。</li>
<li><code>head</code>和<code>tail</code>两个字段用于记录队列的头节点和尾节点。</li>
<li><code>accessOrder</code>控制列表的顺序是根据插入顺序排序还是根据访问顺序进行排序。</li>
</ul>
<h2 id="1-3-主要方法"><a href="#1-3-主要方法" class="headerlink" title="1.3 主要方法"></a>1.3 主要方法</h2><p>LinkedHashMap并没有重写父类HashMap的put方法，而是重写了HashMap中空的钩子方法，HashMap源码如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// Callbacks to allow LinkedHashMap post-actions</span>
<span class="token keyword">void</span> <span class="token function">afterNodeAccess</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">void</span> <span class="token function">afterNodeInsertion</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> evict<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">void</span> <span class="token function">afterNodeRemoval</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span>   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>这些钩子方法在HashMap的<code>put</code>等方法中进行了调用，如：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">putVal</span><span class="token punctuation">(</span><span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">final</span> <span class="token class-name">V</span> <span class="token function">putVal</span><span class="token punctuation">(</span><span class="token keyword">int</span> hash<span class="token punctuation">,</span> <span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyIfAbsent<span class="token punctuation">,</span>
               <span class="token keyword">boolean</span> evict<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">;</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> p<span class="token punctuation">;</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> i<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tab <span class="token operator">=</span> table<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        n <span class="token operator">=</span> <span class="token punctuation">(</span>tab <span class="token operator">=</span> <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> tab<span class="token punctuation">[</span>i <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> hash<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">newNode</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> e<span class="token punctuation">;</span> <span class="token class-name">K</span> k<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> p<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            e <span class="token operator">=</span> p<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token keyword">instanceof</span> <span class="token class-name">TreeNode</span><span class="token punctuation">)</span>
            e <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">)</span>p<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putTreeVal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> tab<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> binCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token operator">++</span>binCount<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    p<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token function">newNode</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>binCount <span class="token operator">>=</span> <span class="token constant">TREEIFY_THRESHOLD</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// -1 for 1st</span>
                        <span class="token function">treeifyBin</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                p <span class="token operator">=</span> e<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// existing mapping for key</span>
            <span class="token class-name">V</span> oldValue <span class="token operator">=</span> e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onlyIfAbsent <span class="token operator">||</span> oldValue <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                e<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
            <span class="token function">afterNodeAccess</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> oldValue<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token operator">++</span>modCount<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>size <span class="token operator">></span> threshold<span class="token punctuation">)</span>
        <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">afterNodeInsertion</span><span class="token punctuation">(</span>evict<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="afterNodeInsertion-boolean-evict-方法"><a href="#afterNodeInsertion-boolean-evict-方法" class="headerlink" title="afterNodeInsertion(boolean evict)方法"></a>afterNodeInsertion(boolean evict)方法</h3><p>这个方法的主要作用就是在元素添加到Map中后，判断是否要移除最老的元素，默认返回false。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">afterNodeInsertion</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> evict<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// possibly remove eldest</span>
    <span class="token class-name">LinkedHashMap<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> first<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>evict <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>first <span class="token operator">=</span> head<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">removeEldestEntry</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">K</span> key <span class="token operator">=</span> first<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
        <span class="token function">removeNode</span><span class="token punctuation">(</span><span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们来看一下removeEldestEntry(first)方法的实现：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Returns &lt;tt>true&lt;/tt> if this map should remove its eldest entry.
 * This method is invoked by &lt;tt>put&lt;/tt> and &lt;tt>putAll&lt;/tt> after
 * inserting a new entry into the map.  It provides the implementor
 * with the opportunity to remove the eldest entry each time a new one
 * is added.  This is useful if the map represents a cache: it allows
 * the map to reduce memory consumption by deleting stale entries.
 *
 * &lt;p>Sample use: this override will allow the map to grow up to 100
 * entries and then delete the eldest entry each time a new entry is
 * added, maintaining a steady state of 100 entries.
 * &lt;pre>
 *     private static final int MAX_ENTRIES = 100;
 *
 *     protected boolean removeEldestEntry(Map.Entry eldest) &#123;
 *        return size() > MAX_ENTRIES;
 *     &#125;
 * &lt;/pre>
 *
 * &lt;p>This method typically does not modify the map in any way,
 * instead allowing the map to modify itself as directed by its
 * return value.  It &lt;i>is&lt;/i> permitted for this method to modify
 * the map directly, but if it does so, it &lt;i>must&lt;/i> return
 * &lt;tt>false&lt;/tt> (indicating that the map should not attempt any
 * further modification).  The effects of returning &lt;tt>true&lt;/tt>
 * after modifying the map from within this method are unspecified.
 *
 * &lt;p>This implementation merely returns &lt;tt>false&lt;/tt> (so that this
 * map acts like a normal map - the eldest element is never removed).
 *
 * @param    eldest The least recently inserted entry in the map, or if
 *           this is an access-ordered map, the least recently accessed
 *           entry.  This is the entry that will be removed it this
 *           method returns &lt;tt>true&lt;/tt>.  If the map was empty prior
 *           to the &lt;tt>put&lt;/tt> or &lt;tt>putAll&lt;/tt> invocation resulting
 *           in this invocation, this will be the entry that was just
 *           inserted; in other words, if the map contains a single
 *           entry, the eldest entry is also the newest.
 * @return   &lt;tt>true&lt;/tt> if the eldest entry should be removed
 *           from the map; &lt;tt>false&lt;/tt> if it should be retained.
 */</span>
<span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">removeEldestEntry</span><span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> eldest<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当我们将LinkedHashMap用作LRU缓存，我们需要限制缓存的大小，这时我们需要重写LinkedHashMap的removeEldestEntry方法，当元素个数超过设置的最大值后，则移除最老的元素，代码如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MAX_ENTRIES</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
<span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">removeEldestEntry</span><span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span> eldest<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">return</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token constant">MAX_ENTRIES</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="afterNodeAccess-Node-e-方法"><a href="#afterNodeAccess-Node-e-方法" class="headerlink" title="afterNodeAccess(Node&lt;K,V&gt; e)方法"></a>afterNodeAccess(Node&lt;K,V&gt; e)方法</h3><p>首先来看一下afterNodeAccess方法被调用的时机：</p>
<ul>
<li>LinkedHashMap中调用<code>public V get(Object key)</code>方法时，且accessOrder&#x3D;true</li>
<li>LinkedHashMap中调用<code>public V getOrDefault(Object key, V defaultValue)</code>方法时，且accessOrder&#x3D;true</li>
<li>HashMap中调用<code>put</code>方法添加一个Key已经存在的元素</li>
<li>HashMap中调用<code>public boolean replace(K key, V oldValue, V newValue)</code>方法时</li>
<li>HashMap中调用<code>public V replace(K key, V value)</code>方法时</li>
<li>HashMap中调用<code>public V computeIfAbsent(K key, Function&lt;? super K, ? extends V&gt; mappingFunction)</code>方法时，对应Key的值存且在不为null</li>
<li>HashMap中调用<code>public V computeIfPresent(K key, BiFunction&lt;? super K, ? super V, ? extends V&gt; remappingFunction)</code>方法时</li>
<li>HashMap中调用<code>public V compute(K key, BiFunction&lt;? super K, ? super V, ? extends V&gt; remappingFunction) </code>方法时</li>
<li>HashMap中调用<code>public V merge(K key, V value, BiFunction&lt;? super V, ? super V, ? extends V&gt; remappingFunction)</code>方法时</li>
</ul>
<p>该方法的主要作用是在accessOrder&#x3D;true的情况下，将e节点转移至双向队列末尾。  </p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">afterNodeAccess</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// move node to last</span>
    <span class="token class-name">LinkedHashMap<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> last<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>accessOrder <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>last <span class="token operator">=</span> tail<span class="token punctuation">)</span> <span class="token operator">!=</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">LinkedHashMap<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> p <span class="token operator">=</span>
            <span class="token punctuation">(</span><span class="token class-name">LinkedHashMap<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">)</span>e<span class="token punctuation">,</span> b <span class="token operator">=</span> p<span class="token punctuation">.</span>before<span class="token punctuation">,</span> a <span class="token operator">=</span> p<span class="token punctuation">.</span>after<span class="token punctuation">;</span>
        p<span class="token punctuation">.</span>after <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            head <span class="token operator">=</span> a<span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            b<span class="token punctuation">.</span>after <span class="token operator">=</span> a<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            a<span class="token punctuation">.</span>before <span class="token operator">=</span> b<span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            last <span class="token operator">=</span> b<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>last <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            head <span class="token operator">=</span> p<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            p<span class="token punctuation">.</span>before <span class="token operator">=</span> last<span class="token punctuation">;</span>
            last<span class="token punctuation">.</span>after <span class="token operator">=</span> p<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        tail <span class="token operator">=</span> p<span class="token punctuation">;</span>
        <span class="token operator">++</span>modCount<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="afterNodeRemoval-Node-e-方法"><a href="#afterNodeRemoval-Node-e-方法" class="headerlink" title="afterNodeRemoval(Node&lt;K,V&gt; e)方法"></a>afterNodeRemoval(Node&lt;K,V&gt; e)方法</h3><p>该方法的作用是在元素被移除后将列表中的元素也进行移除。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">afterNodeRemoval</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// unlink</span>
    <span class="token class-name">LinkedHashMap<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> p <span class="token operator">=</span>
        <span class="token punctuation">(</span><span class="token class-name">LinkedHashMap<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">)</span>e<span class="token punctuation">,</span> b <span class="token operator">=</span> p<span class="token punctuation">.</span>before<span class="token punctuation">,</span> a <span class="token operator">=</span> p<span class="token punctuation">.</span>after<span class="token punctuation">;</span>
    p<span class="token punctuation">.</span>before <span class="token operator">=</span> p<span class="token punctuation">.</span>after <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        head <span class="token operator">=</span> a<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        b<span class="token punctuation">.</span>after <span class="token operator">=</span> a<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        tail <span class="token operator">=</span> b<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        a<span class="token punctuation">.</span>before <span class="token operator">=</span> b<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>LinkedHashMap继承了HashMap，通过<code>Entry</code>对象构建了一个双向队列，并通过重写HashMap中预留的空的钩子方法维护元素的顺序。当accessOrder&#x3D;false，默认根据元素的插入顺序排序；accessOrder&#x3D;true，根据元素的访问顺序进行排序。<br>根据LinkedHashMap的特点，能够很方便的实现一个LRU缓存算法，如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LinkedHashMapLRUCache</span> <span class="token keyword">extends</span> <span class="token class-name">LinkedHashMap</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> <span class="token constant">CACHE_MAX_COUNT</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">LinkedHashMapLRUCache</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>initialCapacity<span class="token punctuation">,</span> <span class="token number">0.75f</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">CACHE_MAX_COUNT</span> <span class="token operator">=</span> initialCapacity<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">removeEldestEntry</span><span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span> eldest<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token constant">CACHE_MAX_COUNT</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>LinkedHashMap</tag>
        <tag>LRU</tag>
      </tags>
  </entry>
  <entry>
    <title>10万TPS级高并发系统——30亿级发送量频次管控（一）</title>
    <url>/2024/06/15/high-concurrency/10-wan-tps-ji-gao-bing-fa-xi-tong-30-yi-ji-fa-song-liang-pin-ci-guan-kong/</url>
    <content><![CDATA[<h1 id="一、背景简介"><a href="#一、背景简介" class="headerlink" title="一、背景简介"></a>一、背景简介</h1><div class="note success no-icon flat"><p>在客户的业务场景中，需要在全局开启终端用户消息发送的频次管控，避免消息重复发送以及段时间内下发大量消息对终端用户进行信息轰炸，从而引起终端用户投诉。目前业务平台每日最高的消息发送量为30亿，去重后的消息接收人量在千万级到亿级，消息发送管控平台需要对每个消息接收人的消息发送时间进行缓存，并根据管控平台配置频次管控策略，检查最新下发的消息是否超过设置的频次，超过则进行拦截。</p>
</div>
<h2 id="1-1-频次管控配置"><a href="#1-1-频次管控配置" class="headerlink" title="1.1 频次管控配置"></a>1.1 频次管控配置</h2><table>
<thead>
<tr>
<th>限制项</th>
<th>限制频率</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>接收频次管控</td>
<td>15次&#x2F;1分钟</td>
<td>任意1分钟内，对同一个接收人发送消息最多15次，超出次数会被限制。</td>
</tr>
<tr>
<td>接收频次管控</td>
<td>50次&#x2F;24小时</td>
<td>任意24小时内，对同一个接收人发送消息最多50次，超出次数会被限制。</td>
</tr>
<tr>
<td>内容频次管控</td>
<td>2次&#x2F;59秒</td>
<td>任意59秒内，对同一个接收人发送同一内容（内容完全相同）最多2次，超出次数会被限制。</td>
</tr>
<tr>
<td>内容频次管控</td>
<td>5次&#x2F;59分钟</td>
<td>任意59分钟内，对同一个接收人发送同一消息内容（内容完全相同）最多5次，超出次数会被限制。</td>
</tr>
</tbody></table>
<h1 id="二、需求分析"><a href="#二、需求分析" class="headerlink" title="二、需求分析"></a>二、需求分析</h1><p>基于上述业务场景，我们需要对每个消息接收者做消息接收的频次限制，在每日30亿级的发送量的场景下，接收用户的数量也是亿级的。根据业务频次管控限流要求，需要实现分钟级别和24小时级别的频次管控。即需要对亿级终端接收用户分做独立的限流，限流的时间范围在分钟和24小时级别。</p>
<h1 id="三、方案设计"><a href="#三、方案设计" class="headerlink" title="三、方案设计"></a>三、方案设计</h1><p>上述业务需求其实是一种流量控制场景，可以结合一些常用的限流方案进行分析与设计。业务常见的限流方案有：固定窗口计数器、滑动窗口计数器、漏桶算法、令牌桶算法、分布式限流等（详见：<a href="https://www.mpoom.cn/2024/06/08/distributed/si-chong-jing-dian-de-xian-liu-suan-fa/">四种经典的限流算法</a>），我们先分析现有方案的特点再结合业务场景进行方案设计。</p>
<h2 id="3-1-限流算法选择"><a href="#3-1-限流算法选择" class="headerlink" title="3.1 限流算法选择"></a>3.1 限流算法选择</h2><p>基于上述业务场景，需要对每日亿级的终端接收用户做单独限流，结合经典的限流算法特点选择适合的算法：</p>
<table>
<thead>
<tr>
<th>限流算法</th>
<th>特点</th>
<th>是否适合</th>
<th>具体说明</th>
</tr>
</thead>
<tbody><tr>
<td>固定时间窗口</td>
<td>简单，易于实现和理解</td>
<td>可选</td>
<td>容忍临界问题存在</td>
</tr>
<tr>
<td>滑动时间窗口</td>
<td>简单易懂，精度高，可扩展性强</td>
<td>适合</td>
<td>实现简单精度高</td>
</tr>
<tr>
<td>漏桶算法</td>
<td>平滑的限制处理速度</td>
<td>不适合</td>
<td>无法应对突发流量</td>
</tr>
<tr>
<td>令牌桶算法</td>
<td>稳定性高、精度高、可以处理突发流量</td>
<td>不适合</td>
<td>需要对日发送亿级用户做限流，需要维护上亿个令牌桶，复杂度过高</td>
</tr>
</tbody></table>
<p>综上，经典的限流算法中<code>滑动时间窗口</code>是最适合的算法，<code>固定时间窗口</code>作为备选方案，因为固定时间窗口存在一个临界问题。</p>
<h2 id="3-2-详细设计"><a href="#3-2-详细设计" class="headerlink" title="3.2 详细设计"></a>3.2 详细设计</h2><p>目前系统性能需要达到10万TPS，应用使用集群化方式部署，同时需要实现日亿级用户的限流。所以我们需要实现一个基于滑动时间窗口的分布式限流器，且支持亿级用户做单独的限流。<br>根据业务及性能要求，我们使用Redis来设计一个基于<code>滑动时间窗口算法</code>的分布式限流器。</p>
<p><img src="/2024/06/15/high-concurrency/10-wan-tps-ji-gao-bing-fa-xi-tong-30-yi-ji-fa-song-liang-pin-ci-guan-kong/ZSET%E6%BB%91%E5%8A%A8%E6%97%B6%E9%97%B4%E7%AA%97%E5%8F%A3%E9%99%90%E6%B5%81%E5%99%A8.png" alt="ZSET滑动时间窗口限流器.png"></p>
<p>基于Redis ZSET集合的特点，我们使用ZSET来实现一个滑动时间窗口，用户每次下发成功后我们向ZSET添加一个成员，该成员的值和分数为当前消息的发送时间戳。</p>
<h3 id="3-2-1-发送限流"><a href="#3-2-1-发送限流" class="headerlink" title="3.2.1 发送限流"></a>3.2.1 发送限流</h3><p>发送消息前，我们根据当前时间和滑动时间窗口大小计算出滑动窗口起始时间戳，通过ZSET的<code>Score</code>获取起始时间戳和当前时间戳区间内成员的个数即为用户的消息发送量，如果超出频次限制则限制下发，如果未超过，则将该发送时间添加到ZSET中。</p>
<h3 id="3-2-2-代码实现"><a href="#3-2-2-代码实现" class="headerlink" title="3.2.2 代码实现"></a>3.2.2 代码实现</h3><p>下面通过Redis的ZSET数据结构及LUA脚本实现一个滑动窗口计数器，Lua脚本<code>frequency_limit.lua</code>内容如下：</p>
<pre class="line-numbers language-none"><code class="language-none">-- 接收参数
local key &#x3D; KEYS[1]
local windowSize &#x3D; tonumber(ARGV[1])
local limit &#x3D; tonumber(ARGV[2])

-- 获取精确到毫秒的时间戳
local nowMicros &#x3D; redis.call(&#39;time&#39;)
local nowMillis &#x3D; math.floor(nowMicros[1] * 1000 + nowMicros[2] &#x2F; 1000)

-- 计算时间窗口的最小值
local minScore &#x3D; nowMillis - windowSize

-- 获取时间窗口范围内的成员数量
local count &#x3D; redis.call(&#39;ZCOUNT&#39;, key, minScore, nowMillis)

-- 如果数量没有超过限制
if count &lt; limit then
    -- 查找下一个可用的、未存在于ZSET中的时间戳
    local uniqueTimestamp &#x3D; nowMillis
    while redis.call(&#39;ZSCORE&#39;, key, uniqueTimestamp) do
        uniqueTimestamp &#x3D; uniqueTimestamp + 1
    end
    -- 将找到的唯一时间戳作为值，当前时间戳作为score添加到ZSET
    redis.call(&#39;ZADD&#39;, key, nowMillis, uniqueTimestamp)
    
    -- 仅当添加了新元素后，才更新ZSET的过期时间
    redis.call(&#39;EXPIRE&#39;, key, windowSize)
end

-- 返回计算出的数量
return count<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="缓存过期时间"><a href="#缓存过期时间" class="headerlink" title="缓存过期时间"></a>缓存过期时间</h4><p>每次调用时将缓存的过期时间更新为一个滑动时间窗口大小，当一个滑动时间窗口区间内没有请求进来，则缓存过期。</p>
<h4 id="并发访问问题"><a href="#并发访问问题" class="headerlink" title="并发访问问题"></a>并发访问问题</h4><p>我们在ZSET中使用毫秒级别的时间戳来记录访问数量。在高并发的情况下，可能会存在同一毫秒下发多条消息导致发送量出现覆盖，我们采用占用未来时间戳的方式解决并发冲突。</p>
<div class="note success no-icon flat"><p><strong>说明</strong>：由于我们是对用户进行限流，系统的并发高，但是用户级别的并发并不是很高，如上述的1分钟15次，所以采用占用未来时间戳的方式解决并发冲突。如果是应对系统级别的高并发请求，可以在时间戳后面增加序列号来解决并发冲突，序列号的长度通过每秒的并发数进行计算评估。</p>
</div>

<h3 id="3-2-3-验证测试"><a href="#3-2-3-验证测试" class="headerlink" title="3.2.3 验证测试"></a>3.2.3 验证测试</h3><div class="note success no-icon flat"><p>假设用户<code>18829340001</code>每分钟接收到消息的数量限制为5条，如果发送量小于限制的5条则继续下发，如果大于等于限制的5条，则进行频次管控。</p>
</div>
<h4 id="上传Lua脚本"><a href="#上传Lua脚本" class="headerlink" title="上传Lua脚本"></a>上传Lua脚本</h4><pre class="line-numbers language-none"><code class="language-none">[root@develop bin]# .&#x2F;redis-cli -p 6383 -a 123456 SCRIPT LOAD &quot;$(cat frequency_limit.lua)&quot;
Warning: Using a password with &#39;-a&#39; or &#39;-u&#39; option on the command line interface may not be safe.
&quot;59931c4f3ae5b3601ba2988d12d7aa897afc9549&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="执行Lua脚本"><a href="#执行Lua脚本" class="headerlink" title="执行Lua脚本"></a>执行Lua脚本</h4><p>下面通过Redis执行上述lua脚本，获取<code>18829340001</code>前1分钟的消息发送量，当返回值小于5时，可以继续下发消息；当返回值为5时，表示前1分钟内已经下发了5条，需要进行频次管控。</p>
<pre class="line-numbers language-none"><code class="language-none">127.0.0.1:6383&gt; EVALSHA 59931c4f3ae5b3601ba2988d12d7aa897afc9549 1 18829340001 60000 5
(integer) 0
127.0.0.1:6383&gt; EVALSHA 59931c4f3ae5b3601ba2988d12d7aa897afc9549 1 18829340001 60000 5
(integer) 1
127.0.0.1:6383&gt; EVALSHA 59931c4f3ae5b3601ba2988d12d7aa897afc9549 1 18829340001 60000 5
(integer) 2
127.0.0.1:6383&gt; EVALSHA 59931c4f3ae5b3601ba2988d12d7aa897afc9549 1 18829340001 60000 5
(integer) 3
127.0.0.1:6383&gt; EVALSHA 59931c4f3ae5b3601ba2988d12d7aa897afc9549 1 18829340001 60000 5
(integer) 4
127.0.0.1:6383&gt; EVALSHA 59931c4f3ae5b3601ba2988d12d7aa897afc9549 1 18829340001 60000 5
(integer) 5
127.0.0.1:6383&gt; EVALSHA 59931c4f3ae5b3601ba2988d12d7aa897afc9549 1 18829340001 60000 5
(integer) 5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="四、性能评估"><a href="#四、性能评估" class="headerlink" title="四、性能评估"></a>四、性能评估</h1><h2 id="4-1-业务场景分析"><a href="#4-1-业务场景分析" class="headerlink" title="4.1 业务场景分析"></a>4.1 业务场景分析</h2><div class="note success no-icon flat"><p>消息发送管控系统性能要求为10万TPS，平均响应时长不超过50ms。系统每天发送峰值为30亿，单独的发送用户约在亿级别，全局配置频次管控个数至少为2个，结合系统其它访问Redis的场景，每个请求平均访问Redis3次，频次管控的最大时长为24小时，即用户发送记录最大需要保存24小时，独立用户数在亿级。</p>
</div>

<p><strong>即Redis的性能要在30万TPS以上,需要支持亿级数据缓存。</strong></p>
<h2 id="4-2-Redis主备性能评估"><a href="#4-2-Redis主备性能评估" class="headerlink" title="4.2 Redis主备性能评估"></a>4.2 Redis主备性能评估</h2><p>该项目使用华为云部署，使用华为云上Redis服务，华为云提供的<a href="https://support.huaweicloud.com/usermanual-dcs/dcs_10_0001.html">Redis6主备性能</a>测试数据如下：<br><img src="/2024/06/15/high-concurrency/10-wan-tps-ji-gao-bing-fa-xi-tong-30-yi-ji-fa-song-liang-pin-ci-guan-kong/%E5%8D%8E%E4%B8%BA%E4%BA%91Redis6%E4%B8%BB%E5%A4%87%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE.png" alt="华为云Redis6主备性能数据"></p>
<p>Redis主备32G实例的性能在14万TPS作为，无法满足系统30万+TPS性能要求，所以需要使用Redis集群。</p>
<h2 id="4-3-Redis集群性能评估"><a href="#4-3-Redis集群性能评估" class="headerlink" title="4.3 Redis集群性能评估"></a>4.3 Redis集群性能评估</h2><p>华为云提供的<a href="https://support.huaweicloud.com/usermanual-dcs/dcs_10_0002.html">Redis6集群性能</a>测试数据如下：<br><img src="/2024/06/15/high-concurrency/10-wan-tps-ji-gao-bing-fa-xi-tong-30-yi-ji-fa-song-liang-pin-ci-guan-kong/%E5%8D%8E%E4%B8%BA%E4%BA%91Redis6%E9%9B%86%E7%BE%A4%E6%80%A7%E8%83%BD%E6%95%B0%E6%8D%AE.png" alt="华为云Redis6集群性能数据"><br>华为云Redis6 32G集群实例的性能达到30万tps，为应对业务中配置多条频次管控场景，选择64G 8分片的规格。<br>但在生产环境中，客户直接选择256G 32分片的规格实例，在配置2条全局的频次管控场景下，压测10万TPS，Redis集群CPU负载在50%以上。</p>
<h1 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h1><p>本文主要介绍基于Redis的ZSET数据结构实现一个滑动窗口计数器，实现亿级用户的发送频次管控，并根据业务场景和华为云Redis不同规格的性能进行规格选择。</p>
<h2 id="5-1-优化改进"><a href="#5-1-优化改进" class="headerlink" title="5.1 优化改进"></a>5.1 优化改进</h2><p>在上述设计方案中，结合业务场景分析频次管控配置数量在1-2个左右，为实现简单所以每个频次管控单独维护一个滑动窗口计数器。如果需要适配较多的窗口大小的场景下，可以将多个滑动窗口进行合并，降低网络消耗，提高性能。</p>
<h2 id="5-2-其它问题"><a href="#5-2-其它问题" class="headerlink" title="5.2 其它问题"></a>5.2 其它问题</h2><p>在大数据量、高并发的场景下，Redis的使用还会出现大Key等问题，具体的场景和案例，敬请期待后续文章。</p>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p><a href="https://juejin.cn/post/7000152990501847048">微服务 —— 常见的5种限流方案｜8月更文挑战</a><br><a href="https://juejin.cn/post/7339544833999110170">基于redis的简易滑动窗口实现</a><br><a href="https://heapdump.cn/article/5480577">面试必备：四种经典限流算法讲解</a></p>
]]></content>
      <categories>
        <category>分布式</category>
      </categories>
      <tags>
        <tag>高并发</tag>
        <tag>限流算法</tag>
        <tag>10万TPS</tag>
        <tag>频次管控</tag>
        <tag>滑动窗口</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux上使用JMeter进行压测</title>
    <url>/2023/12/02/java/linux-shang-shi-yong-jmeter-jin-xing-ya-ce/</url>
    <content><![CDATA[<h1 id="背景简介"><a href="#背景简介" class="headerlink" title="背景简介"></a>背景简介</h1><p>JMeter是我们日常开发中最常用的压测工具，我们经常会直接在本地启动JMeter对本地或远程应用进行简单的压测。但是这种压测场景下得出的压测结果并不严谨，受以下两方面影响：</p>
<ul>
<li>本地机器硬件配置差，压测中本机的性能最先达到瓶颈</li>
<li>本地机器和远程服务端网络延时较高，导致压测性能比预期差<br>所以我们做一些简单的验证可以在本地直接启动JMeter进行压测，但是如果要做真实的性能测试，需要使用专用的压测服务器对服务端应用进行压测。而压测服务器一般都是Linux系统，所以需要在Linux系统上使用JMeter进行操作。</li>
</ul>
<h1 id="JMeter配置"><a href="#JMeter配置" class="headerlink" title="JMeter配置"></a>JMeter配置</h1><h2 id="下载JMeter压测工具"><a href="#下载JMeter压测工具" class="headerlink" title="下载JMeter压测工具"></a>下载JMeter压测工具</h2><p>登录Linux压测服务器，下载JMeter压测工具，<a href="https://jmeter.apache.org/download_jmeter.cgi">官网下载地址</a>。</p>
<pre class="line-numbers language-none"><code class="language-none">curl -O https:&#x2F;&#x2F;dlcdn.apache.org&#x2F;&#x2F;jmeter&#x2F;binaries&#x2F;apache-jmeter-5.6.2.zip<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>注意：请确保压测服务器已经安装了JDK1.8</p>
<h2 id="解压并配置JMeter"><a href="#解压并配置JMeter" class="headerlink" title="解压并配置JMeter"></a>解压并配置JMeter</h2><blockquote>
<p>说明：配置JMeter环境变量是为了方便在任意路劲下使用<code>jmeter</code>命令，如果不配置环境变量，则直接进入JMeter解压目录的bin目录下执行。</p>
</blockquote>
<p>1.解压JMeter</p>
<pre class="line-numbers language-none"><code class="language-none">unzip apache-jmeter-5.6.2.zip
# 移动到local目录
mv apache-jmeter-5.6.2 &#x2F;usr&#x2F;local&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>2.配置JMeter环境变量<br>在<code>/etc/profile</code>文件末尾添加以下内容：</p>
<pre class="line-numbers language-none"><code class="language-none">export JMETER_HOME&#x3D;&#x2F;usr&#x2F;local&#x2F;apache-jmeter-5.6.2
export PATH&#x3D;$&#123;JMETER_HOME&#125;&#x2F;bin:$PATH<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>保存修改，执行source &#x2F;etc&#x2F;profile，重新加载配置文件。<br>最后，通过<code>jmeter --version</code>查看安装的JMeter版本，验证安装成功。</p>
<h1 id="压测步骤"><a href="#压测步骤" class="headerlink" title="压测步骤"></a>压测步骤</h1><h2 id="设置压测场景和数据"><a href="#设置压测场景和数据" class="headerlink" title="设置压测场景和数据"></a>设置压测场景和数据</h2><p>1.在windows系统中设置好压测场景和数据，保存到jmx文件中。如: test.jmx</p>
<h2 id="上传JMeter压测脚本"><a href="#上传JMeter压测脚本" class="headerlink" title="上传JMeter压测脚本"></a>上传JMeter压测脚本</h2><p>将jmx压测脚本上传至Linux服务器任意目录。</p>
<h2 id="执行压测命令"><a href="#执行压测命令" class="headerlink" title="执行压测命令"></a>执行压测命令</h2><pre class="line-numbers language-none"><code class="language-none">jmeter -n -t test.jmx -l result.jtl<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>命令行参数：<a href="https://jmeter.apache.org/usermanual/get-started.html#non_gui">1.4.4 CLI Mode (Command Line mode was called NON GUI mode)</a></p>
<h3 id="CLI-Mode-Command-Line-mode-was-called-NON-GUI-mode"><a href="#CLI-Mode-Command-Line-mode-was-called-NON-GUI-mode" class="headerlink" title="CLI Mode(Command Line mode was called NON GUI mode)"></a>CLI Mode(Command Line mode was called NON GUI mode)</h3><p>For load testing, you must run JMeter in this mode (Without the GUI) to get the optimal results from it. To do so, use the following command options:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">-n</span>  This specifies JMeter is to run <span class="token keyword">in</span> cli mode
<span class="token parameter variable">-t</span>  <span class="token punctuation">[</span>name of JMX <span class="token function">file</span> that contains the Test Plan<span class="token punctuation">]</span>.
<span class="token parameter variable">-l</span>  <span class="token punctuation">[</span>name of JTL <span class="token function">file</span> to log sample results to<span class="token punctuation">]</span>.
<span class="token parameter variable">-j</span>  <span class="token punctuation">[</span>name of JMeter run log file<span class="token punctuation">]</span>.
<span class="token parameter variable">-r</span>  the <span class="token builtin class-name">test</span> <span class="token keyword">in</span> the servers specified by the JMeter property <span class="token string">"remote_hosts"</span>
<span class="token parameter variable">-R</span>  <span class="token punctuation">[</span>list of remote servers<span class="token punctuation">]</span> Run the <span class="token builtin class-name">test</span> <span class="token keyword">in</span> the specified remote servers
<span class="token parameter variable">-g</span>  <span class="token punctuation">[</span>path to CSV file<span class="token punctuation">]</span> generate report dashboard only
<span class="token parameter variable">-e</span>  generate report dashboard after load <span class="token builtin class-name">test</span>
<span class="token parameter variable">-o</span>  output folder where to generate the report dashboard after load test. Folder must not exist or be empty
    The script also lets you specify the optional firewall/proxy server information:
<span class="token parameter variable">-H</span>  <span class="token punctuation">[</span>proxy server <span class="token function">hostname</span> or <span class="token function">ip</span> address<span class="token punctuation">]</span>
<span class="token parameter variable">-P</span>  <span class="token punctuation">[</span>proxy server port<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">jmeter <span class="token parameter variable">-n</span> <span class="token parameter variable">-t</span> my_test.jmx <span class="token parameter variable">-l</span> log.jtl <span class="token parameter variable">-H</span> my.proxy.server <span class="token parameter variable">-P</span> <span class="token number">8000</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>在进行严谨的性能压测时需要使用JMeter的命令行模式进行压测，且一般压测在Linux服务器上进行，主要步骤如下：</p>
<ul>
<li>1.下载JMeter</li>
<li>2.解压并配置环境变量</li>
<li>3.在Windows上配置好JMeter的测试计划并保存为jmx文件</li>
<li>4.在压测服务器上通过命令行模式执行压测计划</li>
</ul>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>JMeter</tag>
        <tag>压测</tag>
      </tags>
  </entry>
  <entry>
    <title>SSH使用X11转发引起的异常</title>
    <url>/2022/07/13/java/ssh-shi-yong-x11-zhuan-fa-yin-qi-de-yi-chang/</url>
    <content><![CDATA[<h1 id="一、问题背景"><a href="#一、问题背景" class="headerlink" title="一、问题背景"></a>一、问题背景</h1><p>测试同学在测试导出Excel功能时报错，异常日志如下：</p>
<pre class="line-numbers language-none"><code class="language-none">java.util.concurrent.ExecutionException: java.awt.AWTError: Can&#39;t connect to X11 window server using &#39;localhost:10.0&#39; as the value of the DISPLAY variable.
        at java.util.concurrent.FutureTask.report(FutureTask.java:122)
        at java.util.concurrent.FutureTask.get(FutureTask.java:192)
        at com.xuanwu.ds.service.impl.export.async.ExportWorker.run(ExportWorker.java:76)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
        at java.lang.Thread.run(Thread.java:748)
Caused by: java.awt.AWTError: Can&#39;t connect to X11 window server using &#39;localhost:10.0&#39; as the value of the DISPLAY variable.
        at sun.awt.X11GraphicsEnvironment.initDisplay(Native Method)
        at sun.awt.X11GraphicsEnvironment.access$200(X11GraphicsEnvironment.java:65)
        at sun.awt.X11GraphicsEnvironment$1.run(X11GraphicsEnvironment.java:115)
        at java.security.AccessController.doPrivileged(Native Method)
        at sun.awt.X11GraphicsEnvironment.&lt;clinit&gt;(X11GraphicsEnvironment.java:74)
        at java.lang.Class.forName0(Native Method)
        at java.lang.Class.forName(Class.java:264)
        at java.awt.GraphicsEnvironment.createGE(GraphicsEnvironment.java:103)
        at java.awt.GraphicsEnvironment.getLocalGraphicsEnvironment(GraphicsEnvironment.java:82)
        at sun.awt.X11FontManager.isHeadless(X11FontManager.java:509)
        at sun.awt.X11FontManager.getFileNameFromPlatformName(X11FontManager.java:189)
        at sun.font.SunFontManager.initCompositeFonts(SunFontManager.java:3481)
        at sun.font.SunFontManager.access$700(SunFontManager.java:65)
        at sun.font.SunFontManager$2.run(SunFontManager.java:545)
        at java.security.AccessController.doPrivileged(Native Method)
        at sun.font.SunFontManager.&lt;init&gt;(SunFontManager.java:376)
        at sun.awt.FcFontManager.&lt;init&gt;(FcFontManager.java:35)
        at sun.awt.X11FontManager.&lt;init&gt;(X11FontManager.java:57)
        at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)
        at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)
        at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
        at java.lang.reflect.Constructor.newInstance(Constructor.java:423)
        at java.lang.Class.newInstance(Class.java:442)
        at sun.font.FontManagerFactory$1.run(FontManagerFactory.java:83)
        at java.security.AccessController.doPrivileged(Native Method)
        at sun.font.FontManagerFactory.getInstance(FontManagerFactory.java:74)
        at java.awt.Font.getFont2D(Font.java:491)
        at java.awt.Font.canDisplayUpTo(Font.java:2060)
        at java.awt.font.TextLayout.singleFont(TextLayout.java:470)
        at java.awt.font.TextLayout.&lt;init&gt;(TextLayout.java:531)
        at org.apache.poi.ss.util.SheetUtil.getDefaultCharWidth(SheetUtil.java:275)
        at org.apache.poi.xssf.streaming.AutoSizeColumnTracker.&lt;init&gt;(AutoSizeColumnTracker.java:117)
        at org.apache.poi.xssf.streaming.SXSSFSheet.&lt;init&gt;(SXSSFSheet.java:82)
        at org.apache.poi.xssf.streaming.SXSSFWorkbook.createAndRegisterSXSSFSheet(SXSSFWorkbook.java:658)
        at org.apache.poi.xssf.streaming.SXSSFWorkbook.createSheet(SXSSFWorkbook.java:650)
        &#x2F;&#x2F; 此处省略部分业务堆栈信息
        ... 3 more<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但是在开发环境（Windows），该导出功能正常。</p>
<h1 id="二、原因分析"><a href="#二、原因分析" class="headerlink" title="二、原因分析"></a>二、原因分析</h1><p>根据异常堆栈信息，无法连接到X11 window server。</p>
<h2 id="2-1-X-Window-System简介"><a href="#2-1-X-Window-System简介" class="headerlink" title="2.1 X Window System简介"></a>2.1 X Window System简介</h2><blockquote>
<p>The X Window System (also known as X11, or just X) is a software package and network protocol that lets you interact locally, using your personal computer’s display, mouse, and keyboard, with the graphical user interface (GUI) of an application running on a remote networked computer.</p>
</blockquote>
<p>X Window System（也称为 X11，或简称 X）是一个软件包和网络协议，可让您使用个人计算机的显示器、鼠标和键盘进行本地交互，同时运行应用程序的图形用户界面 (GUI) 在远程联网计算机上。</p>
<blockquote>
<p>You can use X forwarding in an SSH session on your personal computer to securely run graphical applications (X clients) installed on the Indiana University research supercomputers.</p>
</blockquote>
<p>您可以在个人计算机上的 SSH 会话中使用 X (X Window System) 转发来安全地运行安装在印第安纳大学研究超级计算机上的图形应用程序（X 客户端）。</p>
<blockquote>
<p>For X forwarding in SSH to work, your personal computer must be running an X server program. The X server program manages the interaction between the remote application (the X client) and your computer’s hardware.</p>
</blockquote>
<p>要在 SSH 中进行 X 转发，您的个人计算机必须运行 X 服务器程序。 X 服务器程序管理远程应用程序（X 客户端）和计算机硬件之间的交互</p>
<h2 id="2-2-SSH使用X转发"><a href="#2-2-SSH使用X转发" class="headerlink" title="2.2 SSH使用X转发"></a>2.2 SSH使用X转发</h2><p>SSH使用X转发参照一下命令：</p>
<pre class="line-numbers language-none"><code class="language-none">Linux: ssh -X username@hostname
macOS: ssh -Y username@hostname<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>SSH使用X转发所需要具备的环境详见：<a href="https://kb.iu.edu/d/bdnt#interactive">Use X forwarding on a personal computer</a></p>
<h2 id="2-3-日志分析"><a href="#2-3-日志分析" class="headerlink" title="2.3 日志分析"></a>2.3 日志分析</h2><p>根据上述异常日志信息，推测由于使用SSH连接到服务器开启了X11转发，Java应用程序作为X Client连接到 X Server，目前报错应该是SSH连接断开后X11连接失败导致。<br>与测试同学沟通，发现使用Xshell工具连接到服务器启动的Java进程，网上也有文章描述Xshell存在该问题，所以判断是使用Xshel启动Java进程后XShell断开连接导致出现了该问题。</p>
<h2 id="2-4-复现异常"><a href="#2-4-复现异常" class="headerlink" title="2.4 复现异常"></a>2.4 复现异常</h2><p>使用Xshell连接到服务器后启动Java进程后，关闭Xshell中的SSH连接，进行导出操作，错误复现。</p>
<p>查看Xshell中SSH连接的配置，默认开启了X11转发,配置如下：<br><img src="/2022/07/13/java/ssh-shi-yong-x11-zhuan-fa-yin-qi-de-yi-chang/xshell-config.png" alt="Xshell-config"></p>
<h1 id="三、解决方案"><a href="#三、解决方案" class="headerlink" title="三、解决方案"></a>三、解决方案</h1><p>(1) 如果使用XShell，则关闭X11转发<br>(2) 设置JVM参数，不去检查图形界面</p>
<pre class="line-numbers language-none"><code class="language-none">-Djava.awt.headless&#x3D;true 
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h1 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h1><p>由于XShell工具中的SSH连接默认开启X11转发，Java进程启动后，关闭了SSH连接，X11连接失败从而出现上述问题。解决方案：</p>
<ul>
<li>使用XShell时关闭X11转发</li>
<li>JVM启动参数配置：<code>-Djava.awt.headless=true </code></li>
<li>使用XShell开启了X11转发，请保持SSH连接不要断开</li>
</ul>
<h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p><a href="https://wizardforcel.gitbooks.io/vbird-linux-basic-4e/content/202.html">什么是 X Window System</a></p>
<p><a href="https://blog.csdn.net/top_explore/article/details/106566455">xshell 执行项目报错 X11 window server</a></p>
<p><a href="https://kb.iu.edu/d/bdnt#interactive">Use X forwarding on a personal computer</a></p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>SSH</tag>
        <tag>X11</tag>
        <tag>XShell</tag>
      </tags>
  </entry>
  <entry>
    <title>代码Review规范指南及实践案例</title>
    <url>/2023/04/24/java/dai-ma-review-gui-fan-zhi-nan-ji-shi-jian-an-li/</url>
    <content><![CDATA[<p>在项目开发过程中发现很多代码的坏味道，针对发现的问题进行分析和解答。本文将从异常处理、日志打印、项目分层、包结构划分、DTO使用、面向接口编程、单元测试等多个维度，提供Code Review的规范指南和实践案例。</p>
<span id="more"></span>

<h1 id="一、异常处理"><a href="#一、异常处理" class="headerlink" title="一、异常处理"></a>一、异常处理</h1><h2 id="1-1-核心问题"><a href="#1-1-核心问题" class="headerlink" title="1.1 核心问题"></a>1.1 核心问题</h2><p>在日常开发中，我们经常面临以下异常处理问题：</p>
<ul>
<li>异常要抛出去还是catch处理？</li>
<li>写代码的过程中是否有主动抛出过异常？  </li>
<li>要抛出什么类型的异常，Exception、Throwable或其它？</li>
</ul>
<h2 id="1-2-异常处理准则"><a href="#1-2-异常处理准则" class="headerlink" title="1.2 异常处理准则"></a>1.2 异常处理准则</h2><div class="note primary no-icon flat"><p><strong>核心原则</strong>：You should catch the exception when you are in the method that knows what to do</p>
</div>

<h3 id="（1）低层级异常处理"><a href="#（1）低层级异常处理" class="headerlink" title="（1）低层级异常处理"></a>（1）低层级异常处理</h3><p><strong>什么是低层级？</strong><br>这是与第三方代码集成的级别，例如ORM工具或任何执行IO操作的库（通过HTTP访问资源、读取文件、保存到数据库等）。也就是说，您离开应用程序的内部代码以与其他组件交互的级别。</p>
<p><strong>处理准则：</strong></p>
<div class="note info no-icon flat"><ol>
<li><strong>只处理特定的异常</strong>，例如SqlTimeoutException或IOException。从不处理一般异常（Exception类型）</li>
<li><strong>仅当您有一些有意义的事情要做时才处理它</strong>，例如重试、触发补偿操作或向异常添加更多数据（例如上下文变量），然后重新抛出它</li>
<li><strong>不要在此处执行日志记录</strong></li>
<li><strong>让所有其他异常冒泡</strong>，因为它们将由高层级处理</li>
</ol>
</div>

<h3 id="（2）高层级异常处理"><a href="#（2）高层级异常处理" class="headerlink" title="（2）高层级异常处理"></a>（2）高层级异常处理</h3><p><strong>什么是高层级？</strong><br>这将是在将异常直接抛给用户之前您可以处理异常的最后一个地方。</p>
<p><strong>处理准则：</strong></p>
<div class="note success no-icon flat"><ol>
<li><strong>处理通用异常类</strong></li>
<li><strong>从当前执行上下文中添加更多信息</strong></li>
<li><strong>记录错误并通知程序员</strong></li>
<li><strong>向用户道歉或提示错误信息</strong></li>
<li><strong>尽快解决</strong></li>
</ol>
</div>

<h3 id="（3）什么时候抛出异常"><a href="#（3）什么时候抛出异常" class="headerlink" title="（3）什么时候抛出异常"></a>（3）什么时候抛出异常</h3><p>在开发库的上下文中更容易理解。当您遇到错误时，您应该抛出错误，除了让您的API的使用者知道并让他们决定之外，您无能为力。</p>
<p>假设您是某个数据访问库的开发人员。当您遇到网络错误时，除了抛出异常之外，您无能为力。从数据访问库的角度来看，这是一个不可逆转的错误。</p>
<h2 id="1-3-准则背后的原理"><a href="#1-3-准则背后的原理" class="headerlink" title="1.3 准则背后的原理"></a>1.3 准则背后的原理</h2><div class="note warning no-icon flat"><ol>
<li><strong>异常代表不可逆转的错误</strong>。它们代表系统中的错误、程序员犯的错误或应用程序无法控制的情况。在这些情况下，用户通常无能为力。</li>
<li><strong>try catch块可以屏蔽应用程序流程</strong>。过度使用会让代码逻辑变得复杂和难以理解。</li>
<li><strong>异常处理应该有层次性</strong>。低层级专注于特定异常的处理，高层级负责统一的异常处理策略。</li>
</ol>
</div>

<h2 id="1-4-项目异常处理方法"><a href="#1-4-项目异常处理方法" class="headerlink" title="1.4 项目异常处理方法"></a>1.4 项目异常处理方法</h2><h3 id="（1）工具类中的异常处理"><a href="#（1）工具类中的异常处理" class="headerlink" title="（1）工具类中的异常处理"></a>（1）工具类中的异常处理</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 推荐做法</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileUtils</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> filePath<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">readString</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 添加上下文信息后重新抛出</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Failed to read file: "</span> <span class="token operator">+</span> filePath<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="（2）Controller的参数校验"><a href="#（2）Controller的参数校验" class="headerlink" title="（2）Controller的参数校验"></a>（2）Controller的参数校验</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 推荐做法</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">&#123;</span>
    
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/users"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Response</span> <span class="token function">createUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Valid</span> <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">UserCreateRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">User</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BusinessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Create user failed: &#123;&#125;"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Unexpected error when creating user"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"系统异常，请稍后重试"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="（3）异常处理的经典案例"><a href="#（3）异常处理的经典案例" class="headerlink" title="（3）异常处理的经典案例"></a>（3）异常处理的经典案例</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 不推荐的做法</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 业务逻辑</span>
        dataService<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 吞掉异常，不做任何处理</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 推荐的做法</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DataProcessException</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        dataService<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">DataAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 转换为业务异常</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DataProcessException</span><span class="token punctuation">(</span><span class="token string">"数据处理失败"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="二、日志打印"><a href="#二、日志打印" class="headerlink" title="二、日志打印"></a>二、日志打印</h1><h2 id="2-1-日志输出准则"><a href="#2-1-日志输出准则" class="headerlink" title="2.1 日志输出准则"></a>2.1 日志输出准则</h2><h3 id="（1）Good-things-to-log"><a href="#（1）Good-things-to-log" class="headerlink" title="（1）Good things to log"></a>（1）Good things to log</h3><div class="note success no-icon flat"><ul>
<li><strong>系统启动和关闭信息</strong></li>
<li><strong>用户的重要操作</strong>（登录、登出、重要数据修改）</li>
<li><strong>外部系统调用</strong>（第三方API、数据库操作）</li>
<li><strong>异常和错误信息</strong></li>
<li><strong>性能关键点的耗时</strong></li>
<li><strong>业务流程的关键节点</strong></li>
</ul>
</div>

<h3 id="（2）记录性能数据"><a href="#（2）记录性能数据" class="headerlink" title="（2）记录性能数据"></a>（2）记录性能数据</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderService</span> <span class="token punctuation">&#123;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processOrder</span><span class="token punctuation">(</span><span class="token class-name">Long</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"开始处理订单，orderId: &#123;&#125;"</span><span class="token punctuation">,</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 业务处理逻辑</span>
            <span class="token function">doProcessOrder</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">long</span> duration <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"订单处理完成，orderId: &#123;&#125;, 耗时: &#123;&#125;ms"</span><span class="token punctuation">,</span> orderId<span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">long</span> duration <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"订单处理失败，orderId: &#123;&#125;, 耗时: &#123;&#125;ms"</span><span class="token punctuation">,</span> orderId<span class="token punctuation">,</span> duration<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="（3）Bad-things-to-log"><a href="#（3）Bad-things-to-log" class="headerlink" title="（3）Bad things to log"></a>（3）Bad things to log</h3><div class="note danger no-icon flat"><ul>
<li><strong>敏感信息</strong>（密码、身份证号、银行卡号等）</li>
<li><strong>过于频繁的日志</strong>（循环中的大量日志）</li>
<li><strong>无意义的日志</strong>（如简单的getter&#x2F;setter调用）</li>
<li><strong>重复的日志信息</strong></li>
<li><strong>调试日志在生产环境中输出</strong></li>
</ul>
</div>

<h2 id="2-2-日志输出案例"><a href="#2-2-日志输出案例" class="headerlink" title="2.2 日志输出案例"></a>2.2 日志输出案例</h2><h3 id="（1）系统入口增加日志记录"><a href="#（1）系统入口增加日志记录" class="headerlink" title="（1）系统入口增加日志记录"></a>（1）系统入口增加日志记录</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApiController</span> <span class="token punctuation">&#123;</span>
    
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/api/data"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Response</span> <span class="token function">processData</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">DataRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> requestId <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"接收到数据处理请求，requestId: &#123;&#125;, request: &#123;&#125;"</span><span class="token punctuation">,</span> requestId<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">DataResponse</span> response <span class="token operator">=</span> dataService<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"数据处理完成，requestId: &#123;&#125;, response: &#123;&#125;"</span><span class="token punctuation">,</span> requestId<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"数据处理失败，requestId: &#123;&#125;"</span><span class="token punctuation">,</span> requestId<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"处理失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="（2）请求第三方或远程接口记录日志"><a href="#（2）请求第三方或远程接口记录日志" class="headerlink" title="（2）请求第三方或远程接口记录日志"></a>（2）请求第三方或远程接口记录日志</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThirdPartyService</span> <span class="token punctuation">&#123;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">ApiResponse</span> <span class="token function">callThirdPartyApi</span><span class="token punctuation">(</span><span class="token class-name">ApiRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"调用第三方API开始，url: &#123;&#125;, request: &#123;&#125;"</span><span class="token punctuation">,</span> apiUrl<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">ApiResponse</span> response <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">postForObject</span><span class="token punctuation">(</span>apiUrl<span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token class-name">ApiResponse</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"调用第三方API成功，url: &#123;&#125;, response: &#123;&#125;"</span><span class="token punctuation">,</span> apiUrl<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> response<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"调用第三方API失败，url: &#123;&#125;, request: &#123;&#125;"</span><span class="token punctuation">,</span> apiUrl<span class="token punctuation">,</span> request<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ThirdPartyApiException</span><span class="token punctuation">(</span><span class="token string">"第三方API调用失败"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="（3）记录系统关键的启动参数"><a href="#（3）记录系统关键的启动参数" class="headerlink" title="（3）记录系统关键的启动参数"></a>（3）记录系统关键的启动参数</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationStartupListener</span> <span class="token keyword">implements</span> <span class="token class-name">ApplicationListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ContextRefreshedEvent</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;app.version&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> appVersion<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;spring.profiles.active&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> activeProfile<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onApplicationEvent</span><span class="token punctuation">(</span><span class="token class-name">ContextRefreshedEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"应用启动完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"应用版本: &#123;&#125;"</span><span class="token punctuation">,</span> appVersion<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"活动配置: &#123;&#125;"</span><span class="token punctuation">,</span> activeProfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"JVM信息: &#123;&#125;"</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"java.version"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"系统时区: &#123;&#125;"</span><span class="token punctuation">,</span> <span class="token class-name">TimeZone</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="三、项目分层"><a href="#三、项目分层" class="headerlink" title="三、项目分层"></a>三、项目分层</h1><h2 id="3-1-项目分层准则"><a href="#3-1-项目分层准则" class="headerlink" title="3.1 项目分层准则"></a>3.1 项目分层准则</h2><div class="note primary no-icon flat"><p><strong>经典三层架构</strong>：</p>
<ul>
<li><strong>Controller层</strong>：接收请求，参数校验，调用Service层</li>
<li><strong>Service层</strong>：业务逻辑处理，事务控制</li>
<li><strong>DAO层</strong>：数据访问，与数据库交互</li>
</ul>
<p><strong>扩展分层</strong>：</p>
<ul>
<li><strong>DTO层</strong>：数据传输对象</li>
<li><strong>Entity层</strong>：实体对象</li>
<li><strong>Utils层</strong>：工具类</li>
<li><strong>Config层</strong>：配置类</li>
</ul>
</div>

<h2 id="3-2-项目案例"><a href="#3-2-项目案例" class="headerlink" title="3.2 项目案例"></a>3.2 项目案例</h2><h3 id="（1）创建短链接口"><a href="#（1）创建短链接口" class="headerlink" title="（1）创建短链接口"></a>（1）创建短链接口</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// Controller层</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/api/shortlink"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShortLinkController</span> <span class="token punctuation">&#123;</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ShortLinkService</span> shortLinkService<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/create"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Response</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ShortLinkDTO</span><span class="token punctuation">></span></span> <span class="token function">createShortLink</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Valid</span> <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">CreateShortLinkRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"创建短链请求: &#123;&#125;"</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ShortLinkDTO</span> result <span class="token operator">=</span> shortLinkService<span class="token punctuation">.</span><span class="token function">createShortLink</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Response</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// Service层</span>
<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShortLinkService</span> <span class="token punctuation">&#123;</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ShortLinkDAO</span> shortLinkDAO<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">ShortLinkDTO</span> <span class="token function">createShortLink</span><span class="token punctuation">(</span><span class="token class-name">CreateShortLinkRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 业务逻辑处理</span>
        <span class="token class-name">String</span> shortCode <span class="token operator">=</span> <span class="token function">generateShortCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">ShortLink</span> shortLink <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShortLink</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        shortLink<span class="token punctuation">.</span><span class="token function">setOriginalUrl</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getOriginalUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        shortLink<span class="token punctuation">.</span><span class="token function">setShortCode</span><span class="token punctuation">(</span>shortCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        shortLink<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        shortLinkDAO<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>shortLink<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> <span class="token function">convertToDTO</span><span class="token punctuation">(</span>shortLink<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">generateShortCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 短码生成逻辑</span>
        <span class="token keyword">return</span> <span class="token class-name">RandomStringUtils</span><span class="token punctuation">.</span><span class="token function">randomAlphanumeric</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// DAO层</span>
<span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShortLinkDAO</span> <span class="token punctuation">&#123;</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token class-name">ShortLink</span> shortLink<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">"INSERT INTO short_link (original_url, short_code, create_time) VALUES (?, ?, ?)"</span><span class="token punctuation">;</span>
        jdbcTemplate<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> shortLink<span class="token punctuation">.</span><span class="token function">getOriginalUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> shortLink<span class="token punctuation">.</span><span class="token function">getShortCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> shortLink<span class="token punctuation">.</span><span class="token function">getCreateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="四、包结构划分"><a href="#四、包结构划分" class="headerlink" title="四、包结构划分"></a>四、包结构划分</h1><h2 id="4-1-包结构划分准则"><a href="#4-1-包结构划分准则" class="headerlink" title="4.1 包结构划分准则"></a>4.1 包结构划分准则</h2><div class="note info no-icon flat"><p><strong>按功能模块划分</strong>：</p>
<pre class="line-numbers language-none"><code class="language-none">com.example.project
├── controller&#x2F;     # 控制器
├── service&#x2F;        # 业务逻辑
├── dao&#x2F;           # 数据访问
├── entity&#x2F;        # 实体类
├── dto&#x2F;           # 数据传输对象
├── config&#x2F;        # 配置类
├── utils&#x2F;         # 工具类
└── exception&#x2F;     # 异常类<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>按业务领域划分</strong>：</p>
<pre class="line-numbers language-none"><code class="language-none">com.example.project
├── user&#x2F;          # 用户模块
│   ├── controller&#x2F;
│   ├── service&#x2F;
│   └── dao&#x2F;
├── order&#x2F;         # 订单模块
│   ├── controller&#x2F;
│   ├── service&#x2F;
│   └── dao&#x2F;
└── common&#x2F;        # 公共模块
    ├── config&#x2F;
    ├── utils&#x2F;
    └── exception&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<h2 id="4-2-包名命名"><a href="#4-2-包名命名" class="headerlink" title="4.2 包名命名"></a>4.2 包名命名</h2><ul>
<li>包名应该使用小写字母</li>
<li>多个单词用点分隔</li>
<li>避免使用下划线或其他特殊字符</li>
<li>包名应该有意义，能够清楚表达包的用途</li>
</ul>
<h2 id="4-3-项目案例"><a href="#4-3-项目案例" class="headerlink" title="4.3 项目案例"></a>4.3 项目案例</h2><h3 id="（1）回调接口提取到单独的包中以做区分"><a href="#（1）回调接口提取到单独的包中以做区分" class="headerlink" title="（1）回调接口提取到单独的包中以做区分"></a>（1）回调接口提取到单独的包中以做区分</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 原有结构</span>
<span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>project<span class="token punctuation">.</span>controller<span class="token punctuation">.</span></span>UserController</span>
<span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>project<span class="token punctuation">.</span>controller<span class="token punctuation">.</span></span>CallbackController</span>

<span class="token comment">// 优化后结构</span>
<span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>project<span class="token punctuation">.</span>controller<span class="token punctuation">.</span></span>UserController</span>
<span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>project<span class="token punctuation">.</span>callback<span class="token punctuation">.</span></span>MessageCallbackController</span>
<span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>project<span class="token punctuation">.</span>callback<span class="token punctuation">.</span></span>PaymentCallbackController</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="（2）使用package-info-java"><a href="#（2）使用package-info-java" class="headerlink" title="（2）使用package-info.java"></a>（2）使用package-info.java</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 回调接口包
 * 
 * 包含所有第三方平台的回调接口实现，包括：
 * - 消息状态回调
 * - 支付状态回调
 * - 审核结果回调
 * 
 * @author development team
 * @version 1.0
 * @since 2024-01-01
 */</span>
<span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>project<span class="token punctuation">.</span>callback</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="（3）Controller根据业务进行分包"><a href="#（3）Controller根据业务进行分包" class="headerlink" title="（3）Controller根据业务进行分包"></a>（3）Controller根据业务进行分包</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 按业务领域分包</span>
<span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>project<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>user<span class="token punctuation">.</span></span>UserController</span>
<span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>project<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>user<span class="token punctuation">.</span></span>UserProfileController</span>
<span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>project<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>order<span class="token punctuation">.</span></span>OrderController</span>
<span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>project<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>order<span class="token punctuation">.</span></span>OrderPaymentController</span>
<span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>project<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>admin<span class="token punctuation">.</span></span>AdminController</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="五、DTO的使用"><a href="#五、DTO的使用" class="headerlink" title="五、DTO的使用"></a>五、DTO的使用</h1><h2 id="5-1-处理准则"><a href="#5-1-处理准则" class="headerlink" title="5.1 处理准则"></a>5.1 处理准则</h2><h3 id="（1）分层领域模型规约（阿里规约）"><a href="#（1）分层领域模型规约（阿里规约）" class="headerlink" title="（1）分层领域模型规约（阿里规约）"></a>（1）分层领域模型规约（阿里规约）</h3><div class="note primary no-icon flat"><ul>
<li><strong>DO (Data Object)</strong>：与数据库表结构一一对应，通过DAO层向上传输数据源对象</li>
<li><strong>DTO (Data Transfer Object)</strong>：数据传输对象，Service或Manager向外传输的对象</li>
<li><strong>BO (Business Object)</strong>：业务对象，由Service层输出的封装业务逻辑的对象</li>
<li><strong>VO (View Object)</strong>：显示层对象，通常是Web向模板渲染引擎层传输的对象</li>
</ul>
</div>

<h3 id="（2）使用DTO的优点"><a href="#（2）使用DTO的优点" class="headerlink" title="（2）使用DTO的优点"></a>（2）使用DTO的优点</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// Entity - 数据库实体</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"user"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>  <span class="token comment">// 敏感信息</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> createTime<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> updateTime<span class="token punctuation">;</span>
    <span class="token comment">// getters and setters</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// DTO - 数据传输对象</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDTO</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> createTime<span class="token punctuation">;</span>  <span class="token comment">// 格式化后的时间</span>
    <span class="token comment">// getters and setters</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// Service层使用</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">&#123;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">UserDTO</span> <span class="token function">getUserById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> userDAO<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">convertToDTO</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 转换时过滤敏感信息</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">private</span> <span class="token class-name">UserDTO</span> <span class="token function">convertToDTO</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">UserDTO</span> dto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dto<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dto<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dto<span class="token punctuation">.</span><span class="token function">setEmail</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dto<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token class-name">DateUtils</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getCreateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 格式化时间</span>
        <span class="token keyword">return</span> dto<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="5-2-推荐案例"><a href="#5-2-推荐案例" class="headerlink" title="5.2 推荐案例"></a>5.2 推荐案例</h2><h3 id="（1）应用平台案例"><a href="#（1）应用平台案例" class="headerlink" title="（1）应用平台案例"></a>（1）应用平台案例</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 请求DTO</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SendMessageRequest</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@NotBlank</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">"接收者不能为空"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> receiver<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@NotBlank</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">"消息内容不能为空"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> content<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token class-name">String</span> messageType<span class="token punctuation">;</span>
    <span class="token comment">// getters and setters</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 响应DTO</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SendMessageResponse</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> messageId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> status<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> timestamp<span class="token punctuation">;</span>
    <span class="token comment">// getters and setters</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 实体类</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Message</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> messageId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> sender<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> receiver<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> content<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> status<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> createTime<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> sendTime<span class="token punctuation">;</span>
    <span class="token comment">// getters and setters</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="六、面向接口编程"><a href="#六、面向接口编程" class="headerlink" title="六、面向接口编程"></a>六、面向接口编程</h1><h2 id="6-1-编码准则"><a href="#6-1-编码准则" class="headerlink" title="6.1 编码准则"></a>6.1 编码准则</h2><h3 id="（1）面向接口编程和面向对象编程"><a href="#（1）面向接口编程和面向对象编程" class="headerlink" title="（1）面向接口编程和面向对象编程"></a>（1）面向接口编程和面向对象编程</h3><div class="note success no-icon flat"><p><strong>面向接口编程的优点</strong>：</p>
<ul>
<li><strong>降低耦合度</strong>：依赖抽象而不是具体实现</li>
<li><strong>提高可测试性</strong>：便于Mock和单元测试</li>
<li><strong>增强可扩展性</strong>：新增实现不影响现有代码</li>
<li><strong>符合开闭原则</strong>：对扩展开放，对修改关闭</li>
</ul>
</div>

<h3 id="（2）接口的本质"><a href="#（2）接口的本质" class="headerlink" title="（2）接口的本质"></a>（2）接口的本质</h3><p>接口定义了一个契约，规定了实现类必须提供的方法。这样可以实现多态，同一个接口可以有多种不同的实现。</p>
<h2 id="6-2-项目案例"><a href="#6-2-项目案例" class="headerlink" title="6.2 项目案例"></a>6.2 项目案例</h2><h3 id="（1）消息接口的返回值"><a href="#（1）消息接口的返回值" class="headerlink" title="（1）消息接口的返回值"></a>（1）消息接口的返回值</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 消息发送接口定义</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MessageSender</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">SendResult</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">SendMessageRequest</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 短信发送实现</span>
<span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span><span class="token string">"smsSender"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SmsSender</span> <span class="token keyword">implements</span> <span class="token class-name">MessageSender</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">SendResult</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">SendMessageRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 短信发送逻辑</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SendResult</span><span class="token punctuation">(</span><span class="token string">"SMS"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"发送成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 邮件发送实现</span>
<span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span><span class="token string">"emailSender"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EmailSender</span> <span class="token keyword">implements</span> <span class="token class-name">MessageSender</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">SendResult</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">SendMessageRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 邮件发送逻辑</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SendResult</span><span class="token punctuation">(</span><span class="token string">"EMAIL"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"发送成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 消息服务</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageService</span> <span class="token punctuation">&#123;</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">"smsSender"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">MessageSender</span> smsSender<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">"emailSender"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">MessageSender</span> emailSender<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">SendResult</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> type<span class="token punctuation">,</span> <span class="token class-name">SendMessageRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">MessageSender</span> sender <span class="token operator">=</span> <span class="token string">"SMS"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token operator">?</span> smsSender <span class="token operator">:</span> emailSender<span class="token punctuation">;</span>
        <span class="token keyword">return</span> sender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="七、单元测试"><a href="#七、单元测试" class="headerlink" title="七、单元测试"></a>七、单元测试</h1><h2 id="7-1-编码准则"><a href="#7-1-编码准则" class="headerlink" title="7.1 编码准则"></a>7.1 编码准则</h2><h3 id="（1）单元测试定义"><a href="#（1）单元测试定义" class="headerlink" title="（1）单元测试定义"></a>（1）单元测试定义</h3><p>单元测试是对软件中的最小可测试单元进行检查和验证的测试方法。在Java中，通常是对类的方法进行测试。</p>
<h3 id="（2）单元测试的优点"><a href="#（2）单元测试的优点" class="headerlink" title="（2）单元测试的优点"></a>（2）单元测试的优点</h3><div class="note success no-icon flat"><ul>
<li><strong>提高代码质量</strong>：强制思考边界条件和异常情况</li>
<li><strong>便于重构</strong>：为代码重构提供安全网</li>
<li><strong>文档作用</strong>：单元测试本身就是最好的使用文档</li>
<li><strong>提高开发效率</strong>：快速验证代码修改是否正确</li>
<li><strong>降低维护成本</strong>：及早发现问题，降低修复成本</li>
</ul>
</div>

<h3 id="（3）单元测试如何进行"><a href="#（3）单元测试如何进行" class="headerlink" title="（3）单元测试如何进行"></a>（3）单元测试如何进行</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 被测试的服务类</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">&#123;</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserDAO</span> userDAO<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">CreateUserRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"用户名不能为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userDAO<span class="token punctuation">.</span><span class="token function">existsByUsername</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token string">"用户名已存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setEmail</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> userDAO<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 单元测试</span>
<span class="token annotation punctuation">@ExtendWith</span><span class="token punctuation">(</span><span class="token class-name">MockitoExtension</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">UserServiceTest</span> <span class="token punctuation">&#123;</span>
    
    <span class="token annotation punctuation">@Mock</span>
    <span class="token keyword">private</span> <span class="token class-name">UserDAO</span> userDAO<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@InjectMocks</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">createUser_Success</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Given</span>
        <span class="token class-name">CreateUserRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateUserRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"testuser"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">setEmail</span><span class="token punctuation">(</span><span class="token string">"test@example.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">User</span> savedUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        savedUser<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        savedUser<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"testuser"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        savedUser<span class="token punctuation">.</span><span class="token function">setEmail</span><span class="token punctuation">(</span><span class="token string">"test@example.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token function">when</span><span class="token punctuation">(</span>userDAO<span class="token punctuation">.</span><span class="token function">existsByUsername</span><span class="token punctuation">(</span><span class="token string">"testuser"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">when</span><span class="token punctuation">(</span>userDAO<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span>savedUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// When &amp; Then</span>
        <span class="token function">assertThatThrownBy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> userService<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">isInstanceOf</span><span class="token punctuation">(</span><span class="token class-name">BusinessException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">hasMessage</span><span class="token punctuation">(</span><span class="token string">"用户名已存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token function">verify</span><span class="token punctuation">(</span>userDAO<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">existsByUsername</span><span class="token punctuation">(</span><span class="token string">"existinguser"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">verify</span><span class="token punctuation">(</span>userDAO<span class="token punctuation">,</span> <span class="token function">never</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="7-2-项目案例分析"><a href="#7-2-项目案例分析" class="headerlink" title="7.2 项目案例分析"></a>7.2 项目案例分析</h2><h3 id="（1）数据回调逻辑单元测试"><a href="#（1）数据回调逻辑单元测试" class="headerlink" title="（1）数据回调逻辑单元测试"></a>（1）数据回调逻辑单元测试</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 被测试的回调处理类</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataCallbackService</span> <span class="token punctuation">&#123;</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DataService</span> dataService<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">NotificationService</span> notificationService<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleCallback</span><span class="token punctuation">(</span><span class="token class-name">DataCallbackRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>request <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getDataId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"回调参数不能为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token class-name">DataEntity</span> data <span class="token operator">=</span> dataService<span class="token punctuation">.</span><span class="token function">getDataById</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getDataId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token string">"数据不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token comment">// 更新数据状态</span>
        data<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span><span class="token function">setUpdateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataService<span class="token punctuation">.</span><span class="token function">updateData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 发送通知</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"APPROVED"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            notificationService<span class="token punctuation">.</span><span class="token function">sendApprovalNotification</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 单元测试</span>
<span class="token annotation punctuation">@ExtendWith</span><span class="token punctuation">(</span><span class="token class-name">MockitoExtension</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">DataCallbackServiceTest</span> <span class="token punctuation">&#123;</span>
    
    <span class="token annotation punctuation">@Mock</span>
    <span class="token keyword">private</span> <span class="token class-name">DataService</span> dataService<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Mock</span>
    <span class="token keyword">private</span> <span class="token class-name">NotificationService</span> notificationService<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@InjectMocks</span>
    <span class="token keyword">private</span> <span class="token class-name">DataCallbackService</span> callbackService<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">handleCallback_Success</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Given</span>
        <span class="token class-name">DataCallbackRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataCallbackRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">setDataId</span><span class="token punctuation">(</span><span class="token string">"data123"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">"APPROVED"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">DataEntity</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token string">"data123"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token string">"user456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">"PENDING"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token function">when</span><span class="token punctuation">(</span>dataService<span class="token punctuation">.</span><span class="token function">getDataById</span><span class="token punctuation">(</span><span class="token string">"data123"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// When</span>
        callbackService<span class="token punctuation">.</span><span class="token function">handleCallback</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// Then</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token string">"APPROVED"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertThat</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getUpdateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isNotNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token function">verify</span><span class="token punctuation">(</span>dataService<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDataById</span><span class="token punctuation">(</span><span class="token string">"data123"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">verify</span><span class="token punctuation">(</span>dataService<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">updateData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">verify</span><span class="token punctuation">(</span>notificationService<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendApprovalNotification</span><span class="token punctuation">(</span><span class="token string">"user456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">handleCallback_ThrowException_WhenRequestIsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// When &amp; Then</span>
        <span class="token function">assertThatThrownBy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> callbackService<span class="token punctuation">.</span><span class="token function">handleCallback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">isInstanceOf</span><span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">hasMessage</span><span class="token punctuation">(</span><span class="token string">"回调参数不能为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token function">verify</span><span class="token punctuation">(</span>dataService<span class="token punctuation">,</span> <span class="token function">never</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDataById</span><span class="token punctuation">(</span><span class="token function">anyString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">verify</span><span class="token punctuation">(</span>dataService<span class="token punctuation">,</span> <span class="token function">never</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">updateData</span><span class="token punctuation">(</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token class-name">DataEntity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">verify</span><span class="token punctuation">(</span>notificationService<span class="token punctuation">,</span> <span class="token function">never</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendApprovalNotification</span><span class="token punctuation">(</span><span class="token function">anyString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="八、常见代码坏味道"><a href="#八、常见代码坏味道" class="headerlink" title="八、常见代码坏味道"></a>八、常见代码坏味道</h1><h2 id="8-1-过长函数"><a href="#8-1-过长函数" class="headerlink" title="8.1 过长函数"></a>8.1 过长函数</h2><h3 id="（1）代码的可读性"><a href="#（1）代码的可读性" class="headerlink" title="（1）代码的可读性"></a>（1）代码的可读性</h3><div class="note warning no-icon flat"><p><strong>函数过长的问题</strong>：</p>
<ul>
<li>难以理解和维护</li>
<li>违反单一职责原则</li>
<li>难以进行单元测试</li>
<li>容易产生重复代码</li>
</ul>
</div>

<h3 id="（2）编码准则"><a href="#（2）编码准则" class="headerlink" title="（2）编码准则"></a>（2）编码准则</h3><ul>
<li>函数应该尽可能短小，通常不超过20-30行</li>
<li>一个函数只做一件事情</li>
<li>如果函数需要注释来说明不同部分的功能，考虑拆分</li>
<li>使用有意义的函数名</li>
</ul>
<h3 id="（3）如何把函数变小"><a href="#（3）如何把函数变小" class="headerlink" title="（3）如何把函数变小"></a>（3）如何把函数变小</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 重构前：过长的函数</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processOrder</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 验证订单</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>order <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"订单不能为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"订单ID不能为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// 检查库存</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">OrderItem</span> item <span class="token operator">:</span> order<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Product</span> product <span class="token operator">=</span> productService<span class="token punctuation">.</span><span class="token function">getProduct</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getProductId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>product<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> item<span class="token punctuation">.</span><span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token string">"库存不足"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// 计算价格</span>
    <span class="token class-name">BigDecimal</span> totalPrice <span class="token operator">=</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">OrderItem</span> item <span class="token operator">:</span> order<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">BigDecimal</span> itemPrice <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        totalPrice <span class="token operator">=</span> totalPrice<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>itemPrice<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// 扣减库存</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">OrderItem</span> item <span class="token operator">:</span> order<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        productService<span class="token punctuation">.</span><span class="token function">reduceStock</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getProductId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> item<span class="token punctuation">.</span><span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// 创建订单记录</span>
    order<span class="token punctuation">.</span><span class="token function">setTotalPrice</span><span class="token punctuation">(</span>totalPrice<span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">"CREATED"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderDAO<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 重构后：拆分为多个小函数</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processOrder</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">validateOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">checkStock</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BigDecimal</span> totalPrice <span class="token operator">=</span> <span class="token function">calculateTotalPrice</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">reduceStock</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">createOrderRecord</span><span class="token punctuation">(</span>order<span class="token punctuation">,</span> totalPrice<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">validateOrder</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>order <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"订单不能为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"订单ID不能为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkStock</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">OrderItem</span> item <span class="token operator">:</span> order<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Product</span> product <span class="token operator">=</span> productService<span class="token punctuation">.</span><span class="token function">getProduct</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getProductId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>product<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> item<span class="token punctuation">.</span><span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token string">"库存不足"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> <span class="token function">calculateTotalPrice</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> order<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">-></span> item<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token constant">ZERO</span><span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span><span class="token operator">::</span><span class="token function">add</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">reduceStock</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    order<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">-></span> 
        productService<span class="token punctuation">.</span><span class="token function">reduceStock</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getProductId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> item<span class="token punctuation">.</span><span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">createOrderRecord</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span> totalPrice<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    order<span class="token punctuation">.</span><span class="token function">setTotalPrice</span><span class="token punctuation">(</span>totalPrice<span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    order<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">"CREATED"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    orderDAO<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="8-2-过大的类"><a href="#8-2-过大的类" class="headerlink" title="8.2 过大的类"></a>8.2 过大的类</h2><h3 id="（1）项目案例"><a href="#（1）项目案例" class="headerlink" title="（1）项目案例"></a>（1）项目案例</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 重构前：职责过多的类</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserManager</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 用户CRUD操作</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* */</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateUser</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* */</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteUser</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* */</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* */</span> <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// 用户认证</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* */</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">generateToken</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* */</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">validateToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* */</span> <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// 用户权限管理</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">assignRole</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> role<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* */</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">removeRole</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> role<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* */</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getUserRoles</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* */</span> <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// 用户通知</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendWelcomeEmail</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* */</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendPasswordResetEmail</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* */</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendNotification</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* */</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 重构后：按职责拆分为多个类</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* */</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateUser</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* */</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteUser</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* */</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* */</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthenticationService</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* */</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">generateToken</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* */</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">validateToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* */</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserRoleService</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">assignRole</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> role<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* */</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">removeRole</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> role<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* */</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getUserRoles</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* */</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserNotificationService</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendWelcomeEmail</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* */</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendPasswordResetEmail</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* */</span> <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendNotification</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* */</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="九、总结"><a href="#九、总结" class="headerlink" title="九、总结"></a>九、总结</h1><h2 id="9-1-Code-Review关键点"><a href="#9-1-Code-Review关键点" class="headerlink" title="9.1 Code Review关键点"></a>9.1 Code Review关键点</h2><div class="note primary no-icon flat"><p><strong>异常处理</strong>：</p>
<ul>
<li>明确异常处理的层次和职责</li>
<li>避免吞掉异常或过度捕获</li>
<li>提供有意义的异常信息</li>
</ul>
<p><strong>日志打印</strong>：</p>
<ul>
<li>记录关键业务流程和性能数据</li>
<li>避免记录敏感信息和无意义日志</li>
<li>使用合适的日志级别</li>
</ul>
<p><strong>代码结构</strong>：</p>
<ul>
<li>保持清晰的分层架构</li>
<li>合理划分包结构</li>
<li>使用DTO进行数据传输</li>
<li>面向接口编程</li>
</ul>
<p><strong>代码质量</strong>：</p>
<ul>
<li>编写单元测试</li>
<li>避免过长函数和过大类</li>
<li>遵循单一职责原则</li>
<li>保持代码简洁和可读性</li>
</ul>
</div>

<h2 id="9-2-最佳实践建议"><a href="#9-2-最佳实践建议" class="headerlink" title="9.2 最佳实践建议"></a>9.2 最佳实践建议</h2><ol>
<li><strong>建立Code Review文化</strong>：让Code Review成为开发流程的必要环节</li>
<li><strong>制定编码规范</strong>：团队统一的编码标准和最佳实践</li>
<li><strong>使用工具辅助</strong>：集成静态代码分析工具</li>
<li><strong>持续学习改进</strong>：定期回顾和总结Code Review中发现的问题</li>
<li><strong>注重代码可读性</strong>：代码是给人读的，不仅仅是给机器执行的</li>
</ol>
<p>通过规范的Code Review流程和标准，可以显著提高代码质量，减少生产环境问题，提升团队整体的开发水平。<br>        User result &#x3D; userService.createUser(request);</p>
<pre><code>    // Then
    assertThat(result).isNotNull();
    assertThat(result.getId()).isEqualTo(1L);
    assertThat(result.getUsername()).isEqualTo(&quot;testuser&quot;);
    
    verify(userDAO).existsByUsername(&quot;testuser&quot;);
    verify(userDAO).save(any(User.class));
&#125;

@Test
void createUser_ThrowException_WhenUsernameIsBlank() &#123;
    // Given
    CreateUserRequest request = new CreateUserRequest();
    request.setUsername(&quot;&quot;);
    
    // When &amp; Then
    assertThatThrownBy(() -&gt; userService.createUser(request))
        .isInstanceOf(IllegalArgumentException.class)
        .hasMessage(&quot;用户名不能为空&quot;);
    
    verify(userDAO, never()).existsByUsername(anyString());
    verify(userDAO, never()).save(any(User.class));
&#125;

@Test
void createUser_ThrowException_WhenUsernameExists() &#123;
    // Given
    CreateUserRequest request = new CreateUserRequest();
    request.setUsername(&quot;existinguser&quot;);
    
    when(userDAO.existsByUsername(&quot;existinguser&quot;)).thenReturn(true);
    
    // When
</code></pre>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>代码规范</tag>
        <tag>Code Review</tag>
        <tag>异常处理</tag>
        <tag>日志打印</tag>
        <tag>项目分层</tag>
        <tag>单元测试</tag>
      </tags>
  </entry>
  <entry>
    <title>浅谈“伪共享”问题</title>
    <url>/2022/01/20/java/qian-tan-wei-gong-xiang-wen-ti/</url>
    <content><![CDATA[<blockquote>
<p>非原创，转载于：<a href="https://www.liuyj.top/false_sharing.html">https://www.liuyj.top/false_sharing.html</a></p>
</blockquote>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>学习的过程中遇到了一个名词——伪共享，出于对知识的兴趣，上网查阅了一些博文，研究了伪共享的问题，写此文章总结记录。</p>
<p>要很好的理解伪共享问题，我们要先从CPU的缓存开始说起。</p>
<h2 id="CPU缓存架构"><a href="#CPU缓存架构" class="headerlink" title="CPU缓存架构"></a>CPU缓存架构</h2><p>CPU 是计算机的心脏，所有运算和程序最终都要由它来执行。</p>
<p>主内存（RAM）是数据存放的地方，CPU 和主内存之间有好几级缓存，因为即使直接访问主内存也是非常慢的。</p>
<p><img src="/2022/01/20/java/qian-tan-wei-gong-xiang-wen-ti/%E7%BC%93%E5%AD%98%E6%9E%B6%E6%9E%84.png" alt="缓存架构"></p>
<p>如果对一块数据做相同的运算多次，那么在执行运算的时候把它加载到离 CPU 很近的地方就有意义了，比如一个循环计数，你不想每次循环都跑到主内存去取这个数据来增长它吧。</p>
<p>再对缓存的概念做一些说明：</p>
<blockquote>
<p>越靠近 CPU 的缓存越快也越小。<br>所以 L1 缓存很小但很快，并且紧靠着在使用它的 CPU 内核。<br>L2 大一些，也慢一些，并且仍然只能被一个单独的 CPU 核使用。<br>L3 在现代多核机器中更普遍，仍然更大，更慢，并且被<code>单个插槽上的所有 CPU 核共享</code>。<br>最后，主存保存着程序运行的所有数据，它更大，更慢，由<code>全部插槽上的所有 CPU 核共享</code>。</p>
</blockquote>
<p>当 CPU 执行运算的时候，它先去 L1 查找所需的数据，再去 L2，然后是 L3，最后如果这些缓存中都没有，所需的数据就要去主内存拿。</p>
<p>走得越远，运算耗费的时间就越长。</p>
<p>所以如果进行一些很频繁的运算，要确保数据在 L1 缓存中。</p>
<h2 id="CPU缓存行"><a href="#CPU缓存行" class="headerlink" title="CPU缓存行"></a>CPU缓存行</h2><p>缓存是由缓存行组成的，通常是 64 字节（常用处理器的缓存行是 64 字节的，比较旧的处理器缓存行是 32 字节），并且它有效地引用主内存中的一块地址。</p>
<p>一个 Java 的 long 类型是 8 字节，因此在一个缓存行中可以存 8 个 long 类型的变量。</p>
<p><img src="/2022/01/20/java/qian-tan-wei-gong-xiang-wen-ti/cpu%E7%BC%93%E5%AD%98%E8%A1%8C.png" alt="cpu缓存行"></p>
<p>在程序运行的过程中，缓存每次更新都从主内存中加载连续的 64 个字节。因此，如果访问一个 long 类型的数组时，当数组中的一个值被加载到缓存中时，另外 7 个元素也会被加载到缓存中。</p>
<p>但是，如果使用的数据结构中的项在内存中不是彼此相邻的，比如链表，那么将得不到免费缓存加载带来的好处。</p>
<p>不过，这种免费加载也有一个坏处。设想如果我们有个 long 类型的变量 a，它不是数组的一部分，而是一个单独的变量，并且还有另外一个 long 类型的变量 b 紧挨着它，那么当加载 a 的时候将免费加载 b。</p>
<p>看起来似乎没有什么毛病，但是如果一个 CPU 核心的线程在对 a 进行修改，另一个 CPU 核心的线程却在对 b 进行读取。</p>
<p>当前者修改 a 时，会把 a 和 b 同时加载到前者核心的缓存行中，更新完 a 后其它所有包含 a 的缓存行都将失效，因为其它缓存中的 a 不是最新值了。</p>
<p>而当后者读取 b 时，发现这个缓存行已经失效了，需要从主内存中重新加载。</p>
<p>请记住，我们的缓存都是以缓存行作为一个单位来处理的，所以失效 a 的缓存的同时，也会把 b 失效，反之亦然。</p>
<p><img src="/2022/01/20/java/qian-tan-wei-gong-xiang-wen-ti/cpu%E7%BC%93%E5%AD%98%E8%A1%8C-1.png" alt="cpu缓存行-1"></p>
<p>这样就出现了一个问题，b 和 a 完全不相干，每次却要因为 a 的更新需要从主内存重新读取，它被缓存未命中给拖慢了。</p>
<p>这就是传说中的<code>伪共享</code>。</p>
<h2 id="何为伪共享（False-Sharing）"><a href="#何为伪共享（False-Sharing）" class="headerlink" title="何为伪共享（False Sharing）"></a>何为伪共享（False Sharing）</h2><p>从上面我们的原理讲解中，对<code>伪共享</code>有了理性的认识。</p>
<p>这里我们先给<code>伪共享</code>下个定义：</p>
<blockquote>
<p>当多线程修改互相独立的变量时，如果这些变量共享同一个缓存行，就会无意中影响彼此的性能，这就是伪共享。</p>
</blockquote>
<p>我们从一个例子来看”伪共享”产生的作用：</p>
<pre class="line-numbers language-none"><code class="language-none">public class FalseSharingTest &#123;  
    public static void main(String[] args) throws InterruptedException &#123;  
        testPointer(new Pointer());  
    &#125;  

    private static void testPointer(Pointer pointer) throws InterruptedException &#123;  
        long start &#x3D; System.currentTimeMillis();  
        Thread t1 &#x3D; new Thread(() -&gt; &#123;  
            for (int i &#x3D; 0; i &lt; 100000000; i++) &#123;  
                pointer.x++;  
            &#125;  
        &#125;);  
        Thread t2 &#x3D; new Thread(() -&gt; &#123;  
            for (int i &#x3D; 0; i &lt; 100000000; i++) &#123;  
                pointer.y++;  
            &#125;  
        &#125;);  
        tstart();  
        tstart();  
        tjoin();  
        tjoin();  
        System.out.println(System.currentTimeMillis() - start);  
        System.out.println(&quot;x: &quot;+pointer.x);  
        System.out.println(&quot;y: &quot;+pointer.y);  
    &#125;  
&#125;  

class Pointer &#123;  
    volatile long x;  
    volatile long y;  
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们声明了一个 Pointer 的类，它包含 x 和 y 两个变量（必须声明为volatile，保证可见性），一个线程对 x 进行自增1亿次，一个线程对 y 进行自增1亿次。</p>
<p>可以看到，x 和 y 完全没有任何关系，但是更新 x 的时候会把其它包含 x 的缓存行失效，同时也就失效了 y，运行这段程序输出的时间为 <code>3458ms</code>。</p>
<p>运行结果：</p>
<pre class="line-numbers language-none"><code class="language-none">3458  
x: 100000000  
y: 100000000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>运行了多次，结果都是在3000ms左右。</p>
<p>虽然从这个时间上我们好像看不出来有什么伪共享的问题，无非可能有点慢而已，但我们没有别的证据。别急，我们下面会有答案的。</p>
<h2 id="避免伪共享"><a href="#避免伪共享" class="headerlink" title="避免伪共享"></a>避免伪共享</h2><p>伪共享的原理我们知道了，一个缓存行是 64 个字节，一个 long 类型是 8 个字节，所以避免伪共享也很简单，大概有以下三种方式。</p>
<h2 id="方法一-填充-Padding"><a href="#方法一-填充-Padding" class="headerlink" title="方法一 填充(Padding)"></a>方法一 填充(Padding)</h2><p>顾名思义，填充的思想就是在两个变量之间填充到64个字节，把第二个变量挤到下一个缓存行。</p>
<p>我们的例子中在两个 long 类型的变量之间再加 7 个 long 类型，把Pointer改成下面的结构之后：</p>
<pre class="line-numbers language-none"><code class="language-none">class Pointer &#123;  
    volatile long x;  
    long p1, p2, p3, p4, p5, p6, p7;  
    volatile long y;  
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>发现时间神奇的缩短了4分之一，多次试验，大概都在800ms左右：</p>
<pre class="line-numbers language-none"><code class="language-none">720  
x: 100000000  
y: 100000000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>这个结果也充分证明了<code>伪共享</code>的存在。</p>
<p><code>注意</code>：在考虑使用填充之前，必须要了解的一点是JVM可能会清除无用字段或重排无用字段的位置，这样的话，可能无形中又会引入伪共享。我们也没有办法指定对象在堆内驻留的位置。</p>
<h2 id="方法二-自己创建对象"><a href="#方法二-自己创建对象" class="headerlink" title="方法二 自己创建对象"></a>方法二 自己创建对象</h2><p>我们尝试使用另外一种方式，我们重新创建自己的long类型，而不是Java自带的long：</p>
<pre class="line-numbers language-none"><code class="language-none">class Pointer &#123;  
    MyLong x&#x3D;new MyLong();  
    MyLong y&#x3D;new MyLong();  
&#125;  

class MyLong&#123;  
    volatile long value;  
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同时把 <code>pointer.x++;</code> 修改为 <code>pointer.x.value++;</code>，把 <code>pointer.y++;</code> 修改为 <code>pointer.y.value++;</code>，再次运行程序发现时间是 <code>752ms</code>。<br>可以看到也解决了伪共享问题。</p>
<h2 id="方法三-使用-sun-misc-Contended-注解（java8）"><a href="#方法三-使用-sun-misc-Contended-注解（java8）" class="headerlink" title="方法三 使用 @sun.misc.Contended 注解（java8）"></a>方法三 使用 @sun.misc.Contended 注解（java8）</h2><p>除了对字段进行填充之外，还有一个比较清爽的方法，那就是对需要避免陷入伪共享的字段进行注解，这个注解暗示JVM应当将字段放入不同的缓存行。</p>
<p>如下添加@Contended注解：</p>
<pre class="line-numbers language-none"><code class="language-none">import sun.misc.Contended;  
class Pointer &#123;  
   @Contended  
   volatile long x;  

   volatile long y;  
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>默认使用这个注解是无效的，需要在JVM启动参数加上 <code>-XX:-RestrictContended</code>才会生效：</p>
<p>再次运行程序发现时间是 749ms：</p>
<pre class="line-numbers language-none"><code class="language-none">749  
x: 100000000  
y: 100000000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>说明：引入了<code>@Contented</code>注解，被这个注解修饰的字段应当和其他的字段驻留在不同的位置。上面的代码将x和y置于不同的缓存行。@Contented注解将y移动到远离对象头部的地方，(以避免和x一起被加载到同一个缓存行)。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><blockquote>
<p>杂谈 什么是伪共享（false sharing）？ （注：这篇文章中的避免伪共享的方案中的代码及解释有误，本文已纠正）<br>Java8中@Contended和伪共享</p>
</blockquote>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>（1）CPU具有多级缓存，越接近CPU的缓存越小也越快；</p>
<p>（2）CPU缓存中的数据是以缓存行为单位处理的；</p>
<p>（3）CPU缓存行能带来免费加载数据的好处，所以处理数组性能非常高；</p>
<p>（4）CPU缓存行也带来了弊端，多线程处理不相干的变量时会相互影响，也就是伪共享；</p>
<p>（5）避免伪共享的主要思路就是让不相干的变量不要出现在同一个缓存行中，常见的有填充、创建自己的变量、使用注解三种方式避免伪共享。</p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>伪共享</tag>
      </tags>
  </entry>
  <entry>
    <title>海量业务数据加解密方案的落地与实践</title>
    <url>/2024/12/08/java/hai-liang-ye-wu-shu-ju-jia-jie-mi-fang-an-de-luo-di-yu-shi-jian/</url>
    <content><![CDATA[<h1 id="一、背景简介"><a href="#一、背景简介" class="headerlink" title="一、背景简介"></a>一、背景简介</h1><p>根据数据安全规范与标准及企业合法合规运营，业务系统需要对海量的业务数据进行加密，保护数据的安全。</p>
<h2 id="1-1-业务数据的安全性要求"><a href="#1-1-业务数据的安全性要求" class="headerlink" title="1.1 业务数据的安全性要求"></a>1.1 业务数据的安全性要求</h2><ul>
<li>敏感业务数据需要加密存储</li>
<li>数据查询需要进行解密</li>
<li>加密数据的密钥支持定期轮换</li>
</ul>
<h1 id="二、方案预研"><a href="#二、方案预研" class="headerlink" title="二、方案预研"></a>二、方案预研</h1><p>对于上述业务数据的加密要求，一般采用加密性能较高的对称加密算法，如：AES、国密SM4等。系统的数据加解密及密钥的管理及定期轮换，行业内一般是采用密钥管理服务（Key Management Service，简称KMS）来解决，下面我们就预研一下KMS的使用。</p>
<h2 id="2-1-密钥管理服务KMS"><a href="#2-1-密钥管理服务KMS" class="headerlink" title="2.1 密钥管理服务KMS"></a>2.1 密钥管理服务KMS</h2><p>密钥管理，即密钥管理服务（Key Management Service，KMS），是一种安全、可靠、简单易用的密钥托管服务，帮助您轻松创建和管理密钥，保护密钥的安全。</p>
<p>KMS通过使用硬件安全模块HSM（Hardware Security Module）保护密钥的安全，所有的用户密钥都由HSM中的根密钥保护，避免密钥泄露。</p>
<p>KMS对密钥的所有操作都会进行访问控制及日志跟踪，提供所有密钥的使用记录，满足审计和合规性要求。</p>
<h2 id="2-2-KMS服务选型"><a href="#2-2-KMS服务选型" class="headerlink" title="2.2 KMS服务选型"></a>2.2 KMS服务选型</h2><p>密钥管理服务使用硬件安全模块HSM（Hardware Security Module）保护密钥的安全，企业内部如果是要自己搭建密钥管理服务，则需要采购专业的硬件设备进行搭建。对于没有专业的安全团队的公司，选择云厂商提供的KMS服务是一个更加高效便捷的途径。</p>
<p>目前提供KMS云服务能力的厂商：</p>
<ul>
<li><a href="https://www.aliyun.com/product/kms">阿里云KMS</a></li>
<li><a href="https://www.huaweicloud.com/product/dew.html?utm_source=3.baidu.com&utm_medium=organic&utm_adplace=kapian">华为云DEW</a></li>
<li><a href="https://cloud.tencent.com/product/kms">腾讯云KMS</a></li>
<li><a href="https://aws.amazon.com/cn/kms/">亚马逊KMS</a></li>
<li><a href="https://cloud.google.com/kms/docs/key-management-service?hl=zh-cn">谷歌KMS</a></li>
</ul>
<p>上述云厂商提供的KMS服务能力基本相同，介于企业内部使用华为云，本文主要介绍基于华为云KMS的海量业务数据加密场景的落地。</p>
<h1 id="三、华为云KMS简介"><a href="#三、华为云KMS简介" class="headerlink" title="三、华为云KMS简介"></a>三、华为云KMS简介</h1><p>华为云提供统一管理密钥、敏感数据加密、华为云服务加密、数据数字签名、安全合规(PCI-DSS、等保等)等能力。</p>
<h2 id="3-1-功能总览"><a href="#3-1-功能总览" class="headerlink" title="3.1 功能总览"></a>3.1 功能总览</h2><table>
<thead>
<tr>
<th>功能</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>密钥管理</td>
<td>密钥管理，即密钥管理服务（Key Management Service，KMS），是一种安全、可靠、简单易用的密钥托管服务，帮助您轻松创建和管理密钥，保护密钥的安全。 <br>KMS通过使用硬件安全模块HSM（Hardware Security Module）保护密钥的安全，所有的用户密钥都由HSM中的根密钥保护，避免密钥泄露。</td>
</tr>
<tr>
<td>创建密钥</td>
<td>用户主密钥有密钥元数据（密钥ID、密钥别名、描述、密钥状态与创建日期）和用于加解密数据的密钥材料。 <br> 用户可以使用控制台创建密钥，该密钥会自动生成密钥材料。</td>
</tr>
<tr>
<td>密钥全生命周期管理</td>
<td>用户可以通过密钥管理界面，对用户主密钥进行全生命周期管理。（启用、禁用、删除）</td>
</tr>
<tr>
<td>数据加解密</td>
<td>当有少量数据（例如：口令、证书、电话号码等）需要加解密时，用户可以通过密钥管理服务（Key Management Service，KMS）界面使用在线工具加解密数据，或者调用KMS的API接口使用指定的用户主密钥直接加密、解密数据。 <br> 当有大量数据（例如：照片、视频或者数据库文件等）需要加解密时，用户可采用<font color="red">信封加密</font>方式加解密数据，无需通过网络传输大量数据即可完成数据加解密。</td>
</tr>
<tr>
<td>密钥轮换</td>
<td>广泛重复的使用加密密钥，会对加密密钥的安全造成风险。为了确保加密密钥的安全性，建议您定期轮换密钥，更改原密钥的密钥材料。 <br> 开通密钥轮转后，会收取相应的密钥存储费用，每个轮转的版本将作为一个独立的主密钥资源进行计算。</td>
</tr>
<tr>
<td>专属密钥库</td>
<td>KMS通过专属密钥库支持HYOK功能，帮助用户完全自主可控名下的用户主密钥，用户主密钥不脱离加密机，并且密码运算完全在加密机中完成。 <br> 说明：在外部密钥存储中使用 KMS 密钥的加密和解密操作，由您的外部密钥管理器使用加密密钥材料执行，该功能称为持有自己的密钥（HYOK）。</td>
</tr>
<tr>
<td>签名验签</td>
<td>签名验签是一种加密机制，是保证数据传输安全性以及完整性的重要手段。<br> 通过签名验签的方式，可以防止信息在传输过程中被篡改或伪造。</td>
</tr>
<tr>
<td>密钥授权</td>
<td>用户可以为其他IAM用户或账号创建授权，授予其使用自身的自定义密钥的权限。被授权用户可以通过调用API接口，即可使用被授权的权限。 <br> 以下两种情况下，授权用户可以通过密钥管理界面撤销授权：<br>  · 当被授权用户不再使用授权用户的自定义密钥时，被授权用户可告知授权用户撤销授权，或者通过API接口直接退役授权。 <br> ·  当授权用户想收回自定义密钥的操作权限时，授权用户可强制撤销授权。</td>
</tr>
<tr>
<td>密钥区域性</td>
<td>KMS通过密钥区域性，实现密钥跨区域使用。每组用户主密钥与副本密钥具有相同的密钥材料，即可以实现在不同区域的密钥共享。<br>  · 创建副本密钥 <br> · 使用副本密钥</td>
</tr>
</tbody></table>
<h2 id="3-2-信封加密术语说明（谷歌KMS）"><a href="#3-2-信封加密术语说明（谷歌KMS）" class="headerlink" title="3.2 信封加密术语说明（谷歌KMS）"></a>3.2 信封加密术语说明（<a href="https://cloud.google.com/kms/docs/envelope-encryption?hl=zh-cn">谷歌KMS</a>）</h2><p>对于海量的业务数据加解密场景，采用信封加密的方式对业务进行加密，下面我们介绍一下何为信封加密。</p>
<div class="note success no-icon flat"><h3 id="数据加密密钥（DEK）"><a href="#数据加密密钥（DEK）" class="headerlink" title="数据加密密钥（DEK）"></a>数据加密密钥（DEK）</h3><p>用于加密数据密钥本身称为数据加密密钥 (Data Encryption Key， 简称DEK)。<br>以下是管理 DEK 的最佳做法：</p>
<ul>
<li>在本地生成 DEK。</li>
<li>存储时，始终确保 DEK 进行静态加密。</li>
<li>为便于访问，<strong>请将 DEK 存储在用其进行加密的数据附近</strong>。</li>
<li>每次写入数据时均生成一个新的 DEK。这意味着您无需轮替 DEK。</li>
<li>请勿使用相同的 DEK 来加密来自两个不同用户的数据。</li>
<li>在伽罗瓦计数器模式 (GCM) 中使用强大的算法（如 256 位高级加密标准 (AES)）。</li>
</ul>
</div>

<div class="note success no-icon flat"><h3 id="密钥加密密钥（KEK）"><a href="#密钥加密密钥（KEK）" class="headerlink" title="密钥加密密钥（KEK）"></a>密钥加密密钥（KEK）</h3><p>DEK 使用“密钥加密密钥”(Key Encryption Key， 简称KEK) 进行加密（也称为“封装”）。 用另一个密钥对密钥进行加密的过程称为“信封加密”。<br><em><strong>说明： KEK是谷歌的命名方式，华为云的命名是CMK（Customer Master Key），是同一个概念。</strong></em><br>以下是管理 DEK 的最佳做法：</p>
<ul>
<li>集中存储 KEK。</li>
<li>根据用例加密设置 KEK 加密的 DEK 的粒度。例如，考虑需要多个 DEK 来加密其数据区块的工作负载。您可以使用单个 KEK 来封装负责该工作负载加密的所有 DEK。</li>
<li>定期或可疑事件发生后轮替密钥。</li>
</ul>
</div>

<div class="note success no-icon flat"><h3 id="平衡-DEK-和-KEK"><a href="#平衡-DEK-和-KEK" class="headerlink" title="平衡 DEK 和 KEK"></a>平衡 DEK 和 KEK</h3><p>通过让 KEK 的数量少于 DEK 并且使用集中式密钥管理服务，我们得以让大规模的数据存储和加密工作变得更加切实可行。中央密钥服务还可以作为一个点，用于更轻松地审核和限制数据访问。</p>
<p>根据您的情况和要加密的数据量，您可以选择使用类似的模型。单个 KEK 可用于保护许多 DEK；该模型允许各个数据对象各自拥有自己的 DEK，而不会大量增加存储在中央密钥管理服务中的密钥量。</p>
</div>

<h2 id="3-3-华为云KMS信封加密简介-官网"><a href="#3-3-华为云KMS信封加密简介-官网" class="headerlink" title="3.3 华为云KMS信封加密简介(官网)"></a>3.3 华为云KMS信封加密简介(<a href="https://support.huaweicloud.com/bestpractice-dew/dew_06_0013.html">官网</a>)</h2><p>当有大量数据（例如：照片、视频或者数据库文件等）需要加解密时，用户可采用信封加密方式加解密数据，无需通过网络传输大量数据即可完成数据加解密。</p>
<h3 id="大量数据加密"><a href="#大量数据加密" class="headerlink" title="大量数据加密"></a>大量数据加密</h3><p><img src="/2024/12/08/java/hai-liang-ye-wu-shu-ju-jia-jie-mi-fang-an-de-luo-di-yu-shi-jian/%E5%8A%A0%E5%AF%86.png" alt="大量数据加密"><br><strong>说明如下：</strong></p>
<ol>
<li>用户需要在KMS中创建一个用户主密钥。</li>
<li>用户调用KMS的“create-datakey”接口创建数据加密密钥。用户得到一个明文的数据加密密钥和一个密文的数据加密密钥。其中密文的数据加密密钥是由指定的用户主密钥加密明文的数据加密密钥生成的。</li>
<li>用户使用明文的数据加密密钥来加密明文文件，生成密文文件。</li>
<li>用户将密文的数据加密密钥和密文文件一同存储到持久化存储设备或服务中。</li>
</ol>
<h3 id="大量数据解密"><a href="#大量数据解密" class="headerlink" title="大量数据解密"></a>大量数据解密</h3><p><img src="/2024/12/08/java/hai-liang-ye-wu-shu-ju-jia-jie-mi-fang-an-de-luo-di-yu-shi-jian/%E8%A7%A3%E5%AF%86.png" alt="大量数据解密"><br><strong>说明如下：</strong></p>
<ol>
<li>用户从持久化存储设备或服务中读取密文的数据加密密钥和密文文件。</li>
<li>用户调用KMS的“decrypt-datakey”接口，使用对应的用户主密钥（即生成密文的数据加密密钥时所使用的用户主密钥）来解密密文的数据加密密钥，取得明文的数据加密密钥。<br>如果对应的用户主密钥被误删除，会导致解密失败。因此，需要妥善管理好用户主密钥。</li>
<li>用户使用明文的数据加密密钥来解密密文文件。</li>
</ol>
<h1 id="四、本地数据加解密方案实践"><a href="#四、本地数据加解密方案实践" class="headerlink" title="四、本地数据加解密方案实践"></a>四、本地数据加解密方案实践</h1><div class="note primary no-icon flat"><p>在上述云厂商的KMS服务提供的大量数据加解密的案例中，加密后的数据和加密后的数据加密密钥DEK一起进行存储。<br>基于数据安全的需求，需要对数据加密密钥进行定期的轮换。对于加密后的数据，业务场景存在对加密数据进行精确查询的需求，需要根据数据加密密钥对查询<strong>参数进行加密查询</strong>。</p>
</div>
<p>综上，我们对KMS的信封加密的标准流程进行一些本地项目落地的调整。<br><img src="/2024/12/08/java/hai-liang-ye-wu-shu-ju-jia-jie-mi-fang-an-de-luo-di-yu-shi-jian/%E6%B5%B7%E9%87%8F%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%A7%A3%E5%AF%86.png" alt="海量数据加解密"></p>
<p><strong>方案说明：</strong></p>
<ol>
<li>本地开发一个密钥管理服务，实现数据加密密钥的管理</li>
<li>数据加密密钥定期轮换，并指定数据加密密钥的<strong>数据类型</strong>、<strong>生效时间</strong>、<strong>版本号</strong></li>
<li>应用引入定制加解密SDK，数据加密时根据<strong>数据类型</strong>、<strong>生效时间</strong>选择对应版本号的数据加密密钥进行加密</li>
<li>加密后的密文同时拼接加密所用的密钥版本号</li>
<li>加密数据查询时，根据查询数据的类型及时间，选择对应版本号的数据加密密钥对参数加密后进行精确查询</li>
</ol>
<h2 id="4-1-数据加密密钥的数据安全分析"><a href="#4-1-数据加密密钥的数据安全分析" class="headerlink" title="4.1 数据加密密钥的数据安全分析"></a>4.1 数据加密密钥的数据安全分析</h2><div class="note success no-icon flat"><h3 id="密钥服务的密钥数据"><a href="#密钥服务的密钥数据" class="headerlink" title="密钥服务的密钥数据"></a>密钥服务的密钥数据</h3><ol>
<li>密钥服务需要对密钥数据进行持久化保存，并做数据的定期备份，防止密钥数据丢失</li>
<li>密钥服务持久化的密钥数据是使用KMS上的用户主密钥进行加密，必须调用华为云KMS的接口才能对密钥数据解密</li>
<li>华为云KMS接口使用IAM账号进行鉴权，鉴权通过IAM账号的访问密钥（AK&#x2F;SK，Access Key ID&#x2F;Secret Access Key）</li>
</ol>
</div>

<div class="note success no-icon flat"><h3 id="华为云IAM账号访问密钥AK-SK"><a href="#华为云IAM账号访问密钥AK-SK" class="headerlink" title="华为云IAM账号访问密钥AK&#x2F;SK"></a>华为云IAM账号访问密钥AK&#x2F;SK</h3><ol>
<li>使用K8s的secrets存储华为云接口的AK&#x2F;SK信息，避免接口账号信息泄漏。</li>
</ol>
</div>

<div class="note success no-icon flat"><h3 id="SDK与密钥服务访问"><a href="#SDK与密钥服务访问" class="headerlink" title="SDK与密钥服务访问"></a>SDK与密钥服务访问</h3><ol>
<li>使用IP白名单进行限制访问</li>
<li>使用appId、appSecret进行身份鉴权</li>
<li>基于应用信息进行签名验证等</li>
</ol>
</div>

<h1 id="五、华为云KMS验证"><a href="#五、华为云KMS验证" class="headerlink" title="五、华为云KMS验证"></a>五、华为云KMS验证</h1><p>在基于华为云KMS服务进行海量数据加解密的场景中，我们主要用到一下3个接口：</p>
<ol>
<li>控制台创建主密钥</li>
<li>接口创建数据密钥</li>
<li>接口解密数据密钥</li>
</ol>
<h2 id="5-1-控制台创建主密钥"><a href="#5-1-控制台创建主密钥" class="headerlink" title="5.1 控制台创建主密钥"></a>5.1 控制台创建主密钥</h2><p><img src="/2024/12/08/java/hai-liang-ye-wu-shu-ju-jia-jie-mi-fang-an-de-luo-di-yu-shi-jian/%E5%88%9B%E5%BB%BA%E4%B8%BB%E5%AF%86%E9%92%A5.png" alt="创建主密钥"></p>
<h2 id="5-2-创建数据密钥"><a href="#5-2-创建数据密钥" class="headerlink" title="5.2 创建数据密钥"></a>5.2 创建数据密钥</h2><p><img src="/2024/12/08/java/hai-liang-ye-wu-shu-ju-jia-jie-mi-fang-an-de-luo-di-yu-shi-jian/%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%AF%86%E9%92%A5.png" alt="创建数据加密密钥"><br>调用华为云创建数据加密密钥的接口，会返回明文和密文的数据加密密钥（DEK），如下：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
 <span class="token property">"plain_text"</span><span class="token operator">:</span> <span class="token string">"43456936300d023645e0d7898d44c3a98b98c1b67cf611ccbfe8b9f5460d7095"</span><span class="token punctuation">,</span>
 <span class="token property">"key_id"</span><span class="token operator">:</span> <span class="token string">"2eef7f6e-7686-45c5-95c4-ddd6459d2e83"</span><span class="token punctuation">,</span>
 <span class="token property">"cipher_text"</span><span class="token operator">:</span> <span class="token string">"050064004ab28a42d6fff08045cd023000e738415a5de6ebccb0cebab73c14369fcc33e5dbc1d36c96739a4edd989eae2be4155a95374dfb04eef8581b95b6df32656566376636652d373638362d343563352d393563342d6464643634353964326538330000000014131211100f0e0d0c0b0a090807060504030201e3b815d0aae3791dfc9947897bfc20188f71c8ab4827c10f555bf3cc894cbbfe"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="5-3-解密数据密钥"><a href="#5-3-解密数据密钥" class="headerlink" title="5.3 解密数据密钥"></a>5.3 解密数据密钥</h2><p><img src="/2024/12/08/java/hai-liang-ye-wu-shu-ju-jia-jie-mi-fang-an-de-luo-di-yu-shi-jian/%E8%A7%A3%E5%AF%86%E6%95%B0%E6%8D%AE%E5%AF%86%E9%92%A5.png" alt="解密数据密钥"><br>调用解密数据密钥接口，对本地存储的加密后的数据密钥进行解密。</p>
<h3 id="请求参数"><a href="#请求参数" class="headerlink" title="请求参数"></a>请求参数</h3><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
 <span class="token property">"key_id"</span><span class="token operator">:</span> <span class="token string">"2eef7f6e-7686-45c5-95c4-ddd6459d2e83"</span><span class="token punctuation">,</span>
 <span class="token property">"cipher_text"</span><span class="token operator">:</span> <span class="token string">"050064004ab28a42d6fff08045cd023000e738415a5de6ebccb0cebab73c14369fcc33e5dbc1d36c96739a4edd989eae2be4155a95374dfb04eef8581b95b6df32656566376636652d373638362d343563352d393563342d6464643634353964326538330000000014131211100f0e0d0c0b0a090807060504030201e3b815d0aae3791dfc9947897bfc20188f71c8ab4827c10f555bf3cc894cbbfe"</span><span class="token punctuation">,</span>
 <span class="token property">"datakey_cipher_length"</span><span class="token operator">:</span> <span class="token string">"312"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="响应参数"><a href="#响应参数" class="headerlink" title="响应参数"></a>响应参数</h3><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
 <span class="token property">"datakey_dgst"</span><span class="token operator">:</span> <span class="token string">"1a96e1bcf8849e04e9e6786b4fcfa779260fac66ecd2233a413dc35c1d48fecb"</span><span class="token punctuation">,</span>
 <span class="token property">"data_key"</span><span class="token operator">:</span> <span class="token string">"43456936300d023645e0d7898d44c3a98b98c1b67cf611ccbfe8b9f5460d7095"</span><span class="token punctuation">,</span>
 <span class="token property">"datakey_length"</span><span class="token operator">:</span> <span class="token string">"32"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h1><p>本文主要介绍基于KMS的海量数据加解密方式，在本地大量数据加解密的场景下，一般采用<font color="red"><strong>信封加密</strong></font>的方式对业务数据进行加密。在本地业务落地过程中，基于加密数据查询的需求及数据存储的要求，我们对标准的信封加密方式进行调整，引入本地密钥服务，实现对数据加密密钥生效时间和版本的管理，更好的适配本地海量业务数据加密的场景。</p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>数据加密</tag>
        <tag>KMS</tag>
        <tag>信封加密</tag>
      </tags>
  </entry>
  <entry>
    <title>深入理解Java线程池：ThreadPoolExecutor</title>
    <url>/2019/05/06/java/shen-ru-li-jie-java-xian-cheng-chi-threadpoolexecutor/</url>
    <content><![CDATA[<p>看完ThreadPoolExecutor线程池源码准备写博客记录一下，但是发现一篇博客对ThreadPoolExecutor源码分析很详细，这里不再重复造轮子，所以直接转载了这篇文章。</p>
<blockquote>
<p>原文地址：<a href="http://www.ideabuffer.cn/2017/04/04/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E7%BA%BF%E7%A8%8B%E6%B1%A0%EF%BC%9AThreadPoolExecutor/">深入理解Java线程池：ThreadPoolExecutor</a></p>
</blockquote>
<h2 id="线程池介绍"><a href="#线程池介绍" class="headerlink" title="线程池介绍"></a>线程池介绍</h2><p>在web开发中，服务器需要接受并处理请求，所以会为一个请求来分配一个线程来进行处理。如果每次请求都新创建一个线程的话实现起来非常简便，但是存在一个问题：</p>
<p><strong>如果并发的请求数量非常多，但每个线程执行的时间很短，这样就会频繁的创建和销毁线程，如此一来会大大降低系统的效率。可能出现服务器在为每个请求创建新线程和销毁线程上花费的时间和消耗的系统资源要比处理实际的用户请求的时间和资源更多。</strong></p>
<p>那么有没有一种办法使执行完一个任务，并不被销毁，而是可以继续执行其他的任务呢？</p>
<p>这就是线程池的目的了。线程池为线程生命周期的开销和资源不足问题提供了解决方案。通过对多个任务重用线程，线程创建的开销被分摊到了多个任务上。</p>
<p><strong>什么时候使用线程池？</strong></p>
<ul>
<li>单个任务处理时间比较短</li>
<li>需要处理的任务数量很大</li>
</ul>
<p><strong>使用线程池的好处</strong></p>
<p>引用自 <a href="http://ifeve.com/java-threadpool/">http://ifeve.com/java-threadpool/</a> 的说明：</p>
<ul>
<li>降低资源消耗。通过重复利用已创建的线程降低线程创建和销毁造成的消耗。</li>
<li>提高响应速度。当任务到达时，任务可以不需要的等到线程创建就能立即执行。</li>
<li>提高线程的可管理性。线程是稀缺资源，如果无限制的创建，不仅会消耗系统资源，还会降低系统的稳定性，使用线程池可以进行统一的分配，调优和监控。</li>
</ul>
<p>Java中的线程池是用ThreadPoolExecutor类来实现的. 本文就结合JDK 1.8对该类的源码来分析一下这个类内部对于线程的创建, 管理以及后台任务的调度等方面的执行原理。</p>
<p>先看一下线程池的类图：</p>
<p><img src="http://www.ideabuffer.cn/2017/04/04/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E7%BA%BF%E7%A8%8B%E6%B1%A0%EF%BC%9AThreadPoolExecutor/QQ20170331-004227.png" alt="ThreadPoolExecutor.png"></p>
<h2 id="Executor框架接口"><a href="#Executor框架接口" class="headerlink" title="Executor框架接口"></a>Executor框架接口</h2><p>Executor框架是一个根据一组执行策略调用，调度，执行和控制的异步任务的框架，目的是提供一种将”任务提交”与”任务如何运行”分离开来的机制。</p>
<p>J.U.C中有三个Executor接口：</p>
<ul>
<li><strong>Executor</strong>：一个运行新任务的简单接口；</li>
<li><strong>ExecutorService</strong>：扩展了Executor接口。添加了一些用来管理执行器生命周期和任务生命周期的方法；</li>
<li><strong>ScheduledExecutorService</strong>：扩展了ExecutorService。支持Future和定期执行任务。</li>
</ul>
<h3 id="Executor接口"><a href="#Executor接口" class="headerlink" title="Executor接口"></a>Executor接口</h3><pre class="line-numbers language-none"><code class="language-none">public interface Executor &#123;
    void execute(Runnable command);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>Executor接口只有一个execute方法，用来替代通常创建或启动线程的方法。例如，使用Thread来创建并启动线程的代码如下：</p>
<pre class="line-numbers language-none"><code class="language-none">Thread t &#x3D; new Thread();
t.start();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>使用Executor来启动线程执行任务的代码如下：</p>
<pre class="line-numbers language-none"><code class="language-none">Thread t &#x3D; new Thread();
executor.execute(t);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>对于不同的Executor实现，execute()方法可能是创建一个新线程并立即启动，也有可能是使用已有的工作线程来运行传入的任务，也可能是根据设置线程池的容量或者阻塞队列的容量来决定是否要将传入的线程放入阻塞队列中或者拒绝接收传入的线程。</p>
<h3 id="ExecutorService接口"><a href="#ExecutorService接口" class="headerlink" title="ExecutorService接口"></a>ExecutorService接口</h3><p>ExecutorService接口继承自Executor接口，提供了管理终止的方法，以及可为跟踪一个或多个异步任务执行状况而生成 Future 的方法。增加了shutDown()，shutDownNow()，invokeAll()，invokeAny()和submit()等方法。如果需要支持即时关闭，也就是shutDownNow()方法，则任务需要正确处理中断。</p>
<h3 id="ScheduledExecutorService接口"><a href="#ScheduledExecutorService接口" class="headerlink" title="ScheduledExecutorService接口"></a>ScheduledExecutorService接口</h3><p>ScheduledExecutorService扩展ExecutorService接口并增加了schedule方法。调用schedule方法可以在指定的延时后执行一个Runnable或者Callable任务。ScheduledExecutorService接口还定义了按照指定时间间隔定期执行任务的scheduleAtFixedRate()方法和scheduleWithFixedDelay()方法。</p>
<h2 id="ThreadPoolExecutor分析"><a href="#ThreadPoolExecutor分析" class="headerlink" title="ThreadPoolExecutor分析"></a>ThreadPoolExecutor分析</h2><p>ThreadPoolExecutor继承自AbstractExecutorService，也是实现了ExecutorService接口。</p>
<h3 id="几个重要的字段"><a href="#几个重要的字段" class="headerlink" title="几个重要的字段"></a>几个重要的字段</h3><pre class="line-numbers language-none"><code class="language-none">private final AtomicInteger ctl &#x3D; new AtomicInteger(ctlOf(RUNNING, 0));
private static final int COUNT_BITS &#x3D; Integer.SIZE - 3;
private static final int CAPACITY   &#x3D; (1 &lt;&lt; COUNT_BITS) - 1;

&#x2F;&#x2F; runState is stored in the high-order bits
private static final int RUNNING    &#x3D; -1 &lt;&lt; COUNT_BITS;
private static final int SHUTDOWN   &#x3D;  0 &lt;&lt; COUNT_BITS;
private static final int STOP       &#x3D;  1 &lt;&lt; COUNT_BITS;
private static final int TIDYING    &#x3D;  2 &lt;&lt; COUNT_BITS;
private static final int TERMINATED &#x3D;  3 &lt;&lt; COUNT_BITS;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>ctl</code>是对线程池的运行状态和线程池中有效线程的数量进行控制的一个字段， 它包含两部分的信息: 线程池的运行状态 (runState) 和线程池内有效线程的数量 (workerCount)，这里可以看到，使用了Integer类型来保存，高3位保存runState，低29位保存workerCount。COUNT_BITS 就是29，CAPACITY就是1左移29位减1（29个1），这个常量表示workerCount的上限值，大约是5亿。</p>
<p>下面再介绍下线程池的运行状态. 线程池一共有五种状态, 分别是:</p>
<ol>
<li><p><strong>RUNNING</strong> ：能接受新提交的任务，并且也能处理阻塞队列中的任务；</p>
</li>
<li><p><strong>SHUTDOWN</strong>：关闭状态，不再接受新提交的任务，但却可以继续处理阻塞队列中已保存的任务。在线程池处于 RUNNING 状态时，调用 shutdown()方法会使线程池进入到该状态。（finalize() 方法在执行过程中也会调用shutdown()方法进入该状态）；</p>
</li>
<li><p><strong>STOP</strong>：不能接受新任务，也不处理队列中的任务，会中断正在处理任务的线程。在线程池处于 RUNNING 或 SHUTDOWN 状态时，调用 shutdownNow() 方法会使线程池进入到该状态；</p>
</li>
<li><p><strong>TIDYING</strong>：如果所有的任务都已终止了，workerCount (有效线程数) 为0，线程池进入该状态后会调用 terminated() 方法进入TERMINATED 状态。</p>
</li>
<li><p>TERMINATED</p>
<p>：在terminated() 方法执行完后进入该状态，默认terminated()方法中什么也没有做。</p>
<p>进入TERMINATED的条件如下：</p>
<ul>
<li>线程池不是RUNNING状态；</li>
<li>线程池状态不是TIDYING状态或TERMINATED状态；</li>
<li>如果线程池状态是SHUTDOWN并且workerQueue为空；</li>
<li>workerCount为0；</li>
<li>设置TIDYING状态成功。</li>
</ul>
</li>
</ol>
<p>下图为线程池的状态转换过程：</p>
<p><img src="http://www.ideabuffer.cn/2017/04/04/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E7%BA%BF%E7%A8%8B%E6%B1%A0%EF%BC%9AThreadPoolExecutor/threadpool-status.png" alt="threadpool-status.png"></p>
<h3 id="ctl相关方法"><a href="#ctl相关方法" class="headerlink" title="ctl相关方法"></a>ctl相关方法</h3><p>这里还有几个对ctl进行计算的方法：</p>
<pre class="line-numbers language-none"><code class="language-none">private static int runStateOf(int c)     &#123; return c &amp; ~CAPACITY; &#125;
private static int workerCountOf(int c)  &#123; return c &amp; CAPACITY; &#125;
private static int ctlOf(int rs, int wc) &#123; return rs | wc; &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li><strong>runStateOf</strong>：获取运行状态；</li>
<li><strong>workerCountOf</strong>：获取活动线程数；</li>
<li><strong>ctlOf</strong>：获取运行状态和活动线程数的值。</li>
</ul>
<h3 id="ThreadPoolExecutor构造方法"><a href="#ThreadPoolExecutor构造方法" class="headerlink" title="ThreadPoolExecutor构造方法"></a>ThreadPoolExecutor构造方法</h3><pre class="line-numbers language-none"><code class="language-none">public ThreadPoolExecutor(int corePoolSize,
                          int maximumPoolSize,
                          long keepAliveTime,
                          TimeUnit unit,
                          BlockingQueue&lt;Runnable&gt; workQueue,
                          ThreadFactory threadFactory,
                          RejectedExecutionHandler handler) &#123;
    if (corePoolSize &lt; 0 ||
        maximumPoolSize &lt;&#x3D; 0 ||
        maximumPoolSize &lt; corePoolSize ||
        keepAliveTime &lt; 0)
        throw new IllegalArgumentException();
    if (workQueue &#x3D;&#x3D; null || threadFactory &#x3D;&#x3D; null || handler &#x3D;&#x3D; null)
        throw new NullPointerException();
    this.corePoolSize &#x3D; corePoolSize;
    this.maximumPoolSize &#x3D; maximumPoolSize;
    this.workQueue &#x3D; workQueue;
    this.keepAliveTime &#x3D; unit.toNanos(keepAliveTime);
    this.threadFactory &#x3D; threadFactory;
    this.handler &#x3D; handler;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>构造方法中的字段含义如下：</p>
<ul>
<li><p><strong>corePoolSize</strong>：核心线程数量，当有新任务在execute()方法提交时，会执行以下判断：</p>
<ol>
<li>如果运行的线程少于 corePoolSize，则创建新线程来处理任务，即使线程池中的其他线程是空闲的；</li>
<li>如果线程池中的线程数量大于等于 corePoolSize 且小于 maximumPoolSize，则只有当workQueue满时才创建新的线程去处理任务；</li>
<li>如果设置的corePoolSize 和 maximumPoolSize相同，则创建的线程池的大小是固定的，这时如果有新任务提交，若workQueue未满，则将请求放入workQueue中，等待有空闲的线程去从workQueue中取任务并处理；</li>
<li>如果运行的线程数量大于等于maximumPoolSize，这时如果workQueue已经满了，则通过handler所指定的策略来处理任务；</li>
</ol>
<p>所以，任务提交时，判断的顺序为 corePoolSize –&gt; workQueue –&gt; maximumPoolSize。</p>
</li>
<li><p><strong>maximumPoolSize</strong>：最大线程数量；</p>
</li>
<li><p><strong>workQueue</strong>：等待队列，当任务提交时，如果线程池中的线程数量大于等于corePoolSize的时候，把该任务封装成一个Worker对象放入等待队列；</p>
</li>
<li><p>workQueue</p>
<p>：保存等待执行的任务的阻塞队列，当提交一个新的任务到线程池以后, 线程池会根据当前线程池中正在运行着的线程的数量来决定对该任务的处理方式，主要有以下几种处理方式:</p>
<ol>
<li><p><strong>直接切换</strong>：这种方式常用的队列是SynchronousQueue，但现在还没有研究过该队列，这里暂时还没法介绍；</p>
</li>
<li><p><strong>使用无界队列</strong>：一般使用基于链表的阻塞队列LinkedBlockingQueue。如果使用这种方式，那么线程池中能够创建的最大线程数就是corePoolSize，而maximumPoolSize就不会起作用了（后面也会说到）。当线程池中所有的核心线程都是RUNNING状态时，这时一个新的任务提交就会放入等待队列中。</p>
</li>
<li><p>使用有界队列</p>
<p>：一般使用ArrayBlockingQueue。使用该方式可以将线程池的最大线程数量限制为maximumPoolSize，这样能够降低资源的消耗，但同时这种方式也使得线程池对线程的调度变得更困难，因为线程池和队列的容量都是有限的值，所以要想使线程池处理任务的吞吐率达到一个相对合理的范围，又想使线程调度相对简单，并且还要尽可能的降低线程池对资源的消耗，就需要合理的设置这两个数量。</p>
<ul>
<li>如果要想降低系统资源的消耗（包括CPU的使用率，操作系统资源的消耗，上下文环境切换的开销等）, 可以设置较大的队列容量和较小的线程池容量, 但这样也会降低线程处理任务的吞吐量。</li>
<li>如果提交的任务经常发生阻塞，那么可以考虑通过调用 setMaximumPoolSize() 方法来重新设定线程池的容量。</li>
<li>如果队列的容量设置的较小，通常需要将线程池的容量设置大一点，这样CPU的使用率会相对的高一些。但如果线程池的容量设置的过大，则在提交的任务数量太多的情况下，并发量会增加，那么线程之间的调度就是一个要考虑的问题，因为这样反而有可能降低处理任务的吞吐量。</li>
</ul>
</li>
</ol>
</li>
<li><p><strong>keepAliveTime</strong>：线程池维护线程所允许的空闲时间。当线程池中的线程数量大于corePoolSize的时候，如果这时没有新的任务提交，核心线程外的线程不会立即销毁，而是会等待，直到等待的时间超过了keepAliveTime；</p>
</li>
<li><p><strong>threadFactory</strong>：它是ThreadFactory类型的变量，用来创建新线程。默认使用Executors.defaultThreadFactory() 来创建线程。使用默认的ThreadFactory来创建线程时，会使新创建的线程具有相同的NORM_PRIORITY优先级并且是非守护线程，同时也设置了线程的名称。</p>
</li>
<li><p>handler</p>
<p>：它是RejectedExecutionHandler类型的变量，表示线程池的饱和策略。如果阻塞队列满了并且没有空闲的线程，这时如果继续提交任务，就需要采取一种策略处理该任务。线程池提供了4种策略：</p>
<ol>
<li>AbortPolicy：直接抛出异常，这是默认策略；</li>
<li>CallerRunsPolicy：用调用者所在的线程来执行任务；</li>
<li>DiscardOldestPolicy：丢弃阻塞队列中靠最前的任务，并执行当前任务；</li>
<li>DiscardPolicy：直接丢弃任务；</li>
</ol>
</li>
</ul>
<h3 id="execute方法"><a href="#execute方法" class="headerlink" title="execute方法"></a>execute方法</h3><p>execute()方法用来提交任务，代码如下：</p>
<pre class="line-numbers language-none"><code class="language-none">public void execute(Runnable command) &#123;
    if (command &#x3D;&#x3D; null)
        throw new NullPointerException();
    &#x2F;*
     * clt记录着runState和workerCount
     *&#x2F;
    int c &#x3D; ctl.get();
    &#x2F;*
     * workerCountOf方法取出低29位的值，表示当前活动的线程数；
     * 如果当前活动线程数小于corePoolSize，则新建一个线程放入线程池中；
     * 并把任务添加到该线程中。
     *&#x2F;
    if (workerCountOf(c) &lt; corePoolSize) &#123;
        &#x2F;*
         * addWorker中的第二个参数表示限制添加线程的数量是根据corePoolSize来判断还是maximumPoolSize来判断；
         * 如果为true，根据corePoolSize来判断；
         * 如果为false，则根据maximumPoolSize来判断
         *&#x2F;
        if (addWorker(command, true))
            return;
        &#x2F;*
         * 如果添加失败，则重新获取ctl值
         *&#x2F;
        c &#x3D; ctl.get();
    &#125;
    &#x2F;*
     * 如果当前线程池是运行状态并且任务添加到队列成功
     *&#x2F;
    if (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;
        &#x2F;&#x2F; 重新获取ctl值
        int recheck &#x3D; ctl.get();
        &#x2F;&#x2F; 再次判断线程池的运行状态，如果不是运行状态，由于之前已经把command添加到workQueue中了，
        &#x2F;&#x2F; 这时需要移除该command
        &#x2F;&#x2F; 执行过后通过handler使用拒绝策略对该任务进行处理，整个方法返回
        if (! isRunning(recheck) &amp;&amp; remove(command))
            reject(command);
        &#x2F;*
         * 获取线程池中的有效线程数，如果数量是0，则执行addWorker方法
         * 这里传入的参数表示：
         * 1. 第一个参数为null，表示在线程池中创建一个线程，但不去启动；
         * 2. 第二个参数为false，将线程池的有限线程数量的上限设置为maximumPoolSize，添加线程时根据maximumPoolSize来判断；
         * 如果判断workerCount大于0，则直接返回，在workQueue中新增的command会在将来的某个时刻被执行。
         *&#x2F;
        else if (workerCountOf(recheck) &#x3D;&#x3D; 0)
            addWorker(null, false);
    &#125;
    &#x2F;*
     * 如果执行到这里，有两种情况：
     * 1. 线程池已经不是RUNNING状态；
     * 2. 线程池是RUNNING状态，但workerCount &gt;&#x3D; corePoolSize并且workQueue已满。
     * 这时，再次调用addWorker方法，但第二个参数传入为false，将线程池的有限线程数量的上限设置为maximumPoolSize；
     * 如果失败则拒绝该任务
     *&#x2F;
    else if (!addWorker(command, false))
        reject(command);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>简单来说，在执行execute()方法时如果状态一直是RUNNING时，的执行过程如下：</p>
<ol>
<li>如果<code>workerCount &lt; corePoolSize</code>，则创建并启动一个线程来执行新提交的任务；</li>
<li>如果<code>workerCount &gt;= corePoolSize</code>，且线程池内的阻塞队列未满，则将任务添加到该阻塞队列中；</li>
<li>如果<code>workerCount &gt;= corePoolSize &amp;&amp; workerCount &lt; maximumPoolSize</code>，且线程池内的阻塞队列已满，则创建并启动一个线程来执行新提交的任务；</li>
<li>如果<code>workerCount &gt;= maximumPoolSize</code>，并且线程池内的阻塞队列已满, 则根据拒绝策略来处理该任务, 默认的处理方式是直接抛异常。</li>
</ol>
<p>这里要注意一下<code>addWorker(null, false);</code>，也就是创建一个线程，但并没有传入任务，因为任务已经被添加到workQueue中了，所以worker在执行的时候，会直接从workQueue中获取任务。所以，在<code>workerCountOf(recheck) == 0</code>时执行<code>addWorker(null, false);</code>也是为了保证线程池在RUNNING状态下必须要有一个线程来执行任务。</p>
<p>execute方法执行流程如下：</p>
<p><img src="http://www.ideabuffer.cn/2017/04/04/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E7%BA%BF%E7%A8%8B%E6%B1%A0%EF%BC%9AThreadPoolExecutor/executor.png" alt="executor.png"></p>
<h3 id="addWorker方法"><a href="#addWorker方法" class="headerlink" title="addWorker方法"></a>addWorker方法</h3><p>addWorker方法的主要工作是在线程池中创建一个新的线程并执行，firstTask参数 用于指定新增的线程执行的第一个任务，core参数为true表示在新增线程时会判断当前活动线程数是否少于corePoolSize，false表示新增线程前需要判断当前活动线程数是否少于maximumPoolSize，代码如下：</p>
<pre class="line-numbers language-none"><code class="language-none">private boolean addWorker(Runnable firstTask, boolean core) &#123;
    retry:
    for (;;) &#123;
        int c &#x3D; ctl.get();
        &#x2F;&#x2F; 获取运行状态
        int rs &#x3D; runStateOf(c);
        
        &#x2F;*
         * 这个if判断
         * 如果rs &gt;&#x3D; SHUTDOWN，则表示此时不再接收新任务；
         * 接着判断以下3个条件，只要有1个不满足，则返回false：
         * 1. rs &#x3D;&#x3D; SHUTDOWN，这时表示关闭状态，不再接受新提交的任务，但却可以继续处理阻塞队列中已保存的任务
         * 2. firsTask为空
         * 3. 阻塞队列不为空
         * 
         * 首先考虑rs &#x3D;&#x3D; SHUTDOWN的情况
         * 这种情况下不会接受新提交的任务，所以在firstTask不为空的时候会返回false；
         * 然后，如果firstTask为空，并且workQueue也为空，则返回false，
         * 因为队列中已经没有任务了，不需要再添加线程了
         *&#x2F;
        &#x2F;&#x2F; Check if queue empty only if necessary.
        if (rs &gt;&#x3D; SHUTDOWN &amp;&amp;
            ! (rs &#x3D;&#x3D; SHUTDOWN &amp;&amp;
               firstTask &#x3D;&#x3D; null &amp;&amp;
               ! workQueue.isEmpty()))
            return false;

        for (;;) &#123;
            &#x2F;&#x2F; 获取线程数
            int wc &#x3D; workerCountOf(c);
            &#x2F;&#x2F; 如果wc超过CAPACITY，也就是ctl的低29位的最大值（二进制是29个1），返回false；
            &#x2F;&#x2F; 这里的core是addWorker方法的第二个参数，如果为true表示根据corePoolSize来比较，
            &#x2F;&#x2F; 如果为false则根据maximumPoolSize来比较。
            &#x2F;&#x2F; 
            if (wc &gt;&#x3D; CAPACITY ||
                wc &gt;&#x3D; (core ? corePoolSize : maximumPoolSize))
                return false;
            &#x2F;&#x2F; 尝试增加workerCount，如果成功，则跳出第一个for循环
            if (compareAndIncrementWorkerCount(c))
                break retry;
            &#x2F;&#x2F; 如果增加workerCount失败，则重新获取ctl的值
            c &#x3D; ctl.get();  &#x2F;&#x2F; Re-read ctl
            &#x2F;&#x2F; 如果当前的运行状态不等于rs，说明状态已被改变，返回第一个for循环继续执行
            if (runStateOf(c) !&#x3D; rs)
                continue retry;
            &#x2F;&#x2F; else CAS failed due to workerCount change; retry inner loop
        &#125;
    &#125;

    boolean workerStarted &#x3D; false;
    boolean workerAdded &#x3D; false;
    Worker w &#x3D; null;
    try &#123;
        &#x2F;&#x2F; 根据firstTask来创建Worker对象
        w &#x3D; new Worker(firstTask);
        &#x2F;&#x2F; 每一个Worker对象都会创建一个线程
        final Thread t &#x3D; w.thread;
        if (t !&#x3D; null) &#123;
            final ReentrantLock mainLock &#x3D; this.mainLock;
            mainLock.lock();
            try &#123;
                &#x2F;&#x2F; Recheck while holding lock.
                &#x2F;&#x2F; Back out on ThreadFactory failure or if
                &#x2F;&#x2F; shut down before lock acquired.
                int rs &#x3D; runStateOf(ctl.get());
                &#x2F;&#x2F; rs &lt; SHUTDOWN表示是RUNNING状态；
                &#x2F;&#x2F; 如果rs是RUNNING状态或者rs是SHUTDOWN状态并且firstTask为null，向线程池中添加线程。
                &#x2F;&#x2F; 因为在SHUTDOWN时不会在添加新的任务，但还是会执行workQueue中的任务
                if (rs &lt; SHUTDOWN ||
                    (rs &#x3D;&#x3D; SHUTDOWN &amp;&amp; firstTask &#x3D;&#x3D; null)) &#123;
                    if (t.isAlive()) &#x2F;&#x2F; precheck that t is startable
                        throw new IllegalThreadStateException();
                    &#x2F;&#x2F; workers是一个HashSet
                    workers.add(w);
                    int s &#x3D; workers.size();
                    &#x2F;&#x2F; largestPoolSize记录着线程池中出现过的最大线程数量
                    if (s &gt; largestPoolSize)
                        largestPoolSize &#x3D; s;
                    workerAdded &#x3D; true;
                &#125;
            &#125; finally &#123;
                mainLock.unlock();
            &#125;
            if (workerAdded) &#123;
                &#x2F;&#x2F; 启动线程
                t.start();
                workerStarted &#x3D; true;
            &#125;
        &#125;
    &#125; finally &#123;
        if (! workerStarted)
            addWorkerFailed(w);
    &#125;
    return workerStarted;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>注意一下这里的<code>t.start()</code>这个语句，启动时会调用Worker类中的run方法，Worker本身实现了Runnable接口，所以一个Worker类型的对象也是一个线程。</p>
<h3 id="Worker类"><a href="#Worker类" class="headerlink" title="Worker类"></a>Worker类</h3><p>线程池中的每一个线程被封装成一个Worker对象，ThreadPool维护的其实就是一组Worker对象，看一下Worker的定义：</p>
<pre class="line-numbers language-none"><code class="language-none">private final class Worker
        extends AbstractQueuedSynchronizer
        implements Runnable
&#123;
    &#x2F;**
     * This class will never be serialized, but we provide a
     * serialVersionUID to suppress a javac warning.
     *&#x2F;
    private static final long serialVersionUID &#x3D; 6138294804551838833L;

    &#x2F;** Thread this worker is running in.  Null if factory fails. *&#x2F;
    final Thread thread;
    &#x2F;** Initial task to run.  Possibly null. *&#x2F;
    Runnable firstTask;
    &#x2F;** Per-thread task counter *&#x2F;
    volatile long completedTasks;

    &#x2F;**
     * Creates with given first task and thread from ThreadFactory.
     * @param firstTask the first task (null if none)
     *&#x2F;
    Worker(Runnable firstTask) &#123;
        setState(-1); &#x2F;&#x2F; inhibit interrupts until runWorker
        this.firstTask &#x3D; firstTask;
        this.thread &#x3D; getThreadFactory().newThread(this);
    &#125;

    &#x2F;** Delegates main run loop to outer runWorker  *&#x2F;
    public void run() &#123;
        runWorker(this);
    &#125;

    &#x2F;&#x2F; Lock methods
    &#x2F;&#x2F;
    &#x2F;&#x2F; The value 0 represents the unlocked state.
    &#x2F;&#x2F; The value 1 represents the locked state.

    protected boolean isHeldExclusively() &#123;
        return getState() !&#x3D; 0;
    &#125;

    protected boolean tryAcquire(int unused) &#123;
        if (compareAndSetState(0, 1)) &#123;
            setExclusiveOwnerThread(Thread.currentThread());
            return true;
        &#125;
        return false;
    &#125;

    protected boolean tryRelease(int unused) &#123;
        setExclusiveOwnerThread(null);
        setState(0);
        return true;
    &#125;

    public void lock()        &#123; acquire(1); &#125;
    public boolean tryLock()  &#123; return tryAcquire(1); &#125;
    public void unlock()      &#123; release(1); &#125;
    public boolean isLocked() &#123; return isHeldExclusively(); &#125;

    void interruptIfStarted() &#123;
        Thread t;
        if (getState() &gt;&#x3D; 0 &amp;&amp; (t &#x3D; thread) !&#x3D; null &amp;&amp; !t.isInterrupted()) &#123;
            try &#123;
                t.interrupt();
            &#125; catch (SecurityException ignore) &#123;
            &#125;
        &#125;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Worker类继承了AQS，并实现了Runnable接口，注意其中的firstTask和thread属性：firstTask用它来保存传入的任务；thread是在调用构造方法时通过ThreadFactory来创建的线程，是用来处理任务的线程。</p>
<p>在调用构造方法时，需要把任务传入，这里通过<code>getThreadFactory().newThread(this);</code>来新建一个线程，newThread方法传入的参数是this，因为Worker本身继承了Runnable接口，也就是一个线程，所以一个Worker对象在启动的时候会调用Worker类中的run方法。</p>
<p>Worker继承了AQS，使用AQS来实现独占锁的功能。为什么不使用ReentrantLock来实现呢？可以看到tryAcquire方法，它是不允许重入的，而ReentrantLock是允许重入的：</p>
<ol>
<li>lock方法一旦获取了独占锁，表示当前线程正在执行任务中；</li>
<li>如果正在执行任务，则不应该中断线程；</li>
<li>如果该线程现在不是独占锁的状态，也就是空闲的状态，说明它没有在处理任务，这时可以对该线程进行中断；</li>
<li>线程池在执行shutdown方法或tryTerminate方法时会调用interruptIdleWorkers方法来中断空闲的线程，interruptIdleWorkers方法会使用tryLock方法来判断线程池中的线程是否是空闲状态；</li>
<li>之所以设置为不可重入，是因为我们不希望任务在调用像setCorePoolSize这样的线程池控制方法时重新获取锁。如果使用ReentrantLock，它是可重入的，这样如果在任务中调用了如setCorePoolSize这类线程池控制的方法，会中断正在运行的线程。</li>
</ol>
<p>所以，Worker继承自AQS，用于判断线程是否空闲以及是否可以被中断。</p>
<p>此外，在构造方法中执行了<code>setState(-1);</code>，把state变量设置为-1，为什么这么做呢？是因为AQS中默认的state是0，如果刚创建了一个Worker对象，还没有执行任务时，这时就不应该被中断，看一下tryAquire方法：</p>
<pre class="line-numbers language-none"><code class="language-none">protected boolean tryAcquire(int unused) &#123;
    if (compareAndSetState(0, 1)) &#123;
        setExclusiveOwnerThread(Thread.currentThread());
        return true;
    &#125;
    return false;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>tryAcquire方法是根据state是否是0来判断的，所以，<code>setState(-1);</code>将state设置为-1是为了禁止在执行任务前对线程进行中断。</p>
<p>正因为如此，在runWorker方法中会先调用Worker对象的unlock方法将state设置为0.</p>
<h3 id="runWorker方法"><a href="#runWorker方法" class="headerlink" title="runWorker方法"></a>runWorker方法</h3><p>在Worker类中的run方法调用了runWorker方法来执行任务，runWorker方法的代码如下：</p>
<pre class="line-numbers language-none"><code class="language-none">final void runWorker(Worker w) &#123;
    Thread wt &#x3D; Thread.currentThread();
    &#x2F;&#x2F; 获取第一个任务
    Runnable task &#x3D; w.firstTask;
    w.firstTask &#x3D; null;
    &#x2F;&#x2F; 允许中断
    w.unlock(); &#x2F;&#x2F; allow interrupts
    &#x2F;&#x2F; 是否因为异常退出循环
    boolean completedAbruptly &#x3D; true;
    try &#123;
        &#x2F;&#x2F; 如果task为空，则通过getTask来获取任务
        while (task !&#x3D; null || (task &#x3D; getTask()) !&#x3D; null) &#123;
            w.lock();
            &#x2F;&#x2F; If pool is stopping, ensure thread is interrupted;
            &#x2F;&#x2F; if not, ensure thread is not interrupted.  This
            &#x2F;&#x2F; requires a recheck in second case to deal with
            &#x2F;&#x2F; shutdownNow race while clearing interrupt
            if ((runStateAtLeast(ctl.get(), STOP) ||
                 (Thread.interrupted() &amp;&amp;
                  runStateAtLeast(ctl.get(), STOP))) &amp;&amp;
                !wt.isInterrupted())
                wt.interrupt();
            try &#123;
                beforeExecute(wt, task);
                Throwable thrown &#x3D; null;
                try &#123;
                    task.run();
                &#125; catch (RuntimeException x) &#123;
                    thrown &#x3D; x; throw x;
                &#125; catch (Error x) &#123;
                    thrown &#x3D; x; throw x;
                &#125; catch (Throwable x) &#123;
                    thrown &#x3D; x; throw new Error(x);
                &#125; finally &#123;
                    afterExecute(task, thrown);
                &#125;
            &#125; finally &#123;
                task &#x3D; null;
                w.completedTasks++;
                w.unlock();
            &#125;
        &#125;
        completedAbruptly &#x3D; false;
    &#125; finally &#123;
        processWorkerExit(w, completedAbruptly);
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里说明一下第一个if判断，目的是：</p>
<ul>
<li>如果线程池正在停止，那么要保证当前线程是中断状态；</li>
<li>如果不是的话，则要保证当前线程不是中断状态；</li>
</ul>
<p>这里要考虑在执行该if语句期间可能也执行了shutdownNow方法，shutdownNow方法会把状态设置为STOP，回顾一下STOP状态：</p>
<blockquote>
<p>不能接受新任务，也不处理队列中的任务，会中断正在处理任务的线程。在线程池处于 RUNNING 或 SHUTDOWN 状态时，调用 shutdownNow() 方法会使线程池进入到该状态。</p>
</blockquote>
<p>STOP状态要中断线程池中的所有线程，而这里使用<code>Thread.interrupted()</code>来判断是否中断是为了确保在RUNNING或者SHUTDOWN状态时线程是非中断状态的，因为Thread.interrupted()方法会复位中断的状态。</p>
<p>总结一下runWorker方法的执行过程：</p>
<ol>
<li>while循环不断地通过getTask()方法获取任务；</li>
<li>getTask()方法从阻塞队列中取任务；</li>
<li>如果线程池正在停止，那么要保证当前线程是中断状态，否则要保证当前线程不是中断状态；</li>
<li>调用<code>task.run()</code>执行任务；</li>
<li>如果task为null则跳出循环，执行processWorkerExit()方法；</li>
<li>runWorker方法执行完毕，也代表着Worker中的run方法执行完毕，销毁线程。</li>
</ol>
<p>这里的beforeExecute方法和afterExecute方法在ThreadPoolExecutor类中是空的，留给子类来实现。</p>
<p>completedAbruptly变量来表示在执行任务过程中是否出现了异常，在processWorkerExit方法中会对该变量的值进行判断。</p>
<h3 id="getTask方法"><a href="#getTask方法" class="headerlink" title="getTask方法"></a>getTask方法</h3><p>getTask方法用来从阻塞队列中取任务，代码如下：</p>
<pre class="line-numbers language-none"><code class="language-none">private Runnable getTask() &#123;
    &#x2F;&#x2F; timeOut变量的值表示上次从阻塞队列中取任务时是否超时
    boolean timedOut &#x3D; false; &#x2F;&#x2F; Did the last poll() time out?

    for (;;) &#123;
        int c &#x3D; ctl.get();
        int rs &#x3D; runStateOf(c);

        &#x2F;&#x2F; Check if queue empty only if necessary.
        &#x2F;*
         * 如果线程池状态rs &gt;&#x3D; SHUTDOWN，也就是非RUNNING状态，再进行以下判断：
         * 1. rs &gt;&#x3D; STOP，线程池是否正在stop；
         * 2. 阻塞队列是否为空。
         * 如果以上条件满足，则将workerCount减1并返回null。
         * 因为如果当前线程池状态的值是SHUTDOWN或以上时，不允许再向阻塞队列中添加任务。
         *&#x2F;
        if (rs &gt;&#x3D; SHUTDOWN &amp;&amp; (rs &gt;&#x3D; STOP || workQueue.isEmpty())) &#123;
            decrementWorkerCount();
            return null;
        &#125;

        int wc &#x3D; workerCountOf(c);

        &#x2F;&#x2F; Are workers subject to culling?
        &#x2F;&#x2F; timed变量用于判断是否需要进行超时控制。
        &#x2F;&#x2F; allowCoreThreadTimeOut默认是false，也就是核心线程不允许进行超时；
        &#x2F;&#x2F; wc &gt; corePoolSize，表示当前线程池中的线程数量大于核心线程数量；
        &#x2F;&#x2F; 对于超过核心线程数量的这些线程，需要进行超时控制
        boolean timed &#x3D; allowCoreThreadTimeOut || wc &gt; corePoolSize;
        
        &#x2F;*
         * wc &gt; maximumPoolSize的情况是因为可能在此方法执行阶段同时执行了setMaximumPoolSize方法；
         * timed &amp;&amp; timedOut 如果为true，表示当前操作需要进行超时控制，并且上次从阻塞队列中获取任务发生了超时
         * 接下来判断，如果有效线程数量大于1，或者阻塞队列是空的，那么尝试将workerCount减1；
         * 如果减1失败，则返回重试。
         * 如果wc &#x3D;&#x3D; 1时，也就说明当前线程是线程池中唯一的一个线程了。
         *&#x2F;
        if ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut))
            &amp;&amp; (wc &gt; 1 || workQueue.isEmpty())) &#123;
            if (compareAndDecrementWorkerCount(c))
                return null;
            continue;
        &#125;

        try &#123;
            &#x2F;*
             * 根据timed来判断，如果为true，则通过阻塞队列的poll方法进行超时控制，如果在keepAliveTime时间内没有获取到任务，则返回null；
             * 否则通过take方法，如果这时队列为空，则take方法会阻塞直到队列不为空。
             * 
             *&#x2F;
            Runnable r &#x3D; timed ?
                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :
                workQueue.take();
            if (r !&#x3D; null)
                return r;
            &#x2F;&#x2F; 如果 r &#x3D;&#x3D; null，说明已经超时，timedOut设置为true
            timedOut &#x3D; true;
        &#125; catch (InterruptedException retry) &#123;
            &#x2F;&#x2F; 如果获取任务时当前线程发生了中断，则设置timedOut为false并返回循环重试
            timedOut &#x3D; false;
        &#125;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里重要的地方是第二个if判断，目的是控制线程池的有效线程数量。由上文中的分析可以知道，在执行execute方法时，如果当前线程池的线程数量超过了corePoolSize且小于maximumPoolSize，并且workQueue已满时，则可以增加工作线程，但这时如果超时没有获取到任务，也就是timedOut为true的情况，说明workQueue已经为空了，也就说明了当前线程池中不需要那么多线程来执行任务了，可以把多于corePoolSize数量的线程销毁掉，保持线程数量在corePoolSize即可。</p>
<p>什么时候会销毁？当然是runWorker方法执行完之后，也就是Worker中的run方法执行完，由JVM自动回收。</p>
<p>getTask方法返回null时，在runWorker方法中会跳出while循环，然后会执行processWorkerExit方法。</p>
<h3 id="processWorkerExit方法"><a href="#processWorkerExit方法" class="headerlink" title="processWorkerExit方法"></a>processWorkerExit方法</h3><pre class="line-numbers language-none"><code class="language-none">private void processWorkerExit(Worker w, boolean completedAbruptly) &#123;
    &#x2F;&#x2F; 如果completedAbruptly值为true，则说明线程执行时出现了异常，需要将workerCount减1；
    &#x2F;&#x2F; 如果线程执行时没有出现异常，说明在getTask()方法中已经已经对workerCount进行了减1操作，这里就不必再减了。  
    if (completedAbruptly) &#x2F;&#x2F; If abrupt, then workerCount wasn&#39;t adjusted
        decrementWorkerCount();

    final ReentrantLock mainLock &#x3D; this.mainLock;
    mainLock.lock();
    try &#123;
        &#x2F;&#x2F;统计完成的任务数
        completedTaskCount +&#x3D; w.completedTasks;
        &#x2F;&#x2F; 从workers中移除，也就表示着从线程池中移除了一个工作线程
        workers.remove(w);
    &#125; finally &#123;
        mainLock.unlock();
    &#125;

    &#x2F;&#x2F; 根据线程池状态进行判断是否结束线程池
    tryTerminate();

    int c &#x3D; ctl.get();
    &#x2F;*
     * 当线程池是RUNNING或SHUTDOWN状态时，如果worker是异常结束，那么会直接addWorker；
     * 如果allowCoreThreadTimeOut&#x3D;true，并且等待队列有任务，至少保留一个worker；
     * 如果allowCoreThreadTimeOut&#x3D;false，workerCount不少于corePoolSize。
     *&#x2F;
    if (runStateLessThan(c, STOP)) &#123;
        if (!completedAbruptly) &#123;
            int min &#x3D; allowCoreThreadTimeOut ? 0 : corePoolSize;
            if (min &#x3D;&#x3D; 0 &amp;&amp; ! workQueue.isEmpty())
                min &#x3D; 1;
            if (workerCountOf(c) &gt;&#x3D; min)
                return; &#x2F;&#x2F; replacement not needed
        &#125;
        addWorker(null, false);
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>至此，processWorkerExit执行完之后，工作线程被销毁，以上就是整个工作线程的生命周期，从execute方法开始，Worker使用ThreadFactory创建新的工作线程，runWorker通过getTask获取任务，然后执行任务，如果getTask返回null，进入processWorkerExit方法，整个线程结束，如图所示：</p>
<p><img src="http://www.ideabuffer.cn/2017/04/04/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E7%BA%BF%E7%A8%8B%E6%B1%A0%EF%BC%9AThreadPoolExecutor/threadpool-lifecycle.png" alt="threadpool-lifecycle.png"></p>
<h3 id="tryTerminate方法"><a href="#tryTerminate方法" class="headerlink" title="tryTerminate方法"></a>tryTerminate方法</h3><p>tryTerminate方法根据线程池状态进行判断是否结束线程池，代码如下：</p>
<pre class="line-numbers language-none"><code class="language-none">final void tryTerminate() &#123;
    for (;;) &#123;
        int c &#x3D; ctl.get();
        &#x2F;*
         * 当前线程池的状态为以下几种情况时，直接返回：
         * 1. RUNNING，因为还在运行中，不能停止；
         * 2. TIDYING或TERMINATED，因为线程池中已经没有正在运行的线程了；
         * 3. SHUTDOWN并且等待队列非空，这时要执行完workQueue中的task；
         *&#x2F;
        if (isRunning(c) ||
            runStateAtLeast(c, TIDYING) ||
            (runStateOf(c) &#x3D;&#x3D; SHUTDOWN &amp;&amp; ! workQueue.isEmpty()))
            return;
        &#x2F;&#x2F; 如果线程数量不为0，则中断一个空闲的工作线程，并返回
        if (workerCountOf(c) !&#x3D; 0) &#123; &#x2F;&#x2F; Eligible to terminate
            interruptIdleWorkers(ONLY_ONE);
            return;
        &#125;

        final ReentrantLock mainLock &#x3D; this.mainLock;
        mainLock.lock();
        try &#123;
            &#x2F;&#x2F; 这里尝试设置状态为TIDYING，如果设置成功，则调用terminated方法
            if (ctl.compareAndSet(c, ctlOf(TIDYING, 0))) &#123;
                try &#123;
                    &#x2F;&#x2F; terminated方法默认什么都不做，留给子类实现
                    terminated();
                &#125; finally &#123;
                    &#x2F;&#x2F; 设置状态为TERMINATED
                    ctl.set(ctlOf(TERMINATED, 0));
                    termination.signalAll();
                &#125;
                return;
            &#125;
        &#125; finally &#123;
            mainLock.unlock();
        &#125;
        &#x2F;&#x2F; else retry on failed CAS
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>interruptIdleWorkers(ONLY_ONE);</code>的作用是因为在getTask方法中执行<code>workQueue.take()</code>时，如果不执行中断会一直阻塞。在下面介绍的shutdown方法中，会中断所有空闲的工作线程，如果在执行shutdown时工作线程没有空闲，然后又去调用了getTask方法，这时如果workQueue中没有任务了，调用<code>workQueue.take()</code>时就会一直阻塞。所以每次在工作线程结束时调用tryTerminate方法来尝试中断一个空闲工作线程，避免在队列为空时取任务一直阻塞的情况。</p>
<h3 id="shutdown方法"><a href="#shutdown方法" class="headerlink" title="shutdown方法"></a>shutdown方法</h3><p>shutdown方法要将线程池切换到SHUTDOWN状态，并调用interruptIdleWorkers方法请求中断所有空闲的worker，最后调用tryTerminate尝试结束线程池。</p>
<pre class="line-numbers language-none"><code class="language-none">public void shutdown() &#123;
    final ReentrantLock mainLock &#x3D; this.mainLock;
    mainLock.lock();
    try &#123;
        &#x2F;&#x2F; 安全策略判断
        checkShutdownAccess();
        &#x2F;&#x2F; 切换状态为SHUTDOWN
        advanceRunState(SHUTDOWN);
        &#x2F;&#x2F; 中断空闲线程
        interruptIdleWorkers();
        onShutdown(); &#x2F;&#x2F; hook for ScheduledThreadPoolExecutor
    &#125; finally &#123;
        mainLock.unlock();
    &#125;
    &#x2F;&#x2F; 尝试结束线程池
    tryTerminate();
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里思考一个问题：在runWorker方法中，执行任务时对Worker对象w进行了lock操作，为什么要在执行任务的时候对每个工作线程都加锁呢？</p>
<p>下面仔细分析一下：</p>
<ul>
<li>在getTask方法中，如果这时线程池的状态是SHUTDOWN并且workQueue为空，那么就应该返回null来结束这个工作线程，而使线程池进入SHUTDOWN状态需要调用shutdown方法；</li>
<li>shutdown方法会调用interruptIdleWorkers来中断空闲的线程，interruptIdleWorkers持有mainLock，会遍历workers来逐个判断工作线程是否空闲。但getTask方法中没有mainLock；</li>
<li>在getTask中，如果判断当前线程池状态是RUNNING，并且阻塞队列为空，那么会调用<code>workQueue.take()</code>进行阻塞；</li>
<li>如果在判断当前线程池状态是RUNNING后，这时调用了shutdown方法把状态改为了SHUTDOWN，这时如果不进行中断，那么当前的工作线程在调用了<code>workQueue.take()</code>后会一直阻塞而不会被销毁，因为在SHUTDOWN状态下不允许再有新的任务添加到workQueue中，这样一来线程池永远都关闭不了了；</li>
<li>由上可知，shutdown方法与getTask方法（从队列中获取任务时）存在竞态条件；</li>
<li>解决这一问题就需要用到线程的中断，也就是为什么要用interruptIdleWorkers方法。在调用<code>workQueue.take()</code>时，如果发现当前线程在执行之前或者执行期间是中断状态，则会抛出InterruptedException，解除阻塞的状态；</li>
<li>但是要中断工作线程，还要判断工作线程是否是空闲的，如果工作线程正在处理任务，就不应该发生中断；</li>
<li>所以Worker继承自AQS，在工作线程处理任务时会进行lock，interruptIdleWorkers在进行中断时会使用tryLock来判断该工作线程是否正在处理任务，如果tryLock返回true，说明该工作线程当前未执行任务，这时才可以被中断。</li>
</ul>
<p>下面就来分析一下interruptIdleWorkers方法。</p>
<h3 id="interruptIdleWorkers方法"><a href="#interruptIdleWorkers方法" class="headerlink" title="interruptIdleWorkers方法"></a>interruptIdleWorkers方法</h3><pre class="line-numbers language-none"><code class="language-none">private void interruptIdleWorkers() &#123;
    interruptIdleWorkers(false);
&#125;

private void interruptIdleWorkers(boolean onlyOne) &#123;
    final ReentrantLock mainLock &#x3D; this.mainLock;
    mainLock.lock();
    try &#123;
        for (Worker w : workers) &#123;
            Thread t &#x3D; w.thread;
            if (!t.isInterrupted() &amp;&amp; w.tryLock()) &#123;
                try &#123;
                    t.interrupt();
                &#125; catch (SecurityException ignore) &#123;
                &#125; finally &#123;
                    w.unlock();
                &#125;
            &#125;
            if (onlyOne)
                break;
        &#125;
    &#125; finally &#123;
        mainLock.unlock();
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>interruptIdleWorkers遍历workers中所有的工作线程，若线程没有被中断tryLock成功，就中断该线程。</p>
<p>为什么需要持有mainLock？因为workers是HashSet类型的，不能保证线程安全。</p>
<h3 id="shutdownNow方法"><a href="#shutdownNow方法" class="headerlink" title="shutdownNow方法"></a>shutdownNow方法</h3><pre class="line-numbers language-none"><code class="language-none">public List&lt;Runnable&gt; shutdownNow() &#123;
    List&lt;Runnable&gt; tasks;
    final ReentrantLock mainLock &#x3D; this.mainLock;
    mainLock.lock();
    try &#123;
        checkShutdownAccess();
        advanceRunState(STOP);
        &#x2F;&#x2F; 中断所有工作线程，无论是否空闲
        interruptWorkers();
        &#x2F;&#x2F; 取出队列中没有被执行的任务
        tasks &#x3D; drainQueue();
    &#125; finally &#123;
        mainLock.unlock();
    &#125;
    tryTerminate();
    return tasks;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>shutdownNow方法与shutdown方法类似，不同的地方在于：</p>
<ol>
<li>设置状态为STOP；</li>
<li>中断所有工作线程，无论是否是空闲的；</li>
<li>取出阻塞队列中没有被执行的任务并返回。</li>
</ol>
<p>shutdownNow方法执行完之后调用tryTerminate方法，该方法在上文已经分析过了，目的就是使线程池的状态设置为TERMINATED。</p>
<h2 id="线程池的监控"><a href="#线程池的监控" class="headerlink" title="线程池的监控"></a>线程池的监控</h2><p>通过线程池提供的参数进行监控。线程池里有一些属性在监控线程池的时候可以使用</p>
<ul>
<li><strong>getTaskCount</strong>：线程池已经执行的和未执行的任务总数；</li>
<li><strong>getCompletedTaskCount</strong>：线程池已完成的任务数量，该值小于等于taskCount；</li>
<li><strong>getLargestPoolSize</strong>：线程池曾经创建过的最大线程数量。通过这个数据可以知道线程池是否满过，也就是达到了maximumPoolSize；</li>
<li><strong>getPoolSize</strong>：线程池当前的线程数量；</li>
<li><strong>getActiveCount</strong>：当前线程池中正在执行任务的线程数量。</li>
</ul>
<p>通过这些方法，可以对线程池进行监控，在ThreadPoolExecutor类中提供了几个空方法，如beforeExecute方法，afterExecute方法和terminated方法，可以扩展这些方法在执行前或执行后增加一些新的操作，例如统计线程池的执行任务的时间等，可以继承自ThreadPoolExecutor来进行扩展。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文比较详细的分析了线程池的工作流程，总体来说有如下几个内容：</p>
<ul>
<li>分析了线程的创建，任务的提交，状态的转换以及线程池的关闭；</li>
<li>这里通过execute方法来展开线程池的工作流程，execute方法通过corePoolSize，maximumPoolSize以及阻塞队列的大小来判断决定传入的任务应该被立即执行，还是应该添加到阻塞队列中，还是应该拒绝任务。</li>
<li>介绍了线程池关闭时的过程，也分析了shutdown方法与getTask方法存在竞态条件；</li>
<li>在获取任务时，要通过线程池的状态来判断应该结束工作线程还是阻塞线程等待新的任务，也解释了为什么关闭线程池时要中断工作线程以及为什么每一个worker都需要lock。</li>
</ul>
<p>在向线程池提交任务时，除了execute方法，还有一个submit方法，submit方法会返回一个Future对象用于获取返回值，有关Future和Callable请自行了解一下相关的文章，这里就不介绍了。</p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>线程池</tag>
      </tags>
  </entry>
  <entry>
    <title>Kube-Prometheus监控MySQL（二）</title>
    <url>/2023/05/06/k8s/kube-prometheus-jian-kong-mysql/</url>
    <content><![CDATA[<h2 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h2><p>本文介绍如何使用 Kube-Prometheus 监控 MySQL 数据库。通过部署 MySQL Exporter，将 MySQL 的性能指标暴露给 Prometheus 进行采集和监控。</p>
<p><strong>核心组件：</strong></p>
<ul>
<li><strong>MySQL Exporter</strong>：用于暴露 MySQL 指标的 Exporter（镜像版本：v0.14.0）</li>
<li><strong>ServiceMonitor</strong>：Prometheus Operator 的 CRD，用于服务发现和指标采集配置</li>
</ul>
<h2 id="二、部署-MySQL-Exporter"><a href="#二、部署-MySQL-Exporter" class="headerlink" title="二、部署 MySQL Exporter"></a>二、部署 MySQL Exporter</h2><h3 id="2-1-创建-Deployment"><a href="#2-1-创建-Deployment" class="headerlink" title="2.1 创建 Deployment"></a>2.1 创建 Deployment</h3><p>通过 Deployment 部署 MySQL Exporter，需要配置数据库连接信息。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token comment">#设置唯一名称，建议添加数据库实例ip</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span>  mysql<span class="token punctuation">-</span>exporter<span class="token punctuation">-</span>172.16.1.77 
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> exporter
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>exporter
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> v0.14.0
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> exporter
      <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>exporter
      <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> exporter
        <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>exporter
        <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus
        <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> v0.14.0
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>exporter
          <span class="token key atrule">image</span><span class="token punctuation">:</span> prom/mysqld<span class="token punctuation">-</span>exporter<span class="token punctuation">:</span>v0.14.0
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DATA_SOURCE_NAME
              <span class="token comment"># 格式：用户名:密码@(数据库地址:端口)/</span>
              <span class="token comment"># 示例：root:password@(mysql-service.share-components:3306)/</span>
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"root:password@(mysql-service.share-components:3306)/"</span>
          <span class="token key atrule">resources</span><span class="token punctuation">:</span>
            <span class="token key atrule">requests</span><span class="token punctuation">:</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 20m
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 20Mi
            <span class="token key atrule">limits</span><span class="token punctuation">:</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 30Mi
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9104</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> http
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> localtime
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/localtime
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> localtime
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /usr/share/zoneinfo/Asia/Shanghai
      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>配置说明：</strong></p>
<ul>
<li><code>DATA_SOURCE_NAME</code>：MySQL 连接串，需替换为实际的用户名、密码和地址</li>
<li><code>resources</code>：资源限制，根据实际监控规模调整</li>
<li><code>volumeMounts</code>：挂载宿主机时区文件，确保容器时区正确</li>
</ul>
<h3 id="2-2-创建-Service"><a href="#2-2-创建-Service" class="headerlink" title="2.2 创建 Service"></a>2.2 创建 Service</h3><p>为 MySQL Exporter 创建 Service，暴露监控端口。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>exporter
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> exporter
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>exporter
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> v0.14.0
    <span class="token key atrule">platform</span><span class="token punctuation">:</span> mos
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> exporter
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>exporter
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9104</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> http
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>配置说明：</strong></p>
<ul>
<li><code>port: 9104</code>：MySQL Exporter 默认暴露端口</li>
<li><code>platform: mos</code>：自定义标签，用于区分不同环境</li>
</ul>
<h3 id="2-3-创建-ServiceMonitor"><a href="#2-3-创建-ServiceMonitor" class="headerlink" title="2.3 创建 ServiceMonitor"></a>2.3 创建 ServiceMonitor</h3><p>ServiceMonitor 用于告诉 Prometheus 如何采集 MySQL Exporter 的指标。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> monitoring.coreos.com/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceMonitor
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> exporter
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>exporter
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> v0.14.0
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>exporter
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">interval</span><span class="token punctuation">:</span> 15s
      <span class="token key atrule">port</span><span class="token punctuation">:</span> http
      <span class="token key atrule">relabelings</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">action</span><span class="token punctuation">:</span> replace
          <span class="token key atrule">regex</span><span class="token punctuation">:</span> (.<span class="token important">*)</span>
          <span class="token key atrule">replacement</span><span class="token punctuation">:</span> $1
          <span class="token key atrule">sourceLabels</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> __meta_kubernetes_pod_node_name
          <span class="token key atrule">targetLabel</span><span class="token punctuation">:</span> instance
      <span class="token key atrule">scheme</span><span class="token punctuation">:</span> http
  <span class="token key atrule">jobLabel</span><span class="token punctuation">:</span> app.kubernetes.io/name
  <span class="token key atrule">targetLabels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>platform<span class="token punctuation">]</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> exporter
      <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>exporter
      <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>配置说明：</strong></p>
<ul>
<li><code>interval: 15s</code>：每 15 秒采集一次指标</li>
<li><code>relabelings</code>：指标重写规则，将 Pod 节点名作为 instance 标签值</li>
<li><code>targetLabels</code>：将 Service 的 <code>platform</code> 标签添加到采集的指标中</li>
</ul>
<h2 id="三、验证部署"><a href="#三、验证部署" class="headerlink" title="三、验证部署"></a>三、验证部署</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看 Deployment 状态</span>
kubectl get deployment mysql-exporter-172.16.1.77 <span class="token parameter variable">-n</span> monitoring

<span class="token comment"># 查看 Pod 日志</span>
kubectl logs <span class="token parameter variable">-f</span> <span class="token operator">&lt;</span>pod-name<span class="token operator">></span> <span class="token parameter variable">-n</span> monitoring

<span class="token comment"># 访问 Exporter 指标接口</span>
kubectl port-forward svc/mysql-exporter <span class="token number">9104</span>:9104 <span class="token parameter variable">-n</span> monitoring
<span class="token function">curl</span> http://localhost:9104/metrics<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="四、监控指标说明"><a href="#四、监控指标说明" class="headerlink" title="四、监控指标说明"></a>四、监控指标说明</h2><p>MySQL Exporter 提供的核心监控指标：</p>
<ul>
<li><code>mysql_up</code>：MySQL 实例是否可用</li>
<li><code>mysql_global_status_threads_connected</code>：当前连接数</li>
<li><code>mysql_global_status_queries</code>：查询总数</li>
<li><code>mysql_global_status_slow_queries</code>：慢查询数量</li>
<li><code>mysql_global_variables_max_connections</code>：最大连接数配置</li>
</ul>
<h2 id="五、注意事项"><a href="#五、注意事项" class="headerlink" title="五、注意事项"></a>五、注意事项</h2><ol>
<li><strong>数据库权限</strong>：MySQL Exporter 需要的最小权限为 <code>PROCESS, REPLICATION CLIENT, SELECT</code></li>
<li><strong>多实例监控</strong>：监控多个 MySQL 实例时，需为每个实例创建独立的 Deployment，通过 name 区分</li>
<li><strong>安全配置</strong>：生产环境建议使用 Secret 存储数据库密码，而非明文配置</li>
</ol>
]]></content>
      <categories>
        <category>k8s</category>
      </categories>
      <tags>
        <tag>k8s</tag>
        <tag>Prometheus</tag>
        <tag>exporter</tag>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring类加载顺序异常Bug排查</title>
    <url>/2023/10/10/java/spring-lei-jia-zai-shun-xu-yi-chang-bug-pai-cha/</url>
    <content><![CDATA[<h1 id="一、背景简介"><a href="#一、背景简介" class="headerlink" title="一、背景简介"></a>一、背景简介</h1><p>项目代码通过Jenkins自动打包构建，自动在测试环境部署时出现报错，但是该项目在本地IDEA中能够正常启动。报错信息如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Exception</span> in thread <span class="token string">"main"</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span></span>BeanCreationException</span><span class="token operator">:</span> <span class="token class-name">Error</span> creating bean <span class="token keyword">with</span> <span class="token namespace">name</span> 'nMetaWebServiceImpl'<span class="token operator">:</span> <span class="token class-name">Invocation</span> of init method failed<span class="token punctuation">;</span> nested exception is <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>NullPointerException</span>
    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span>InitDestroyAnnotationBeanPostProcessor</span><span class="token punctuation">.</span><span class="token function">postProcessBeforeInitialization</span><span class="token punctuation">(</span><span class="token class-name">InitDestroyAnnotationBeanPostProcessor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">136</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span>AbstractAutowireCapableBeanFactory</span><span class="token punctuation">.</span><span class="token function">applyBeanPostProcessorsBeforeInitialization</span><span class="token punctuation">(</span><span class="token class-name">AbstractAutowireCapableBeanFactory</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">408</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span>AbstractAutowireCapableBeanFactory</span><span class="token punctuation">.</span><span class="token function">initializeBean</span><span class="token punctuation">(</span><span class="token class-name">AbstractAutowireCapableBeanFactory</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1570</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span>AbstractAutowireCapableBeanFactory</span><span class="token punctuation">.</span><span class="token function">doCreateBean</span><span class="token punctuation">(</span><span class="token class-name">AbstractAutowireCapableBeanFactory</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">545</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span>AbstractAutowireCapableBeanFactory</span><span class="token punctuation">.</span><span class="token function">createBean</span><span class="token punctuation">(</span><span class="token class-name">AbstractAutowireCapableBeanFactory</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">482</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span>AbstractBeanFactory</span>$<span class="token number">1.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanFactory</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">306</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span>DefaultSingletonBeanRegistry</span><span class="token punctuation">.</span><span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token class-name">DefaultSingletonBeanRegistry</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">230</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span>AbstractBeanFactory</span><span class="token punctuation">.</span><span class="token function">doGetBean</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanFactory</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">302</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span>AbstractBeanFactory</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanFactory</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">197</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span>DefaultListableBeanFactory</span><span class="token punctuation">.</span><span class="token function">preInstantiateSingletons</span><span class="token punctuation">(</span><span class="token class-name">DefaultListableBeanFactory</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">772</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span>AbstractApplicationContext</span><span class="token punctuation">.</span><span class="token function">finishBeanFactoryInitialization</span><span class="token punctuation">(</span><span class="token class-name">AbstractApplicationContext</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">839</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span>AbstractApplicationContext</span><span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token class-name">AbstractApplicationContext</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">538</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span>ClassPathXmlApplicationContext</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span>init<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">139</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span>ClassPathXmlApplicationContext</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span>init<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">83</span><span class="token punctuation">)</span>
    at <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">.</span>RestServer<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">RestServer</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">25</span><span class="token punctuation">)</span>
<span class="token class-name">Caused</span> by<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>NullPointerException</span>
    at <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">.</span>webservice<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>NMetaWebServiceImpl<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">NMetaWebServiceImpl</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">31</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>NativeMethodAccessorImpl</span><span class="token punctuation">.</span><span class="token function">invoke0</span><span class="token punctuation">(</span><span class="token class-name">Native</span> <span class="token class-name">Method</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>NativeMethodAccessorImpl</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">NativeMethodAccessorImpl</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">62</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>DelegatingMethodAccessorImpl</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">DelegatingMethodAccessorImpl</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">43</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>Method</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Method</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">498</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span>InitDestroyAnnotationBeanPostProcessor</span>$<span class="token class-name">LifecycleElement</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">InitDestroyAnnotationBeanPostProcessor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">354</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span>InitDestroyAnnotationBeanPostProcessor</span>$<span class="token class-name">LifecycleMetadata</span><span class="token punctuation">.</span><span class="token function">invokeInitMethods</span><span class="token punctuation">(</span><span class="token class-name">InitDestroyAnnotationBeanPostProcessor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">305</span><span class="token punctuation">)</span>
    at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span>InitDestroyAnnotationBeanPostProcessor</span><span class="token punctuation">.</span><span class="token function">postProcessBeforeInitialization</span><span class="token punctuation">(</span><span class="token class-name">InitDestroyAnnotationBeanPostProcessor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">133</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">14</span> more<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="1-1-报错代码排查"><a href="#1-1-报错代码排查" class="headerlink" title="1.1 报错代码排查"></a>1.1 报错代码排查</h2><p>根据上述报错堆栈信息，找到项目报错的代码，如下：<br><img src="/2023/10/10/java/spring-lei-jia-zai-shun-xu-yi-chang-bug-pai-cha/image2023-10-7_1-14-2.png" alt="报错源码1"><br><img src="/2023/10/10/java/spring-lei-jia-zai-shun-xu-yi-chang-bug-pai-cha/image2023-10-7_1-13-14.png" alt="报错源码2"></p>
<h1 id="二、问题排查"><a href="#二、问题排查" class="headerlink" title="二、问题排查"></a>二、问题排查</h1><p>由于该错误在不同环境下出现，且为开发环境，所以开启远程Debug定位问题原因。</p>
<h2 id="2-1-开启远程Debug"><a href="#2-1-开启远程Debug" class="headerlink" title="2.1 开启远程Debug"></a>2.1 开启远程Debug</h2><p>在本地IDEA中开启远程Debug进行问题排查。</p>
<h3 id="2-1-1-服务端配置"><a href="#2-1-1-服务端配置" class="headerlink" title="2.1.1 服务端配置"></a>2.1.1 服务端配置</h3><p>服务端的启动脚本添加如下配启动参数：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">-</span>agentlib<span class="token operator">:</span>jdwp<span class="token operator">=</span>transport<span class="token operator">=</span>dt_socket<span class="token punctuation">,</span>server<span class="token operator">=</span>y<span class="token punctuation">,</span>suspend<span class="token operator">=</span>n<span class="token punctuation">,</span>address<span class="token operator">=</span><span class="token number">5005</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="/2023/10/10/java/spring-lei-jia-zai-shun-xu-yi-chang-bug-pai-cha/image2023-10-9_15-13-48.png" alt="远程Debug参数"></p>
<h3 id="2-1-2-本地配置"><a href="#2-1-2-本地配置" class="headerlink" title="2.1.2 本地配置"></a>2.1.2 本地配置</h3><p>IDEA中创建一个Remote JVM Debug：<br><img src="/2023/10/10/java/spring-lei-jia-zai-shun-xu-yi-chang-bug-pai-cha/image2023-10-9_15-14-38.png" alt="远程Debug本地配置"></p>
<h2 id="2-2-远程Debug排查问题"><a href="#2-2-远程Debug排查问题" class="headerlink" title="2.2 远程Debug排查问题"></a>2.2 远程Debug排查问题</h2><p>通过Debug查看类的初始化顺序，部分截图如下：<br><img src="/2023/10/10/java/spring-lei-jia-zai-shun-xu-yi-chang-bug-pai-cha/image2023-9-26_19-23-42.png" alt="远程Debug代码1"><br><img src="/2023/10/10/java/spring-lei-jia-zai-shun-xu-yi-chang-bug-pai-cha/image2023-9-28_11-10-33.png" alt="远程Debug代码2"><br><img src="/2023/10/10/java/spring-lei-jia-zai-shun-xu-yi-chang-bug-pai-cha/image2023-9-28_11-19-29.png" alt="远程Debug代码3"></p>
<h2 id="2-3-排查结论"><a href="#2-3-排查结论" class="headerlink" title="2.3 排查结论"></a>2.3 排查结论</h2><p><strong>测试环境NMetaWebServiceImpl扫描顺序在ApplicationContextKeeper前面，Spring根据Bean的扫描顺序进行类的初始化，由于NMetaWebServiceImpl扫描顺序在ApplicationContextKeeper前面，所以在初始化NMetaWebServiceImpl的过程中由于ApplicationContextKeeper还未初始化，导致空指针问题。</strong></p>
<h1 id="三、本地问题复现"><a href="#三、本地问题复现" class="headerlink" title="三、本地问题复现"></a>三、本地问题复现</h1><p>上述问题仅在通过Jenkins构建的包启动出现问题，本地手动构建的包并无此问题，通过Debug排查本地程序类的初始化情况。<br><img src="/2023/10/10/java/spring-lei-jia-zai-shun-xu-yi-chang-bug-pai-cha/image2023-9-26_19-29-20.png" alt="本地Debug代码1"><br><img src="/2023/10/10/java/spring-lei-jia-zai-shun-xu-yi-chang-bug-pai-cha/image2023-9-28_11-5-55.png" alt="本地Debug代码2"></p>
<h2 id="3-1-排查结论"><a href="#3-1-排查结论" class="headerlink" title="3.1 排查结论"></a>3.1 排查结论</h2><p>在本地IDEA中ApplicationContextKeeper扫描顺序在NMetaWebServiceImpl前面，所以程序启动是正常的。</p>
<h1 id="四、Spring类加载顺序分析"><a href="#四、Spring类加载顺序分析" class="headerlink" title="四、Spring类加载顺序分析"></a>四、Spring类加载顺序分析</h1><p>参考文章：<a href="https://caotc.org/2019/08/20/java-springboot-bean-override/">springboot bean加载顺序问题</a></p>
<h2 id="4-1-Debug追踪Spring类加载顺序"><a href="#4-1-Debug追踪Spring类加载顺序" class="headerlink" title="4.1 Debug追踪Spring类加载顺序"></a>4.1 Debug追踪Spring类加载顺序</h2><p>通过Debug继续追踪类从jar包的加载顺序<br><img src="/2023/10/10/java/spring-lei-jia-zai-shun-xu-yi-chang-bug-pai-cha/image2023-10-8_9-44-28.png" alt="Spring加载类源码1"><br><img src="/2023/10/10/java/spring-lei-jia-zai-shun-xu-yi-chang-bug-pai-cha/image2023-10-8_9-46-22.png" alt="Spring加载类源码1"><br><img src="/2023/10/10/java/spring-lei-jia-zai-shun-xu-yi-chang-bug-pai-cha/image2023-10-8_12-43-50.png" alt="Spring加载类源码1"><br><img src="/2023/10/10/java/spring-lei-jia-zai-shun-xu-yi-chang-bug-pai-cha/image2023-10-8_17-22-18.png" alt="Spring加载类源码1"><br><img src="/2023/10/10/java/spring-lei-jia-zai-shun-xu-yi-chang-bug-pai-cha/image2023-10-8_17-23-26.png" alt="Spring加载类源码1"><br>Jar包中类的加载是一个Native方法，需要看看Native方法的class读取顺序。</p>
<h2 id="4-2-Java-Native方法源码分析"><a href="#4-2-Java-Native方法源码分析" class="headerlink" title="4.2 Java Native方法源码分析"></a>4.2 Java Native方法源码分析</h2><p>这里主要涉及两个C文件：<code>ZipFile.c</code> 和 <code>zip_util.c</code>。</p>
<h3 id="ZipFile-c"><a href="#ZipFile-c" class="headerlink" title="ZipFile.c"></a>ZipFile.c</h3><pre class="line-numbers language-C" data-language="C"><code class="language-C">JNIEXPORT jlong JNICALL
Java_java_util_zip_ZipFile_getNextEntry(JNIEnv *env, jclass cls, jlong zfile,
                                        jint n)
&#123;
    jzentry *ze &#x3D; ZIP_GetNextEntry(jlong_to_ptr(zfile), n);
    return ptr_to_jlong(ze);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="zip-util-c"><a href="#zip-util-c" class="headerlink" title="zip_util.c"></a>zip_util.c</h3><pre class="line-numbers language-C" data-language="C"><code class="language-C">&#x2F;*
 * Returns the n&#39;th (starting at zero) zip file entry, or NULL if the
 * specified index was out of range.
 *&#x2F;
jzentry * JNICALL
ZIP_GetNextEntry(jzfile *zip, jint n)
&#123;
    jzentry *result;
    if (n &lt; 0 || n &gt;&#x3D; zip-&gt;total) &#123;
        return 0;
    &#125;
    ZIP_Lock(zip);
    result &#x3D; newEntry(zip, &amp;zip-&gt;entries[n], ACCESS_SEQUENTIAL);
    ZIP_Unlock(zip);
    return result;
&#125;
 
&#x2F;*
 * Descriptor for a ZIP file.
 *&#x2F;
typedef struct jzfile &#123;   &#x2F;* Zip file *&#x2F;
    char *name;           &#x2F;* zip file name *&#x2F;
    jint refs;            &#x2F;* number of active references *&#x2F;
    jlong len;            &#x2F;* length (in bytes) of zip file *&#x2F;
#ifdef USE_MMAP
    unsigned char *maddr; &#x2F;* beginning address of the CEN &amp; ENDHDR *&#x2F;
    jlong mlen;           &#x2F;* length (in bytes) mmaped *&#x2F;
    jlong offset;         &#x2F;* offset of the mmapped region from the
                             start of the file. *&#x2F;
    jboolean usemmap;     &#x2F;* if mmap is used. *&#x2F;
#endif
    jboolean locsig;      &#x2F;* if zip file starts with LOCSIG *&#x2F;
    cencache cencache;    &#x2F;* CEN header cache *&#x2F;
    ZFILE zfd;            &#x2F;* open file descriptor *&#x2F;
    void *lock;           &#x2F;* read lock *&#x2F;
    char *comment;        &#x2F;* zip file comment *&#x2F;
    jint clen;            &#x2F;* length of the zip file comment *&#x2F;
    char *msg;            &#x2F;* zip error message *&#x2F;
    jzcell *entries;      &#x2F;* array of hash cells *&#x2F;
    jint total;           &#x2F;* total number of entries *&#x2F;
    jint *table;          &#x2F;* Hash chain heads: indexes into entries *&#x2F;
    jint tablelen;        &#x2F;* number of hash heads *&#x2F;
    struct jzfile *next;  &#x2F;* next zip file in search list *&#x2F;
    jzentry *cache;       &#x2F;* we cache the most recently freed jzentry *&#x2F;
    &#x2F;* Information on metadata names in META-INF directory *&#x2F;
    char **metanames;     &#x2F;* array of meta names (may have null names) *&#x2F;
    jint metacurrent;     &#x2F;* the next empty slot in metanames array *&#x2F;
    jint metacount;       &#x2F;* number of slots in metanames array *&#x2F;
    jint manifestNum;     &#x2F;* number of META-INF&#x2F;MANIFEST.MF, case insensitive *&#x2F;
    jlong lastModified;   &#x2F;* last modified time *&#x2F;
    jlong locpos;         &#x2F;* position of first LOC header (usually 0) *&#x2F;
&#125; jzfile;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-3-分析结果"><a href="#4-3-分析结果" class="headerlink" title="4.3 分析结果"></a>4.3 分析结果</h2><p>通过上述Native方法的源码分析，可以看到class文件的顺序依赖于jzcell *entries这个数据结构，猜想到这个数据结构为Jar包构建时类文件的添加顺序。</p>
<h1 id="五、Jar包Class文件顺序分析"><a href="#五、Jar包Class文件顺序分析" class="headerlink" title="五、Jar包Class文件顺序分析"></a>五、Jar包Class文件顺序分析</h1><p>查看测试环境与本地环境的Jar包中Class的顺序。</p>
<h2 id="5-1-测试环境"><a href="#5-1-测试环境" class="headerlink" title="5.1 测试环境"></a>5.1 测试环境</h2><p><img src="/2023/10/10/java/spring-lei-jia-zai-shun-xu-yi-chang-bug-pai-cha/image2023-10-8_17-33-8.png" alt="测试环境"></p>
<h2 id="5-2-本地环境"><a href="#5-2-本地环境" class="headerlink" title="5.2 本地环境"></a>5.2 本地环境</h2><p><img src="/2023/10/10/java/spring-lei-jia-zai-shun-xu-yi-chang-bug-pai-cha/image2023-10-8_17-34-24.png" alt="本地环境"><br><img src="/2023/10/10/java/spring-lei-jia-zai-shun-xu-yi-chang-bug-pai-cha/image2023-10-8_17-34-50.png" alt="本地环境"></p>
<h2 id="5-3-结果分析"><a href="#5-3-结果分析" class="headerlink" title="5.3 结果分析"></a>5.3 结果分析</h2><p>不同环境中的Jar包其中类的添加顺序不一致，而Spring根据Jar包中的类的顺序进行类的初始化，导致测试环境启动报错。</p>
<h1 id="六、Jar包打包Class顺序验证"><a href="#六、Jar包打包Class顺序验证" class="headerlink" title="六、Jar包打包Class顺序验证"></a>六、Jar包打包Class顺序验证</h1><p>根据上述排查结果，我们知道是由于在不同环境下项目中打包的Jar包中Class顺序不一致引起的问题，接下来分析一下为什么不同环境下打包，Class的顺序会不同。</p>
<h2 id="6-1-手动打包验证"><a href="#6-1-手动打包验证" class="headerlink" title="6.1 手动打包验证"></a>6.1 手动打包验证</h2><p>我们知道Jar包的本质是一个压缩包，所以首先验证手动构建压缩包时文件的顺序。</p>
<pre class="line-numbers language-none"><code class="language-none">tar -zcvf mtr-rest.jar .&#x2F;

zip -r mtr.rest.jar .&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>使用tar 命令或zip命令手动制作压缩包,文件按照首字母顺序排序。所以Maven构建Jar包的方式与上述两个命令不同。</p>
<h2 id="6-2-测试环境验证"><a href="#6-2-测试环境验证" class="headerlink" title="6.2 测试环境验证"></a>6.2 测试环境验证</h2><p>在测试服务器上新建一个目录，将项目克隆下来进行打包。<br><img src="/2023/10/10/java/spring-lei-jia-zai-shun-xu-yi-chang-bug-pai-cha/image2023-10-8_18-13-0.png" alt="测试环境Maven打包"></p>
<p>经过验证类的添加顺序是正常的，即在相同的服务器上手动执行Maven打包命令和Jenkins执行Maven打包命令所构建的Jar包中Class的顺序不一致。</p>
<p>在Jenkins工作路径下手动打包,问题复现。<br><img src="/2023/10/10/java/spring-lei-jia-zai-shun-xu-yi-chang-bug-pai-cha/image2023-10-9_14-46-6.png" alt="测试环境Maven打包"></p>
<h2 id="6-3-问题分析"><a href="#6-3-问题分析" class="headerlink" title="6.3 问题分析"></a>6.3 问题分析</h2><p>经过上述验证，发现在服务器的不同路径下进行打包，Jar包中的Class的添加顺序不一致。</p>
<h1 id="七、排查结论"><a href="#七、排查结论" class="headerlink" title="七、排查结论"></a>七、排查结论</h1><p><strong>1.Maven默认使用不稳定的文件系统遍历来收集并构建项目的类。这可能导致在不同操作系统、不同环境或不同构建命令下，类的顺序出现变化。</strong></p>
<p><strong>2.从上述的验证结果来看，项目的父路径将会影响Maven打包类的添加顺序。</strong></p>
<p><strong>3.此外类的依赖顺序应该通过应用层面去保证，而不应该依赖于jar中类的物理路径。</strong></p>
<h1 id="八、解决方案"><a href="#八、解决方案" class="headerlink" title="八、解决方案"></a>八、解决方案</h1><p>上述问题主要是由于两个类之间没有构建依赖关系，正常当按照文件排序的方式实例化两个类时，程序正常运行；但是当打包时，两个类添加到Jar包的物理顺序出现变化，则会出现异常。</p>
<h2 id="8-1-显示添加依赖关系"><a href="#8-1-显示添加依赖关系" class="headerlink" title="8.1 显示添加依赖关系"></a>8.1 显示添加依赖关系</h2><p>在NMetaWebServiceImpl类上使用@DependsOn注解，让ApplicationContextKeeper先于NMetaWebServiceImpl初始化。</p>
<h2 id="8-2-隐式构建依赖关系"><a href="#8-2-隐式构建依赖关系" class="headerlink" title="8.2 隐式构建依赖关系"></a>8.2 隐式构建依赖关系</h2><p>将ApplicationContextKeeper实例注入到NMetaWebServiceImpl，隐式构建类的依赖关系。</p>
<h2 id="8-3-优先初始化"><a href="#8-3-优先初始化" class="headerlink" title="8.3 优先初始化"></a>8.3 优先初始化</h2><p>由于NMetaWebServiceImpl是一个webservice应用，实例对象没有在spring中，而是通过类的静态成员变量进行传递数据，无法直接构建依赖管理，所以在spring中优先实例化ApplicationContextKeeper。</p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>Spring</tag>
        <tag>类加载</tag>
        <tag>Maven</tag>
      </tags>
  </entry>
  <entry>
    <title>Kube-Prometheus监控Nacos（五）</title>
    <url>/2023/05/09/k8s/kube-prometheus-jian-kong-nacos/</url>
    <content><![CDATA[<h2 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h2><p>本文介绍如何使用 Kube-Prometheus 监控 Nacos 服务。Nacos 自带 Prometheus 指标接口，无需额外部署 Exporter，只需通过 Endpoint 和 ServiceMonitor 配置即可实现监控。</p>
<p><strong>监控方式：</strong></p>
<ul>
<li>Nacos 内置了 Micrometer 指标，通过 <code>/nacos/actuator/prometheus</code> 接口暴露</li>
<li>使用 Endpoints 手动指定 Nacos 集群节点 IP</li>
<li>通过 ServiceMonitor 配置 Prometheus 采集规则</li>
</ul>
<h2 id="二、配置部署"><a href="#二、配置部署" class="headerlink" title="二、配置部署"></a>二、配置部署</h2><h3 id="2-1-创建-Endpoints"><a href="#2-1-创建-Endpoints" class="headerlink" title="2.1 创建 Endpoints"></a>2.1 创建 Endpoints</h3><p>由于 Nacos 通常部署在 K8s 集群外部，需要手动创建 Endpoints 指向 Nacos 服务器。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Endpoints
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>exporter
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
<span class="token key atrule">subsets</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">addresses</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">ip</span><span class="token punctuation">:</span> <span class="token comment"># 列举 nacos 的机器的ip1</span>
  <span class="token punctuation">-</span> <span class="token key atrule">ip</span><span class="token punctuation">:</span> <span class="token comment"># 列举 nacos 的机器的ip2 ...</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8848</span>  <span class="token comment"># nacos-exporter 端口</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>配置说明：</strong></p>
<ul>
<li><code>addresses</code>：列举所有 Nacos 集群节点的 IP 地址</li>
<li><code>port: 8848</code>：Nacos 默认端口，也是 Prometheus 指标暴露端口</li>
</ul>
<h3 id="2-2-创建-Service"><a href="#2-2-创建-Service" class="headerlink" title="2.2 创建 Service"></a>2.2 创建 Service</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>exporter
    <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">version</span><span class="token punctuation">:</span> 1.4.4
    <span class="token key atrule">platform</span><span class="token punctuation">:</span> mos
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>exporter
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8848</span>  <span class="token comment"># nacos-exporter 端口</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> http
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>配置说明：</strong></p>
<ul>
<li>Service 不需要 selector，因为它关联的是手动创建的 Endpoints</li>
<li><code>platform: mos</code>：自定义标签，用于环境区分</li>
</ul>
<h3 id="2-3-创建-ServiceMonitor"><a href="#2-3-创建-ServiceMonitor" class="headerlink" title="2.3 创建 ServiceMonitor"></a>2.3 创建 ServiceMonitor</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> monitoring.coreos.com/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceMonitor
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>exporter
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">interval</span><span class="token punctuation">:</span> 15s
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /nacos/actuator/prometheus
    <span class="token key atrule">port</span><span class="token punctuation">:</span> http
  <span class="token key atrule">targetLabels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>platform<span class="token punctuation">]</span>
  <span class="token key atrule">namespaceSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchNames</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> monitoring
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>exporter
      <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>配置说明：</strong></p>
<ul>
<li><code>path: /nacos/actuator/prometheus</code>：Nacos 的 Prometheus 指标路径</li>
<li><code>interval: 15s</code>：每 15 秒采集一次指标</li>
<li><code>targetLabels</code>：将 Service 的 <code>platform</code> 标签添加到采集的指标中</li>
</ul>
<h2 id="三、验证部署"><a href="#三、验证部署" class="headerlink" title="三、验证部署"></a>三、验证部署</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 检查 Endpoints 是否创建成功</span>
kubectl get endpoints nacos-exporter <span class="token parameter variable">-n</span> monitoring

<span class="token comment"># 检查 Service 状态</span>
kubectl get svc nacos-exporter <span class="token parameter variable">-n</span> monitoring

<span class="token comment"># 检查 ServiceMonitor</span>
kubectl get servicemonitor nacos-exporter <span class="token parameter variable">-n</span> monitoring

<span class="token comment"># 测试访问 Nacos 指标接口</span>
<span class="token function">curl</span> http://<span class="token operator">&lt;</span>nacos-ip<span class="token operator">></span>:8848/nacos/actuator/prometheus<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="四、监控指标说明"><a href="#四、监控指标说明" class="headerlink" title="四、监控指标说明"></a>四、监控指标说明</h2><p>Nacos 提供的核心监控指标：</p>
<ul>
<li><code>nacos_monitor&#123;name=&quot;serviceCount&quot;&#125;</code>：服务数量</li>
<li><code>nacos_monitor&#123;name=&quot;instanceCount&quot;&#125;</code>：实例数量</li>
<li><code>nacos_monitor&#123;name=&quot;configCount&quot;&#125;</code>：配置数量</li>
<li><code>nacos_monitor&#123;name=&quot;publishSuccessCount&quot;&#125;</code>：配置发布成功次数</li>
<li><code>nacos_monitor&#123;name=&quot;publishFailCount&quot;&#125;</code>：配置发布失败次数</li>
<li><code>http_server_requests_seconds_*</code>：HTTP 请求的响应时间统计</li>
<li><code>jvm_*</code>：JVM 相关指标（内存、线程、GC 等）</li>
</ul>
<h2 id="五、注意事项"><a href="#五、注意事项" class="headerlink" title="五、注意事项"></a>五、注意事项</h2><ol>
<li><strong>Nacos 版本要求</strong>：Nacos 1.4.0 及以上版本才支持 Prometheus 指标暴露</li>
<li><strong>网络访问</strong>：确保 K8s 集群能够访问 Nacos 服务器的 8848 端口</li>
<li><strong>多节点配置</strong>：Nacos 集群需要在 Endpoints 中列出所有节点 IP</li>
<li><strong>指标路径</strong>：不同 Nacos 版本可能指标路径有差异，请根据实际情况调整</li>
</ol>
]]></content>
      <categories>
        <category>k8s</category>
      </categories>
      <tags>
        <tag>k8s</tag>
        <tag>Prometheus</tag>
        <tag>exporter</tag>
        <tag>Nacos</tag>
      </tags>
  </entry>
  <entry>
    <title>Kube-Prometheus监控Redis（三）</title>
    <url>/2023/05/07/k8s/kube-prometheus-jian-kong-redis/</url>
    <content><![CDATA[<h2 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h2><p>本文介绍如何使用 Kube-Prometheus 监控 Redis。通过部署 Redis Exporter，将 Redis 的性能指标暴露给 Prometheus 进行采集和监控。</p>
<p><strong>核心组件：</strong></p>
<ul>
<li><strong>Redis Exporter</strong>：用于暴露 Redis 指标的 Exporter（镜像版本：v1.37.0）</li>
<li><strong>ServiceMonitor</strong>：Prometheus Operator 的 CRD，用于服务发现和指标采集配置</li>
</ul>
<h2 id="二、部署-Redis-Exporter"><a href="#二、部署-Redis-Exporter" class="headerlink" title="二、部署 Redis Exporter"></a>二、部署 Redis Exporter</h2><h3 id="2-1-创建-Deployment"><a href="#2-1-创建-Deployment" class="headerlink" title="2.1 创建 Deployment"></a>2.1 创建 Deployment</h3><p>通过 Deployment 部署 Redis Exporter，需要配置 Redis 连接信息。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token comment">#设置唯一名称，建议添加数据库实例ip</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span>  redis<span class="token punctuation">-</span>exporter<span class="token punctuation">-</span>172.16.1.77
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> exporter
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>exporter
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.37.0
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> exporter
      <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>exporter
      <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> exporter
        <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>exporter
        <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus
        <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.37.0
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>exporter
          <span class="token key atrule">image</span><span class="token punctuation">:</span> oliver006/redis_exporter<span class="token punctuation">:</span>v1.37.0
          <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"-redis.addr"</span><span class="token punctuation">,</span><span class="token string">"redis://cpaas-redis-cluster.share-components:6379"</span><span class="token punctuation">,</span><span class="token string">"-redis.password"</span><span class="token punctuation">,</span><span class="token string">"AoSshx9Drq"</span><span class="token punctuation">]</span>
          <span class="token key atrule">resources</span><span class="token punctuation">:</span>
            <span class="token key atrule">requests</span><span class="token punctuation">:</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 20m
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 20Mi
            <span class="token key atrule">limits</span><span class="token punctuation">:</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 30Mi
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9121</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> http
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> localtime
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/localtime
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> localtime
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /usr/share/zoneinfo/Asia/Shanghai
      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>配置说明：</strong></p>
<ul>
<li><code>args</code>：Redis Exporter 启动参数<ul>
<li><code>-redis.addr</code>：Redis 地址，支持单机和集群模式</li>
<li><code>-redis.password</code>：Redis 密码（建议使用 Secret 管理）</li>
</ul>
</li>
<li><code>port: 9121</code>：Redis Exporter 默认暴露端口</li>
<li><code>resources</code>：资源限制，根据实际监控规模调整</li>
</ul>
<h3 id="2-2-创建-Service"><a href="#2-2-创建-Service" class="headerlink" title="2.2 创建 Service"></a>2.2 创建 Service</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>exporter
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> exporter
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>exporter
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.37.0
    <span class="token key atrule">platform</span><span class="token punctuation">:</span> mos
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> exporter
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>exporter
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9121</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> http<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>配置说明：</strong></p>
<ul>
<li><code>platform: mos</code>：自定义标签，用于区分不同环境</li>
</ul>
<h3 id="2-3-创建-ServiceMonitor"><a href="#2-3-创建-ServiceMonitor" class="headerlink" title="2.3 创建 ServiceMonitor"></a>2.3 创建 ServiceMonitor</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> monitoring.coreos.com/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceMonitor
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> exporter
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>exporter
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 1.37.0
  <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>exporter
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>  <span class="token comment"># 指标采集配置</span>
    <span class="token punctuation">-</span> <span class="token key atrule">interval</span><span class="token punctuation">:</span> 15s <span class="token comment"># 每 15 秒采集一次</span>
      <span class="token key atrule">port</span><span class="token punctuation">:</span> http    <span class="token comment"># Service 定义的 port 名称</span>
      <span class="token key atrule">relabelings</span><span class="token punctuation">:</span>  <span class="token comment"># 指标重写规则</span>
        <span class="token punctuation">-</span> <span class="token key atrule">action</span><span class="token punctuation">:</span> replace
          <span class="token key atrule">regex</span><span class="token punctuation">:</span> (.<span class="token important">*)</span>
          <span class="token key atrule">replacement</span><span class="token punctuation">:</span> $1
          <span class="token key atrule">sourceLabels</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> __meta_kubernetes_pod_node_name
          <span class="token key atrule">targetLabel</span><span class="token punctuation">:</span> instance
      <span class="token key atrule">scheme</span><span class="token punctuation">:</span> http
  <span class="token key atrule">jobLabel</span><span class="token punctuation">:</span> app.kubernetes.io/name
  <span class="token key atrule">targetLabels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>platform<span class="token punctuation">]</span>
  <span class="token key atrule">namespaceSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchNames</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> monitoring
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># 选择器，告诉 Prometheus 如何获取目标 Pod</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> exporter
      <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>exporter
      <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>配置说明：</strong></p>
<ul>
<li><code>interval: 15s</code>：每 15 秒采集一次指标</li>
<li><code>relabelings</code>：指标重写规则，将 Pod 节点名作为 instance 标签值</li>
<li><code>targetLabels</code>：将 Service 的 <code>platform</code> 标签添加到采集的指标中</li>
</ul>
<h2 id="三、验证部署"><a href="#三、验证部署" class="headerlink" title="三、验证部署"></a>三、验证部署</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看 Deployment 状态</span>
kubectl get deployment redis-exporter-172.16.1.77 <span class="token parameter variable">-n</span> monitoring

<span class="token comment"># 查看 Pod 日志</span>
kubectl logs <span class="token parameter variable">-f</span> <span class="token operator">&lt;</span>pod-name<span class="token operator">></span> <span class="token parameter variable">-n</span> monitoring

<span class="token comment"># 访问 Exporter 指标接口</span>
kubectl port-forward svc/redis-exporter <span class="token number">9121</span>:9121 <span class="token parameter variable">-n</span> monitoring
<span class="token function">curl</span> http://localhost:9121/metrics<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="四、监控指标说明"><a href="#四、监控指标说明" class="headerlink" title="四、监控指标说明"></a>四、监控指标说明</h2><p>Redis Exporter 提供的核心监控指标：</p>
<ul>
<li><code>redis_up</code>：Redis 实例是否可用</li>
<li><code>redis_connected_clients</code>：已连接客户端数量</li>
<li><code>redis_used_memory_bytes</code>：内存使用量</li>
<li><code>redis_commands_processed_total</code>：命令处理总数</li>
<li><code>redis_keyspace_hits_total</code>：缓存命中次数</li>
<li><code>redis_keyspace_misses_total</code>：缓存未命中次数</li>
<li><code>redis_evicted_keys_total</code>：被逐出的 key 数量</li>
</ul>
<h2 id="五、注意事项"><a href="#五、注意事项" class="headerlink" title="五、注意事项"></a>五、注意事项</h2><ol>
<li><strong>Redis 集群监控</strong>：监控 Redis 集群时，只需配置任意一个节点地址，Exporter 会自动发现整个集群</li>
<li><strong>密码安全</strong>：生产环境建议使用 Secret 存储 Redis 密码，而非明文配置</li>
<li><strong>多实例监控</strong>：监控多个 Redis 实例时，需为每个实例创建独立的 Deployment</li>
<li><strong>性能影响</strong>：Exporter 采集指标会执行 <code>INFO</code> 命令，对 Redis 性能影响极小</li>
</ol>
]]></content>
      <categories>
        <category>k8s</category>
      </categories>
      <tags>
        <tag>k8s</tag>
        <tag>Prometheus</tag>
        <tag>exporter</tag>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>Kube-Prometheus监控RocketMQ（四）</title>
    <url>/2023/05/08/k8s/kube-prometheus-jian-kong-rocketmq/</url>
    <content><![CDATA[<h2 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h2><p>本文介绍如何使用 Kube-Prometheus 监控 RocketMQ。通过部署 RocketMQ Exporter，将 RocketMQ 的消息队列指标暴露给 Prometheus 进行采集和监控。</p>
<p><strong>核心组件：</strong></p>
<ul>
<li><strong>RocketMQ Exporter</strong>：用于暴露 RocketMQ 指标的 Exporter</li>
<li><strong>ServiceMonitor</strong>：Prometheus Operator 的 CRD，用于服务发现和指标采集配置</li>
</ul>
<h2 id="二、部署-RocketMQ-Exporter"><a href="#二、部署-RocketMQ-Exporter" class="headerlink" title="二、部署 RocketMQ Exporter"></a>二、部署 RocketMQ Exporter</h2><h3 id="2-1-创建-Deployment"><a href="#2-1-创建-Deployment" class="headerlink" title="2.1 创建 Deployment"></a>2.1 创建 Deployment</h3><p>通过 Deployment 部署 RocketMQ Exporter，需要配置 NameServer 地址。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
   <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> exporter
   <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>exporter
   <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus
  <span class="token key atrule">name</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>exporter
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">progressDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">600</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> exporter
      <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>exporter
      <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> 25%
      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> 25%
    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> exporter
        <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>exporter
        <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">args</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token string">'--rocketmq.config.namesrvAddr=172.16.15.121:9876'</span>
          <span class="token key atrule">image</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>exporter<span class="token punctuation">:</span>latest
          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always
          <span class="token key atrule">name</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>exporter
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">5557</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> http
              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
          <span class="token key atrule">resources</span><span class="token punctuation">:</span>
            <span class="token key atrule">limits</span><span class="token punctuation">:</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 500m
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1024Mi
            <span class="token key atrule">requests</span><span class="token punctuation">:</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 10m
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 512Mi
          <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log
          <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /home/exporter/logs
              <span class="token key atrule">name</span><span class="token punctuation">:</span> exporter<span class="token punctuation">-</span>log
            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/localtime
              <span class="token key atrule">name</span><span class="token punctuation">:</span> date<span class="token punctuation">-</span>config
      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst
      <span class="token key atrule">imagePullSecrets</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>secret<span class="token punctuation">-</span>harbor
      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always
      <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>scheduler
      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> exporter<span class="token punctuation">-</span>log
        <span class="token punctuation">-</span> <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/localtime
            <span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">''</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> date<span class="token punctuation">-</span>config
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>配置说明：</strong></p>
<ul>
<li><code>args</code>：RocketMQ Exporter 启动参数<ul>
<li><code>--rocketmq.config.namesrvAddr</code>：RocketMQ NameServer 地址，多个地址用分号分隔</li>
</ul>
</li>
<li><code>port: 5557</code>：RocketMQ Exporter 默认暴露端口</li>
<li><code>imagePullSecrets</code>：私有镜像仓库的认证信息</li>
<li><code>resources</code>：资源限制，根据监控的 RocketMQ 规模调整</li>
</ul>
<h3 id="2-2-创建-Service"><a href="#2-2-创建-Service" class="headerlink" title="2.2 创建 Service"></a>2.2 创建 Service</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> monitoring.coreos.com/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceMonitor
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> exporter
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>exporter
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus
  <span class="token key atrule">name</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>exporter
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">interval</span><span class="token punctuation">:</span> 15s
      <span class="token key atrule">port</span><span class="token punctuation">:</span> http
      <span class="token key atrule">relabelings</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">action</span><span class="token punctuation">:</span> replace
          <span class="token key atrule">regex</span><span class="token punctuation">:</span> (.<span class="token important">*)</span>
          <span class="token key atrule">replacement</span><span class="token punctuation">:</span> $1
          <span class="token key atrule">sourceLabels</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> __meta_kubernetes_pod_node_name
          <span class="token key atrule">targetLabel</span><span class="token punctuation">:</span> instance
      <span class="token key atrule">scheme</span><span class="token punctuation">:</span> http
  <span class="token key atrule">jobLabel</span><span class="token punctuation">:</span> app.kubernetes.io/name
  <span class="token key atrule">targetLabels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>platform<span class="token punctuation">]</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> exporter
      <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>exporter
      <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>配置说明：</strong></p>
<ul>
<li><code>interval: 15s</code>：每 15 秒采集一次指标</li>
<li><code>relabelings</code>：指标重写规则，将 Pod 节点名作为 instance 标签值</li>
<li><code>targetLabels</code>：将 Service 的 <code>platform</code> 标签添加到采集的指标中</li>
</ul>
<h2 id="三、验证部署"><a href="#三、验证部署" class="headerlink" title="三、验证部署"></a>三、验证部署</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看 Deployment 状态</span>
kubectl get deployment rocketmq-exporter <span class="token parameter variable">-n</span> monitoring

<span class="token comment"># 查看 Pod 日志</span>
kubectl logs <span class="token parameter variable">-f</span> <span class="token operator">&lt;</span>pod-name<span class="token operator">></span> <span class="token parameter variable">-n</span> monitoring

<span class="token comment"># 访问 Exporter 指标接口</span>
kubectl port-forward svc/rocketmq-exporter <span class="token number">5557</span>:5557 <span class="token parameter variable">-n</span> monitoring
<span class="token function">curl</span> http://localhost:5557/metrics<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="四、监控指标说明"><a href="#四、监控指标说明" class="headerlink" title="四、监控指标说明"></a>四、监控指标说明</h2><p>RocketMQ Exporter 提供的核心监控指标：</p>
<ul>
<li><code>rocketmq_broker_tps</code>：Broker 的 TPS（每秒事务数）</li>
<li><code>rocketmq_broker_qps</code>：Broker 的 QPS（每秒查询数）</li>
<li><code>rocketmq_producer_message_size</code>：生产者消息大小</li>
<li><code>rocketmq_consumer_tps</code>：消费者 TPS</li>
<li><code>rocketmq_consumer_message_size</code>：消费者消息大小</li>
<li><code>rocketmq_group_get_latency</code>：消费组消费延迟</li>
<li><code>rocketmq_group_diff</code>：消费组积压消息数</li>
</ul>
<h2 id="五、注意事项"><a href="#五、注意事项" class="headerlink" title="五、注意事项"></a>五、注意事项</h2><ol>
<li><strong>NameServer 地址</strong>：需要配置正确的 RocketMQ NameServer 地址，支持多个地址</li>
<li><strong>网络访问</strong>：确保 K8s 集群能够访问 RocketMQ NameServer</li>
<li><strong>镜像准备</strong>：RocketMQ Exporter 需要提前构建并推送到镜像仓库</li>
<li><strong>资源配置</strong>：根据 RocketMQ 集群规模调整 Exporter 的内存资源，避免 OOM</li>
</ol>
<p><strong>配置说明：</strong></p>
<ul>
<li><code>interval: 15s</code>：每 15 秒采集一次指标</li>
<li><code>relabelings</code>：指标重写规则，将 Pod 节点名作为 instance 标签值</li>
<li><code>targetLabels</code>：将 Service 的 <code>platform</code> 标签添加到采集的指标中</li>
</ul>
<h2 id="三、验证部署-1"><a href="#三、验证部署-1" class="headerlink" title="三、验证部署"></a>三、验证部署</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看 Deployment 状态</span>
kubectl get deployment rocketmq-exporter <span class="token parameter variable">-n</span> monitoring

<span class="token comment"># 查看 Pod 日志</span>
kubectl logs <span class="token parameter variable">-f</span> <span class="token operator">&lt;</span>pod-name<span class="token operator">></span> <span class="token parameter variable">-n</span> monitoring

<span class="token comment"># 访问 Exporter 指标接口</span>
kubectl port-forward svc/rocketmq-exporter <span class="token number">5557</span>:5557 <span class="token parameter variable">-n</span> monitoring
<span class="token function">curl</span> http://localhost:5557/metrics<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="四、监控指标说明-1"><a href="#四、监控指标说明-1" class="headerlink" title="四、监控指标说明"></a>四、监控指标说明</h2><p>RocketMQ Exporter 提供的核心监控指标：</p>
<ul>
<li><code>rocketmq_broker_tps</code>：Broker 的 TPS（每秒事务数）</li>
<li><code>rocketmq_broker_qps</code>：Broker 的 QPS（每秒查询数）</li>
<li><code>rocketmq_producer_message_size</code>：生产者消息大小</li>
<li><code>rocketmq_consumer_tps</code>：消费者 TPS</li>
<li><code>rocketmq_consumer_message_size</code>：消费者消息大小</li>
<li><code>rocketmq_group_get_latency</code>：消费组消费延迟</li>
<li><code>rocketmq_group_diff</code>：消费组积压消息数</li>
</ul>
<h2 id="五、注意事项-1"><a href="#五、注意事项-1" class="headerlink" title="五、注意事项"></a>五、注意事项</h2><ol>
<li><strong>NameServer 地址</strong>：需要配置正确的 RocketMQ NameServer 地址，支持多个地址</li>
<li><strong>网络访问</strong>：确保 K8s 集群能够访问 RocketMQ NameServer</li>
<li><strong>镜像准备</strong>：RocketMQ Exporter 需要提前构建并推送到镜像仓库</li>
<li><strong>资源配置</strong>：根据 RocketMQ 集群规模调整 Exporter 的内存资源，避免 OOM</li>
</ol>
]]></content>
      <categories>
        <category>k8s</category>
      </categories>
      <tags>
        <tag>k8s</tag>
        <tag>Prometheus</tag>
        <tag>exporter</tag>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>Kube-Prometheus监控主机和中间件（一）</title>
    <url>/2023/05/05/k8s/kube-prometheus-jian-kong-zhu-ji-he-zhong-jian-jian/</url>
    <content><![CDATA[<h2 id="一、背景简介"><a href="#一、背景简介" class="headerlink" title="一、背景简介"></a>一、背景简介</h2><p>随着业务向云原生架构迁移，原有的监控系统需要升级以适应容器化环境。本系列文章介绍如何使用 Kube-Prometheus 监控 K8s 集群外部的主机和中间件服务。</p>
<p><strong>核心特点：</strong></p>
<ul>
<li>支持监控 K8s 集群外部的服务（MySQL、Redis、RocketMQ 等）</li>
<li>通过环境标签（platform）区分不同环境的监控数据</li>
<li>基于 Prometheus Operator 的 ServiceMonitor 机制实现服务发现</li>
</ul>
<h2 id="二、技术原理"><a href="#二、技术原理" class="headerlink" title="二、技术原理"></a>二、技术原理</h2><h3 id="2-1-K8s-访问外部服务"><a href="#2-1-K8s-访问外部服务" class="headerlink" title="2.1 K8s 访问外部服务"></a>2.1 K8s 访问外部服务</h3><p>K8s 集群内的 Pod 访问外部服务的原理：</p>
<p><img src="/2023/05/05/k8s/kube-prometheus-jian-kong-zhu-ji-he-zhong-jian-jian/k8s%E8%AE%BF%E9%97%AE%E5%A4%96%E9%83%A8%E6%9C%8D%E5%8A%A1.png"></p>
<p><strong>关键步骤：</strong></p>
<ol>
<li>创建 <strong>Endpoints</strong> 资源，指向外部服务的 IP 地址</li>
<li>创建 <strong>Service</strong> 资源，不配置 selector，关联到手动创建的 Endpoints</li>
<li>Pod 通过 Service 名称访问外部服务</li>
</ol>
<p><img src="/2023/05/05/k8s/kube-prometheus-jian-kong-zhu-ji-he-zhong-jian-jian/k8s%E5%88%9B%E5%BB%BAService.png"></p>
<h3 id="2-2-ServiceMonitor-原理"><a href="#2-2-ServiceMonitor-原理" class="headerlink" title="2.2 ServiceMonitor 原理"></a>2.2 ServiceMonitor 原理</h3><p>Prometheus Operator 通过 ServiceMonitor 实现服务发现：</p>
<p><img src="/2023/05/05/k8s/kube-prometheus-jian-kong-zhu-ji-he-zhong-jian-jian/k8s%E7%9A%84ServiceMonitor.png"></p>
<p><strong>工作流程：</strong></p>
<ol>
<li>ServiceMonitor 通过 selector 选择目标 Service</li>
<li>Prometheus Operator 监听 ServiceMonitor 变化，更新 Prometheus 配置</li>
<li>Prometheus 根据配置发现 Endpoints，采集指标数据</li>
</ol>
<h2 id="三、环境准备"><a href="#三、环境准备" class="headerlink" title="三、环境准备"></a>三、环境准备</h2><h3 id="3-1-创建命名空间"><a href="#3-1-创建命名空间" class="headerlink" title="3.1 创建命名空间"></a>3.1 创建命名空间</h3><pre class="line-numbers language-none"><code class="language-none">kubectl create namespace monitoring
# 执行结果：namespace&#x2F;monitoring created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="配置角色和权限"><a href="#配置角色和权限" class="headerlink" title="配置角色和权限"></a>配置角色和权限</h2><h3 id="monitoring-role-yaml"><a href="#monitoring-role-yaml" class="headerlink" title="monitoring-role.yaml"></a>monitoring-role.yaml</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>k8s
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mos<span class="token punctuation">-</span>monitoring
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> services
      <span class="token punctuation">-</span> endpoints
      <span class="token punctuation">-</span> pods
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> get
      <span class="token punctuation">-</span> list
      <span class="token punctuation">-</span> watch
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> extensions
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ingresses
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> get
      <span class="token punctuation">-</span> list
      <span class="token punctuation">-</span> watch<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="monitoring-role-binding-yaml"><a href="#monitoring-role-binding-yaml" class="headerlink" title="monitoring-role-binding.yaml"></a>monitoring-role-binding.yaml</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>k8s
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mos<span class="token punctuation">-</span>monitoring
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
  <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>k8s
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
    <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>k8s
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>配置说明：</strong></p>
<ul>
<li>Role 定义了 Prometheus 在业务命名空间中的访问权限</li>
<li>RoleBinding 将 Role 绑定到 Prometheus 的 ServiceAccount</li>
</ul>
<h2 id="四、监控实施"><a href="#四、监控实施" class="headerlink" title="四、监控实施"></a>四、监控实施</h2><p><strong>环境隔离方案：</strong><br>为了区分不同环境的监控数据，在 Service 中添加自定义标签 <code>platform: &lt;env&gt;</code>，通过 ServiceMonitor 的 <code>targetLabels</code> 配置将该标签添加到指标中。</p>
<p><strong>后续章节内容：</strong></p>
<ul>
<li><a href="/k8s/Kube-Prometheus%E7%9B%91%E6%8E%A7MySQL/">监控 MySQL</a></li>
<li><a href="/k8s/Kube-Prometheus%E7%9B%91%E6%8E%A7Redis/">监控 Redis</a></li>
<li><a href="/k8s/Kube-Prometheus%E7%9B%91%E6%8E%A7RocketMQ/">监控 RocketMQ</a></li>
<li><a href="/k8s/Kube-Prometheus%E7%9B%91%E6%8E%A7Nacos/">监控 Nacos</a></li>
</ul>
<h2 id="五、注意事项"><a href="#五、注意事项" class="headerlink" title="五、注意事项"></a>五、注意事项</h2><ol>
<li><strong>网络连通性</strong>：确保 K8s 集群能够访问外部服务的网络和端口</li>
<li><strong>权限配置</strong>：每个业务命名空间都需要配置 Role 和 RoleBinding</li>
<li><strong>标签统一</strong>：保持所有监控组件的标签一致性，方便管理和查询</li>
<li><strong>环境区分</strong>：通过 <code>platform</code> 标签区分开发、测试、生产环境</li>
</ol>
]]></content>
      <categories>
        <category>k8s</category>
      </categories>
      <tags>
        <tag>k8s</tag>
        <tag>Prometheus</tag>
        <tag>中间件</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s容器部署时区问题处理</title>
    <url>/2023/11/15/k8s/k8s-rong-qi-bu-shu-shi-qu-wen-ti-chu-li/</url>
    <content><![CDATA[<h2 id="一、问题描述"><a href="#一、问题描述" class="headerlink" title="一、问题描述"></a>一、问题描述</h2><p>在 K8s 环境下部署应用后，发现数据库中记录的时间比北京时间晚了 8 小时，导致按时间查询数据时无法查到正确结果。这是典型的时区不一致问题。</p>
<p><strong>涩及的时区配置点：</strong></p>
<ul>
<li>MySQL 数据库服务器的时区设置</li>
<li>MySQL 数据库时区配置</li>
<li>JDBC 数据库连接的时区配置</li>
<li>应用服务器时区配置</li>
<li>应用容器的时区配置</li>
</ul>
<h2 id="二、问题排查"><a href="#二、问题排查" class="headerlink" title="二、问题排查"></a>二、问题排查</h2><h3 id="2-1-服务器时区检查"><a href="#2-1-服务器时区检查" class="headerlink" title="2.1 服务器时区检查"></a>2.1 服务器时区检查</h3><p>首先确认各个服务器的时区，使用命令 <code>date</code> 或 <code>date -R</code>。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@host-172 ~<span class="token punctuation">]</span>$ <span class="token function">date</span>
<span class="token number">2023</span>年 <span class="token number">11</span>月 <span class="token number">15</span>日 星期三 <span class="token number">21</span>:19:02 CST
<span class="token punctuation">[</span>root@host-172 ~<span class="token punctuation">]</span>$ <span class="token function">date</span> <span class="token parameter variable">-R</span>
Wed, <span class="token number">15</span> Nov <span class="token number">2023</span> <span class="token number">21</span>:19:06 +0800<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>结果显示服务器时区为 CST（东八区）。</p>
<h3 id="2-2-数据库时区检查"><a href="#2-2-数据库时区检查" class="headerlink" title="2.2 数据库时区检查"></a>2.2 数据库时区检查</h3><p>在确认服务器时区后，进一步确认数据库的时区，在数据库执行下面命令：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%time_zone%'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>查询结果如下：</p>
<table>
<thead>
<tr>
<th align="left">variable_name</th>
<th align="left">value</th>
</tr>
</thead>
<tbody><tr>
<td align="left">system_time_zone</td>
<td align="left">CST</td>
</tr>
<tr>
<td align="left">time_zone</td>
<td align="left">SYSTEM</td>
</tr>
</tbody></table>
<p>上述查询结果表明，数据库服务器的时区为CST，数据默认使用服务器的时区则也是CST。</p>
<h3 id="2-3-Java-获取时区机制"><a href="#2-3-Java-获取时区机制" class="headerlink" title="2.3 Java 获取时区机制"></a>2.3 Java 获取时区机制</h3><p>在Java代码中我们可以通过一下方式获取系统时区：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 获取默认时区</span>
<span class="token class-name">TimeZone</span> timeZone <span class="token operator">=</span> <span class="token class-name">TimeZone</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>运行结果如下：</p>
<pre class="line-numbers language-none"><code class="language-none">sun.util.calendar.ZoneInfo[id&#x3D;&quot;Asia&#x2F;Shanghai&quot;,offset&#x3D;28800000,dstSavings&#x3D;0,useDaylight&#x3D;false,transitions&#x3D;29,lastRule&#x3D;null]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="2-4-Java-默认时区获取逻辑"><a href="#2-4-Java-默认时区获取逻辑" class="headerlink" title="2.4 Java 默认时区获取逻辑"></a>2.4 Java 默认时区获取逻辑</h3><p>Java 获取默认时区的步骤：</p>
<ol>
<li>查找 <code>TZ</code> 环境变量</li>
<li>若未设置，读取 <code>/etc/timezone</code> 文件</li>
<li>若文件不存在，比较 <code>/etc/localtime</code> 与 <code>/usr/share/zoneinfo</code> 目录下的时区文件</li>
<li>都未找到，默认使用 GMT 时区</li>
</ol>
<blockquote>
<p>参考：<a href="https://www.cnblogs.com/darange/p/9368245.html">Java读取系统默认时区</a></p>
</blockquote>
<h2 id="三、解决方案"><a href="#三、解决方案" class="headerlink" title="三、解决方案"></a>三、解决方案</h2><h3 id="3-1-挂载时区文件"><a href="#3-1-挂载时区文件" class="headerlink" title="3.1 挂载时区文件"></a>3.1 挂载时区文件</h3><p>将宿主机的<code>/etc/localtime</code>路径挂载到容器，可以保持容器与宿主机时间同步，避免由于时间同步引起的应用层的问题。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> 
    <span class="token key atrule">app</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>pod
     
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>pod
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> host<span class="token punctuation">-</span>time
        <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/localtime
        <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> host<span class="token punctuation">-</span>time
      <span class="token key atrule">hostPath</span><span class="token punctuation">:</span> 
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/localtime<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>**作用：**将宿主机的 <code>/etc/localtime</code> 路径挂载到容器，保持容器与宿主机时间同步。</p>
<h3 id="3-2-设置环境变量-TZ"><a href="#3-2-设置环境变量-TZ" class="headerlink" title="3.2 设置环境变量 TZ"></a>3.2 设置环境变量 TZ</h3><p>即使挂载了时区文件，如果没有设置 <code>TZ</code> 环境变量，Java 应用可能仍然使用容器的默认时区。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>env<span class="token punctuation">-</span>tz
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ngx<span class="token punctuation">-</span>time
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>latest
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> TZ
        <span class="token key atrule">value</span><span class="token punctuation">:</span> Asia/Shanghai<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>**作用：**设置 <code>TZ</code> 环境变量，确保 Java 应用能获取正确的时区。</p>
<h3 id="3-3-完整配置示例"><a href="#3-3-完整配置示例" class="headerlink" title="3.3 完整配置示例"></a>3.3 完整配置示例</h3><p>推荐的容器时区配置方案（同时配置环境变量和挂载时区文件）：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> app<span class="token punctuation">-</span>pod
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> app
    <span class="token key atrule">image</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>app<span class="token punctuation">:</span>latest
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> TZ
        <span class="token key atrule">value</span><span class="token punctuation">:</span> Asia/Shanghai
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> host<span class="token punctuation">-</span>time
        <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/localtime
        <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> host<span class="token punctuation">-</span>time
      <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/localtime<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="四、验证方法"><a href="#四、验证方法" class="headerlink" title="四、验证方法"></a>四、验证方法</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 进入容器</span>
kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> <span class="token operator">&lt;</span>pod-name<span class="token operator">></span> -- /bin/bash

<span class="token comment"># 检查容器时区</span>
<span class="token function">date</span>
<span class="token function">date</span> <span class="token parameter variable">-R</span>

<span class="token comment"># 检查 TZ 环境变量</span>
<span class="token builtin class-name">echo</span> <span class="token variable">$TZ</span>

<span class="token comment"># 检查 Java 应用获取的时区（在应用代码中）</span>
TimeZone.getDefault<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="五、注意事项"><a href="#五、注意事项" class="headerlink" title="五、注意事项"></a>五、注意事项</h2><ol>
<li><strong>双重配置</strong>：建议同时配置 <code>TZ</code> 环境变量和挂载 <code>/etc/localtime</code>，确保时区一致</li>
<li><strong>数据库连接</strong>：JDBC 连接串也可以配置时区，如 <code>serverTimezone=Asia/Shanghai</code></li>
<li><strong>镜像构建</strong>：如果在 Dockerfile 中设置时区，可以避免部署时配置</li>
<li><strong>时区文件路径</strong>：不同的 Linux 发行版时区文件路径可能不同，注意适配</li>
</ol>
<h2 id="六、参考文章"><a href="#六、参考文章" class="headerlink" title="六、参考文章"></a>六、参考文章</h2><ul>
<li><a href="https://www.cnblogs.com/darange/p/9368245.html">Java读取系统默认时区</a></li>
<li><a href="https://juejin.cn/post/6844903924806189063">k8s pod时区更改</a></li>
</ul>
]]></content>
      <categories>
        <category>k8s</category>
      </categories>
      <tags>
        <tag>k8s</tag>
        <tag>容器</tag>
        <tag>时区</tag>
      </tags>
  </entry>
  <entry>
    <title>一份k8s的Deployment配置文件详解</title>
    <url>/2023/11/03/k8s/yi-fen-k8s-de-deployment-pei-zhi-wen-jian-xiang-jie/</url>
    <content><![CDATA[<h2 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h2><p>本文提供一份 K8s Deployment 配置文件示例，并对关键配置项进行详细说明，方便在实际项目部署时参考和使用。</p>
<h2 id="二、配置示例"><a href="#二、配置示例" class="headerlink" title="二、配置示例"></a>二、配置示例</h2><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> msmp<span class="token punctuation">-</span>mt<span class="token punctuation">-</span>server
    <span class="token key atrule">k8s.kuboard.cn/name</span><span class="token punctuation">:</span> msmp<span class="token punctuation">-</span>mt<span class="token punctuation">-</span>server<span class="token punctuation">-</span>deployment
  <span class="token key atrule">name</span><span class="token punctuation">:</span> msmp<span class="token punctuation">-</span>mt<span class="token punctuation">-</span>server<span class="token punctuation">-</span>deployment
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> hw<span class="token punctuation">-</span>msmp
  <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">'10843811'</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">progressDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">600</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> msmp<span class="token punctuation">-</span>mt<span class="token punctuation">-</span>server
      <span class="token key atrule">env</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> 25%
      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> 25%
    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
        <span class="token key atrule">kubectl.kubernetes.io/restartedAt</span><span class="token punctuation">:</span> <span class="token string">'2023-11-03T17:39:17+08:00'</span>
      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> msmp<span class="token punctuation">-</span>mt<span class="token punctuation">-</span>server
        <span class="token key atrule">env</span><span class="token punctuation">:</span> dev
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">env</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> TZ
              <span class="token key atrule">value</span><span class="token punctuation">:</span> Asia/Shanghai
          <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">'harbor.mos.com/hw/mt-server:v4.0.7'</span>
          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always
          <span class="token key atrule">name</span><span class="token punctuation">:</span> msmp<span class="token punctuation">-</span>mt<span class="token punctuation">-</span>server
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> http
              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
          <span class="token key atrule">resources</span><span class="token punctuation">:</span>
            <span class="token key atrule">limits</span><span class="token punctuation">:</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">'16'</span>
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 32Gi
            <span class="token key atrule">requests</span><span class="token punctuation">:</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">'2'</span>
              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 4Gi
          <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log
          <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /root/mt<span class="token punctuation">-</span>server/cache
              <span class="token key atrule">name</span><span class="token punctuation">:</span> cache
              <span class="token key atrule">subPath</span><span class="token punctuation">:</span> cache
            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /root/mt<span class="token punctuation">-</span>server/logs
              <span class="token key atrule">name</span><span class="token punctuation">:</span> cache
              <span class="token key atrule">subPath</span><span class="token punctuation">:</span> logs
      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst
      <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> host<span class="token punctuation">-</span>172.16.1.113
      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always
      <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>scheduler
      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
            <span class="token key atrule">defaultMode</span><span class="token punctuation">:</span> <span class="token number">420</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> hw2<span class="token punctuation">-</span>msmp<span class="token punctuation">-</span>config
          <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>volume
        <span class="token punctuation">-</span> <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /home/msmp/
            <span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">''</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> cache<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="三、配置项详解"><a href="#三、配置项详解" class="headerlink" title="三、配置项详解"></a>三、配置项详解</h2><h3 id="3-1-元数据-metadata"><a href="#3-1-元数据-metadata" class="headerlink" title="3.1 元数据 (metadata)"></a>3.1 元数据 (metadata)</h3><table>
<thead>
<tr>
<th>配置项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>name</code></td>
<td>Deployment 的名称，在命名空间中必须唯一</td>
</tr>
<tr>
<td><code>namespace</code></td>
<td>所属的命名空间</td>
</tr>
<tr>
<td><code>labels</code></td>
<td>标签，用于资源的组织和选择</td>
</tr>
<tr>
<td><code>annotations</code></td>
<td>注解，存储非识别信息，如重启时间等</td>
</tr>
</tbody></table>
<h3 id="3-2-规格配置-spec"><a href="#3-2-规格配置-spec" class="headerlink" title="3.2 规格配置 (spec)"></a>3.2 规格配置 (spec)</h3><h4 id="3-2-1-基本配置"><a href="#3-2-1-基本配置" class="headerlink" title="3.2.1 基本配置"></a>3.2.1 基本配置</h4><table>
<thead>
<tr>
<th>配置项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>replicas</code></td>
<td>Pod 副本数量，此处为 1</td>
</tr>
<tr>
<td><code>revisionHistoryLimit</code></td>
<td>保留的历史版本数，用于回滚</td>
</tr>
<tr>
<td><code>progressDeadlineSeconds</code></td>
<td>Deployment 进展超时时间（600秒）</td>
</tr>
</tbody></table>
<h4 id="3-2-2-选择器-selector"><a href="#3-2-2-选择器-selector" class="headerlink" title="3.2.2 选择器 (selector)"></a>3.2.2 选择器 (selector)</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">selector</span><span class="token punctuation">:</span>
  <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> msmp<span class="token punctuation">-</span>mt<span class="token punctuation">-</span>server
    <span class="token key atrule">env</span><span class="token punctuation">:</span> dev<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>用于选择 Deployment 管理的 Pod，必须与 Pod 模板中的 labels 匹配。</p>
<h4 id="3-2-3-更新策略-strategy"><a href="#3-2-3-更新策略-strategy" class="headerlink" title="3.2.3 更新策略 (strategy)"></a>3.2.3 更新策略 (strategy)</h4><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">strategy</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate
  <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
    <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> 25%
    <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> 25%<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<table>
<thead>
<tr>
<th>配置项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>type</code></td>
<td>更新类型，RollingUpdate（滚动更新）或 Recreate（重建）</td>
</tr>
<tr>
<td><code>maxSurge</code></td>
<td>更新时最多可以超出期望 Pod 数的比例&#x2F;数量</td>
</tr>
<tr>
<td><code>maxUnavailable</code></td>
<td>更新时最多不可用 Pod 数的比例&#x2F;数量</td>
</tr>
</tbody></table>
<h3 id="3-3-Pod-模板-template"><a href="#3-3-Pod-模板-template" class="headerlink" title="3.3 Pod 模板 (template)"></a>3.3 Pod 模板 (template)</h3><h4 id="3-3-1-容器配置-containers"><a href="#3-3-1-容器配置-containers" class="headerlink" title="3.3.1 容器配置 (containers)"></a>3.3.1 容器配置 (containers)</h4><p><strong>镜像配置：</strong></p>
<table>
<thead>
<tr>
<th>配置项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>image</code></td>
<td>容器镜像地址和版本</td>
</tr>
<tr>
<td><code>imagePullPolicy</code></td>
<td>镜像拉取策略：Always（总是拉取）、IfNotPresent、Never</td>
</tr>
</tbody></table>
<p><strong>环境变量：</strong></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">env</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> TZ
    <span class="token key atrule">value</span><span class="token punctuation">:</span> Asia/Shanghai<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>设置容器的时区为东八区，避免时间问题。</p>
<p><strong>资源配置：</strong></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token key atrule">requests</span><span class="token punctuation">:</span>
    <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"2"</span>
    <span class="token key atrule">memory</span><span class="token punctuation">:</span> 4Gi
  <span class="token key atrule">limits</span><span class="token punctuation">:</span>
    <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"16"</span>
    <span class="token key atrule">memory</span><span class="token punctuation">:</span> 32Gi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<table>
<thead>
<tr>
<th>配置项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>requests</code></td>
<td>容器请求的最小资源，用于调度</td>
</tr>
<tr>
<td><code>limits</code></td>
<td>容器可使用的最大资源，超出会被限制或杀死</td>
</tr>
</tbody></table>
<p><strong>端口配置：</strong></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> http
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>声明容器暴露的端口，主要用于文档说明和 Service 关联。</p>
<h4 id="3-3-2-卷配置-volumes"><a href="#3-3-2-卷配置-volumes" class="headerlink" title="3.3.2 卷配置 (volumes)"></a>3.3.2 卷配置 (volumes)</h4><p><strong>挂载卷：</strong></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /root/mt<span class="token punctuation">-</span>server/cache
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cache
    <span class="token key atrule">subPath</span><span class="token punctuation">:</span> cache
  <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /root/mt<span class="token punctuation">-</span>server/logs
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cache
    <span class="token key atrule">subPath</span><span class="token punctuation">:</span> logs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>定义卷：</strong></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultMode</span><span class="token punctuation">:</span> <span class="token number">420</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> hw2<span class="token punctuation">-</span>msmp<span class="token punctuation">-</span>config
    <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>volume
  <span class="token punctuation">-</span> <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /home/msmp/
      <span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">''</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cache<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<table>
<thead>
<tr>
<th>卷类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>configMap</code></td>
<td>从 ConfigMap 挂载配置文件</td>
</tr>
<tr>
<td><code>hostPath</code></td>
<td>挂载宿主机路径，用于持久化存储</td>
</tr>
<tr>
<td><code>emptyDir</code></td>
<td>临时目录，Pod 删除时数据也会删除</td>
</tr>
</tbody></table>
<h4 id="3-3-3-其他配置"><a href="#3-3-3-其他配置" class="headerlink" title="3.3.3 其他配置"></a>3.3.3 其他配置</h4><table>
<thead>
<tr>
<th>配置项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>restartPolicy</code></td>
<td>重启策略：Always（总是重启）、OnFailure、Never</td>
</tr>
<tr>
<td><code>dnsPolicy</code></td>
<td>DNS 策略，ClusterFirst 使用集群 DNS</td>
</tr>
<tr>
<td><code>nodeName</code></td>
<td>指定调度到的节点名称（不建议手动指定）</td>
</tr>
<tr>
<td><code>terminationGracePeriodSeconds</code></td>
<td>Pod 终止宽限期（30秒）</td>
</tr>
</tbody></table>
<h2 id="四、使用示例"><a href="#四、使用示例" class="headerlink" title="四、使用示例"></a>四、使用示例</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建 Deployment</span>
kubectl apply <span class="token parameter variable">-f</span> deployment.yaml

<span class="token comment"># 查看 Deployment 状态</span>
kubectl get deployment msmp-mt-server-deployment <span class="token parameter variable">-n</span> hw-msmp

<span class="token comment"># 查看 Pod 状态</span>
kubectl get pods <span class="token parameter variable">-n</span> hw-msmp <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>msmp-mt-server

<span class="token comment"># 查看 Deployment 详情</span>
kubectl describe deployment msmp-mt-server-deployment <span class="token parameter variable">-n</span> hw-msmp

<span class="token comment"># 扩容/缩容</span>
kubectl scale deployment msmp-mt-server-deployment <span class="token parameter variable">--replicas</span><span class="token operator">=</span><span class="token number">3</span> <span class="token parameter variable">-n</span> hw-msmp

<span class="token comment"># 更新镜像</span>
kubectl <span class="token builtin class-name">set</span> image deployment/msmp-mt-server-deployment msmp-mt-server<span class="token operator">=</span>harbor.mos.com/hw/mt-server:v4.0.8 <span class="token parameter variable">-n</span> hw-msmp

<span class="token comment"># 查看滚动更新状态</span>
kubectl rollout status deployment/msmp-mt-server-deployment <span class="token parameter variable">-n</span> hw-msmp

<span class="token comment"># 回滚到上一个版本</span>
kubectl rollout undo deployment/msmp-mt-server-deployment <span class="token parameter variable">-n</span> hw-msmp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="五、注意事项"><a href="#五、注意事项" class="headerlink" title="五、注意事项"></a>五、注意事项</h2><ol>
<li><strong>资源配置</strong>：合理设置 requests 和 limits，避免资源浪费或 OOM</li>
<li><strong>时区配置</strong>：必须配置 <code>TZ</code> 环境变量，确保应用时间正确</li>
<li><strong>持久化存储</strong>：hostPath 会将 Pod 绑定到特定节点，生产环境建议使用 PV&#x2F;PVC</li>
<li><strong>更新策略</strong>：根据业务特点调整 maxSurge 和 maxUnavailable，平衡更新速度和服务可用性</li>
<li><strong>标签匹配</strong>：selector 必须与 Pod template 中的 labels 完全匹配</li>
</ol>
]]></content>
      <categories>
        <category>K8s</category>
      </categories>
      <tags>
        <tag>K8s</tag>
        <tag>Deployment</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux中的CommitLimit与OOM Killer</title>
    <url>/2020/11/19/linux/linux-zhong-de-commitlimit-yu-oomkiller/</url>
    <content><![CDATA[<h1 id="一、背景说明"><a href="#一、背景说明" class="headerlink" title="一、背景说明"></a>一、背景说明</h1><p>在测试过程中遇到一个Java进程由于申请内存过大导致被Linux OOM killer杀掉的问题，所以来分析一下Linux中的CommitLimit与OMM killer机制。</p>
<h1 id="二、Linux内存分配机制"><a href="#二、Linux内存分配机制" class="headerlink" title="二、Linux内存分配机制"></a>二、Linux内存分配机制</h1><p>　　Linux系统允许程序申请比系统可用内存更多的内存空间，这个特性叫做 <code>overcommit</code> 特性，这样做可能是为了系统的优化，因为不是所有的程序申请了内存就会立刻使用，当真正的使用时，系统可能已经回收了一些内存。为了避免内存的浪费，在分配页面时，Linux 采用的是按需分配物理页面的方式。譬如说，某个进程调用malloc()申请了一块小内存，这时内核会分配一个虚拟页面，但这个页面不会映射到实际的物理页面。<br><img src="/2020/11/19/linux/linux-zhong-de-commitlimit-yu-oomkiller/oom1.png" alt="OS内存分配"><br>从图中可以看到，当程序首次访问这个虚拟页面时，会触发一个缺页异常 (page fault)。这时内核会分配一个物理页面，让虚拟页面映射到这个物理页面，同时更新进程的页表 (page table)。</p>
<h2 id="2-1-Linux的Memory-Overcommit"><a href="#2-1-Linux的Memory-Overcommit" class="headerlink" title="2.1 Linux的Memory Overcommit"></a>2.1 Linux的Memory Overcommit</h2><p>这种按需分配物理页面的方式，可以大大节省物理内存的使用，但有时会导致 Memory Overcommit。所谓 Memory Overcommit，也就是说，所有进程使用的虚拟内存超过了系统的物理内存和交换空间的总和。默认情况下，Linux 是允许 Memory Overcommit 的。并且在大多数情况下，Memory Overcommit 也是安全的，因为很多进程只是申请了很多内存，但实际使用到的内存并不多。</p>
<p>但万一很多进程都使用了申请来的大部分内存，就可能导致物理内存和交换空间不够用了，这时内核的 OOM Killer 就会出马，它会选择杀掉一个或多个进程，这样就能腾出一些内存给其它进程使用。</p>
<p>Linux设计了一个OOM killer机制(out of memory killer)来处理这种危机：挑选一个进程出来杀死，以腾出部分内存，如果还不够就继续杀…也可通过设置内核参数 vm.panic_on_oom 使得发生OOM时自动重启系统。</p>
<p>Linux 2.6之后允许通过内核参数 vm.overcommit_memory 禁止memory overcommit。<br>内核参数 vm.overcommit_memory 接受三种取值：</p>
<table>
<thead>
<tr>
<th>取值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>Heuristic overcommit handling. 这是缺省值，它允许overcommit，但过于明目张胆的overcommit会被拒绝，比如malloc一次性申请的内存大小就超过了系统总内存。</td>
</tr>
<tr>
<td>1</td>
<td>Always overcommit. 允许overcommit，对内存申请来者不拒</td>
</tr>
<tr>
<td>2</td>
<td>Don’t overcommit. 禁止overcommit。</td>
</tr>
</tbody></table>
<h3 id="如何才算-overcommit？"><a href="#如何才算-overcommit？" class="headerlink" title="如何才算 overcommit？"></a>如何才算 overcommit？</h3><p>Linux 设定了一个阈值，叫做 CommitLimit，如果所有进程申请的总内存超过了 CommitLimit，那就算是 overcommit 了。在&#x2F;proc&#x2F;meminfo中可以看到 CommitLimit 的大小：</p>
<pre class="line-numbers language-none"><code class="language-none">$ grep -i commit &#x2F;proc&#x2F;meminfo
CommitLimit:    32905144 kB
Committed_AS:   30462700 kB<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ul>
<li>CommitLimit ： overcommit的阈值</li>
<li>Committed_AS : 表示所有进程已经申请的内存总大小</li>
</ul>
<blockquote>
<p>注意 Committed_AS是已经申请的，不是已经分配的，如果 Committed_AS 超过 CommitLimit 就表示发生了 overcommit，超出越多表示 overcommit 越严重。</p>
</blockquote>
<h3 id="CommitLimit计算方式"><a href="#CommitLimit计算方式" class="headerlink" title="CommitLimit计算方式"></a>CommitLimit计算方式</h3><pre class="line-numbers language-none"><code class="language-none">CommitLimit &#x3D; [swap size] + [RAM size] * vm.overcommit_ratio &#x2F; 100<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>[swap size] : 交换区空间大小</li>
<li>[RAM size] : 内存空间大小</li>
<li>vm.overcommit_ratio : vm.overcommit_ratio 是内核参数，缺省值是50，表示物理内存的50%</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">$ free
              total        used        free      shared  buff&#x2F;cache   available
Mem:       32780152    16704624     2104672     1442992    13970856    14124620
Swap:      16515068      127488    16387580<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>CommitLimit &#x3D; 16515068 + 32780152 * 50 &#x2F; 100 &#x3D; 32905144</p>
</blockquote>
<h2 id="2-2-Linux-OOM-Killer"><a href="#2-2-Linux-OOM-Killer" class="headerlink" title="2.2 Linux OOM Killer"></a>2.2 Linux OOM Killer</h2><p>当物理内存严重不足时，Linux内核调用OOM Killer来检查所有正在运行的进程并杀死其中一个或多个进程，以释放系统内存并保持系统运行。</p>
<h3 id="OOM-Killer如何选择进程？"><a href="#OOM-Killer如何选择进程？" class="headerlink" title="OOM Killer如何选择进程？"></a>OOM Killer如何选择进程？</h3><p>Linux内核给每个正在运行的进程评分oom_score，该评分显示了在可用内存不足的情况下终止该进程的可能性。</p>
<pre class="line-numbers language-none"><code class="language-none">oom_score &#x3D; 10 x [percent of memory used by process]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>oom_score最大得分为<code>100% x 10 = 1000</code> 。此外，如果进程以root用户身份运行，则与普通用户进程使用相同的内存相比，该进程的oom_score略低。</p>
</blockquote>
<p>Linux 的每个进程都有一个<code>oom_score</code> (位于&#x2F;proc&#x2F;$pid&#x2F;oom_score)，这个值越大，就越有可能被 OOM Killer 选中。<br>这个值是系统综合进程的内存消耗量、CPU时间(utime + stime)、存活时间(uptime - start time)和oom_adj计算出的，消耗内存越多分越高，存活时间越长分越低。</p>
<h3 id="如何避免进程被OOM-Killer杀死？"><a href="#如何避免进程被OOM-Killer杀死？" class="headerlink" title="如何避免进程被OOM Killer杀死？"></a>如何避免进程被OOM Killer杀死？</h3><h4 id="oom-score-adj"><a href="#oom-score-adj" class="headerlink" title="oom_score_adj"></a>oom_score_adj</h4><p> OOM killer检查oom_score_adj以调整其最终计算出的分数。该文件位于&#x2F;proc&#x2F;$pid&#x2F;oom_score_adj中,所以我们可以通过在这个文件中给一个大的负数，以降低该进程被选中并终止的可能性。oom_score_adj取值范围在-1000到1000之间。如果你给了-1000，进程即使使用了100%的内存也不会被OOM Killer杀死。</p>
<blockquote>
<p>修改pid为42的进程的oom_score_adj的方法：</p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">sudo echo -200 &gt; &#x2F;proc&#x2F;42&#x2F;oom_score_adj<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>需要以root用户或sudo的身份执行此操作，因为Linux不允许普通用户降低OOM分数。您可以在没有任何特殊权限的情况下以普通用户身份提高OOM分数。例如:</p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">echo 100&gt; &#x2F;proc&#x2F;42&#x2F;oom_score_adj<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="oom-adj"><a href="#oom-adj" class="headerlink" title="oom_adj"></a>oom_adj</h4><p> 另外还有一个较细粒度的分数，称为oom_adj，该文件位于&#x2F;proc&#x2F;$pid&#x2F;oom_adj，范围从-16到15。与oom_score_adj类似。 实际上，设置oom_score_adj时，内核会自动将其按比例缩小并计算oom_adj。<br> 当oom_adj的魔术值为-17，指示给定的进程永远不能被OOM杀手杀死。</p>
<h4 id="显示所有正在运行的进程的OOM分数"><a href="#显示所有正在运行的进程的OOM分数" class="headerlink" title="显示所有正在运行的进程的OOM分数"></a>显示所有正在运行的进程的OOM分数</h4><p> 该脚本以OOM分数的降序显示所有正在运行的进程的OOM分数和OOM调整后的分数：</p>
 <pre class="line-numbers language-none"><code class="language-none">#!&#x2F;bin&#x2F;bash
# Displays running processes in descending order of OOM score
printf &#39;PID\tOOM Score\tOOM Adj\tCommand\n&#39;
while read -r pid comm; do [ -f &#x2F;proc&#x2F;$pid&#x2F;oom_score ] &amp;&amp; [ $(cat &#x2F;proc&#x2F;$pid&#x2F;oom_score) !&#x3D; 0 ] &amp;&amp; printf &#39;%d\t%d\t\t%d\t%s\n&#39; &quot;$pid&quot; &quot;$(cat &#x2F;proc&#x2F;$pid&#x2F;oom_score)&quot; &quot;$(cat &#x2F;proc&#x2F;$pid&#x2F;oom_score_adj)&quot; &quot;$comm&quot;; done &lt; &lt;(ps -e -o pid&#x3D; -o comm&#x3D;) | sort -k 2nr<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="检查进程是否已被OOM杀死"><a href="#检查进程是否已被OOM杀死" class="headerlink" title="检查进程是否已被OOM杀死"></a>检查进程是否已被OOM杀死</h4> <pre class="line-numbers language-none"><code class="language-none"> $ egrep -i &#39;killed process&#39; &#x2F;var&#x2F;log&#x2F;messages
Nov 19 16:24:31 localhost kernel: Killed process 26980 (java) total-vm:14316628kB, anon-rss:6138236kB, file-rss:0kB, shmem-rss:0kB<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>


<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="http://linuxperf.com/?p=102">理解LINUX的MEMORY OVERCOMMIT</a><br><a href="http://senlinzhan.github.io/2017/07/03/oom-killer/">Linux 的 OOM Killer 机制分析</a><br><a href="https://learning-kernel.readthedocs.io/en/latest/mem-management.html">内存管理</a><br><a href="https://dev.to/rrampage/surviving-the-linux-oom-killer-2ki9">Surviving the Linux OOM Killer</a></p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Linux</tag>
        <tag>CommitLimit</tag>
        <tag>OOM killer</tag>
      </tags>
  </entry>
  <entry>
    <title>一次Java进程物理内存占用超过最大堆内存分析</title>
    <url>/2020/11/30/linux/yi-ci-java-jin-cheng-wu-li-nei-cun-zhan-yong-chao-guo-zui-da-dui-nei-cun-fen-xi/</url>
    <content><![CDATA[<h1 id="一、背景说明"><a href="#一、背景说明" class="headerlink" title="一、背景说明"></a>一、背景说明</h1><p>项目测试过程中，测试人员反馈使用Excel导入100万号码时报错，通过Top命令查看到该java进程占用物理内存大小为3.4G，而且内存持续占用，一直没有释放，怀疑是不是有内存泄露的情况。</p>
<p><img src="/2020/11/30/linux/yi-ci-java-jin-cheng-wu-li-nei-cun-zhan-yong-chao-guo-zui-da-dui-nei-cun-fen-xi/top.jpg" alt="top结果"></p>
<p><em>PS：上图为后续重新截的图,比第一次物理内存占用小</em></p>
<blockquote>
<p>JVM配置参数如下：</p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">server.java.opts&#x3D;-d64 -XX:MaxPermSize&#x3D;192M -Xms3000M -Xmx3000M -XX:+HeapDumpOnOutOfMemoryError<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h1 id="二、问题排查"><a href="#二、问题排查" class="headerlink" title="二、问题排查"></a>二、问题排查</h1><p>查看日志发现出现了<code>OOM</code>, 报错信息未：<code>java.lang.OutOfMemoryError: GC overhead limit exceeded</code>，并生成了堆内存快照文件java_pid31734.hprof。<br>通过jVisualVM工具分析<code>java_pid31734.hprof</code>文件。</p>
<p><img src="/2020/11/30/linux/yi-ci-java-jin-cheng-wu-li-nei-cun-zhan-yong-chao-guo-zui-da-dui-nei-cun-fen-xi/hprof.jpg" alt="hprof"></p>
<p>java进程发生OOM时生成的堆内存快照文件大小为3.4G。</p>
<p><img src="/2020/11/30/linux/yi-ci-java-jin-cheng-wu-li-nei-cun-zhan-yong-chao-guo-zui-da-dui-nei-cun-fen-xi/hprof_class.jpg" alt="hprof_class"></p>
<p>由于在项目中使用<code>POI</code>去读取Excel文件的，从内存快照中可以看到大量的内存被<code>POI</code>相关的对象占用。</p>
<p>发生OOM后java进程并没有退出，仍可以正常访问。接下来看一下Java进程的堆内存使用情况：</p>
<p><img src="/2020/11/30/linux/yi-ci-java-jin-cheng-wu-li-nei-cun-zhan-yong-chao-guo-zui-da-dui-nei-cun-fen-xi/jmap.jpg" alt="jmap result"></p>
<p>通过<code>jmap</code>查看JVM堆内存使用总计约为152.8 MB：100.07（年轻代） + 52.73（老年代），说明出现<code>OOM</code>后，占用的堆内存已经正常释放。</p>
<h2 id="2-1-为什么堆内存释放后java进程占用的物理内存没有收缩？"><a href="#2-1-为什么堆内存释放后java进程占用的物理内存没有收缩？" class="headerlink" title="2.1 为什么堆内存释放后java进程占用的物理内存没有收缩？"></a>2.1 为什么堆内存释放后java进程占用的物理内存没有收缩？</h2><p>项目启动后，该java进程占用内存也就1G多一点，进行导入Excel文件操作后，出现了OOM，但是后面堆内存已经正常释放，为什么该java进程占用物理内存没有释放？</p>
<h3 id="操作系统内存分配机制"><a href="#操作系统内存分配机制" class="headerlink" title="操作系统内存分配机制"></a>操作系统内存分配机制</h3><blockquote>
<p>进程向操作系统申请内存时，操作系统分配给进程的是虚拟内存空间，只有进程真正访问这块内存时，操作系统才会给进程分配物理内存。</p>
</blockquote>
<p>JVM启动时，向操作系统申请了<code>3000M</code>的内存，但是这<code>3000M</code>内存空间是虚拟内存空间，只有在java进程真正使用这些内存时操作系统才会去分配物理内。<br>由于JVM启动后，没有进行耗内存的操作，实际使用的内存空间较小，所以操作系统只分配真正使用到的物理内存给JVM，所以通过Top命令查看到的物理内存占用小于<code>3000M</code>。<br>但是在处理Excel导入时发生了OOM，说明java进程已经使用了全部的堆内存，此时操作系统会将堆内存大小的物理内存全部分配给JVM。<br>上述JVM启动参数配置为<code>-Xms3000M -Xmx3000M</code>, <code>Xms</code>为最小堆内存，<code>Xmx</code>为最大堆大小，由于这两个参数配置相同，所以JVM在堆内存空闲时仍不会归还物理内存给操作系统。<br>可以通过<code>pmap</code>命令看一下进程内存占用情况:</p>
<p><img src="/2020/11/30/linux/yi-ci-java-jin-cheng-wu-li-nei-cun-zhan-yong-chao-guo-zui-da-dui-nei-cun-fen-xi/pmap.jpg" alt="pmap"></p>
<p>从上图可以看出堆内存释放后，JVM底层并未将物理内存归还给操作系统。</p>
<h2 id="2-2-为什么java进程占用的内存大小超过了堆内存大小？"><a href="#2-2-为什么java进程占用的内存大小超过了堆内存大小？" class="headerlink" title="2.2 为什么java进程占用的内存大小超过了堆内存大小？"></a>2.2 为什么java进程占用的内存大小超过了堆内存大小？</h2><p>JVM 的内存大概分为下面这几个部分</p>
<ul>
<li><p>堆（Heap）：eden、survivor、old 区域等</p>
</li>
<li><p>线程栈（Thread Stack）：每个线程栈预留 1M 的线程栈大小</p>
</li>
<li><p>非堆（Non-heap）：包括 code_cache、metaspace 等</p>
</li>
<li><p>堆外内存：unsafe.allocateMemory 和 DirectByteBuffer申请的堆外内存</p>
</li>
<li><p>native （C&#x2F;C++ 代码）申请的内存</p>
</li>
<li><p>还有 JVM 运行本身需要的内存，比如 GC 等。</p>
</li>
</ul>
<p>除去JVM堆内存外，java进程本身会占用一些内存，所以会出现java进程的占用的总内存会比最大堆内存大的情况。</p>
<h1 id="三、POI读取超大Excel文件OOM问题"><a href="#三、POI读取超大Excel文件OOM问题" class="headerlink" title="三、POI读取超大Excel文件OOM问题"></a>三、POI读取超大Excel文件OOM问题</h1><p><code>POI</code>是读写Excel的常用工具包，功能非常丰富。但是<code>POI</code>的缺点也非常明显，在导入100万手机号码的Excel文件时，即使最大堆设置为<code>4000M</code>也还是会发生OOM的。<br>所以项目后续采用了阿里开源的<code>easyexcel</code>，<code>easyexcel</code><a href="https://github.com/alibaba/easyexcel">官网</a>给出的数据为：64M内存1分钟内读取75M(46W行25列)的Excel。<br>使用<code>easyexcel</code>后成功解决读取百万以上Excel数据OOM问题。</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://club.perfma.com/article/1709425">一次 Java 进程 OOM 的排查分析（glibc 篇）</a><br><a href="https://club.perfma.com/article/1850399">记一次堆外内存泄漏排查过程</a><br><a href="https://sploitfun.wordpress.com/2015/02/10/understanding-glibc-malloc/">Understanding glibc malloc</a></p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>内存泄露</tag>
        <tag>OOM</tag>
      </tags>
  </entry>
  <entry>
    <title>突然消失的Java进程</title>
    <url>/2020/11/19/linux/tu-ran-xiao-shi-de-java-jin-cheng/</url>
    <content><![CDATA[<h1 id="一、背景说明"><a href="#一、背景说明" class="headerlink" title="一、背景说明"></a>一、背景说明</h1><p>在一次大批量数据测试时，一个Java服务模块突然宕掉，并且连续出现了好几次。检查服务已经开启了打印堆栈信息<code>-XX:+HeapDumpOnOutOfMemoryError</code>,<br>但是在服务器运行目录下并没有发现.hprof文件生成。服务器总内存为16G，当前Java服务设置的内存为：<code>-Xms5000M -Xmx8000M</code>。</p>
<h1 id="二、原因分析"><a href="#二、原因分析" class="headerlink" title="二、原因分析"></a>二、原因分析</h1><p>Java进程突然被干掉无外乎以下三种情况：</p>
<ul>
<li>Linux OOM killer 杀死了Java进程</li>
<li>JVM自身故障</li>
<li>JVM OOM导致进程退出</li>
</ul>
<h2 id="2-1-Linux-的OOM-killer"><a href="#2-1-Linux-的OOM-killer" class="headerlink" title="2.1 Linux 的OOM killer"></a>2.1 Linux 的OOM killer</h2><p>Linux内核有一个OOM(out of memory) killer机制，当系统内存严重不足时，OOM killer会选择一个或多个进程杀死。关于OOM killer机制可参考上一篇文章<a href="https://www.mpoom.cn/2020/11/19/Linux%E4%B8%AD%E7%9A%84CommitLimit%E4%B8%8EOOMKiller/">Linux中的CommitLimit与OOM Killer</a>.。<br>因此，当java进程突然消失时，首先怀疑是不是被OOM killer杀掉了。</p>
<blockquote>
<p>查看系统日志文件<code>/var/log/messages</code></p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">$egrep -i &#39;killed process&#39; &#x2F;var&#x2F;log&#x2F;messages
Nov 19 16:24:31 localhost kernel: Killed process 26980 (java) total-vm:14316628kB, anon-rss:6138236kB, file-rss:0kB, shmem-rss:0kB<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<blockquote>
<p>查看linux系统内核日志</p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">$dmesg | grep java
[3571149.337671] Out of memory: Kill process 26980 (java) score 243 or sacrifice child
[3571149.338458] Killed process 26980 (java) total-vm:14316628kB, anon-rss:6138236kB, file-rss:0kB, shmem-rss:0kB
[3571149.395860] java: page allocation failure: order:0, mode:0x201da
[3571149.395864] CPU: 0 PID: 26980 Comm: java Kdump: loaded Tainted: G             L ------------ T 3.10.0-957.el7.x86_64 #1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="2-2-JVM的自身故障"><a href="#2-2-JVM的自身故障" class="headerlink" title="2.2 JVM的自身故障"></a>2.2 JVM的自身故障</h2><p>当JVM发生致命错误导致崩溃时，会生成一个hs_err_pid_xxx.log这样的文件，该文件包含了导致 JVM crash 的重要信息，我们可以通过分析该文件定位到导致 JVM Crash 的原因，从而修复保证系统稳定。<br>默认情况下，该文件是生成在工作目录下的，当然也可以通过 JVM 参数指定生成路径：</p>
<pre class="line-numbers language-none"><code class="language-none">-XX:ErrorFile&#x3D;&#x2F;var&#x2F;log&#x2F;hs_err_pid&lt;pid&gt;.log<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这个文件主要包含如下内容：</p>
<ul>
<li>日志头文件</li>
<li>导致 crash 的线程信息</li>
<li>所有线程信息</li>
<li>安全点和锁信息</li>
<li>堆信息</li>
<li>本地代码缓存</li>
<li>编译事件</li>
<li>gc 相关记录</li>
<li>jvm 内存映射</li>
<li>jvm 启动参数</li>
<li>服务器信息</li>
</ul>
<h2 id="2-3-JVM的OOM"><a href="#2-3-JVM的OOM" class="headerlink" title="2.3 JVM的OOM"></a>2.3 JVM的OOM</h2><p>JVM由于有GC机制，一般很少发生OOM，但是如果出现内存泄露，就可能发生OOM导致java进程退出。<br>可以根据JVM的下面两个参数查找堆内存快照文件定位问题。</p>
<pre class="line-numbers language-none"><code class="language-none">-XX:+HeapDumpOnOutOfMemoryError
-XX:HeapDumpPath&#x3D;*&#x2F;java.hprof<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>找到dump快照文件，借助一些MAT或VisualVM这一类可视化工具分析问题原因。</p>
<h1 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h1><p>当java进程突然消失时，可以先查看是否有dump文件；如果没有dump文件，再查看是否有hs_err_pid.log日志；如果也没有，则查看内核日志。</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://www.cnblogs.com/rjzheng/p/11317889.html">JAVA进程突然消失的原因?</a><br><a href="https://www.jianshu.com/p/7652f931cafd">JVM致命错误日志(hs_err_pid.log)分析</a></p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>常用文本分类模型简介</title>
    <url>/2024/03/06/machine-learning/chang-yong-wen-ben-fen-lei-mo-xing/</url>
    <content><![CDATA[<h1 id="1-背景简介"><a href="#1-背景简介" class="headerlink" title="1.背景简介"></a>1.背景简介</h1><p>本文主要介绍常见的文本分类算法模型及其优缺点，下面关键收集自互联网，按需获取。</p>
<h1 id="2-文本分类模型"><a href="#2-文本分类模型" class="headerlink" title="2.文本分类模型"></a>2.文本分类模型</h1><p>在文本分类中，有多种模型可以进行选择，如果您不知道选哪个，可以选择CNN 进行尝试，兼顾了运行效率和最终结果。以下是模型的说明，您可以根据自己的具体场景，选择一个更适合的模型。</p>
<ul>
<li><p><strong>FastText</strong> : 分类模型速度快，计算资源要求低，适合样本数量大、类别标签多，适合不需要太多语义理解的任务。</p>
</li>
<li><p><strong>CNN</strong>: 分类模型相比FastText 模型，CNN 适用复杂度更高的场景，可捕捉更多、更广、更细致的文本特征，适合需要一定语义理解的任务。对比FastText 通常效果要好一些，但训练时间也会更长。</p>
</li>
<li><p><strong>Self-Attention</strong>: 分类模型相比FastText 模型，Self-Attention 适应复杂度更高的场景，可捕捉更多、更广、更细致的特征；跟CNN 相比，能更好地捕捉文本里的长期依赖。适合需要一定语义理解的任务。训练时间跟效果跟 CNN 类似。</p>
</li>
<li><p><strong>BERT</strong>: 小样本分类模型，主要原理为使用 BERT模型 从大量无标注语料进行预训练。适用于标注语料有限的场景，训练和预测时间较长。</p>
</li>
<li><p><strong>StructBERT</strong>: 主要原理为使用StructBERT模型 从大量无标注语料进行预训练，精度较高，推理速度较慢。</p>
</li>
<li><p><strong>StructBERT小样本分类</strong>: 基于StructBert-base，在xnli数据集（将英文数据集重新翻译得到中文数据集）上面进行了自然语言推理任务训练。<br>适用场景：面向文本分类任务，尤其是多层级（最多3级）、标签数目大，训练样本少的低资源场景。时间开销会比较大<br>典型输入样例：支持最多3层的层级分类，3层标签字段固定为“一级标签”、“二级标签”和“三级标签”。每一层为单标签分类</p>
</li>
</ul>
<h1 id="3-开源仓库"><a href="#3-开源仓库" class="headerlink" title="3.开源仓库"></a>3.开源仓库</h1><p><a href="https://github.com/649453932/Chinese-Text-Classification-Pytorch">Chinese-Text-Classification-Pytorch</a></p>
<p><a href="https://github.com/649453932/Bert-Chinese-Text-Classification-Pytorch">Bert-Chinese-Text-Classification-Pytorch</a></p>
<h1 id="4-参考文档"><a href="#4-参考文档" class="headerlink" title="4.参考文档"></a>4.参考文档</h1><p><a href="https://zhuanlan.zhihu.com/p/73176084">中文文本分类 pytorch实现</a></p>
<p><a href="https://help.aliyun.com/document_detail/162446.html?spm=a2c4g.162450.0.0.53fb36f1QHZ5iE">模型说明</a></p>
]]></content>
      <categories>
        <category>机器学习</category>
      </categories>
      <tags>
        <tag>机器学习</tag>
        <tag>文本分类</tag>
      </tags>
  </entry>
  <entry>
    <title>Nacos简介及使用</title>
    <url>/2021/08/25/middleware/nacos-jian-jie-ji-shi-yong/</url>
    <content><![CDATA[<h1 id="《Nacos简介及使用》"><a href="#《Nacos简介及使用》" class="headerlink" title="《Nacos简介及使用》"></a>《Nacos简介及使用》</h1><span id="more"></span>
<div class="pdf-container" style="width: 100%; height: 600px; margin: 20px 0; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
    <iframe src="./Nacos简介及使用.pdf" width="100%" height="100%" frameborder="0" style="border: none; border-radius: 8px;">
      <div style="padding: 20px; text-align: center; background-color: #f8f9fa; border-radius: 8px;">
        <p style="margin: 0; color: #666;">您的浏览器不支持显示PDF文件</p>
        <a href="./Nacos简介及使用.pdf" target="_blank" style="color: #409eff; text-decoration: none; font-weight: 500;">📥 点击这里下载PDF文件</a>
      </div>
    </iframe>
  </div>]]></content>
      <categories>
        <category>中间件</category>
      </categories>
      <tags>
        <tag>Nacos</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux服务器重启后mysqld.service未创建/var/run/mysqld</title>
    <url>/2021/12/20/mysql/linux-fu-wu-qi-chong-qi-hou-mysqld.service-wei-chuang-jian-mysqld.pid-fu-mu-lu-wen-ti/</url>
    <content><![CDATA[<h1 id="一、问题背景"><a href="#一、问题背景" class="headerlink" title="一、问题背景"></a>一、问题背景</h1><p>开发环境的数据库服务器重启后，启动MySQl服务报错，错误如下：</p>
<pre class="line-numbers language-none"><code class="language-none">[ERROR] &#x2F;usr&#x2F;sbin&#x2F;mysqld: Can&#39;t create&#x2F;write to file &#39;&#x2F;var&#x2F;run&#x2F;mysqld&#x2F;mysqld.pid&#39; (Errcode: 2 - No such file or directory)
[ERROR] Can&#39;t start server: can&#39;t create PID file: No such file or directory<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>之前看到上面错误日志都是手动创建<code>/var/run/mysqld</code>目录，然后将目录的属主修改为mysql用户，如下：</p>
<pre class="line-numbers language-none"><code class="language-none">mkdir -p &#x2F;var&#x2F;run&#x2F;mysqld
chown mysql:mysql &#x2F;var&#x2F;run&#x2F;mysqld<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>上面方式，每次服务器重启后都要重新执行，所以分析一下问题原因，探索一种永久的解决方案。</p>
<blockquote>
<p>MySQL版本信息<br>mysql  Ver 14.14 Distrib 5.7.10, for Linux (x86_64) using  EditLine wrapper</p>
</blockquote>
<h1 id="二、问题原因"><a href="#二、问题原因" class="headerlink" title="二、问题原因"></a>二、问题原因</h1><p>通过查找发现该问题是MySQL5.7的一个小bug，详见：<br><a href="https://bugs.mysql.com/bug.php?id=100506">Bug #100506	mysqld.service does not create &#x2F;var&#x2F;run&#x2F;mysqld after reboot</a></p>
<p>该问题的主要原因是&#x2F;var&#x2F;run目录是一个临时目录，存在于内存之中，系统重启后&#x2F;var&#x2F;run目录下的文件将会被擦除。</p>
<pre class="line-numbers language-none"><code class="language-none">[root@develop log]# ll &#x2F;var&#x2F;run
lrwxrwxrwx. 1 root root 6 Sep 27 22:33 &#x2F;var&#x2F;run -&gt; ..&#x2F;run

[root@develop log]# df -hT
Filesystem                Type      Size  Used Avail Use% Mounted on
&#x2F;dev&#x2F;mapper&#x2F;centos00-root xfs        30G   22G  8.0G  74% &#x2F;
devtmpfs                  devtmpfs   16G     0   16G   0% &#x2F;dev
tmpfs                     tmpfs      16G     0   16G   0% &#x2F;dev&#x2F;shm
tmpfs                     tmpfs      16G  682M   15G   5% &#x2F;run<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从上面可以看出，<code>/var/run</code>目录通过软连接挂载在<code>/run</code>目录下，<code>/run</code>目录文件系统类型为<code>tmpfs</code></p>
<h2 id="原因总结："><a href="#原因总结：" class="headerlink" title="原因总结："></a>原因总结：</h2><p>安装MySQL时，mysql-community-server-5.7.31-1.el7.x86_64 rpm 创建了<code>/var/run/mysqld</code>目录，系统重启后这个目录被擦除了。</p>
<h1 id="三、解决方案"><a href="#三、解决方案" class="headerlink" title="三、解决方案"></a>三、解决方案</h1><h2 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h2><p>使用<code>tmpfiles.d</code>在系统启动的时候创建<code>/var/run/mysqld</code>目录，<a href="https://www.freedesktop.org/software/systemd/man/tmpfiles.d.html">tmpfiles.d简介</a>。<br>在<code>/usr/lib/tmpfiles.d</code>目录下创建<code>mysql.conf</code>文件，文件内容如下：</p>
<pre class="line-numbers language-none"><code class="language-none">d &#x2F;run&#x2F;mysqld 0755 mysql mysql  -<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>或直接使用如下命令：</p>
<pre class="line-numbers language-none"><code class="language-none">echo &quot;d &#x2F;var&#x2F;run&#x2F;mysqld 0755 mysql mysql -&quot; &gt; &#x2F;usr&#x2F;lib&#x2F;tmpfiles.d&#x2F;mysql.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>操作系统重启后会根据<code>/usr/lib/tmpfiles.d/mysql.conf</code>创建<code>/var/run/mysqld</code>目录。</p>
<h2 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h2><p>修改MySQL配置文件<code>/etc/my.cnf</code>中的<code>pid-file</code>的路径，文件内容如下：</p>
<pre class="line-numbers language-none"><code class="language-none">
datadir&#x3D;&#x2F;data&#x2F;deploy&#x2F;mysql&#x2F;data
socket&#x3D;&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;mysql.sock

# Disabling symbolic-links is recommended to prevent assorted security risks
symbolic-links&#x3D;0

log-error&#x3D;&#x2F;var&#x2F;log&#x2F;mysqld.log
pid-file&#x3D;&#x2F;var&#x2F;run&#x2F;mysqld&#x2F;mysqld.pid

skip-external-locking
key_buffer_size &#x3D; 256M
max_allowed_packet &#x3D; 16M
table_open_cache &#x3D; 2048
sort_buffer_size &#x3D; 2M
read_buffer_size &#x3D; 2M
read_rnd_buffer_size &#x3D; 8M
myisam_sort_buffer_size &#x3D; 64M
thread_cache_size &#x3D; 64
query_cache_size &#x3D; 256M
max_connections &#x3D; 1024

default-storage-engine&#x3D;INNODB
lower_case_table_names&#x3D;1
explicit_defaults_for_timestamp&#x3D;true
sql_mode&#x3D;STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION
character_set_server&#x3D; utf8<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>将’pid-file<code>文件路径修改为</code>&#x2F;var&#x2F;lib&#x2F;mysql&#96;.</p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL中MVCC是否真的能够解决幻读问题？</title>
    <url>/2019/04/30/mysql/mysql-zhong-mvcc-shi-fou-zhen-de-neng-gou-jie-jue-huan-du-wen-ti/</url>
    <content><![CDATA[<p>&emsp;&emsp;偶然间看到同事在看MySQL的MVCC问题，就随口插了一句，“MVCC模式解决了MySQL中的幻读问题”，但是</p>
<p>同事告诉我并没有，我说不可能，我清楚的记得在看《高性能MySQL 第3版》一书的事务隔离级别中的，在介绍**REPEATABLE READ **隔离级别时候提过，MVCC解决了幻读的问题。说完我还找到了书中内容给他看，内容如下：</p>
<p>英文原版：</p>
<blockquote>
<ul>
<li>REPEATABLE READ</li>
</ul>
<p> REPEATABLE READ solves the problems that READ UNCOMMITTED allows. It guarantees<br> that any rows a transaction reads will “look the same” in subsequent reads within<br> the same transaction, but in theory it still allows another tricky problem: phantom<br> reads. Simply put, a phantom read can happen when you select some range of rows,<br> another transaction inserts a new row into the range, and then you select the same<br> range again; you will then see the new “phantom” row. InnoDB and XtraDB solve<br> the phantom read problem with multiversion concurrency control, which we explain later in this chapter.<br> REPEATABLE READ is MySQL’s default transaction isolation level. </p>
</blockquote>
<p>中文版：</p>
<blockquote>
<ul>
<li><p>REPEATABLE READ(可重复读)</p>
<p>REPEATABLE READ解决了脏读的问题。该级别保证了在同一个事务中多次读取同样记录的结果是一致的。但是理论上,可重复读隔离级别还是无法解决另外一个幻读( Phantom read)的问题。所谓幻读,指的是当某个事务在读取某个范围内的记录时另外一个事务又在该范围内插入了新的记录,当之前的事务再次读取该范围的记录时,会产生幻行( Phantom row)。 InnoDB和 XtraDB存储引擎通过多版本并发控制(MVCC, Multiversion Concurrency Control)解决了幻读的问题。本章稍后会做进一步的讨论。</p>
<p>可重复读是 MySQL的默认事务隔离级别。</p>
</li>
</ul>
</blockquote>
<p>同事说这也是他正在查找的问题，并给我演示了一个案例，相关表结构数据如下：</p>
<pre class="line-numbers language-none"><code class="language-none">CREATE TABLE &#96;employee&#96; (
  &#96;Id&#96; int(11) NOT NULL AUTO_INCREMENT,
  &#96;Name&#96; varchar(50) DEFAULT NULL,
  &#96;Salary&#96; int(11) DEFAULT NULL,
  &#96;DepartmentId&#96; int(11) DEFAULT NULL,
  PRIMARY KEY (&#96;Id&#96;)
) ENGINE&#x3D;InnoDB AUTO_INCREMENT&#x3D;5 DEFAULT CHARSET&#x3D;utf8;

insert  into &#96;employee&#96;(&#96;Id&#96;,&#96;Name&#96;,&#96;Salary&#96;,&#96;DepartmentId&#96;) values (1,&#39;Joe&#39;,70000,1);
insert  into &#96;employee&#96;(&#96;Id&#96;,&#96;Name&#96;,&#96;Salary&#96;,&#96;DepartmentId&#96;) values (2,&#39;Henry&#39;,80000,2);
insert  into &#96;employee&#96;(&#96;Id&#96;,&#96;Name&#96;,&#96;Salary&#96;,&#96;DepartmentId&#96;) values (3,&#39;Sam&#39;,6000,2);
insert  into &#96;employee&#96;(&#96;Id&#96;,&#96;Name&#96;,&#96;Salary&#96;,&#96;DepartmentId&#96;) values (4,&#39;Max&#39;,90000,1);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>事务执行流程如下：</p>
<p><img src="/2019/04/30/mysql/mysql-zhong-mvcc-shi-fou-zhen-de-neng-gou-jie-jue-huan-du-wen-ti/%E4%BA%8B%E5%8A%A1%E6%BC%94%E7%A4%BA.png" alt="MySQL幻读的情景演示"></p>
<ul>
<li><p>1、开始事务A</p>
</li>
<li><p>2、查询employee表中所有数据</p>
<p><img src="/2019/04/30/mysql/mysql-zhong-mvcc-shi-fou-zhen-de-neng-gou-jie-jue-huan-du-wen-ti/%E5%BC%80%E5%A7%8B%E4%BA%8B%E5%8A%A1A.png" alt="开始事务A"></p>
</li>
<li><p>3、开始事务B</p>
</li>
<li><p>4、向employee表中插入2条数据</p>
</li>
<li><p>5、提交事务B</p>
<p><img src="/2019/04/30/mysql/mysql-zhong-mvcc-shi-fou-zhen-de-neng-gou-jie-jue-huan-du-wen-ti/%E6%89%A7%E8%A1%8C%E4%BA%8B%E5%8A%A1B.png" alt="执行事务B"></p>
</li>
<li><p>6、在事务A中执行查询</p>
<p><img src="/2019/04/30/mysql/mysql-zhong-mvcc-shi-fou-zhen-de-neng-gou-jie-jue-huan-du-wen-ti/%E4%BA%8B%E5%8A%A1B%E6%8F%90%E4%BA%A4%E5%90%8E%E5%86%8D%E6%AC%A1%E5%9C%A8%E4%BA%8B%E5%8A%A1A%E4%B8%AD%E6%9F%A5%E8%AF%A2.png" alt="事务B提交后再次在事务A中查询"></p>
</li>
</ul>
<p>&emsp;&emsp;从这里我们可以看出MySQL的默认事务隔离级别（REPEATABLE READ）解决不可重复读的问题，但是对于幻读我们继续验证。</p>
<ul>
<li><p>7、更新employee表中的所有数据， 将DepartmentId都设置为1</p>
</li>
<li><p>8、更新操作执行后再次查询</p>
<p><img src="/2019/04/30/mysql/mysql-zhong-mvcc-shi-fou-zhen-de-neng-gou-jie-jue-huan-du-wen-ti/%E6%9B%B4%E6%96%B0%E5%90%8E%E5%86%8D%E6%AC%A1%E6%9F%A5%E8%AF%A2.png" alt="更新后再次查询"></p>
</li>
</ul>
<p>此时我们发现，在A事务中竟然能够查看到B事务插入的2条数据，我们再来回顾一下脏读、不可重复读和幻读的定义及现象：</p>
<p>以下内容均来自MySQL官网：<a href="https://dev.mysql.com/doc/refman/5.7/en/">https://dev.mysql.com/doc/refman/5.7/en/</a></p>
<p><strong>脏读：</strong></p>
<blockquote>
<ul>
<li><p>dirty read </p>
<p>An operation that retrieves unreliable data, data that was updated by another transaction but not yet committed. It is only possible with the isolation level known as read uncommitted.</p>
</li>
</ul>
</blockquote>
<p>脏读意味着一个事务读取了另一个事务未提交的数据,而这个数据是有可能回滚。</p>
<p><strong>不可重复读：</strong></p>
<blockquote>
<ul>
<li><p>non-repeatable read </p>
<p>The situation when a query retrieves data, and a later query within the same transaction retrieves what should be the same data, but the queries return different results (changed by another transaction committing in the meantime).</p>
</li>
</ul>
</blockquote>
<p>不可重复读意味着在同一个事务中，不同时间的相同查询的返回结果不一致，由于另外已提交的事务修改了数据。</p>
<p><strong>幻读：</strong></p>
<blockquote>
<ul>
<li><p>phantom </p>
<p>A row that appears in the result set of a query, but not in the result set of an earlier query. For example, if a query is run twice within a transaction, and in the meantime, another transaction commits after inserting a new row or updating a row so that it matches the WHERE clause of the query.</p>
</li>
</ul>
</blockquote>
<p>幻读意味着在同一个事务中，相同的查询在最新的结果集中出现了新的行数据。</p>
<p>总结：根据上面的实验案例以及幻读的定义，上述案例确实存在幻读的问题，接下来我们简单介绍一下MVCC的实现原理，并结合MySQL源码分析一下幻读产生的原因。</p>
<h1 id="什么是MVCC？"><a href="#什么是MVCC？" class="headerlink" title="什么是MVCC？"></a>什么是MVCC？</h1><p>为什么会出现幻读的问题？在解释这个问题之前，我们先简单介绍一下MySQL中MVCC。</p>
<p><strong>MVCC简介：</strong></p>
<p>引用：<a href="http://mysql.taobao.org/monthly/2017/12/01/">[阿里数据库内核’2017&#x2F;12’月报]</a></p>
<blockquote>
<p>多版本并发控制(Multiversion concurrency control， MCC 或 <strong>MVCC</strong>)指的是一种提高并发的技术。最早的数据库系统，只有读读之间可以并发，读写，写读，写写都要阻塞。引入多版本之后，只有写写之间相互阻塞，其他三种操作都可以并行，这样大幅度提高了InnoDB的并发度。在内部实现中，与Postgres在数据行上实现多版本不同，InnoDB是在undolog中实现的，通过undolog可以找回数据的历史版本。找回的数据历史版本可以提供给用户读(按照隔离级别的定义，有些读请求只能看到比较老的数据版本)，也可以在回滚的时候覆盖数据页上的数据。在InnoDB内部中，会记录一个全局的活跃读写事务数组，其主要用来判断事务的可见性。</p>
</blockquote>
<p>下面两篇文章对MySQL的InnoDB的MVCC实现进行详细介绍：</p>
<ul>
<li><a href="https://segmentfault.com/a/1190000012650596">MySQL-InnoDB-MVCC多版本并发控制</a></li>
<li><a href="http://mysql.taobao.org/monthly/2017/12/01/">[阿里数据库内核’2017&#x2F;12’月报]</a></li>
</ul>
<h1 id="为什么会出现幻读？"><a href="#为什么会出现幻读？" class="headerlink" title="为什么会出现幻读？"></a>为什么会出现幻读？</h1><p>在了解了MVCC的原理之后我们再来看一下源码</p>
<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">UNIV_INTERN
dberr_t
row_search_for_mysql(
&#x2F;*&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;*&#x2F;
  byte*   buf,    &#x2F;* 用来存放记录的空间地址 *&#x2F;
  ulint   mode,   &#x2F;* InnoDB页扫描顺序 *&#x2F;
  row_prebuilt_t* prebuilt, &#x2F;* InnoDB扫描需要的所有信息都包含在这个结构体，比如表以及Index等信息 *&#x2F;
  ulint   match_mode, &#x2F;* 对于Index的匹配模式，是精确匹配还是前缀索引匹配 *&#x2F;
  ulint   direction)  &#x2F;* 指定扫描顺序，正序还是倒叙扫描 *&#x2F;
&#123;
	...
	&#x2F;* 从这里我们看出开始一个新事务，并非是从执行BEGIN语句位置开始，而是从其后开始执行的第一条语句开始分配事务ID *&#x2F;
	trx_start_if_not_started(trx, ((trx-&gt;mysql_thd
          &amp;&amp; thd_is_select(trx-&gt;mysql_thd)
          ) || srv_read_only_mode) ? FALSE : TRUE); 

	...
	&#x2F;&#x2F; 如果是SQL语句第一次开始执行，需要考虑对TABLE增加意向所

	 if (!prebuilt-&gt;sql_stat_start) &#123;
	 &#x2F;&#x2F; 这里标记SQL语句已经开始执行，处理一条SQL语句循环扫描记录的过程
    &#x2F;* No need to set an intention lock or assign a read view *&#x2F;

    if (UNIV_UNLIKELY
        (trx-&gt;read_view &#x3D;&#x3D; NULL 
         &amp;&amp; prebuilt-&gt;select_lock_type &#x3D;&#x3D; LOCK_NONE)) &#123;
      ...
	    &#125;
  &#125; else if (prebuilt-&gt;select_lock_type &#x3D;&#x3D; LOCK_NONE) &#123;
	...
  &#125; else &#123;
	&#x2F;&#x2F; 这里开始非INSERT的DML操作，因为DML会对记录增加记录排他锁。具体需要增加什么类型的锁，可以参考https:&#x2F;&#x2F;dev.mysql.com&#x2F;doc&#x2F;refman&#x2F;5.7&#x2F;en&#x2F;innodb-locking.html
 wait_table_again:
	&#x2F;&#x2F; 这里要对TABLE加意向锁
    err &#x3D; lock_table(0, index-&gt;table,
         prebuilt-&gt;select_lock_type &#x3D;&#x3D; LOCK_S
         ? LOCK_IS : LOCK_IX, thr);

    if (err !&#x3D; DB_SUCCESS) &#123;

      table_lock_waited &#x3D; TRUE;
      goto lock_table_wait;
    &#125;    
    prebuilt-&gt;sql_stat_start &#x3D; FALSE;
  &#125;

	...
  if (prebuilt-&gt;select_lock_type !&#x3D; LOCK_NONE) &#123;
	 ulint lock_type;

    if (!set_also_gap_locks
        || srv_locks_unsafe_for_binlog
        || trx-&gt;isolation_level &lt;&#x3D; TRX_ISO_READ_COMMITTED
        || (unique_search &amp;&amp; !rec_get_deleted_flag(rec, comp))) &#123;
	  &#x2F;&#x2F; 这里对于READ_UNCOMMITTED以及READ_COMMITTED,或者唯一键扫描不需要使用gap锁
      goto no_gap_lock;
    &#125; else &#123;
      lock_type &#x3D; LOCK_ORDINARY;
    &#125;
	
	&#x2F;* If we are doing a &#39;greater or equal than a primary key
    value&#39; search from a clustered index, and we find a record
    that has that exact primary key value, then there is no need
    to lock the gap before the record, because no insert in the
    gap can be in our search range. That is, no phantom row can
    appear that way.

    An example: if col1 is the primary key, the search is WHERE
    col1 &gt;&#x3D; 100, and we find a record where col1 &#x3D; 100, then no
    need to lock the gap before that record. *&#x2F;

    if (index &#x3D;&#x3D; clust_index
        &amp;&amp; mode &#x3D;&#x3D; PAGE_CUR_GE
        &amp;&amp; direction &#x3D;&#x3D; 0
        &amp;&amp; dtuple_get_n_fields_cmp(search_tuple)
        &#x3D;&#x3D; dict_index_get_n_unique(index)
        &amp;&amp; 0 &#x3D;&#x3D; cmp_dtuple_rec(search_tuple, rec, offsets)) &#123;
no_gap_lock:
      lock_type &#x3D; LOCK_REC_NOT_GAP;
    &#125;

	    err &#x3D; sel_set_rec_lock(btr_pcur_get_block(pcur),
               rec, index, offsets,
               prebuilt-&gt;select_lock_type,
               lock_type, thr);

    switch (err) &#123;
      const rec_t*  old_vers;
    case DB_SUCCESS_LOCKED_REC:
      if (srv_locks_unsafe_for_binlog
          || trx-&gt;isolation_level
          &lt;&#x3D; TRX_ISO_READ_COMMITTED) &#123;
        &#x2F;* Note that a record of
        prebuilt-&gt;index was locked. *&#x2F;
        prebuilt-&gt;new_rec_locks &#x3D; 1;
      &#125;
      err &#x3D; DB_SUCCESS;
    case DB_SUCCESS:
	 &#x2F;&#x2F; 加锁成功后就认为记录可见了，并未像SELECT语句一样根据事务开始的READ_VIEW进行可见性判断。所以对于DML来说，所有提交的事务都是可见的。
      break;
    case DB_LOCK_WAIT:
	      &#x2F;* Never unlock rows that were part of a conflict. *&#x2F;
	  &#x2F;&#x2F; 如果存在锁冲突，也就是其他事务正在更新同一行
      prebuilt-&gt;new_rec_locks &#x3D; 0;

      if (UNIV_LIKELY(prebuilt-&gt;row_read_type
          !&#x3D; ROW_READ_TRY_SEMI_CONSISTENT)
          || unique_search
          || index !&#x3D; clust_index) &#123;

        goto lock_wait_or_error;
      &#125;

      &#x2F;* The following call returns &#39;offsets&#39;
      associated with &#39;old_vers&#39; *&#x2F;
	  &#x2F;&#x2F; 这里需要查看是否有别的事务提交了，以便获取最新版本的记录
      row_sel_build_committed_vers_for_mysql(
        clust_index, prebuilt, rec,
        &amp;offsets, &amp;heap, &amp;old_vers, &amp;mtr);

      &#x2F;* Check whether it was a deadlock or not, if not
      a deadlock and the transaction had to wait then
      release the lock it is waiting on. *&#x2F;
	        err &#x3D; lock_trx_handle_wait(trx);

      switch (err) &#123;
      case DB_SUCCESS:
        &#x2F;* The lock was granted while we were
        searching for the last committed version.
        Do a normal locking read. *&#x2F;

        offsets &#x3D; rec_get_offsets(
          rec, index, offsets, ULINT_UNDEFINED,
          &amp;heap);
        goto locks_ok;
      case DB_DEADLOCK:
        goto lock_wait_or_error;
      case DB_LOCK_WAIT:
        err &#x3D; DB_SUCCESS;
        break;
      default:
        ut_error;
      &#125;
	        if (old_vers &#x3D;&#x3D; NULL) &#123;
        &#x2F;* The row was not yet committed *&#x2F;

        goto next_rec;
      &#125;
	  did_semi_consistent_read &#x3D; TRUE;
      rec &#x3D; old_vers;
      break;
    default:

      goto lock_wait_or_error;
    &#125;

	&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>从上面的代码我们可以看到，对于UPDATE操作更新的记录包含幻读读取到的已提交事务的最新记录。那么接下来看为什么UPDATE之后的SELECT语句对于UPDATE之后的所有语句都可见了？ 原因是前面的UPDATE语句执行之后，会将当前记录上存储的事务信息更新为当前的事务，而当前事务所做的任何更新，对本事务所有SELECT查询都变的可见，因此最后输出的结果是UPDATE执行后更新的所有记录。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>从上我们可以知道，MySQL的**REPEATABLE READ **隔离级别和MVCC只解决了部分幻读的问题，意味着这一隔离级别仍旧可能出现幻读。该问题的发现同时也提醒着以后不能死读书，应该边读边想多实践，把书中的知识转换为我们自己的想法，而不是生搬硬套。</p>
<blockquote>
<p><strong>引用参考</strong></p>
<p><a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-multi-versioning.html">MySQL官网</a></p>
<p><a href="http://mysql.taobao.org/monthly/2017/06/07/">MySQL · 源码分析 · InnoDB Repeatable Read隔离级别之大不同</a></p>
<p><a href="http://mysql.taobao.org/monthly/2017/12/01/">[阿里数据库内核’2017&#x2F;12’月报]</a></p>
<p><a href="http://mysql.taobao.org/monthly/2017/06">[数据库内核月报 2017 &#x2F; 06]</a></p>
</blockquote>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>mysql mvcc</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL插入速度测试</title>
    <url>/2019/07/02/mysql/mysql-cha-ru-su-du-ce-shi/</url>
    <content><![CDATA[<h2 id="一、测试环境"><a href="#一、测试环境" class="headerlink" title="一、测试环境"></a>一、测试环境</h2><h3 id="1-1-硬件环境"><a href="#1-1-硬件环境" class="headerlink" title="1.1 硬件环境"></a>1.1 硬件环境</h3><table>
<thead>
<tr>
<th>名称</th>
<th>配置</th>
</tr>
</thead>
<tbody><tr>
<td>操作系统</td>
<td>win7 64位</td>
</tr>
<tr>
<td>CPU</td>
<td>4核4线程 i5-4590</td>
</tr>
<tr>
<td>内存</td>
<td>16G</td>
</tr>
<tr>
<td>硬盘</td>
<td>128G SSD</td>
</tr>
<tr>
<td>MySQL</td>
<td>Version 5.6</td>
</tr>
</tbody></table>
<h3 id="1-2-数据库表结构"><a href="#1-2-数据库表结构" class="headerlink" title="1.2 数据库表结构"></a>1.2 数据库表结构</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>user<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>password<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>sex<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>phone<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>email<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>remark<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="二、插入实验"><a href="#二、插入实验" class="headerlink" title="二、插入实验"></a>二、插入实验</h2><h3 id="2-1-普通插入"><a href="#2-1-普通插入" class="headerlink" title="2.1 普通插入"></a>2.1 普通插入</h3><table>
<thead>
<tr>
<th>线程数</th>
<th>插入量（万）</th>
<th>总耗时（毫秒）</th>
<th>平均插入速度（条&#x2F;秒）</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>100</td>
<td>342844</td>
<td>2923</td>
</tr>
<tr>
<td>4</td>
<td>400</td>
<td>480112</td>
<td>8333</td>
</tr>
<tr>
<td>8</td>
<td>800</td>
<td>693702</td>
<td>11544</td>
</tr>
<tr>
<td>16</td>
<td>1600</td>
<td>1246522</td>
<td>12841</td>
</tr>
</tbody></table>
<h3 id="2-2-批量插入"><a href="#2-2-批量插入" class="headerlink" title="2.2 批量插入"></a>2.2 批量插入</h3><blockquote>
<p>批次大小： 500条</p>
</blockquote>
<table>
<thead>
<tr>
<th>线程数</th>
<th>插入量（万）</th>
<th>总耗时（毫秒）</th>
<th>平均插入速度（条&#x2F;秒）</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>100</td>
<td>42793</td>
<td>23364</td>
</tr>
<tr>
<td>4</td>
<td>400</td>
<td>58856</td>
<td>68027</td>
</tr>
<tr>
<td>8</td>
<td>800</td>
<td>109688</td>
<td>72939</td>
</tr>
<tr>
<td>16</td>
<td>1600</td>
<td>216542</td>
<td>73903</td>
</tr>
</tbody></table>
<blockquote>
<p>批次大小： 1000条</p>
</blockquote>
<table>
<thead>
<tr>
<th>线程数</th>
<th>插入量（万）</th>
<th>总耗时（毫秒）</th>
<th>平均插入速度（条&#x2F;秒）</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>100</td>
<td>42771</td>
<td>23380</td>
</tr>
<tr>
<td>4</td>
<td>400</td>
<td>55098</td>
<td>72595</td>
</tr>
<tr>
<td>8</td>
<td>800</td>
<td>106554</td>
<td>75082</td>
</tr>
<tr>
<td>16</td>
<td>1600</td>
<td>216353</td>
<td>73971</td>
</tr>
</tbody></table>
<h1 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h1><p>本次实验主要是测试一下MySQL的插入速度到底有多快，让我们在开发过程中心理有底，测试数据库文件是存储到固态硬盘上的，所以速度肯定比在普通磁盘上快。测试主要围绕多线程插入和批量插入这两个点，从实验结果来看，我们可以得出以下两点结论：</p>
<ul>
<li>多线程插入确实是能够提高MySQL的插入速度，但是线程数超过系统核心线程数后，已经没有太大提升效果，所以建议多线程插入时，线程数保持和系统核心线程数一致。</li>
<li>MySQL批量插入能极大提高插入速度，每批次1000条插入的速度是单条插入速度的8倍左右，在大数据量插入时建议使用批量插入的方式，批次大小建议设置为1000条左右，可根据具体的业务情况调整。MySQL数据包默认大小为4M，超过该值会导致插入或更新失败，批量插入时应考虑该因素，可通过<code>SHOW VARIABLES LIKE &#39;%max_allowed_packet%&#39;</code>查看，该值可以修改。</li>
</ul>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL索引合并优化</title>
    <url>/2022/01/07/mysql/mysql-suo-yin-he-bing-you-hua/</url>
    <content><![CDATA[<h1 id="一、问题背景"><a href="#一、问题背景" class="headerlink" title="一、问题背景"></a>一、问题背景</h1><p>之前遇到过一个关于MySQL索引的面试题，问题如下：</p>
<blockquote>
<p>一张数据库表t其中有3列为a、b、c，分别为每一个列单独建立一个二级索引，那么现在有一个查询条件<code>select * from t where a=? and b=? and c=?</code><br>请问上述SQL语句，MySQL存储引擎在执行查询的时候，哪些索引将会被使用到？</p>
</blockquote>
<p>当时一顿分析，还谈到了MySQL基于成本估算的优化，认为MySQL优化器先基于a、b、c三个列的索引区分度，选择索引区分度较高的索引进行扫描，根据第一个索引的扫描结果，如果第一个索引的扫描结果集高于一个固定量级，则继续选择第二个索引进行扫描，依次判断是否需要使用第三个索引，如果第一个索引的扫描结果集小于一个固定量级，则直接根据第一个索引的扫描结果集进行回表查询到列记录，再根据未使用到的2列进行过滤。</p>
<p>最后得出的结果是：a、b、c 3个索引都可能被使用到，具体使用到哪些索引，取决于3个索引的区分度以及表的数据量。</p>
<h2 id="正确答案"><a href="#正确答案" class="headerlink" title="正确答案"></a>正确答案</h2><p>上面的问题应该用<code>索引合并优化</code>的原理来分析，上述的SQL的where条件满足了索引合并优化中的<code>Index Merge Intersection Access Algorithm</code>,<br>存储引擎将会同时使用3个索引进行扫描，将扫描到的结果集取交集后返回给MySQL Server，然后再进行回表查询。</p>
<h1 id="二、索引合并优化"><a href="#二、索引合并优化" class="headerlink" title="二、索引合并优化"></a>二、索引合并优化</h1><p>索引合并访问方法检索具有多个范围扫描的行并将其结果合并为一个。 此访问方法仅合并来自单个表的索引扫描，而不是跨多个表的扫描。 合并可以生成其底层扫描的并集、交集或交集并集。</p>
<h2 id="索引合并的查询案例"><a href="#索引合并的查询案例" class="headerlink" title="索引合并的查询案例"></a>索引合并的查询案例</h2><pre class="line-numbers language-none"><code class="language-none">SELECT * FROM tbl_name WHERE key1 &#x3D; 10 OR key2 &#x3D; 20;

SELECT * FROM tbl_name
  WHERE (key1 &#x3D; 10 OR key2 &#x3D; 20) AND non_key &#x3D; 30;

SELECT * FROM t1, t2
  WHERE (t1.key1 IN (1,2) OR t1.key2 LIKE &#39;value%&#39;)
  AND t2.key1 &#x3D; t1.some_col;

SELECT * FROM t1, t2
  WHERE t1.key1 &#x3D; 1
  AND (t2.key1 &#x3D; t1.some_col OR t2.key2 &#x3D; t1.some_col2);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<h3 id="Note"><a href="#Note" class="headerlink" title="Note"></a>Note</h3><p>索引合并优化具有以下已知限制：</p>
<ul>
<li>如果您的查询有一个带有深度 AND&#x2F;OR 嵌套的复杂 WHERE 子句，并且 MySQL 没有选择最佳计划，请尝试使用以下身份转换分配术语：</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">(x AND y) OR z &#x3D;&gt; (x OR z) AND (y OR z)
(x OR y) AND z &#x3D;&gt; (x AND z) OR (y AND z)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ul>
<li>索引合并不适用于全文索引</li>
</ul>
</blockquote>
<p>在 <code>EXPLAIN</code> 输出中，Index Merge 方法在 <code>type</code> 列中显示为 <code>index_merge</code>。 在这种情况下，键列包含使用的索引列表，而 <code>key_len</code> 包含这些索引的最长键部分的列表。</p>
<p>Index Merge 访问方法有几种算法，显示在 EXPLAIN 输出的 Extra 字段中：</p>
<ul>
<li><p>Using intersect(…)</p>
</li>
<li><p>Using union(…)</p>
</li>
<li><p>Using sort_union(…)</p>
</li>
</ul>
<p>以下部分更详细地描述了这些算法。 优化器根据各种可用选项的成本估计在不同可能的索引合并算法和其他访问方法之间进行选择。</p>
<p>索引合并的使用取决于MySQL优化器开关,分别是系统变量 index_merge、index_merge_intersection、index_merge_union 和 index_merge_sort_union 标志的值。<br>请参见第 8.9.2 节，“可切换的优化”。 默认情况下，所有这些标志都打开。<br>要仅启用某些算法，请将 index_merge 设置为关闭，并仅启用应允许的其他算法。</p>
<ul>
<li><p>Index Merge Intersection Access Algorithm</p>
</li>
<li><p>Index Merge Union Access Algorithm</p>
</li>
<li><p>Index Merge Sort-Union Access Algorithm</p>
</li>
</ul>
<h2 id="Index-Merge-Intersection-Access-Algorithm（索引合并交集访问算法）"><a href="#Index-Merge-Intersection-Access-Algorithm（索引合并交集访问算法）" class="headerlink" title="Index Merge Intersection Access Algorithm（索引合并交集访问算法）"></a>Index Merge Intersection Access Algorithm（索引合并交集访问算法）</h2><p>此访问算法适用于将 WHERE 子句转换为与 AND 结合的不同键上的多个范围条件的情况，并且每个条件都是以下之一：</p>
<ul>
<li>这种形式的 N 部分表达式，其中索引正好有 N 部分（即，组合索引所有索引部分都被覆盖）：</li>
</ul>
 <pre class="line-numbers language-none"><code class="language-none">-- 二级索引必须是等值查询，如果是组合索引，则组合索引的每一列都必须覆盖到
key_part1 &#x3D; const1 AND key_part2 &#x3D; const2 ... AND key_partN &#x3D; constN<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ul>
<li>InnoDB 表的主键上的任何范围条件。</li>
</ul>
<h3 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h3><pre class="line-numbers language-none"><code class="language-none">SELECT * FROM innodb_table
  WHERE primary_key &lt; 10 AND key_col1 &#x3D; 20;

SELECT * FROM tbl_name
  WHERE key1_part1 &#x3D; 1 AND key1_part2 &#x3D; 2 AND key2 &#x3D; 2;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>索引合并交集算法对所有使用的索引执行同时扫描，并生成它从合并索引扫描接收的行序列的交集。</p>
<ul>
<li>如果查询中使用的所有列都被使用的索引覆盖，则不会检索完整的表行（在这种情况下，EXPLAIN 输出包含在 Extra 字段中使用索引）。以下是此类查询的示例：</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">SELECT COUNT(*) FROM t1 WHERE key1 &#x3D; 1 AND key2 &#x3D; 1;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>如果使用的索引未覆盖查询中使用的所有列，则仅当满足所有使用的键的范围条件时才检索完整的行。</li>
<li>如果其中一个合并条件是对 InnoDB 表的主键的条件，则它不用于行检索，而是用于过滤掉使用其他条件检索到的行。</li>
</ul>
<h2 id="Index-Merge-Union-Access-Algorithm-索引合并并集访问算法）"><a href="#Index-Merge-Union-Access-Algorithm-索引合并并集访问算法）" class="headerlink" title="Index Merge Union Access Algorithm(索引合并并集访问算法）"></a>Index Merge Union Access Algorithm(索引合并并集访问算法）</h2><p>此算法的标准类似于索引合并交集算法的标准。 该算法适用于将表的 WHERE 子句转换为不同键上的多个范围条件并结合 OR 的情况，并且每个条件都是以下之一：</p>
<ul>
<li>这种形式的 N 部分表达式，其中索引正好有 N 部分（即，组合索引所有索引部分都被覆盖）：</li>
</ul>
 <pre class="line-numbers language-none"><code class="language-none">key_part1 &#x3D; const1 AND key_part2 &#x3D; const2 ... AND key_partN &#x3D; constN<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>InnoDB 表的主键上的任何范围条件。</li>
<li>索引合并交集算法适用的条件。</li>
</ul>
<h3 id="Examples-1"><a href="#Examples-1" class="headerlink" title="Examples"></a>Examples</h3><pre class="line-numbers language-none"><code class="language-none">SELECT * FROM t1
  WHERE key1 &#x3D; 1 OR key2 &#x3D; 2 OR key3 &#x3D; 3;

SELECT * FROM innodb_table
  WHERE (key1 &#x3D; 1 AND key2 &#x3D; 2)
     OR (key3 &#x3D; &#39;foo&#39; AND key4 &#x3D; &#39;bar&#39;) AND key5 &#x3D; 5;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Index-Merge-Sort-Union-Access-Algorithm-索引合并排序并集访问算法"><a href="#Index-Merge-Sort-Union-Access-Algorithm-索引合并排序并集访问算法" class="headerlink" title="Index Merge Sort-Union Access Algorithm(索引合并排序并集访问算法)"></a>Index Merge Sort-Union Access Algorithm(索引合并排序并集访问算法)</h2><p>该访问算法适用于WHERE子句转换为多个OR组合的范围条件，但不适用Index Merge union算法。</p>
<h3 id="Examples-2"><a href="#Examples-2" class="headerlink" title="Examples"></a>Examples</h3><pre class="line-numbers language-none"><code class="language-none">SELECT * FROM tbl_name
  WHERE key_col1 &lt; 10 OR key_col2 &lt; 20;

SELECT * FROM tbl_name
  WHERE (key_col1 &gt; 10 OR key_col2 &#x3D; 20) AND nonkey_col &#x3D; 30;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>排序并集算法和并集算法之间的区别在于排序并集算法必须首先获取所有行的行 ID 并在返回任何行之前对它们进行排序。</p>
<h1 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h1><h2 id="索引合并交集访问算法"><a href="#索引合并交集访问算法" class="headerlink" title="索引合并交集访问算法"></a>索引合并交集访问算法</h2><p><code>WHERE</code>条件之间使用<code>AND</code>结合，而且每个条件必须满足以下两个条件：</p>
<ul>
<li>二级索引必须是等值查询，如果是组合索引，组合索引的每一列都必须覆盖到</li>
<li>InnoDB表的主键范围条件查询</li>
</ul>
<h2 id="索引合并并集访问算法"><a href="#索引合并并集访问算法" class="headerlink" title="索引合并并集访问算法"></a>索引合并并集访问算法</h2><p>与<code>索引合并交集访问算法</code>类似，不过使用了<code>OR</code>连接条件，且满足以下条件：</p>
<ul>
<li>二级索引必须是等值查询，如果是组合索引，组合索引的每一列都必须覆盖到</li>
<li>InnoDB表的主键范围条件查询</li>
<li>符合<code>索引合并交集访问算法</code>的条件</li>
</ul>
<h2 id="索引合并排序并集访问算法"><a href="#索引合并排序并集访问算法" class="headerlink" title="索引合并排序并集访问算法"></a>索引合并排序并集访问算法</h2><p>二级索引不必等值查询，联合索引也不必匹配所有的索引项</p>
<h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p><a href="https://dev.mysql.com/doc/refman/5.7/en/index-merge-optimization.html">8.2.1.3 Index Merge Optimization</a></p>
<p><a href="https://gentlezuo.github.io/2019/09/11/MySQL%EF%BC%9A%E7%B4%A2%E5%BC%95%E5%90%88%E5%B9%B6/#%E7%B4%A2%E5%BC%95%E5%90%88%E5%B9%B6">MySQL：索引合并</a></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>索引合并</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL调优案例分享</title>
    <url>/2020/04/27/mysql/mysql-diao-you-an-li-fen-xiang/</url>
    <content><![CDATA[<h1 id="MySQL调优案例分享——技术分享"><a href="#MySQL调优案例分享——技术分享" class="headerlink" title="MySQL调优案例分享——技术分享"></a>MySQL调优案例分享——技术分享</h1><span id="more"></span>
<div class="pdf-container" style="width: 100%; height: 600px; margin: 20px 0; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
    <iframe src="./MySQL调优案例分享.pdf" width="100%" height="100%" frameborder="0" style="border: none; border-radius: 8px;">
      <div style="padding: 20px; text-align: center; background-color: #f8f9fa; border-radius: 8px;">
        <p style="margin: 0; color: #666;">您的浏览器不支持显示PDF文件</p>
        <a href="./MySQL调优案例分享.pdf" target="_blank" style="color: #409eff; text-decoration: none; font-weight: 500;">📥 点击这里下载PDF文件</a>
      </div>
    </iframe>
  </div>]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL行锁升级邻键锁的Bug引起死锁问题排查</title>
    <url>/2023/03/09/mysql/yi-ge-qi-guai-de-shu-ju-ku-si-suo-wen-ti-pai-cha/</url>
    <content><![CDATA[<h1 id="一、问题现象"><a href="#一、问题现象" class="headerlink" title="一、问题现象"></a>一、问题现象</h1><p>线上接口在并发请求的场景部分请求失败，查询线上日志发现时出现死锁，异常日志如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>exceptions<span class="token punctuation">.</span></span>PersistenceException</span><span class="token operator">:</span>
### <span class="token class-name">Error</span> querying <span class="token class-name"><span class="token namespace">database<span class="token punctuation">.</span></span> Cause</span><span class="token operator">:</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>exceptions<span class="token punctuation">.</span>jdbc4<span class="token punctuation">.</span></span>MySQLTransactionRollbackException</span><span class="token operator">:</span> <span class="token class-name">Deadlock</span> found when trying <span class="token keyword">to</span> <span class="token namespace">get</span> lock<span class="token punctuation">;</span> <span class="token keyword">try</span> restarting transaction
### <span class="token class-name">The</span> error may exist in com<span class="token operator">/</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>/dao<span class="token operator">/</span>mapper<span class="token operator">/</span><span class="token class-name">ShortLinkMapper</span><span class="token punctuation">.</span>xml
### <span class="token class-name">The</span> error may involve defaultParameterMap
### <span class="token class-name">The</span> error occurred <span class="token keyword">while</span> setting parameters
### <span class="token constant">SQL</span><span class="token operator">:</span> select <span class="token operator">*</span> from short_link_id_map where table_name_index <span class="token operator">=</span> <span class="token operator">?</span> and year <span class="token operator">=</span> <span class="token operator">?</span> <span class="token keyword">for</span> update
### <span class="token class-name">Cause</span><span class="token operator">:</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>exceptions<span class="token punctuation">.</span>jdbc4<span class="token punctuation">.</span></span>MySQLTransactionRollbackException</span><span class="token operator">:</span> <span class="token class-name">Deadlock</span> found when trying <span class="token keyword">to</span> <span class="token namespace">get</span> lock<span class="token punctuation">;</span> <span class="token keyword">try</span> restarting transaction<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>根据异常日志，是在执行<code>select for update</code>时产生了死锁，接下来分析一下死锁日志并结合业务逻辑分析出死锁的原因。</p>
<h1 id="二、业务逻辑分析"><a href="#二、业务逻辑分析" class="headerlink" title="二、业务逻辑分析"></a>二、业务逻辑分析</h1><p>该接口是一个短链生成接口，提供批量生成短链的能力，业务逻辑如下：</p>
<ul>
<li>1.客户端调用ID短链接口，批量生成短链</li>
<li>2.接口从缓存队列中获取短链ID，如果队列为空则先批量获取1000个短链ID加入队列</li>
<li>3.获取短链ID完成后，同步更新短链ID映射表</li>
</ul>
<blockquote>
<p>短链ID映射表：短链记录按天分表，根据短链ID映射表确认短链所在的分表<br><img src="/2023/03/09/mysql/yi-ge-qi-guai-de-shu-ju-ku-si-suo-wen-ti-pai-cha/%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B.png" alt="业务逻辑"></p>
</blockquote>
<h2 id="数据库表结构"><a href="#数据库表结构" class="headerlink" title="数据库表结构"></a>数据库表结构</h2><pre class="line-numbers language-SQL" data-language="SQL"><code class="language-SQL">create table short_link_id_map
(
    year             int not null comment &#39;年份&#39;,
    table_name_index varchar(10)      not null comment &#39;短连接表名后缀，主键&#39;,
    start_id         bigint           null comment &#39;开始ID&#39;,
    end_id           bigint           null comment &#39;结束ID&#39;,
    primary key (year, table_name_index)
)
    comment &#39;短连接ID映射表&#39;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="产生死锁的事务"><a href="#产生死锁的事务" class="headerlink" title="产生死锁的事务"></a>产生死锁的事务</h2><pre class="line-numbers language-SQL" data-language="SQL"><code class="language-SQL">-- 1.获取ID短链映射记录，只会有一条记录
select * from short_link_id_map
where table_name_index &#x3D; #&#123;tableNameIndex&#125; and year &#x3D; #&#123;year&#125;
for update;
-- 2.短链ID映射记录存在，则更新endId
update short_link_id_map set end_id &#x3D; #&#123;endId&#125;
where table_name_index&#x3D;$&#123;tableNameIndex&#125; and year&#x3D;#&#123;year&#125;
and end_id &lt; #&#123;endId&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>产生死锁的事务如上，其中事务中的第一条语句使用了<code>select for update</code>，目的是为了解决多节点并发插入引起主键冲突。</p>
<h2 id="事务执行场景"><a href="#事务执行场景" class="headerlink" title="事务执行场景"></a>事务执行场景</h2><p>根据线上环境，事务执行的情况如下图所示：<br><img src="/2023/03/09/mysql/yi-ge-qi-guai-de-shu-ju-ku-si-suo-wen-ti-pai-cha/%E4%BA%8B%E5%8A%A1%E6%89%A7%E8%A1%8C%E7%A4%BA%E6%84%8F%E5%9B%BE.png" alt="事务执行示意图"><br>在单节点下不会出现死锁，而多个节点并发的执行上面的事务，就会出现死锁的现象。<br><img src="/2023/03/09/mysql/yi-ge-qi-guai-de-shu-ju-ku-si-suo-wen-ti-pai-cha/%E6%AD%BB%E9%94%81%E6%97%A5%E5%BF%97.png" alt="死锁日志"></p>
<h2 id="死锁分析"><a href="#死锁分析" class="headerlink" title="死锁分析"></a>死锁分析</h2><p>首先我们得了解MySQL中加锁的基本单位是邻键锁（行锁 + 间隙锁），如果遇到唯一索引，则邻键锁退化为行锁，详情请参阅<a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-locking.html">MySQL官网</a>。<br>第一条SQL：<code>select for update</code> ,where条件使用了主键索引，所以在查询记录上加行锁。<br>第二条SQL：<code>update</code>, 由于where条件是会走主键索引，所以也是在要更新的记录上加行锁。<br>根据事务中的SQL操作，两条SQL会对同一个行记录加行锁，理论上是不会产生死锁的。从SQL中无法分析出产生死锁具体原因，所以需要查看MySQL的死锁日志。</p>
<h1 id="三、死锁日志"><a href="#三、死锁日志" class="headerlink" title="三、死锁日志"></a>三、死锁日志</h1><p>使用<code>SHOW ENGINE INNODB STATUS;</code>命令查看最后一个死锁日志，内容如下：</p>
<pre class="line-numbers language-SQL" data-language="SQL"><code class="language-SQL">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;
2023-03-07 12:58:29 0x7fe705b44700 INNODB MONITOR OUTPUT
&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;
Per second averages calculated from the last 9 seconds
-----------------
BACKGROUND THREAD
-----------------
srv_master_thread loops: 100159 srv_active, 0 srv_shutdown, 1185548 srv_idle
srv_master_thread log flush and writes: 1285611
----------
SEMAPHORES
----------
OS WAIT ARRAY INFO: reservation count 209834
OS WAIT ARRAY INFO: signal count 212844
RW-shared spins 0, rounds 407264, OS waits 186247
RW-excl spins 0, rounds 316974, OS waits 7975
RW-sx spins 28, rounds 627, OS waits 12
Spin rounds per wait: 407264.00 RW-shared, 316974.00 RW-excl, 22.39 RW-sx
------------------------
LATEST DETECTED DEADLOCK
------------------------
2023-03-07 12:57:09 0x7fe72781c700
*** (1) TRANSACTION:
TRANSACTION 1686739378, ACTIVE 0 sec starting index read
mysql tables in use 1, locked 1
LOCK WAIT 2 lock struct(s), heap size 1136, 1 row lock(s)
MySQL thread id 10768, OS thread handle 140630204196608, query id 4101047 172.16.124.217 root statistics
select *
        from short_link_id_map
        where table_name_index &#x3D; &#39;0303&#39;
          and year &#x3D; 2023
        for update
*** (1) WAITING FOR THIS LOCK TO BE GRANTED:
-- 事务1：等待一个行锁，这个行锁是添加到主键索引上的
RECORD LOCKS space id 25270 page no 3 n bits 160 index PRIMARY of table &#96;db&#96;.&#96;short_link_id_map&#96; trx id 1686739378 lock_mode X locks rec but not gap waiting
-- 事务1：等待的行锁对应的行内容如下：
Record lock, heap no 88 PHYSICAL RECORD: n_fields 6; compact format; info bits 0
 0: len 4; hex 800007e7; asc     ;;
 1: len 4; hex 30333033; asc 0303;;
 2: len 6; hex 000064899693; asc   d   ;;
 3: len 7; hex 6c000014e80d9a; asc l      ;;
 4: len 8; hex 8000000002e70503; asc         ;;
 5: len 8; hex 8000000002e70513; asc         ;;
 
*** (2) TRANSACTION:
TRANSACTION 1686739377, ACTIVE 0 sec starting index read
mysql tables in use 1, locked 1
3 lock struct(s), heap size 1136, 2 row lock(s)
MySQL thread id 10760, OS thread handle 140630776989440, query id 4101048 172.16.124.217 root updating
update short_link_id_map
         SET end_id &#x3D; 48694547
        where table_name_index&#x3D;0303 and year&#x3D;2023
          
            and end_id &lt; 48694547
*** (2) HOLDS THE LOCK(S):
-- 事务2：持有一个行锁，这个行锁是添加到主键索引上的
RECORD LOCKS space id 25270 page no 3 n bits 160 index PRIMARY of table &#96;db&#96;.&#96;short_link_id_map&#96; trx id 1686739377 lock_mode X locks rec but not gap
-- 事务2：持有的行锁对应的行内容如下：
Record lock, heap no 88 PHYSICAL RECORD: n_fields 6; compact format; info bits 0
 0: len 4; hex 800007e7; asc     ;;
 1: len 4; hex 30333033; asc 0303;;
 2: len 6; hex 000064899693; asc   d   ;;
 3: len 7; hex 6c000014e80d9a; asc l      ;;
 4: len 8; hex 8000000002e70503; asc         ;;
 5: len 8; hex 8000000002e70513; asc         ;;
 
*** (2) WAITING FOR THIS LOCK TO BE GRANTED:
-- 事务2：等带一个邻键锁，这个行锁是添加到主键索引上的
RECORD LOCKS space id 25270 page no 3 n bits 160 index PRIMARY of table &#96;db&#96;.&#96;short_link_id_map&#96; trx id 1686739377 lock_mode X waiting
-- 事务2:等待的加锁的记录内容如下：
Record lock, heap no 88 PHYSICAL RECORD: n_fields 6; compact format; info bits 0
 0: len 4; hex 800007e7; asc     ;;
 1: len 4; hex 30333033; asc 0303;;
 2: len 6; hex 000064899693; asc   d   ;;
 3: len 7; hex 6c000014e80d9a; asc l      ;;
 4: len 8; hex 8000000002e70503; asc         ;;
 5: len 8; hex 8000000002e70513; asc         ;;
 
*** WE ROLL BACK TRANSACTION (1)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="日志分析"><a href="#日志分析" class="headerlink" title="日志分析"></a>日志分析</h2><p>根据以上异常日志，我们详细分析可以得出以下结论。</p>
<ul>
<li>事务1：等待行锁（lock_mode X locks rec but not gap waiting）</li>
<li>事务2：持有行锁（lock_mode X locks rec but not gap）</li>
<li>事务2：等待邻键锁（lock_mode X waiting）</li>
</ul>
<p>根据事务推进顺序，<code>事务2</code>持有一个行锁，<code>事务1</code>等待<code>事务2</code>持有的行锁，<code>事务2</code>申请一个邻键锁，而且这个邻键锁等待<code>事务2</code>自己持有的行锁。从而触发死锁检测条件，最后回滚<code>事务1</code>，导致<code>事务1</code>对应的请求失败。</p>
<h2 id="为什么会产生死锁？"><a href="#为什么会产生死锁？" class="headerlink" title="为什么会产生死锁？"></a>为什么会产生死锁？</h2><p>从以上的死锁日志来看，发生死锁的两个事务，<code>事务1</code>只是在等待锁并没有持有锁，而<code>事务2</code>持有一个行锁，再次申请该行锁对应的邻键锁时触发了死锁检测，导致<code>事务1</code>回滚。<br>而根据我们的分析，此时并不存在锁竞争，为什么就死锁了呢？</p>
<h2 id="不符合理论的现象"><a href="#不符合理论的现象" class="headerlink" title="不符合理论的现象"></a>不符合理论的现象</h2><p>而且更为奇怪的是为什么第二条SQL执行update语句的SQL请求的是一个<code>邻键锁</code>，update语句明显是走了主键索引，主键索引则会将<code>邻键锁</code>退化为<code>行锁</code>，为什么在这个事务中<code>邻键锁</code>没有退化为<code>行锁</code>？</p>
<h2 id="死锁重现"><a href="#死锁重现" class="headerlink" title="死锁重现"></a>死锁重现</h2><p>在本地环境同时开启两个会话，按照上述事务推进顺序进行测试，并不会产生死锁。但是本地环境在进行并发测试的时候，则会频繁出现死锁。</p>
<h2 id="死锁产生的场景"><a href="#死锁产生的场景" class="headerlink" title="死锁产生的场景"></a>死锁产生的场景</h2><p>对于死锁检测的机制和我们对死锁的认知存在一定的区别，我在一个MySQL的一个bug清单中找到了MySQL团队给予的回复：</p>
<blockquote>
<p>The very misleading part of the output is that the section is titled “HOLDS THE LOCK(S)”, while in fact not every lock mentioned in this section is actually “held”. It’s still in the process of acquisition, as evidenced by the word “waiting”.<br>The reason this lock is listed in the section titled “HOLDS THE LOCK(S)” is because for the purpose of deadlock detection algorithm, a request for an X-lock is treated very similarly to already holding an X-lock.<br>And this is done to correctly model the fact, that transactions which request S-lock, have to wait not only for transactions already holding an X-lock, but also for transactions which merely requested it, but still wait for it to be granted - this is done to avoid the problem of “starvation of writers by readers”.<br>Another reason (perhaps more important for your case) which is a bit similar, is that a transaction which requests an X-lock, has to wait for its turn, giving priority to transaction which already waits for an X-lock (in mysql 5.6 and 5.7 there’s simply a FIFO queue, and in 8.0 there is also CATS algorithm, but both algorithms try to ensure that new-coming transaction waits for those already in queue). This again is done to avoid starvation: this time among writers themselves.<br>So, given that InnoDB forces transactions to wait for a transaction which waits for an X-lock, it might mean that a deadlock is possible, in which one of the edges in the deadlock cycle involves waiting for transaction which still waits for an X-lock.<br>And the simplest way to model it in the deadlock checking algorithm is to treat the “X-lock being waited for” as “already held”.</p>
</blockquote>
<p>输出中非常具有误导性的部分是该部分标题为“HOLDS THE LOCK(S)”，而实际上并非本节中提到的每个锁实际上都“持有”。 还在请求过程中，“待”字就是明证。<br>这个锁被列在标题为“HOLDS THE LOCK(S)”的部分中的原因是出于死锁检测算法的目的，对 X 锁的请求与已经持有 X 锁的处理方式非常相似。<br>这样做是为了正确地模拟这样一个事实，即请求 S 锁的事务不仅要等待已经持有 X 锁的事务，还要等待仅请求它但仍在等待它被授予的事务—— 这样做是为了避免“读请求饿死写请求”的问题。<br>另一个有点相似的原因（对于您的情况可能更重要）是请求 X 锁的事务必须等待轮到它，优先考虑已经等待 X 锁的事务（在 mysql 5.6 中 5.7 有一个简单的 FIFO 队列，8.0 也有 CATS 算法，但两种算法都试图确保新到来的事务等待已经在队列中的事务）。 这样做也是为了避免饥饿：这次是在写请求自己中间。<br>因此，鉴于 InnoDB 强制事务等待 X 锁的事务，这可能意味着死锁是可能的，其中死锁周期中的一个边缘涉及等待仍在等待 X- 的事务锁。<br>在死锁检查算法中对其建模的最简单方法是将“正在等待的 X 锁”视为“已持有”。</p>
<p>文章见：<a href="https://bugs.mysql.com/bug.php?id=101695">Weird deadlock behavior where a transaction holds a lock on an index, and the SAME transactions also waits for a lock on the exact SAME index</a></p>
<p>总结来说就是MySQL死锁检测算法按照相似方式处理<code>请求X锁的事务</code>与<code>持有X锁的事务</code>,因为多个事务请求X锁时需要进行排队，而X锁释放后会按照队列中的顺序去获得锁。<br>根据以上结论，死锁产生的原因为：事务2持有行锁，事务1请求行锁，事务2请求邻键锁需要在事务1后排队行程环路，从而触发了死锁检测，示意图如下：<br><img src="/2023/03/09/mysql/yi-ge-qi-guai-de-shu-ju-ku-si-suo-wen-ti-pai-cha/%E6%AD%BB%E9%94%81%E7%A4%BA%E6%84%8F%E5%9B%BE.png" alt="死锁示意图"></p>
<h2 id="仍存在的两个疑问？"><a href="#仍存在的两个疑问？" class="headerlink" title="仍存在的两个疑问？"></a>仍存在的两个疑问？</h2><p>通过上述的解释，我们明白了死锁产生的场景，但是有两个问题仍然存在疑问：</p>
<ul>
<li>为什么事务2在持有行锁的情况下，再请求一个邻键锁（行锁与间隙锁的组合）时被检测为死锁呢？</li>
<li>为什么在执行第二条update时明显走了主键索引，但请求的是邻键锁而不是行锁？</li>
</ul>
<h1 id="四、MySQL的一个BUG"><a href="#四、MySQL的一个BUG" class="headerlink" title="四、MySQL的一个BUG"></a>四、MySQL的一个BUG</h1><p>通过查看MySLQ加锁的源码解析，发现MySQL存在的一个bug，详情参见以下文章：<br><a href="https://leviathan.vip/2021/02/25/mysql-deadlock-bugfix-23755664/">InnoDB 死锁 Bug 排查</a><br><a href="https://bugs.mysql.com/bug.php?id=99095">Bug #82127	Deadlock with 3 concurrent DELETEs by UNIQUE key</a></p>
<h2 id="简而言之"><a href="#简而言之" class="headerlink" title="简而言之"></a>简而言之</h2><p>官方在 8.0.18 版本对死锁检测进行了优化, 将原先的死锁检测机制交给了<code>background thread</code> 来处理, 具体的Patch链接:<a href="https://github.com/mysql/mysql-server/commit/3859219875b62154b921e8c6078c751198071b9c">MySQL-8.0.18 死锁检测优化</a>. 具体的思路是将当前事务系统的 lock 信息打一份快照, 由这份快照判断是否存在回环, 假如存在死锁即唤醒等待事务.<br>而在 8.0.17 版本依然采用旧的死锁检测方法,每次申请<code>lock</code>失败进入<code>wait</code>状态后触发一下死锁检测,由于存在锁等待的环路，所以被检测为死锁。<br>用一句话来说就是MySQL 8.0.18之前不支持行锁升级到邻键锁，所以在持有行锁的情况下，基于此行锁升级至邻键锁时，由于存在等待环路，而被检测为死锁。</p>
<h1 id="五、邻键锁为什么没有退化为行锁"><a href="#五、邻键锁为什么没有退化为行锁" class="headerlink" title="五、邻键锁为什么没有退化为行锁"></a>五、邻键锁为什么没有退化为行锁</h1><p>通过上述MySQL的bug分析，我们了解到MySQL不支持锁升级导致了死锁的产生。<br>但是目前还存在一个问题，事务中第二条更新语句使用到主键索引，通过执行计划看也是会走主键索引，为什么这里的邻键锁没有退化为行锁呢？</p>
<pre class="line-numbers language-SQL" data-language="SQL"><code class="language-SQL">update short_link_id_map set end_id &#x3D; #&#123;endId&#125;
where table_name_index&#x3D;$&#123;tableNameIndex&#125; and year&#x3D;#&#123;year&#125;
and end_id &lt; #&#123;endId&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="猜想与验证"><a href="#猜想与验证" class="headerlink" title="猜想与验证"></a>猜想与验证</h2><p>因为这个表的记录并不多，总共不超过1000行，而MySQL的查询基于成本优化，是不是在成本优化后，没有选择走主键索引，二是走了全表扫描呢？<br>我们更新条件中除了有主见索引外，还有一个普通列，是否查询条件会影响MySQL的执行计划，我们将update修改为select通过执行计划验证一下：<br><img src="/2023/03/09/mysql/yi-ge-qi-guai-de-shu-ju-ku-si-suo-wen-ti-pai-cha/%E5%85%A8%E8%A1%A8%E6%89%AB%E6%8F%8F%E9%AA%8C%E8%AF%81.png" alt="全表扫描验证"><br>根据以上验证结果，我们可以发现，当我们修改where条件中的主键索引后面的条件时，执行计划显示会存在走全表扫描的情况。</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>更新操作虽然使用了主键索引，但是同时存在一个普通的where条件，而且由于表内容较少，在并发请求时有一定的概率走全表扫描，而全表扫描则会加邻键锁。</p>
<h1 id="六、解决方案"><a href="#六、解决方案" class="headerlink" title="六、解决方案"></a>六、解决方案</h1><p>根据业务场景，我们使用<code>select for update</code>主要时为了解决并发插入主键冲突的问题，但是实际业务中一天只会进行一次插入，其余的都是更新操作。所以我们直接去除了select中的<code>for update</code>,减小了事务，对于并发插入问题，使用<code>insert ... on duplicate key update</code>解决并发插入的问题。</p>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p><code>insert ... on duplicate key update</code>在并发情况下也会产生死锁，但是实际业务中并存在这种场景。具体原因这里不做展开，有兴趣的同学可以自己探索一下，死锁日志如下；</p>
<pre class="line-numbers language-SQL" data-language="SQL"><code class="language-SQL">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;
2023-03-07 16:01:08 0x7fe705b44700 INNODB MONITOR OUTPUT
&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;
Per second averages calculated from the last 46 seconds
-----------------
BACKGROUND THREAD
-----------------
srv_master_thread loops: 100781 srv_active, 0 srv_shutdown, 1195883 srv_idle
srv_master_thread log flush and writes: 1296568
----------
SEMAPHORES
----------
OS WAIT ARRAY INFO: reservation count 211624
OS WAIT ARRAY INFO: signal count 214692
RW-shared spins 0, rounds 410284, OS waits 187670
RW-excl spins 0, rounds 326082, OS waits 8247
RW-sx spins 29, rounds 657, OS waits 12
Spin rounds per wait: 410284.00 RW-shared, 326082.00 RW-excl, 22.66 RW-sx
------------------------
LATEST DETECTED DEADLOCK
------------------------
2023-03-07 15:51:02 0x7fe705556700
*** (1) TRANSACTION:
TRANSACTION 1686742571, ACTIVE 0 sec inserting
mysql tables in use 1, locked 1
LOCK WAIT 4 lock struct(s), heap size 1136, 2 row lock(s)
MySQL thread id 10937, OS thread handle 140630203115264, query id 4160546 172.16.124.217 root update
insert into short_link_id_map (year, table_name_index, start_id, end_id)
        values (2023, &#39;0304&#39;, 48694560,
                48694570)
        on duplicate key update end_id &#x3D; if(end_id  &lt; 48694570, 48694570, end_id)
*** (1) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 25270 page no 3 n bits 160 index PRIMARY of table &#96;cmp_gsms_2.0&#96;.&#96;gsms_short_link_id_map&#96; trx id 1686742571 lock_mode X locks gap before rec insert intention waiting
Record lock, heap no 89 PHYSICAL RECORD: n_fields 6; compact format; info bits 0
 0: len 4; hex 80000833; asc    3;;
 1: len 4; hex 31323331; asc 1231;;
 2: len 6; hex 0000648995f6; asc   d   ;;
 3: len 7; hex 6f000014de10a9; asc o      ;;
 4: len 8; hex 8000000000000004; asc         ;;
 5: len 8; hex 8000000000001130; asc        0;;
 
*** (2) TRANSACTION:
TRANSACTION 1686742572, ACTIVE 0 sec inserting
mysql tables in use 1, locked 1
4 lock struct(s), heap size 1136, 2 row lock(s)
MySQL thread id 10938, OS thread handle 140630203655936, query id 4160547 172.16.124.217 root update
insert into gsms_short_link_id_map (year, table_name_index, start_id, end_id)
        values (2023, &#39;0304&#39;, 48694560,
                48694570)
        on duplicate key update end_id &#x3D; if(end_id  &lt; 48694570, 48694570, end_id)
*** (2) HOLDS THE LOCK(S):
RECORD LOCKS space id 25270 page no 3 n bits 160 index PRIMARY of table &#96;cmp_gsms_2.0&#96;.&#96;gsms_short_link_id_map&#96; trx id 1686742572 lock_mode X locks gap before rec
Record lock, heap no 89 PHYSICAL RECORD: n_fields 6; compact format; info bits 0
 0: len 4; hex 80000833; asc    3;;
 1: len 4; hex 31323331; asc 1231;;
 2: len 6; hex 0000648995f6; asc   d   ;;
 3: len 7; hex 6f000014de10a9; asc o      ;;
 4: len 8; hex 8000000000000004; asc         ;;
 5: len 8; hex 8000000000001130; asc        0;;
 
*** (2) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 25270 page no 3 n bits 160 index PRIMARY of table &#96;cmp_gsms_2.0&#96;.&#96;gsms_short_link_id_map&#96; trx id 1686742572 lock_mode X locks gap before rec insert intention waiting
Record lock, heap no 89 PHYSICAL RECORD: n_fields 6; compact format; info bits 0
 0: len 4; hex 80000833; asc    3;;
 1: len 4; hex 31323331; asc 1231;;
 2: len 6; hex 0000648995f6; asc   d   ;;
 3: len 7; hex 6f000014de10a9; asc o      ;;
 4: len 8; hex 8000000000000004; asc         ;;
 5: len 8; hex 8000000000001130; asc        0;;
 
*** WE ROLL BACK TRANSACTION (2)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="七、总结"><a href="#七、总结" class="headerlink" title="七、总结"></a>七、总结</h1><ul>
<li>MySQL的死锁检测算法中，虽然一个事务在请求X锁而并不持有X锁，仍会触发死锁检测，原因由于请求X锁会进行排队；</li>
<li>MySQL 8.0.18 版本之前不支持行锁升级至邻键锁或更严格的锁，这与MySQL的死锁键锁实现机制相关；</li>
<li>update操作的where条件中存在主键索引与普通列，在并发场景下，存在一定概率走全表扫描，而至于为什么会走全表，则需要探索MySQL的成本优化机制。</li>
</ul>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://keithlan.github.io/2017/06/05/innodb_locks_1/">https://keithlan.github.io/2017/06/05/innodb_locks_1/</a><br><a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-locking.html">https://dev.mysql.com/doc/refman/5.7/en/innodb-locking.html</a><br><a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-locks-set.html">https://dev.mysql.com/doc/refman/8.0/en/innodb-locks-set.html</a><br><a href="https://leviathan.vip/2021/02/25/mysql-deadlock-bugfix-23755664/">https://leviathan.vip/2021/02/25/mysql-deadlock-bugfix-23755664/</a><br><a href="https://bugs.mysql.com/bug.php?id=82127">https://bugs.mysql.com/bug.php?id=82127</a></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>死锁</tag>
        <tag>行锁</tag>
        <tag>邻键锁</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx代理配置中的DNS缓存问题</title>
    <url>/2020/08/04/nginx/nginx-dai-li-pei-zhi-zhong-de-dns-huan-cun-wen-ti/</url>
    <content><![CDATA[<h1 id="一、问题背景"><a href="#一、问题背景" class="headerlink" title="一、问题背景"></a>一、问题背景</h1><p>客户内网环境不允许应用服务器直接访问外网，必须通过跳板机访问外网，所在使用Nginx代理访问外网，部署架构图可参考<a href="https://www.mpoom.cn/2020/07/31/Nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86HTTP%E7%9A%84header%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8F%82%E6%95%B0%E4%B8%A2%E5%A4%B1%E9%97%AE%E9%A2%98/">Nginx反向代理HTTP header自定义参数丢失问题</a>。<br>在部署完成后，测试代理接口都正常，但是一段时间过后，就出现了外网接口访问超时的问题。</p>
<h1 id="二、问题排查"><a href="#二、问题排查" class="headerlink" title="二、问题排查"></a>二、问题排查</h1><p>Nginx代理的外网接口都是通过域名进行访问，发现请求超时后，直接在服务器上ping请求地址中的域名，发现域名是可以ping通的，后面继续观察请求超时的情况，发现每次出现请求超时时，在服务器都是能直接ping通请求中的域名，但是服务器每次ping命令解析后的IP与上一次不同，在服务器则无法ping通上次解析后的IP，所以怀疑是不是Nginx缓存了DNS解析。通过查阅文档，发现Nginx在启动时会检查域名是否能够解析，在第一次请求时会缓存DNS解析记录，并且忽略了DNS中的TTL值永久缓存。</p>
<blockquote>
<p>注意：在使用Nginx进行反向代理时，如果配置的是域名，突然出现了404问题时，可以查看域名绑定的IP是否发生了变更，如果这种变更不频繁，可以重启Nginx解决，重启Nginx后域名会重新进行解析。</p>
</blockquote>
<h1 id="三、问题分析与解决"><a href="#三、问题分析与解决" class="headerlink" title="三、问题分析与解决"></a>三、问题分析与解决</h1><p>外网接口中的域名是动态解析的，不同时间访问时域名解析后的IP是动态变化的，客户内网环境只能访问域名实时解析后的IP地址（外网环境验证过没有这个问题），上次解析后的IP会有无法访问的情况。刚开始发现请求超时后，重启Nginx即可解决超时问题，但这只能作为临时的解决方法。</p>
<p>通过查阅文档得知，nginx提供了<code>resolver</code>配置项，可以设置域名解析服务器，并设置缓存的有效期：</p>
<p>Nginx文档地址：<a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#resolver">http://nginx.org/en/docs/http/ngx_http_core_module.html#resolver</a></p>
<pre class="line-numbers language-none"><code class="language-none">Syntax:	resolver address ... [valid&#x3D;time] [ipv6&#x3D;on|off] [status_zone&#x3D;zone];
Default:	—
Context:	http, server, location
Configures name servers used to resolve names of upstream servers into addresses, for example:

resolver 127.0.0.1 [::1]:5353;
The address can be specified as a domain name or IP address, with an optional port (1.3.1, 1.2.2). If port is not specified, the port 53 is used. Name servers are queried in a round-robin fashion.

Before version 1.1.7, only a single name server could be configured. Specifying name servers using IPv6 addresses is supported starting from versions 1.3.1 and 1.2.2.
By default, nginx will look up both IPv4 and IPv6 addresses while resolving. If looking up of IPv6 addresses is not desired, the ipv6&#x3D;off parameter can be specified.

Resolving of names into IPv6 addresses is supported starting from version 1.5.8.
By default, nginx caches answers using the TTL value of a response. An optional valid parameter allows overriding it:

resolver 127.0.0.1 [::1]:5353 valid&#x3D;30s;
Before version 1.1.9, tuning of caching time was not possible, and nginx always cached answers for the duration of 5 minutes.
To prevent DNS spoofing, it is recommended configuring DNS servers in a properly secured trusted local network.
The optional status_zone parameter (1.17.1) enables collection of DNS server statistics of requests and responses in the specified zone. The parameter is available as part of our commercial subscription.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>修改Nginx配置文件如下：</p>
<pre class="line-numbers language-none"><code class="language-none">server &#123;
    listen       9000;
    server_name  localhost;
    resolver 114.114.114.114 valid&#x3D;60s;

    location &#x2F;ncs&#x2F;mobile&#x2F;phone-verify &#123;
        set $mobile www.cmpassport.com;
        proxy_pass https:&#x2F;&#x2F;$mobile&#x2F;openapi&#x2F;rs&#x2F;tokenValidate;
        proxy_read_timeout 300;
        proxy_connect_timeout 300;
        proxy_redirect off;
    
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>注意：需要将代理的域名设置为变量，否则域名无法动态解析</p>
</blockquote>
<h1 id="四、验证"><a href="#四、验证" class="headerlink" title="四、验证"></a>四、验证</h1><p>上述配置中我们设置DNS解析缓存时间为60s，通过tcpdump抓取请求114.114.114.114 DNS服务器的包，在请求过程中，发现每间隔一分钟Nginx就会去重新请求DNS服务器，问题解决。</p>
<p><img src="/2020/08/04/nginx/nginx-dai-li-pei-zhi-zhong-de-dns-huan-cun-wen-ti/dns%E8%A7%A3%E6%9E%90.jpg" alt="DNS解析抓包"></p>
]]></content>
      <categories>
        <category>运维</category>
      </categories>
      <tags>
        <tag>Nginx</tag>
        <tag>反向代理</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx反向代理404问题</title>
    <url>/2020/07/13/nginx/nginx-fan-xiang-dai-li-404-wen-ti/</url>
    <content><![CDATA[<h1 id="一、问题背景"><a href="#一、问题背景" class="headerlink" title="一、问题背景"></a>一、问题背景</h1><p>   在测试web应用的时候，前端需要进行跨域访问后端接口，由于服务端跨域访问功能不完善，所以打算通过反向代理临时解决跨域问题，但是反向代理配置成功后，访问时浏览器端返回404，在nginx的访问日志中也提示404，Nginx配置如下。</p>
<h2 id="1-1-Nginx反向代理配置"><a href="#1-1-Nginx反向代理配置" class="headerlink" title="1.1 Nginx反向代理配置"></a>1.1 Nginx反向代理配置</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">server <span class="token punctuation">&#123;</span>
    listen     <span class="token number">80</span><span class="token punctuation">;</span>
    server_name h5-verify.mpoom.cn<span class="token punctuation">;</span>
    location / <span class="token punctuation">&#123;</span>
        proxy_set_header Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>
        proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
        proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>

        proxy_pass http://127.0.0.1:8000<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

server <span class="token punctuation">&#123;</span>
    listen       <span class="token number">8000</span><span class="token punctuation">;</span>
    server_name  <span class="token number">127.0</span>.0.1 localhost<span class="token punctuation">;</span>

    <span class="token builtin class-name">set</span> <span class="token variable">$root_path</span> <span class="token string">"/home/ytx/jiyan-h5"</span><span class="token punctuation">;</span>

    <span class="token comment">#charset koi8-r;</span>

    location / <span class="token punctuation">&#123;</span>
        root   <span class="token variable">$root_path</span><span class="token punctuation">;</span>
        index  index.html index.htm<span class="token punctuation">;</span>
        try_files <span class="token variable">$uri</span> <span class="token variable">$uri</span>/ /index.html<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    location /ytx-api/ <span class="token punctuation">&#123;</span>
        proxy_set_header Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>
        proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
        proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>

        proxy_buffering off<span class="token punctuation">;</span>
        proxy_connect_timeout 300s<span class="token punctuation">;</span>
        proxy_send_timeout 300s<span class="token punctuation">;</span>
        proxy_read_timeout 300s<span class="token punctuation">;</span>
        client_max_body_size 100M<span class="token punctuation">;</span>

        proxy_pass  https://www.139130.com<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="1-2-浏览器请求及响应"><a href="#1-2-浏览器请求及响应" class="headerlink" title="1.2 浏览器请求及响应"></a>1.2 浏览器请求及响应</h2><p>（1）headers</p>
<p>General</p>
<blockquote>
<p>Request URL: <a href="http://h5-verify.mpoom.cn/ytx-api/v1.0.0/phone/carrier-info">http://h5-verify.mpoom.cn/ytx-api/v1.0.0/phone/carrier-info</a><br>Request Method: GET<br>Status Code: 404 Not Found<br>Remote Address: 106.54.197.193:80<br>Referrer Policy: no-referrer-when-downgrade</p>
</blockquote>
<p>Response Headers</p>
<blockquote>
<p>Connection: keep-alive<br>Content-Length: 315<br>Content-Type: text&#x2F;html; charset&#x3D;iso-8859-1<br>Date: Mon, 13 Jul 2020 09:24:37 GMT<br>Server: nginx&#x2F;1.9.9</p>
</blockquote>
<p>Request Headers</p>
<blockquote>
<p>Accept: <em>&#x2F;</em><br>Accept-Encoding: gzip, deflate<br>Accept-Language: zh-CN,zh;q&#x3D;0.9<br>Cache-Control: no-cache<br>Connection: keep-alive<br>Content-Type: application&#x2F;json;charset&#x3D;UTF-8<br>Host: h5-verify.mpoom.cn<br>Pragma: no-cache<br>Referer: <a href="http://h5-verify.mpoom.cn/phone-verify">http://h5-verify.mpoom.cn/phone-verify</a><br>User-Agent: Mozilla&#x2F;5.0 (Windows NT 6.1; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;83.0.4103.116 Safari&#x2F;537.36</p>
</blockquote>
<p>(2)preview</p>
<pre class="line-numbers language-none"><code class="language-none">Not Found
The requested URL &#x2F;ytx-api&#x2F;v1.0.0&#x2F;phone&#x2F;carrier-info was not found on this server.

Apache&#x2F;2.2.15 (CentOS) Server at h5-verify.mpoom.cn Port 80<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="1-3-Nginx-access-log日志"><a href="#1-3-Nginx-access-log日志" class="headerlink" title="1.3 Nginx access.log日志"></a>1.3 Nginx access.log日志</h2><pre class="line-numbers language-none"><code class="language-none">127.0.0.1 - - [13&#x2F;Jul&#x2F;2020:17:32:33 +0800] &quot;GET &#x2F;ytx-api&#x2F;v1.0.0&#x2F;phone&#x2F;carrier-info HTTP&#x2F;1.0&quot; 404 315 &quot;http:&#x2F;&#x2F;h5-verify.mpoom.cn&#x2F;phone-verify&quot; &quot;Mozilla&#x2F;5.0 (Windows NT 6.1; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;83.0.4103.116 Safari&#x2F;537.36&quot; &quot;183.238.58.120&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h1 id="二、问题原因"><a href="#二、问题原因" class="headerlink" title="二、问题原因"></a>二、问题原因</h1><p>在服务器上有类似反向代理配置，但都是可以正常访问的，唯一与上述配置有区别的是，能正常访问的被反向代理的应用和Nginx部署在同一台机器，而上述被反向代理的应用部署在一台公网服务器。<br>该问的主要原因在于配置反向代理时<code>proxy_set_header Host</code>的配置.</p>
<h2 id="2-1-Host定义"><a href="#2-1-Host定义" class="headerlink" title="2.1 Host定义"></a>2.1 Host定义</h2><blockquote>
<p>Host 请求头指明了请求将要发送到的服务器主机名和端口号。<br>组成：域名+端口号<br>例子：test.com:1998<br>如果没有包含端口号，会自动使用被请求服务的默认端口（比如HTTPS URL使用443端口，HTTP URL使用80端口）<br>所有HTTP&#x2F;1.1 请求报文中必须包含一个Host头字段。对于缺少Host头或者含有超过一个Host头的HTTP&#x2F;1.1 请求，可能会收到400（Bad Request）状态码。</p>
</blockquote>
<p><strong>http1.1中不能缺失host字段，但host字段可以是空值</strong><br>上述问题是由于web前端使用二级域名<code>h5-verify.mpoom.cn</code>去访问，被反向代理的应用接口部署在另外一台服务器并且使用了<code>www.139130.com</code>域名进行访问，上述反向代理配置将Host设置为了<code>h5-verify.mpoom.cn</code>，去访问远程应用接口时服务器时无法解析<code>h5-verify.mpoom.cn</code>返回404。</p>
<h1 id="三、解决方案"><a href="#三、解决方案" class="headerlink" title="三、解决方案"></a>三、解决方案</h1><blockquote>
<p>（1）解决方法一<br>修改反向代理中的Host配置</p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">proxy_set_header Host &quot;www.139130.com&quot;;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>（2）解决方法二<br>注释掉nginx配置文件中的Host配置</p>
</blockquote>
<blockquote>
<p>参考文章：</p>
</blockquote>
<p><a href="https://zh.wikipedia.org/zh-hans/HTTP%E5%A4%B4%E5%AD%97%E6%AE%B5">https://zh.wikipedia.org/zh-hans/HTTP%E5%A4%B4%E5%AD%97%E6%AE%B5</a><br><a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.23">https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.23</a><br><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Host">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Host</a></p>
]]></content>
      <categories>
        <category>运维</category>
      </categories>
      <tags>
        <tag>Nginx</tag>
        <tag>反向代理</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx反向代理HTTP header自定义参数丢失问题</title>
    <url>/2020/07/31/nginx/nginx-fan-xiang-dai-li-http-de-header-zi-ding-yi-can-shu-diu-shi-wen-ti/</url>
    <content><![CDATA[<h1 id="一、问题背景"><a href="#一、问题背景" class="headerlink" title="一、问题背景"></a>一、问题背景</h1><p>客户内网服务器不能直接访问外网，需要通过一台跳板机才能访问外网，在跳板机安装Nginx反向代理外网接口服务，架构图如下：<br><img src="/2020/07/31/nginx/nginx-fan-xiang-dai-li-http-de-header-zi-ding-yi-can-shu-diu-shi-wen-ti/nginx_proxy_pass_architecture_diagram.png" alt="nginx反向代理结构图"><br>代理设置完成后，在联调过程中请求外网接口返回参数错误，但是外网环境下不经过Nginx代理直接访问外网接口则能正常访问，说明在经过Nginx代理时，部分参数丢失了。</p>
<h1 id="二、问题排查"><a href="#二、问题排查" class="headerlink" title="二、问题排查"></a>二、问题排查</h1><p>根据接口报错，定位到是HTTPheader中的一个自定义参数<code>client_id</code>参数经过Nginx代理时没有转发出去,问题出现在Nginx代理上。</p>
<blockquote>
<p>Nginx主配置文件nginx.conf内容如下</p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">user  root;
worker_processes  1;

error_log  logs&#x2F;error.log;
error_log  logs&#x2F;error.log  notice;
error_log  logs&#x2F;error.log  info;

pid        logs&#x2F;nginx.pid;


events &#123;
    worker_connections  1024;
&#125;


http &#123;
    include       mime.types;
    default_type  application&#x2F;octet-stream;

    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;
                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;
                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;

    access_log  logs&#x2F;access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  0;
    #keepalive_timeout  65;

    gzip  on;
    include &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;conf.d&#x2F;*.conf;

&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>Nginx代理配置内容如下:</p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">server &#123;
    listen       9000;
    server_name  localhost;
 
    location &#x2F;mobile&#x2F;verify &#123;
        proxy_pass https:&#x2F;&#x2F;www.cmpassport.com&#x2F;openapi&#x2F;rs&#x2F;tokenValidate;
        proxy_read_timeout 60;
        proxy_connect_timeout 60;
        proxy_redirect off;
    
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过查阅文档得知，Nginx默认会忽略http header中带有下划线的参数：<br><img src="/2020/07/31/nginx/nginx-fan-xiang-dai-li-http-de-header-zi-ding-yi-can-shu-diu-shi-wen-ti/nginx-underscores-syntax.jpg" alt="Nginx Syntax"></p>
<h1 id="三、解决方案"><a href="#三、解决方案" class="headerlink" title="三、解决方案"></a>三、解决方案</h1><p>在nginx配置文件的http或server模块设置<code>underscores_in_headers</code>为<code>on</code>:</p>
<pre class="line-numbers language-none"><code class="language-none">#该属性默认为off，表示如果header name中包含下划线，则忽略掉。
underscores_in_headers on;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>更新配置文件后重启Nginx，问题解决。</p>
]]></content>
      <categories>
        <category>运维</category>
      </categories>
      <tags>
        <tag>Nginx</tag>
        <tag>反向代理</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx离线安装</title>
    <url>/2020/05/24/nginx/nginx-chi-xian-an-zhuang/</url>
    <content><![CDATA[<h1 id="一、概览"><a href="#一、概览" class="headerlink" title="一、概览"></a>一、概览</h1><blockquote>
<p>服务器无法访问外网的情况下，Nginx只能离线安装，安装主要步骤如下：</p>
</blockquote>
<ul>
<li>安装gcc、g++</li>
<li>安装pcre、zlib</li>
<li>安装nginx</li>
</ul>
<h1 id="二、安装gcc、g"><a href="#二、安装gcc、g" class="headerlink" title="二、安装gcc、g++"></a>二、安装gcc、g++</h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc <span class="token parameter variable">--version</span>
g++ <span class="token parameter variable">--version</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>使用<code>gcc --version</code> <code>g++ --version</code>查看服务器是否已经安装过<strong>gcc</strong>、<strong>g++</strong>。</p>
<h3 id="2-1-下载"><a href="#2-1-下载" class="headerlink" title="2.1 下载"></a>2.1 下载</h3><p>如果未安装，请下载<strong>gcc</strong>、**g++**及其依赖包进行安装，下面为Centos7 x86_64下 <strong>gcc</strong> 与 **g++ ** 4.8.5的依赖包:</p>
<blockquote>
<p>gcc依赖包详见:<a href="https://centos.pkgs.org/7/centos-x86_64/gcc-4.8.5-39.el7.x86_64.rpm.html">gcc-4.8.5-39.el7.x86_64.rpm</a> </p>
</blockquote>
<p><img src="/2020/05/24/nginx/nginx-chi-xian-an-zhuang/gcc-requires.png" alt="gcc 依赖包"></p>
<blockquote>
<p>g++依赖包详见：<a href="https://centos.pkgs.org/7/centos-x86_64/gcc-c++-4.8.5-39.el7.x86_64.rpm.html">gcc-c++-4.8.5-39.el7.x86_64.rpm</a></p>
</blockquote>
<p><img src="/2020/05/24/nginx/nginx-chi-xian-an-zhuang/g++_requires.png" alt="g++ 依赖包"></p>
<p>根据上述依赖包列表下载安装包，下载地址：<a href="http://mirror.centos.org/centos/7/os/x86_64/Packages/">Centos Mirrors</a> 、 <a href="http://mirrors.aliyun.com/centos/7/os/x86_64/Packages/">阿里云</a> 、<a href="http://mirrors.163.com/centos/6/os/x86_64/Packages/">网易</a>,下载后的依赖包如下图所示：</p>
<p><img src="/2020/05/24/nginx/nginx-chi-xian-an-zhuang/gcc_g++_rpm%E5%AE%89%E8%A3%85%E5%8C%85.png" alt="gcc  g++ rpm安装包"></p>
<p>上述安装包已分享至天翼云盘<a href="https://cloud.189.cn/t/2M7vuyra6vM3">gcc g++ rpm安装包</a></p>
<blockquote>
<p><em><strong>注意</strong></em></p>
<p><em>上图下载的依赖包有一些是<code>gcc</code> <code>g++</code>依赖包列表中不存在的，是因为那部分安装包是<code>gcc</code> <code>g++</code> 依赖包的依赖包，这里参考网上下载了缺少的一些包</em></p>
</blockquote>
<h3 id="2-2-安装"><a href="#2-2-安装" class="headerlink" title="2.2 安装"></a>2.2 安装</h3><p>进入安装包下载路径</p>
<pre class="line-numbers language-none"><code class="language-none">rpm  -ivh  *.rpm --nodeps --force<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>–nodeps: do not verify package dependencies</p>
<p>–force:  short hand for –replacepkgs –replacefiles</p>
<p>–replacefiles : ignore file conflicts between packages</p>
<p>–replacepkgs: reinstall if the package is already present</p>
</blockquote>
<h3 id="2-3-检查"><a href="#2-3-检查" class="headerlink" title="2.3 检查"></a>2.3 检查</h3><p>执行<code>gcc --version</code> 、<code>g++ version</code>检测是否安装成功。</p>
<h1 id="三、安装pcre、zlib"><a href="#三、安装pcre、zlib" class="headerlink" title="三、安装pcre、zlib"></a>三、安装pcre、zlib</h1><p>Nginx的gzip模块需要zlib库，rewrite模块需要pcre库，ssl模块需要openssl库.</p>
<p>下载地址：<a href="http://mirror.centos.org/centos/7/os/x86_64/Packages/">http://mirror.centos.org/centos/7/os/x86_64&#x2F;Packages&#x2F;</a></p>
<h2 id="3-1-安装pcre"><a href="#3-1-安装pcre" class="headerlink" title="3.1 安装pcre"></a>3.1 安装pcre</h2><p>检查服务器是否已经安装了<code>pcre</code>：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">rpm</span> <span class="token parameter variable">-q</span> pcre<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>下载地址：<a href="http://mirror.centos.org/centos/7/os/x86_64/Packages/pcre-8.32-17.el7.x86_64.rpm">http://mirror.centos.org/centos/7/os/x86_64&#x2F;Packages&#x2F;pcre-8.32-17.el7.x86_64.rpm</a></p>
<pre class="line-numbers language-none"><code class="language-none">rpm -ivh pcre-8.32-17.el7.x86_64.rpm --force<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>进入文件存放路径执行上述命令安装，最后执行<code>rpm -q pcre</code>检测是否安装成功。</p>
<h2 id="3-2-安装zlib"><a href="#3-2-安装zlib" class="headerlink" title="3.2 安装zlib"></a>3.2 安装zlib</h2><p>检查服务器是否已经安装<code>zlib</code></p>
<pre class="line-numbers language-none"><code class="language-none">rpm -q zlib<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>下载地址：<a href="http://mirror.centos.org/centos/7/os/x86_64/Packages/zlib-1.2.7-18.el7.x86_64.rpm">http://mirror.centos.org/centos/7/os/x86_64&#x2F;Packages&#x2F;zlib-1.2.7-18.el7.x86_64.rpm</a></p>
<pre class="line-numbers language-none"><code class="language-none">rpm -ivh zlib-1.2.7-18.el7.x86_64.rpm --force<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>进入文件下载路径执行上面命令进行安装，最后执行<code>rpm -q zlib</code>检测是否安装成功。</p>
<h1 id="四、安装Nginx"><a href="#四、安装Nginx" class="headerlink" title="四、安装Nginx"></a>四、安装Nginx</h1><p>从<a href="https://nginx.org/">Nginx官网</a>下载<strong>Stable version</strong>，当前的Stable version为<code>nginx-1.18.0</code></p>
<p>下载地址：<a href="https://nginx.org/download/nginx-1.18.0.tar.gz">https://nginx.org/download/nginx-1.18.0.tar.gz</a></p>
<h2 id="3-1-编译安装"><a href="#3-1-编译安装" class="headerlink" title="3.1 编译安装"></a>3.1 编译安装</h2><pre class="line-numbers language-none"><code class="language-none">tar -zxvf nginx-1.18.0.tar.gz
cd nginx-1.18.0
.&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx
make
make install<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>下载解压后进入Nginx解压目录进行编译安装, 上面讲Nginx安装到了&#x2F;usr&#x2F;local&#x2F;nginx目录下。</p>
<blockquote>
<p>查看Nginx版本</p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -v<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="3-2-配置环境变量"><a href="#3-2-配置环境变量" class="headerlink" title="3.2 配置环境变量"></a>3.2 配置环境变量</h2><p>编辑&#x2F;etc&#x2F;profile添加下面内容：</p>
<pre class="line-numbers language-none"><code class="language-none">export NGINX_HOME&#x3D; &#x2F;usr&#x2F;local&#x2F;nginx
export PATH&#x3D;$PATH:$NGINX_HOME&#x2F;sbin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>完成后执行<code>source /etc/profile</code>,之后就可以直接执行<code>nginx -v</code>查看Nginx版本。</p>
<h2 id="3-3-设置开机自启动"><a href="#3-3-设置开机自启动" class="headerlink" title="3.3 设置开机自启动"></a>3.3 设置开机自启动</h2><p>1、在系统服务目录里创建nginx.service文件</p>
<pre class="line-numbers language-none"><code class="language-none">vim  &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;nginx.service<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>2、在文中添加下面内容</p>
<pre class="line-numbers language-none"><code class="language-none">[Unit]
Description&#x3D;nginx
After&#x3D;network.target
  
[Service]
Type&#x3D;forking
ExecStart&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx
ExecReload&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -s reload
ExecStop&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -s quit
PrivateTmp&#x3D;true
  
[Install]
WantedBy&#x3D;multi-user.target<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>Description:描述服务<br>After:描述服务类别<br>[Service]服务运行参数的设置<br>Type&#x3D;forking是后台运行的形式<br>ExecStart为服务的具体运行命令<br>ExecReload为重启命令<br>ExecStop为停止命令<br>PrivateTmp&#x3D;True表示给服务分配独立的临时空间<br>注意：[Service]的启动、重启、停止命令全部要求使用绝对路径<br>[Install]运行级别下服务安装的相关设置，可设置为多用户，即系统运行级别为3</p>
</blockquote>
<p>3、设置开机自启动</p>
<pre class="line-numbers language-none"><code class="language-none">systemctl enable nginx.service<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>至此Nginx的安装已经完成了。</p>
<h1 id="五、下载"><a href="#五、下载" class="headerlink" title="五、下载"></a>五、下载</h1><blockquote>
<p>Nginx离线安装下载：</p>
</blockquote>
<p><a href="https://cloud.189.cn/t/2M7vuyra6vM3">gcc、g++安装包</a></p>
<p><a href="https://cloud.189.cn/t/IZNN3yFVZZne">nginx离线安装包</a></p>
<p><em><strong>参考文章</strong></em></p>
<p><em><a href="%5Bhttps://linking.fun/2019/04/20/CentOS7%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85Nginx/%5D(https://linking.fun/2019/04/20/CentOS7%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85Nginx/)">CentOS7离线安装Nginx</a></em></p>
<p><em><a href="https://blog.csdn.net/qq_29480353/article/details/80006246">linux的离线安装nginx</a></em></p>
]]></content>
      <categories>
        <category>运维</category>
      </categories>
      <tags>
        <tag>Nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>分库分表设计方案</title>
    <url>/2021/03/04/mysql/fen-ku-fen-biao-she-ji-fang-an/</url>
    <content><![CDATA[<h1 id="一、背景介绍"><a href="#一、背景介绍" class="headerlink" title="一、背景介绍"></a>一、背景介绍</h1><p>系统数据库主要分为两个数据库，一个是主要的业务数据存储库，在该库下进行了分表操作；另一个是业务关联性较小的数据库，未进行分表。在当前业务场景下，系统每天的消息发送量基本分布在100万 ~ 3000万之间。消息下发后，用户可以查看消息发送记录，及用户接受状态。系统采用了按天分表的策略，提前为存储消息记录的表按天创建分表，每个大表将会按天创建366个分表，分表以月日为后缀。</p>
<h2 id="1-1-按天分表的优点"><a href="#1-1-按天分表的优点" class="headerlink" title="1.1 按天分表的优点"></a>1.1 按天分表的优点</h2><ul>
<li>用户可以以发送日期为时间限度，查询、导出当天的发送记录及用户接受状态。</li>
<li>可以通过日期条件，限定事务范围，简化分表事务问题。</li>
<li>分表规则简单，方便基于数据库各类连表查询操作。</li>
</ul>
<h2 id="1-2-分库分表遇到的问题"><a href="#1-2-分库分表遇到的问题" class="headerlink" title="1.2 分库分表遇到的问题"></a>1.2 分库分表遇到的问题</h2><ul>
<li>在开发新业务的过程中，分表数量急速增长，目前系统的分表数量已达7000多。</li>
<li>分表数据分布不均匀，有些表的数据库只有几十万或更少，而有的表的量超过了千万。</li>
<li>分表数量超过千万级，客户查询时会影响数据库性能，当前的分表机制无法做动态扩容。</li>
</ul>
<h1 id="二、分库分表方案"><a href="#二、分库分表方案" class="headerlink" title="二、分库分表方案"></a>二、分库分表方案</h1><p>分库分表的采用的常见方案垂直拆分和水平拆分。</p>
<h2 id="2-1-垂直拆分"><a href="#2-1-垂直拆分" class="headerlink" title="2.1 垂直拆分"></a>2.1 垂直拆分</h2><h3 id="垂直分表"><a href="#垂直分表" class="headerlink" title="垂直分表"></a>垂直分表</h3><p>垂直分表主要主要针对数据列较多的宽表，一般是表中的字段较多，将不常用的， 数据较大，长度较长（比如text类型字段）的列拆分到“扩展表“。 一般是针对那种几百列的大表，也避免查询时，数据量太大造成的“跨页”问题。</p>
<h3 id="垂直分库"><a href="#垂直分库" class="headerlink" title="垂直分库"></a>垂直分库</h3><p>垂直分库主要是对系统中业务进行拆分，切分后不同的业务数据存放到不同的数据库。可以将这些数据库部署到不同的机器上，避免单机CPU、内存、IO瓶颈问题。此外还可以独立对高并发的业务进行性能单独优化而不影响其它业务。</p>
<h2 id="2-2-水平拆分"><a href="#2-2-水平拆分" class="headerlink" title="2.2 水平拆分"></a>2.2 水平拆分</h2><h3 id="水平分表"><a href="#水平分表" class="headerlink" title="水平分表"></a>水平分表</h3><p>针对数据量巨大打单表（比如订单表）按照某种规则（如时间，哈希取模等），将数据路由到不同的分表中。但是这些分表仍处于一个数据库中，单库具有IO瓶颈问题。</p>
<h3 id="水平分库分表"><a href="#水平分库分表" class="headerlink" title="水平分库分表"></a>水平分库分表</h3><p>单独的水平分表会遇到单机数据库性能瓶颈及压力，如IO、连接数等硬件资源的限制。可以将单表数据按分表规则先路由到不同的数据库，然后再路由数据库内的不同分表之中。水平分库分表能够有效的缓解单机和单库的性能瓶颈和压力，突破IO、连接数、硬件资源等的瓶颈。</p>
<h2 id="2-3-水平分库分表切分规则"><a href="#2-3-水平分库分表切分规则" class="headerlink" title="2.3 水平分库分表切分规则"></a>2.3 水平分库分表切分规则</h2><h3 id="RANGE"><a href="#RANGE" class="headerlink" title="RANGE"></a>RANGE</h3><p>从0到1000万一个表，1000万到2000万一个表；</p>
<h3 id="HASH取模"><a href="#HASH取模" class="headerlink" title="HASH取模"></a>HASH取模</h3><ul>
<li>按用户ID哈希取模（避免分库事务，但数据可能会分布不均匀）</li>
<li>按订单ID哈希取模（数据分布较均匀，会有分库事务问题）</li>
</ul>
<h3 id="区域"><a href="#区域" class="headerlink" title="区域"></a>区域</h3><p>比如按照华东，华南，华北这样来区分业务，七牛云应该就是如此。</p>
<h3 id="时间"><a href="#时间" class="headerlink" title="时间"></a>时间</h3><p>按照时间切分，就是将6个月前，甚至一年前的数据切出去放到另外的一张表，因为随着时间流逝，这些表的数据 被查询的概率变小，所以没必要和“热数据”放在一起，这个也是“冷热数据分离”。</p>
<h1 id="三、分库分表面临的问题"><a href="#三、分库分表面临的问题" class="headerlink" title="三、分库分表面临的问题"></a>三、分库分表面临的问题</h1><ul>
<li><p>事务支持<br>分库分表后，就成了分布式事务了。如果依赖数据库本身的分布式事务管理功能去执行事务，将付出高昂的性能代价； 如果由应用程序去协助控制，形成程序逻辑上的事务，又会造成编程方面的负担。</p>
</li>
<li><p>多库结果集合并</p>
</li>
<li><p>跨库join连接查询<br>分库分表后表之间的关联操作将受到限制，我们无法join位于不同分库的表，也无法join分表粒度不同的表， 结果原本一次查询能够完成的业务，可能需要多次查询才能完成。 粗略的解决方法： 全局表：基础数据，所有库都拷贝一份。 字段冗余：这样有些字段就不用join去查询了。 系统层组装：分别查询出所有，然后组装起来，较复杂。</p>
</li>
</ul>
<h1 id="四、分库分表产品"><a href="#四、分库分表产品" class="headerlink" title="四、分库分表产品"></a>四、分库分表产品</h1><p><img src="/2021/03/04/mysql/fen-ku-fen-biao-she-ji-fang-an/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E4%BA%A7%E5%93%81.jpg" alt="分库分表设计方案"><br>参考文章：<a href="https://blog.csdn.net/fly910905/article/details/87101059">分库分表：中间件方案对比</a></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>分库分表常用的方法就是垂直拆分和水平拆分，我们在进行分库分表设计时需要结合业务场景及资源环境去充分考虑。</p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>分库分表</tag>
      </tags>
  </entry>
  <entry>
    <title>单域名多网站Nginx配置</title>
    <url>/2024/10/20/nginx/dan-yu-ming-duo-wang-zhan-nginx-pei-zhi/</url>
    <content><![CDATA[<h1 id="一、背景简介"><a href="#一、背景简介" class="headerlink" title="一、背景简介"></a>一、背景简介</h1><p>在搭建个人博客或站点时，为方便用户记住访问站点，我们大多站点管理者会使用域名进行网站的访问。</p>
<h1 id="二、域名Nginx配置"><a href="#二、域名Nginx配置" class="headerlink" title="二、域名Nginx配置"></a>二、域名Nginx配置</h1><h2 id="2-1-global-conf"><a href="#2-1-global-conf" class="headerlink" title="2.1 global.conf"></a>2.1 global.conf</h2><pre class="line-numbers language-ssh" data-language="ssh"><code class="language-ssh">server &#123;
    listen 443 ssl;
    server_name mpoom.cn;
    #ssl on;
    ssl_certificate  cert&#x2F;mpoom.cn.pem;
    ssl_certificate_key cert&#x2F;mpoom.cn.key;
    ssl_session_timeout 5m;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_prefer_server_ciphers on;
    client_max_body_size 100M;

    location &#x2F; &#123;
        proxy_pass  http:&#x2F;&#x2F;127.0.0.1:8060;
    &#125;
&#125;

server &#123;
    listen       80;
    server_name  mpoom.cn www.mpoom.cn;
    return 301 https:&#x2F;&#x2F;www.mpoom.cn$request_uri;
&#125;

server &#123;
    listen 443 ssl;
    server_name blog.mpoom.cn;
    ssl_certificate  cert&#x2F;blog.mpoom.cn.pem;
    ssl_certificate_key cert&#x2F;blog.mpoom.cn.key;
    ssl_session_timeout 5m;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_prefer_server_ciphers on;
    client_max_body_size 100M;

    location &#x2F; &#123;
        proxy_pass  http:&#x2F;&#x2F;127.0.0.1:8060;
    &#125;
&#125;
server &#123;
    listen       80;
    server_name  blog.mpoom.cn;
    location &#x2F; &#123;
        proxy_pass  http:&#x2F;&#x2F;127.0.0.1:8060;
    &#125;
&#125;

server &#123;
    listen       80;
    server_name  p.mpoom.cn;
    client_max_body_size 100M;
    location &#x2F; &#123;
        proxy_pass  http:&#x2F;&#x2F;127.0.0.1:8090;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="2-2-blog-mpoom-conf"><a href="#2-2-blog-mpoom-conf" class="headerlink" title="2.2 blog_mpoom.conf"></a>2.2 blog_mpoom.conf</h2><pre class="line-numbers language-none"><code class="language-none">server &#123;
    listen       8060;
    server_name  127.0.0.1 localhost;

    set $root_path &quot;&#x2F;home&#x2F;github&#x2F;hexo-blog&#x2F;public&quot;;

    #charset koi8-r;
    #access_log  &#x2F;home&#x2F;running&#x2F;mpoom&#x2F;nginx-logs&#x2F;blog&#x2F;host.access.log;
    #error_log  &#x2F;home&#x2F;running&#x2F;mpoom&#x2F;nginx-logs&#x2F;blog&#x2F;error.log;

    location &#x2F; &#123;
        root   $root_path;
        index  index.html index.htm;
    &#125;

    #error_page  404              &#x2F;404.html;

    # redirect server error pages to the static page &#x2F;50x.html
    #
    error_page   500 502 503 504  &#x2F;50x.html;
    location &#x3D; &#x2F;50x.html &#123;
        root   &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;
    &#125;

    # deny access to .htaccess files, if Apache&#39;s document root
    # concurs with nginx&#39;s one
    #
    #location ~ &#x2F;\.ht &#123;
    #    deny  all;
    #&#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      <categories>
        <category>运维</category>
      </categories>
      <tags>
        <tag>域名, nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx负载均衡失败重试</title>
    <url>/2021/04/26/nginx/nginx-fu-zai-jun-heng-shi-bai-chong-shi/</url>
    <content><![CDATA[<h1 id="一、问题背景"><a href="#一、问题背景" class="headerlink" title="一、问题背景"></a>一、问题背景</h1><p>在对一个接口进行反向代理时，nginx总是会打印error日志，但是请求是正常的。根据nginx的error日志，发现是请求到ipv6地址失败，但是最终的代理请求是成功的，所以接下来分析一下nginx的负载均衡及失败重试机制。</p>
<p>nginx配置文件如下：</p>
<pre class="line-numbers language-none"><code class="language-none">server &#123;
    listen       9000;
    server_name  localhost;
    #proxy_next_upstream off;
    location &#x2F;ncs&#x2F;telecom&#x2F;phone-verify &#123;
        proxy_pass https:&#x2F;&#x2F;open.e.189.cn&#x2F;auth&#x2F;verifyinfo.do;
        proxy_read_timeout 300;
        proxy_connect_timeout 300;
        proxy_redirect off;
    
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host &#39;open.e.189.cn&#39;;
        proxy_set_header X-Real-IP $remote_addr;
    &#125;
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>nginx error日志内容如下：</p>
<pre class="line-numbers language-none"><code class="language-none">[error] 3587705#0: *3471 connect() to [240e:698:100::2]:443 failed (101: Network is unreachable) while connecting to upstream, client: 127.0.0.1, server: localhost, request: &quot;GET &#x2F;ncs&#x2F;telecom&#x2F;phone-verify HTTP&#x2F;1.1&quot;, upstream: &quot;https:&#x2F;&#x2F;[240e:698:100::2]:443&#x2F;auth&#x2F;verifyinfo.do&quot;, host: &quot;localhost:9000&quot;
[error] 3587705#0: *3471 connect() to [240e:698:100::4]:443 failed (101: Network is unreachable) while connecting to upstream, client: 127.0.0.1, server: localhost, request: &quot;GET &#x2F;ncs&#x2F;telecom&#x2F;phone-verify HTTP&#x2F;1.1&quot;, upstream: &quot;https:&#x2F;&#x2F;[240e:698:100::4]:443&#x2F;auth&#x2F;verifyinfo.do&quot;, host: &quot;localhost:9000&quot;
[error] 3587705#0: *3471 connect() to [240e:698:100::5]:443 failed (101: Network is unreachable) while connecting to upstream, client: 127.0.0.1, server: localhost, request: &quot;GET &#x2F;ncs&#x2F;telecom&#x2F;phone-verify HTTP&#x2F;1.1&quot;, upstream: &quot;https:&#x2F;&#x2F;[240e:698:100::5]:443&#x2F;auth&#x2F;verifyinfo.do&quot;, host: &quot;localhost:9000&quot;
[error] 3587705#0: *3471 connect() to [240e:698:100::3]:443 failed (101: Network is unreachable) while connecting to upstream, client: 127.0.0.1, server: localhost, request: &quot;GET &#x2F;ncs&#x2F;telecom&#x2F;phone-verify HTTP&#x2F;1.1&quot;, upstream: &quot;https:&#x2F;&#x2F;[240e:698:100::3]:443&#x2F;auth&#x2F;verifyinfo.do&quot;, host: &quot;localhost:9000&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="二、proxy-pass"><a href="#二、proxy-pass" class="headerlink" title="二、proxy_pass"></a>二、<a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass">proxy_pass</a></h1><blockquote>
<p>Syntax:	proxy_pass URL;<br>Default:	—<br>Context:	location, if in location, limit_except</p>
</blockquote>
<p>Sets the protocol and address of a proxied server and an optional URI to which a location should be mapped. As a protocol, “http” or “https” can be specified. The address can be specified as a domain name or IP address, and an optional port:</p>
<blockquote>
<p>proxy_pass <a href="http://localhost:8000/uri/">http://localhost:8000/uri/</a>;</p>
</blockquote>
<p>or as a UNIX-domain socket path specified after the word “unix” and enclosed in colons:</p>
<blockquote>
<p>proxy_pass <a href="http://unix/tmp/backend.socket:/uri/">http://unix:/tmp/backend.socket:/uri/</a>;</p>
</blockquote>
<p>If a domain name resolves to several addresses, all of them will be used in a round-robin fashion. In addition, an address can be specified as a server group.</p>
<p>Parameter value can contain variables. In this case, if an address is specified as a domain name, the name is searched among the described server groups, and, if not found, is determined using a resolver.</p>
<p>根据<code>proxy_pass</code>的说明，我们的代理地址可以是域名或IP地址，如果地址是域名并且这个域名被解析到多个地址时，nginx以轮询的方式访问解析后的这些地址。<br>此外，可以将这个地址指定为一个server group，即我们的代理地址时一个域名的时候，域名解析后的地址将会被转换为一个<code>upstream</code>服务组，以默认轮询的方式提供服务。</p>
<p>代理地址的参数中可以包含变量，当代理地址被指定为一个域名的时候，则在描述的服务器组中搜索该名称，如果没有找到，则使用域名解析器确定。</p>
<h1 id="三、resolver"><a href="#三、resolver" class="headerlink" title="三、resolver"></a>三、<a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#resolver">resolver</a></h1><blockquote>
<p>Syntax:	resolver address … [valid&#x3D;time] [ipv6&#x3D;on|off] [status_zone&#x3D;zone];<br>Default:	—<br>Context:	http, server, location</p>
</blockquote>
<p>Configures name servers used to resolve names of upstream servers into addresses, for example:</p>
<blockquote>
<p>resolver 127.0.0.1 [::1]:5353;</p>
</blockquote>
<p>The address can be specified as a domain name or IP address, with an optional port (1.3.1, 1.2.2). If port is not specified, the port 53 is used. Name servers are queried in a round-robin fashion.</p>
<blockquote>
<p>Before version 1.1.7, only a single name server could be configured. Specifying name servers using IPv6 addresses is supported starting from versions 1.3.1 and 1.2.2.</p>
</blockquote>
<p>By default, nginx will look up both IPv4 and IPv6 addresses while resolving. If looking up of IPv6 addresses is not desired, the ipv6&#x3D;off parameter can be specified.</p>
<blockquote>
<p>Resolving of names into IPv6 addresses is supported starting from version 1.5.8.</p>
</blockquote>
<p>By default, nginx caches answers using the TTL value of a response. An optional valid parameter allows overriding it:</p>
<blockquote>
<p>resolver 127.0.0.1 [::1]:5353 valid&#x3D;30s;</p>
</blockquote>
<p>通过<code>proxy_pass</code>的说明我们知道，在nginx中可以配置resolver对域名进行解析，并关闭ipv6的解析。</p>
<p>所以nginx代理的的配置文件如下：</p>
<pre class="line-numbers language-none"><code class="language-none">server &#123;
    listen       9000;
    server_name  localhost;
    resolver 114.114.114.114 valid&#x3D;60s ipv6&#x3D;off;
    
    location &#x2F;ncs&#x2F;telecom&#x2F;phone-verify &#123;
        set $telecom open.e.189.cn;
        proxy_pass https:&#x2F;&#x2F;$telecom&#x2F;auth&#x2F;verifyinfo.do;
        proxy_read_timeout 300;
        proxy_connect_timeout 300;
        proxy_redirect off;

        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host &#39;open.e.189.cn&#39;;
        proxy_set_header X-Real-IP $remote_addr;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过上述配置（注意：必须将<code>proxy_pass</code>参数中的域名设置为变量)，我们指定代理地址中的域名每间隔60s进行解析一次，解析时排除掉域名中的ipv6地址。</p>
<p>域名open.e.189.cn解析后的IP地址如下：</p>
<pre class="line-numbers language-none"><code class="language-none">[root@10-13-149-183 conf.d]# nslookup open.e.189.cn
Server:         10.13.255.1
Address:        10.13.255.1#53

Non-authoritative answer:
open.e.189.cn   canonical name &#x3D; open.e-189.21cn.com.
Name:   open.e-189.21cn.com
Address: 42.123.76.75
Name:   open.e-189.21cn.com
Address: 42.123.76.52
Name:   open.e-189.21cn.com
Address: 42.123.76.87
Name:   open.e-189.21cn.com
Address: 240e:698:100::3
Name:   open.e-189.21cn.com
Address: 240e:698:100::2
Name:   open.e-189.21cn.com
Address: 240e:698:100::5
Name:   open.e-189.21cn.com
Address: 240e:698:100::4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>修改nginx配置后重启，发现error日志中已经没有报错了，至此nginx代理请求ipv6报错的问题已经解决了。</p>
<p>前面我们看到，即使在nginx打印了请求ipv6的失败的情况下，但我们的请求最后仍是成功的，这是由于nginx的失败重试机制，接下来我们分析一下nginx的失败重试机制。</p>
<h1 id="四、upstream"><a href="#四、upstream" class="headerlink" title="四、upstream"></a>四、<a href="http://nginx.org/en/docs/http/ngx_http_upstream_module.html">upstream</a></h1><p>nginx的<code>ngx_http_upstream_module</code>的模块时用来定义一个服务组的，这个服务组可以被<code>proxy_pass</code>等模块引用。<br>前面在<code>proxy_pass</code>中提到，当我们的代理地址是一个域名的时候，域名解析后的地址将被转换位一个<code>upstream</code>服务组。<br><code>upstream</code>的配置示例如下：</p>
<pre class="line-numbers language-none"><code class="language-none">resolver 10.0.0.1;

upstream dynamic &#123;
    zone upstream_dynamic 64k;

    server backend1.example.com      weight&#x3D;5;
    server backend2.example.com:8080 fail_timeout&#x3D;5s slow_start&#x3D;30s;
    server 192.0.2.1                 max_fails&#x3D;3;
    server backend3.example.com      resolve;
    server backend4.example.com      service&#x3D;http resolve;

    server backup1.example.com:8080  backup;
    server backup2.example.com:8080  backup;
&#125;

server &#123;
    location &#x2F; &#123;
        proxy_pass http:&#x2F;&#x2F;dynamic;
        health_check;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>Syntax:	server address [parameters];<br>Default:	—<br>Context:	upstream</p>
</blockquote>
<ul>
<li><p>max_fails&#x3D;number<br>sets the number of unsuccessful attempts to communicate with the server that should happen in the duration set by the fail_timeout parameter to consider the server unavailable for a duration also set by the fail_timeout parameter. By default, the number of unsuccessful attempts is set to 1. The zero value disables the accounting of attempts. What is considered an unsuccessful attempt is defined by the proxy_next_upstream, fastcgi_next_upstream, uwsgi_next_upstream, scgi_next_upstream, memcached_next_upstream, and grpc_next_upstream directives.</p>
</li>
<li><p>fail_timeout&#x3D;time<br>sets the time during which the specified number of unsuccessful attempts to communicate with the server should happen to consider the server unavailable;<br>and the period of time the server will be considered unavailable.<br>By default, the parameter is set to 10 seconds.</p>
</li>
</ul>
<p>nginx默认使用轮询机制请求server group中服务，通过<code>max_fails</code>和<code>fail_timeout</code>两个参数控制<code>upstream</code>下的服务是否可用。<br>这个两个参数表示在<code>fail_timeout</code>时间内，一个服务累计的失败次数超过<code>max_fails</code>，则这个服务在接一下来的<code>fail_timeout</code>时间内不可用。<br><code>max_fails</code>默认值为1，设置为0表示不限制。<code>fail_timeout</code>默认值为10，即默认一个服务在10s内失败一次，则在接一下来的10s内，这个服务将变为不可用。</p>
<p>当server group中的一个server请求失败时，nginx的会进行失败重试，参见<code>proxy_next_upstream</code>模块。</p>
<h1 id="五、proxy-next-upstream"><a href="#五、proxy-next-upstream" class="headerlink" title="五、proxy_next_upstream"></a>五、<a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_next_upstream">proxy_next_upstream</a></h1><blockquote>
<p>Syntax:	proxy_next_upstream error | timeout | invalid_header | http_500 | http_502 | http_503 | http_504 | http_403 | http_404 | http_429 | non_idempotent | off …;<br>Default:	<br>proxy_next_upstream error timeout;<br>Context:	http, server, location</p>
</blockquote>
<p>Specifies in which cases a request should be passed to the next server:</p>
<ul>
<li>error<br>an error occurred while establishing a connection with the server, passing a request to it, or reading the response header;</li>
<li>timeout<br>a timeout has occurred while establishing a connection with the server, passing a request to it, or reading the response header;</li>
</ul>
<p>One should bear in mind that passing a request to the next server is only possible if nothing has been sent to a client yet. That is, if an error or timeout occurs in the middle of the transferring of a response, fixing this is impossible.</p>
<p>The directive also defines what is considered an unsuccessful attempt of communication with a server. The cases of error, timeout and invalid_header are always considered unsuccessful attempts, even if they are not specified in the directive. The cases of http_500, http_502, http_503, http_504, and http_429 are considered unsuccessful attempts only if they are specified in the directive. The cases of http_403 and http_404 are never considered unsuccessful attempts.</p>
<p>根据上述说明nginx遇到<code>error</code>、<code>timeout</code>等错误时，会下一个server进行重试。我们之前遇到的请求的ipv6的错误属于<code>errror</code>情况，nignx会进行重试。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>根据上述说明，我们对域名地址进行反向代理时，域名解析后的地址会被转为一个<code>upstream</code>的server group，并以轮询的方式进行访问；我们可以通过配置<code>resolver</code>来设置域名解析服务器地址、同时可以关闭ipv6的解析；<br>nginx对server group中的server进行访问时，会根据<code>max_fails</code>和<code>fail_timeout</code>连个参数判断服务是否可用，在server请求失败后，会根据错误类型判断是否使用下一个server进行失败重试。</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass">Nginx官网——proxy_pass</a><br><a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#resolver">Nginx官网——resolver</a><br><a href="http://nginx.org/en/docs/http/ngx_http_upstream_module.html">Nginx官网——upstream</a><br><a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_next_upstream">Nginx官网——proxy_next_upstream</a></p>
]]></content>
      <categories>
        <category>运维</category>
      </categories>
      <tags>
        <tag>Nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>基于Nginx实现三级域名访问和https访问</title>
    <url>/2018/10/26/nginx/ji-yu-nginx-shi-xian-san-ji-yu-ming-fang-wen-he-https-fang-wen/</url>
    <content><![CDATA[<h1 id="Nginx实现三级域名访问"><a href="#Nginx实现三级域名访问" class="headerlink" title="Nginx实现三级域名访问"></a>Nginx实现三级域名访问</h1><p>我的VPS上部署了<a href="https://www.mpoom.cn/">MPOOM工作台</a>、<a href="http://blog.mpoom.cn/">个人博客</a>、<a href="http://m.mpoom.cn/">文件共享平台</a>三个系统，并且在阿里云平台购买了域名，想要通过nginx实现不同的三级域名访问不同的系统，例如：</p>
<ul>
<li><p>MPOOM工作台：<a href="http://www.mpoon.cn/">http://www.mpoon.cn</a></p>
</li>
<li><p>个人博客： <a href="http://blog.mpoom.cn/">http://blog.mpoom.cn</a></p>
</li>
<li><p>文件共享平台：<a href="http://m.mpoom.cn/">http://m.mpoom.cn</a></p>
</li>
</ul>
<p><em>ps：如果域名要解析到国内云服务器，域名要提前在工信部进行备案，但是如果解析到国外，则没有这个限制.</em></p>
<blockquote>
<p>配置文件mpoom.conf如下:</p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none"># mpoom工作台
server &#123;
    listen       80;
    server_name  mpoom.cn www.mpoom.cn;
    location &#x2F; &#123;
        proxy_pass  http:&#x2F;&#x2F;127.0.0.1:8090;
    &#125;
&#125;
# 个人博客
server &#123;
    listen       80;
    server_name  blog.mpoom.cn;

    set $root_path &quot;&#x2F;usr&#x2F;local&#x2F;webserver&#x2F;blog&#x2F;public&quot;;

    #charset koi8-r;
    access_log  &#x2F;home&#x2F;running&#x2F;blog&#x2F;blog-logs&#x2F;host.access.log;
    error_log  &#x2F;home&#x2F;running&#x2F;blog&#x2F;blog-logs&#x2F;error.log;
    # 个人博客系统是由hexo生成的静态页面
    location &#x2F; &#123;
        root   $root_path;
        index  index.html index.htm;
    &#125;
&#125;
# 文件共享平台
server &#123;
    listen       80;
    server_name  m.mpoom.cn;

    set $root_path &quot;&#x2F;home&#x2F;running&#x2F;web&#x2F;open-web&#x2F;&quot;;

    #charset koi8-r;
    access_log  &#x2F;home&#x2F;running&#x2F;web&#x2F;openweb-logs&#x2F;host.access.log;
    error_log  &#x2F;home&#x2F;running&#x2F;blog&#x2F;blog-logs&#x2F;error.log;

    location &#x2F; &#123;
        root   $root_path;
        index  index.html index.htm;
    &#125;

    location ~ ^&#x2F;service&#x2F; &#123;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path &#x2F;service&#x2F; &#x2F;;

        proxy_buffering off;
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        proxy_pass  http:&#x2F;&#x2F;127.0.0.1:9000;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>工作台和文件共享平台进行了前后端分离，且两者共用后台系统，前端使用nginx作为服务器，后台使用nginx作为反向代理服务器。</p>
<p>然后在nginx主配置文件nginx.conf的http模块引入上面mpoom.conf配置文件</p>
<pre class="line-numbers language-none"><code class="language-none">include &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;mpoom.conf;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h1 id="Nginx实现https访问"><a href="#Nginx实现https访问" class="headerlink" title="Nginx实现https访问"></a>Nginx实现https访问</h1><p>为保障MPOOM工作台访问安全性，且在阿里云购可以购买免费的SSL证书，所以决定使用https来进行访问。</p>
<blockquote>
<p>Nginx服务器安装SSL证书步骤如下</p>
</blockquote>
<ul>
<li><p>在阿里云购买免费的SSL证书，验证通过后，下载Nginx版本证书。</p>
</li>
<li><p>进入nginx安装目录下的conf目录，在conf目录下创建cert目录，将下载解压后的证书上传到cert目录，下载到本地的证书压缩文件包解压后包含：</p>
<ul>
<li><strong>.crt</strong>文件：是证书文件，crt是pem文件的扩展名。</li>
<li><strong>.key</strong>文件：证书的私钥文件。</li>
</ul>
</li>
<li><p>在nginx配置文件的http模块下新增一个server模块,配置如下：</p>
<pre class="line-numbers language-none"><code class="language-none">server &#123;
    listen 443;
    server_name mpoom.cn;
    ssl on;
    ssl_certificate  cert&#x2F;***_www.mpoom.cn.pem;
    ssl_certificate_key cert&#x2F;***_www.mpoom.cn.key;
    ssl_session_timeout 5m;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_prefer_server_ciphers on;

    location &#x2F; &#123;
        proxy_pass  http:&#x2F;&#x2F;127.0.0.1:8090;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>强制http跳转至https，将工作台的server模块更新为如下：</p>
<pre class="line-numbers language-none"><code class="language-none">server &#123;
    listen       80;
    server_name  mpoom.cn www.mpoom.cn;
    return 301 https:&#x2F;&#x2F;www.mpoom.cn$request_uri;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>重启nginx。</p>
</li>
</ul>
]]></content>
      <categories>
        <category>运维</category>
      </categories>
      <tags>
        <tag>nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>一次生产流量攻击防御与解决方案</title>
    <url>/2025/11/11/operations/yi-ci-sheng-chan-liu-liang-gong-ji-fang-yu-yu-jie-jue-fang-an/</url>
    <content><![CDATA[<p><img src="/2025/11/11/operations/yi-ci-sheng-chan-liu-liang-gong-ji-fang-yu-yu-jie-jue-fang-an/%E6%B5%81%E9%87%8F%E6%94%BB%E5%87%BB.png" alt="流量攻击"></p>
<h1 id="一、问题背景"><a href="#一、问题背景" class="headerlink" title="一、问题背景"></a>一、问题背景</h1><h2 id="1-1-问题发现"><a href="#1-1-问题发现" class="headerlink" title="1.1 问题发现"></a>1.1 问题发现</h2><p>某天上班后，运维反馈监控系统突然告警，网站带宽使用率持续飙升至80%以上，服务器CPU负载异常。通过查看Nginx访问日志发现，某个静态资源文件遭受了大规模的异常访问。</p>
<h2 id="1-2-日志分析"><a href="#1-2-日志分析" class="headerlink" title="1.2 日志分析"></a>1.2 日志分析</h2><h3 id="正常访问日志示例"><a href="#正常访问日志示例" class="headerlink" title="正常访问日志示例"></a>正常访问日志示例</h3><p>首先查看正常时段的访问日志，流量分布较为均匀：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"@timestamp"</span><span class="token operator">:</span><span class="token string">"2025-11-11T09:00:00+08:00"</span><span class="token punctuation">,</span><span class="token property">"host"</span><span class="token operator">:</span><span class="token string">"172.25.192.5"</span><span class="token punctuation">,</span><span class="token property">"client"</span><span class="token operator">:</span><span class="token string">"183.44.115.70"</span><span class="token punctuation">,</span><span class="token property">"size"</span><span class="token operator">:</span><span class="token number">792</span><span class="token punctuation">,</span><span class="token property">"responsetime"</span><span class="token operator">:</span><span class="token number">0.001</span><span class="token punctuation">,</span><span class="token property">"url"</span><span class="token operator">:</span><span class="token string">"/uploadfiles/nav/nav3_img3.png"</span><span class="token punctuation">,</span><span class="token property">"status"</span><span class="token operator">:</span><span class="token string">"200"</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span><span class="token property">"@timestamp"</span><span class="token operator">:</span><span class="token string">"2025-11-11T09:00:00+08:00"</span><span class="token punctuation">,</span><span class="token property">"host"</span><span class="token operator">:</span><span class="token string">"172.25.192.5"</span><span class="token punctuation">,</span><span class="token property">"client"</span><span class="token operator">:</span><span class="token string">"119.134.146.224"</span><span class="token punctuation">,</span><span class="token property">"size"</span><span class="token operator">:</span><span class="token number">1222</span><span class="token punctuation">,</span><span class="token property">"responsetime"</span><span class="token operator">:</span><span class="token number">0.002</span><span class="token punctuation">,</span><span class="token property">"url"</span><span class="token operator">:</span><span class="token string">"/uploadfiles/2024/05/20240506180621580.png"</span><span class="token punctuation">,</span><span class="token property">"status"</span><span class="token operator">:</span><span class="token string">"200"</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span><span class="token property">"@timestamp"</span><span class="token operator">:</span><span class="token string">"2025-11-11T09:00:00+08:00"</span><span class="token punctuation">,</span><span class="token property">"host"</span><span class="token operator">:</span><span class="token string">"172.25.192.5"</span><span class="token punctuation">,</span><span class="token property">"client"</span><span class="token operator">:</span><span class="token string">"223.104.87.191"</span><span class="token punctuation">,</span><span class="token property">"size"</span><span class="token operator">:</span><span class="token number">367</span><span class="token punctuation">,</span><span class="token property">"responsetime"</span><span class="token operator">:</span><span class="token number">0.003</span><span class="token punctuation">,</span><span class="token property">"url"</span><span class="token operator">:</span><span class="token string">"/ytx-api/v1.0.0/loginToken/getApp"</span><span class="token punctuation">,</span><span class="token property">"status"</span><span class="token operator">:</span><span class="token string">"200"</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#123;</span><span class="token property">"@timestamp"</span><span class="token operator">:</span><span class="token string">"2025-11-11T09:00:00+08:00"</span><span class="token punctuation">,</span><span class="token property">"host"</span><span class="token operator">:</span><span class="token string">"172.25.192.5"</span><span class="token punctuation">,</span><span class="token property">"client"</span><span class="token operator">:</span><span class="token string">"183.44.115.70"</span><span class="token punctuation">,</span><span class="token property">"size"</span><span class="token operator">:</span><span class="token number">4692</span><span class="token punctuation">,</span><span class="token property">"responsetime"</span><span class="token operator">:</span><span class="token number">0.003</span><span class="token punctuation">,</span><span class="token property">"url"</span><span class="token operator">:</span><span class="token string">"/cn/js/liMarquee/jquery.liMarquee.js"</span><span class="token punctuation">,</span><span class="token property">"status"</span><span class="token operator">:</span><span class="token string">"200"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="异常流量特征"><a href="#异常流量特征" class="headerlink" title="异常流量特征"></a>异常流量特征</h3><p>通过日志分析工具统计发现，某个Banner图片的访问量异常激增：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 统计访问最频繁的URL</span>
<span class="token function">cat</span> access.log <span class="token operator">|</span> jq <span class="token parameter variable">-r</span> <span class="token string">'.url'</span> <span class="token operator">|</span> <span class="token function">sort</span> <span class="token operator">|</span> <span class="token function">uniq</span> <span class="token parameter variable">-c</span> <span class="token operator">|</span> <span class="token function">sort</span> <span class="token parameter variable">-rn</span> <span class="token operator">|</span> <span class="token function">head</span> <span class="token parameter variable">-10</span>

<span class="token comment"># 输出结果（示例）</span>
  <span class="token number">6897</span> /uploadfiles/banner/banner_img.png
   <span class="token number">342</span> /uploadfiles/nav/nav3_img3.png
   <span class="token number">256</span> /uploadfiles/2024/05/20240506180621580.png
   <span class="token number">189</span> /ytx-api/v1.0.0/loginToken/getApp
   <span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到，某个Banner图片的访问量远超其他资源，占据了绝对优势。</p>
<h3 id="IP来源分析"><a href="#IP来源分析" class="headerlink" title="IP来源分析"></a>IP来源分析</h3><p>进一步分析访问该资源的IP分布：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 统计访问Banner图片的独立IP数</span>
<span class="token function">cat</span> access.log <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"banner_img.png"</span> <span class="token operator">|</span> jq <span class="token parameter variable">-r</span> <span class="token string">'.client'</span> <span class="token operator">|</span> <span class="token function">sort</span> <span class="token parameter variable">-u</span> <span class="token operator">|</span> <span class="token function">wc</span> <span class="token parameter variable">-l</span>
<span class="token comment"># 输出: 6857</span>

<span class="token comment"># 统计每个IP的访问次数</span>
<span class="token function">cat</span> access.log <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"banner_img.png"</span> <span class="token operator">|</span> jq <span class="token parameter variable">-r</span> <span class="token string">'.client'</span> <span class="token operator">|</span> <span class="token function">sort</span> <span class="token operator">|</span> <span class="token function">uniq</span> <span class="token parameter variable">-c</span> <span class="token operator">|</span> <span class="token function">sort</span> <span class="token parameter variable">-rn</span> <span class="token operator">|</span> <span class="token function">head</span> <span class="token parameter variable">-10</span>
<span class="token comment"># 输出结果（示例）</span>
   <span class="token number">5</span> <span class="token number">183.44</span>.115.70
   <span class="token number">4</span> <span class="token number">119.134</span>.146.224
   <span class="token number">3</span> <span class="token number">223.104</span>.87.191
   <span class="token number">2</span> <span class="token number">113.117</span>.88.203
   <span class="token number">1</span> <span class="token number">211.90</span>.250.205
   <span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>关键发现</strong>：近7000个IP，每个IP仅访问1-5次，这是典型的分布式低频攻击特征。</p>
<h2 id="1-3-攻击特征总结"><a href="#1-3-攻击特征总结" class="headerlink" title="1.3 攻击特征总结"></a>1.3 攻击特征总结</h2><p>通过对日志进行深入分析，确认了以下攻击特征：</p>
<p><strong>攻击特征：</strong></p>
<ul>
<li><strong>目标资源</strong>: 网站Banner图片（约900KB）</li>
<li><strong>攻击规模</strong>: 约7000次&#x2F;小时，流量达6GB&#x2F;小时</li>
<li><strong>客户端数</strong>: 近7000个独立IP（高度分散）</li>
<li><strong>攻击模式</strong>: 分布式低频攻击（每个IP仅访问1-5次）</li>
<li><strong>攻击类型</strong>: <strong>DDoS（分布式拒绝服务攻击）</strong></li>
<li><strong>响应时间</strong>: 平均响应时间从0.002s增长到0.5s以上</li>
</ul>
<h2 id="1-4-攻击危害分析"><a href="#1-4-攻击危害分析" class="headerlink" title="1.4 攻击危害分析"></a>1.4 攻击危害分析</h2><p>经过初步评估，此次攻击造成了以下影响：</p>
<ul>
<li><strong>带宽耗尽</strong>: 单个文件占用超过60%带宽资源</li>
<li><strong>服务器负载</strong>: 大量并发请求导致CPU使用率持续在80%以上</li>
<li><strong>成本增加</strong>: 带宽费用较平时增长3倍以上</li>
<li><strong>服务降级</strong>: 正常用户访问延迟增加，部分请求超时</li>
</ul>
<h1 id="二、紧急防御措施（立即部署）"><a href="#二、紧急防御措施（立即部署）" class="headerlink" title="二、紧急防御措施（立即部署）"></a>二、紧急防御措施（立即部署）</h1><h2 id="2-1-Nginx限流配置（5分钟内完成）"><a href="#2-1-Nginx限流配置（5分钟内完成）" class="headerlink" title="2.1 Nginx限流配置（5分钟内完成）"></a>2.1 Nginx限流配置（5分钟内完成）</h2><h3 id="配置限流规则"><a href="#配置限流规则" class="headerlink" title="配置限流规则"></a>配置限流规则</h3><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token comment"># 在 http 块中定义限流区域</span>
<span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">&#123;</span>
    <span class="token comment"># 限制单IP请求频率</span>
    <span class="token directive"><span class="token keyword">limit_req_zone</span> <span class="token variable">$binary_remote_addr</span> zone=static_limit:10m rate=10r/s</span><span class="token punctuation">;</span>
    
    <span class="token comment"># 限制单IP并发连接数</span>
    <span class="token directive"><span class="token keyword">limit_conn_zone</span> <span class="token variable">$binary_remote_addr</span> zone=conn_limit:10m</span><span class="token punctuation">;</span>
    
    <span class="token comment"># 限制总带宽</span>
    <span class="token directive"><span class="token keyword">limit_rate</span> <span class="token number">500k</span></span><span class="token punctuation">;</span>  <span class="token comment"># 单连接限速500KB/s</span>
    
    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">server_name</span> www.example.com</span><span class="token punctuation">;</span>
        
        <span class="token comment"># 针对静态资源的限流</span>
        <span class="token directive"><span class="token keyword">location</span> ~* /uploadfiles/.*\.(png|jpg|jpeg|gif)$</span> <span class="token punctuation">&#123;</span>
            <span class="token comment"># 请求频率限制：每秒10个请求，突发20个</span>
            <span class="token directive"><span class="token keyword">limit_req</span> zone=static_limit burst=20 nodelay</span><span class="token punctuation">;</span>
            
            <span class="token comment"># 并发连接限制：每IP最多5个连接</span>
            <span class="token directive"><span class="token keyword">limit_conn</span> conn_limit <span class="token number">5</span></span><span class="token punctuation">;</span>
            
            <span class="token comment"># 单连接限速</span>
            <span class="token directive"><span class="token keyword">limit_rate</span> <span class="token number">300k</span></span><span class="token punctuation">;</span>
            
            <span class="token comment"># 返回静态文件</span>
            <span class="token directive"><span class="token keyword">root</span> /var/www/html</span><span class="token punctuation">;</span>
            
            <span class="token comment"># 如果超过限制，返回503</span>
            <span class="token directive"><span class="token keyword">limit_req_status</span> <span class="token number">503</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">limit_conn_status</span> <span class="token number">503</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token comment"># 特别保护Banner图片</span>
        <span class="token directive"><span class="token keyword">location</span> = /uploadfiles/banner/banner_img.png</span> <span class="token punctuation">&#123;</span>
            <span class="token comment"># 更严格的限制</span>
            <span class="token directive"><span class="token keyword">limit_req</span> zone=static_limit burst=5 nodelay</span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">limit_conn</span> conn_limit <span class="token number">2</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">limit_rate</span> <span class="token number">200k</span></span><span class="token punctuation">;</span>
            
            <span class="token directive"><span class="token keyword">root</span> /var/www/html</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="配置说明"><a href="#配置说明" class="headerlink" title="配置说明"></a>配置说明</h3><ul>
<li><code>limit_req_zone</code>: 定义一个限流区域，使用 <code>$binary_remote_addr</code> 作为键，存储在 <code>static_limit</code> 区域，设置为10分钟，限速为每秒10个请求。</li>
<li><code>limit_conn_zone</code>: 定义一个连接数限制区域，使用 <code>$binary_remote_addr</code> 作为键，存储在 <code>conn_limit</code> 区域，设置为10分钟。</li>
<li><code>limit_rate</code>: 设置单连接限速为500KB&#x2F;s。</li>
<li><code>limit_req</code>: 对静态资源请求进行限流，设置为每秒10个请求，突发20个，不延迟处理。</li>
<li><code>limit_conn</code>: 对单IP的并发连接数进行限制，设置为每IP最多5个连接。</li>
<li><code>limit_rate</code>: 对单连接限速为300KB&#x2F;s。</li>
<li><code>limit_req_status</code>: 当超过限流阈值时，返回503状态码。</li>
<li><code>limit_conn_status</code>: 当超过连接数限制时，返回503状态码。</li>
</ul>
<h3 id="应用配置并重启"><a href="#应用配置并重启" class="headerlink" title="应用配置并重启"></a>应用配置并重启</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 测试配置文件语法</span>
nginx <span class="token parameter variable">-t</span>

<span class="token comment"># 配置无误后重载Nginx</span>
nginx <span class="token parameter variable">-s</span> reload

<span class="token comment"># 或使用systemctl方式</span>
systemctl reload nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="2-2-启用防盗链保护（15分钟内完成）"><a href="#2-2-启用防盗链保护（15分钟内完成）" class="headerlink" title="2.2 启用防盗链保护（15分钟内完成）"></a>2.2 启用防盗链保护（15分钟内完成）</h2><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">location</span> ~* /uploadfiles/.*\.(png|jpg|jpeg|gif)$</span> <span class="token punctuation">&#123;</span>
    <span class="token comment"># 防盗链配置</span>
    <span class="token directive"><span class="token keyword">valid_referers</span> none blocked server_names
                   *.example.com
                   example.com
                   localhost</span><span class="token punctuation">;</span>
    
    <span class="token directive"><span class="token keyword">if</span> (<span class="token variable">$invalid_referer</span>)</span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">return</span> <span class="token number">403</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment"># 其他配置...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="配置说明-1"><a href="#配置说明-1" class="headerlink" title="配置说明"></a>配置说明</h3><ul>
<li><code>valid_referers</code>: 定义允许的Referer列表，包括直接访问、CDN回源IP、CDN域名、本地访问等。</li>
<li><code>if ($invalid_referer)</code>: 如果Referer不在允许列表中，则返回403状态码。</li>
</ul>
<h1 id="三、中期防御方案（24小时内部署）"><a href="#三、中期防御方案（24小时内部署）" class="headerlink" title="三、中期防御方案（24小时内部署）"></a>三、中期防御方案（24小时内部署）</h1><p>中期防御方案，需要在服务器上部署CDN + DDoS防护设备，以提供更全面的防御能力。</p>
<h2 id="3-1-接入CDN-DDoS防护"><a href="#3-1-接入CDN-DDoS防护" class="headerlink" title="3.1 接入CDN + DDoS防护"></a>3.1 接入CDN + DDoS防护</h2><h3 id="方案选择"><a href="#方案选择" class="headerlink" title="方案选择"></a>方案选择</h3><p><strong>阿里云CDN + DDoS高防</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 配置步骤</span>
<span class="token number">1</span>. 登录阿里云控制台
<span class="token number">2</span>. 开通CDN服务
<span class="token number">3</span>. 添加加速域名：www.example.com
<span class="token number">4</span>. 配置源站：当前服务器IP
<span class="token number">5</span>. 开通DDoS高防IP
<span class="token number">6</span>. 将域名解析到高防IP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意：</p>
<ul>
<li>需要确保CDN和DDoS高防IP的配置正确无误，否则会影响正常访问。</li>
</ul>
<h3 id="源站Nginx配置"><a href="#源站Nginx配置" class="headerlink" title="源站Nginx配置"></a>源站Nginx配置</h3><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token comment"># 源站Nginx配置示例</span>
<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span> www.example.com</span><span class="token punctuation">;</span>
    
    <span class="token comment"># 只允许CDN回源IP访问</span>
    <span class="token directive"><span class="token keyword">allow</span> 47.88.0.0/16</span><span class="token punctuation">;</span>      <span class="token comment"># 阿里云CDN IP段</span>
    <span class="token directive"><span class="token keyword">allow</span> 47.246.0.0/16</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">allow</span> 118.178.0.0/16</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">deny</span> all</span><span class="token punctuation">;</span>
    
    <span class="token comment"># 验证CDN回源请求</span>
    <span class="token directive"><span class="token keyword">if</span> (<span class="token variable">$http_x_forwarded_for</span> = <span class="token string">""</span>)</span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">return</span> <span class="token number">403</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">root</span> /var/www/html</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置说明：</p>
<ul>
<li><code>allow</code>: 允许访问的IP段，这里配置了阿里云CDN的IP段。</li>
<li><code>deny all</code>: 拒绝所有其他IP的访问。</li>
<li><code>if ($http_x_forwarded_for = &quot;&quot;)</code>: 如果请求头中没有X-Forwarded-For字段，说明不是CDN回源请求，返回403状态码。</li>
</ul>
<h3 id="其他CDN方案对比"><a href="#其他CDN方案对比" class="headerlink" title="其他CDN方案对比"></a>其他CDN方案对比</h3><table>
<thead>
<tr>
<th>方案</th>
<th>优势</th>
<th>成本</th>
</tr>
</thead>
<tbody><tr>
<td>腾讯云CDN + DDoS防护</td>
<td>成本相对较低，国内节点丰富</td>
<td>400-1500元&#x2F;月</td>
</tr>
<tr>
<td>Cloudflare（国际方案）</td>
<td>免费DDoS防护，全球CDN加速</td>
<td>免费-200美元&#x2F;月</td>
</tr>
</tbody></table>
<h3 id="预期效果"><a href="#预期效果" class="headerlink" title="预期效果"></a>预期效果</h3><ul>
<li><strong>防御能力</strong>: 100-300 Gbps</li>
<li><strong>源站流量减少</strong>: 80-95%</li>
<li><strong>响应时间</strong>: 降低30-50%</li>
<li><strong>成本</strong>: 约500-2000元&#x2F;月</li>
</ul>
<h1 id="四、长期防护策略"><a href="#四、长期防护策略" class="headerlink" title="四、长期防护策略"></a>四、长期防护策略</h1><h2 id="4-1-架构优化"><a href="#4-1-架构优化" class="headerlink" title="4.1 架构优化"></a>4.1 架构优化</h2><h3 id="静态资源分离"><a href="#静态资源分离" class="headerlink" title="静态资源分离"></a>静态资源分离</h3><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token comment"># 主站服务器（动态内容）</span>
<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span> www.example.com</span><span class="token punctuation">;</span>
    
    <span class="token comment"># 静态资源重定向到CDN</span>
    <span class="token directive"><span class="token keyword">location</span> ~* /uploadfiles/</span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">return</span> <span class="token number">301</span> https://cdn.example.com<span class="token variable">$request_uri</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment"># 动态内容</span>
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span> http://backend</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment"># CDN/静态资源服务器</span>
<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span> cdn.example.com</span><span class="token punctuation">;</span>
    
    <span class="token comment"># 严格限流</span>
    <span class="token directive"><span class="token keyword">limit_req</span> zone=cdn_limit burst=10</span><span class="token punctuation">;</span>
    
    <span class="token directive"><span class="token keyword">location</span> /uploadfiles/</span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">root</span> /var/www/static</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">expires</span> <span class="token number">30d</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">add_header</span> Cache-Control <span class="token string">"public, immutable"</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置说明：</p>
<ul>
<li><code>limit_req</code>: 对CDN请求进行限流，设置为每秒10个请求，突发10个。</li>
<li><code>expires</code>: 设置静态资源缓存时间为30天。</li>
<li><code>add_header</code>: 添加Cache-Control头，设置为public和immutable，确保浏览器缓存。</li>
</ul>
<h3 id="使用对象存储（OSS）"><a href="#使用对象存储（OSS）" class="headerlink" title="使用对象存储（OSS）"></a>使用对象存储（OSS）</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 将静态资源迁移到阿里云OSS</span>

<span class="token comment"># 1. 安装ossutil工具</span>
<span class="token function">wget</span> http://gosspublic.alicdn.com/ossutil/1.7.15/ossutil64
<span class="token function">chmod</span> +x ossutil64
<span class="token function">mv</span> ossutil64 /usr/local/bin/ossutil

<span class="token comment"># 2. 配置OSS访问凭证</span>
ossutil config

<span class="token comment"># 3. 批量上传文件到OSS</span>
ossutil <span class="token function">cp</span> <span class="token parameter variable">-r</span> /var/www/html/uploadfiles/ oss://your-bucket/uploadfiles/

<span class="token comment"># 4. 配置CDN加速OSS</span>
<span class="token comment"># 在阿里云控制台配置CDN指向OSS bucket</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="图片压缩与优化"><a href="#图片压缩与优化" class="headerlink" title="图片压缩与优化"></a>图片压缩与优化</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 批量压缩所有图片</span>
<span class="token function">cat</span> <span class="token operator">></span> /usr/local/bin/optimize_all_images.sh <span class="token operator">&lt;&lt;</span> <span class="token string">'EOF'
#!/bin/bash

UPLOAD_DIR="/var/www/html/uploadfiles"
BACKUP_DIR="/var/www/backup/uploadfiles_$(date +%Y%m%d)"

# 备份原文件
echo "备份原文件到 $BACKUP_DIR"
mkdir -p "$BACKUP_DIR"
cp -r "$UPLOAD_DIR" "$BACKUP_DIR"

# 优化PNG
echo "优化PNG图片..."
find "$UPLOAD_DIR" -name "*.png" -type f | while read img; do
    size_before=$(stat -f%z "$img" 2>/dev/null || stat -c%s "$img")
    pngquant --quality=65-80 --ext .png --force "$img" 2>/dev/null
    size_after=$(stat -f%z "$img" 2>/dev/null || stat -c%s "$img")
    saved=$((size_before - size_after))
    echo "  $img: $(numfmt --to=iec $size_before) -> $(numfmt --to=iec $size_after) (节省 $(numfmt --to=iec $saved))"
done

# 优化JPG
echo "优化JPG图片..."
find "$UPLOAD_DIR" -name "*.jpg" -o -name "*.jpeg" -type f | while read img; do
    size_before=$(stat -f%z "$img" 2>/dev/null || stat -c%s "$img")
    jpegoptim --max=85 --strip-all "$img" 2>/dev/null
    size_after=$(stat -f%z "$img" 2>/dev/null || stat -c%s "$img")
    saved=$((size_before - size_after))
    echo "  $img: $(numfmt --to=iec $size_before) -> $(numfmt --to=iec $size_after) (节省 $(numfmt --to=iec $saved))"
done

echo "优化完成！"
EOF</span>

<span class="token function">chmod</span> +x /usr/local/bin/optimize_all_images.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置说明：</p>
<ul>
<li><code>UPLOAD_DIR</code>: 静态资源目录。</li>
<li><code>BACKUP_DIR</code>: 备份目录，使用当前日期作为子目录。</li>
<li><code>pngquant</code>: 优化PNG图片，设置质量为65-80，不保留元数据。</li>
<li><code>jpegoptim</code>: 优化JPG图片，设置最大质量为85，不保留元数据。</li>
</ul>
<h1 id="五、实施时间表"><a href="#五、实施时间表" class="headerlink" title="五、实施时间表"></a>五、实施时间表</h1><h2 id="5-1-分阶段实施计划"><a href="#5-1-分阶段实施计划" class="headerlink" title="5.1 分阶段实施计划"></a>5.1 分阶段实施计划</h2><h3 id="第一阶段：紧急响应（立即-2小时）"><a href="#第一阶段：紧急响应（立即-2小时）" class="headerlink" title="第一阶段：紧急响应（立即-2小时）"></a>第一阶段：紧急响应（立即-2小时）</h3><ul>
<li>部署Nginx限流配置</li>
<li>启用IP黑名单</li>
<li>配置防盗链</li>
<li>压缩关键图片</li>
</ul>
<h3 id="第二阶段：中期防护（24小时内）"><a href="#第二阶段：中期防护（24小时内）" class="headerlink" title="第二阶段：中期防护（24小时内）"></a>第二阶段：中期防护（24小时内）</h3><ul>
<li>接入CDN服务</li>
<li>部署WAF规则</li>
<li>启动实时监控</li>
<li>配置告警系统</li>
</ul>
<h3 id="第三阶段：长期优化（1周内）"><a href="#第三阶段：长期优化（1周内）" class="headerlink" title="第三阶段：长期优化（1周内）"></a>第三阶段：长期优化（1周内）</h3><ul>
<li>静态资源迁移OSS</li>
<li>批量优化所有图片</li>
<li>部署监控面板</li>
<li>制定应急预案</li>
</ul>
<h1 id="六、验证与测试"><a href="#六、验证与测试" class="headerlink" title="六、验证与测试"></a>六、验证与测试</h1><h2 id="6-1-限流功能测试"><a href="#6-1-限流功能测试" class="headerlink" title="6.1 限流功能测试"></a>6.1 限流功能测试</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 使用ab进行压力测试</span>
ab <span class="token parameter variable">-n</span> <span class="token number">1000</span> <span class="token parameter variable">-c</span> <span class="token number">50</span> https://www.example.com/uploadfiles/banner/banner_img.png

<span class="token comment"># 预期结果：大部分请求返回503或429</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>


<h1 id="七、总结"><a href="#七、总结" class="headerlink" title="七、总结"></a>七、总结</h1><h2 id="7-1-核心要点"><a href="#7-1-核心要点" class="headerlink" title="7.1 核心要点"></a>7.1 核心要点</h2><ol>
<li><strong>立即行动</strong>: 部署Nginx限流和IP封禁（30分钟内完成）</li>
<li><strong>接入CDN</strong>: 最有效的防护手段，24小时内完成接入</li>
<li><strong>持续监控</strong>: 建立实时监控和告警机制</li>
<li><strong>优化资源</strong>: 压缩图片、使用OSS减少攻击面</li>
</ol>
<h2 id="7-2-预期效果"><a href="#7-2-预期效果" class="headerlink" title="7.2 预期效果"></a>7.2 预期效果</h2><ul>
<li><strong>防护能力</strong>: 从0提升到100+ Gbps</li>
<li><strong>带宽节省</strong>: 70-90%</li>
<li><strong>响应时间</strong>: 降低30-50%</li>
<li><strong>成本控制</strong>: 2000-5000元&#x2F;月</li>
<li><strong>服务稳定性</strong>: 99.9%可用性</li>
</ul>
<blockquote>
<p><strong>注意</strong>: 可根据实际情况立即部署。建议先在测试环境验证后再应用到生产环境。</p>
</blockquote>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><ul>
<li><a href="http://nginx.org/en/docs/http/ngx_http_limit_req_module.html">Nginx官方文档 - 限流配置</a></li>
<li><a href="https://www.aliyun.com/sswb/1700108_1.html">阿里云DDoS防护最佳实践</a></li>
</ul>
]]></content>
      <categories>
        <category>运维</category>
      </categories>
      <tags>
        <tag>DDoS防御</tag>
        <tag>Nginx限流</tag>
        <tag>CDN</tag>
        <tag>WAF</tag>
        <tag>流量攻击</tag>
      </tags>
  </entry>
  <entry>
    <title>Forecasting Research on the Wireless Mesh Network Throughput Based on the Support Vector Machine</title>
    <url>/2017/12/26/paper/ji-yu-zhi-chi-xiang-liang-ji-de-wu-xian-mesh-wang-luo-tun-tu-liang-yu-ce/</url>
    <content><![CDATA[<h1 id="《基于支持向量机的无线Mesh网络吞吐量预测》-——-论文"><a href="#《基于支持向量机的无线Mesh网络吞吐量预测》-——-论文" class="headerlink" title="《基于支持向量机的无线Mesh网络吞吐量预测》 —— 论文"></a>《基于支持向量机的无线Mesh网络吞吐量预测》 —— 论文</h1><span id="more"></span>
<div class="pdf-container" style="width: 100%; height: 600px; margin: 20px 0; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
    <iframe src="./基于支持向量机的无线Mesh网络吞吐量预测.pdf" width="100%" height="100%" frameborder="0" style="border: none; border-radius: 8px;">
      <div style="padding: 20px; text-align: center; background-color: #f8f9fa; border-radius: 8px;">
        <p style="margin: 0; color: #666;">您的浏览器不支持显示PDF文件</p>
        <a href="./基于支持向量机的无线Mesh网络吞吐量预测.pdf" target="_blank" style="color: #409eff; text-decoration: none; font-weight: 500;">📥 点击这里下载PDF文件</a>
      </div>
    </iframe>
  </div>]]></content>
      <categories>
        <category>论文</category>
      </categories>
      <tags>
        <tag>论文</tag>
      </tags>
  </entry>
  <entry>
    <title>Maven Resources Plugin 二进制文件filtering</title>
    <url>/2020/12/18/other/mavenresourcesplugin-binaryfiltering/</url>
    <content><![CDATA[<h1 id="一、问题背景"><a href="#一、问题背景" class="headerlink" title="一、问题背景"></a>一、问题背景</h1><p>Maven项目中打包使用Maven Resources Plugin拷贝配置文件，使用Filtering来处理项目配置文件中的变量，POM文件如下所示：</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;resources&gt;
    &lt;resource&gt;
        &lt;directory&gt;src&#x2F;main&#x2F;resources&lt;&#x2F;directory&gt;
        &lt;filtering&gt;true&lt;&#x2F;filtering&gt;
    &lt;&#x2F;resource&gt;
&lt;&#x2F;resources&gt;
&lt;testResources&gt;
    &lt;testResource&gt;
        &lt;directory&gt;src&#x2F;test&#x2F;resources&lt;&#x2F;directory&gt;
        &lt;filtering&gt;true&lt;&#x2F;filtering&gt;
    &lt;&#x2F;testResource&gt;
&lt;&#x2F;testResources&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但是对于项目配置文件目录下的二进制文件，经过Filtering处理后，文件内容发生了变化，如<code>pdf</code>, <code>ddl</code>文件内容被修改，导致打包后的文件无法正常使用。</p>
<h1 id="二、解决方案"><a href="#二、解决方案" class="headerlink" title="二、解决方案"></a>二、解决方案</h1><p>Maven Resources Plugin提供了Binary filtering配置项，阻止二进制文件被filtering，配置案例：</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;project&gt;
  ...
  &lt;build&gt;
    &lt;plugins&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;org.apache.maven.plugins&lt;&#x2F;groupId&gt;
        &lt;artifactId&gt;maven-resources-plugin&lt;&#x2F;artifactId&gt;
        &lt;version&gt;3.2.0&lt;&#x2F;version&gt;
        &lt;configuration&gt;
          ...
          &lt;nonFilteredFileExtensions&gt;
            &lt;nonFilteredFileExtension&gt;pdf&lt;&#x2F;nonFilteredFileExtension&gt;
            &lt;nonFilteredFileExtension&gt;swf&lt;&#x2F;nonFilteredFileExtension&gt;
          &lt;&#x2F;nonFilteredFileExtensions&gt;
          ...
        &lt;&#x2F;configuration&gt;
      &lt;&#x2F;plugin&gt;
    &lt;&#x2F;plugins&gt;
    ...
  &lt;&#x2F;build&gt;
  ...
&lt;&#x2F;project&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在<code>nonFilteredFileExtension</code>添加文件扩展名可以阻止文件被filtering。</p>
<h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><p><a href="https://maven.apache.org/plugins/maven-resources-plugin/">Apache Maven Resources Plugin</a><br><a href="https://maven.apache.org/plugins/maven-resources-plugin/examples/binaries-filtering.html">Apache Maven Resources Plugin&#x2F; Binaries Filtering</a></p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>Maven</tag>
      </tags>
  </entry>
  <entry>
    <title>使用Hexo搭建个人博客</title>
    <url>/2018/07/25/other/shi-yong-hexo-da-jian-ge-ren-bo-ke/</url>
    <content><![CDATA[<p>记录一下自己使用Hexo搭建个人博客的过程，以及搭建过程中踩过的坑。<br> <strong>Hexo简介</strong><br>这里引用<a href="https://hexo.io/">Hexo</a>官网介绍：  </p>
<blockquote>
<p>快速、简洁且高效的博客框架<br>A fast, simple &amp; powerful blog framework.</p>
</blockquote>
<h1 id="一、为什么选择Hexo"><a href="#一、为什么选择Hexo" class="headerlink" title="一、为什么选择Hexo"></a>一、为什么选择Hexo</h1><p>之前也想过自己用java写一个博客系统，顺便能学习一些开发技术。通过一段时间的折腾，主要发现有一下几个问题，于是放弃了自己开发的计划转而采用开源框架。</p>
<blockquote>
<p>使用java自行开发个人博客系统遇到的问题：</p>
</blockquote>
<ul>
<li>开发周期长：虽然可以使用一些脚手架快速搭建博客系统框架，但是仍需要个人大量的开发时间去实现及调试代码。</li>
<li>UI样式不美观: 由于本人是非前端开发人员，只能通过前端的一些脚手架去搭建博客前端，UI设计不够美观。</li>
<li>偏离初始目标：自己开发博客的目标是通过开发过程提高编码水平，但是随着在工作中的成长，知识面已经铺开，搭建个人博客已经无法带来技术深层面成长，只是重复造轮子罢了。</li>
</ul>
<h2 id="hexo-博客的优点"><a href="#hexo-博客的优点" class="headerlink" title="hexo 博客的优点"></a>hexo 博客的优点</h2><ul>
<li>支持MarkDown格式</li>
<li>使用Node.js生成静态文件，部署简便</li>
<li>有丰富的主题可以选择</li>
<li>有丰富的插件扩展性强</li>
</ul>
<p>选择hexo搭建个人博客完全满足我个人写博客的要求，最终选择使用hexo来搭建个人博客。</p>
<h1 id="二、如何管理个人博客"><a href="#二、如何管理个人博客" class="headerlink" title="二、如何管理个人博客"></a>二、如何管理个人博客</h1><h2 id="2-1-博客资源文件存储"><a href="#2-1-博客资源文件存储" class="headerlink" title="2.1 博客资源文件存储"></a>2.1 博客资源文件存储</h2><p>个人博客是以Node.js项目形式托管到github的私有仓库中的，方便我在任意设备去编辑发布博客。</p>
<h2 id="2-2-写作及提交新文章"><a href="#2-2-写作及提交新文章" class="headerlink" title="2.2 写作及提交新文章"></a>2.2 写作及提交新文章</h2><p>从github检出项目，我们可以使用<code>jetbrain</code>系列的开发工具安装MarkDown插件后进行写作新文章，或者使用常用MarkDown软件进行写作，完成后将文章提交到github仓库。</p>
<h2 id="2-3-文章发布更新"><a href="#2-3-文章发布更新" class="headerlink" title="2.3 文章发布更新"></a>2.3 文章发布更新</h2><blockquote>
<p><strong>前置条件</strong><br>目前个人博客是部署在个人购买的华为云服务器上，使用Nginx进行托管的。<br>云服务器安装Node.js及hexo环境，将github上的博客仓库克隆到本地,在Nginx中将博客的托管路径设置为hexo博客构建目录。</p>
</blockquote>
<p>文章发布时只在本地仓库下执行<code>git pull</code>和<code>hexo g</code>两个命令即可生成博客内容。<br>为简化操作，将上述脚本写入shell脚本，通过执行脚本进行发布文章。如果不想每次都去手动发布，可以添加系统定时任务，做到定时执行脚本去发布文章。</p>
<h1 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h1><p>使用github托管博客主要的优点在于添加新文章方便，我们使用MarkDown写完文章后，可以方便的提交到itHub进行管理；然后可以在任意地方去编辑修改及部署。</p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>hexo</tag>
        <tag>博客</tag>
      </tags>
  </entry>
  <entry>
    <title>JMX-Exporter虚拟机JVM监控采集部署</title>
    <url>/2024/12/30/prometheus/jmx-exporter-xu-ni-ji-jvm-jian-kong-cai-ji-bu-shu/</url>
    <content><![CDATA[<h1 id="一、背景简介"><a href="#一、背景简介" class="headerlink" title="一、背景简介"></a>一、背景简介</h1><p>虚拟机部署的Java应用没有集成SpringBoot自带监控Actuator，需要额外手动配置采集JVM监控。JMX-Exporter作为Prometheus生态系统中重要的组件，能够将JMX（Java Management Extensions）指标转换为Prometheus格式，实现对Java应用的深度监控。</p>
<div class="note primary no-icon flat"><p><strong>核心解决问题</strong>：</p>
<ul>
<li>传统Java应用缺乏现代化监控指标暴露</li>
<li>需要统一监控数据格式对接Prometheus</li>
<li>实现JVM性能指标的实时采集和分析</li>
</ul>
</div>

<span id="more"></span>

<h1 id="二、JMX-Agent部署步骤"><a href="#二、JMX-Agent部署步骤" class="headerlink" title="二、JMX Agent部署步骤"></a>二、JMX Agent部署步骤</h1><h2 id="2-1-部署文件"><a href="#2-1-部署文件" class="headerlink" title="2.1. 部署文件"></a>2.1. 部署文件</h2><p>在开始部署之前，需要准备以下核心文件：</p>
<table>
<thead>
<tr>
<th>文件类型</th>
<th>文件名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>JVM监控Agent</td>
<td><code>jmx_prometheus_javaagent-1.2.0.jar</code></td>
<td>JMX指标收集器</td>
</tr>
<tr>
<td>监控配置文件</td>
<td><code>exporter.yaml</code></td>
<td>JMX指标采集规则配置</td>
</tr>
</tbody></table>
<h3 id="exporter-yaml"><a href="#exporter-yaml" class="headerlink" title="exporter.yaml"></a>exporter.yaml</h3><pre class="line-numbers language-none"><code class="language-none">rules:
  - pattern: &quot;.*&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<div class="note info no-icon flat"><p><strong>版本说明</strong>：</p>
<ul>
<li>建议使用JMX Prometheus JavaAgent 1.2.0或更新版本</li>
<li>配置文件需要根据应用特点进行定制化调整</li>
</ul>
</div>

<h2 id="2-2-部署步骤"><a href="#2-2-部署步骤" class="headerlink" title="2.2. 部署步骤"></a>2.2. 部署步骤</h2><h3 id="（1）文件部署"><a href="#（1）文件部署" class="headerlink" title="（1）文件部署"></a>（1）文件部署</h3><ol>
<li><strong>Agent部署</strong>：将<code>jmx_prometheus_javaagent-1.2.0.jar</code>文件添加到Java应用模块的<code>lib</code>目录下</li>
<li><strong>配置文件部署</strong>：将<code>exporter.yaml</code>配置文件添加到应用模块的<code>conf</code>目录下</li>
<li><strong>启动脚本修改</strong>：修改Java应用模块的启动脚本，增加jmx-agent的启动参数</li>
</ol>
<h3 id="（2）修改应用启动脚本配置"><a href="#（2）修改应用启动脚本配置" class="headerlink" title="（2）修改应用启动脚本配置"></a>（2）修改应用启动脚本配置</h3><p><strong>基础配置示例：</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">java</span> -javaagent:./lib/jmx_prometheus_javaagent-1.2.0.jar<span class="token operator">=</span><span class="token number">8585</span>:./conf/exporter.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>完整启动脚本示例：</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">java</span> -javaagent:./lib/jmx_prometheus_javaagent-1.2.0.jar<span class="token operator">=</span><span class="token number">8585</span>:./conf/exporter.yaml <span class="token punctuation">\</span>
     <span class="token variable">$&#123;JAVA_OPTS&#125;</span> <span class="token punctuation">\</span>
     <span class="token parameter variable">-cp</span> <span class="token variable">$&#123;CLASSPATH&#125;</span> <span class="token punctuation">\</span>
     com.example.application.server.ApplicationServer <span class="token punctuation">\</span>
     <span class="token operator">></span> <span class="token variable">$&#123;SERVER_LOG&#125;</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<div class="note warning no-icon flat"><p><strong>配置要点</strong>：</p>
<ul>
<li>端口8585可根据实际情况调整，需确保端口未被占用</li>
<li>javaagent参数必须在主类之前指定</li>
<li>路径必须与实际文件位置保持一致</li>
</ul>
</div>

<h2 id="2-3-重启应用模块"><a href="#2-3-重启应用模块" class="headerlink" title="2.3. 重启应用模块"></a>2.3. 重启应用模块</h2><p>修改启动脚本后，需要重启应用模块使配置生效：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 停止应用</span>
./stop.sh

<span class="token comment"># 启动应用</span>
./start.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="2-4-验证Agent启动"><a href="#2-4-验证Agent启动" class="headerlink" title="2.4. 验证Agent启动"></a>2.4. 验证Agent启动</h2><p>使用浏览器或curl命令验证JMX-Exporter是否正常工作：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> http://host:8585/metrics<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<div class="note success no-icon flat"><p><strong>验证成功标志</strong>：</p>
<ul>
<li>返回Prometheus格式的指标数据</li>
<li>包含JVM相关指标如<code>jvm_memory_bytes_used</code>、<code>jvm_gc_duration_seconds</code>等</li>
<li>HTTP状态码为200</li>
</ul>
</div>

<h1 id="三、Prometheus监控采集配置"><a href="#三、Prometheus监控采集配置" class="headerlink" title="三、Prometheus监控采集配置"></a>三、Prometheus监控采集配置</h1><h2 id="3-1-配置Kubernetes-Endpoints"><a href="#3-1-配置Kubernetes-Endpoints" class="headerlink" title="3.1. 配置Kubernetes Endpoints"></a>3.1. 配置Kubernetes Endpoints</h2><p>创建<code>应用名称-jmx-exporter-endpoints.yaml</code>文件：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Endpoints
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> 应用名称<span class="token punctuation">-</span>jmx<span class="token punctuation">-</span>exporter
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
<span class="token key atrule">subsets</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">addresses</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">ip</span><span class="token punctuation">:</span> 192.168.1.10  <span class="token comment"># JMX服务器IP1</span>
  <span class="token punctuation">-</span> <span class="token key atrule">ip</span><span class="token punctuation">:</span> 192.168.1.11  <span class="token comment"># JMX服务器IP2</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8585</span>  <span class="token comment"># jmx-exporter端口</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<div class="note info no-icon flat"><p><strong>配置说明</strong>：</p>
<ul>
<li>替换<code>应用名称</code>为实际应用标识</li>
<li><code>ip</code>字段填写部署JMX-Exporter的服务器IP地址</li>
<li><code>port</code>需与启动脚本中配置的端口保持一致</li>
</ul>
</div>

<h2 id="3-2-配置Kubernetes-Service"><a href="#3-2-配置Kubernetes-Service" class="headerlink" title="3.2. 配置Kubernetes Service"></a>3.2. 配置Kubernetes Service</h2><p>创建<code>应用名称-jmx-exporter-service.yaml</code>文件：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> jmx<span class="token punctuation">-</span>exporter
    <span class="token key atrule">platform</span><span class="token punctuation">:</span> app<span class="token punctuation">-</span>platform          <span class="token comment"># 应用所属平台</span>
    <span class="token key atrule">modules</span><span class="token punctuation">:</span> 应用名称        <span class="token comment"># 具体应用模块名</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> jmx<span class="token punctuation">-</span>exporter
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8585</span>              <span class="token comment"># jmx-exporter端口</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> http
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<div class="note primary no-icon flat"><p><strong>关键配置项</strong>：</p>
<ul>
<li><code>platform</code>：标识应用所属的业务平台</li>
<li><code>modules</code>：标识具体的应用模块名称</li>
<li>这些标签将用于Prometheus的指标分类和查询</li>
</ul>
</div>

<h2 id="3-3-配置ServiceMonitor"><a href="#3-3-配置ServiceMonitor" class="headerlink" title="3.3. 配置ServiceMonitor"></a>3.3. 配置ServiceMonitor</h2><p>创建<code>jmx-exporter-monitor.yaml</code>文件：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> monitoring.coreos.com/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceMonitor
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> jmx<span class="token punctuation">-</span>exporter
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">interval</span><span class="token punctuation">:</span> 15s           <span class="token comment"># 采集间隔</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /metrics          <span class="token comment"># 指标暴露路径</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> http
  <span class="token key atrule">targetLabels</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> platform
  <span class="token punctuation">-</span> modules
  <span class="token key atrule">namespaceSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchNames</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> monitoring
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> jmx<span class="token punctuation">-</span>exporter<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<div class="note success no-icon flat"><p><strong>ServiceMonitor功能</strong>：</p>
<ul>
<li>自动发现符合条件的Service</li>
<li>定时采集JMX指标数据</li>
<li>将标签信息传递给Prometheus</li>
</ul>
</div>

<h2 id="3-4-启用配置"><a href="#3-4-启用配置" class="headerlink" title="3.4. 启用配置"></a>3.4. 启用配置</h2><p>按顺序执行以下命令启用监控配置：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建Endpoints</span>
kubectl apply <span class="token parameter variable">-f</span> 应用名称-jmx-exporter-endpoints.yaml

<span class="token comment"># 创建Service</span>
kubectl apply <span class="token parameter variable">-f</span> 应用名称-jmx-exporter-service.yaml

<span class="token comment"># 创建ServiceMonitor</span>
kubectl apply <span class="token parameter variable">-f</span> jmx-exporter-monitor.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>验证配置生效：</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看Endpoints状态</span>
kubectl get endpoints <span class="token parameter variable">-n</span> monitoring <span class="token operator">|</span> <span class="token function">grep</span> jmx-exporter

<span class="token comment"># 查看Service状态</span>
kubectl get <span class="token function">service</span> <span class="token parameter variable">-n</span> monitoring <span class="token operator">|</span> <span class="token function">grep</span> jmx-exporter

<span class="token comment"># 查看ServiceMonitor状态</span>
kubectl get servicemonitor <span class="token parameter variable">-n</span> monitoring <span class="token operator">|</span> <span class="token function">grep</span> jmx-exporter<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="四、监控指标说明"><a href="#四、监控指标说明" class="headerlink" title="四、监控指标说明"></a>四、监控指标说明</h1><h2 id="4-1-核心JVM指标"><a href="#4-1-核心JVM指标" class="headerlink" title="4.1. 核心JVM指标"></a>4.1. 核心JVM指标</h2><p>JMX-Exporter采集的主要JVM指标包括：</p>
<div class="note info no-icon flat"><p><strong>内存指标</strong>：</p>
<ul>
<li><code>jvm_memory_bytes_used</code>：JVM内存使用量</li>
<li><code>jvm_memory_bytes_max</code>：JVM最大内存</li>
<li><code>jvm_memory_pool_bytes_used</code>：内存池使用情况</li>
</ul>
<p><strong>垃圾回收指标</strong>：</p>
<ul>
<li><code>jvm_gc_duration_seconds</code>：GC耗时统计</li>
<li><code>jvm_gc_collection_seconds</code>：GC收集时间</li>
<li><code>jvm_memory_pool_allocated_bytes_total</code>：内存分配总量</li>
</ul>
<p><strong>线程指标</strong>：</p>
<ul>
<li><code>jvm_threads_current</code>：当前线程数</li>
<li><code>jvm_threads_peak</code>：线程峰值</li>
<li><code>jvm_threads_daemon</code>：守护线程数</li>
</ul>
</div>

<h2 id="4-2-告警规则配置"><a href="#4-2-告警规则配置" class="headerlink" title="4.2. 告警规则配置"></a>4.2. 告警规则配置</h2><p>基于JMX指标可以配置相应的告警规则：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">groups</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> jvm_alerts
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> JVMMemoryHigh
    <span class="token key atrule">expr</span><span class="token punctuation">:</span> jvm_memory_bytes_used / jvm_memory_bytes_max <span class="token punctuation">></span> 0.9
    <span class="token key atrule">for</span><span class="token punctuation">:</span> 2m
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">severity</span><span class="token punctuation">:</span> warning
    <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
      <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">"JVM内存使用率过高"</span>
      <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; $labels.instance &#125;&#125; JVM内存使用率超过90%"</span>
      
  <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> JVMGCTimeHigh
    <span class="token key atrule">expr</span><span class="token punctuation">:</span> rate(jvm_gc_duration_seconds_sum<span class="token punctuation">[</span>5m<span class="token punctuation">]</span>) <span class="token punctuation">></span> 0.1
    <span class="token key atrule">for</span><span class="token punctuation">:</span> 1m
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">severity</span><span class="token punctuation">:</span> critical
    <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
      <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">"JVM GC时间过长"</span>
      <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; $labels.instance &#125;&#125; GC时间占比超过10%"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="五、故障排查"><a href="#五、故障排查" class="headerlink" title="五、故障排查"></a>五、故障排查</h1><h2 id="5-1-常见问题"><a href="#5-1-常见问题" class="headerlink" title="5.1. 常见问题"></a>5.1. 常见问题</h2><div class="note warning no-icon flat"><p><strong>Agent启动失败</strong>：</p>
<ul>
<li>检查jar文件路径是否正确</li>
<li>验证配置文件语法是否正确</li>
<li>确认端口是否被占用</li>
</ul>
<p><strong>指标采集异常</strong>：</p>
<ul>
<li>检查网络连通性</li>
<li>验证ServiceMonitor配置</li>
<li>查看Prometheus日志</li>
</ul>
</div>

<h2 id="5-2-日志排查"><a href="#5-2-日志排查" class="headerlink" title="5.2. 日志排查"></a>5.2. 日志排查</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看应用启动日志</span>
<span class="token function">tail</span> <span class="token parameter variable">-f</span> application.log

<span class="token comment"># 查看Prometheus采集日志</span>
kubectl logs <span class="token parameter variable">-n</span> monitoring prometheus-xxx

<span class="token comment"># 检查ServiceMonitor状态</span>
kubectl describe servicemonitor jmx-exporter <span class="token parameter variable">-n</span> monitoring<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>JMX-Exporter为传统Java应用提供了现代化的监控能力，通过本方案可以实现：</p>
<ol>
<li><strong>统一监控体系</strong>：将JMX指标纳入Prometheus监控生态</li>
<li><strong>自动化采集</strong>：通过Kubernetes原生组件实现自动发现和采集</li>
<li><strong>灵活配置</strong>：支持自定义指标采集规则和告警策略</li>
<li><strong>可扩展性</strong>：支持多实例、多应用的统一管理</li>
</ol>
<p>通过标准化的部署流程，可以快速为现有Java应用添加完善的JVM监控能力，提升系统可观测性。</p>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><ul>
<li><a href="https://github.com/prometheus/jmx_exporter">JMX Exporter官方文档</a></li>
<li><a href="https://prometheus-operator.dev/docs/operator/design/#servicemonitor">Prometheus ServiceMonitor配置</a></li>
<li><a href="https://prometheus.io/docs/guides/java-monitoring/">JVM监控最佳实践</a></li>
<li><a href="https://docs.oracle.com/en/industries/energy-water/advanced-meter/2.9.0.0.0/c2m-server-admin-guide/index.html#page/C2M_SERVER_ADMIN_29000/C2M_Server_Admin_Monitoring.05.5.html">Oracle指标说明</a></li>
</ul>
]]></content>
      <categories>
        <category>系统监控</category>
      </categories>
      <tags>
        <tag>Prometheus</tag>
        <tag>JMX-Exporter</tag>
        <tag>JVM</tag>
        <tag>监控采集</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL主从监控配置-Helm部署方案</title>
    <url>/2024/12/30/prometheus/mysql-zhu-cong-jian-kong-pei-zhi-helm-bu-shu-fang-an/</url>
    <content><![CDATA[<h1 id="一、背景简介"><a href="#一、背景简介" class="headerlink" title="一、背景简介"></a>一、背景简介</h1><p>生产环境的MySQL监控面临着部署复杂、标签不统一、管理困难等问题。传统方式中每个MySQL实例都需要单独部署一个exporter，部署方式繁琐，采集的指标标签不统一，无法在监控图表上快速检索查看。</p>
<div class="note primary no-icon flat"><p><strong>核心解决问题</strong>：</p>
<ul>
<li>简化MySQL监控的部署流程</li>
<li>统一监控指标标签格式</li>
<li>支持灵活的多实例监控管理</li>
<li>提供安全的认证信息存储</li>
</ul>
</div>

<p>本方案采用Helm部署mysql-exporter实现MySQL监控采集，可以灵活增加mysql监控实例，大大简化了运维管理复杂度。</p>
<span id="more"></span>

<h1 id="二、部署文件准备"><a href="#二、部署文件准备" class="headerlink" title="二、部署文件准备"></a>二、部署文件准备</h1><h2 id="2-1-必需文件清单"><a href="#2-1-必需文件清单" class="headerlink" title="2.1. 必需文件清单"></a>2.1. 必需文件清单</h2><table>
<thead>
<tr>
<th>文件类型</th>
<th>文件名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Helm Charts</td>
<td><code>prometheus-mysql-exporter-2.10.0.tgz</code></td>
<td>prometheus-mysql-exporter chart部署包</td>
</tr>
<tr>
<td>配置文件</td>
<td><code>mysql-exporter-values.yaml</code></td>
<td>mysql-exporter配置文件</td>
</tr>
</tbody></table>
<div class="note info no-icon flat"><p><strong>版本说明</strong>：</p>
<ul>
<li>推荐使用prometheus-mysql-exporter 2.10.0或更新版本</li>
<li>Chart包包含了完整的Kubernetes资源定义</li>
<li>values.yaml文件用于定制化配置参数</li>
</ul>
</div>

<h2 id="2-2-环境要求"><a href="#2-2-环境要求" class="headerlink" title="2.2. 环境要求"></a>2.2. 环境要求</h2><ul>
<li>Kubernetes集群环境</li>
<li>Helm 3.x已安装配置</li>
<li>Prometheus Operator已部署</li>
<li>具备集群管理权限</li>
</ul>
<h1 id="三、配置步骤"><a href="#三、配置步骤" class="headerlink" title="三、配置步骤"></a>三、配置步骤</h1><h2 id="3-1-MySQL监控账号创建"><a href="#3-1-MySQL监控账号创建" class="headerlink" title="3.1. MySQL监控账号创建"></a>3.1. MySQL监控账号创建</h2><p>MySQL监控账号用于采集MySQL监控数据，需要具备特定的权限以确保能够获取完整的监控指标。</p>
<h3 id="（1）创建监控用户"><a href="#（1）创建监控用户" class="headerlink" title="（1）创建监控用户"></a>（1）创建监控用户</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">USER</span> <span class="token string">'exporter'</span><span class="token variable">@'%'</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">'your-secure-password'</span> <span class="token keyword">WITH</span> MAX_USER_CONNECTIONS <span class="token number">3</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="（2）授权必要权限"><a href="#（2）授权必要权限" class="headerlink" title="（2）授权必要权限"></a>（2）授权必要权限</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">GRANT</span> PROCESS<span class="token punctuation">,</span> <span class="token keyword">REPLICATION</span> CLIENT<span class="token punctuation">,</span> <span class="token keyword">SELECT</span> <span class="token keyword">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">'exporter'</span><span class="token variable">@'%'</span><span class="token punctuation">;</span>
FLUSH <span class="token keyword">PRIVILEGES</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<div class="note warning no-icon flat"><p><strong>安全配置要点</strong>：</p>
<ul>
<li>将<code>&#39;exporter&#39;@&#39;%&#39;</code>中的<code>%</code>调整为生产环境K8s的具体IP段</li>
<li>设置<code>MAX_USER_CONNECTIONS 3</code>避免监控连接过多导致数据库过载</li>
<li>使用强密码并定期轮换</li>
<li>仅授权必要的最小权限集</li>
</ul>
</div>

<h3 id="（3）权限说明"><a href="#（3）权限说明" class="headerlink" title="（3）权限说明"></a>（3）权限说明</h3><table>
<thead>
<tr>
<th>权限类型</th>
<th>用途说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>PROCESS</code></td>
<td>查看进程列表，获取连接状态信息</td>
</tr>
<tr>
<td><code>REPLICATION CLIENT</code></td>
<td>获取主从复制状态信息</td>
</tr>
<tr>
<td><code>SELECT</code></td>
<td>查询performance_schema等系统表</td>
</tr>
</tbody></table>
<h2 id="3-2-配置文件修改"><a href="#3-2-配置文件修改" class="headerlink" title="3.2. 配置文件修改"></a>3.2. 配置文件修改</h2><p>修改<code>mysql-exporter-values.yaml</code>配置文件中的关键配置项：</p>
<h3 id="（1）多目标配置结构"><a href="#（1）多目标配置结构" class="headerlink" title="（1）多目标配置结构"></a>（1）多目标配置结构</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">serviceMonitor</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">additionalLabels</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
  <span class="token key atrule">jobLabel</span><span class="token punctuation">:</span> <span class="token string">""</span>
  <span class="token key atrule">targetLabels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token key atrule">podTargetLabels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token key atrule">metricRelabelings</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token key atrule">relabelings</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  
  <span class="token comment"># 启用多目标采集</span>
  <span class="token key atrule">multipleTarget</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">targets</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> 172.16.1.15
      <span class="token key atrule">name</span><span class="token punctuation">:</span> app<span class="token punctuation">-</span>db<span class="token punctuation">-</span>write<span class="token punctuation">-</span>master
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3306</span>
      <span class="token key atrule">user</span><span class="token punctuation">:</span> exporter
      <span class="token key atrule">password</span><span class="token punctuation">:</span> your<span class="token punctuation">-</span>secure<span class="token punctuation">-</span>password
    <span class="token punctuation">-</span> <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> 172.16.1.17
      <span class="token key atrule">name</span><span class="token punctuation">:</span> app<span class="token punctuation">-</span>db<span class="token punctuation">-</span>backup<span class="token punctuation">-</span>master
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3306</span>
      <span class="token key atrule">user</span><span class="token punctuation">:</span> exporter
      <span class="token key atrule">password</span><span class="token punctuation">:</span> your<span class="token punctuation">-</span>secure<span class="token punctuation">-</span>password
      
  <span class="token comment"># 共享认证配置（可选）</span>
  <span class="token key atrule">sharedSecret</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="（2）配置参数详解"><a href="#（2）配置参数详解" class="headerlink" title="（2）配置参数详解"></a>（2）配置参数详解</h3><table>
<thead>
<tr>
<th>配置项</th>
<th>示例值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>endpoint</code></td>
<td><code>172.16.1.15</code></td>
<td>MySQL实例的IP地址或域名<br><strong>注意</strong>：使用域名配置多个IP时需使用具体IP避免数据混乱</td>
</tr>
<tr>
<td><code>name</code></td>
<td><code>app-db-write-master</code></td>
<td>节点标识名称，用于监控页面筛选<br><strong>命名规范</strong>：平台-用途-角色</td>
</tr>
<tr>
<td><code>port</code></td>
<td><code>3306</code></td>
<td>MySQL端口，默认3306，可选配置</td>
</tr>
<tr>
<td><code>user</code></td>
<td><code>exporter</code></td>
<td>监控账号用户名</td>
</tr>
<tr>
<td><code>password</code></td>
<td><code>your-secure-password</code></td>
<td>监控账号密码<br><strong>注意</strong>：避免使用<code>#</code>等特殊字符</td>
</tr>
</tbody></table>
<h3 id="（3）命名规范示例"><a href="#（3）命名规范示例" class="headerlink" title="（3）命名规范示例"></a>（3）命名规范示例</h3><div class="note success no-icon flat"><p><strong>标准命名格式</strong>：<code>平台-地区-用途-角色[-附加信息]</code></p>
<p><strong>示例说明</strong>：</p>
<ul>
<li><code>app-db-write-master</code>：应用数据库写入主节点</li>
<li><code>app-db-backup-master</code>：应用数据库备份主节点  </li>
<li><code>app-db-write-master-slave</code>：应用数据库写入主节点的从节点</li>
<li><code>app-cache-backup-master</code>：应用缓存备份主节点</li>
<li><code>app-cache-backup-slave</code>：应用缓存备份从节点</li>
</ul>
<p><strong>命名约束</strong>：</p>
<ul>
<li>不能包含<code>.</code>等特殊字符</li>
<li>建议使用英文字母和短横线<code>-</code></li>
<li>保持简洁明了，便于识别</li>
</ul>
</div>

<h1 id="四、部署实施"><a href="#四、部署实施" class="headerlink" title="四、部署实施"></a>四、部署实施</h1><h2 id="4-1-部署命令"><a href="#4-1-部署命令" class="headerlink" title="4.1. 部署命令"></a>4.1. 部署命令</h2><p>在具备Helm环境的生产服务器上执行部署：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 部署MySQL监控</span>
helm <span class="token function">install</span> prometheus-mysql-exporter <span class="token punctuation">\</span>
  prometheus-mysql-exporter-2.10.0.tgz <span class="token punctuation">\</span>
  <span class="token parameter variable">--version</span> <span class="token number">2.10</span>.0 <span class="token punctuation">\</span>
  <span class="token parameter variable">-n</span> monitoring <span class="token punctuation">\</span>
  <span class="token parameter variable">-f</span> mysql-exporter-values.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-2-部署验证"><a href="#4-2-部署验证" class="headerlink" title="4.2. 部署验证"></a>4.2. 部署验证</h2><h3 id="（1）检查Pod状态"><a href="#（1）检查Pod状态" class="headerlink" title="（1）检查Pod状态"></a>（1）检查Pod状态</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看Pod状态</span>
kubectl get pods <span class="token parameter variable">-n</span> monitoring <span class="token operator">|</span> <span class="token function">grep</span> mysql-exporter

<span class="token comment"># 查看Pod详细信息</span>
kubectl describe pod <span class="token operator">&lt;</span>mysql-exporter-pod-name<span class="token operator">></span> <span class="token parameter variable">-n</span> monitoring<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="（2）验证Service和ServiceMonitor"><a href="#（2）验证Service和ServiceMonitor" class="headerlink" title="（2）验证Service和ServiceMonitor"></a>（2）验证Service和ServiceMonitor</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看Service</span>
kubectl get <span class="token function">service</span> <span class="token parameter variable">-n</span> monitoring <span class="token operator">|</span> <span class="token function">grep</span> mysql-exporter

<span class="token comment"># 查看ServiceMonitor</span>
kubectl get servicemonitor <span class="token parameter variable">-n</span> monitoring <span class="token operator">|</span> <span class="token function">grep</span> mysql-exporter<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="（3）验证指标采集"><a href="#（3）验证指标采集" class="headerlink" title="（3）验证指标采集"></a>（3）验证指标采集</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 端口转发测试</span>
kubectl port-forward service/prometheus-mysql-exporter <span class="token number">9104</span>:9104 <span class="token parameter variable">-n</span> monitoring

<span class="token comment"># 访问指标端点</span>
<span class="token function">curl</span> http://localhost:9104/metrics<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-3-安全清理"><a href="#4-3-安全清理" class="headerlink" title="4.3. 安全清理"></a>4.3. 安全清理</h2><div class="note warning no-icon flat"><p><strong>重要提醒</strong>：部署完成后，为避免配置文件中数据库监控账号及密码泄漏，应立即删除本地配置文件：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 删除本地配置文件</span>
<span class="token function">rm</span> mysql-exporter-values.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>后续查看配置方式</strong>：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 通过Helm查看当前配置</span>
helm get values prometheus-mysql-exporter <span class="token parameter variable">-n</span> monitoring<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div>

<h1 id="五、监控配置管理"><a href="#五、监控配置管理" class="headerlink" title="五、监控配置管理"></a>五、监控配置管理</h1><h2 id="5-1-添加新的MySQL实例"><a href="#5-1-添加新的MySQL实例" class="headerlink" title="5.1. 添加新的MySQL实例"></a>5.1. 添加新的MySQL实例</h2><h3 id="（1）获取当前配置"><a href="#（1）获取当前配置" class="headerlink" title="（1）获取当前配置"></a>（1）获取当前配置</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 导出当前配置</span>
helm get values prometheus-mysql-exporter <span class="token parameter variable">-n</span> monitoring <span class="token operator">></span> current-values.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="（2）修改配置添加新实例"><a href="#（2）修改配置添加新实例" class="headerlink" title="（2）修改配置添加新实例"></a>（2）修改配置添加新实例</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 在targets中添加新的MySQL实例</span>
<span class="token key atrule">targets</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> 172.16.1.18
  <span class="token key atrule">name</span><span class="token punctuation">:</span> app<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>write<span class="token punctuation">-</span>master
  <span class="token key atrule">user</span><span class="token punctuation">:</span> exporter
  <span class="token key atrule">password</span><span class="token punctuation">:</span> your<span class="token punctuation">-</span>secure<span class="token punctuation">-</span>password<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="（3）更新部署"><a href="#（3）更新部署" class="headerlink" title="（3）更新部署"></a>（3）更新部署</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 更新Helm部署</span>
helm upgrade prometheus-mysql-exporter <span class="token punctuation">\</span>
  prometheus-mysql-exporter-2.10.0.tgz <span class="token punctuation">\</span>
  <span class="token parameter variable">--version</span> <span class="token number">2.10</span>.0 <span class="token punctuation">\</span>
  <span class="token parameter variable">-n</span> monitoring <span class="token punctuation">\</span>
  <span class="token parameter variable">-f</span> current-values.yaml
  
<span class="token comment"># 清理临时配置文件</span>
<span class="token function">rm</span> current-values.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="5-2-移除MySQL实例"><a href="#5-2-移除MySQL实例" class="headerlink" title="5.2. 移除MySQL实例"></a>5.2. 移除MySQL实例</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 导出配置并编辑</span>
helm get values prometheus-mysql-exporter <span class="token parameter variable">-n</span> monitoring <span class="token operator">></span> temp-values.yaml

<span class="token comment"># 编辑文件移除不需要的targets配置</span>
<span class="token function">vim</span> temp-values.yaml

<span class="token comment"># 应用更新</span>
helm upgrade prometheus-mysql-exporter <span class="token punctuation">\</span>
  prometheus-mysql-exporter-2.10.0.tgz <span class="token punctuation">\</span>
  <span class="token parameter variable">--version</span> <span class="token number">2.10</span>.0 <span class="token punctuation">\</span>
  <span class="token parameter variable">-n</span> monitoring <span class="token punctuation">\</span>
  <span class="token parameter variable">-f</span> temp-values.yaml

<span class="token comment"># 清理文件</span>
<span class="token function">rm</span> temp-values.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="5-3-完全卸载"><a href="#5-3-完全卸载" class="headerlink" title="5.3. 完全卸载"></a>5.3. 完全卸载</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 卸载Helm部署</span>
helm uninstall prometheus-mysql-exporter <span class="token parameter variable">-n</span> monitoring

<span class="token comment"># 清理相关Secret（如果需要）</span>
kubectl delete secret prometheus-mysql-exporter <span class="token parameter variable">-n</span> monitoring<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="六、监控指标说明"><a href="#六、监控指标说明" class="headerlink" title="六、监控指标说明"></a>六、监控指标说明</h1><h2 id="6-1-核心MySQL指标"><a href="#6-1-核心MySQL指标" class="headerlink" title="6.1. 核心MySQL指标"></a>6.1. 核心MySQL指标</h2><div class="note info no-icon flat"><p><strong>连接指标</strong>：</p>
<ul>
<li><code>mysql_global_status_threads_connected</code>：当前连接数</li>
<li><code>mysql_global_status_threads_running</code>：活跃连接数</li>
<li><code>mysql_global_status_max_used_connections</code>：历史最大连接数</li>
</ul>
<p><strong>性能指标</strong>：</p>
<ul>
<li><code>mysql_global_status_queries</code>：查询总数</li>
<li><code>mysql_global_status_slow_queries</code>：慢查询数量</li>
<li><code>mysql_global_status_innodb_buffer_pool_reads</code>：缓冲池读取次数</li>
</ul>
<p><strong>复制指标</strong>：</p>
<ul>
<li><code>mysql_slave_lag_seconds</code>：主从延迟时间</li>
<li><code>mysql_slave_sql_running</code>：SQL线程运行状态</li>
<li><code>mysql_slave_io_running</code>：IO线程运行状态</li>
</ul>
</div>

<h2 id="6-2-告警规则配置"><a href="#6-2-告警规则配置" class="headerlink" title="6.2. 告警规则配置"></a>6.2. 告警规则配置</h2><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">groups</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql_alerts
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> MySQLDown
    <span class="token key atrule">expr</span><span class="token punctuation">:</span> mysql_up == 0
    <span class="token key atrule">for</span><span class="token punctuation">:</span> 1m
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">severity</span><span class="token punctuation">:</span> critical
    <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
      <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">"MySQL实例不可用"</span>
      <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; $labels.instance &#125;&#125; MySQL实例已下线"</span>
      
  <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> MySQLSlaveLag
    <span class="token key atrule">expr</span><span class="token punctuation">:</span> mysql_slave_lag_seconds <span class="token punctuation">></span> 300
    <span class="token key atrule">for</span><span class="token punctuation">:</span> 2m
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">severity</span><span class="token punctuation">:</span> warning
    <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
      <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">"MySQL主从延迟过高"</span>
      <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; $labels.instance &#125;&#125; 主从延迟 &#123;&#123; $value &#125;&#125; 秒"</span>
      
  <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> MySQLConnectionsHigh
    <span class="token key atrule">expr</span><span class="token punctuation">:</span> mysql_global_status_threads_connected / mysql_global_variables_max_connections <span class="token punctuation">></span> 0.8
    <span class="token key atrule">for</span><span class="token punctuation">:</span> 2m
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">severity</span><span class="token punctuation">:</span> warning
    <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
      <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">"MySQL连接数过高"</span>
      <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; $labels.instance &#125;&#125; 连接使用率超过80%"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="七、故障排查"><a href="#七、故障排查" class="headerlink" title="七、故障排查"></a>七、故障排查</h1><h2 id="7-1-常见问题"><a href="#7-1-常见问题" class="headerlink" title="7.1. 常见问题"></a>7.1. 常见问题</h2><div class="note warning no-icon flat"><p><strong>部署失败</strong>：</p>
<ul>
<li>检查Helm Chart版本兼容性</li>
<li>验证namespace是否存在</li>
<li>确认RBAC权限配置</li>
</ul>
<p><strong>连接失败</strong>：</p>
<ul>
<li>验证MySQL账号权限</li>
<li>检查网络连通性</li>
<li>确认防火墙规则</li>
</ul>
<p><strong>指标缺失</strong>：</p>
<ul>
<li>检查ServiceMonitor配置</li>
<li>验证Prometheus配置</li>
<li>查看exporter日志</li>
</ul>
</div>

<h2 id="7-2-日志排查"><a href="#7-2-日志排查" class="headerlink" title="7.2. 日志排查"></a>7.2. 日志排查</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看exporter日志</span>
kubectl logs <span class="token parameter variable">-f</span> deployment/prometheus-mysql-exporter <span class="token parameter variable">-n</span> monitoring

<span class="token comment"># 查看Prometheus日志</span>
kubectl logs <span class="token parameter variable">-f</span> prometheus-prometheus-kube-prometheus-prometheus-0 <span class="token parameter variable">-n</span> monitoring

<span class="token comment"># 检查ServiceMonitor状态</span>
kubectl describe servicemonitor prometheus-mysql-exporter <span class="token parameter variable">-n</span> monitoring<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>通过Helm部署MySQL监控方案具有以下优势：</p>
<ol>
<li><strong>简化部署</strong>：一次性配置多个MySQL实例监控</li>
<li><strong>统一管理</strong>：集中化的配置管理和版本控制</li>
<li><strong>安全存储</strong>：敏感信息通过Kubernetes Secret安全存储</li>
<li><strong>灵活扩展</strong>：支持动态添加和移除监控实例</li>
<li><strong>标准化</strong>：统一的命名规范和标签体系</li>
</ol>
<p>本方案大大降低了MySQL监控的运维复杂度，提升了监控系统的可维护性和可扩展性。</p>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><ul>
<li><a href="https://github.com/prometheus/mysqld_exporter">Prometheus MySQL Exporter</a></li>
<li><a href="https://helm.sh/docs/chart_best_practices/">Helm Charts最佳实践</a></li>
<li><a href="https://prometheus.io/docs/guides/mysql-monitoring/">MySQL监控指标详解</a></li>
</ul>
]]></content>
      <categories>
        <category>系统监控</category>
      </categories>
      <tags>
        <tag>Prometheus</tag>
        <tag>MySQL</tag>
        <tag>Helm</tag>
        <tag>数据库监控</tag>
      </tags>
  </entry>
  <entry>
    <title>Prometheus监控指标采集与图表配置</title>
    <url>/2024/04/20/prometheus/prometheus-jian-kong-zhi-biao-cai-ji-yu-tu-biao-pei-zhi/</url>
    <content><![CDATA[<h1 id="一、背景简介"><a href="#一、背景简介" class="headerlink" title="一、背景简介"></a>一、背景简介</h1><p>Prometheus由于对云原生的优秀的支持，成为各企业上云监控选型的首选，本文主要介绍Prometheus监控指标采集后图表的配置。</p>
<blockquote>
<p>Prometheus受启发于Google的Brogmon监控系统（相似的Kubernetes是从Google的Brog系统演变而来），从2012年开始由前Google工程师在Soundcloud以开源软件的形式进行研发，并且于2015年早期对外发布早期版本。2016年5月继Kubernetes之后成为第二个正式加入CNCF基金会的项目，同年6月正式发布1.0版本。2017年底发布了基于全新存储层的2.0版本，能更好地与容器平台、云平台配合。详见：<a href="https://yunlzheng.gitbook.io/prometheus-book/parti-prometheus-ji-chu/quickstart/why-monitor">Prometheus简介</a></p>
</blockquote>
<h1 id="二、监控指标数据"><a href="#二、监控指标数据" class="headerlink" title="二、监控指标数据"></a>二、监控指标数据</h1><p>Prometheus使用Pull模式主动拉取监控数据，在应用内部我们实现监控指标数据采集并暴露一个数据采集端口，在Prometheus服务侧配置监控指标采集任务进行监控数据采集（Prometheus默认15s采集一次监控数据）。</p>
<h2 id="指标数据格式"><a href="#指标数据格式" class="headerlink" title="指标数据格式"></a>指标数据格式</h2><blockquote>
<p>在spring-boot应用中，默认监控采集路径为： <code>http://172.16.1.15:31744/actuator/prometheus</code>。</p>
</blockquote>
<p>Prometheus采集到监控数据如下：</p>
<pre class="line-numbers language-none"><code class="language-none"># HELP app_url_control_item_req_metric_seconds_max  
# TYPE app_url_control_item_req_metric_seconds_max gauge
app_url_control_item_req_metric_seconds_max&#123;application&#x3D;&quot;app-biz-server&quot;,&#125; 0.0
# HELP app_url_control_item_req_metric_seconds  
# TYPE app_url_control_item_req_metric_seconds summary
app_url_control_item_req_metric_seconds_count&#123;application&#x3D;&quot;app-biz-server&quot;,&#125; 1411.0
app_url_control_item_req_metric_seconds_sum&#123;application&#x3D;&quot;app-biz-server&quot;,&#125; 4.836

# HELP app_url_control_req_metric_seconds_max  
# TYPE app_url_control_req_metric_seconds_max gauge
app_url_control_req_metric_seconds_max&#123;application&#x3D;&quot;app-biz-server&quot;,&#125; 0.001
# HELP app_url_control_req_metric_seconds  
# TYPE app_url_control_req_metric_seconds summary
app_url_control_req_metric_seconds_count&#123;application&#x3D;&quot;app-biz-server&quot;,&#125; 1410.0
app_url_control_req_metric_seconds_sum&#123;application&#x3D;&quot;app-biz-server&quot;,&#125; 5.324<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在上述Prometheus采集到的监控指标数据中，有几个关键词：</p>
<ul>
<li>HELP：表示一个监控指标名称</li>
<li>TYPE：表示该监控指标的类型</li>
</ul>
<h1 id="三、监控指标类型"><a href="#三、监控指标类型" class="headerlink" title="三、监控指标类型"></a>三、监控指标类型</h1><p>Prometheus定义了4种不同的指标类型(metric type)：Counter（计数器）、Gauge（仪表盘）、Histogram（直方图）、Summary（摘要）。</p>
<h2 id="Counter：只增不减的计数器"><a href="#Counter：只增不减的计数器" class="headerlink" title="Counter：只增不减的计数器"></a>Counter：只增不减的计数器</h2><p>Counter类型的指标其工作方式和计数器一样，只增不减（除非系统发生重置）。常见的监控指标，如http_requests_total，node_cpu都是Counter类型的监控指标。 一般在定义Counter类型指标的名称时推荐使用_total作为后缀。</p>
<p>Counter是一个简单但有强大的工具，例如我们可以在应用程序中记录某些事件发生的次数，通过以时序的形式存储这些数据，我们可以轻松的了解该事件产生速率的变化。 PromQL内置的聚合操作和函数可以让用户对这些数据进行进一步的分析：</p>
<p>例如，通过rate()函数获取HTTP请求量的增长率：</p>
<pre class="line-numbers language-none"><code class="language-none">rate(http_requests_total[5m])<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>查询当前系统中，访问量前10的HTTP地址：</p>
<pre class="line-numbers language-none"><code class="language-none">topk(10, http_requests_total)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="Gauge：可增可减的仪表盘"><a href="#Gauge：可增可减的仪表盘" class="headerlink" title="Gauge：可增可减的仪表盘"></a>Gauge：可增可减的仪表盘</h2><p>与Counter不同，Gauge类型的指标侧重于反应系统的当前状态。因此这类指标的样本数据可增可减。常见指标如：node_memory_MemFree（主机当前空闲的内容大小）、node_memory_MemAvailable（可用内存大小）都是Gauge类型的监控指标。</p>
<p>通过Gauge指标，用户可以直接查看系统的当前状态：</p>
<pre class="line-numbers language-none"><code class="language-none">node_memory_MemFree<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>对于Gauge类型的监控指标，通过PromQL内置函数delta()可以获取样本在一段时间返回内的变化情况。例如，计算CPU温度在两个小时内的差异：</p>
<pre class="line-numbers language-none"><code class="language-none">delta(cpu_temp_celsius&#123;host&#x3D;&quot;zeus&quot;&#125;[2h])<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>还可以使用deriv()计算样本的线性回归模型，甚至是直接使用predict_linear()对数据的变化趋势进行预测。例如，预测系统磁盘空间在4个小时之后的剩余情况：</p>
<pre class="line-numbers language-none"><code class="language-none">predict_linear(node_filesystem_free&#123;job&#x3D;&quot;node&quot;&#125;[1h], 4 * 3600)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="使用Histogram和Summary分析数据分布情况"><a href="#使用Histogram和Summary分析数据分布情况" class="headerlink" title="使用Histogram和Summary分析数据分布情况"></a>使用Histogram和Summary分析数据分布情况</h2><blockquote>
<p>官方文档： <a href="https://prometheus.io/docs/practices/histograms/#count-and-sum-of-observations">Histogram and Summary</a></p>
</blockquote>
<p>除了Counter和Gauge类型的监控指标以外，Prometheus还定义了Histogram和Summary的指标类型。Histogram和Summary主用用于统计和分析样本的分布情况。</p>
<p>在大多数情况下人们都倾向于使用某些量化指标的平均值，例如CPU的平均使用率、页面的平均响应时间。这种方式的问题很明显，以系统API调用的平均响应时间为例：如果大多数API请求都维持在100ms的响应时间范围内，而个别请求的响应时间需要5s，那么就会导致某些WEB页面的响应时间落到中位数的情况，而这种现象被称为长尾问题。</p>
<p>为了区分是平均的慢还是长尾的慢，最简单的方式就是按照请求延迟的范围进行分组。例如，统计延迟在0<del>10ms之间的请求数有多少而10</del>20ms之间的请求数又有多少。通过这种方式可以快速分析系统慢的原因。Histogram和Summary都是为了能够解决这样问题的存在，通过Histogram和Summary类型的监控指标，我们可以快速了解监控样本的分布情况。</p>
<p>例如，指标prometheus_tsdb_wal_fsync_duration_seconds的指标类型为Summary。 它记录了Prometheus Server中wal_fsync处理的处理时间，通过访问Prometheus Server的&#x2F;metrics地址，可以获取到以下监控样本数据：</p>
<pre class="line-numbers language-none"><code class="language-none"># HELP prometheus_tsdb_wal_fsync_duration_seconds Duration of WAL fsync.
# TYPE prometheus_tsdb_wal_fsync_duration_seconds summary
prometheus_tsdb_wal_fsync_duration_seconds&#123;quantile&#x3D;&quot;0.5&quot;&#125; 0.012352463
prometheus_tsdb_wal_fsync_duration_seconds&#123;quantile&#x3D;&quot;0.9&quot;&#125; 0.014458005
prometheus_tsdb_wal_fsync_duration_seconds&#123;quantile&#x3D;&quot;0.99&quot;&#125; 0.017316173
prometheus_tsdb_wal_fsync_duration_seconds_sum 2.888716127000002
prometheus_tsdb_wal_fsync_duration_seconds_count 216<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从上面的样本中可以得知当前Prometheus Server进行wal_fsync操作的总次数为216次，耗时2.888716127000002s。其中中位数（quantile&#x3D;0.5）的耗时为0.012352463，9分位数（quantile&#x3D;0.9）的耗时为0.014458005s。</p>
<p>在Prometheus Server自身返回的样本数据中，我们还能找到类型为Histogram的监控指标:<code>prometheus_tsdb_compaction_chunk_range_bucket</code>。</p>
<pre class="line-numbers language-none"><code class="language-none"># HELP prometheus_tsdb_compaction_chunk_range Final time range of chunks on their first compaction
# TYPE prometheus_tsdb_compaction_chunk_range histogram
prometheus_tsdb_compaction_chunk_range_bucket&#123;le&#x3D;&quot;100&quot;&#125; 0
prometheus_tsdb_compaction_chunk_range_bucket&#123;le&#x3D;&quot;400&quot;&#125; 0
prometheus_tsdb_compaction_chunk_range_bucket&#123;le&#x3D;&quot;1600&quot;&#125; 0
prometheus_tsdb_compaction_chunk_range_bucket&#123;le&#x3D;&quot;6400&quot;&#125; 0
prometheus_tsdb_compaction_chunk_range_bucket&#123;le&#x3D;&quot;25600&quot;&#125; 0
prometheus_tsdb_compaction_chunk_range_bucket&#123;le&#x3D;&quot;102400&quot;&#125; 0
prometheus_tsdb_compaction_chunk_range_bucket&#123;le&#x3D;&quot;409600&quot;&#125; 0
prometheus_tsdb_compaction_chunk_range_bucket&#123;le&#x3D;&quot;1.6384e+06&quot;&#125; 260
prometheus_tsdb_compaction_chunk_range_bucket&#123;le&#x3D;&quot;6.5536e+06&quot;&#125; 780
prometheus_tsdb_compaction_chunk_range_bucket&#123;le&#x3D;&quot;2.62144e+07&quot;&#125; 780
prometheus_tsdb_compaction_chunk_range_bucket&#123;le&#x3D;&quot;+Inf&quot;&#125; 780
prometheus_tsdb_compaction_chunk_range_sum 1.1540798e+09
prometheus_tsdb_compaction_chunk_range_count 780<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>与Summary类型的指标相似之处在于Histogram类型的样本同样会反应当前指标的记录的总数(以_count作为后缀)以及其值的总量（以_sum作为后缀）。不同在于Histogram指标直接反应了在不同区间内样本的个数，区间通过标签len进行定义。</p>
<p>同时对于Histogram的指标，我们还可以通过histogram_quantile()函数计算出其值的分位数。不同在于Histogram通过histogram_quantile函数是在服务器端计算的分位数。 而Sumamry的分位数则是直接在客户端计算完成。因此对于分位数的计算而言，Summary在通过PromQL进行查询时有更好的性能表现，而Histogram则会消耗更多的资源。反之对于客户端而言Histogram消耗的资源更少。在选择这两种方式时用户应该按照自己的实际场景进行选择。</p>
<h1 id="四、监控图表配置"><a href="#四、监控图表配置" class="headerlink" title="四、监控图表配置"></a>四、监控图表配置</h1><p>在Prometheus配件监控指标数据采集任务后，我们需要通过PromQL语言实现监控数据查询，将查询结果显示Grafana图表或进行告警，本文主要讲述对常见类型的监控指标的图表配置。</p>
<blockquote>
<p>PromQL的学习可以参考下面文档：<a href="https://yunlzheng.gitbook.io/prometheus-book/parti-prometheus-ji-chu/promql">探索PromQL</a>。</p>
</blockquote>
<h2 id="Counter指标"><a href="#Counter指标" class="headerlink" title="Counter指标"></a>Counter指标</h2><p>由于counter类型的指标是一个只增不减的计数器，所以如果直接在Grafana的监控图表展示该指标非常不直观，所以对于counter类型的指标需要用到PromQL的几个常用内置函数：<code>rate</code> 和 <code>irate</code>。</p>
<p><code>increase(v range-vector)</code>函数是PromQL中提供的众多内置函数之一。其中参数v是一个区间向量，increase函数获取区间向量中的第一个后最后一个样本并返回其增长量。因此，可以通过以下表达式Counter类型指标的增长率：</p>
<pre class="line-numbers language-none"><code class="language-none">increase(node_cpu[2m]) &#x2F; 120<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这里通过node_cpu[2m]获取时间序列最近两分钟的所有样本，increase计算出最近两分钟的增长量，最后除以时间120秒得到node_cpu样本在最近两分钟的平均增长率。并且这个值也近似于主机节点最近两分钟内的平均CPU使用率。</p>
<p>除了使用increase函数以外，PromQL中还直接内置了<code>rate(v range-vector)</code>函数，rate函数可以直接计算区间向量v在时间窗口内平均增长速率。因此，通过以下表达式可以得到与increase函数相同的结果：</p>
<pre class="line-numbers language-none"><code class="language-none">rate(node_cpu[2m])<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>需要注意的是使用rate或者increase函数去计算样本的平均增长速率，容易陷入“长尾问题”当中，其无法反应在时间窗口内样本数据的突发变化。 例如，对于主机而言在2分钟的时间窗口内，可能在某一个由于访问量或者其它问题导致CPU占用100%的情况，但是通过计算在时间窗口内的平均增长率却无法反应出该问题。</p>
<p>为了解决该问题，PromQL提供了另外一个灵敏度更高的函数<code>irate(v range-vector)</code>。irate同样用于计算区间向量的计算率，但是其反应出的是瞬时增长率。irate函数是通过区间向量中最后两个样本数据来计算区间向量的增长速率。这种方式可以避免在时间窗口范围内的“长尾问题”，并且体现出更好的灵敏度，通过irate函数绘制的图标能够更好的反应样本数据的瞬时变化状态。</p>
<pre class="line-numbers language-none"><code class="language-none">irate(node_cpu[2m])<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>irate函数相比于rate函数提供了更高的灵敏度，不过当需要分析长期趋势或者在告警规则中，irate的这种灵敏度反而容易造成干扰。因此在长期趋势分析或者告警中更推荐使用rate函数。</p>
<blockquote>
<p>详细内容参见：<a href="https://yunlzheng.gitbook.io/prometheus-book/parti-prometheus-ji-chu/promql/prometheus-promql-functions">PromQL内置函数</a></p>
</blockquote>
<h2 id="Gauge指标"><a href="#Gauge指标" class="headerlink" title="Gauge指标"></a>Gauge指标</h2><p>在一般情况下，系统管理员为了确保业务的持续可用运行，会针对服务器的资源设置相应的告警阈值。例如，当磁盘空间只剩512MB时向相关人员发送告警通知。 这种基于阈值的告警模式对于当资源用量是平滑增长的情况下是能够有效的工作的。 但是如果资源不是平滑变化的呢？ 比如有些某些业务增长，存储空间的增长速率提升了高几倍。这时，如果基于原有阈值去触发告警，当系统管理员接收到告警以后可能还没来得及去处理问题，系统就已经不可用了。 因此阈值通常来说不是固定的，需要定期进行调整才能保证该告警阈值能够发挥去作用。 那么还有没有更好的方法吗？</p>
<p>PromQL中内置的<code>predict_linear(v range-vector, t scalar) </code>函数可以帮助系统管理员更好的处理此类情况，predict_linear函数可以预测时间序列v在t秒后的值。它基于简单线性回归的方式，对时间窗口内的样本数据进行统计，从而可以对时间序列的变化趋势做出预测。例如，基于2小时的样本数据，来预测主机可用磁盘空间的是否在4个小时候被占满，可以使用如下表达式：</p>
<pre class="line-numbers language-none"><code class="language-none">predict_linear(node_filesystem_free&#123;job&#x3D;&quot;node&quot;&#125;[2h], 4 * 3600) &lt; 0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="Histogram指标"><a href="#Histogram指标" class="headerlink" title="Histogram指标"></a>Histogram指标</h2><p>Histogram和Summary都可以用于统计和分析数据的分布情况。区别在于Summary是直接在客户端计算了数据分布的分位数情况。而Histogram的分位数计算需要通过histogram_quantile(φ float, b instant-vector)函数进行计算。其中φ（0&lt;φ&lt;1）表示需要计算的分位数，如果需要计算中位数φ取值为0.5，以此类推即可。</p>
<p>以指标http_request_duration_seconds_bucket为例：</p>
<pre class="line-numbers language-none"><code class="language-none"># HELP http_request_duration_seconds request duration histogram
# TYPE http_request_duration_seconds histogram
http_request_duration_seconds_bucket&#123;le&#x3D;&quot;0.5&quot;&#125; 0
http_request_duration_seconds_bucket&#123;le&#x3D;&quot;1&quot;&#125; 1
http_request_duration_seconds_bucket&#123;le&#x3D;&quot;2&quot;&#125; 2
http_request_duration_seconds_bucket&#123;le&#x3D;&quot;3&quot;&#125; 3
http_request_duration_seconds_bucket&#123;le&#x3D;&quot;5&quot;&#125; 3
http_request_duration_seconds_bucket&#123;le&#x3D;&quot;+Inf&quot;&#125; 3
http_request_duration_seconds_sum 6
http_request_duration_seconds_count 3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当计算5分位数时，使用如下表达式：</p>
<pre class="line-numbers language-none"><code class="language-none">histogram_quantile(0.5, http_request_duration_seconds_bucket)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>通过对Histogram类型的监控指标，用户可以轻松获取样本数据的分布情况。同时分位数的计算，也可以非常方便的用于评判当前监控指标的服务水平。</p>
<h2 id="Summary指标"><a href="#Summary指标" class="headerlink" title="Summary指标"></a>Summary指标</h2><blockquote>
<p>Histograms and summaries both sample observations, typically request durations or response sizes. They track the number of observations and the sum of the observed values, allowing you to calculate the average of the observed values. <strong>Note that the number of observations (showing up in Prometheus as a time series with a _count suffix) is inherently a counter (as described above, it only goes up). The sum of observations (showing up as a time series with a _sum suffix) behaves like a counter, too, as long as there are no negative observations</strong>. Obviously, request durations or response sizes are never negative. In principle, however, you can use summaries and histograms to observe negative values (e.g. temperatures in centigrade). In that case, the sum of observations can go down, so you cannot apply rate() to it anymore. In those rare cases where you need to apply rate() and cannot avoid negative observations, you can use two separate summaries, one for positive and one for negative observations (the latter with inverted sign), and combine the results later with suitable PromQL expressions.</p>
</blockquote>
<p>根据上述描述，Summary类型的指标是一个复合类型指标，其中的count和sum本质上是Counter类型指标，如下：</p>
<pre class="line-numbers language-none"><code class="language-none"># HELP srcp_url_control_req_metric_seconds_max  
# TYPE srcp_url_control_req_metric_seconds_max gauge
app_url_control_req_metric_seconds_max&#123;application&#x3D;&quot;app-biz-server&quot;,&#125; 0.001
# HELP app_url_control_req_metric_seconds  
# TYPE app_url_control_req_metric_seconds summary
app_url_control_req_metric_seconds_count&#123;application&#x3D;&quot;app-biz-server&quot;,&#125; 1410.0
app_url_control_req_metric_seconds_sum&#123;application&#x3D;&quot;app-biz-server&quot;,&#125; 5.324<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面<code>srcp_url_control_req</code>指标采集了链接管控请求的请求数量、请求响应时长总和、请求响应时长最大值。则计算请求的平均响应时长表达式如下：</p>
<pre class="line-numbers language-none"><code class="language-none">irate(app_url_control_item_req_metric_seconds_sum&#123;namespace&#x3D;&quot;app-test&quot;&#125;[5m])&#x2F; irate(app_url_control_item_req_metric_seconds_count&#123;namespace&#x3D;&quot;app-test&quot;&#125;[5m])<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="rate-vs-irate"><a href="#rate-vs-irate" class="headerlink" title="rate vs irate"></a>rate vs irate</h3><p><strong>rate</strong>：计算的时候是选择指定时间范围下的第一和最后一个样本进行计算；<br><strong>irate</strong>： 过区间向量中最后两个样本数据来计算区间向量的增长速率。这种方式可以避免在时间窗口范围内的长尾问题。</p>
<p><strong>irate时间范围说明</strong>：irate使用最后两个点计算，那为什么还要指定类似于 [1m] 的时间范围呢？这个 [1m] 不是用来计算的，irate 在计算的时候会最多向前在 [1m] 范围内找点，如果超过 [1m] 没有找到数据点，这个点的计算就放弃了。</p>
<blockquote>
<p>详见文档：<a href="https://cloud.tencent.com/developer/article/1891190">PromQL查询之rate函数的使用</a></p>
</blockquote>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>本文简单介绍了Prometheus指标数据采集、指标类型及PromQL使用，读者可以根据监控指标类型编写PromQL在Grafana中进行查询配置可视化图表。</p>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a href="https://cloud.tencent.com/developer/article/1891190">PromQL查询之rate函数的使用</a><br><a href="https://wl05.github.io/tech/monitor/data-visualization/histogram/#%E6%A0%B7%E4%BE%8B">直方图 （Histogram）</a></p>
]]></content>
      <categories>
        <category>系统监控</category>
      </categories>
      <tags>
        <tag>Prometheus</tag>
        <tag>Metrics</tag>
        <tag>Grafana</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis集群监控配置-Helm部署方案</title>
    <url>/2024/12/30/prometheus/redis-ji-qun-jian-kong-pei-zhi-helm-bu-shu-fang-an/</url>
    <content><![CDATA[<h1 id="一、背景简介"><a href="#一、背景简介" class="headerlink" title="一、背景简介"></a>一、背景简介</h1><p>生产环境的Redis监控告警一直存在准确性问题，通过深入排查发现redis-exporter采集方式不正确，导致监控指标偏差和告警误报。为了解决这些问题，采用标准化的Helm部署方式来实现Redis集群监控采集。</p>
<p><img src="/2024/12/30/prometheus/redis-ji-qun-jian-kong-pei-zhi-helm-bu-shu-fang-an/Redis%E7%9B%91%E6%8E%A7%E9%87%87%E9%9B%86%E6%96%B9%E5%BC%8F%E5%AF%B9%E6%AF%94%E8%AF%B4%E6%98%8E.png" alt="Redis监控采集方式对比说明"></p>
<div class="note primary no-icon flat"><p><strong>核心解决问题</strong>：</p>
<ul>
<li>修复Redis监控指标采集不准确的问题</li>
<li>统一Redis集群监控部署方式</li>
<li>提供安全的认证信息管理</li>
<li>支持多集群的灵活配置管理</li>
</ul>
</div>

<p>本方案通过Helm部署redis-exporter实现Redis集群监控采集，确保监控数据的准确性和可靠性。</p>
<span id="more"></span>

<h1 id="二、部署文件准备"><a href="#二、部署文件准备" class="headerlink" title="二、部署文件准备"></a>二、部署文件准备</h1><h2 id="2-1-必需文件清单"><a href="#2-1-必需文件清单" class="headerlink" title="2.1. 必需文件清单"></a>2.1. 必需文件清单</h2><table>
<thead>
<tr>
<th>文件类型</th>
<th>文件名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Helm Charts</td>
<td><code>prometheus-redis-exporter-6.9.0.tgz</code></td>
<td>prometheus-redis-exporter chart部署包</td>
</tr>
<tr>
<td>配置文件</td>
<td><code>redis-exporter-values.yaml</code></td>
<td>redis-exporter配置文件</td>
</tr>
</tbody></table>
<div class="note info no-icon flat"><p><strong>版本说明</strong>：</p>
<ul>
<li>推荐使用prometheus-redis-exporter 6.9.0或更新版本</li>
<li>Chart包包含了完整的Kubernetes资源定义</li>
<li>values.yaml文件支持集群多节点配置</li>
</ul>
</div>

<h2 id="2-2-环境要求"><a href="#2-2-环境要求" class="headerlink" title="2.2. 环境要求"></a>2.2. 环境要求</h2><ul>
<li>Kubernetes集群环境</li>
<li>Helm 3.x已安装配置</li>
<li>Prometheus Operator已部署</li>
<li>Redis集群已正常运行</li>
<li>具备集群管理权限</li>
</ul>
<h1 id="三、配置步骤"><a href="#三、配置步骤" class="headerlink" title="三、配置步骤"></a>三、配置步骤</h1><h2 id="3-1-Redis密钥创建"><a href="#3-1-Redis密钥创建" class="headerlink" title="3.1. Redis密钥创建"></a>3.1. Redis密钥创建</h2><p>Redis密钥用于安全存储Redis集群的认证信息，避免明文密码泄露。</p>
<h3 id="（1）创建Secret命令"><a href="#（1）创建Secret命令" class="headerlink" title="（1）创建Secret命令"></a>（1）创建Secret命令</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl create secret generic app-redis-cluster-secret <span class="token punctuation">\</span>
  --from-literal<span class="token operator">=</span>redis-password<span class="token operator">=</span><span class="token string">'your-redis-password'</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-n</span> monitoring<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="（2）参数说明"><a href="#（2）参数说明" class="headerlink" title="（2）参数说明"></a>（2）参数说明</h3><table>
<thead>
<tr>
<th>参数</th>
<th>示例值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Secret名称</td>
<td><code>app-redis-cluster-secret</code></td>
<td>Redis密钥标识名称</td>
</tr>
<tr>
<td>密码键名</td>
<td><code>redis-password</code></td>
<td>密码在Secret中的键名</td>
</tr>
<tr>
<td>密码值</td>
<td><code>your-redis-password</code></td>
<td>Redis集群实际密码</td>
</tr>
<tr>
<td>命名空间</td>
<td><code>monitoring</code></td>
<td>Secret存储的命名空间</td>
</tr>
</tbody></table>
<div class="note warning no-icon flat"><p><strong>安全配置要点</strong>：</p>
<ul>
<li>将示例中的密钥名称和密码替换为生产环境的实际值</li>
<li>密码应符合强密码策略要求</li>
<li>Secret创建后可通过<code>kubectl get secret</code>验证</li>
<li>定期轮换Redis密码并更新Secret</li>
</ul>
</div>

<h3 id="（3）验证Secret创建"><a href="#（3）验证Secret创建" class="headerlink" title="（3）验证Secret创建"></a>（3）验证Secret创建</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 检查Secret是否创建成功</span>
kubectl get secret app-redis-cluster-secret <span class="token parameter variable">-n</span> monitoring

<span class="token comment"># 查看Secret详细信息（不显示密码内容）</span>
kubectl describe secret app-redis-cluster-secret <span class="token parameter variable">-n</span> monitoring<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="3-2-配置文件修改"><a href="#3-2-配置文件修改" class="headerlink" title="3.2. 配置文件修改"></a>3.2. 配置文件修改</h2><p>修改<code>redis-exporter-values.yaml</code>配置文件中的关键配置项：</p>
<h3 id="（1）核心配置参数"><a href="#（1）核心配置参数" class="headerlink" title="（1）核心配置参数"></a>（1）核心配置参数</h3><table>
<thead>
<tr>
<th>配置项</th>
<th>示例值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>service.labels.platform</code></td>
<td><code>app-platform</code></td>
<td>平台标识，如：platform-a、platform-b、platform-c</td>
</tr>
<tr>
<td><code>serviceMonitor.targets</code></td>
<td>见下方示例</td>
<td>Redis集群所有节点配置</td>
</tr>
<tr>
<td><code>serviceMonitor.interval</code></td>
<td><code>60s</code></td>
<td>监控采集周期，建议60s</td>
</tr>
<tr>
<td><code>auth.secret.name</code></td>
<td><code>app-redis-cluster-secret</code></td>
<td>步骤3.1创建的密钥名称</td>
</tr>
</tbody></table>
<h3 id="（2）完整配置示例"><a href="#（2）完整配置示例" class="headerlink" title="（2）完整配置示例"></a>（2）完整配置示例</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">service</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9121</span>
  <span class="token key atrule">portName</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>exporter
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">platform</span><span class="token punctuation">:</span> <span class="token string">"app-platform"</span>  <span class="token comment"># 修改为对应平台标识</span>

<span class="token key atrule">serviceMonitor</span><span class="token punctuation">:</span>
  <span class="token comment"># 启用ServiceMonitor</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">multipleTarget</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">targets</span><span class="token punctuation">:</span>
    <span class="token comment"># Redis集群节点配置 - 需配置所有节点</span>
    <span class="token punctuation">-</span> <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">"172.16.1.15:6383"</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"app-redis-cluster-node-6383"</span>
    <span class="token punctuation">-</span> <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">"172.16.1.15:6384"</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"app-redis-cluster-node-6384"</span>
    <span class="token punctuation">-</span> <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">"172.16.1.15:6385"</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"app-redis-cluster-node-6385"</span>
  
  <span class="token key atrule">additionalMetricsRelabels</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
  <span class="token key atrule">additionalRelabeling</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  
  <span class="token comment"># ServiceMonitor部署命名空间</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
  
  <span class="token comment"># Prometheus采集间隔（重要配置）</span>
  <span class="token key atrule">interval</span><span class="token punctuation">:</span> 60s  <span class="token comment"># 从默认15s调整为60s</span>

<span class="token key atrule">auth</span><span class="token punctuation">:</span>
  <span class="token comment"># 启用密码认证</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token comment"># 使用已存在的Secret</span>
  <span class="token key atrule">secret</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"app-redis-cluster-secret"</span>
    <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"redis-password"</span>
  <span class="token comment"># 当不使用Secret时的密码配置（留空）</span>
  <span class="token key atrule">redisPassword</span><span class="token punctuation">:</span> <span class="token string">""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="（3）配置要点说明"><a href="#（3）配置要点说明" class="headerlink" title="（3）配置要点说明"></a>（3）配置要点说明</h3><div class="note success no-icon flat"><p><strong>targets配置规范</strong>：</p>
<ul>
<li><code>url</code>：Redis节点的IP和端口，格式为”IP:PORT”</li>
<li><code>name</code>：节点标识名称，建议格式：”平台-redis-cluster-node-端口”</li>
<li><strong>必须配置集群的所有节点</strong>，确保监控覆盖完整</li>
</ul>
<p><strong>interval调整原因</strong>：</p>
<ul>
<li>Redis-exporter使用短连接方式采集数据</li>
<li>默认15s间隔可能对Redis造成压力</li>
<li>调整为60s可减少连接频率，提升稳定性</li>
</ul>
</div>

<h2 id="3-3-平台标识配置"><a href="#3-3-平台标识配置" class="headerlink" title="3.3. 平台标识配置"></a>3.3. 平台标识配置</h2><p>根据不同的生产环境，配置相应的平台标识：</p>
<table>
<thead>
<tr>
<th>环境类型</th>
<th>platform配置值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>应用平台A</td>
<td><code>platform-a</code></td>
<td>应用平台A环境</td>
</tr>
<tr>
<td>应用平台B</td>
<td><code>platform-b</code></td>
<td>应用平台B环境</td>
</tr>
<tr>
<td>应用平台C</td>
<td><code>platform-c</code></td>
<td>应用平台C环境</td>
</tr>
<tr>
<td>数据平台</td>
<td><code>data-platform</code></td>
<td>数据平台环境</td>
</tr>
<tr>
<td>测试环境</td>
<td><code>test-env</code></td>
<td>测试环境</td>
</tr>
</tbody></table>
<h1 id="四、部署实施"><a href="#四、部署实施" class="headerlink" title="四、部署实施"></a>四、部署实施</h1><h2 id="4-1-Helm发布名称规范"><a href="#4-1-Helm发布名称规范" class="headerlink" title="4.1. Helm发布名称规范"></a>4.1. Helm发布名称规范</h2><div class="note info no-icon flat"><p><strong>命名规范</strong>：<code>平台前缀-prometheus-redis-exporter</code></p>
<p><strong>标准示例</strong>：</p>
<ul>
<li><code>platform-a-prometheus-redis-exporter</code></li>
<li><code>platform-b-prometheus-redis-exporter</code></li>
<li><code>data-platform-prometheus-redis-exporter</code></li>
<li><code>app-cluster-prometheus-redis-exporter</code></li>
<li><code>test-env-prometheus-redis-exporter</code></li>
</ul>
<p><strong>重要说明</strong>：必须保留<code>prometheus-redis-exporter</code>后缀，否则Helm会自动添加该后缀导致名称不规范。</p>
</div>

<h2 id="4-2-部署命令"><a href="#4-2-部署命令" class="headerlink" title="4.2. 部署命令"></a>4.2. 部署命令</h2><p>在具备Helm环境的生产服务器上执行部署：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 部署Redis监控</span>
helm <span class="token function">install</span> app-prometheus-redis-exporter <span class="token punctuation">\</span>
  prometheus-redis-exporter-6.9.0.tgz <span class="token punctuation">\</span>
  <span class="token parameter variable">--version</span> <span class="token number">6.9</span>.0 <span class="token punctuation">\</span>
  <span class="token parameter variable">-n</span> monitoring <span class="token punctuation">\</span>
  <span class="token parameter variable">-f</span> redis-exporter-values.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="多环境部署示例"><a href="#多环境部署示例" class="headerlink" title="多环境部署示例"></a>多环境部署示例</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 平台A环境</span>
helm <span class="token function">install</span> platform-a-prometheus-redis-exporter <span class="token punctuation">\</span>
  prometheus-redis-exporter-6.9.0.tgz <span class="token punctuation">\</span>
  <span class="token parameter variable">--version</span> <span class="token number">6.9</span>.0 <span class="token punctuation">\</span>
  <span class="token parameter variable">-n</span> monitoring <span class="token punctuation">\</span>
  <span class="token parameter variable">-f</span> platform-a-redis-exporter-values.yaml

<span class="token comment"># 平台B环境</span>
helm <span class="token function">install</span> platform-b-prometheus-redis-exporter <span class="token punctuation">\</span>
  prometheus-redis-exporter-6.9.0.tgz <span class="token punctuation">\</span>
  <span class="token parameter variable">--version</span> <span class="token number">6.9</span>.0 <span class="token punctuation">\</span>
  <span class="token parameter variable">-n</span> monitoring <span class="token punctuation">\</span>
  <span class="token parameter variable">-f</span> platform-b-redis-exporter-values.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-3-部署验证"><a href="#4-3-部署验证" class="headerlink" title="4.3. 部署验证"></a>4.3. 部署验证</h2><h3 id="（1）检查Pod状态"><a href="#（1）检查Pod状态" class="headerlink" title="（1）检查Pod状态"></a>（1）检查Pod状态</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看Redis-exporter Pod状态</span>
kubectl get pods <span class="token parameter variable">-n</span> monitoring <span class="token operator">|</span> <span class="token function">grep</span> redis-exporter

<span class="token comment"># 查看具体Pod详情</span>
kubectl describe pod <span class="token operator">&lt;</span>redis-exporter-pod-name<span class="token operator">></span> <span class="token parameter variable">-n</span> monitoring<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="（2）验证Service和ServiceMonitor"><a href="#（2）验证Service和ServiceMonitor" class="headerlink" title="（2）验证Service和ServiceMonitor"></a>（2）验证Service和ServiceMonitor</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看Service</span>
kubectl get <span class="token function">service</span> <span class="token parameter variable">-n</span> monitoring <span class="token operator">|</span> <span class="token function">grep</span> redis-exporter

<span class="token comment"># 查看ServiceMonitor</span>
kubectl get servicemonitor <span class="token parameter variable">-n</span> monitoring <span class="token operator">|</span> <span class="token function">grep</span> redis-exporter<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="（3）验证指标采集"><a href="#（3）验证指标采集" class="headerlink" title="（3）验证指标采集"></a>（3）验证指标采集</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 端口转发测试</span>
kubectl port-forward service/app-prometheus-redis-exporter <span class="token number">9121</span>:9121 <span class="token parameter variable">-n</span> monitoring

<span class="token comment"># 访问指标端点</span>
<span class="token function">curl</span> http://localhost:9121/metrics<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-4-验证Redis连接"><a href="#4-4-验证Redis连接" class="headerlink" title="4.4. 验证Redis连接"></a>4.4. 验证Redis连接</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看exporter日志</span>
kubectl logs <span class="token parameter variable">-f</span> deployment/app-prometheus-redis-exporter <span class="token parameter variable">-n</span> monitoring

<span class="token comment"># 检查是否有连接错误</span>
kubectl logs deployment/app-prometheus-redis-exporter <span class="token parameter variable">-n</span> monitoring <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-i</span> error<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="五、监控指标说明"><a href="#五、监控指标说明" class="headerlink" title="五、监控指标说明"></a>五、监控指标说明</h1><h2 id="5-1-核心Redis指标"><a href="#5-1-核心Redis指标" class="headerlink" title="5.1. 核心Redis指标"></a>5.1. 核心Redis指标</h2><div class="note info no-icon flat"><p><strong>连接指标</strong>：</p>
<ul>
<li><code>redis_connected_clients</code>：当前连接的客户端数量</li>
<li><code>redis_connected_slaves</code>：连接的从节点数量</li>
<li><code>redis_blocked_clients</code>：阻塞的客户端数量</li>
</ul>
<p><strong>内存指标</strong>：</p>
<ul>
<li><code>redis_memory_used_bytes</code>：Redis使用的内存字节数</li>
<li><code>redis_memory_max_bytes</code>：Redis最大可用内存</li>
<li><code>redis_memory_fragmentation_ratio</code>：内存碎片率</li>
</ul>
<p><strong>性能指标</strong>：</p>
<ul>
<li><code>redis_total_commands_processed</code>：总命令处理数</li>
<li><code>redis_instantaneous_ops_per_sec</code>：每秒操作数</li>
<li><code>redis_keyspace_hits_total</code>：键空间命中次数</li>
<li><code>redis_keyspace_misses_total</code>：键空间未命中次数</li>
</ul>
<p><strong>集群指标</strong>：</p>
<ul>
<li><code>redis_cluster_enabled</code>：集群模式状态</li>
<li><code>redis_cluster_slots_assigned</code>：分配的集群槽位数</li>
<li><code>redis_cluster_slots_ok</code>：正常的集群槽位数</li>
</ul>
</div>

<h2 id="5-2-告警规则配置"><a href="#5-2-告警规则配置" class="headerlink" title="5.2. 告警规则配置"></a>5.2. 告警规则配置</h2><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">groups</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> redis_alerts
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> RedisDown
    <span class="token key atrule">expr</span><span class="token punctuation">:</span> redis_up == 0
    <span class="token key atrule">for</span><span class="token punctuation">:</span> 1m
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">severity</span><span class="token punctuation">:</span> critical
    <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
      <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">"Redis实例不可用"</span>
      <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; $labels.instance &#125;&#125; Redis实例已下线"</span>
      
  <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> RedisMemoryHigh
    <span class="token key atrule">expr</span><span class="token punctuation">:</span> redis_memory_used_bytes / redis_memory_max_bytes <span class="token punctuation">></span> 0.9
    <span class="token key atrule">for</span><span class="token punctuation">:</span> 2m
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">severity</span><span class="token punctuation">:</span> warning
    <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
      <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">"Redis内存使用率过高"</span>
      <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; $labels.instance &#125;&#125; 内存使用率超过90%"</span>
      
  <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> RedisConnectionsHigh
    <span class="token key atrule">expr</span><span class="token punctuation">:</span> redis_connected_clients <span class="token punctuation">></span> 1000
    <span class="token key atrule">for</span><span class="token punctuation">:</span> 2m
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">severity</span><span class="token punctuation">:</span> warning
    <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
      <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">"Redis连接数过高"</span>
      <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; $labels.instance &#125;&#125; 连接数超过1000"</span>
      
  <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> RedisClusterSlotsMissing
    <span class="token key atrule">expr</span><span class="token punctuation">:</span> redis_cluster_slots_assigned &lt; redis_cluster_slots_ok
    <span class="token key atrule">for</span><span class="token punctuation">:</span> 1m
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">severity</span><span class="token punctuation">:</span> critical
    <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
      <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">"Redis集群槽位异常"</span>
      <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; $labels.instance &#125;&#125; 集群槽位分配异常"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="六、Grafana监控配置"><a href="#六、Grafana监控配置" class="headerlink" title="六、Grafana监控配置"></a>六、Grafana监控配置</h1><h2 id="6-1-官方Dashboard"><a href="#6-1-官方Dashboard" class="headerlink" title="6.1. 官方Dashboard"></a>6.1. 官方Dashboard</h2><p>Redis-exporter提供了官方的Grafana Dashboard配置：</p>
<div class="note success no-icon flat"><p><strong>Dashboard地址</strong>：<br><a href="https://github.com/oliver006/redis_exporter/blob/master/contrib/grafana_prometheus_redis_dashboard.json">https://github.com/oliver006/redis_exporter/blob/master/contrib/grafana_prometheus_redis_dashboard.json</a></p>
<p><strong>使用方法</strong>：</p>
<ol>
<li>下载JSON配置文件</li>
<li>在Grafana中导入Dashboard</li>
<li>配置数据源为对应的Prometheus</li>
<li>根据实际标签调整查询条件</li>
</ol>
</div>

<h2 id="6-2-自定义监控面板"><a href="#6-2-自定义监控面板" class="headerlink" title="6.2. 自定义监控面板"></a>6.2. 自定义监控面板</h2><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"dashboard"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Redis集群监控"</span><span class="token punctuation">,</span>
    <span class="token property">"panels"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">&#123;</span>
        <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Redis连接数"</span><span class="token punctuation">,</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"graph"</span><span class="token punctuation">,</span>
        <span class="token property">"targets"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">&#123;</span>
            <span class="token property">"expr"</span><span class="token operator">:</span> <span class="token string">"redis_connected_clients&#123;platform=\"$platform\"&#125;"</span><span class="token punctuation">,</span>
            <span class="token property">"legendFormat"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;instance&#125;&#125; - 连接数"</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span>
        <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"内存使用率"</span><span class="token punctuation">,</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"graph"</span><span class="token punctuation">,</span>
        <span class="token property">"targets"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">&#123;</span>
            <span class="token property">"expr"</span><span class="token operator">:</span> <span class="token string">"redis_memory_used_bytes&#123;platform=\"$platform\"&#125; / redis_memory_max_bytes&#123;platform=\"$platform\"&#125; * 100"</span><span class="token punctuation">,</span>
            <span class="token property">"legendFormat"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;instance&#125;&#125; - 内存使用率%"</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="七、配置管理"><a href="#七、配置管理" class="headerlink" title="七、配置管理"></a>七、配置管理</h1><h2 id="7-1-添加新的Redis节点"><a href="#7-1-添加新的Redis节点" class="headerlink" title="7.1. 添加新的Redis节点"></a>7.1. 添加新的Redis节点</h2><h3 id="（1）更新配置文件"><a href="#（1）更新配置文件" class="headerlink" title="（1）更新配置文件"></a>（1）更新配置文件</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 获取当前配置</span>
helm get values app-prometheus-redis-exporter <span class="token parameter variable">-n</span> monitoring <span class="token operator">></span> current-values.yaml

<span class="token comment"># 编辑配置添加新节点</span>
<span class="token function">vim</span> current-values.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="（2）在targets中添加新节点"><a href="#（2）在targets中添加新节点" class="headerlink" title="（2）在targets中添加新节点"></a>（2）在targets中添加新节点</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">targets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">"172.16.1.15:6386"</span>  <span class="token comment"># 新节点</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"app-redis-cluster-node-6386"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="（3）更新部署"><a href="#（3）更新部署" class="headerlink" title="（3）更新部署"></a>（3）更新部署</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 更新Helm部署</span>
helm upgrade app-prometheus-redis-exporter <span class="token punctuation">\</span>
  prometheus-redis-exporter-6.9.0.tgz <span class="token punctuation">\</span>
  <span class="token parameter variable">--version</span> <span class="token number">6.9</span>.0 <span class="token punctuation">\</span>
  <span class="token parameter variable">-n</span> monitoring <span class="token punctuation">\</span>
  <span class="token parameter variable">-f</span> current-values.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="7-2-修改监控间隔"><a href="#7-2-修改监控间隔" class="headerlink" title="7.2. 修改监控间隔"></a>7.2. 修改监控间隔</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 修改interval配置</span>
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s/interval: 60s/interval: 30s/g'</span> current-values.yaml

<span class="token comment"># 应用更新</span>
helm upgrade app-prometheus-redis-exporter <span class="token punctuation">\</span>
  prometheus-redis-exporter-6.9.0.tgz <span class="token punctuation">\</span>
  <span class="token parameter variable">--version</span> <span class="token number">6.9</span>.0 <span class="token punctuation">\</span>
  <span class="token parameter variable">-n</span> monitoring <span class="token punctuation">\</span>
  <span class="token parameter variable">-f</span> current-values.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="7-3-完全卸载"><a href="#7-3-完全卸载" class="headerlink" title="7.3. 完全卸载"></a>7.3. 完全卸载</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 卸载Helm部署</span>
helm uninstall app-prometheus-redis-exporter <span class="token parameter variable">-n</span> monitoring

<span class="token comment"># 清理Secret（如果需要）</span>
kubectl delete secret app-redis-cluster-secret <span class="token parameter variable">-n</span> monitoring<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="八、故障排查"><a href="#八、故障排查" class="headerlink" title="八、故障排查"></a>八、故障排查</h1><h2 id="8-1-常见问题"><a href="#8-1-常见问题" class="headerlink" title="8.1. 常见问题"></a>8.1. 常见问题</h2><div class="note warning no-icon flat"><p><strong>部署失败</strong>：</p>
<ul>
<li>检查Secret是否正确创建</li>
<li>验证Redis集群连通性</li>
<li>确认Helm Chart版本兼容性</li>
</ul>
<p><strong>连接失败</strong>：</p>
<ul>
<li>验证Redis密码正确性</li>
<li>检查网络连通性和防火墙</li>
<li>确认Redis配置允许外部连接</li>
</ul>
<p><strong>指标缺失</strong>：</p>
<ul>
<li>检查ServiceMonitor配置</li>
<li>验证targets配置正确性</li>
<li>查看exporter日志错误信息</li>
</ul>
</div>

<h2 id="8-2-日志排查"><a href="#8-2-日志排查" class="headerlink" title="8.2. 日志排查"></a>8.2. 日志排查</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看exporter日志</span>
kubectl logs <span class="token parameter variable">-f</span> deployment/app-prometheus-redis-exporter <span class="token parameter variable">-n</span> monitoring

<span class="token comment"># 查看最近的错误日志</span>
kubectl logs deployment/app-prometheus-redis-exporter <span class="token parameter variable">-n</span> monitoring <span class="token parameter variable">--tail</span><span class="token operator">=</span><span class="token number">100</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-i</span> error

<span class="token comment"># 检查ServiceMonitor状态</span>
kubectl describe servicemonitor app-prometheus-redis-exporter <span class="token parameter variable">-n</span> monitoring<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="8-3-连接测试"><a href="#8-3-连接测试" class="headerlink" title="8.3. 连接测试"></a>8.3. 连接测试</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 测试Redis连接</span>
redis-cli <span class="token parameter variable">-h</span> <span class="token number">172.16</span>.1.15 <span class="token parameter variable">-p</span> <span class="token number">6383</span> <span class="token parameter variable">-a</span> your-password <span class="token function">ping</span>

<span class="token comment"># 检查集群状态</span>
redis-cli <span class="token parameter variable">-h</span> <span class="token number">172.16</span>.1.15 <span class="token parameter variable">-p</span> <span class="token number">6383</span> <span class="token parameter variable">-a</span> your-password cluster nodes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>通过Helm部署Redis集群监控方案解决了以下关键问题：</p>
<ol>
<li><strong>准确性提升</strong>：修复了原有采集方式的问题，确保监控数据准确性</li>
<li><strong>标准化部署</strong>：统一的Helm Chart管理，简化部署和维护流程</li>
<li><strong>安全管理</strong>：通过Kubernetes Secret安全存储认证信息</li>
<li><strong>灵活配置</strong>：支持多集群、多节点的灵活配置管理</li>
<li><strong>性能优化</strong>：合理的采集间隔配置，降低对Redis的影响</li>
</ol>
<p>本方案为Redis集群监控提供了可靠的基础设施，确保了生产环境监控的准确性和稳定性。</p>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><ul>
<li><a href="https://github.com/oliver006/redis_exporter">Redis Exporter官方文档</a></li>
<li><a href="https://prometheus.io/docs/guides/redis-monitoring/">Prometheus Redis监控最佳实践</a></li>
<li><a href="https://helm.sh/docs/chart_best_practices/">Helm Charts最佳实践</a></li>
</ul>
]]></content>
      <categories>
        <category>系统监控</category>
      </categories>
      <tags>
        <tag>Prometheus</tag>
        <tag>Redis</tag>
        <tag>Helm</tag>
        <tag>集群监控</tag>
      </tags>
  </entry>
  <entry>
    <title>生产应用日志监控告警方案</title>
    <url>/2024/12/30/prometheus/sheng-chan-ying-yong-ri-zhi-jian-kong-gao-jing-fang-an/</url>
    <content><![CDATA[<h1 id="一、背景简介"><a href="#一、背景简介" class="headerlink" title="一、背景简介"></a>一、背景简介</h1><p>生产之前出现过许多业务异常的情况未能及时发现，这些异常出现时有大量的异常日志打印，但是由于缺乏日志监控，未能及时发现异常并进行处理。</p>
<p>该方案计划对生产所有的异常日志进行监控及告警配置，及时发现生产日志异常，快速响应处理。</p>
<span id="more"></span>

<h1 id="二、日志及监控采集方案"><a href="#二、日志及监控采集方案" class="headerlink" title="二、日志及监控采集方案"></a>二、日志及监控采集方案</h1><p>生产的日志采集和监控均基于Promtail组件实现，具体的原理如下：</p>
<div class="note info no-icon flat"><ol>
<li>Promtail监听日志文件变化，主动将日志数据推送到Loki服务端实现日志数据采集；</li>
<li>Promtail采集日志内容时根据配置做日志监控指标聚合运算，Prometheus主动到Promtail拉取聚合的日志监控指标；</li>
</ol>
</div>

<p><img src="/2024/12/30/prometheus/sheng-chan-ying-yong-ri-zhi-jian-kong-gao-jing-fang-an/%E5%9F%BA%E4%BA%8EPromtail%E7%9A%84%E6%97%A5%E5%BF%97%E7%9B%91%E6%8E%A7%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="基于Promtail的日志监控架构图"><br><em>图：基于Promtail的日志和日志监控采集架构</em></p>
<h2 id="2-1-日志监控两种实现方式对比"><a href="#2-1-日志监控两种实现方式对比" class="headerlink" title="2.1. 日志监控两种实现方式对比"></a>2.1. 日志监控两种实现方式对比</h2><p>日志监控两种实现方式包括：Promtail 中的 metrics 阶段和 Loki 的 ruler 组件。</p>
<div class="note primary no-icon flat"><p><strong>方案一：Promtail在日志采集时进行日志监控指标的收集</strong></p>
<ul>
<li>监控指标采集速度高、无延迟</li>
<li>告警规则使用Prometheus的告警规则即可</li>
<li>需要在Promtail侧配置日志告警指标</li>
</ul>
</div>

<div class="note warning no-icon flat"><p><strong>方案二：Loki的Ruler组件定时根据配置查询</strong></p>
<ul>
<li>根据配置的告警规则触发告警</li>
<li>存在日志采集延迟、海量日志查询性能差等问题</li>
<li>告警规则需要在Loki侧独立配置管理</li>
</ul>
</div>

<p><img src="/2024/12/30/prometheus/sheng-chan-ying-yong-ri-zhi-jian-kong-gao-jing-fang-an/%E6%97%A5%E5%BF%97%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94.png" alt="日志监控方案对比"><br><em>图：Promtail的Metrics VS Loki的Rule组件对比</em></p>
<p><strong>总结</strong>：从性能和及时性综合评估，生产环境使用方案一更适合。</p>
<h1 id="三、日志采集配置"><a href="#三、日志采集配置" class="headerlink" title="三、日志采集配置"></a>三、日志采集配置</h1><p>生产环境目前所有应用均已实现基于Promtail的日志采集，但是有虚拟机和K8s容器环境两种区别。</p>
<h2 id="3-1-虚拟机日志采集配置"><a href="#3-1-虚拟机日志采集配置" class="headerlink" title="3.1. 虚拟机日志采集配置"></a>3.1. 虚拟机日志采集配置</h2><p>虚拟机进行日志采集时，上传Promtail组件到服务器，然后配置Promtail的配置文件：</p>
<p><strong>config.yaml配置示例：</strong></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment">#promtail当作一个服务端，Prometheus通过该服务抓取监控指标</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">http_listen_port</span><span class="token punctuation">:</span> <span class="token number">9080</span>
  <span class="token key atrule">grpc_listen_port</span><span class="token punctuation">:</span> <span class="token number">0</span>

<span class="token comment">#2.7.2版本增加的从新加载配置文件的配置，可以访问:http://ip:9080/reload来从新加载配置文件</span>
<span class="token key atrule">enable_runtime_reload</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token key atrule">clients</span><span class="token punctuation">:</span>
  <span class="token comment">#需要推送给的Loki服务端的地址，可以配置多个，同时朝向多个Loki推送日志</span>
  <span class="token punctuation">-</span> <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//loki.example.com<span class="token punctuation">:</span>30669/loki/api/v1/push

<span class="token key atrule">positions</span><span class="token punctuation">:</span>
  <span class="token comment">#Promtail采集到日志的时候，会把已经发送给Loki成功的日志的字节偏移量记录到这个文件当中</span>
  <span class="token key atrule">filename</span><span class="token punctuation">:</span> ./positions.yaml

<span class="token key atrule">target_config</span><span class="token punctuation">:</span>
  <span class="token comment">#这个是同步采集的target的file的监控的的时间，默认也是10s</span>
  <span class="token key atrule">sync_period</span><span class="token punctuation">:</span> 10s

<span class="token key atrule">scrape_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>system<span class="token punctuation">-</span>log
    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> localhost
        <span class="token key atrule">labels</span><span class="token punctuation">:</span>
          <span class="token key atrule">node</span><span class="token punctuation">:</span> app<span class="token punctuation">-</span>node
          <span class="token key atrule">job</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>system<span class="token punctuation">-</span>log
          <span class="token key atrule">type</span><span class="token punctuation">:</span> system
          <span class="token key atrule">__path__</span><span class="token punctuation">:</span> /var/log/syslog
  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>logs <span class="token comment">#job的名字，可以在loki上面搜索条件:job="pod-logs"</span>
    <span class="token key atrule">kubernetes_sd_configs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> pod<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-1-1-启动命令"><a href="#3-1-1-启动命令" class="headerlink" title="3.1.1. 启动命令"></a>3.1.1. 启动命令</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">nohup</span> ./promtail-linux-amd64 <span class="token parameter variable">-config.file</span><span class="token operator">=</span>./config.yaml <span class="token operator">></span> promtail.log <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>Promtail启动后会根据配置文件config.yaml中的配置的__path__路径，监听路径下文件，采集上报至Loki。</p>
<h2 id="3-2-k8s容器日志采集配置"><a href="#3-2-k8s容器日志采集配置" class="headerlink" title="3.2. k8s容器日志采集配置"></a>3.2. k8s容器日志采集配置</h2><p>在容器环境中，Promtail采用DaemonSet的部署，采集Pod中的日志信息。</p>
<div class="note info no-icon flat"><p><strong>DaemonSet简介</strong>：</p>
<ul>
<li>DaemonSet 定义了提供节点本地设施的 Pod</li>
<li>DaemonSet 确保全部（或者某些）节点上运行一个 Pod 的副本</li>
<li>当有节点加入集群时，也会为他们新增一个 Pod</li>
<li>当有节点从集群移除时，这些 Pod 也会被回收</li>
</ul>
</div>

<p><strong>DaemonSet 的典型用法：</strong></p>
<ul>
<li>在每个节点上运行集群守护进程</li>
<li>在每个节点上运行日志收集守护进程</li>
<li>在每个节点上运行监控守护进程</li>
</ul>
<p>DaemonSet中通过configMap配置Promtail的配置文件。</p>
<p><img src="/2024/12/30/prometheus/sheng-chan-ying-yong-ri-zhi-jian-kong-gao-jing-fang-an/k8s-daemonset-architecture.png" alt="K8s DaemonSet部署架构"><br><em>图：K8s环境中DaemonSet部署Promtail的架构示意</em></p>
<h1 id="四、日志监控配置"><a href="#四、日志监控配置" class="headerlink" title="四、日志监控配置"></a>四、日志监控配置</h1><p>在第三章节中，介绍了Promtail日志采集的配置，这个章节介绍如果配置日志监控。</p>
<h2 id="4-1-日志监控原理"><a href="#4-1-日志监控原理" class="headerlink" title="4.1. 日志监控原理"></a>4.1. 日志监控原理</h2><p>Promtail的日志监控基于Pipeline实现，Promtail的Pipeline其实就是用来对一行日志执行操作的流水线，由统称为stages(阶段)这个专业术语来组成的。</p>
<div class="note primary no-icon flat"><p><strong>Pipeline主要分为四种类型的stages：</strong></p>
<ol>
<li><strong>Parsing stages</strong>：解析当前的日志行，提取数据，提取的数据交给下一个stages处理</li>
<li><strong>Transform stages</strong>：转换提取的数据，从一个组映射到另外一个组</li>
<li><strong>Action stages</strong>：拿到提取的数据做处理，可以执行如下的动作：<ul>
<li>对标签执行新增&#x2F;修改&#x2F;删除</li>
<li>修改日志行的timestamp</li>
<li>修改日志的内容</li>
<li>基于提取的数据创建一个指标(我们需要的)</li>
</ul>
</li>
</ol>
</div>

<blockquote>
<p>官网地址：<a href="https://grafana.com/docs/loki/latest/send-data/promtail/stages/">https://grafana.com/docs/loki/latest/send-data/promtail/stages/</a></p>
</blockquote>
<p>日志监控主要基于Promtail Pipeline的regex和metrics两个stage：</p>
<ol>
<li><strong>regex</strong>：使用正则提取数据</li>
<li><strong>metrics</strong>：根据提取的数据监控指标</li>
</ol>
<p><img src="/2024/12/30/prometheus/sheng-chan-ying-yong-ri-zhi-jian-kong-gao-jing-fang-an/promtail-pipeline-flow.png" alt="Promtail Pipeline处理流程"><br><em>图：Promtail Pipeline的日志处理流程</em></p>
<h2 id="4-2-日志监控配置说明"><a href="#4-2-日志监控配置说明" class="headerlink" title="4.2. 日志监控配置说明"></a>4.2. 日志监控配置说明</h2><p>Promtail Pipeline各个State的变量是可以被用于下个Stage的，日志监控主要基于Regex和Metrics两个Stage配置实现。</p>
<h3 id="4-2-1-Regex-Stage配置说明"><a href="#4-2-1-Regex-Stage配置说明" class="headerlink" title="4.2.1. Regex Stage配置说明"></a>4.2.1. Regex Stage配置说明</h3><p>regex Stage主要用于从日志中提取数据，提取数据使用RE2 正则表达式。</p>
<blockquote>
<p>官网地址：<a href="https://grafana.com/docs/loki/latest/send-data/promtail/stages/regex/">https://grafana.com/docs/loki/latest/send-data/promtail/stages/regex/</a></p>
</blockquote>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">regex</span><span class="token punctuation">:</span>
  <span class="token comment"># The RE2 regular expression. Each capture group must be named.</span>
  <span class="token key atrule">expression</span><span class="token punctuation">:</span> &lt;string<span class="token punctuation">></span>
  
  <span class="token comment"># Name from extracted data to parse. If empty, uses the log message.</span>
  <span class="token punctuation">[</span><span class="token key atrule">source</span><span class="token punctuation">:</span> &lt;string<span class="token punctuation">></span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<div class="note warning no-icon flat"><p><strong>重要说明</strong>：</p>
<ul>
<li>expression 必须是 Go RE2 正则表达式字符串</li>
<li>每个捕获组必须以如下方式命名：<code>(?P&lt;name&gt;re)</code></li>
<li>捕获组的名称将用作提取映射中的键</li>
</ul>
</div>

<blockquote>
<p>RE2正则语法官方文档：<a href="https://github.com/google/re2/wiki/Syntax">https://github.com/google/re2/wiki/Syntax</a></p>
</blockquote>
<h3 id="4-2-2-Metrics-Stage配置说明"><a href="#4-2-2-Metrics-Stage配置说明" class="headerlink" title="4.2.2. Metrics Stage配置说明"></a>4.2.2. Metrics Stage配置说明</h3><p>Metrics Stage主要用于定义监控指标名称、类型、采集次数。</p>
<blockquote>
<p>官网地址：<a href="https://grafana.com/docs/loki/latest/send-data/promtail/stages/metrics/">https://grafana.com/docs/loki/latest/send-data/promtail/stages/metrics/</a></p>
</blockquote>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">metrics</span><span class="token punctuation">:</span>
  <span class="token key atrule">http_get_total</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> Counter  <span class="token comment">#Counter类型，参看Prometheus的四种指标类型</span>
    <span class="token key atrule">description</span><span class="token punctuation">:</span> &lt;string<span class="token punctuation">></span> <span class="token comment">#描述信息</span>
    <span class="token key atrule">prefix</span><span class="token punctuation">:</span> &lt;string<span class="token punctuation">></span> <span class="token comment">#指标的前缀，默认是:promtail_custom_，例如:promtail_custom_http_get_total</span>
    <span class="token key atrule">source</span><span class="token punctuation">:</span> &lt;string<span class="token punctuation">></span> <span class="token comment">#从提取数据中获取到的Key作为统计的指标来源，如果不提供，就是指标名字</span>
    <span class="token key atrule">max_idle_duration</span><span class="token punctuation">:</span> &lt;string<span class="token punctuation">></span>  <span class="token comment">#指标的存活时间，避免出现业务上的指标的积累的问题，默认是:5m</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">match_all</span><span class="token punctuation">:</span> &lt;bool<span class="token punctuation">></span> <span class="token comment">#如果设置为true，那么所有的日志行都会被统计到</span>
      <span class="token key atrule">count_entry_bytes</span><span class="token punctuation">:</span> &lt;bool<span class="token punctuation">></span> <span class="token comment">#如果设置为true，那么所有的日志行的bytes都会被统计</span>
      <span class="token key atrule">value</span><span class="token punctuation">:</span> &lt;string<span class="token punctuation">></span> <span class="token comment">#只有符合value的才会被统计，和match_all还有count_entry_bytes有一定的配置冲突</span>
      <span class="token key atrule">action</span><span class="token punctuation">:</span> &lt;string<span class="token punctuation">></span> <span class="token comment">#inc 或者 add这俩递增的意思。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-3-日志监控配置示例"><a href="#4-3-日志监控配置示例" class="headerlink" title="4.3. 日志监控配置示例"></a>4.3. 日志监控配置示例</h2><p>下面为一个日志监控指标示例，指标名为：<code>data_truncation_total</code>， 指标类型为：Counter，该指标对日志行内容包含”Data truncation”字符计数，该关键字在日志中每出现一次，指标值加1。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">http_listen_port</span><span class="token punctuation">:</span> <span class="token number">9080</span>
  <span class="token key atrule">grpc_listen_port</span><span class="token punctuation">:</span> <span class="token number">0</span>
<span class="token key atrule">enable_runtime_reload</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token key atrule">clients</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//loki.example.com<span class="token punctuation">:</span>30669/loki/api/v1/push

<span class="token key atrule">positions</span><span class="token punctuation">:</span>
  <span class="token key atrule">filename</span><span class="token punctuation">:</span> ./positions.yaml

<span class="token key atrule">target_config</span><span class="token punctuation">:</span>
  <span class="token key atrule">sync_period</span><span class="token punctuation">:</span> 10s

<span class="token key atrule">scrape_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> app<span class="token punctuation">-</span>logs
    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> localhost
        <span class="token key atrule">labels</span><span class="token punctuation">:</span>
          <span class="token key atrule">job</span><span class="token punctuation">:</span> app<span class="token punctuation">-</span>logs
          <span class="token key atrule">__path__</span><span class="token punctuation">:</span> /var/log/app/<span class="token important">*.log</span>
    <span class="token key atrule">pipeline_stages</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">regex</span><span class="token punctuation">:</span>
          <span class="token key atrule">expression</span><span class="token punctuation">:</span> <span class="token string">'.*(?P&lt;error_content>Data truncation).*'</span>
      <span class="token punctuation">-</span> <span class="token key atrule">metrics</span><span class="token punctuation">:</span>
          <span class="token key atrule">data_truncation_total</span><span class="token punctuation">:</span>
            <span class="token key atrule">type</span><span class="token punctuation">:</span> Counter
            <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"Count of data truncation errors"</span>
            <span class="token key atrule">config</span><span class="token punctuation">:</span>
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123;.error_content&#125;&#125;"</span>
              <span class="token key atrule">action</span><span class="token punctuation">:</span> inc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<div class="note success no-icon flat"><p><strong>配置说明</strong>：</p>
<ul>
<li>使用正则表达式提取包含”Data truncation”的日志行</li>
<li>定义Counter类型指标进行计数</li>
<li>每当匹配到相关错误时，指标值自动递增</li>
</ul>
</div>

<h1 id="五、告警配置"><a href="#五、告警配置" class="headerlink" title="五、告警配置"></a>五、告警配置</h1><p>基于Promtail采集的日志监控指标，可以在Prometheus中配置相应的告警规则：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">groups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> log_alerts
    <span class="token key atrule">rules</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> DataTruncationAlert
        <span class="token key atrule">expr</span><span class="token punctuation">:</span> increase(promtail_custom_data_truncation_total<span class="token punctuation">[</span>5m<span class="token punctuation">]</span>) <span class="token punctuation">></span> 0
        <span class="token key atrule">for</span><span class="token punctuation">:</span> 0m
        <span class="token key atrule">labels</span><span class="token punctuation">:</span>
          <span class="token key atrule">severity</span><span class="token punctuation">:</span> warning
        <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
          <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">"检测到数据截断错误"</span>
          <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"在过去5分钟内检测到 &#123;&#123; $value &#125;&#125; 次数据截断错误"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>本方案通过Promtail实现了生产环境日志的实时监控和告警，主要优势：</p>
<ol>
<li><strong>实时性强</strong>：基于Promtail的metrics阶段，无延迟监控</li>
<li><strong>配置灵活</strong>：支持正则表达式灵活匹配日志内容</li>
<li><strong>集成便利</strong>：与现有Prometheus监控体系无缝集成</li>
<li><strong>可扩展性</strong>：支持虚拟机和K8s两种部署方式</li>
</ol>
<p>通过该方案，可以有效提升生产环境异常发现的及时性，降低业务风险。</p>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><ul>
<li><a href="https://grafana.com/docs/loki/latest/send-data/promtail/">Promtail官方文档</a></li>
<li><a href="https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/">Prometheus告警规则</a></li>
<li><a href="https://github.com/google/re2/wiki/Syntax">RE2正则语法</a></li>
</ul>
]]></content>
      <categories>
        <category>系统监控</category>
      </categories>
      <tags>
        <tag>Prometheus</tag>
        <tag>Promtail</tag>
        <tag>Loki</tag>
        <tag>日志监控</tag>
        <tag>告警</tag>
      </tags>
  </entry>
  <entry>
    <title>怎么用“福格行为模型”战胜拖延症?</title>
    <url>/2021/09/23/reprint/zen-me-yong-fu-ge-xing-wei-mo-xing-zhan-sheng-tuo-yan-zheng/</url>
    <content><![CDATA[<blockquote>
<p>说明：本文转载自 <a href="https://www.ljsw.io/dedao/2021-01-11/AsH.html">怎么用“福格行为模型”战胜拖延症？</a></p>
</blockquote>
<p>去年年底，我们有一期节目是讨论新年该立一个什么样的flag才人间值得，当时我给你的提议是：立一个不光自己变好，也要让别人从中受益的flag。</p>
<p>老实说，设定这样一个目标并不难，难的是如何完成它。我看到一个说法很有意思，说当代人立flag的现状是“今年立的flag，就是完成去年承诺的、前年没做到的、大前年立下的flag”，你说说，这让人情何以堪啊。于是，有人干脆就不敢定目标了，怕打脸。</p>
<p>到底是什么阻碍我们完成这些目标呢？除了客观原因之外，我想最大的拦路虎就是拖延症了。我身边很多朋友都饱受拖延症的困扰，包括我自己。明明是重要的事，也制定了计划，却总是无法按时完成。更可怕的是，打脸多了，自我评价变低，还容易掉入负面情绪的旋涡。</p>
<p>要怎么打败拖延症呢？我最近在36氪的神译局栏目里看到一篇文章，很受启发。文章来自一个国外专门研究拖延症的网站，叫Deprocrastination，标题是《如何用福格行为模型治疗拖延症》（How to stop procrastinating by using the Fogg Behavior Model）。读完这篇文章之后，我突然明白了拖延症的“底层逻辑”，也对如何应对它有了清晰的思路。在今天的《邵恒头条》中，我就把我从这篇文章中得到的收获分享给你。</p>
<p>你一定注意到了，文章的标题叫“如何用福格行为模型治疗拖延症”。那什么是福格行为模型呢？这个行为模型是美国斯坦福大学的教授布莱恩·福格（Brian Fogg）提出来的，所以是以他的名字命名的。福格行为模型的主要用途，是用来解释人们为什么会做出某种行为，比如“为什么你会早起跑步？”当然，它也能用来解释人们为什么没有做出某种行为，比如“你本来计划早起跑步，今天却没去，为什么？”对于这两类问题，福格行为模型都能给出合理的解释。</p>
<p>在互联网领域，福格行为模型常被用来设计引导用户行为。你可能听说过尼尔·埃亚尔的那本著名的《上瘾：让用户养成使用习惯的四大产品逻辑》，这本书的理论基础，就是福格行为模型。</p>
<p>简单来说，福格行为模型可以用一个公式来表示：行为&#x3D;动机+能力+触发（Behavior&#x3D;Motivation+Ability+Trigger）。 </p>
<p>从这个公式中你就可以看出，人的行为背后有三大要素：一个是动机，也就是做这件事的理由或目的；一个是能力，你得有能力完成这个行为才行；还有一个是触发，也就是在某个时刻促使人们采取行动的信号。要想使人们完成特定的行为，“动机”、“能力”、“触发”这三个要素缺一不可。</p>
<p>那你可能想问，福格行为模型和拖延症又有什么关系呢？其实，福格行为模型给了我们理解和分析拖延症的一个抓手。毕竟，拖延也是一种“行为”，那么它就可以被拆解成“动机”、“能力”和“触发”三个环节。你可以把它们想象成三根“链条”，任何一根链条断了，都会导致拖延发生。</p>
<p>这么说有点抽象，我举一些具体的例子。先来说第一根断掉的链条：动机。</p>
<p>不知道你有没有发现，我们拖延的事并不是什么小事，往往还挺重要的。比如说，你要写毕业论文，这关乎到你能不能顺利毕业；你想要瘦身，因为以前的衣服已经穿不进去了；你计划新的一年在知识城邦上多做分享，将来能成为“粉丝”过万的大V。这些都是对你来说重要的事，可问题是，当你把这些事放进待办列表之后，你的动机就不再像最开始那么强烈了。</p>
<p>不信，你回忆一下，有多少次你麻木地盯着待办事项列表，却发现找不到一件让自己感到兴奋，想马上就动手去做的事？随着时间的推移，你的动机会不断地被稀释淡化。</p>
<p>那该怎么办呢？最佳的解决方案，就是重新帮自己建立动机。你可以找出一件自己一直在拖延的事，想想当初为什么要计划做这件事，让自己再一次直观地感受到这件事的价值和意义。</p>
<p>这里有一个小窍门：尽量把这件事和个人收益关联起来。比如说，做完它能让你获得什么好处？你的个人能力会提升吗？未来会因此得到更多的机会吗？这件事有可能帮助到更多人吗？别人看到你穿着好看的衣服，会向你投来钦佩或羡慕的眼光吗？想得越细致，你的动机就会越明确，也就会感到越兴奋，动力越足。</p>
<p>好，这就是从动机上应对拖延的方法。再来说第二根断掉的链条：能力。</p>
<p>如果一项任务看起来特别难，你就不愿意做了，至少不愿意马上做。你有没有这种体会，做一件困难的事情时会特别容易分心。手机一有新消息提示就恨不得马上拿起来，干一会儿活就不自觉地打开购物网站刷一刷。这是为什么呢？</p>
<p>原因就出在能力上。从能力上来说，分心比工作要简单多了。工作你要耗费很多脑细胞，但回微信你只需要拿起手机就好了。人会本能地回避困难的事情，去做简单的事情。</p>
<p>更可怕的是，研究发现，你越不常做某事，就会越觉得它难。打个比方，如果日拱一卒，你会觉得每一步都比较轻松，但要是全憋到最后，那你就会觉得自己必须要下一盘大棋，无从下手了。</p>
<p>那该怎么办呢？你得学会把工作变简单。最好的方式就是拆分任务：把大任务拆分成若干个小任务，这样就能降低整体任务的难度。</p>
<p>如果你面对的只是一个小任务，那就不会觉得那么难了。比如爬山，爬到山顶很难，但先爬到50级台阶并不难；写完一篇上万字的论文很难，但先写出三个段落并不难；一下子瘦20斤很难，但上一次跑步机，跑个半小时并不难；成为知识城邦大V很难，但发一篇读书笔记并不难。而每完成一件这样的小任务，都会带给你信心和能量，让你更愿意把剩下的任务完成。</p>
<p>同时，你还需要做一个时间表，把所有的小任务串联起来。这里有一个小技巧是：倒推。也就是说，先写好最后一天要完成的任务，然后往回倒推，依次写下每一个时间点完成的小任务，一直写到今天为止。</p>
<p>举个例子，你要做一次公众演讲，一共有10天的准备时间，那时间表就要从第10天开始列，比如：</p>
<p>第10天：完整排练三次</p>
<p>第9天：熟练背诵整篇演讲稿</p>
<p>第8天：做完PPT，和文稿对照，确定翻页的时间点</p>
<p>……</p>
<p>第3天：先写出开头</p>
<p>第2天：收集和整理所有可用素材</p>
<p>第1天：理清演讲目的，构思结构框架</p>
<p>用“倒推”的方式设计时间表，你会更合理地安排小任务，不会出现到最后几天任务量积压的情况。</p>
<p>这是从能力上应对拖延的办法。再来说第三根断掉的链条：触发。</p>
<p>有时候，我们有充分的动机，也把任务拆好了，可还有会拖延，那原因就可能出在“触发不够”上。</p>
<p>触发，是提醒我们当下马上行动的信号。比如说，你这几天要交一份报告，结果突然接到老板一条信息说“报告写完了吗？写完赶紧发给我，我等着用”。本来你还想拖一拖，结果一接到老板的这条信息，屁股一下就从沙发上弹起来了。你看，这条信息就是一个触发，它会让你立即行动起来。可是，触发也不能光靠老板啊，要战胜拖延的毛病，你要学会主动设置触发信号。</p>
<p>什么样的触发最有效呢？文章里给了一个妙招：设置连锁触发。</p>
<p>第一个触发，是用手机设置一个定时提醒，让自己在设定好的时刻在办公桌前坐下来。你可能并没想好做什么，没关系，先坐下来。</p>
<p>第二个触发，就是倒计时5分钟，在5分钟之内盯着待办事项列表，挑出一项任务来做。如果5分钟计时结束，你仍然没决定做哪项任务的话，那就随机选择一项任务，立即去做。</p>
<p>通过连锁触发，你能快速让自己投入到工作状态中。</p>
<p>还有一种触发，是增加你“看见”任务的概率。什么意思呢？举个例子，假如你要制定春节假期的旅行计划，那得提前订机票啊，是吧。为了让自己不拖延，你可以下载一张飞机图片，设成手机壁纸。这样每次你拿起手机，就会看到飞机的图片，然后就会想起要赶紧订机票——这就是一种增加看见概率的触发。</p>
<p>除此之外，你还可以反过来，用减少触发的方式来提升专注力。比如说，在工作的时候，把手机放在别的房间或者打开勿扰模式；关闭微信电脑端的新消息通知；把工作用的软件全屏，这样就看不到其他软件的图标……你看，这些做法都是减少或消除导致分心的触发。你越难分心，也就越不会分心。</p>
<p>好了，总结一下，在今天的《邵恒头条》中，我跟你分享了如何用福格行为模型来分析和治疗拖延症。按照这个模型，拖延症可以被拆分为三个因素：动机不足、能力欠缺以及触发不够。很多人会认为拖延症就是自律性不强导致的，所以每次拖延都很自责。而这篇文章的启发在于，拖延症是个系统问题，它和人固有的行为模式有着密切的关系，你没必要苛责自己。你需要做的，是聪明地调整做事的方法。</p>
<p>今后当你拖延的时候，不妨想一想，到底是动机、能力和触发哪个环节出了问题？然后对症下药，制定应对策略。欢迎你把你的思考分享在留言区。</p>
<p>好了，这就是今天的《邵恒头条》。我是邵恒，我们明天见。</p>
]]></content>
      <categories>
        <category>转载</category>
      </categories>
      <tags>
        <tag>福格行为模型</tag>
        <tag>拖延症</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis哨兵模式和集群模式</title>
    <url>/2020/12/25/redis/redis-shao-bing-mo-shi-he-ji-qun-mo-shi/</url>
    <content><![CDATA[<h1 id="一、Redis哨兵模式搭建"><a href="#一、Redis哨兵模式搭建" class="headerlink" title="一、Redis哨兵模式搭建"></a>一、Redis哨兵模式搭建</h1><h2 id="1-1-Redis-的-主从复制模式-和-Sentinel-高可用架构-的示意图"><a href="#1-1-Redis-的-主从复制模式-和-Sentinel-高可用架构-的示意图" class="headerlink" title="1.1 Redis 的 主从复制模式 和 Sentinel 高可用架构 的示意图"></a>1.1 Redis 的 主从复制模式 和 Sentinel 高可用架构 的示意图</h2><p><img src="/2020/12/25/redis/redis-shao-bing-mo-shi-he-ji-qun-mo-shi/redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8F%8Asentinel%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9E%B6%E6%9E%84%E5%9B%BE.jpg" alt="redis主从复制及sentinel高可用架构图"></p>
<h2 id="1-2-基于Docker换件搭建Redis哨兵模式"><a href="#1-2-基于Docker换件搭建Redis哨兵模式" class="headerlink" title="1.2 基于Docker换件搭建Redis哨兵模式"></a>1.2 基于Docker换件搭建Redis哨兵模式</h2><p>本次搭建Redis哨兵模式仅为测试使用，且因资源有限，在一台云主机上安装docker引擎，通过docker容器搭建哨兵模式。</p>
<h3 id="1-2-1-安装环境"><a href="#1-2-1-安装环境" class="headerlink" title="1.2.1 安装环境"></a>1.2.1 安装环境</h3><p>云主机配置：1核2G</p>
<p>所需软件及环境：docker， docker-compose， redis镜像</p>
<h3 id="1-2-2-Redis主从复制"><a href="#1-2-2-Redis主从复制" class="headerlink" title="1.2.2 Redis主从复制"></a>1.2.2 Redis主从复制</h3><p>创建docker-compose.yml配置文件：</p>
<blockquote>
<p>docker-compose.yml</p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">version: &#39;3&#39;
services:
  master:
    image: redis
    container_name: redis-master
    command: redis-server --requirepass redis_hyk  --masterauth redis_hyk
    ports:
      - 6379:6379
  slave1:
    image: redis
    container_name: redis-slave-1
    ports:
      - 6380:6379
    command:  redis-server --slaveof 172.16.16.37 6379 --requirepass redis_hyk --masterauth redis_hyk --replica-announce-ip 172.16.16.37 --replica-announce-port 6380
  slave2:
    image: redis
    container_name: redis-slave-2
    ports:
      - 6381:6379
    command: redis-server --slaveof 172.16.16.37 6379 --requirepass redis_hyk --masterauth redis_hyk --replica-announce-ip 172.16.16.37 --replica-announce-port 6381<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>注意：使用dockers容器配置主从时，slave节点默认使用的时容器内部的ip，会导致在容器外部无法访问，可以通过以下配置指定ip及端口<br>详情参考：<a href="https://redis.io/topics/replication">Redis官网 Replication</a><br>replica-announce-ip 172.16.16.37<br>replica-announce-port 6380</p>
</blockquote>
<p>执行docker-compose up -d 启动容器。</p>
<h3 id="1-2-3-Redis-Sentinel"><a href="#1-2-3-Redis-Sentinel" class="headerlink" title="1.2.3 Redis Sentinel"></a>1.2.3 Redis Sentinel</h3><p>创建docker-compose.yml配置文件：</p>
<blockquote>
<p>docker-compose.yml</p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">version: &#39;3&#39;
services:
  sentinel1:
    image: redis
    container_name: redis-sentinel-1
    ports:
      - 26379:26379
    command: redis-sentinel &#x2F;usr&#x2F;local&#x2F;etc&#x2F;redis&#x2F;sentinel.conf
    volumes:
      - .&#x2F;sentinel1.conf:&#x2F;usr&#x2F;local&#x2F;etc&#x2F;redis&#x2F;sentinel.conf
      - .&#x2F;26379&#x2F;:&#x2F;usr&#x2F;local&#x2F;etc&#x2F;redis&#x2F;
  sentinel2:
    image: redis
    container_name: redis-sentinel-2
    ports:
    - 26380:26379
    command: redis-sentinel &#x2F;usr&#x2F;local&#x2F;etc&#x2F;redis&#x2F;sentinel.conf
    volumes:
      - .&#x2F;sentinel2.conf:&#x2F;usr&#x2F;local&#x2F;etc&#x2F;redis&#x2F;sentinel.conf
      - .&#x2F;26380&#x2F;:&#x2F;usr&#x2F;local&#x2F;etc&#x2F;redis&#x2F;
  sentinel3:
    image: redis
    container_name: redis-sentinel-3
    ports:
      - 26381:26379
    command: redis-sentinel &#x2F;usr&#x2F;local&#x2F;etc&#x2F;redis&#x2F;sentinel.conf
    volumes:
      - .&#x2F;sentinel3.conf:&#x2F;usr&#x2F;local&#x2F;etc&#x2F;redis&#x2F;sentinel.conf
      - .&#x2F;26381:&#x2F;usr&#x2F;local&#x2F;etc&#x2F;redis&#x2F;
networks:
  default:
    external:
      name: redis_default
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>挂载Sentinel配置文件：</p>
<blockquote>
<p>sentinel1.conf</p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">port 26379
dir &#x2F;tmp
# 172.18.0.3是redis的主节点ip
# 指示 Sentinel 去监视一个名为 mymaster 的主服务器， 这个主服务器的 IP 地址为 172.18.0.3 （docker inspect [containerIP]可以获取） 端口号为 6379
# 将这个主服务器判断为失效至少需要 2 个 Sentinel 同意 （只要同意 Sentinel 的数量不达标，自动故障迁移就不会执行）
sentinel monitor mymaster 172.18.0.3 6379 2
#
sentinel auth-pass mymaster redis_pwd
# 指定了 Sentinel 认为服务器已经断线所需的毫秒数。
sentinel down-after-milliseconds mymaster 30000
# 指定了在执行故障转移时， 最多可以有多少个从服务器同时对新的主服务器进行同步，
# 这个数字越小， 完成故障转移所需的时间就越长。
sentinel parallel-syncs mymaster 1
sentinel failover-timeout mymaster 180000
sentinel deny-scripts-reconfig yes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>PS:由于sentinel启动会对sentinel.conf文件做修改，我们启动了3个sentinel节点，所以配置文件需要复制3份分别对应每一个节点</p>
<p>执行docker-compose up -d 启动容器。</p>
<h3 id="1-2-4-验证"><a href="#1-2-4-验证" class="headerlink" title="1.2.4 验证"></a>1.2.4 验证</h3><p>查看docker容器状态：<br><img src="/2020/12/25/redis/redis-shao-bing-mo-shi-he-ji-qun-mo-shi/docker%E5%AE%B9%E5%99%A8%E7%8A%B6%E6%80%81.png" alt="docker容器状态"></p>
<p>查看Reids Master节点状态：<br><img src="/2020/12/25/redis/redis-shao-bing-mo-shi-he-ji-qun-mo-shi/Master%E8%8A%82%E7%82%B9%E7%8A%B6%E6%80%81.png" alt="Master节点状态"></p>
<p>查看sentinel节点状态：<br><img src="/2020/12/25/redis/redis-shao-bing-mo-shi-he-ji-qun-mo-shi/sentinel%E8%8A%82%E7%82%B9%E7%8A%B6%E6%80%81.png" alt="sentinel节点状态"><br><img src="/2020/12/25/redis/redis-shao-bing-mo-shi-he-ji-qun-mo-shi/sentinel%E8%8A%82%E7%82%B9%E7%8A%B6%E6%80%812.png" alt="sentinel节点状态2"></p>
<h2 id="1-3-Redis哨兵模式故障转移测试"><a href="#1-3-Redis哨兵模式故障转移测试" class="headerlink" title="1.3 Redis哨兵模式故障转移测试"></a>1.3 Redis哨兵模式故障转移测试</h2><h3 id="1-3-1-新建SpringBoot项目连接到Redis"><a href="#1-3-1-新建SpringBoot项目连接到Redis" class="headerlink" title="1.3.1 新建SpringBoot项目连接到Redis"></a>1.3.1 新建SpringBoot项目连接到Redis</h3><h4 id="创建一个SpringBoot项目，添加Redis依赖："><a href="#创建一个SpringBoot项目，添加Redis依赖：" class="headerlink" title="创建一个SpringBoot项目，添加Redis依赖："></a>创建一个SpringBoot项目，添加Redis依赖：</h4><pre class="line-numbers language-none"><code class="language-none">   &lt;dependency&gt;
	&lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;
	&lt;artifactId&gt;spring-boot-starter-data-redis&lt;&#x2F;artifactId&gt;
&lt;&#x2F;dependency&gt;
&lt;dependency&gt;
	&lt;groupId&gt;org.apache.commons&lt;&#x2F;groupId&gt;
	&lt;artifactId&gt;commons-pool2&lt;&#x2F;artifactId&gt;
&lt;&#x2F;dependency&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="配置Redis"><a href="#配置Redis" class="headerlink" title="配置Redis"></a>配置Redis</h4><pre class="line-numbers language-none"><code class="language-none">spring:
  redis:
    password: redis_hyk
    sentinel:
      master: mymaster
      nodes: 172.16.16.37:26379,172.16.16.37:26380,172.16.16.37:26381<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="在SpringBoot项目中持续进行写入操作"><a href="#在SpringBoot项目中持续进行写入操作" class="headerlink" title="在SpringBoot项目中持续进行写入操作"></a>在SpringBoot项目中持续进行写入操作</h4><pre class="line-numbers language-none"><code class="language-none">@Component
public class RedisService &#123;

    @Autowired
    private RedisTemplate&lt;String, String&gt; stringRedisTemplate;

    @PostConstruct
    public void writeRedis() &#123;
        DateTimeFormatter formatter &#x3D; DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss SSS&quot;);
        while(true) &#123;
            try &#123;
                String time &#x3D; ZonedDateTime.now().format(formatter);
                stringRedisTemplate.opsForValue().set(&quot;master-failover&quot;, time);
                Thread.sleep(1000);
            &#125; catch (Exception e) &#123;
                e.printStackTrace();
            &#125;
        &#125;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="停止掉Redis的Master节点"><a href="#停止掉Redis的Master节点" class="headerlink" title="停止掉Redis的Master节点"></a>停止掉Redis的Master节点</h4><p><code>docker container stop 881</code></p>
<h4 id="SpringBoot项目日志输入"><a href="#SpringBoot项目日志输入" class="headerlink" title="SpringBoot项目日志输入"></a>SpringBoot项目日志输入</h4><pre class="line-numbers language-none"><code class="language-none">20:02:59.584  INFO 15128 --- [xecutorLoop-1-3] i.l.core.protocol.ConnectionWatchdog     : Reconnecting, last destination was &#x2F;172.16.16.37:6379
20:03:01.657  WARN 15128 --- [ioEventLoop-4-4] i.l.core.protocol.ConnectionWatchdog     : Cannot reconnect to [172.16.16.37:6379]: Connection refused: no further information: &#x2F;172.16.16.37:6379
20:03:05.957  INFO 15128 --- [xecutorLoop-1-2] i.l.core.protocol.ConnectionWatchdog     : Reconnecting, last destination was 172.16.16.37:6379
20:03:07.997  WARN 15128 --- [ioEventLoop-4-2] i.l.core.protocol.ConnectionWatchdog     : Cannot reconnect to [172.16.16.37:6379]: Connection refused: no further information: &#x2F;172.16.16.37:6379
20:03:12.464  INFO 15128 --- [xecutorLoop-1-4] i.l.core.protocol.ConnectionWatchdog     : Reconnecting, last destination was 172.16.16.37:6379
20:03:14.517  WARN 15128 --- [ioEventLoop-4-4] i.l.core.protocol.ConnectionWatchdog     : Cannot reconnect to [172.16.16.37:6379]: Connection refused: no further information: &#x2F;172.16.16.37:6379
20:03:19.659  INFO 15128 --- [xecutorLoop-1-2] i.l.core.protocol.ConnectionWatchdog     : Reconnecting, last destination was 172.16.16.37:6379
20:03:21.714  WARN 15128 --- [ioEventLoop-4-2] i.l.core.protocol.ConnectionWatchdog     : Cannot reconnect to [172.16.16.37:6379]: Connection refused: no further information: &#x2F;172.16.16.37:6379
20:03:26.961  INFO 15128 --- [xecutorLoop-1-2] i.l.core.protocol.ConnectionWatchdog     : Reconnecting, last destination was 172.16.16.37:6379
20:03:29.030  WARN 15128 --- [ioEventLoop-4-2] i.l.core.protocol.ConnectionWatchdog     : Cannot reconnect to [172.16.16.37:6379]: Connection refused: no further information: &#x2F;172.16.16.37:6379
20:03:33.167  INFO 15128 --- [xecutorLoop-1-4] i.l.core.protocol.ConnectionWatchdog     : Reconnecting, last destination was 172.16.16.37:6379
20:03:33.184  INFO 15128 --- [ioEventLoop-4-4] i.l.core.protocol.ReconnectionHandler    : Reconnected to 172.16.16.37:6381<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Sentinel节点日志输出"><a href="#Sentinel节点日志输出" class="headerlink" title="Sentinel节点日志输出"></a>Sentinel节点日志输出</h4><pre class="line-numbers language-none"><code class="language-none">04:01:34.181 # +sdown master mymaster 172.16.16.37 6379
04:01:34.309 # +new-epoch 1
04:01:34.325 # +vote-for-leader a1d392603fe93637b2194b0f67f38cf1946efdc2 1
04:01:35.280 # +odown master mymaster 172.16.16.37 6379 #quorum 3&#x2F;2
04:01:35.281 # Next failover delay: I will not start a failover before 04:07:35 2021
04:01:35.449 # +config-update-from sentinel a1d392603fe93637b2194b0f67f38cf1946efdc2 172.16.16.37 26380 @ mymaster 172.16.16.37 6379
04:01:35.449 # +switch-master mymaster 172.16.16.37 6379 172.16.16.37 6381
04:01:35.449 * +slave slave 172.16.16.37:6380 172.16.16.37 6380 @ mymaster 172.16.16.37 6381
04:01:35.449 * +slave slave 172.16.16.37:6379 172.16.16.37 6379 @ mymaster 172.16.16.37 6381
04:02:05.508 # +sdown slave 172.16.16.37:6379 172.16.16.37 6379 @ mymaster 172.16.16.37 6381
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>根据日志输出可以看到redis哨兵模式在3分内完成了故障转移操作。<br><code>sentinel failover-timeout mymaster 180000</code></p>
<h1 id="二、Redis集群模式搭建"><a href="#二、Redis集群模式搭建" class="headerlink" title="二、Redis集群模式搭建"></a>二、Redis集群模式搭建</h1><h2 id="2-1Redis集群模式架构图"><a href="#2-1Redis集群模式架构图" class="headerlink" title="2.1Redis集群模式架构图"></a>2.1Redis集群模式架构图</h2><p><img src="/2020/12/25/redis/redis-shao-bing-mo-shi-he-ji-qun-mo-shi/Redis%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="Redis集群模式架构图"></p>
<p>Redis的集群实现方案：<br>(1)官方的 redis cluster 的方案<br>(2)类 codis 的架构</p>
<h2 id="2-2-虚拟机环境下搭建Redis集群模式"><a href="#2-2-虚拟机环境下搭建Redis集群模式" class="headerlink" title="2.2 虚拟机环境下搭建Redis集群模式"></a>2.2 虚拟机环境下搭建Redis集群模式</h2><h3 id="2-2-1-下载编译Redis"><a href="#2-2-1-下载编译Redis" class="headerlink" title="2.2.1 下载编译Redis"></a>2.2.1 下载编译Redis</h3><p>从redis官网下载Redis源码并进行编译。Redis官网：<a href="https://redis.io/download">https://redis.io/download</a></p>
<p>注意：在Centos7上编译Redis6.x需要gcc的版本在5.0以上，Centos7默认的gcc版本为4.8.5。gcc目前最新版本为9.3.1</p>
<h3 id="2-2-2-搭建Redis集群模式"><a href="#2-2-2-搭建Redis集群模式" class="headerlink" title="2.2.2 搭建Redis集群模式"></a>2.2.2 搭建Redis集群模式</h3><p>根据Redis官方文档，测试搭建Redis集群模式：</p>
<p>（1）手动创建redis.conf配置文件启动redis实例，最后通过redis-cli 的集群命令创建集群</p>
<p>（2）通过Redis源码包下的utils工具包下的脚本创建（脚本创建更方便，但是手动创建有助于了解集群创建的过程）</p>
<p>关于集群创建的操作步骤可以参考Redis的官方文档：<a href="https://redis.io/topics/cluster-tutorial">https://redis.io/topics/cluster-tutorial</a></p>
<h2 id="2-3-Redis集群总结"><a href="#2-3-Redis集群总结" class="headerlink" title="2.3 Redis集群总结"></a>2.3 Redis集群总结</h2><p>（1）Redis集群拓扑结构<br>Redis集群是一个网状结构，每个节点都通过TCP连接跟其它每个节点连接。</p>
<p>在一个有N个节点的集群中，每个节点都有N-1个流出的TCP连接和N-1个流入的TCP连接，这些TCP连接会永久保持，并不是按需创建的</p>
<p>（2）Redis 集群的数据分片<br>Redis集群的实现方案：</p>
<ul>
<li><p>客户端分区，代表为 Redis Sharding</p>
</li>
<li><p>代理分区方案，主流实现的有方案有 Twemproxy 和 Codis</p>
</li>
<li><p>查询路由方案，Redis默认实现方案。</p>
</li>
</ul>
<p>Redis 集群没有使用一致性hash, 而是引入了 哈希槽的概念.</p>
<p>Redis 集群有16384个哈希槽,每个key通过CRC16校验后对16384取模来决定放置哪个槽.集群的每个节点负责一部分hash槽,举个例子,比如当前集群有3个节点,那么:</p>
<p>节点 A 包含 0 到 5500号哈希槽.<br>节点 B 包含5501 到 11000 号哈希槽.<br>节点 C 包含11001 到 16384号哈希槽.<br>这种结构很容易添加或者删除节点. 比如如果我想新添加个节点D, 我需要从节点 A, B, C中得部分槽到D上. 如果我想移除节点A,需要将A中的槽移到B和C节点上,然后将没有任何槽的A节点从集群中移除即可. 由于从一个节点将哈希槽移动到另一个节点并不会停止服务,所以无论添加删除或者改变某个节点的哈希槽的数量都不会造成集群不可用的状态.</p>
<p>（3）Redis集群的主从复制模型<br>为了使在部分节点失败或者大部分节点无法通信的情况下集群仍然可用，所以集群使用了主从复制模型,每个节点都会有N-1个复制品.</p>
<p>在我们例子中具有A，B，C三个节点的集群,在没有复制模型的情况下,如果节点B失败了，那么整个集群就会以为缺少5501-11000这个范围的槽而不可用.</p>
<p>然而如果在集群创建的时候（或者过一段时间）我们为每个节点添加一个从节点A1，B1，C1,那么整个集群便有三个master节点和三个slave节点组成，这样在节点B失败后，集群便会选举B1为新的主节点继续服务，整个集群便不会因为槽找不到而不可用了</p>
<p>不过当B和B1 都失败后，集群是不可用的.</p>
<p>（4）Redis集群的一致性保证<br>Redis 并不能保证数据的强一致性. 这意味这在实际中集群在特定的条件下可能会丢失写操作.</p>
<p>第一个原因是因为集群是用了异步复制. 写操作过程:</p>
<p>客户端向主节点B写入一条命令.<br>主节点B向客户端回复命令状态.<br>主节点将写操作复制给他得从节点 B1, B2 和 B3.<br>主节点对命令的复制工作发生在返回命令回复之后， 因为如果每次处理命令请求都需要等待复制操作完成的话， 那么主节点处理命令请求的速度将极大地降低 —— 我们必须在性能和一致性之间做出权衡。 注意：Redis 集群可能会在将来提供同步写的方法。 Redis 集群另外一种可能会丢失命令的情况是集群出现了网络分区， 并且一个客户端与至少包括一个主节点在内的少数实例被孤立。</p>
<p>举个例子 假设集群包含 A 、 B 、 C 、 A1 、 B1 、 C1 六个节点， 其中 A 、B 、C 为主节点， A1 、B1 、C1 为A，B，C的从节点， 还有一个客户端 Z1 假设集群中发生网络分区，那么集群可能会分为两方，大部分的一方包含节点 A 、C 、A1 、B1 和 C1 ，小部分的一方则包含节点 B 和客户端 Z1 .</p>
<p>Z1仍然能够向主节点B中写入, 如果网络分区发生时间较短,那么集群将会继续正常运作,如果分区的时间足够让大部分的一方将B1选举为新的master，那么Z1写入B中得数据便丢失了.</p>
<p>注意， 在网络分裂出现期间， 客户端 Z1 可以向主节点 B 发送写命令的最大时间是有限制的， 这一时间限制称为节点超时时间（node timeout）， 是 Redis 集群的一个重要的配置选项。</p>
<p>（5）Redis集群在线重配置<br>Redis 集群支持在集群运行过程中添加或移除节点。实际上，添加或移除节点都被抽象为同一个操作，那就是把哈希槽从一个节点移到另一个节点。</p>
<p>向集群添加一个新节点，就是把一个空节点加入到集群中并把某些哈希槽从已存在的节点移到新节点上。<br>从集群中移除一个节点，就是把该节点上的哈希槽移到其他已存在的节点上。<br>所以实现这个的核心是能把哈希槽移来移去。从实际角度看，哈希槽就只是一堆键，所以 Redis 集群在重组碎片（reshard）时做的就是把键从一个节点移到另一个节点。<br>为了理解这是怎么工作的，我们需要介绍 CLUSTER 的子命令，这些命令是用来操作 Redis 集群节点上的哈希槽转换表（slots translation table）。</p>
<p>以下是可用的子命令：</p>
<p>CLUSTER ADDSLOTS slot1 [slot2] … [slotN]<br>CLUSTER DELSLOTS slot1 [slot2] … [slotN]<br>CLUSTER SETSLOT slot NODE node<br>CLUSTER SETSLOT slot MIGRATING node<br>CLUSTER SETSLOT slot IMPORTING node<br>头两个命令，ADDSLOTS 和 DELSLOTS，就是简单地用来给一个 Redis 节点指派（assign）或移除哈希槽。 在哈希槽被指派后，节点会将这个消息通过 gossip 协议向整个集群传播。ADDSLOTS 命令通常是用于在一个集群刚建立的时候快速给所有节点指派哈希槽。<br>当 SETSLOT 子命令使用 NODE 形式的时候，用来给指定 ID 的节点指派哈希槽。 除此之外哈希槽能通过两个特殊的状态来设定，MIGRATING 和 IMPORTING：</p>
<p>当一个槽被设置为 MIGRATING，原来持有该哈希槽的节点仍会接受所有跟这个哈希槽有关的请求，但只有当查询的键还存在原节点时，原节点会处理该请求，否则这个查询会通过一个 -ASK 重定向（-ASK redirection）转发到迁移的目标节点。<br>当一个槽被设置为 IMPORTING，只有在接受到 ASKING 命令之后节点才会接受所有查询这个哈希槽的请求。如果客户端一直没有发送 ASKING 命令，那么查询都会通过 -MOVED 重定向错误转发到真正处理这个哈希槽的节点那里。<br>这么讲可能显得有点奇怪，现在我们用实例让它更清晰些。假设我们有两个 Redis 节点，称为 A 和 B。我们想要把哈希槽 8 从 节点A 移到 节点B，所以我们发送了这样的命令：</p>
<p>我们向 节点B 发送：CLUSTER SETSLOT 8 IMPORTING A<br>我们向 节点A 发送：CLUSTER SETSLOT 8 MIGRATING B<br>其他所有节点在每次被询问到的一个键是属于哈希槽 8 的时候，都会把客户端引向节点”A”。具体如下：</p>
<p>所有关于已存在的键的查询都由节点”A”处理。<br>所有关于不存在于节点 A 的键都由节点”B”处理。<br>这种方式让我们可以不用在节点 A 中创建新的键。同时，一个叫做 redis-trib 的特殊客户端，它也是 Redis 集群的配置程序（configuration utility），会确保把已存在的键从节点 A 移到节点 B。这通过以下命令实现：</p>
<p>CLUSTER GETKEYSINSLOT slot count<br>上面这个命令会返回指定的哈希槽中 count 个键。对于每个返回的键，redis-trib 向节点 A 发送一个 MIGRATE 命令，这样会以原子性的方式（在移动键的过程中两个节点都被锁住，以免出现竞争状况）把指定的键从节点 A 移到节点 B。以下是 MIGRATE 的工作原理：</p>
<p>MIGRATE target_host target_port key target_database id timeout<br>执行 MIGRATE 命令的节点会连接到目标节点，把序列化后的 key 发送过去，一旦收到 OK 回复就会从它自己的数据集中删除老的 key。所以从一个外部客户端看来，在某个时间点，一个 key 要不就存在于节点 A 中要不就存在于节点 B 中。</p>
<p>在 Redis 集群中，不需要指定一个除了 0 号之外的数据库，但 MIGRATE 命令能用于其他跟 Redis 集群无关的的任务，所以它是一个足够通用的命令。MIGRATE 命令被优化了，使得即使在移动像长列表这样的复杂键仍然能做到快速。 不过当在重配置一个拥有很多键且键的数据量都很大的集群的时候，这个过程就并不那么好了，对于使用数据库的应用程序来说就会有延时这个限制。</p>
<p>（6）Redis集群失效检测<br>Redis 集群失效检测是用来识别出大多数节点何时无法访问某一个主节点或从节点。当这个事件发生时，就提升一个从节点来做主节点；若如果无法提升从节点来做主节点的话，那么整个集群就置为错误状态并停止接收客户端的查询。</p>
<p>每个节点都有一份跟其他已知节点相关的标识列表。其中有两个标识是用于失效检测，分别是 PFAIL 和 FAIL。PFAIL 表示可能失效（Possible failure），这是一个非公认的（non acknowledged）失效类型。FAIL 表示一个节点已经失效，而且这个情况已经被大多数主节点在某段固定时间内确认过的了。</p>
<h2 id="参考文章："><a href="#参考文章：" class="headerlink" title="参考文章："></a>参考文章：</h2><p><a href="https://redis.io/topics/cluster-tutorial">https://redis.io/topics/cluster-tutorial</a></p>
<p><a href="https://juejin.cn/post/6850418118721077261">docker-compose快速搭建redis哨兵模式高可用集群</a></p>
<p><a href="https://juejin.cn/post/6844903663362637832">深入剖析Redis系列(二) - Redis哨兵模式与高可用集群</a></p>
<p><a href="https://msd.misuland.com/pd/3255817928875971830">redis cluster集群模式总结</a></p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>Redis</tag>
        <tag>哨兵模式</tag>
        <tag>集群模式</tag>
      </tags>
  </entry>
  <entry>
    <title>一次线上Redis集群节点主从切换引起的应用重启问题排查处理</title>
    <url>/2025/12/20/redis/yi-ci-xian-shang-redis-ji-qun-jie-dian-zhu-cong-qie-huan-yin-qi-de-ying-yong-chong-qi-wen-ti-pai-cha-chu-li/</url>
    <content><![CDATA[<h2 id="一、问题背景"><a href="#一、问题背景" class="headerlink" title="一、问题背景"></a>一、问题背景</h2><p>某日生产环境出现大规模应用重启告警，经过初步排查发现与Redis集群节点主从切换有关。该问题导致多个核心服务不可用，对业务产生了较大影响。</p>
<p><strong>问题环境：</strong></p>
<ul>
<li>Redis集群架构</li>
<li>Kubernetes容器化部署</li>
<li>Spring Boot微服务架构</li>
</ul>
<h2 id="二、问题现象"><a href="#二、问题现象" class="headerlink" title="二、问题现象"></a>二、问题现象</h2><p>问题发生时，监控系统显示大量应用实例出现重启现象，具体表现为：</p>
<ol>
<li><strong>应用层面：</strong> 多个微服务实例频繁重启</li>
<li><strong>日志异常：</strong> 应用日志中出现大量Redis连接异常</li>
<li><strong>监控指标：</strong> Redis集群监控显示某个节点发生主从切换</li>
<li><strong>业务影响：</strong> 部分核心接口响应超时，用户体验下降</li>
</ol>
<p><img src="/2025/12/20/redis/yi-ci-xian-shang-redis-ji-qun-jie-dian-zhu-cong-qie-huan-yin-qi-de-ying-yong-chong-qi-wen-ti-pai-cha-chu-li/redis%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9%E8%B5%84%E6%BA%90%E7%9B%91%E6%8E%A7.png" alt="Redis集群节点资源监控"></p>
<p><em>图1：Redis集群节点资源监控图示</em></p>
<h2 id="三、排查过程"><a href="#三、排查过程" class="headerlink" title="三、排查过程"></a>三、排查过程</h2><h3 id="3-1-初步分析"><a href="#3-1-初步分析" class="headerlink" title="3.1 初步分析"></a>3.1 初步分析</h3><p>通过监控系统初步定位，发现问题与Redis集群节点主从切换存在强关联性：</p>
<ol>
<li>时间关联性：应用重启时间与Redis节点主从切换时间高度吻合</li>
<li>影响范围：所有依赖该Redis集群的服务均受到影响</li>
<li>初步判断：可能是Redis集群拓扑变化导致应用无法正常连接</li>
</ol>
<h3 id="3-2-深入排查"><a href="#3-2-深入排查" class="headerlink" title="3.2 深入排查"></a>3.2 深入排查</h3><p>为进一步定位问题根因，我们进行了深入的技术排查：</p>
<p><strong>排查工具与方法：</strong></p>
<ul>
<li>查看应用日志，分析异常堆栈信息</li>
<li>检查Redis集群状态和节点信息</li>
<li>分析Kubernetes事件和Pod状态变化</li>
<li>对比切换前后集群拓扑结构</li>
</ul>
<p><strong>关键发现：</strong></p>
<ul>
<li>应用日志中反复出现<code>Node xxx.xxx.xxx.xxx:xxxx is unknown to cluster</code>异常</li>
<li>Redis集群已完成主从切换，但应用仍尝试连接已失效的节点</li>
<li>K8s健康检查因Redis健康检查失败而判定Pod不健康，触发重启机制</li>
</ul>
<p><img src="/2025/12/20/redis/yi-ci-xian-shang-redis-ji-qun-jie-dian-zhu-cong-qie-huan-yin-qi-de-ying-yong-chong-qi-wen-ti-pai-cha-chu-li/redis%E9%9B%86%E7%BE%A4%E8%8A%82%E7%82%B9%E6%97%A5%E5%BF%97.png" alt="Redis集群节点日志"></p>
<p><em>图2：Redis集群节点日志截图</em></p>
<h3 id="3-3-根因定位"><a href="#3-3-根因定位" class="headerlink" title="3.3 根因定位"></a>3.3 根因定位</h3><p>通过深入分析，我们定位到问题的根本原因：</p>
<p><strong>Pod重启的核心原因分析：</strong></p>
<p>Redis集群健康检查失败是触发Pod重启的直接原因，而客户端未能及时感知集群拓扑变化是问题的根本所在，二者共同导致Pod被K8s判定为”不健康”并重启：</p>
<ol>
<li><strong>直接触发原因：Redis集群健康检查失败</strong><ul>
<li>日志中反复出现Redis health check failed及相关异常：</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">org.springframework.dao.DataAccessResourceFailureException: Node x.x.x.x:xxxx is unknown to cluster<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>含义：Spring Boot Actuator的Redis健康检查组件尝试连接Redis集群节点时，发现该节点不在集群节点列表中</li>
<li>连锁反应：K8s的存活&#x2F;就绪探针因健康检查失败判定Pod不健康，进而触发Pod重启</li>
</ul>
</li>
</ol>
<p><img src="/2025/12/20/redis/yi-ci-xian-shang-redis-ji-qun-jie-dian-zhu-cong-qie-huan-yin-qi-de-ying-yong-chong-qi-wen-ti-pai-cha-chu-li/k8s%E4%BA%8B%E4%BB%B6%E9%80%9A%E7%9F%A5.png" alt="k8s事件通知"></p>
<p><em>图3：Kubernetes事件通知截图</em></p>
<h2 id="四、问题分析"><a href="#四、问题分析" class="headerlink" title="四、问题分析"></a>四、问题分析</h2><h3 id="4-1-技术原理分析"><a href="#4-1-技术原理分析" class="headerlink" title="4.1 技术原理分析"></a>4.1 技术原理分析</h3><p>Redis集群主从切换后应用持续报<code>Node x.x.x.x:xxxx is unknown to cluster</code>，核心原因是应用侧未感知Redis集群拓扑变化，仍缓存旧的节点信息（失效的主节点），而新的集群拓扑中已无该节点。</p>
<p><strong>主从切换后Redis集群的核心变化：</strong></p>
<ol>
<li><strong>节点角色&#x2F;状态变更：</strong> 原主节点可能被下线、降级为从节点，或在集群重新分片后被移除</li>
<li><strong>集群拓扑更新：</strong> Redis集群会将新的主节点信息同步到所有存活节点</li>
</ol>
<p><strong>客户端感知问题：</strong> 应用侧不会主动感知这个变化，仍依赖初始化时加载的旧拓扑。</p>
<h3 id="4-2-为什么报错会”持续”？"><a href="#4-2-为什么报错会”持续”？" class="headerlink" title="4.2 为什么报错会”持续”？"></a>4.2 为什么报错会”持续”？</h3><ol>
<li><strong>缓存未过期：</strong> Jedis客户端的拓扑缓存无过期机制，除非主动刷新或应用重启，否则不会更新</li>
<li><strong>健康检查周期性执行：</strong> K8s探针&#x2F;Actuator健康检查是定时任务，每次都会尝试访问旧节点，导致报错反复出现</li>
<li><strong>无被动刷新触发条件：</strong> 若应用访问的key哈希槽未命中该失效节点，不会触发MOVED重定向，Jedis无法被动更新拓扑</li>
</ol>
<p><img src="/2025/12/20/redis/yi-ci-xian-shang-redis-ji-qun-jie-dian-zhu-cong-qie-huan-yin-qi-de-ying-yong-chong-qi-wen-ti-pai-cha-chu-li/redis%E8%8A%82%E7%82%B9%E4%B8%BB%E4%BB%8E%E7%8A%B6%E6%80%81.png" alt="redis节点主从状态"></p>
<p><em>图4：Redis节点主从状态变化图示</em></p>
<h3 id="4-3-Redis主从切换的根本原因分析"><a href="#4-3-Redis主从切换的根本原因分析" class="headerlink" title="4.3 Redis主从切换的根本原因分析"></a>4.3 Redis主从切换的根本原因分析</h3><p>通过分析Redis节点日志和资源监控数据，我们定位到主从切换的根本原因：</p>
<p><strong>关键日志分析：</strong></p>
<p>从Redis节点日志中发现了以下关键信息（时间点：2025-12-20 06:47-06:48）：</p>
<pre class="line-numbers language-none"><code class="language-none">Asynchronous AOF fsync is taking too long (disk is busy?). 
Writing the AOF buffer without waiting for fsync to complete, this may slow down Redis.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这条警告在短时间内反复出现，表明Redis在进行AOF持久化时遇到了严重的磁盘IO瓶颈。</p>
<p><strong>资源监控关键发现：</strong></p>
<p>从CPU监控图可以清晰看到：</p>
<ul>
<li><strong>06:48:30时刻</strong>：CPU使用率突然飙升至100%</li>
<li><strong>iowait占比高达8.4%</strong>：说明系统在等待磁盘IO操作完成</li>
<li><strong>持续时间</strong>：高负载状态持续了一段时间才恢复</li>
</ul>
<p><strong>主从切换触发链路：</strong></p>
<ol>
<li><p><strong>持久化操作触发</strong>：</p>
<ul>
<li>日志显示Redis正在进行RDB持久化（<code>1000 changes in 60 seconds. Saving...</code>）</li>
<li>同时进行AOF重写操作（<code>Background saving started by pid 32198</code>）</li>
<li>创建临时AOF文件（<code>temp-rewriteaof-bg-32344.aof</code>）</li>
</ul>
</li>
<li><p><strong>磁盘IO瓶颈</strong>：</p>
<ul>
<li>AOF fsync操作耗时过长，磁盘处于繁忙状态</li>
<li>Fork操作的Copy-on-Write机制加剧了内存和IO压力</li>
<li>日志显示Fork CoW达到30MB，峰值30MB</li>
</ul>
</li>
<li><p><strong>主节点响应缓慢</strong>：</p>
<ul>
<li>CPU资源被持久化操作大量占用（100%使用率）</li>
<li>主节点无法及时响应从节点的心跳请求</li>
<li>从节点认为主节点不可用</li>
</ul>
</li>
<li><p><strong>集群自动故障转移</strong>：</p>
<ul>
<li>日志显示：<code>failover auth denied to edb11b7514756aab7c2ddbe345f9e015269161Sd: its master is up</code></li>
<li>随后进行配置变更：<code>Configuration change detected. Reconfiguring myself as a replica</code></li>
<li>最终完成主从切换：<code>MASTER &lt;-&gt; REPLICA sync started</code></li>
</ul>
</li>
</ol>
<p><strong>根本原因总结：</strong></p>
<p>此次主从切换的根本原因是<strong>Redis持久化操作（RDB+AOF重写）在高负载情况下触发了严重的磁盘IO瓶颈</strong>，导致：</p>
<ul>
<li>主节点CPU和IO资源被大量占用</li>
<li>主节点无法及时响应集群心跳</li>
<li>从节点判定主节点失效，触发自动故障转移</li>
<li>集群执行主从切换以保证高可用性</li>
</ul>
<p>这是Redis集群在面对持久化压力时的正常自我保护机制，但由于应用侧未能及时感知拓扑变化，导致了后续的应用重启问题。</p>
<h2 id="五、解决方案"><a href="#五、解决方案" class="headerlink" title="五、解决方案"></a>五、解决方案</h2><h3 id="5-1-临时解决措施"><a href="#5-1-临时解决措施" class="headerlink" title="5.1 临时解决措施"></a>5.1 临时解决措施</h3><p><strong>紧急修复：重启应用</strong></p>
<p>重启受影响的应用实例，使其重新从Redis集群种子节点加载最新拓扑，直接解决缓存旧节点的问题。这是一种有效的应急处理措施，可以快速恢复服务。</p>
<h3 id="5-2-根本解决方案"><a href="#5-2-根本解决方案" class="headerlink" title="5.2 根本解决方案"></a>5.2 根本解决方案</h3><p><strong>长期优化：开启Jedis集群拓扑自动刷新</strong></p>
<p>修改Spring Redis配置，开启Jedis的拓扑自动刷新功能，让应用能够主动感知集群拓扑变化，从根本上解决此类问题：</p>
<ol>
<li>配置JedisCluster的<code>refresh</code>参数</li>
<li>设置合理的刷新间隔时间</li>
<li>启用集群节点变化监听机制</li>
<li>优化健康检查逻辑，增加容错机制</li>
</ol>
<h3 id="5-3-方案实施"><a href="#5-3-方案实施" class="headerlink" title="5.3 方案实施"></a>5.3 方案实施</h3><p><strong>实施步骤：</strong></p>
<ol>
<li><p><strong>配置优化：</strong></p>
<ul>
<li>在Spring Boot配置文件中启用Jedis集群拓扑自动刷新</li>
<li>调整健康检查超时时间和重试机制</li>
<li>增加重试逻辑和熔断机制</li>
</ul>
</li>
<li><p><strong>代码改造：</strong></p>
<ul>
<li>优化Redis客户端初始化逻辑</li>
<li>增加集群节点状态检测机制</li>
<li>实现优雅降级策略</li>
</ul>
</li>
<li><p><strong>测试验证：</strong></p>
<ul>
<li>在测试环境模拟主从切换场景</li>
<li>验证应用是否能正确感知集群变化</li>
<li>确认健康检查机制的稳定性</li>
</ul>
</li>
<li><p><strong>上线部署：</strong></p>
<ul>
<li>分批灰度发布配置变更</li>
<li>监控上线后的系统表现</li>
<li>准备回滚方案</li>
</ul>
</li>
</ol>
<h2 id="六、经验总结"><a href="#六、经验总结" class="headerlink" title="六、经验总结"></a>六、经验总结</h2><p>通过本次问题处理，我们得到了以下经验教训：</p>
<h3 id="6-1-避免类似问题的措施"><a href="#6-1-避免类似问题的措施" class="headerlink" title="6.1 避免类似问题的措施"></a>6.1 避免类似问题的措施</h3><p><strong>应用层面：</strong></p>
<ol>
<li><strong>客户端优化：</strong> 启用Redis客户端的集群拓扑自动刷新功能</li>
<li><strong>健康检查改进：</strong> 优化健康检查逻辑，增加容错和重试机制</li>
<li><strong>配置管理：</strong> 建立完善的配置管理机制，确保关键参数正确设置</li>
</ol>
<p><strong>Redis层面：</strong></p>
<ol>
<li><p><strong>持久化优化：</strong> </p>
<ul>
<li>调整AOF重写触发条件，避免与RDB同时执行</li>
<li>配置<code>no-appendfsync-on-rewrite yes</code>，在重写期间不执行fsync</li>
<li>考虑使用Redis 7.0的Multi-Part AOF特性</li>
</ul>
</li>
<li><p><strong>资源规划：</strong></p>
<ul>
<li>确保Redis服务器有足够的CPU和IO资源</li>
<li>使用SSD磁盘提升IO性能</li>
<li>合理配置<code>maxmemory</code>参数，避免Fork时的内存压力</li>
</ul>
</li>
<li><p><strong>持久化策略：</strong></p>
<ul>
<li>根据业务特点选择合适的持久化策略（RDB&#x2F;AOF&#x2F;混合）</li>
<li>错峰执行持久化操作，避开业务高峰期</li>
<li>考虑在从节点进行持久化操作</li>
</ul>
</li>
</ol>
<h3 id="6-2-监控告警改进建议"><a href="#6-2-监控告警改进建议" class="headerlink" title="6.2 监控告警改进建议"></a>6.2 监控告警改进建议</h3><ol>
<li><strong>增加专项监控：</strong> 监控Redis集群节点变化事件</li>
<li><strong>完善告警策略：</strong> 区分瞬时故障和持续异常</li>
<li><strong>建立关联分析：</strong> 关联Redis集群状态与应用健康状态</li>
</ol>
<h3 id="6-3-应急预案完善"><a href="#6-3-应急预案完善" class="headerlink" title="6.3 应急预案完善"></a>6.3 应急预案完善</h3><ol>
<li><strong>标准化处理流程：</strong> 制定Redis集群故障应急处理手册</li>
<li><strong>自动化恢复机制：</strong> 开发自动检测和恢复脚本</li>
<li><strong>定期演练：</strong> 定期进行故障恢复演练</li>
</ol>
<h2 id="七、参考资料"><a href="#七、参考资料" class="headerlink" title="七、参考资料"></a>七、参考资料</h2><ol>
<li>Redis官方文档 - 集群规范</li>
<li>Spring Data Redis官方文档</li>
<li>Jedis客户端使用指南</li>
<li>Kubernetes健康检查最佳实践</li>
<li>微服务架构下的故障处理模式</li>
</ol>
]]></content>
      <categories>
        <category>middleware</category>
      </categories>
      <tags>
        <tag>Redis</tag>
        <tag>集群</tag>
        <tag>主从切换</tag>
        <tag>故障排查</tag>
        <tag>生产问题</tag>
      </tags>
  </entry>
  <entry>
    <title>为什么Redis集群使用16384个哈希槽</title>
    <url>/2020/12/30/redis/wei-shi-me-redis-ji-qun-shi-yong-16384-ge-ha-xi-cao/</url>
    <content><![CDATA[<h1 id="一、Redis集群特点"><a href="#一、Redis集群特点" class="headerlink" title="一、Redis集群特点"></a>一、Redis集群特点</h1><h2 id="1-1-Redis集群拓扑结构"><a href="#1-1-Redis集群拓扑结构" class="headerlink" title="1.1 Redis集群拓扑结构"></a>1.1 Redis集群拓扑结构</h2><p>Redis集群是一个网状结构，每个节点都通过TCP连接跟其它每个节点连接。</p>
<p>在一个有N个节点的集群中，每个节点都有N-1个流出的TCP连接和N-1个流入的TCP连接，这些TCP连接会永久保持，并不是按需创建的。</p>
<h2 id="1-2-Redis集群数据分片"><a href="#1-2-Redis集群数据分片" class="headerlink" title="1.2 Redis集群数据分片"></a>1.2 Redis集群数据分片</h2><h3 id="Redis集群的实现方案："><a href="#Redis集群的实现方案：" class="headerlink" title="Redis集群的实现方案："></a>Redis集群的实现方案：</h3><ul>
<li><p>客户端分区，代表为 Redis Sharding</p>
</li>
<li><p>代理分区方案，主流实现的有方案有 Twemproxy 和 Codis</p>
</li>
<li><p>查询路由方案，Redis默认实现方案。</p>
</li>
</ul>
<h2 id="1-3-Redis-集群没有使用一致性hash-而是引入了-哈希槽的概念"><a href="#1-3-Redis-集群没有使用一致性hash-而是引入了-哈希槽的概念" class="headerlink" title="1.3 Redis 集群没有使用一致性hash, 而是引入了 哈希槽的概念."></a>1.3 Redis 集群没有使用一致性hash, 而是引入了 哈希槽的概念.</h2><p>Redis 集群有16384个哈希槽,每个key通过CRC16校验后对16384取模来决定放置哪个槽.集群的每个节点负责一部分hash槽,举个例子,比如当前集群有3个节点,那么:</p>
<p>节点 A 包含 0 到 5500号哈希槽.<br>节点 B 包含5501 到 11000 号哈希槽.<br>节点 C 包含11001 到 16384号哈希槽.<br>这种结构很容易添加或者删除节点. 比如如果我想新添加个节点D, 我需要从节点 A, B, C中得部分槽到D上. 如果我想移除节点A,需要将A中的槽移到B和C节点上,然后将没有任何槽的A节点从集群中移除即可. 由于从一个节点将哈希槽移动到另一个节点并不会停止服务,所以无论添加删除或者改变某个节点的哈希槽的数量都不会造成集群不可用的状态。</p>
<h1 id="二、为什么Redis的集群使用16384个哈希槽？"><a href="#二、为什么Redis的集群使用16384个哈希槽？" class="headerlink" title="二、为什么Redis的集群使用16384个哈希槽？"></a>二、为什么Redis的集群使用16384个哈希槽？</h1><p>这个问题Redis的作者又在github的issue中解释过，我们看一下原文：<a href="https://github.com/redis/redis/issues/2576">原文地址</a></p>
<blockquote>
<p>why redis-cluster use 16384 slots? crc16() can have 2^16 -1&#x3D;65535 different remainders。</p>
</blockquote>
<blockquote>
<p>The reason is:</p>
<ol>
<li>Normal heartbeat packets carry the full configuration of a node, that can be replaced in an idempotent way with the old in order to update an old config. This means they contain the slots configuration for a node, in raw form, that uses 2k of space with16k slots, but would use a prohibitive 8k of space using 65k slots.</li>
<li>At the same time it is unlikely that Redis Cluster would scale to more than 1000 mater nodes because of other design tradeoffs.<br>So 16k was in the right range to ensure enough slots per master with a max of 1000 maters, but a small enough number to propagate the slot configuration as a raw bitmap easily. Note that in small clusters the bitmap would be hard to compress because when N is small the bitmap would have slots&#x2F;N bits set that is a large percentage of bits set.</li>
</ol>
</blockquote>
<h1 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h1><p>从上面Redis的集群拓扑架构中我们知道，Redis集群节点是通过gossip协议进行点对点通信的，每个节点都会与集群中的其它节点进行通信，我们先看一下Redis心跳包的数据结构。</p>
<pre class="line-numbers language-none"><code class="language-none">typedef struct &#123;
    char sig[4];        &#x2F;* Signature &quot;RCmb&quot; (Redis Cluster message bus). *&#x2F;
    uint32_t totlen;    &#x2F;* Total length of this message *&#x2F;
    uint16_t ver;       &#x2F;* Protocol version, currently set to 1. *&#x2F;
    uint16_t port;      &#x2F;* TCP base port number. *&#x2F;
    uint16_t type;      &#x2F;* Message type *&#x2F;
    uint16_t count;     &#x2F;* Only used for some kind of messages. *&#x2F;
    uint64_t currentEpoch;  &#x2F;* The epoch accordingly to the sending node. *&#x2F;
    uint64_t configEpoch;   &#x2F;* The config epoch if it&#39;s a master, or the last
                               epoch advertised by its master if it is a
                               slave. *&#x2F;
    uint64_t offset;    &#x2F;* Master replication offset if node is a master or
                           processed replication offset if node is a slave. *&#x2F;
    char sender[CLUSTER_NAMELEN]; &#x2F;* Name of the sender node *&#x2F;
    unsigned char myslots[CLUSTER_SLOTS&#x2F;8];
    char slaveof[CLUSTER_NAMELEN];
    char myip[NET_IP_STR_LEN];    &#x2F;* Sender IP, if not all zeroed. *&#x2F;
    char notused1[34];  &#x2F;* 34 bytes reserved for future usage. *&#x2F;
    uint16_t cport;      &#x2F;* Sender TCP cluster bus port *&#x2F;
    uint16_t flags;      &#x2F;* Sender node flags *&#x2F;
    unsigned char state; &#x2F;* Cluster state from the POV of the sender *&#x2F;
    unsigned char mflags[3]; &#x2F;* Message flags: CLUSTERMSG_FLAG[012]_... *&#x2F;
    union clusterMsgData data;
&#125; clusterMsg;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>消息头里面有个myslots的char数组，长度为16383&#x2F;8，这其实是一个bitmap,每一个位代表一个槽，如果该位为1，表示这个槽是属于这个节点的。</p>
<p>在Redis的心跳包携带了节点的全部配置信息，我们可以方便的去更新一个旧节点的全部信息。在心跳包中包含了为这个节点配置的全部哈希槽信息，他是一个位图数据结构。<br>（1）如果使用16384个哈希槽，则这个字段大小为2KB，如果使用65535个哈希槽，则将占用8KB的空间。<br>而且由于其它设计上的权衡，一个Redis集群的规模不可能超过1000个节点。<br>（2）因此16384个哈希槽能确保一个Redis集群上的每个主节点分配到足够的哈希槽；而且16384个哈希槽足够小，可以将节点配置的哈希槽作为原始位图进行传输。<br>而且由于在Redis集群规模较小时，由于每个节点分配的哈希槽会比较多，位图很难被压缩。</p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>RocketMQ中ConsumeFromWhere详解</title>
    <url>/2021/09/06/rockermq/rocketmq-zhong-consumefromwhere-xiang-jie/</url>
    <content><![CDATA[<h1 id="一、ConsumeFromWhere"><a href="#一、ConsumeFromWhere" class="headerlink" title="一、ConsumeFromWhere"></a>一、ConsumeFromWhere</h1><p>RocketMQ的Consumer有一个<code>consumeFromWhere</code>属性，表示Consumer启动后将从哪个位置开始消费消息，该属性取值有以下情况：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Consuming point on consumer booting. There are three consuming points:
 * CONSUME_FROM_LAST_OFFSET: consumer clients pick up where it stopped previously. If it were a newly booting up consumer client, according aging of the consumer group, there are two cases:
 * if the consumer group is created so recently that the earliest message being subscribed has yet expired, which means the consumer group represents a lately launched business, consuming will start from the very beginning;
 * if the earliest message being subscribed has expired, consuming will start from the latest messages, meaning messages born prior to the booting timestamp would be ignored.
 * CONSUME_FROM_FIRST_OFFSET: Consumer client will start from earliest messages available.
 * CONSUME_FROM_TIMESTAMP: Consumer client will start from specified timestamp, which means messages born prior to consumeTimestamp will be ignored
 */</span>
<span class="token keyword">private</span> <span class="token class-name">ConsumeFromWhere</span> consumeFromWhere <span class="token operator">=</span> <span class="token class-name">ConsumeFromWhere</span><span class="token punctuation">.</span><span class="token constant">CONSUME_FROM_LAST_OFFSET</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="二、源码分析"><a href="#二、源码分析" class="headerlink" title="二、源码分析"></a>二、源码分析</h1><p>consumeFromWhere在使用过程中，发现设置CONSUME_FROM_LAST_OFFSET后，有些情况仍然从头开始消费，接下来结合源码分析一下consumeFromWhere处理逻辑。</p>
<h2 id="2-1-RocketMQ客户端consumeFromWhere处理逻辑"><a href="#2-1-RocketMQ客户端consumeFromWhere处理逻辑" class="headerlink" title="2.1 RocketMQ客户端consumeFromWhere处理逻辑"></a>2.1 RocketMQ客户端consumeFromWhere处理逻辑</h2><p>Consumer启动是调用<code>computePullFromWhere(MessageQueue mq)</code>方法获取offset，以下为该方法的源码实现：<br><code>org.apache.rocketmq.client.impl.consumer.RebalancePushImpl.java</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">computePullFromWhere</span><span class="token punctuation">(</span><span class="token class-name">MessageQueue</span> mq<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">long</span> result <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">ConsumeFromWhere</span> consumeFromWhere <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumerImpl<span class="token punctuation">.</span><span class="token function">getDefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConsumeFromWhere</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">OffsetStore</span> offsetStore <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumerImpl<span class="token punctuation">.</span><span class="token function">getOffsetStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>consumeFromWhere<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token constant">CONSUME_FROM_LAST_OFFSET_AND_FROM_MIN_WHEN_BOOT_FIRST</span><span class="token operator">:</span>
        <span class="token keyword">case</span> <span class="token constant">CONSUME_FROM_MIN_OFFSET</span><span class="token operator">:</span>
        <span class="token keyword">case</span> <span class="token constant">CONSUME_FROM_MAX_OFFSET</span><span class="token operator">:</span>
        <span class="token keyword">case</span> <span class="token constant">CONSUME_FROM_LAST_OFFSET</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            
            <span class="token comment">// 从broker获取消费者组的offset，此时分为两种情况</span>
            <span class="token comment">// 1. 该消费者组之前已经存在，则broker返回该消费者组的最后的offset，此时offset > 0</span>
            <span class="token comment">// 2. 如果是一个新的消费者组，则又分为两种情况：</span>
            <span class="token comment">// 2.1 如果消费者组订阅的消息仍在broker的内存中,则broker返回offset=0</span>
            <span class="token comment">// 2.2 如果消费者组订阅的消息不在broker的内存中，则broker返回未查找到，客户端将offset设置为-1</span>
            <span class="token keyword">long</span> lastOffset <span class="token operator">=</span> offsetStore<span class="token punctuation">.</span><span class="token function">readOffset</span><span class="token punctuation">(</span>mq<span class="token punctuation">,</span> <span class="token class-name">ReadOffsetType</span><span class="token punctuation">.</span><span class="token constant">READ_FROM_STORE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// 消费者组之前已经存在（offset>0),或新消费者组且订阅的历史消息仍存在broker内存中（offset=0)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lastOffset <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                result <span class="token operator">=</span> lastOffset<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            
            <span class="token comment">// 新消费者组且历史消息不在broker的内存中</span>
            <span class="token comment">// First start,no offset</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> lastOffset<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mq<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token class-name">MixAll</span><span class="token punctuation">.</span><span class="token constant">RETRY_GROUP_TOPIC_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    result <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// 从最新的消息开始消费</span>
                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">getMQAdminImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">maxOffset</span><span class="token punctuation">(</span>mq<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MQClientException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        result <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                result <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">case</span> <span class="token constant">CONSUME_FROM_FIRST_OFFSET</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">long</span> lastOffset <span class="token operator">=</span> offsetStore<span class="token punctuation">.</span><span class="token function">readOffset</span><span class="token punctuation">(</span>mq<span class="token punctuation">,</span> <span class="token class-name">ReadOffsetType</span><span class="token punctuation">.</span><span class="token constant">READ_FROM_STORE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// 消费者组之前已经存在（offset>0),或新消费者组且历史消息仍存在broker的内存中（offset=0)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lastOffset <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                result <span class="token operator">=</span> lastOffset<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> lastOffset<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                result <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                result <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">case</span> <span class="token constant">CONSUME_FROM_TIMESTAMP</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">long</span> lastOffset <span class="token operator">=</span> offsetStore<span class="token punctuation">.</span><span class="token function">readOffset</span><span class="token punctuation">(</span>mq<span class="token punctuation">,</span> <span class="token class-name">ReadOffsetType</span><span class="token punctuation">.</span><span class="token constant">READ_FROM_STORE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
             <span class="token comment">// 消费者组之前已经存在（offset>0),或新消费者组且历史消息仍存在broker的内存中（offset=0)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lastOffset <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                result <span class="token operator">=</span> lastOffset<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> lastOffset<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mq<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token class-name">MixAll</span><span class="token punctuation">.</span><span class="token constant">RETRY_GROUP_TOPIC_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">getMQAdminImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">maxOffset</span><span class="token punctuation">(</span>mq<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MQClientException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        result <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// 从时间戳对应的offset开始消费</span>
                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">long</span> timestamp <span class="token operator">=</span> <span class="token class-name">UtilAll</span><span class="token punctuation">.</span><span class="token function">parseDate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumerImpl<span class="token punctuation">.</span><span class="token function">getDefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConsumeTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token class-name">UtilAll</span><span class="token punctuation">.</span><span class="token constant">YYYYMMDDHHMMSS</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">getMQAdminImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">searchOffset</span><span class="token punctuation">(</span>mq<span class="token punctuation">,</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MQClientException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        result <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                result <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="2-2-broker端查询消费者组offset的处理逻辑"><a href="#2-2-broker端查询消费者组offset的处理逻辑" class="headerlink" title="2.2 broker端查询消费者组offset的处理逻辑"></a>2.2 broker端查询消费者组offset的处理逻辑</h2><h3 id="broker处理queryConsumerOffset请求源码实现"><a href="#broker处理queryConsumerOffset请求源码实现" class="headerlink" title="broker处理queryConsumerOffset请求源码实现"></a>broker处理queryConsumerOffset请求源码实现</h3><p><code>org.apache.rocketmq.broker.processor.ConsumerManageProcessor</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// broker处理客户端查找Consumer的offset的请求</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">RemotingCommand</span> <span class="token function">processRequest</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">RemotingCommand</span> request<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">RemotingCommandException</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span><span class="token constant">GET_CONSUMER_LIST_BY_GROUP</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getConsumerListByGroup</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span><span class="token constant">UPDATE_CONSUMER_OFFSET</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateConsumerOffset</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token class-name">RequestCode</span><span class="token punctuation">.</span><span class="token constant">QUERY_CONSUMER_OFFSET</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">queryConsumerOffset</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token class-name">RemotingCommand</span> <span class="token function">queryConsumerOffset</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">RemotingCommand</span> request<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">RemotingCommandException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">final</span> <span class="token class-name">RemotingCommand</span> response <span class="token operator">=</span>
            <span class="token class-name">RemotingCommand</span><span class="token punctuation">.</span><span class="token function">createResponseCommand</span><span class="token punctuation">(</span><span class="token class-name">QueryConsumerOffsetResponseHeader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">QueryConsumerOffsetResponseHeader</span> responseHeader <span class="token operator">=</span>
            <span class="token punctuation">(</span><span class="token class-name">QueryConsumerOffsetResponseHeader</span><span class="token punctuation">)</span> response<span class="token punctuation">.</span><span class="token function">readCustomHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">QueryConsumerOffsetRequestHeader</span> requestHeader <span class="token operator">=</span>
            <span class="token punctuation">(</span><span class="token class-name">QueryConsumerOffsetRequestHeader</span><span class="token punctuation">)</span> request
                <span class="token punctuation">.</span><span class="token function">decodeCommandCustomHeader</span><span class="token punctuation">(</span><span class="token class-name">QueryConsumerOffsetRequestHeader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 从ConsumerOffsetManager中获取offset</span>
        <span class="token keyword">long</span> offset <span class="token operator">=</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getConsumerOffsetManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">queryOffset</span><span class="token punctuation">(</span>
                requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            responseHeader<span class="token punctuation">.</span><span class="token function">setOffset</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> <span class="token comment">// offset小于0，即broker中不存在该消费者组的offset信息（是一个新启动的消费者组）</span>
            <span class="token comment">// 获取消费队列的最小的offset，如果该队列文件未进行清除，则offset=0</span>
            <span class="token keyword">long</span> minOffset <span class="token operator">=</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMinOffsetInQueue</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    requestHeader<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 如果minOffset小于等于0，且未被消费的消息仍在内存中则返回offset=0</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>minOffset <span class="token operator">&lt;=</span> <span class="token number">0</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checkInDiskByConsumeOffset</span><span class="token punctuation">(</span>
                requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                responseHeader<span class="token punctuation">.</span><span class="token function">setOffset</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                response<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 新启动的消费者组，且积压的消息不在内存中，则返回QUERY_NOT_FOUND</span>
                response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">QUERY_NOT_FOUND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                response<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span><span class="token string">"Not found, V3_0_6_SNAPSHOT maybe this group consumer boot first"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="broker查找消费者组offset源码实现"><a href="#broker查找消费者组offset源码实现" class="headerlink" title="broker查找消费者组offset源码实现"></a>broker查找消费者组offset源码实现</h3><p><code>org.apache.rocketmq.broker.offset.ConsumerOffsetManager.java</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// broker启动时加载启动用户目录下的store/config/consumerOffset.json文件，该文件保存了对应Topic下的消费者组在队列的offset</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">String</span> jsonString<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>jsonString <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ConsumerOffsetManager</span> obj <span class="token operator">=</span> <span class="token class-name">RemotingSerializable</span><span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">,</span> <span class="token class-name">ConsumerOffsetManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>offsetTable <span class="token operator">=</span> obj<span class="token punctuation">.</span>offsetTable<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 根据Topic、消费者组、队列Id从broker获取offset，如果不存在则返回-1</span>
<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">queryOffset</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> group<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> queueId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// topic@group</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> topic <span class="token operator">+</span> <span class="token constant">TOPIC_GROUP_SEPARATOR</span> <span class="token operator">+</span> group<span class="token punctuation">;</span>
    <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>offsetTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> map<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Long</span> offset <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>queueId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> offset<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ul>
<li>如果一个消费者组之前已经启动过，再次启动后，无论consumeFromWhere设置何值，都会根据在broker记录的offset进行消费</li>
<li>如果是一个新启动的消费者组，且消费者组订阅的消息仍在broker的内存中，无论consumeFromWhere设置何值，都将从0开始消费</li>
<li>如果是一个新启动的消费者组，且消费者组订阅的消息不在broker的内存中，根据consumeFromWhere设置的获取对应的offset进行消费</li>
</ul>
<h2 id="克隆或重置消费者组的offset"><a href="#克隆或重置消费者组的offset" class="headerlink" title="克隆或重置消费者组的offset"></a>克隆或重置消费者组的offset</h2><p>根据分析结果，如果是一个已经存在的消费者组，如果想要跳过积压的消息，设置consumeFromWhere是无效的，但是可用通过rocketmq-dashboard或mqadmin重置offset。<br>如果是新建消费者组，不想要重头开始消费，可以在代码中做时间校验跳过历史消息，或者通过rocketmq-dashboard或mqadmin新建消费者组并重置offset。</p>
]]></content>
      <categories>
        <category>消息队列</category>
      </categories>
      <tags>
        <tag>RocketMQ</tag>
        <tag>ConsumeFromWhere</tag>
      </tags>
  </entry>
  <entry>
    <title>RocketMQ中Mmap原理分析及使用</title>
    <url>/2020/10/29/rockermq/rocketmq-zhong-mmap-yuan-li-fen-xi-ji-shi-yong/</url>
    <content><![CDATA[<h1 id="一、Mmap基础概念"><a href="#一、Mmap基础概念" class="headerlink" title="一、Mmap基础概念"></a>一、Mmap基础概念</h1><p>Mmap是一种内存映射文件的方法，即将一个文件或者其它对象映射到进程的地址空间，实现文件磁盘地址和进程虚拟地址空间中一段虚拟地址的一一对映关系。实现这样的映射关系后，进程就可以采用指针的方式读写操作这一段内存，而系统会自动回写脏页面到对应的文件磁盘上，即完成了对文件的操作而不必再调用read,write等系统调用函数。相反，内核空间对这段区域的修改也直接反映用户空间，从而可以实现不同进程间的文件共享。</p>
<h1 id="二、Mmap内存映射原理"><a href="#二、Mmap内存映射原理" class="headerlink" title="二、Mmap内存映射原理"></a>二、Mmap内存映射原理</h1><p><img src="/2020/10/29/rockermq/rocketmq-zhong-mmap-yuan-li-fen-xi-ji-shi-yong/Linux%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84mmap.png" alt="mmap内存映射"></p>
<blockquote>
<p>mmap内存映射的实现过程，总的来说可以分为三个阶段：</p>
</blockquote>
<h2 id="（一）进程启动映射过程，并在虚拟地址空间中为映射创建虚拟映射区域"><a href="#（一）进程启动映射过程，并在虚拟地址空间中为映射创建虚拟映射区域" class="headerlink" title="（一）进程启动映射过程，并在虚拟地址空间中为映射创建虚拟映射区域"></a>（一）进程启动映射过程，并在虚拟地址空间中为映射创建虚拟映射区域</h2><blockquote>
<p>1、进程在用户空间调用库函数mmap，原型：void *mmap(void *start, size_t length, int prot, int flags, int fd, off_t offset);</p>
<p>2、在当前进程的虚拟地址空间中，寻找一段空闲的满足要求的连续的虚拟地址</p>
<p>3、为此虚拟区分配一个vm_area_struct结构，接着对这个结构的各个域进行了初始化</p>
<p>4、将新建的虚拟区结构（vm_area_struct）插入进程的虚拟地址区域链表或树中</p>
</blockquote>
<h2 id="（二）调用内核空间的系统调用函数mmap（不同于用户空间函数），实现文件物理地址和进程虚拟地址的一一映射关系"><a href="#（二）调用内核空间的系统调用函数mmap（不同于用户空间函数），实现文件物理地址和进程虚拟地址的一一映射关系" class="headerlink" title="（二）调用内核空间的系统调用函数mmap（不同于用户空间函数），实现文件物理地址和进程虚拟地址的一一映射关系"></a>（二）调用内核空间的系统调用函数mmap（不同于用户空间函数），实现文件物理地址和进程虚拟地址的一一映射关系</h2><blockquote>
<p>5、为映射分配了新的虚拟地址区域后，通过待映射的文件指针，在文件描述符表中找到对应的文件描述符，通过文件描述符，链接到内核“已打开文件集”中该文件的文件结构体（struct file），每个文件结构体维护着和这个已打开文件相关各项信息。</p>
<p>6、通过该文件的文件结构体，链接到file_operations模块，调用内核函数mmap，其原型为：int mmap(struct file *filp, struct vm_area_struct *vma)，不同于用户空间库函数。</p>
<p>7、内核mmap函数通过虚拟文件系统inode模块定位到文件磁盘物理地址。</p>
<p>8、通过remap_pfn_range函数建立页表，即实现了文件地址和虚拟地址区域的映射关系。此时，这片虚拟地址并没有任何数据关联到主存中。</p>
</blockquote>
<h2 id="（三）进程发起对这片映射空间的访问，引发缺页异常，实现文件内容到物理内存（主存）的拷贝"><a href="#（三）进程发起对这片映射空间的访问，引发缺页异常，实现文件内容到物理内存（主存）的拷贝" class="headerlink" title="（三）进程发起对这片映射空间的访问，引发缺页异常，实现文件内容到物理内存（主存）的拷贝"></a>（三）进程发起对这片映射空间的访问，引发缺页异常，实现文件内容到物理内存（主存）的拷贝</h2><blockquote>
<p>注：前两个阶段仅在于创建虚拟区间并完成地址映射，但是并没有将任何文件数据的拷贝至主存。真正的文件读取是当进程发起读或写操作时。</p>
<p>9、进程的读或写操作访问虚拟地址空间这一段映射地址，通过查询页表，发现这一段地址并不在物理页面上。因为目前只建立了地址映射，真正的硬盘数据还没有拷贝到内存中，因此引发缺页异常。</p>
<p>10、缺页异常进行一系列判断，确定无非法操作后，内核发起请求调页过程。</p>
<p>11、调页过程先在交换缓存空间（swap cache）中寻找需要访问的内存页，如果没有则调用nopage函数把所缺的页从磁盘装入到主存中。</p>
<p>12、之后进程即可对这片主存进行读或者写的操作，如果写操作改变了其内容，一定时间后系统会自动回写脏页面到对应磁盘地址，也即完成了写入到文件的过程。</p>
<p>注：修改过的脏页面并不会立即更新回文件中，而是有一段时间的延迟，可以调用msync()来强制同步, 这样所写的内容就能立即保存到文件里了。</p>
</blockquote>
<h1 id="三、Mmap方式和常规文件操作区别"><a href="#三、Mmap方式和常规文件操作区别" class="headerlink" title="三、Mmap方式和常规文件操作区别"></a>三、Mmap方式和常规文件操作区别</h1><p>常规文件系统操作（调用read&#x2F;fread等类函数）中，函数的调用过程：</p>
<p>1、进程发起读文件请求。</p>
<p>2、内核通过查找进程文件符表，定位到内核已打开文件集上的文件信息，从而找到此文件的inode。</p>
<p>3、inode在address_space上查找要请求的文件页是否已经缓存在页缓存中。如果存在，则直接返回这片文件页的内容。</p>
<p>4、如果不存在，则通过inode定位到文件磁盘地址，将数据从磁盘复制到页缓存。之后再次发起读页面过程，进而将页缓存中的数据发给用户进程。</p>
<blockquote>
<p>总结来说，常规文件操作为了提高读写效率和保护磁盘，使用了页缓存机制。这样造成读文件时需要先将文件页从磁盘拷贝到页缓存中，由于页缓存处在内核空间，不能被用户进程直接寻址，所以还需要将页缓存中数据页再次拷贝到内存对应的用户空间中。这样，通过了两次数据拷贝过程，才能完成进程对文件内容的获取任务。写操作也是一样，待写入的buffer在内核空间不能直接访问，必须要先拷贝至内核空间对应的主存，再写回磁盘中（延迟写回），也是需要两次数据拷贝。</p>
<p>而使用mmap操作文件中，创建新的虚拟内存区域和建立文件磁盘地址和虚拟内存区域映射这两步，没有任何文件拷贝操作。而之后访问数据时发现内存中并无数据而发起的缺页异常过程，可以通过已经建立好的映射关系，只使用一次数据拷贝，就从磁盘中将数据传入内存的用户空间中，供进程使用。</p>
<p>总而言之，常规文件操作需要从磁盘到页缓存再到用户主存的两次数据拷贝。而mmap操控文件，只需要从磁盘到用户主存的一次数据拷贝过程。说白了，mmap的关键点是实现了用户空间和内核空间的数据直接交互而省去了空间不同数据不通的繁琐过程。因此mmap效率更高。</p>
</blockquote>
<h1 id="四、Mmap的优点"><a href="#四、Mmap的优点" class="headerlink" title="四、Mmap的优点"></a>四、Mmap的优点</h1><p>由上文讨论可知，mmap优点共有一下几点：</p>
<p>1、对文件的读取操作跨过了页缓存，减少了数据的拷贝次数，用内存读写取代I&#x2F;O读写，提高了文件读取效率。</p>
<p>2、实现了用户空间和内核空间的高效交互方式。两空间的各自修改操作可以直接反映在映射的区域内，从而被对方空间及时捕捉。</p>
<p>3、提供进程间共享内存及相互通信的方式。不管是父子进程还是无亲缘关系的进程，都可以将自身用户空间映射到同一个文件或匿名映射到同一片区域。从而通过各自对映射区域的改动，达到进程间通信和进程间共享的目的。</p>
<p>同时，如果进程A和进程B都映射了区域C，当A第一次读取C时通过缺页从磁盘复制文件页到内存中；但当B再读C的相同页面时，虽然也会产生缺页异常，但是不再需要从磁盘中复制文件过来，而可直接使用已经保存在内存中的文件数据。</p>
<p>4、可用于实现高效的大规模数据传输。内存空间不足，是制约大数据操作的一个方面，解决方案往往是借助硬盘空间协助操作，补充内存的不足。但是进一步会造成大量的文件I&#x2F;O操作，极大影响效率。这个问题可以通过mmap映射很好的解决。换句话说，但凡是需要用磁盘空间代替内存的时候，mmap都可以发挥其功效。</p>
<h1 id="五、Mmap在java中应用"><a href="#五、Mmap在java中应用" class="headerlink" title="五、Mmap在java中应用"></a>五、Mmap在java中应用</h1><h2 id="5-1-Java中Mmap的使用"><a href="#5-1-Java中Mmap的使用" class="headerlink" title="5.1 Java中Mmap的使用"></a>5.1 Java中Mmap的使用</h2><pre class="line-numbers language-none"><code class="language-none">RandomAccessFile  raf &#x3D; new RandomAccessFile(&quot;C:\\Users\\0959\\Desktop\\mmap-test.txt&quot;, &quot;rw&quot;);
MappedByteBuffer mappedByteBuffer &#x3D; raf.getChannel().map(FileChannel.MapMode.READ_WRITE, 0, FILE_SIZE);
raf.close();
mappedByteBuffer.put(content.getBytes());
mappedByteBuffer.force();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="5-2-FileChannel-map-详解"><a href="#5-2-FileChannel-map-详解" class="headerlink" title="5.2 FileChannel.map()详解"></a>5.2 FileChannel.map()详解</h2><pre class="line-numbers language-$java" data-language="$java"><code class="language-$java">&#x2F;**
 * Maps a region of this channel&#39;s file directly into memory.
 *
 * &lt;p&gt; A region of a file may be mapped into memory in one of three modes:
 * &lt;&#x2F;p&gt;
 *
 * &lt;ul&gt;
 *
 *   &lt;li&gt;&lt;p&gt; &lt;i&gt;Read-only:&lt;&#x2F;i&gt; Any attempt to modify the resulting buffer
 *   will cause a &#123;@link java.nio.ReadOnlyBufferException&#125; to be thrown.
 *   (&#123;@link MapMode#READ_ONLY MapMode.READ_ONLY&#125;) &lt;&#x2F;p&gt;&lt;&#x2F;li&gt;
 *
 *   &lt;li&gt;&lt;p&gt; &lt;i&gt;Read&#x2F;write:&lt;&#x2F;i&gt; Changes made to the resulting buffer will
 *   eventually be propagated to the file; they may or may not be made
 *   visible to other programs that have mapped the same file.  (&#123;@link
 *   MapMode#READ_WRITE MapMode.READ_WRITE&#125;) &lt;&#x2F;p&gt;&lt;&#x2F;li&gt;
 *
 *   &lt;li&gt;&lt;p&gt; &lt;i&gt;Private:&lt;&#x2F;i&gt; Changes made to the resulting buffer will not
 *   be propagated to the file and will not be visible to other programs
 *   that have mapped the same file; instead, they will cause private
 *   copies of the modified portions of the buffer to be created.  (&#123;@link
 *   MapMode#PRIVATE MapMode.PRIVATE&#125;) &lt;&#x2F;p&gt;&lt;&#x2F;li&gt;
 *
 * &lt;&#x2F;ul&gt;
 *
 * &lt;p&gt; For a read-only mapping, this channel must have been opened for
 * reading; for a read&#x2F;write or private mapping, this channel must have
 * been opened for both reading and writing.
 *
 * &lt;p&gt; The &#123;@link MappedByteBuffer &lt;i&gt;mapped byte buffer&lt;&#x2F;i&gt;&#125;
 * returned by this method will have a position of zero and a limit and
 * capacity of &lt;tt&gt;size&lt;&#x2F;tt&gt;; its mark will be undefined.  The buffer and
 * the mapping that it represents will remain valid until the buffer itself
 * is garbage-collected.
 *
 * &lt;p&gt; A mapping, once established, is not dependent upon the file channel
 * that was used to create it.  Closing the channel, in particular, has no
 * effect upon the validity of the mapping.
 *
 * &lt;p&gt; Many of the details of memory-mapped files are inherently dependent
 * upon the underlying operating system and are therefore unspecified.  The
 * behavior of this method when the requested region is not completely
 * contained within this channel&#39;s file is unspecified.  Whether changes
 * made to the content or size of the underlying file, by this program or
 * another, are propagated to the buffer is unspecified.  The rate at which
 * changes to the buffer are propagated to the file is unspecified.
 *
 * &lt;p&gt; For most operating systems, mapping a file into memory is more
 * expensive than reading or writing a few tens of kilobytes of data via
 * the usual &#123;@link #read read&#125; and &#123;@link #write write&#125; methods.  From the
 * standpoint of performance it is generally only worth mapping relatively
 * large files into memory.  &lt;&#x2F;p&gt;
 *
 * @param  mode
 *         One of the constants &#123;@link MapMode#READ_ONLY READ_ONLY&#125;, &#123;@link
 *         MapMode#READ_WRITE READ_WRITE&#125;, or &#123;@link MapMode#PRIVATE
 *         PRIVATE&#125; defined in the &#123;@link MapMode&#125; class, according to
 *         whether the file is to be mapped read-only, read&#x2F;write, or
 *         privately (copy-on-write), respectively
 *
 * @param  position
 *         The position within the file at which the mapped region
 *         is to start; must be non-negative
 *
 * @param  size
 *         The size of the region to be mapped; must be non-negative and
 *         no greater than &#123;@link java.lang.Integer#MAX_VALUE&#125;
 *
 * @return  The mapped byte buffer
 *
 * @throws NonReadableChannelException
 *         If the &lt;tt&gt;mode&lt;&#x2F;tt&gt; is &#123;@link MapMode#READ_ONLY READ_ONLY&#125; but
 *         this channel was not opened for reading
 *
 * @throws NonWritableChannelException
 *         If the &lt;tt&gt;mode&lt;&#x2F;tt&gt; is &#123;@link MapMode#READ_WRITE READ_WRITE&#125; or
 *         &#123;@link MapMode#PRIVATE PRIVATE&#125; but this channel was not opened
 *         for both reading and writing
 *
 * @throws IllegalArgumentException
 *         If the preconditions on the parameters do not hold
 *
 * @throws IOException
 *         If some other I&#x2F;O error occurs
 *
 * @see java.nio.channels.FileChannel.MapMode
 * @see java.nio.MappedByteBuffer
 *&#x2F;
public abstract MappedByteBuffer map(MapMode mode,
                                     long position, long size)
    throws IOException;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>（1）将FileChannle对于的文件的一部分直接映射到内存。（这里的内存是堆外内存）<br>（2）映射模式可以是MapMode.READ_ONLY(只读)，MapMode.READ_WRITE(读写)，MapMode.PRIVATE（私有，写时复制）<br>（3）如果是只读模式映射，那么文件通道必须是以只读模式打开。<br>（4）方法返回的MappedByteBuffer的position是0，limit 和 capacity的值是参数size的值。<br>（5）一旦映射完成，那么该MappedByteBuffer就和创建它的FileChannel无关。关闭FileChannel不会影响该MappedByteBuffer。<br>（6）该方法的底层实现依赖于具体操作系统中mmap系统调用的实现逻辑。不同的操作系统可能表现不同。例如：程序修改了MappedByteBuffer的内容，操作系统何时将变更写入到磁盘，这个是不确定的。<br>（7）对大多数操作系统来说该方法都是一个昂贵的操作，如果仅仅是映射很小范围，那么不建议使用。针对大文件推荐使用该操作。</p>
<h2 id="5-3-MappedByteBuffer详解"><a href="#5-3-MappedByteBuffer详解" class="headerlink" title="5.3 MappedByteBuffer详解"></a>5.3 MappedByteBuffer详解</h2><p>MappedByteBuffer本质上是一块堆外内存，也就是DirectByteBuffer。通过FileChannel.map来创建，直到被GC才结束它的生命。</p>
<blockquote>
<p>load()方法</p>
</blockquote>
<p>加载该缓存的内容到物理内存中。这是因为mapp完成后，OS并没有直接读取文件的内容，当真正要访问的时候，通过缺页异常来进行读磁盘操作。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
    * Loads this buffer's content into physical memory.
    *
    * &lt;p> This method makes a best effort to ensure that, when it returns,
    * this buffer's content is resident in physical memory.  Invoking this
    * method may cause some number of page faults and I/O operations to
    * occur. &lt;/p>
    *
    * @return  This buffer
    */</span>
   <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">MappedByteBuffer</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       <span class="token function">checkMapped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>address <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
       <span class="token keyword">long</span> offset <span class="token operator">=</span> <span class="token function">mappingOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">long</span> length <span class="token operator">=</span> <span class="token function">mappingLength</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">load0</span><span class="token punctuation">(</span><span class="token function">mappingAddress</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">// Read a byte from each page to bring it into memory. A checksum</span>
       <span class="token comment">// is computed as we go along to prevent the compiler from otherwise</span>
       <span class="token comment">// considering the loop as dead code.</span>
       <span class="token class-name">Unsafe</span> unsafe <span class="token operator">=</span> <span class="token class-name">Unsafe</span><span class="token punctuation">.</span><span class="token function">getUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">int</span> ps <span class="token operator">=</span> <span class="token class-name">Bits</span><span class="token punctuation">.</span><span class="token function">pageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token class-name">Bits</span><span class="token punctuation">.</span><span class="token function">pageCount</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">long</span> a <span class="token operator">=</span> <span class="token function">mappingAddress</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">byte</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
           x <span class="token operator">^=</span> unsafe<span class="token punctuation">.</span><span class="token function">getByte</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
           a <span class="token operator">+=</span> ps<span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>unused <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
           unused <span class="token operator">=</span> x<span class="token punctuation">;</span>

       <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>force()方法</p>
</blockquote>
<p>强制将修改后的的内容写入到存储设备上。<br>需要注意的是：如果是本地设备，那么该方法返回时，确保自从该缓存区创建后或该方法最后一次调用后，变更的内容一定写入了设备，如果是网络文件则没有该保证。<br>如果不是通过<code>MapMode.READ_WRITE</code>模式映射的，调用该方法没有任何影响。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
     * Forces any changes made to this buffer's content to be written to the
     * storage device containing the mapped file.
     *
     * &lt;p> If the file mapped into this buffer resides on a local storage
     * device then when this method returns it is guaranteed that all changes
     * made to the buffer since it was created, or since this method was last
     * invoked, will have been written to that device.
     *
     * &lt;p> If the file does not reside on a local device then no such guarantee
     * is made.
     *
     * &lt;p> If this buffer was not mapped in read/write mode (&#123;@link
     * java.nio.channels.FileChannel.MapMode#READ_WRITE&#125;) then invoking this
     * method has no effect. &lt;/p>
     *
     * @return  This buffer
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">MappedByteBuffer</span> <span class="token function">force</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">checkMapped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>address <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">long</span> offset <span class="token operator">=</span> <span class="token function">mappingOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">force0</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token function">mappingAddress</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mappingLength</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>关于force方法多说一点：即使我们不手动调动该方法写缓存区的更改写入底层设备，操作系统底层也会定时将变更的脏页刷到设备上，不过时间不确定。</p>
<p>MappedByteBuffer 在我们关闭FileChannel和文件后如果还没有被GC，那么对于的文件也是无法删除的，因为底层的文件句柄还没有释放。在RocketMQ中有专门针对该问题编写的代码。具体如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">clean</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ByteBuffer</span> buffer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>buffer<span class="token punctuation">.</span><span class="token function">isDirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> buffer<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token function">viewed</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"cleaner"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"clean"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>作用是获取DirectByteBuffer中的Cleaner，然后调用它的clean方法来回收该DirectByteBuffer，也就是MappedByteBuffer。</p>
<p>Cleaner底层是通过unsafe.freeMemory(address);来释放内存的。</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><blockquote>
<p><a href="https://www.cnblogs.com/huxiao-tee/p/4660352.html">认真分析mmap：是什么 为什么 怎么用</a></p>
<p><a href="https://www.cnblogs.com/huxiao-tee/p/4657851.html">从内核文件系统看文件读写过程</a></p>
<p><a href="https://blog.csdn.net/yusiguyuan/article/details/23388771">linux内存映射mmap原理分析</a></p>
<p><a href="https://leokongwq.github.io/2019/09/12/java-mmap.html">java 中的内存映射</a></p>
</blockquote>
]]></content>
      <categories>
        <category>消息队列</category>
      </categories>
      <tags>
        <tag>RocketMQ</tag>
        <tag>Mmap</tag>
      </tags>
  </entry>
  <entry>
    <title>RocketMQ消息存储</title>
    <url>/2020/09/10/rockermq/rocketmq-xiao-xi-cun-chu/</url>
    <content><![CDATA[<h1 id="一、消息存储架构图"><a href="#一、消息存储架构图" class="headerlink" title="一、消息存储架构图"></a>一、消息存储架构图</h1><p><img src="/2020/09/10/rockermq/rocketmq-xiao-xi-cun-chu/rocketmq_design_1.png" alt="消息存储架构图"></p>
<h1 id="二、消息存储"><a href="#二、消息存储" class="headerlink" title="二、消息存储"></a>二、消息存储</h1><h2 id="2-1-消息存储文件"><a href="#2-1-消息存储文件" class="headerlink" title="2.1 消息存储文件"></a>2.1 消息存储文件</h2><table>
<thead>
<tr>
<th>文件名称</th>
<th>作用</th>
<th>文件大小</th>
<th>文件格式</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>CommitLog</td>
<td>消息主体以及元数据的存储主体</td>
<td>单个文件大小默认1G</td>
<td>消息顺序写入文件，当文件满了，写入下一个文件</td>
<td>文件名为20位，如一个文件名为00000000000000000000代表以一个文件，起始偏移量为0，文件大小为1G&#x3D;1073741824，后面新增文件的名称基于上一个文件名累加1G，起始偏移量从上一个文件继续累计。</td>
</tr>
<tr>
<td>ConsumeQueue</td>
<td>消息消费队列</td>
<td>每个条目20个字节，单个文件由30W个条目组成</td>
<td>每一个条目共20个字节，分别为8字节的commitlog物理偏移量、4字节的消息长度、8字节tag hashcode</td>
<td>单个文件由30W个条目组成，可以像数组一样随机访问每一个条目，每个ConsumeQueue文件大小约5.72M</td>
</tr>
<tr>
<td>IndexFile</td>
<td>索引文件</td>
<td>固定的单个IndexFile文件大小约为400M，一个IndexFile可以保存 2000W个索引</td>
<td>IndexFile的底层存储设计为在文件系统中实现HashMap结构</td>
<td>rocketmq的索引文件其底层实现为hash索引</td>
</tr>
</tbody></table>
<h2 id="2-2-存储结构分析"><a href="#2-2-存储结构分析" class="headerlink" title="2.2 存储结构分析"></a>2.2 存储结构分析</h2><ol>
<li>Broker单个实例下所有的队列共用一个日志数据文件（即为CommitLog）来存储。</li>
<li>多个Topic的消息实体内容都存储于一个CommitLog中</li>
<li>RocketMQ的混合型存储结构针对Producer和Consumer分别采用了数据和索引部分相分离的存储结构</li>
</ol>
]]></content>
      <categories>
        <category>消息队列</category>
      </categories>
      <tags>
        <tag>RocketMQ</tag>
        <tag>消息存储</tag>
      </tags>
  </entry>
  <entry>
    <title>RocketMQ中的Consumer及ConsumerGroup详解</title>
    <url>/2021/09/05/rockermq/rocketmq-zhong-de-consumer-ji-consumergroup-xiang-jie/</url>
    <content><![CDATA[<h1 id="一、基本概念"><a href="#一、基本概念" class="headerlink" title="一、基本概念"></a>一、基本概念</h1><h2 id="消息消费者（Consumer）"><a href="#消息消费者（Consumer）" class="headerlink" title="消息消费者（Consumer）"></a>消息消费者（Consumer）</h2><p>负责消费消息，一般是后台系统负责异步消费。一个消息消费者会从Broker服务器拉取消息、并将其提供给应用程序。从用户应用的角度而言提供了两种消费形式：拉取式消费、推动式消费。</p>
<h2 id="消费者组（Consumer-Group）"><a href="#消费者组（Consumer-Group）" class="headerlink" title="消费者组（Consumer Group）"></a>消费者组（Consumer Group）</h2><p>同一类Consumer的集合，这类Consumer通常消费同一类消息且消费逻辑一致。消费者组使得在消息消费方面，实现负载均衡和容错的目标变得非常容易。要注意的是，消费者组的消费者实例必须订阅完全相同的Topic。RocketMQ 支持两种消息模式：集群消费（Clustering）和广播消费（Broadcasting）。</p>
<h2 id="集群消费（Clustering）"><a href="#集群消费（Clustering）" class="headerlink" title="集群消费（Clustering）"></a>集群消费（Clustering）</h2><p>集群消费模式下,相同Consumer Group的每个Consumer实例平均分摊消息。</p>
<h2 id="广播消费（Broadcasting）"><a href="#广播消费（Broadcasting）" class="headerlink" title="广播消费（Broadcasting）"></a>广播消费（Broadcasting）</h2><p>广播消费模式下，相同Consumer Group的每个Consumer实例都接收全量的消息。</p>
<h1 id="二、订阅关系一致"><a href="#二、订阅关系一致" class="headerlink" title="二、订阅关系一致"></a>二、订阅关系一致</h1><p>订阅关系一致指的是同一个消费者Group ID下所有Consumer实例所订阅的Topic、Tag必须完全一致。如果订阅关系不一致，消息消费的逻辑就会混乱，甚至导致消息丢失。</p>
<h2 id="背景信息"><a href="#背景信息" class="headerlink" title="背景信息"></a>背景信息</h2><p>消息队列RocketMQ版里的一个消费者Group ID代表一个Consumer实例群组。对于大多数分布式应用来说，一个消费者Group ID下通常会挂载多个Consumer实例。</p>
<p>由于消息队列RocketMQ版的订阅关系主要由Topic+Tag共同组成，因此，保持订阅关系一致意味着同一个消费者Group ID下所有的Consumer实例需在以下方面均保持一致：</p>
<ul>
<li>订阅的Topic必须一致，例如：Consumer1订阅TopicA和TopicB，Consumer2也必须订阅TopicA和TopicB，不能只订阅TopicA、只订阅TopicB或订阅TopicA和TopicC。</li>
<li>订阅的同一个Topic中的Tag必须一致，包括Tag的数量和Tag的顺序，例如：Consumer1订阅TopicB且Tag为Tag1||Tag2，Consumer2订阅TopicB的Tag也必须是Tag1||Tag2，不能只订阅Tag1、只订阅Tag2或者订阅Tag2||Tag1。</li>
</ul>
<p>正确的订阅关系如下，多个Group ID分别订阅了不同的Topic，但是同一个Group ID下的多个Consumer实例C1、C2、C3订阅的Topic和Tag都一致。<br><img src="/2021/09/05/rockermq/rocketmq-zhong-de-consumer-ji-consumergroup-xiang-jie/RocketMQ%E8%AE%A2%E9%98%85%E5%85%B3%E7%B3%BB.png" alt="RocketMQ订阅关系"></p>
<h1 id="三、订阅关系不一致"><a href="#三、订阅关系不一致" class="headerlink" title="三、订阅关系不一致"></a>三、订阅关系不一致</h1><p>当RocketMQ订阅关系不一致时，消息消费的逻辑就会混乱，甚至导致消息丢失，接下来我们结合案例及源码做进一步验证分析。</p>
<blockquote>
<p>RocketMQ Version : 4.8.0</p>
</blockquote>
<h2 id="消费者组内消费者订阅相同的Topic不同的Tag"><a href="#消费者组内消费者订阅相同的Topic不同的Tag" class="headerlink" title="消费者组内消费者订阅相同的Topic不同的Tag"></a>消费者组内消费者订阅相同的Topic不同的Tag</h2><p>RocketMQ相同消费者组内订阅相同Topic不同Tag的测试基本信息：</p>
<ul>
<li>Topic名称： SUBSCRIBE_TEST</li>
<li>Topic读队列数量：4</li>
<li>Topic写队列数量：4</li>
<li>Topic读写权限：6</li>
<li>消费者组名称： SUBSCRIBE_TEST_CONSUMER_GROUP</li>
<li>消息TAG类型： TagA，TagB</li>
<li>TagA消息消费者： ConsumerForTagA</li>
<li>TagB消息消费者： ConsumerForTagB</li>
</ul>
<h2 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h2><ul>
<li><code>ConsumerForTagA</code>订阅信息： 订阅Topic<code>SUBSCRIBE_TEST</code> 和<code>tagA</code></li>
<li><code>ConsumerForTagB</code>订阅信息： 订阅Topic<code>SUBSCRIBE_TEST</code> 和<code>tagB</code></li>
</ul>
<h3 id="消费者代码示例："><a href="#消费者代码示例：" class="headerlink" title="消费者代码示例："></a>消费者代码示例：</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerForTagA</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MQClientException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"SUBSCRIBE_TEST_CONSUMER_GROUP"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"172.16.1.15:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"SUBSCRIBE_TEST"</span><span class="token punctuation">,</span> <span class="token string">"tagA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">ConsumeConcurrentlyStatus</span> <span class="token function">consumeMessage</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">></span></span> msgs<span class="token punctuation">,</span> <span class="token class-name">ConsumeConcurrentlyContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Receive New Messages: %s %n"</span><span class="token punctuation">,</span> msgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span><span class="token constant">CONSUME_SUCCESS</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ConsumerForTagA started!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerForTagB</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MQClientException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">DefaultMQPushConsumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"SUBSCRIBE_TEST_CONSUMER_GROUP"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"172.16.1.15:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"SUBSCRIBE_TEST"</span><span class="token punctuation">,</span> <span class="token string">"tagB"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">ConsumeConcurrentlyStatus</span> <span class="token function">consumeMessage</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">></span></span> msgs<span class="token punctuation">,</span> <span class="token class-name">ConsumeConcurrentlyContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Receive New Messages: %s %n"</span><span class="token punctuation">,</span> msgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token class-name">ConsumeConcurrentlyStatus</span><span class="token punctuation">.</span><span class="token constant">CONSUME_SUCCESS</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ConsumerForTagB started!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="先启动ConsumerForTagA再启动ConsumerForTagB"><a href="#先启动ConsumerForTagA再启动ConsumerForTagB" class="headerlink" title="先启动ConsumerForTagA再启动ConsumerForTagB"></a>先启动ConsumerForTagA再启动ConsumerForTagB</h3><h2 id="生产者"><a href="#生产者" class="headerlink" title="生产者"></a>生产者</h2><p>生产者向<code>SUBSCRIBE_TEST</code>Topic中写入8条消息，前4条消息的TAG为<code>tagA</code>，后4条消息的TAG为<code>tagB</code>.</p>
<h3 id="生产者代码示例"><a href="#生产者代码示例" class="headerlink" title="生产者代码示例"></a>生产者代码示例</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SyncProducer</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MQClientException</span><span class="token punctuation">,</span> <span class="token class-name">RemotingException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">MQBrokerException</span><span class="token punctuation">,</span> <span class="token class-name">UnsupportedEncodingException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"SUBSCRIBE_TEST_PRODUCER_GROUP"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"172.16.1.15:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">setSendMsgTimeout</span><span class="token punctuation">(</span><span class="token number">15000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> tag <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"tagA"</span> <span class="token operator">:</span> <span class="token string">"tagB"</span><span class="token punctuation">;</span>
            <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">"SUBSCRIBE_TEST"</span><span class="token punctuation">,</span> tag<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"MsgStr"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_CHARSET</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">SendResult</span> sendResult <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s%n"</span><span class="token punctuation">,</span> sendResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="启动生产者发送消息"><a href="#启动生产者发送消息" class="headerlink" title="启动生产者发送消息"></a>启动生产者发送消息</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">SendResult</span> <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span><span class="token constant">SEND_OK</span><span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token constant">AC10DFD6121618B4AAC216EE4B9C0000</span><span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span><span class="token constant">AC10010F00002A9F00000017038663BE</span><span class="token punctuation">,</span> messageQueue<span class="token operator">=</span><span class="token class-name">MessageQueue</span> <span class="token punctuation">[</span>topic<span class="token operator">=</span><span class="token constant">SUBSCRIBE_TEST</span><span class="token punctuation">,</span> brokerName<span class="token operator">=</span>broker<span class="token operator">-</span><span class="token number">172.16</span><span class="token number">.1</span><span class="token number">.15</span><span class="token operator">:</span><span class="token number">10911</span><span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token class-name">SendResult</span> <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span><span class="token constant">SEND_OK</span><span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token constant">AC10DFD6121618B4AAC216EE4C040001</span><span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span><span class="token constant">AC10010F00002A9F0000001703866483</span><span class="token punctuation">,</span> messageQueue<span class="token operator">=</span><span class="token class-name">MessageQueue</span> <span class="token punctuation">[</span>topic<span class="token operator">=</span><span class="token constant">SUBSCRIBE_TEST</span><span class="token punctuation">,</span> brokerName<span class="token operator">=</span>broker<span class="token operator">-</span><span class="token number">172.16</span><span class="token number">.1</span><span class="token number">.15</span><span class="token operator">:</span><span class="token number">10911</span><span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token class-name">SendResult</span> <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span><span class="token constant">SEND_OK</span><span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token constant">AC10DFD6121618B4AAC216EE4C760002</span><span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span><span class="token constant">AC10010F00002A9F0000001703866548</span><span class="token punctuation">,</span> messageQueue<span class="token operator">=</span><span class="token class-name">MessageQueue</span> <span class="token punctuation">[</span>topic<span class="token operator">=</span><span class="token constant">SUBSCRIBE_TEST</span><span class="token punctuation">,</span> brokerName<span class="token operator">=</span>broker<span class="token operator">-</span><span class="token number">172.16</span><span class="token number">.1</span><span class="token number">.15</span><span class="token operator">:</span><span class="token number">10911</span><span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token class-name">SendResult</span> <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span><span class="token constant">SEND_OK</span><span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token constant">AC10DFD6121618B4AAC216EE4C890003</span><span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span><span class="token constant">AC10010F00002A9F000000170386660D</span><span class="token punctuation">,</span> messageQueue<span class="token operator">=</span><span class="token class-name">MessageQueue</span> <span class="token punctuation">[</span>topic<span class="token operator">=</span><span class="token constant">SUBSCRIBE_TEST</span><span class="token punctuation">,</span> brokerName<span class="token operator">=</span>broker<span class="token operator">-</span><span class="token number">172.16</span><span class="token number">.1</span><span class="token number">.15</span><span class="token operator">:</span><span class="token number">10911</span><span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token class-name">SendResult</span> <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span><span class="token constant">SEND_OK</span><span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token constant">AC10DFD6121618B4AAC216EE4CBE0004</span><span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span><span class="token operator">*</span><span class="token operator">*</span><span class="token constant">AC10010F00002A9F00000017038666D2</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">,</span> messageQueue<span class="token operator">=</span><span class="token class-name">MessageQueue</span> <span class="token punctuation">[</span>topic<span class="token operator">=</span><span class="token constant">SUBSCRIBE_TEST</span><span class="token punctuation">,</span> brokerName<span class="token operator">=</span>broker<span class="token operator">-</span><span class="token number">172.16</span><span class="token number">.1</span><span class="token number">.15</span><span class="token operator">:</span><span class="token number">10911</span><span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token class-name">SendResult</span> <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span><span class="token constant">SEND_OK</span><span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token constant">AC10DFD6121618B4AAC216EE4D190005</span><span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span><span class="token operator">*</span><span class="token operator">*</span><span class="token constant">AC10010F00002A9F0000001703866797</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">,</span> messageQueue<span class="token operator">=</span><span class="token class-name">MessageQueue</span> <span class="token punctuation">[</span>topic<span class="token operator">=</span><span class="token constant">SUBSCRIBE_TEST</span><span class="token punctuation">,</span> brokerName<span class="token operator">=</span>broker<span class="token operator">-</span><span class="token number">172.16</span><span class="token number">.1</span><span class="token number">.15</span><span class="token operator">:</span><span class="token number">10911</span><span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token class-name">SendResult</span> <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span><span class="token constant">SEND_OK</span><span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token constant">AC10DFD6121618B4AAC216EE4D380006</span><span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span><span class="token constant">AC10010F00002A9F000000170386685C</span><span class="token punctuation">,</span> messageQueue<span class="token operator">=</span><span class="token class-name">MessageQueue</span> <span class="token punctuation">[</span>topic<span class="token operator">=</span><span class="token constant">SUBSCRIBE_TEST</span><span class="token punctuation">,</span> brokerName<span class="token operator">=</span>broker<span class="token operator">-</span><span class="token number">172.16</span><span class="token number">.1</span><span class="token number">.15</span><span class="token operator">:</span><span class="token number">10911</span><span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token class-name">SendResult</span> <span class="token punctuation">[</span>sendStatus<span class="token operator">=</span><span class="token constant">SEND_OK</span><span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token constant">AC10DFD6121618B4AAC216EE4DE50007</span><span class="token punctuation">,</span> offsetMsgId<span class="token operator">=</span><span class="token constant">AC10010F00002A9F0000001703866921</span><span class="token punctuation">,</span> messageQueue<span class="token operator">=</span><span class="token class-name">MessageQueue</span> <span class="token punctuation">[</span>topic<span class="token operator">=</span><span class="token constant">SUBSCRIBE_TEST</span><span class="token punctuation">,</span> brokerName<span class="token operator">=</span>broker<span class="token operator">-</span><span class="token number">172.16</span><span class="token number">.1</span><span class="token number">.15</span><span class="token operator">:</span><span class="token number">10911</span><span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="消费者消费消息情况"><a href="#消费者消费消息情况" class="headerlink" title="消费者消费消息情况"></a>消费者消费消息情况</h2><p>ConsumerForTagA未消费到消息。<br>ConsumerForTagB消费到2条消息，消息内容如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Receive</span> <span class="token class-name">New</span> <span class="token class-name">Messages</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token class-name">MessageExt</span> <span class="token punctuation">[</span>brokerName<span class="token operator">=</span>broker<span class="token operator">-</span><span class="token number">172.16</span><span class="token number">.1</span><span class="token number">.15</span><span class="token operator">:</span><span class="token number">10911</span><span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> storeSize<span class="token operator">=</span><span class="token number">197</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> sysFlag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> bornTimestamp<span class="token operator">=</span><span class="token number">1630810315966</span><span class="token punctuation">,</span> bornHost<span class="token operator">=</span><span class="token operator">/</span><span class="token number">172.16</span><span class="token number">.0</span><span class="token number">.103</span><span class="token operator">:</span><span class="token number">62659</span><span class="token punctuation">,</span> storeTimestamp<span class="token operator">=</span><span class="token number">1630810316147</span><span class="token punctuation">,</span> storeHost<span class="token operator">=</span><span class="token operator">/</span><span class="token number">172.16</span><span class="token number">.1</span><span class="token number">.15</span><span class="token operator">:</span><span class="token number">10911</span><span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token operator">*</span><span class="token operator">*</span><span class="token constant">AC10010F00002A9F00000017038666D2</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">,</span> commitLogOffset<span class="token operator">=</span><span class="token number">98843387602</span><span class="token punctuation">,</span> bodyCRC<span class="token operator">=</span><span class="token number">686395636</span><span class="token punctuation">,</span> reconsumeTimes<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> preparedTransactionOffset<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token class-name">Message</span><span class="token punctuation">&#123;</span>topic<span class="token operator">=</span>'<span class="token constant">SUBSCRIBE_TEST</span>'<span class="token punctuation">,</span> flag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> properties<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token constant">MIN_OFFSET</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">MAX_OFFSET</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token constant">CONSUME_START_TIME</span><span class="token operator">=</span><span class="token number">1630810316068</span><span class="token punctuation">,</span> <span class="token constant">UNIQ_KEY</span><span class="token operator">=</span><span class="token constant">AC10DFD6121618B4AAC216EE4CBE0004</span><span class="token punctuation">,</span> <span class="token constant">CLUSTER</span><span class="token operator">=</span><span class="token class-name">DefaultCluster</span><span class="token punctuation">,</span> <span class="token constant">WAIT</span><span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token constant">TAGS</span><span class="token operator">=</span>tagB<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> body<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">77</span><span class="token punctuation">,</span> <span class="token number">115</span><span class="token punctuation">,</span> <span class="token number">103</span><span class="token punctuation">,</span> <span class="token number">83</span><span class="token punctuation">,</span> <span class="token number">116</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">52</span><span class="token punctuation">]</span><span class="token punctuation">,</span> transactionId<span class="token operator">=</span><span class="token char">'null'</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">]</span> 
<span class="token class-name">Receive</span> <span class="token class-name">New</span> <span class="token class-name">Messages</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token class-name">MessageExt</span> <span class="token punctuation">[</span>brokerName<span class="token operator">=</span>broker<span class="token operator">-</span><span class="token number">172.16</span><span class="token number">.1</span><span class="token number">.15</span><span class="token operator">:</span><span class="token number">10911</span><span class="token punctuation">,</span> queueId<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> storeSize<span class="token operator">=</span><span class="token number">197</span><span class="token punctuation">,</span> queueOffset<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> sysFlag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> bornTimestamp<span class="token operator">=</span><span class="token number">1630810316057</span><span class="token punctuation">,</span> bornHost<span class="token operator">=</span><span class="token operator">/</span><span class="token number">172.16</span><span class="token number">.0</span><span class="token number">.103</span><span class="token operator">:</span><span class="token number">62659</span><span class="token punctuation">,</span> storeTimestamp<span class="token operator">=</span><span class="token number">1630810316223</span><span class="token punctuation">,</span> storeHost<span class="token operator">=</span><span class="token operator">/</span><span class="token number">172.16</span><span class="token number">.1</span><span class="token number">.15</span><span class="token operator">:</span><span class="token number">10911</span><span class="token punctuation">,</span> msgId<span class="token operator">=</span><span class="token operator">*</span><span class="token operator">*</span><span class="token constant">AC10010F00002A9F0000001703866797</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">,</span> commitLogOffset<span class="token operator">=</span><span class="token number">98843387799</span><span class="token punctuation">,</span> bodyCRC<span class="token operator">=</span><span class="token number">1609474146</span><span class="token punctuation">,</span> reconsumeTimes<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> preparedTransactionOffset<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token class-name">Message</span><span class="token punctuation">&#123;</span>topic<span class="token operator">=</span>'<span class="token constant">SUBSCRIBE_TEST</span>'<span class="token punctuation">,</span> flag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> properties<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token constant">MIN_OFFSET</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">MAX_OFFSET</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token constant">CONSUME_START_TIME</span><span class="token operator">=</span><span class="token number">1630810316088</span><span class="token punctuation">,</span> <span class="token constant">UNIQ_KEY</span><span class="token operator">=</span><span class="token constant">AC10DFD6121618B4AAC216EE4D190005</span><span class="token punctuation">,</span> <span class="token constant">CLUSTER</span><span class="token operator">=</span><span class="token class-name">DefaultCluster</span><span class="token punctuation">,</span> <span class="token constant">WAIT</span><span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token constant">TAGS</span><span class="token operator">=</span>tagB<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> body<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">77</span><span class="token punctuation">,</span> <span class="token number">115</span><span class="token punctuation">,</span> <span class="token number">103</span><span class="token punctuation">,</span> <span class="token number">83</span><span class="token punctuation">,</span> <span class="token number">116</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">53</span><span class="token punctuation">]</span><span class="token punctuation">,</span> transactionId<span class="token operator">=</span><span class="token char">'null'</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>根据上述测试结果，可以分析得出如下结论：</p>
<ul>
<li>测试Topic的队列数量为4，生产者分别向每个队列总共写入了2条消息，TAG分别为<code>tagA</code>和<code>tagB</code></li>
<li>消费者组<code>SUBSCRIBE_TEST_CONSUMER_GROUP</code>下有两个消费者，消费者<code>ConsumerForTagA</code>先启动，消费者<code>ConsumerForTagB</code>后启动</li>
<li>消费者<code>ConsumerForTagA</code>消费的队列ID为<code>0</code>和<code>1</code>，消费者<code>ConsumerForTagB</code>消息的队列ID为<code>2</code>和<code>3</code></li>
<li>消费者<code>ConsumerForTabA</code>对分配给自己的队列<code>0</code>和<code>1</code>中的TAG为<code>tagA</code>和<code>tagB</code>的消息，都未进行消费</li>
<li>消费者<code>ConsumerForTagB</code>消费了分配给自己的队列<code>2</code>和<code>3</code>中的TAG为<code>tagB</code>的消息，但没有消费TAG为<code>tagA</code>的消息</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>消费者<code>ConsumerForTagB</code>在消费者<code>ConsumerForTabA</code>之后启动，覆盖了RocketMQ的Broker中的消费者组<code>SUBSCRIBE_TEST_CONSUMER_GROUP</code>订阅关系，该消费者组在消费者<code>ConsumerForTagB</code>启动后，订阅的消息变为<code>tagB</code>，消费者<code>ConsumerForTagA</code>在消费消息时，由于消费者组的订阅TAG为<code>tagB</code>，所以过滤掉了<code>tagA</code>的消息。</p>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><h4 id="Broken获取消息的源码"><a href="#Broken获取消息的源码" class="headerlink" title="Broken获取消息的源码"></a>Broken获取消息的源码</h4><p><code>DefaultMessageStore.java</code>中获取Message的源码, 其中去除了部分边界检测逻辑</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">GetMessageResult</span> <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> group<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> queueId<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> offset<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> maxMsgNums<span class="token punctuation">,</span>
        <span class="token keyword">final</span> <span class="token class-name">MessageFilter</span> messageFilter<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">long</span> beginTime <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSystemClock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">GetMessageStatus</span> status <span class="token operator">=</span> <span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">NO_MESSAGE_IN_QUEUE</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> nextBeginOffset <span class="token operator">=</span> offset<span class="token punctuation">;</span>
        <span class="token keyword">long</span> minOffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> maxOffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token class-name">GetMessageResult</span> getResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetMessageResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">long</span> maxOffsetPy <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">getMaxOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ConsumeQueue</span> consumeQueue <span class="token operator">=</span> <span class="token function">findConsumeQueue</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> queueId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>consumeQueue <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            minOffset <span class="token operator">=</span> consumeQueue<span class="token punctuation">.</span><span class="token function">getMinOffsetInQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            maxOffset <span class="token operator">=</span> consumeQueue<span class="token punctuation">.</span><span class="token function">getMaxOffsetInQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>maxOffset <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                status <span class="token operator">=</span> <span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">NO_MESSAGE_IN_QUEUE</span><span class="token punctuation">;</span>
                nextBeginOffset <span class="token operator">=</span> <span class="token function">nextOffsetCorrection</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">&lt;</span> minOffset<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                status <span class="token operator">=</span> <span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">OFFSET_TOO_SMALL</span><span class="token punctuation">;</span>
                nextBeginOffset <span class="token operator">=</span> <span class="token function">nextOffsetCorrection</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> minOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">==</span> maxOffset<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                status <span class="token operator">=</span> <span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">OFFSET_OVERFLOW_ONE</span><span class="token punctuation">;</span>
                nextBeginOffset <span class="token operator">=</span> <span class="token function">nextOffsetCorrection</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">></span> maxOffset<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                status <span class="token operator">=</span> <span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">OFFSET_OVERFLOW_BADLY</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> minOffset<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    nextBeginOffset <span class="token operator">=</span> <span class="token function">nextOffsetCorrection</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> minOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    nextBeginOffset <span class="token operator">=</span> <span class="token function">nextOffsetCorrection</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> maxOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">SelectMappedBufferResult</span> bufferConsumeQueue <span class="token operator">=</span> consumeQueue<span class="token punctuation">.</span><span class="token function">getIndexBuffer</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>bufferConsumeQueue <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        status <span class="token operator">=</span> <span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">NO_MATCHED_MESSAGE</span><span class="token punctuation">;</span>

                        <span class="token keyword">long</span> nextPhyFileStartOffset <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">MIN_VALUE</span><span class="token punctuation">;</span>
                        <span class="token keyword">long</span> maxPhyOffsetPulling <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

                        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token keyword">final</span> <span class="token keyword">int</span> maxFilterMessageCount <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">16000</span><span class="token punctuation">,</span> maxMsgNums <span class="token operator">*</span> <span class="token class-name">ConsumeQueue</span><span class="token punctuation">.</span><span class="token constant">CQ_STORE_UNIT_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">final</span> <span class="token keyword">boolean</span> diskFallRecorded <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">isDiskFallRecorded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">ConsumeQueueExt<span class="token punctuation">.</span>CqExtUnit</span> cqExtUnit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsumeQueueExt<span class="token punctuation">.</span>CqExtUnit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bufferConsumeQueue<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> maxFilterMessageCount<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token class-name">ConsumeQueue</span><span class="token punctuation">.</span><span class="token constant">CQ_STORE_UNIT_SIZE</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            <span class="token keyword">long</span> offsetPy <span class="token operator">=</span> bufferConsumeQueue<span class="token punctuation">.</span><span class="token function">getByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">int</span> sizePy <span class="token operator">=</span> bufferConsumeQueue<span class="token punctuation">.</span><span class="token function">getByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">long</span> tagsCode <span class="token operator">=</span> bufferConsumeQueue<span class="token punctuation">.</span><span class="token function">getByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                            maxPhyOffsetPulling <span class="token operator">=</span> offsetPy<span class="token punctuation">;</span>

                            <span class="token keyword">if</span> <span class="token punctuation">(</span>nextPhyFileStartOffset <span class="token operator">!=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">MIN_VALUE</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>offsetPy <span class="token operator">&lt;</span> nextPhyFileStartOffset<span class="token punctuation">)</span>
                                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>

                            <span class="token keyword">boolean</span> isInDisk <span class="token operator">=</span> <span class="token function">checkInDiskByCommitOffset</span><span class="token punctuation">(</span>offsetPy<span class="token punctuation">,</span> maxOffsetPy<span class="token punctuation">)</span><span class="token punctuation">;</span>

                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isTheBatchFull</span><span class="token punctuation">(</span>sizePy<span class="token punctuation">,</span> maxMsgNums<span class="token punctuation">,</span> getResult<span class="token punctuation">.</span><span class="token function">getBufferTotalSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> getResult<span class="token punctuation">.</span><span class="token function">getMessageCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                isInDisk<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>

                            <span class="token keyword">boolean</span> extRet <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> isTagsCodeLegal <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>consumeQueue<span class="token punctuation">.</span><span class="token function">isExtAddr</span><span class="token punctuation">(</span>tagsCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                extRet <span class="token operator">=</span> consumeQueue<span class="token punctuation">.</span><span class="token function">getExt</span><span class="token punctuation">(</span>tagsCode<span class="token punctuation">,</span> cqExtUnit<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>extRet<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                    tagsCode <span class="token operator">=</span> cqExtUnit<span class="token punctuation">.</span><span class="token function">getTagsCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                                    <span class="token comment">// can't find ext content.Client will filter messages by tag also.</span>
                                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[BUG] can't find consume queue extend file content!addr=&#123;&#125;, offsetPy=&#123;&#125;, sizePy=&#123;&#125;, topic=&#123;&#125;, group=&#123;&#125;"</span><span class="token punctuation">,</span>
                                        tagsCode<span class="token punctuation">,</span> offsetPy<span class="token punctuation">,</span> sizePy<span class="token punctuation">,</span> topic<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    isTagsCodeLegal <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                                <span class="token punctuation">&#125;</span>
                            <span class="token punctuation">&#125;</span>
                            <span class="token comment">// 这里是messageFilter根据消费队列中的tag值进行过滤，如果队列中的tag与messageFileter中不匹配则跳过该消息</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>messageFilter <span class="token operator">!=</span> <span class="token keyword">null</span>
                                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>messageFilter<span class="token punctuation">.</span><span class="token function">isMatchedByConsumeQueue</span><span class="token punctuation">(</span>isTagsCodeLegal <span class="token operator">?</span> tagsCode <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> extRet <span class="token operator">?</span> cqExtUnit <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>getResult<span class="token punctuation">.</span><span class="token function">getBufferTotalSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                    status <span class="token operator">=</span> <span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">NO_MATCHED_MESSAGE</span><span class="token punctuation">;</span>
                                <span class="token punctuation">&#125;</span>

                                <span class="token keyword">continue</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>

                            <span class="token class-name">SelectMappedBufferResult</span> selectResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span>offsetPy<span class="token punctuation">,</span> sizePy<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> selectResult<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>getResult<span class="token punctuation">.</span><span class="token function">getBufferTotalSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                    status <span class="token operator">=</span> <span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">MESSAGE_WAS_REMOVING</span><span class="token punctuation">;</span>
                                <span class="token punctuation">&#125;</span>

                                nextPhyFileStartOffset <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">rollNextFile</span><span class="token punctuation">(</span>offsetPy<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">continue</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>

                            <span class="token keyword">if</span> <span class="token punctuation">(</span>messageFilter <span class="token operator">!=</span> <span class="token keyword">null</span>
                                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>messageFilter<span class="token punctuation">.</span><span class="token function">isMatchedByCommitLog</span><span class="token punctuation">(</span>selectResult<span class="token punctuation">.</span><span class="token function">getByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>getResult<span class="token punctuation">.</span><span class="token function">getBufferTotalSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                    status <span class="token operator">=</span> <span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">NO_MATCHED_MESSAGE</span><span class="token punctuation">;</span>
                                <span class="token punctuation">&#125;</span>
                                <span class="token comment">// release...</span>
                                selectResult<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">continue</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>

                            <span class="token keyword">this</span><span class="token punctuation">.</span>storeStatsService<span class="token punctuation">.</span><span class="token function">getGetMessageTransferedMsgCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            getResult<span class="token punctuation">.</span><span class="token function">addMessage</span><span class="token punctuation">(</span>selectResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            status <span class="token operator">=</span> <span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">FOUND</span><span class="token punctuation">;</span>
                            nextPhyFileStartOffset <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">MIN_VALUE</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span>diskFallRecorded<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            <span class="token keyword">long</span> fallBehind <span class="token operator">=</span> maxOffsetPy <span class="token operator">-</span> maxPhyOffsetPulling<span class="token punctuation">;</span>
                            brokerStatsManager<span class="token punctuation">.</span><span class="token function">recordDiskFallBehindSize</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> topic<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> fallBehind<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>

                        nextBeginOffset <span class="token operator">=</span> offset <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">/</span> <span class="token class-name">ConsumeQueue</span><span class="token punctuation">.</span><span class="token constant">CQ_STORE_UNIT_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token keyword">long</span> diff <span class="token operator">=</span> maxOffsetPy <span class="token operator">-</span> maxPhyOffsetPulling<span class="token punctuation">;</span>
                        <span class="token keyword">long</span> memory <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">StoreUtil</span><span class="token punctuation">.</span><span class="token constant">TOTAL_PHYSICAL_MEMORY_SIZE</span>
                            <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">getAccessMessageInMemoryMaxRatio</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        getResult<span class="token punctuation">.</span><span class="token function">setSuggestPullingFromSlave</span><span class="token punctuation">(</span>diff <span class="token operator">></span> memory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>

                        bufferConsumeQueue<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                    status <span class="token operator">=</span> <span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">OFFSET_FOUND_NULL</span><span class="token punctuation">;</span>
                    nextBeginOffset <span class="token operator">=</span> <span class="token function">nextOffsetCorrection</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> consumeQueue<span class="token punctuation">.</span><span class="token function">rollNextFile</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"consumer request topic: "</span> <span class="token operator">+</span> topic <span class="token operator">+</span> <span class="token string">"offset: "</span> <span class="token operator">+</span> offset <span class="token operator">+</span> <span class="token string">" minOffset: "</span> <span class="token operator">+</span> minOffset <span class="token operator">+</span> <span class="token string">" maxOffset: "</span>
                        <span class="token operator">+</span> maxOffset <span class="token operator">+</span> <span class="token string">", but access logic queue failed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            status <span class="token operator">=</span> <span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">NO_MATCHED_LOGIC_QUEUE</span><span class="token punctuation">;</span>
            nextBeginOffset <span class="token operator">=</span> <span class="token function">nextOffsetCorrection</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">GetMessageStatus</span><span class="token punctuation">.</span><span class="token constant">FOUND</span> <span class="token operator">==</span> status<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>storeStatsService<span class="token punctuation">.</span><span class="token function">getGetMessageTimesTotalFound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>storeStatsService<span class="token punctuation">.</span><span class="token function">getGetMessageTimesTotalMiss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">long</span> elapsedTime <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSystemClock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> beginTime<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>storeStatsService<span class="token punctuation">.</span><span class="token function">setGetMessageEntireTimeMax</span><span class="token punctuation">(</span>elapsedTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

        getResult<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        getResult<span class="token punctuation">.</span><span class="token function">setNextBeginOffset</span><span class="token punctuation">(</span>nextBeginOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        getResult<span class="token punctuation">.</span><span class="token function">setMaxOffset</span><span class="token punctuation">(</span>maxOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        getResult<span class="token punctuation">.</span><span class="token function">setMinOffset</span><span class="token punctuation">(</span>minOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> getResult<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="消息过滤器TAG匹配源码"><a href="#消息过滤器TAG匹配源码" class="headerlink" title="消息过滤器TAG匹配源码"></a>消息过滤器TAG匹配源码</h4><p><code>messageFilter.isMatchedByConsumeQueue</code>的代码实现.<br>根据代码这里是根据messageFilter中的subscriptionData的订阅TAG进行匹配。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isMatchedByConsumeQueue</span><span class="token punctuation">(</span><span class="token class-name">Long</span> tagsCode<span class="token punctuation">,</span> <span class="token class-name">ConsumeQueueExt<span class="token punctuation">.</span>CqExtUnit</span> cqExtUnit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> subscriptionData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>subscriptionData<span class="token punctuation">.</span><span class="token function">isClassFilterMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// by tags code.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ExpressionType</span><span class="token punctuation">.</span><span class="token function">isTagType</span><span class="token punctuation">(</span>subscriptionData<span class="token punctuation">.</span><span class="token function">getExpressionType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>tagsCode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>subscriptionData<span class="token punctuation">.</span><span class="token function">getSubString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">SubscriptionData</span><span class="token punctuation">.</span><span class="token constant">SUB_ALL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            
            <span class="token comment">// 根据subscriptionData中的订阅tag判断是否匹配</span>
            <span class="token keyword">return</span> subscriptionData<span class="token punctuation">.</span><span class="token function">getCodeSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>tagsCode<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// no expression or no bloom</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>consumerFilterData <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> consumerFilterData<span class="token punctuation">.</span><span class="token function">getExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span>
                <span class="token operator">||</span> consumerFilterData<span class="token punctuation">.</span><span class="token function">getCompiledExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> consumerFilterData<span class="token punctuation">.</span><span class="token function">getBloomFilterData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token comment">// message is before consumer</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cqExtUnit <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>consumerFilterData<span class="token punctuation">.</span><span class="token function">isMsgInLive</span><span class="token punctuation">(</span>cqExtUnit<span class="token punctuation">.</span><span class="token function">getMsgStoreTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Pull matched because not in live: &#123;&#125;, &#123;&#125;"</span><span class="token punctuation">,</span> consumerFilterData<span class="token punctuation">,</span> cqExtUnit<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> filterBitMap <span class="token operator">=</span> cqExtUnit<span class="token punctuation">.</span><span class="token function">getFilterBitMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">BloomFilter</span> bloomFilter <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumerFilterManager<span class="token punctuation">.</span><span class="token function">getBloomFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>filterBitMap <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>bloomDataValid
                <span class="token operator">||</span> filterBitMap<span class="token punctuation">.</span>length <span class="token operator">*</span> <span class="token class-name">Byte</span><span class="token punctuation">.</span><span class="token constant">SIZE</span> <span class="token operator">!=</span> consumerFilterData<span class="token punctuation">.</span><span class="token function">getBloomFilterData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBitNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token class-name">BitsArray</span> bitsArray <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                bitsArray <span class="token operator">=</span> <span class="token class-name">BitsArray</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>filterBitMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> ret <span class="token operator">=</span> bloomFilter<span class="token punctuation">.</span><span class="token function">isHit</span><span class="token punctuation">(</span>consumerFilterData<span class="token punctuation">.</span><span class="token function">getBloomFilterData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bitsArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Pull &#123;&#125; by bit map:&#123;&#125;, &#123;&#125;, &#123;&#125;"</span><span class="token punctuation">,</span> ret<span class="token punctuation">,</span> consumerFilterData<span class="token punctuation">,</span> bitsArray<span class="token punctuation">,</span> cqExtUnit<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"bloom filter error, sub="</span> <span class="token operator">+</span> subscriptionData
                    <span class="token operator">+</span> <span class="token string">", filter="</span> <span class="token operator">+</span> consumerFilterData <span class="token operator">+</span> <span class="token string">", bitMap="</span> <span class="token operator">+</span> bitsArray<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="消息过滤器中订阅数据来源"><a href="#消息过滤器中订阅数据来源" class="headerlink" title="消息过滤器中订阅数据来源"></a>消息过滤器中订阅数据来源</h4><p><code>PullMessageProcessor.java</code>中的Consumer订阅数据</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">RemotingCommand</span> <span class="token function">processRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">RemotingCommand</span> request<span class="token punctuation">,</span> <span class="token keyword">boolean</span> brokerAllowSuspend<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">RemotingCommandException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">RemotingCommand</span> response <span class="token operator">=</span> <span class="token class-name">RemotingCommand</span><span class="token punctuation">.</span><span class="token function">createResponseCommand</span><span class="token punctuation">(</span><span class="token class-name">PullMessageResponseHeader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">PullMessageResponseHeader</span> responseHeader <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">PullMessageResponseHeader</span><span class="token punctuation">)</span> response<span class="token punctuation">.</span><span class="token function">readCustomHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">PullMessageRequestHeader</span> requestHeader <span class="token operator">=</span>
            <span class="token punctuation">(</span><span class="token class-name">PullMessageRequestHeader</span><span class="token punctuation">)</span> request<span class="token punctuation">.</span><span class="token function">decodeCommandCustomHeader</span><span class="token punctuation">(</span><span class="token class-name">PullMessageRequestHeader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        response<span class="token punctuation">.</span><span class="token function">setOpaque</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getOpaque</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"receive PullMessage request command, &#123;&#125;"</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 此处略去部分代码</span>

        <span class="token keyword">final</span> <span class="token keyword">boolean</span> hasSuspendFlag <span class="token operator">=</span> <span class="token class-name">PullSysFlag</span><span class="token punctuation">.</span><span class="token function">hasSuspendFlag</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getSysFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> hasCommitOffsetFlag <span class="token operator">=</span> <span class="token class-name">PullSysFlag</span><span class="token punctuation">.</span><span class="token function">hasCommitOffsetFlag</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getSysFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> hasSubscriptionFlag <span class="token operator">=</span> <span class="token class-name">PullSysFlag</span><span class="token punctuation">.</span><span class="token function">hasSubscriptionFlag</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getSysFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">long</span> suspendTimeoutMillisLong <span class="token operator">=</span> hasSuspendFlag <span class="token operator">?</span> requestHeader<span class="token punctuation">.</span><span class="token function">getSuspendTimeoutMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token class-name">TopicConfig</span> topicConfig <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTopicConfigManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">selectTopicConfig</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> topicConfig<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"the topic &#123;&#125; not exist, consumer: &#123;&#125;"</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">RemotingHelper</span><span class="token punctuation">.</span><span class="token function">parseChannelRemoteAddr</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">TOPIC_NOT_EXIST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"topic[%s] not exist, apply first please! %s"</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">FAQUrl</span><span class="token punctuation">.</span><span class="token function">suggestTodo</span><span class="token punctuation">(</span><span class="token class-name">FAQUrl</span><span class="token punctuation">.</span><span class="token constant">APPLY_TOPIC_URL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> response<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">PermName</span><span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span>topicConfig<span class="token punctuation">.</span><span class="token function">getPerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">NO_PERMISSION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span><span class="token string">"the topic["</span> <span class="token operator">+</span> requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"] pulling message is forbidden"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> response<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> requestHeader<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> topicConfig<span class="token punctuation">.</span><span class="token function">getReadQueueNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> errorInfo <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"queueId[%d] is illegal, topic:[%s] topicConfig.readQueueNums:[%d] consumer:[%s]"</span><span class="token punctuation">,</span>
                requestHeader<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> topicConfig<span class="token punctuation">.</span><span class="token function">getReadQueueNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> channel<span class="token punctuation">.</span><span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>errorInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SYSTEM_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span>errorInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> response<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token class-name">SubscriptionData</span> subscriptionData <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">ConsumerFilterData</span> consumerFilterData <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasSubscriptionFlag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                subscriptionData <span class="token operator">=</span> <span class="token class-name">FilterAPI</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>
                    requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getSubscription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getExpressionType</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ExpressionType</span><span class="token punctuation">.</span><span class="token function">isTagType</span><span class="token punctuation">(</span>subscriptionData<span class="token punctuation">.</span><span class="token function">getExpressionType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    consumerFilterData <span class="token operator">=</span> <span class="token class-name">ConsumerFilterManager</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>
                        requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getSubscription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        requestHeader<span class="token punctuation">.</span><span class="token function">getExpressionType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getSubVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">assert</span> consumerFilterData <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Parse the consumer's subscription[&#123;&#125;] failed, group: &#123;&#125;"</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getSubscription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUBSCRIPTION_PARSE_FAILED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                response<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span><span class="token string">"parse the consumer's subscription failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> response<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">ConsumerGroupInfo</span> consumerGroupInfo <span class="token operator">=</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getConsumerManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConsumerGroupInfo</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 此处略去部分卫语句判断</span>
            
            <span class="token comment">// 这里从subscriptionTable获取到了subscriptionData</span>
            subscriptionData <span class="token operator">=</span> consumerGroupInfo<span class="token punctuation">.</span><span class="token function">findSubscriptionData</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> subscriptionData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"the consumer's subscription not exist, group: &#123;&#125;, topic:&#123;&#125;"</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUBSCRIPTION_NOT_EXIST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                response<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span><span class="token string">"the consumer's subscription not exist"</span> <span class="token operator">+</span> <span class="token class-name">FAQUrl</span><span class="token punctuation">.</span><span class="token function">suggestTodo</span><span class="token punctuation">(</span><span class="token class-name">FAQUrl</span><span class="token punctuation">.</span><span class="token constant">SAME_GROUP_DIFFERENT_TOPIC</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> response<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>subscriptionData<span class="token punctuation">.</span><span class="token function">getSubVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> requestHeader<span class="token punctuation">.</span><span class="token function">getSubVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"The broker's subscription is not latest, group: &#123;&#125; &#123;&#125;"</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    subscriptionData<span class="token punctuation">.</span><span class="token function">getSubString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SUBSCRIPTION_NOT_LATEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                response<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span><span class="token string">"the consumer's subscription not latest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> response<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ExpressionType</span><span class="token punctuation">.</span><span class="token function">isTagType</span><span class="token punctuation">(</span>subscriptionData<span class="token punctuation">.</span><span class="token function">getExpressionType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                consumerFilterData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getConsumerFilterManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>consumerFilterData <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">FILTER_DATA_NOT_EXIST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    response<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span><span class="token string">"The broker's consumer filter data is not exist!Your expression may be wrong!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>consumerFilterData<span class="token punctuation">.</span><span class="token function">getClientVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> requestHeader<span class="token punctuation">.</span><span class="token function">getSubVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"The broker's consumer filter data is not latest, group: &#123;&#125;, topic: &#123;&#125;, serverV: &#123;&#125;, clientV: &#123;&#125;"</span><span class="token punctuation">,</span>
                        requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> consumerFilterData<span class="token punctuation">.</span><span class="token function">getClientVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getSubVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">FILTER_DATA_NOT_LATEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    response<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span><span class="token string">"the consumer's consumer filter data not latest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ExpressionType</span><span class="token punctuation">.</span><span class="token function">isTagType</span><span class="token punctuation">(</span>subscriptionData<span class="token punctuation">.</span><span class="token function">getExpressionType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnablePropertyFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token class-name">ResponseCode</span><span class="token punctuation">.</span><span class="token constant">SYSTEM_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span><span class="token string">"The broker does not support consumer to filter message by "</span> <span class="token operator">+</span> subscriptionData<span class="token punctuation">.</span><span class="token function">getExpressionType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> response<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token class-name">MessageFilter</span> messageFilter<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isFilterSupportRetry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            messageFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExpressionForRetryMessageFilter</span><span class="token punctuation">(</span>subscriptionData<span class="token punctuation">,</span> consumerFilterData<span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getConsumerFilterManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            messageFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExpressionMessageFilter</span><span class="token punctuation">(</span>subscriptionData<span class="token punctuation">,</span> consumerFilterData<span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getConsumerFilterManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">final</span> <span class="token class-name">GetMessageResult</span> getMessageResult <span class="token operator">=</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                requestHeader<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getMaxMsgNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> messageFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 此处略去后续处理的相关代码</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="Consumer订阅数据更新"><a href="#Consumer订阅数据更新" class="headerlink" title="Consumer订阅数据更新"></a>Consumer订阅数据更新</h4><p><code>ConsumerGroupInfo.java</code> </p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">updateSubscription</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SubscriptionData</span><span class="token punctuation">></span></span> subList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">boolean</span> updated <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SubscriptionData</span> sub <span class="token operator">:</span> subList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Consumer订阅新的Topic后，更新订阅关系</span>
            <span class="token class-name">SubscriptionData</span> old <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subscriptionTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>sub<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>old <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">SubscriptionData</span> prev <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subscriptionTable<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>sub<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sub<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> prev<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    updated <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"subscription changed, add new topic, group: &#123;&#125; &#123;&#125;"</span><span class="token punctuation">,</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>groupName<span class="token punctuation">,</span>
                        sub<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sub<span class="token punctuation">.</span><span class="token function">getSubVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> old<span class="token punctuation">.</span><span class="token function">getSubVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>consumeType <span class="token operator">==</span> <span class="token class-name">ConsumeType</span><span class="token punctuation">.</span><span class="token constant">CONSUME_PASSIVELY</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"subscription changed, group: &#123;&#125; OLD: &#123;&#125; NEW: &#123;&#125;"</span><span class="token punctuation">,</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>groupName<span class="token punctuation">,</span>
                        old<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        sub<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token comment">/**
                 * 当Consumer的subVersion大于Broker中的subVersion时，则更新订阅信息
                 * 这里old.getSubVersion()即为最后消费者组内最后一个消费者的启动时间
                 * 只有当有新的消费者启动，或者消费者进行了重新负载，订阅关系才会被更新
                 */</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>subscriptionTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>sub<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sub<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">SubscriptionData</span><span class="token punctuation">></span><span class="token punctuation">></span></span> it <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subscriptionTable<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">SubscriptionData</span><span class="token punctuation">></span></span> next <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> oldTopic <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">boolean</span> exist <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SubscriptionData</span> sub <span class="token operator">:</span> subList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sub<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>oldTopic<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    exist <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>exist<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"subscription changed, group: &#123;&#125; remove topic &#123;&#125; &#123;&#125;"</span><span class="token punctuation">,</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>groupName<span class="token punctuation">,</span>
                    oldTopic<span class="token punctuation">,</span>
                    next<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>

                it<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                updated <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>lastUpdateTimestamp <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> updated<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h1><p>Broker在获取消息时会根据subscriptionTable中对应的消费者组的订阅Tag进行消息过滤，同一个消费者组内，Broker中保存了最后启动的Consumer的订阅信息，后续只有当新的消费者添加进来或者消费者组内的消费者进行了重新负载均衡（重新负载的可能原因：消费者新增或移除、队列数量变更），订阅信息才会被更新。</p>
]]></content>
      <categories>
        <category>消息队列</category>
      </categories>
      <tags>
        <tag>RocketMQ</tag>
        <tag>Consumer</tag>
        <tag>ConsumerGroup</tag>
      </tags>
  </entry>
  <entry>
    <title>RocketMQ设计原理分析</title>
    <url>/2020/11/26/rockermq/rocketmq-she-ji-yuan-li-fen-xi/</url>
    <content><![CDATA[<h1 id="RocketMQ设计原理分析——技术分享PPT"><a href="#RocketMQ设计原理分析——技术分享PPT" class="headerlink" title="RocketMQ设计原理分析——技术分享PPT"></a>RocketMQ设计原理分析——技术分享PPT</h1><span id="more"></span>
<div class="pdf-container" style="width: 100%; height: 600px; margin: 20px 0; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
    <iframe src="./RocketMQ设计原理分析.pdf" width="100%" height="100%" frameborder="0" style="border: none; border-radius: 8px;">
      <div style="padding: 20px; text-align: center; background-color: #f8f9fa; border-radius: 8px;">
        <p style="margin: 0; color: #666;">您的浏览器不支持显示PDF文件</p>
        <a href="./RocketMQ设计原理分析.pdf" target="_blank" style="color: #409eff; text-decoration: none; font-weight: 500;">📥 点击这里下载PDF文件</a>
      </div>
    </iframe>
  </div>]]></content>
      <categories>
        <category>消息队列</category>
      </categories>
      <tags>
        <tag>RocketMQ</tag>
        <tag>Mmap</tag>
      </tags>
  </entry>
  <entry>
    <title>深度解读 RocketMQ 存储机制</title>
    <url>/2022/06/19/rockermq/shen-du-jie-du-rocketmq-cun-chu-ji-zhi/</url>
    <content><![CDATA[<blockquote>
<p>在《阿里开发者》公众号看到这篇文章，深度解析了RocketMQ的存储机制，对理解RocketMQ存储原理及进行性能优化很有帮助。<br>原文地址：<a href="https://mp.weixin.qq.com/s/PzDO-UCLzxqDbFoHbS47Sg">深度解读 RocketMQ 存储机制</a></p>
</blockquote>
<p>RocketMQ 实现了灵活的多分区和多副本机制，有效的避免了集群内单点故障对于整体服务可用性的影响。存储机制和高可用策略是 RocketMQ 稳定性的核心，社区上关于 RocketMQ 目前存储实现的分析与讨论一直是一个热议的话题。本文想从一个不一样的视角，着重于谈谈我眼中的这种存储实现是在解决哪些复杂的问题，因此我从本文最初的版本中删去了冗杂的代码细节分析，由浅入深的分析存储机制的缺陷与优化方向。</p>
<div class="btn-center">
<a class="btn-beautify outline blue larger" href="https://mp.weixin.qq.com/s/PzDO-UCLzxqDbFoHbS47Sg" title="查看原文"><i class="far fa-hand-point-right"></i><span>查看原文</span></a>
</div>]]></content>
      <categories>
        <category>消息队列</category>
      </categories>
      <tags>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>站在31岁的人生十字路口，我选择放下焦虑，与自己和解</title>
    <url>/2025/03/26/thought/31-sui-zhan-zai-ren-sheng-shi-zi-lu-kou-yi-ci-shen-du-jie-pou-gao-bie-jiao-lu-mi-mang/</url>
    <content><![CDATA[<div class="note primary no-icon flat"><p>三十而立，是一个被赋予了太多期望的词。我们曾以为，到了这个年纪就该事业有成、家庭美满，活成一个”标准答案”。然而，当31岁的里程碑悄然来临，我们才发现，人生没有标准答案，只有不断叩问自己、与自己和解的过程。</p>
</div>

<span id="more"></span>
<p><img src="/2025/03/26/thought/31-sui-zhan-zai-ren-sheng-shi-zi-lu-kou-yi-ci-shen-du-jie-pou-gao-bie-jiao-lu-mi-mang/cover.jpg" alt="cover"></p>
<hr>
<h2 id="一、焦虑，是成长的必经之路"><a href="#一、焦虑，是成长的必经之路" class="headerlink" title="一、焦虑，是成长的必经之路"></a>一、焦虑，是成长的必经之路</h2><p>最近，我常常感到一种莫名的焦虑。它不像年轻时的迷茫，那种对未来的不确定性。现在的焦虑更像是站在一个山顶，回头望去，有起有落，有清晰的足迹，但前方却又是一片迷雾。</p>
<p>我开始意识到，31岁不再是那个可以肆意挥霍时间的少年。我们开始算计沉没成本，每一次选择都背负着更高的风险。肩上的责任越来越重，它不只是工作的 KPI，更是对家人、对未来的承诺。</p>
<div class="note info no-icon flat"><p>曾国藩说：”<strong>物来顺应，未来不迎，当时不杂，既过不恋。</strong>“ 这句话曾被我奉为圭臬。但真正的感悟，是在这31年的人生轨迹里，我才明白它不是让我们被动接受，而是告诉我们，面对焦虑，与其被动逃避，不如主动剖析，搞清楚焦虑的根源，才能真正与之和解。</p>
</div>

<hr>
<h2 id="二、撕开自我的”理想画像”，看见真实的自己"><a href="#二、撕开自我的”理想画像”，看见真实的自己" class="headerlink" title="二、撕开自我的”理想画像”，看见真实的自己"></a>二、撕开自我的”理想画像”，看见真实的自己</h2><p>为了看清前路，我决定做一次深度自我解剖，将自己的人生分成两个阶段：毕业前和工作后。这不是简单的履历罗列，而是去洞察那些塑造了我、也曾困住我的特质。</p>
<p>我曾以为，工作后的人生才算真正开始。但回看毕业前的自己，我看到了一个<strong>内向敏感</strong>、<strong>责任感强</strong>、<strong>习惯性缺乏自信</strong>的少年。他喜欢读书，却总是浅尝辄止；对技术有朦胧的向往，却缺乏明确的方向。这些特质曾是我的桎梏，让我害怕失败，不敢尝试，总在寻求外界的认可。</p>
<p>工作后，我逐渐在技术领域找到了自己的位置，建立了一定的职场圈子。我以为自己已经“长大”，但当新的挑战来临时，那些深藏的特质又会冒出来。31岁，我不再是那个在乎别人看法、害怕“被叫起表演节目”的男孩，但我依然会怀疑自己的能力，在做重大决定时瞻前顾后。</p>
<div class="note warning no-icon flat"><p>这次自我剖析让我明白，<strong>焦虑的本质，是对不确定性的恐惧。</strong> 而这种恐惧，源于我们对自身弱点的抗拒。真正的成长，不是抹掉这些特质，而是去接纳它们，与它们并肩前行。</p>
</div>

<hr>
<h2 id="三、人生不是公式，而是一场向内探索的修行"><a href="#三、人生不是公式，而是一场向内探索的修行" class="headerlink" title="三、人生不是公式，而是一场向内探索的修行"></a>三、人生不是公式，而是一场向内探索的修行</h2><p>我曾试图用几个“公式”来定义幸福与价值，比如：</p>
<p><strong>幸福 &#x3D; 健康 + 财富 + 良好的人际关系</strong></p>
<p>但现实是，人生不是一道可以精确计算的数学题。</p>
<p>健康，不只是没有疾病，更是保持对生活的热情与活力；财富，不是银行账户里的数字，而是实现自我价值与自由选择的底气；人际关系，不是社交圈的大小，而是与重要的人建立深度连接的能力。</p>
<div class="note primary no-icon flat"><p>我开始理解，<strong>人生的意义不在于完美地套用某个公式，而在于不断地向内探索，活出独一无二的生命体验。</strong></p>
</div>

<p>这31年，我逐渐形成了自己的价值观：<strong>诚信、持续成长、价值创造、平衡生活与感恩。</strong> 它们不再是抽象的词汇，而是每一次选择、每一次付出后，内心最真实的回响。</p>
<hr>
<h2 id="四、告别焦虑，从“想明白”到“做得到”"><a href="#四、告别焦虑，从“想明白”到“做得到”" class="headerlink" title="四、告别焦虑，从“想明白”到“做得到”"></a>四、告别焦虑，从“想明白”到“做得到”</h2><p>认清自己之后，告别焦虑的关键就变成了行动。我不再沉溺于空洞的思考，而是将那些宏大的未来愿景拆解成一个个具体的、可执行的行动方案。</p>
<h3 id="（1）放下“完美”，拥抱“完成”"><a href="#（1）放下“完美”，拥抱“完成”" class="headerlink" title="（1）放下“完美”，拥抱“完成”"></a>（1）放下“完美”，拥抱“完成”</h3><div class="note success no-icon flat"><p>我曾是完美主义的受害者，害怕失败，不敢开始。如今，我学会了”<strong>done is better than perfect</strong>“。与其等待一个完美的时机，不如立即行动。哪怕只是每天早起15分钟，哪怕只是写下几行凌乱的思考，这些微小的”完成”会逐渐累积成巨大的能量，驱散内心的恐惧。</p>
</div>

<h3 id="（2）专注于“过程”，而非“结果”"><a href="#（2）专注于“过程”，而非“结果”" class="headerlink" title="（2）专注于“过程”，而非“结果”"></a>（2）专注于“过程”，而非“结果”</h3><div class="note info no-icon flat"><p>过度的结果导向只会徒增焦虑。我开始练习把注意力放在当下，专注于每一个具体行动：<strong>每周复盘得失，每月调整策略，每日精进一小时。</strong> 这种”过程导向”的思维，让我不再被未来的不确定性所困扰，而是能在每一次努力中获得实实在在的成就感。</p>
</div>

<h3 id="（3）找到你的“支持系统”"><a href="#（3）找到你的“支持系统”" class="headerlink" title="（3）找到你的“支持系统”"></a>（3）找到你的“支持系统”</h3><div class="note primary no-icon flat"><p>告别焦虑不是一个人在战斗。我开始更加重视与家人、朋友的深度连接，他们是我最坚实的支持系统。同时，我也开始寻找导师，与同行交流，与志同道合的人组成学习小组。<strong>当你发现有人和你走在同一条路上，内心的孤独感会大大降低。</strong></p>
</div>

<hr>
<h2 id="五、31岁，我的“而立”新解"><a href="#五、31岁，我的“而立”新解" class="headerlink" title="五、31岁，我的“而立”新解"></a>五、31岁，我的“而立”新解</h2><p>在古代，“三十而立”意味着立身、立业、立德。在现代，它对我们这代人有了新的含义：</p>
<ul>
<li><strong>立志</strong>：不是被动地选择一条路，而是主动找到自己真正想走的方向；</li>
<li><strong>立能</strong>：不是拥有所有技能，而是具备在任何不确定性中生存和成长的核心能力；</li>
<li><strong>立心</strong>：不是不为外界所动，而是拥有一个稳定的内心世界和价值体系；</li>
<li><strong>立行</strong>：不是空想未来，而是将所有想法付诸行动，去创造属于自己的未来。</li>
</ul>
<div class="note success no-icon flat"><p>31岁的我，不再害怕迷茫，因为它意味着我在思考。不再害怕焦虑，因为它说明我内心还有追求。<strong>真正的淡定与从容，不是内心毫无波澜，而是在经历风浪之后，依然能够坦然前行。</strong></p>
</div>

<p>希望你也一样。愿我们都能在人生的上半场，找到与自己和解的方式；在下半场，活出内心真正的自由与笃定。</p>
<hr>
<p><em>写于2025年春日</em><br><em>一个31岁的思考者</em></p>
]]></content>
      <categories>
        <category>thought</category>
      </categories>
      <tags>
        <tag>人生</tag>
        <tag>而立之年</tag>
        <tag>焦虑</tag>
        <tag>迷茫</tag>
        <tag>自我和解</tag>
      </tags>
  </entry>
  <entry>
    <title>EnvironmentChangeEvent的Listener执行顺序</title>
    <url>/2022/04/06/springcloud/environmentchangeevent-de-listener-zhi-xing-shun-xu/</url>
    <content><![CDATA[<h1 id="一、问题背景"><a href="#一、问题背景" class="headerlink" title="一、问题背景"></a>一、问题背景</h1><p>项目中使用Nacos作为配置中心，实现配置动态更新，在配置类中监听<code>EnvironmentChangeEvent</code>事件对更新后的配置做一些初始化处理，代码如下：</p>
<h2 id="CallbackConfig"><a href="#CallbackConfig" class="headerlink" title="CallbackConfig"></a>CallbackConfig</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Accessors</span><span class="token punctuation">(</span>chain <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"transparent-delivery.callback"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RefreshScope</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CallbackConfig</span> <span class="token keyword">implements</span> <span class="token class-name">InitializingBean</span><span class="token punctuation">,</span> <span class="token class-name">ApplicationListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EnvironmentChangeEvent</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> log <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token string">"CONFIG_LOG"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChatbotConfig</span><span class="token punctuation">></span></span> configs<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">ChatbotConfig</span><span class="token punctuation">></span></span> <span class="token constant">CHATBOT_MAP</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ChatbotConfig</span> <span class="token function">fetchByUserId</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> userId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token constant">CHATBOT_MAP</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Config chatbot callback information:&#123;&#125;!"</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>configs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">initConfigs</span><span class="token punctuation">(</span>configs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onApplicationEvent</span><span class="token punctuation">(</span><span class="token class-name">EnvironmentChangeEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Nacos refresh config information the current information is:&#123;&#125;!"</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>configs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">initConfigs</span><span class="token punctuation">(</span>configs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是每次在Nacos更新配置后，日志打印的值仍是修改之前的，为什么会出现这个现象？</p>
<h1 id="二、EnvironmentChangeEvent的Listener执行顺序"><a href="#二、EnvironmentChangeEvent的Listener执行顺序" class="headerlink" title="二、EnvironmentChangeEvent的Listener执行顺序"></a>二、EnvironmentChangeEvent的Listener执行顺序</h1><p>在Nacos上更新配置后，Spring会发布一个<code>RefreshEvent</code>事件，这个事件最后会被委托给<code>ContextRefresh</code>去处理，接下来我们结合源码，看一下处理流程。</p>
<h2 id="RefreshEventListener"><a href="#RefreshEventListener" class="headerlink" title="RefreshEventListener"></a>RefreshEventListener</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>endpoint<span class="token punctuation">.</span>event</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RefreshEventListener</span> <span class="token keyword">implements</span> <span class="token class-name">SmartApplicationListener</span> <span class="token punctuation">&#123;</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onApplicationEvent</span><span class="token punctuation">(</span><span class="token class-name">ApplicationEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">ApplicationReadyEvent</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ApplicationReadyEvent</span><span class="token punctuation">)</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">RefreshEvent</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RefreshEvent</span><span class="token punctuation">)</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">ApplicationReadyEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>ready<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">RefreshEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ready<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// don't handle events before app is ready</span>
			<span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> keys <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>refresh<span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>当SpringCloud接收到一个<code>RefreshEvent</code>事件后会委托给<code>ContextRefresher</code>的<code>refresh()</code>方法去处理。</p>
</blockquote>
<h2 id="ContextRefresher"><a href="#ContextRefresher" class="headerlink" title="ContextRefresher"></a>ContextRefresher</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>context<span class="token punctuation">.</span>refresh</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author Dave Syer
 * @author Venil Noronha
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ContextRefresher</span> <span class="token punctuation">&#123;</span>

	<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> keys <span class="token operator">=</span> <span class="token function">refreshEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">refreshAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> keys<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">refreshEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> before <span class="token operator">=</span> <span class="token function">extract</span><span class="token punctuation">(</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">addConfigFilesToEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> keys <span class="token operator">=</span> <span class="token function">changes</span><span class="token punctuation">(</span>before<span class="token punctuation">,</span>
				<span class="token function">extract</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EnvironmentChangeEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">,</span> keys<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> keys<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p><code>ContextRefresher</code>的<code>Refresh()</code>方法先将配置文件添加到<code>Environment</code>中，然后发布<code>EnvironmentChangeEvent</code>事件。</p>
</blockquote>
<h2 id="AbstractApplicationContext"><a href="#AbstractApplicationContext" class="headerlink" title="AbstractApplicationContext"></a>AbstractApplicationContext</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java">   <span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token class-name">ApplicationEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token function">publishEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
   
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token class-name">Object</span> event<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ResolvableType</span> eventType<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// 此处略去部分代码......</span>

	<span class="token comment">// Multicast right now if possible - or lazily once the multicaster is initialized</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>earlyApplicationEvents <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>earlyApplicationEvents<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>applicationEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
           <span class="token comment">// 核心处理逻辑</span>
		<span class="token function">getApplicationEventMulticaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multicastEvent</span><span class="token punctuation">(</span>applicationEvent<span class="token punctuation">,</span> eventType<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// Publish event via parent context as well...</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token keyword">instanceof</span> <span class="token class-name">AbstractApplicationContext</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractApplicationContext</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> eventType<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p><code>getApplicationEventMulticaster().multicastEvent(applicationEvent, eventType);</code>通过事件广播器将事件广播出去。</p>
</blockquote>
<h2 id="SimpleApplicationEventMulticaster"><a href="#SimpleApplicationEventMulticaster" class="headerlink" title="SimpleApplicationEventMulticaster"></a>SimpleApplicationEventMulticaster</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>event</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleApplicationEventMulticaster</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractApplicationEventMulticaster</span> <span class="token punctuation">&#123;</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">multicastEvent</span><span class="token punctuation">(</span><span class="token class-name">ApplicationEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token function">multicastEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token function">resolveDefaultEventType</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">multicastEvent</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ApplicationEvent</span> event<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ResolvableType</span> eventType<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">ResolvableType</span> type <span class="token operator">=</span> <span class="token punctuation">(</span>eventType <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> eventType <span class="token operator">:</span> <span class="token function">resolveDefaultEventType</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Executor</span> executor <span class="token operator">=</span> <span class="token function">getTaskExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ApplicationListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> listener <span class="token operator">:</span> <span class="token function">getApplicationListeners</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>executor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token function">invokeListener</span><span class="token punctuation">(</span>listener<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
				<span class="token function">invokeListener</span><span class="token punctuation">(</span>listener<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p><code>multicastEvent</code>方法中获取当前事件的所有Listener后，循环调用Listener的<code>onApplicationEvent</code>方法。</p>
</blockquote>
<h2 id="AbstractApplicationEventMulticaster"><a href="#AbstractApplicationEventMulticaster" class="headerlink" title="AbstractApplicationEventMulticaster"></a>AbstractApplicationEventMulticaster</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApplicationListener</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">getApplicationListeners</span><span class="token punctuation">(</span>
		<span class="token class-name">ApplicationEvent</span> event<span class="token punctuation">,</span> <span class="token class-name">ResolvableType</span> eventType<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       <span class="token comment">// 此处略去部分代码......</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanClassLoader <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span>
			<span class="token punctuation">(</span><span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">isCacheSafe</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanClassLoader<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
					<span class="token punctuation">(</span>sourceType <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">isCacheSafe</span><span class="token punctuation">(</span>sourceType<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanClassLoader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// Fully synchronized building and caching of a ListenerRetriever</span>
		<span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>retrievalMutex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			retriever <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>retrieverCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>retriever <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">return</span> retriever<span class="token punctuation">.</span><span class="token function">getApplicationListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
			retriever <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListenerRetriever</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApplicationListener</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">></span></span> listeners <span class="token operator">=</span>
					<span class="token function">retrieveApplicationListeners</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> sourceType<span class="token punctuation">,</span> retriever<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>retrieverCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> retriever<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> listeners<span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// No ListenerRetriever caching -> no synchronization necessary</span>
		<span class="token keyword">return</span> <span class="token function">retrieveApplicationListeners</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> sourceType<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApplicationListener</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">retrieveApplicationListeners</span><span class="token punctuation">(</span>
		<span class="token class-name">ResolvableType</span> eventType<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> sourceType<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ListenerRetriever</span> retriever<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

	<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApplicationListener</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">></span></span> allListeners <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApplicationListener</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">></span></span> listeners<span class="token punctuation">;</span>
	<span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> listenerBeans<span class="token punctuation">;</span>
	<span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>retrievalMutex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		listeners <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultRetriever<span class="token punctuation">.</span>applicationListeners<span class="token punctuation">)</span><span class="token punctuation">;</span>
		listenerBeans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultRetriever<span class="token punctuation">.</span>applicationListenerBeans<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// Add programmatically registered listeners, including ones coming</span>
	<span class="token comment">// from ApplicationListenerDetector (singleton beans and inner beans).</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ApplicationListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> listener <span class="token operator">:</span> listeners<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">supportsEvent</span><span class="token punctuation">(</span>listener<span class="token punctuation">,</span> eventType<span class="token punctuation">,</span> sourceType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>retriever <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				retriever<span class="token punctuation">.</span>applicationListeners<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
			allListeners<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token class-name">AnnotationAwareOrderComparator</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>allListeners<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>retriever <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> retriever<span class="token punctuation">.</span>applicationListenerBeans<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		retriever<span class="token punctuation">.</span>applicationListeners<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		retriever<span class="token punctuation">.</span>applicationListeners<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>allListeners<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> allListeners<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>上述代码中根据事件类型获取所有Listener，然后根据<code>AnnotationAwareOrderComparator.sort(allListeners)</code>对Listener进行排序。</p>
</blockquote>
<h1 id="三、AnnotationAwareOrderComparator排序原理"><a href="#三、AnnotationAwareOrderComparator排序原理" class="headerlink" title="三、AnnotationAwareOrderComparator排序原理"></a>三、AnnotationAwareOrderComparator排序原理</h1><h2 id="AnnotationAwareOrderComparator"><a href="#AnnotationAwareOrderComparator" class="headerlink" title="AnnotationAwareOrderComparator"></a>AnnotationAwareOrderComparator</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AnnotationAwareOrderComparator</span> <span class="token keyword">extends</span> <span class="token class-name">OrderComparator</span> <span class="token punctuation">&#123;</span>

	<span class="token comment">/**
	 * This implementation checks for &#123;@link Order @Order&#125; or
	 * &#123;@link javax.annotation.Priority @Priority&#125; on various kinds of
	 * elements, in addition to the &#123;@link org.springframework.core.Ordered&#125;
	 * check in the superclass.
	 */</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token annotation punctuation">@Nullable</span>
	<span class="token keyword">protected</span> <span class="token class-name">Integer</span> <span class="token function">findOrder</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">Integer</span> order <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">findOrder</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>order <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> order<span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span> <span class="token function">findOrderFromAnnotation</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token annotation punctuation">@Nullable</span>
	<span class="token keyword">private</span> <span class="token class-name">Integer</span> <span class="token function">findOrderFromAnnotation</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">AnnotatedElement</span> element <span class="token operator">=</span> <span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">AnnotatedElement</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token class-name">AnnotatedElement</span><span class="token punctuation">)</span> obj <span class="token operator">:</span> obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">MergedAnnotations</span> annotations <span class="token operator">=</span> <span class="token class-name">MergedAnnotations</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> <span class="token class-name">SearchStrategy</span><span class="token punctuation">.</span><span class="token constant">TYPE_HIERARCHY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Integer</span> order <span class="token operator">=</span> <span class="token class-name">OrderUtils</span><span class="token punctuation">.</span><span class="token function">getOrderFromAnnotations</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> annotations<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>order <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> obj <span class="token keyword">instanceof</span> <span class="token class-name">DecoratingProxy</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> <span class="token function">findOrderFromAnnotation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DecoratingProxy</span><span class="token punctuation">)</span> obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDecoratedClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span> order<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="OrderComparator"><a href="#OrderComparator" class="headerlink" title="OrderComparator"></a>OrderComparator</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderComparator</span> <span class="token keyword">implements</span> <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compare</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> o1<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> o2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token function">doCompare</span><span class="token punctuation">(</span>o1<span class="token punctuation">,</span> o2<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">doCompare</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> o1<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> o2<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">OrderSourceProvider</span> sourceProvider<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">boolean</span> p1 <span class="token operator">=</span> <span class="token punctuation">(</span>o1 <span class="token keyword">instanceof</span> <span class="token class-name">PriorityOrdered</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">boolean</span> p2 <span class="token operator">=</span> <span class="token punctuation">(</span>o2 <span class="token keyword">instanceof</span> <span class="token class-name">PriorityOrdered</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>p1 <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>p2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p2 <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>p1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">int</span> i1 <span class="token operator">=</span> <span class="token function">getOrder</span><span class="token punctuation">(</span>o1<span class="token punctuation">,</span> sourceProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> i2 <span class="token operator">=</span> <span class="token function">getOrder</span><span class="token punctuation">(</span>o2<span class="token punctuation">,</span> sourceProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>i1<span class="token punctuation">,</span> i2<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">OrderSourceProvider</span> sourceProvider<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">Integer</span> order <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token comment">// 此处略去部分代码</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span>order <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> order <span class="token operator">:</span> <span class="token function">getOrder</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token class-name">Integer</span> order <span class="token operator">=</span> <span class="token function">findOrder</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>order <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">return</span> order<span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span> <span class="token class-name">Ordered</span><span class="token punctuation">.</span><span class="token constant">LOWEST_PRECEDENCE</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p><code>AnnotationAwareOrderComparator</code> 继承 <code>OrderComparator</code>，获取对象的Order值并进行排序，如果Order为空，则会被设置为最小优先级。</p>
</blockquote>
<h2 id="OrderUtils获取对象Order值"><a href="#OrderUtils获取对象Order值" class="headerlink" title="OrderUtils获取对象Order值"></a>OrderUtils获取对象Order值</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">OrderUtils</span> <span class="token punctuation">&#123;</span>

	<span class="token comment">/**
	 * Return the order from the specified annotations collection.
	 * &lt;p>Takes care of &#123;@link Order @Order&#125; and
	 * &#123;@code @javax.annotation.Priority&#125;.
	 * @param element the source element
	 * @param annotations the annotation to consider
	 * @return the order value, or &#123;@code null&#125; if none can be found
	 */</span>
	<span class="token annotation punctuation">@Nullable</span>
	<span class="token keyword">static</span> <span class="token class-name">Integer</span> <span class="token function">getOrderFromAnnotations</span><span class="token punctuation">(</span><span class="token class-name">AnnotatedElement</span> element<span class="token punctuation">,</span> <span class="token class-name">MergedAnnotations</span> annotations<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>element <span class="token keyword">instanceof</span> <span class="token class-name">Class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> <span class="token function">findOrder</span><span class="token punctuation">(</span>annotations<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token class-name">Object</span> cached <span class="token operator">=</span> orderCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>cached <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> <span class="token punctuation">(</span>cached <span class="token keyword">instanceof</span> <span class="token class-name">Integer</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> cached <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token class-name">Integer</span> result <span class="token operator">=</span> <span class="token function">findOrder</span><span class="token punctuation">(</span>annotations<span class="token punctuation">)</span><span class="token punctuation">;</span>
		orderCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> result <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> result <span class="token operator">:</span> <span class="token constant">NOT_ANNOTATED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> result<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token annotation punctuation">@Nullable</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Integer</span> <span class="token function">findOrder</span><span class="token punctuation">(</span><span class="token class-name">MergedAnnotations</span> annotations<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">MergedAnnotation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">></span></span> orderAnnotation <span class="token operator">=</span> annotations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Order</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>orderAnnotation<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> orderAnnotation<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token class-name">MergedAnnotation</span><span class="token punctuation">.</span><span class="token constant">VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token class-name">MergedAnnotation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> priorityAnnotation <span class="token operator">=</span> annotations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">JAVAX_PRIORITY_ANNOTATION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>priorityAnnotation<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> priorityAnnotation<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token class-name">MergedAnnotation</span><span class="token punctuation">.</span><span class="token constant">VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>从上面源码可以看出,如果没有设置<code>@Order</code>或是<code>javax.annotation.Priority</code>, Order值返回为<code>null</code>。</p>
</blockquote>
<h1 id="四、EnvironmentChangeEvent的Listener有哪些"><a href="#四、EnvironmentChangeEvent的Listener有哪些" class="headerlink" title="四、EnvironmentChangeEvent的Listener有哪些"></a>四、EnvironmentChangeEvent的Listener有哪些</h1><p>EnvironmentChangeEvent的Listener：</p>
<ul>
<li>默认的EnvironmentChangeEvent的Listener <code>ConfigurationPropertiesRebinder</code></li>
<li>自定义的EnvironmentChangeEvent的Listener <code>CallbackConfig</code></li>
</ul>
<p>其它EnvironmentChangeEvent的Listener暂不做分析处理。</p>
<h2 id="ConfigurationPropertiesRebinder"><a href="#ConfigurationPropertiesRebinder" class="headerlink" title="ConfigurationPropertiesRebinder"></a>ConfigurationPropertiesRebinder</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>context<span class="token punctuation">.</span>properties</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@ManagedResource</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigurationPropertiesRebinder</span>
		<span class="token keyword">implements</span> <span class="token class-name">ApplicationContextAware</span><span class="token punctuation">,</span> <span class="token class-name">ApplicationListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EnvironmentChangeEvent</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    
    <span class="token annotation punctuation">@ManagedOperation</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rebind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> name <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beans<span class="token punctuation">.</span><span class="token function">getBeanNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token function">rebind</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token annotation punctuation">@ManagedOperation</span>
	<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">rebind</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>beans<span class="token punctuation">.</span><span class="token function">getBeanNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
				<span class="token class-name">Object</span> bean <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">AopUtils</span><span class="token punctuation">.</span><span class="token function">isAopProxy</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
					bean <span class="token operator">=</span> <span class="token class-name">ProxyUtils</span><span class="token punctuation">.</span><span class="token function">getTargetObject</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">&#125;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
					<span class="token comment">// 此处省略部分代码......</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">.</span><span class="token function">getAutowireCapableBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
							<span class="token punctuation">.</span><span class="token function">destroyBean</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">.</span><span class="token function">getAutowireCapableBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
							<span class="token punctuation">.</span><span class="token function">initializeBean</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>
			<span class="token comment">// 此处省略异常处理代码......</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>            <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>在上述Listener中对<code>@ConfigurationProperties</code>标注的类进行销毁和重新创建，实现了配置更新。</p>
</blockquote>
<h2 id="CallbackConfig-1"><a href="#CallbackConfig-1" class="headerlink" title="CallbackConfig"></a>CallbackConfig</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Accessors</span><span class="token punctuation">(</span>chain <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"config.callback"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RefreshScope</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CallbackConfig</span> <span class="token keyword">implements</span> <span class="token class-name">InitializingBean</span><span class="token punctuation">,</span> <span class="token class-name">ApplicationListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EnvironmentChangeEvent</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> log <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token string">"CONFIG_LOG"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChatbotConfig</span><span class="token punctuation">></span></span> configs<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">ChatbotConfig</span><span class="token punctuation">></span></span> <span class="token constant">CHATBOT_MAP</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ChatbotConfig</span> <span class="token function">fetchByUserId</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> userId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token constant">CHATBOT_MAP</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Config chatbot callback information:&#123;&#125;!"</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>configs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">initConfigs</span><span class="token punctuation">(</span>configs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onApplicationEvent</span><span class="token punctuation">(</span><span class="token class-name">EnvironmentChangeEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Nacos refresh config information the current information is:&#123;&#125;!"</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>configs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">initConfigs</span><span class="token punctuation">(</span>configs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="五、原因分析"><a href="#五、原因分析" class="headerlink" title="五、原因分析"></a>五、原因分析</h1><p>EnvironmentChangeEvent的Listener中有个默认的 <code>ConfigurationPropertiesRebinder</code>，这个Listener实现了配置的动态更新，但是这个Listener未使用<code>@Order</code> 注解，所以优先级是最小的。<br>我们自定义的EnvironmentChangeEvent的Listener <code>CallbackConfig</code> 中虽然设置了 <code>@Order</code> 注解并且默认值为最小优先级，但是和 <code>ConfigurationPropertiesRebinder</code> 的优先级是相同的，它们的执行顺序取决于加入集合的顺序，所以执行顺序不可控。无法通过设置 <code>@Order</code> 将自定的Listener放在 <code>ConfigurationPropertiesRebinder</code> 之后执行。</p>
<h1 id="六、解决方案"><a href="#六、解决方案" class="headerlink" title="六、解决方案"></a>六、解决方案</h1><p>如果是单独使用 <code>@ConfigurationProperties</code> 注解，则可以将配置的初始化验证放在 <code>@PostConstruct</code> 中处理。</p>
<blockquote>
<p>There is one exception. Any @ConfigurationProperties bean that is also in @RefreshScope is not rebound when the event is consumed. They could be rebound, but in the light of what happens in @RefreshScope, it would be redundant. Instead, they follow the usual path of @RefreshScope beans.</p>
</blockquote>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://gist.github.com/dsyer/a43fe5f74427b371519af68c5c4904c7">Dynamic Configuration Properties in Spring Boot and Spring Cloud</a></p>
]]></content>
      <categories>
        <category>spring</category>
      </categories>
      <tags>
        <tag>spring</tag>
        <tag>EnvironmentChangeEvent</tag>
        <tag>ApplicationListener</tag>
      </tags>
  </entry>
  <entry>
    <title>Jack Welch关于绩效、活力曲线的观点</title>
    <url>/2022/04/04/thought/jackwelch-guan-yu-ji-xiao-huo-li-qu-xian-de-guan-dian/</url>
    <content><![CDATA[<blockquote>
<p>视频地址：<a href="https://www.bilibili.com/video/BV1BK4y1L7AU?p=1&share_medium=iphone&share_plat=ios&share_session_id=D3F36362-7E54-4577-9988-7E9E87ABBEBF&share_source=GENERIC&share_tag=s_i&timestamp=1648028847&unique_k=sXlj4Kj">Jack Welch关于绩效、活力曲线的观点</a></p>
</blockquote>
<h1 id="一、Jack-Welch简介"><a href="#一、Jack-Welch简介" class="headerlink" title="一、Jack Welch简介"></a>一、Jack Welch简介</h1><p>杰克·韦尔奇，美国企业家，于1981年至2001年担任通用电气（GE, General Electric）第八任首席执行官期间将该公司营业额提升到4100亿美金，有“中子弹杰克”（Neutron Jack）之称。</p>
<h2 id="1-1-职业履历"><a href="#1-1-职业履历" class="headerlink" title="1.1 职业履历"></a>1.1 职业履历</h2><p>韦尔奇在1960年进入通用电气位于麻州皮茨菲尔德的塑胶部门担任工程师，当时年薪10,500美元。1972年升为该部门的副总，1977年升为部门总经理，1979年升为副董事长，1981年升为第八任最高首席执行官。在20年的生涯后于2001年退休。</p>
<h2 id="1-2-经营手法"><a href="#1-2-经营手法" class="headerlink" title="1.2 经营手法"></a>1.2 经营手法</h2><p>韦尔奇担任通用电气首席执行官起，开始针对公司进行组织再造，他以“三个圈圈”列出通用电气的留存事业，将其他绩效不好的事业部出售或关闭，包括了成为通用电气传统的家电事业。因此，通用电气原有数百个事业，被缩减到不到20个事业。</p>
<p>1996年起，韦尔奇推动“六标准差”（6-Sigma），以将通用电气产品的不良率降低到千万分之34。</p>
<p>韦尔奇最受争议的改革，就是大幅裁员。通用电气员工人数由最高时的41万人裁减到23万人，裁员率高达40%。韦尔奇外号“中子弹杰克”的由来，即因为韦尔奇的大幅裁员有如中子弹一样的特性：杀人而不伤一物。</p>
<p>韦尔奇将通用电气转变为学习型组织，将原有企业内的教育中心投入经费改造为克顿维尔（Crotonville）管理学院。通用电气许多中高阶主管皆到过此学院学习。</p>
<p>借由一连串的兴革，在韦尔奇2001年9月底退休时，通用电气的年营业额从上任前的250亿美元成长到1400亿美元，获利由15亿美元上升到127亿美元。</p>
<h1 id="二、绩效及活力曲线"><a href="#二、绩效及活力曲线" class="headerlink" title="二、绩效及活力曲线"></a>二、绩效及活力曲线</h1><p>Jack Welch作为经理人最显著的4大特点：真实、活力、坦率、差异化管理。</p>
<h2 id="2-1-真实"><a href="#2-1-真实" class="headerlink" title="2.1 真实"></a>2.1 真实</h2><p>一个领导者必须真实。领导者不必刻意去扮演什么样的角色，因为人们轻易发现“伪君子”，人们希望看到的是表里如一你，你可以信任、可以依赖、可以和睦、融洽相处。</p>
<h2 id="2-2-活力"><a href="#2-2-活力" class="headerlink" title="2.2 活力"></a>2.2 活力</h2><p>活力与激励紧密关联，领导者应该具有强烈的使命感和明确的愿景，并且对此坚信不疑。同时激励感染与这个愿景相关的人主动追随你去追求勾勒出的使命和愿景。激励的关键在于让团队成员感受到愿景，明白前进的方向。</p>
<h3 id="2-2-1-如何激发活力？"><a href="#2-2-1-如何激发活力？" class="headerlink" title="2.2.1 如何激发活力？"></a>2.2.1 如何激发活力？</h3><p>激发团队成员的活力，需要激发大家的互动，分享每个人的知识与经验，从成员身上互相学习，汲取集体的智慧，最后达成统一共识。</p>
<h2 id="2-3-坦率"><a href="#2-3-坦率" class="headerlink" title="2.3 坦率"></a>2.3 坦率</h2><p>坦率就是要讲实话，鼓励员工说出自己的真实想法。在进行差异化管理的时候，坦率是差异化管理的基础，组织要对员工进行客观真实的评估。</p>
<h2 id="2-4-差异化管理"><a href="#2-4-差异化管理" class="headerlink" title="2.4 差异化管理"></a>2.4 差异化管理</h2><p>每个人都应该清楚自己在团队中的位置，271原则可以让每个人能够明确自己的位置。虽然这个机制存在不少偏见、不公，甚至会造成积怨，但是就实际来说它是最有效的方式让成员清楚自己在组织中的定位。</p>
<h3 id="顶尖的20"><a href="#顶尖的20" class="headerlink" title="顶尖的20%"></a>顶尖的20%</h3><p>这类人活力十足、会鼓舞他人、讨人喜欢，同时它们喜欢看到别人成长、喜欢鼓励别人，不自私小气，在他们身上有一种慷慨的精神。他们真心的为他人的成功感到高兴、能够主动提拔人才，形成一种积极的氛围，极大大家的潜力。</p>
<h3 id="中坚力量70"><a href="#中坚力量70" class="headerlink" title="中坚力量70%"></a>中坚力量70%</h3><p>这个群里虽然不是举足轻重的，但是也是非常重要的，这类人聪明、优秀、有价值、努力工作。</p>
<blockquote>
<h4 id="存在失去21-26-这个区间成员的风险"><a href="#存在失去21-26-这个区间成员的风险" class="headerlink" title="存在失去21% - 26%这个区间成员的风险"></a>存在失去21% - 26%这个区间成员的风险</h4><p>必须要不断的去解释当前的评估是周期性的而非永久的，他们还有提升的空间，同时在评估中记录他们做的好的地方以及存在的问题和需要改进的地方，定期沟通同步，达成一致。</p>
</blockquote>
<h3 id="末尾的10"><a href="#末尾的10" class="headerlink" title="末尾的10%"></a>末尾的10%</h3><p>这类群里的特点有：不擅长团队合作、无精打采、冷嘲热讽，这些人身上充满负能量而且总喜欢泼冷水。</p>
<blockquote>
<h4 id="搅局者或者是泼凉水的人"><a href="#搅局者或者是泼凉水的人" class="headerlink" title="搅局者或者是泼凉水的人"></a>搅局者或者是泼凉水的人</h4><p>这些人中有一些聪明的人，他们勇于挑战权威，敢于说真话，这些人值得尊敬，领导着也应该听取他们的声音。所以对于这些人要给予适当的容忍 ，但要做好约束。</p>
</blockquote>
<p><font color="#ff0000">明令禁止：大会之后开小会</font></p>
<h2 id="2-5-经验建议"><a href="#2-5-经验建议" class="headerlink" title="2.5 经验建议"></a>2.5 经验建议</h2><h3 id="快速行动"><a href="#快速行动" class="headerlink" title="快速行动"></a>快速行动</h3><p>当我们做出决定后，我们应该立即行动。即使我们的决定面临重大的后果，但是犹豫不能让我们把这种后果降低或消除，该来的终究会来，犹豫不决畏畏缩缩反而会引起为严重的后果。</p>
<h3 id="继任计划，如何传递好交接棒？"><a href="#继任计划，如何传递好交接棒？" class="headerlink" title="继任计划，如何传递好交接棒？"></a>继任计划，如何传递好交接棒？</h3><p>提前启动选择候选人的几乎，人是会变的，生活在变化、家庭关系在变化，你无法知道在下一个阶段人会变成什么样？多挑选一些候选人，提前进行。</p>
<h3 id="鼓励庆祝胜利"><a href="#鼓励庆祝胜利" class="headerlink" title="鼓励庆祝胜利"></a>鼓励庆祝胜利</h3><p>任何小小的胜利都需要庆祝，这能激励整个团队，鼓励他们继续加油。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>Jack Welch管理的4大特点：真实、活力、坦率、差异化管理。</p>
<ul>
<li>真实：一个真实的领导者才能够被信任和依赖，才能和团队成员和睦、融洽相处。</li>
<li>活力：领导者必须要要有明确的使命和愿景，同时感染激励团队成员主动追随你去追求勾勒出的使命和愿景。激励的关键在于让团队成员感受到使命和愿景，明白前进的方向。</li>
<li>坦率：坦率是差异化管理的基础，在进行差异化管理的时候，组织与成员之间沟通反馈必须建立在坦率的基础之上。</li>
<li>差异化管理看：组织内部需要建立271机制，虽然这个机制存在不少偏见、不公，甚至会造成积怨，但是就实际来说它是最有效的方式让成员清楚自己在组织中的定位，从而形成正向激励，激发团队的活力。271机制中：顶尖的20%，这些人属于A类员工，他们活力十足且能力优秀同时能够主动培养提拔人才，这类群体需要给予大幅激励倾斜；中坚力量70%：这些人属于B类员工，他们是团队的中坚力量，需要注意21%-26%区间人，要做好评估结果的反馈和沟通并达成一致，同时提供更多机会促进其发展；末尾的10%：存在问题的员工，对于这类群体，如果还有改变的空间，可以为其提供必要支持和帮助，帮助他们快速改变，否则应尽快优化处理。</li>
<li>快速行动： 当我们做出决定后，我们应该立即行动。即使我们的决定面临重大的后果，但是犹豫不能让我们把这种后果降低或消除，该来的终究会来，犹豫不决畏畏缩缩反而会引起为严重的后果。</li>
</ul>
]]></content>
      <categories>
        <category>thought</category>
      </categories>
      <tags>
        <tag>Jack Welch</tag>
        <tag>绩效</tag>
      </tags>
  </entry>
  <entry>
    <title>从年底人才盘点评委席，看打工人为什么要把自己&quot;产品化&quot;</title>
    <url>/2025/12/29/thought/cong-nian-di-ren-cai-pan-dian-ping-wei-xi-kan-da-gong-ren-wei-shi-me-yao-ba-zi-ji-chan-pin-hua/</url>
    <content><![CDATA[<blockquote>
<p>一个人的一生，最重要的事业就是经营好自己。把“自己”当作一款持续迭代的产品，建立清晰的定位、稳定的价值交付、可规模化的增长与运营体系，你会更快、更稳地抵达想去的地方。</p>
</blockquote>
<p><img src="/2025/12/29/thought/cong-nian-di-ren-cai-pan-dian-ping-wei-xi-kan-da-gong-ren-wei-shi-me-yao-ba-zi-ji-chan-pin-hua/%E6%8A%8A%E8%87%AA%E5%B7%B1%E4%BA%A7%E5%93%81%E5%8C%96.png" alt="把自己产品化"></p>
<p>作为公司年底人才盘点的评委，这几年我反复看到同一个画面：有的人在原地踏步，有的人忙得昏天黑地却难有突破，还有的人明明聪明、肯干，却在关键节点一再与机会擦肩而过。更扎心的是，他们中的绝大多数，并不是“不够努力”，而是不知道<strong>该往哪里用力</strong>。</p>
<span id="more"></span>

<p>如果你把自己看成一个“岗位上的螺丝钉”，你自然会习惯性地等任务、做执行、盯考核；但如果你开始把自己当成一款“产品”，你就会倒过来思考：</p>
<ul>
<li>我到底<strong>解决什么问题</strong>？</li>
<li>我相对于同龄人、同岗位的<strong>独特价值</strong>是什么？</li>
<li>这些价值，能不能被<strong>封装成资产</strong>，在我不亲自盯着的时候也能持续发挥作用？</li>
</ul>
<p>这正是《纳瓦尔宝典》里“把自己产品化”的底层逻辑，而在我一次次的人才评审中，也越来越确定：<strong>能把自己产品化的人，几乎都不会被时代轻易淘汰。</strong></p>
<h2 id="一、从评委席看到的打工人困境"><a href="#一、从评委席看到的打工人困境" class="headerlink" title="一、从评委席看到的打工人困境"></a>一、从评委席看到的打工人困境</h2><p>人才盘点的时候，评委不会只看“你有多辛苦”，而是看“你这两三年到底长成了一个什么样的‘产品’”。在这个视角下，很多职场困境被放大得格外清晰。</p>
<h3 id="1-很努力，但问题选错了"><a href="#1-很努力，但问题选错了" class="headerlink" title="1. 很努力，但问题选错了"></a>1. 很努力，但问题选错了</h3><p>有一类人，全年工时、项目数量都很好看，日报、周报密密麻麻，但当我们去看“结果”——</p>
<ul>
<li>可复用的沉淀很少：文档散落各处，没有形成方法论；</li>
<li>对业务的关键指标影响有限：做了很多“忙事”，真正改变业务盘面的成果不多；</li>
<li>替代成本很低：离开这个人，一两个月就可以找到差不多的替补。</li>
</ul>
<p>他们的问题不是不努力，而是<strong>只在“卖时间”而没有“造资产”</strong>。这类人在评审中，绩效也许不差，但很难在关键晋升节点评为“强烈推荐”。</p>
<h3 id="2-不知道往哪儿用力"><a href="#2-不知道往哪儿用力" class="headerlink" title="2. 不知道往哪儿用力"></a>2. 不知道往哪儿用力</h3><p>第二类人，典型表现是：</p>
<ul>
<li>平时也在学习，但内容非常碎片化，今天算法，明天英语，后天新框架；</li>
<li>遇到新机会，很容易被“别人都在做”的声音带着走；</li>
<li>一年到头回头看，似乎什么都学了一点，又似乎什么都没真正建立壁垒。</li>
</ul>
<p>《异类》里有个重要观点：真正的“异类”，不是偶然的天赋异禀，而是在某个方向上<strong>长期、聚焦、带反馈的刻意练习</strong>叠加了环境优势。大量平庸的努力，本质上是因为没有选定一个足够清晰的“赛道”，也没有为自己设计一个可持续迭代的“产品路线图”。</p>
<h3 id="3-把自己完全交给公司流程"><a href="#3-把自己完全交给公司流程" class="headerlink" title="3. 把自己完全交给公司流程"></a>3. 把自己完全交给公司流程</h3><p>还有一类人，他们能力不错、态度也不差，但习惯于：</p>
<ul>
<li>等 leader 分配任务，而不是主动提出问题、设计方案；</li>
<li>等组织安排培训，而不是根据自己的产品定位去“反向定制”学习路径；</li>
<li>等项目“轮到自己”，而不是主动争取关键战役的参战机会。</li>
</ul>
<p>在公司视角里,这样的人往往被定义为”稳定、可靠、可用”,但很难被视为”核心种子选手”。不是因为他们不聪明,而是因为他们从没把自己当作一个独立运转的”产品”,去主动思考:<strong>我要成为什么样的人,靠什么价值被记住、被需要?</strong></p>
<p><img src="/2025/12/29/thought/cong-nian-di-ren-cai-pan-dian-ping-wei-xi-kan-da-gong-ren-wei-shi-me-yao-ba-zi-ji-chan-pin-hua/%E6%89%93%E5%B7%A5%E4%BA%BA%E5%9B%B0%E5%A2%83vs%E6%9D%A0%E6%9D%86%E6%95%88%E5%BA%94.png" alt="打工人困境vs杠杆效应"></p>
<h2 id="二、为什么要把自己产品化"><a href="#二、为什么要把自己产品化" class="headerlink" title="二、为什么要把自己产品化?"></a>二、为什么要把自己产品化?</h2><p>在《纳瓦尔宝典》里，纳瓦尔反复强调：真正的“财富”，不是工资单，而是<strong>在你睡觉时还能替你赚钱的资产</strong>。这套逻辑放到个体身上，就是——</p>
<ul>
<li><strong>时间无法无限出售</strong>：你每天只有 24 小时，靠加班堆出来的收入，天花板注定很低；</li>
<li><strong>资产才能替你工作</strong>：写过的代码、搭过的系统、沉淀的方法论、对行业的理解，如果被封装成文档、课程、工具、影响力，就能在你不在场时持续发挥价值；</li>
<li><strong>技术与互联网放大“头部个体”</strong>：时代越来越偏爱“能直接为大量人群创造价值的人”。如果你只在组织内部、只为上级一个人创造价值，你很难享受到这种放大效应。</li>
</ul>
<p>所以，“把自己产品化”并不是要你立刻辞职创业，而是：</p>
<blockquote>
<p>用<strong>商业世界的视角</strong>重新审视自己：我究竟是一款什么产品？现在处在什么版本？未来要迭代成什么样？</p>
</blockquote>
<p>当你这样思考时，你会自然从“打工思维”切换到“经营思维”：</p>
<ul>
<li>不再只看今年绩效,而会看 3~5 年后自己能否成为稀缺资产;</li>
<li>不再只盯手上的任务,而会主动设计自己的”功能矩阵”和”护城河”;</li>
<li>不再只关心领导怎么看你,而会关心:<strong>市场会不会为你买单</strong>。</li>
</ul>
<p><img src="/2025/12/29/thought/cong-nian-di-ren-cai-pan-dian-ping-wei-xi-kan-da-gong-ren-wei-shi-me-yao-ba-zi-ji-chan-pin-hua/%E5%BB%BA%E7%AB%8B%E4%BA%A7%E5%93%81%E6%80%9D%E7%BB%B4.png" alt="建立产品思维"></p>
<h2 id="三、给自己做一次”产品体检”-找到属于你的优势位"><a href="#三、给自己做一次”产品体检”-找到属于你的优势位" class="headerlink" title="三、给自己做一次”产品体检”:找到属于你的优势位"></a>三、给自己做一次”产品体检”:找到属于你的优势位</h2><p>《异类》提醒我们：所谓“天赋 + 机会”，很多时候并不是天上掉下来的，而是你能不能<strong>看见自己适合的赛道，并敢于在上面长期下注</strong>。</p>
<p>把自己产品化的第一步，就是诚实地完成一次“产品体检”。你可以从三个维度来盘一盘：</p>
<h3 id="1-你的“品类”是什么？"><a href="#1-你的“品类”是什么？" class="headerlink" title="1. 你的“品类”是什么？"></a>1. 你的“品类”是什么？</h3><p>先不要急着列技能表，先问自己：</p>
<ul>
<li>如果把你当成一个产品，你现在属于什么“类别”？<ul>
<li>是“解决复杂技术问题的工程师”？</li>
<li>是“能把抽象问题翻译成可执行方案的 PM”？</li>
<li>还是“能把混乱项目拉回正轨的项目经理”？</li>
</ul>
</li>
</ul>
<p>一个粗糙但好用的判断是：</p>
<blockquote>
<p><strong>当别人向你求助时，最常问的是哪一类问题？</strong></p>
</blockquote>
<p>那很可能就是你在别人眼里“已经比较好用”的功能，也是你未来可以继续强化的方向。</p>
<h3 id="2-你的“核心优势”在哪？"><a href="#2-你的“核心优势”在哪？" class="headerlink" title="2. 你的“核心优势”在哪？"></a>2. 你的“核心优势”在哪？</h3><p>优势不只是“我会什么”，而是<strong>在真实场景下，你比别人更容易做出的好结果</strong>。可以从这三个交集去找：</p>
<ul>
<li>你做起来<strong>不那么费劲</strong>，别人却觉得很难的事；</li>
<li>你反复做，结果<strong>稳定在中上水平以上</strong>；</li>
<li>为这件事<strong>别人愿意付费</strong>，或愿意把关键任务交给你。</li>
</ul>
<p>把这些具体场景写下来，不要只写“擅长沟通”，而是写：</p>
<ul>
<li>在多方博弈的项目中，你如何撮合共识？</li>
<li>在一次重要线上事故中，你如何主持复盘？</li>
</ul>
<p>这些场景，就是你“产品说明书”里最重要的部分。</p>
<h3 id="3-你的“环境优势”是什么？"><a href="#3-你的“环境优势”是什么？" class="headerlink" title="3. 你的“环境优势”是什么？"></a>3. 你的“环境优势”是什么？</h3><p>《异类》强调了“出生时间、行业周期、文化环境”对个体的巨大影响。你无法重来一遍，但你可以问：</p>
<ul>
<li>你所在的行业、公司、岗位，现在正处在什么周期？是上升期还是存量博弈？</li>
<li>你的上级、同事、资源网络，更偏向哪种类型的机会？</li>
<li>你的业余时间、兴趣爱好，是否给你带来了某种“隐性优势”？</li>
</ul>
<p>把这些外部条件看清,是为了避免一种常见误区:<strong>用错误的环境解释自己的能力问题,或者用错误的能力去对抗环境问题。</strong></p>
<p><img src="/2025/12/29/thought/cong-nian-di-ren-cai-pan-dian-ping-wei-xi-kan-da-gong-ren-wei-shi-me-yao-ba-zi-ji-chan-pin-hua/%E4%BC%98%E5%8A%BF%E5%AE%9A%E4%BD%8D%E9%9B%B7%E8%BE%BE.png" alt="优势定位雷达"></p>
<h2 id="四、五步实操-把自己从”员工”升级为”产品”"><a href="#四、五步实操-把自己从”员工”升级为”产品”" class="headerlink" title="四、五步实操:把自己从”员工”升级为”产品”"></a>四、五步实操:把自己从”员工”升级为”产品”</h2><p>做完”体检”之后，接下来就是实操环节。你可以参考下面这五步，把自己当作一个要上市的产品来经营。</p>
<div class="mermaid-wrap"><pre class="mermaid-src" data-config="{}" hidden>
    graph LR
    A[步骤1&lt;br&#x2F;&gt;明确价值主张] --&gt; B[步骤2&lt;br&#x2F;&gt;盘点功能组件]
    B --&gt; C[步骤3&lt;br&#x2F;&gt;免费内容测试]
    C --&gt; D{反馈&lt;br&#x2F;&gt;如何?}
    D --&gt;|积极| E[步骤4&lt;br&#x2F;&gt;封装产品]
    D --&gt;|一般| F[调整优化]
    F --&gt; C
    E --&gt; G[步骤5&lt;br&#x2F;&gt;选择杠杆]
    G --&gt; H[持续迭代]
    H --&gt; I{需要&lt;br&#x2F;&gt;调整?}
    I --&gt;|是| A
    I --&gt;|否| J[成功:建立护城河]
    
    style A fill:#e3f2fd
    style E fill:#e1f5e1
    style G fill:#fff9c4
    style J fill:#ffebee
    style D fill:#fff4e1
    style I fill:#fff4e1
  </pre></div>

<p><strong>杠杆类型说明：</strong></p>
<ul>
<li><strong>初期</strong>：人力杠杆（带人、分享经验）</li>
<li><strong>中期</strong>：媒体杠杆（文档、文章、工具）</li>
<li><strong>成熟期</strong>：资本杠杆（品牌、项目投资）</li>
</ul>
<h3 id="第一步：写清你的“价值主张”"><a href="#第一步：写清你的“价值主张”" class="headerlink" title="第一步：写清你的“价值主张”"></a>第一步：写清你的“价值主张”</h3><p>拿出一张纸，只回答一个问题：</p>
<blockquote>
<p>如果用一两句话介绍自己，你希望别人记住你“能帮他们解决什么问题”？</p>
</blockquote>
<p>避免写成“空心化标签”（如：负责 XX 模块开发、参与 YY 项目），而是写成<strong>对他人的具体价值</strong>：</p>
<ul>
<li>“我擅长把混乱的需求拆解成可落地方案，并推动多方协作落地”；</li>
<li>“我专注在高并发场景下的系统稳定性建设，能设计出可扩展的治理方案”；</li>
<li>“我能把抽象的技术概念讲清楚，让业务方真正理解技术选择背后的 trade-off”。</li>
</ul>
<p>这就是你的“产品定位文案”。先不追求完美，写出来、挂在桌前，后面可以不断迭代。</p>
<h3 id="第二步：盘点可产品化的“功能组件”"><a href="#第二步：盘点可产品化的“功能组件”" class="headerlink" title="第二步：盘点可产品化的“功能组件”"></a>第二步：盘点可产品化的“功能组件”</h3><p>对照你的过往经历，把那些已经产生过好结果的行为，拆成可复用的“功能组件”：</p>
<ul>
<li>你是否有一套<strong>固定的分析框架</strong>？（比如排查线上故障时的步骤）</li>
<li>你是否有一些<strong>常用的模板</strong>？（复盘模板、项目规划模板、沟通邮件模板等）</li>
<li>你是否在某些场景里形成了<strong>个人 playbook</strong>？（如何启动一个新项目、如何带新人上手等）</li>
</ul>
<p>这些东西，都是可以被“产品化”的雏形：</p>
<ul>
<li>先整理成结构化的文档、流程图、清单；</li>
<li>再在团队内、小范围分享；</li>
<li>再慢慢对外输出，变成文章、分享、或内部课程。</li>
</ul>
<h3 id="第三步：用“免费内容”测试市场"><a href="#第三步：用“免费内容”测试市场" class="headerlink" title="第三步：用“免费内容”测试市场"></a>第三步：用“免费内容”测试市场</h3><p>《纳瓦尔宝典》反复提到：在你尝试收费之前，先用免费内容建立信任。对打工人来说，“免费内容”可以是：</p>
<ul>
<li>在公司内网写结构化的复盘和经验分享；</li>
<li>在社交媒体上输出你在某个细分领域的思考与案例；</li>
<li>给新人录屏讲解某个系统或工具的使用，并整理成公开材料。</li>
</ul>
<p>这个阶段，不要急于算“投入产出比”，更重要的是：</p>
<ul>
<li>看看大家<strong>会不会转发、收藏、评论、来问你问题</strong>；</li>
<li>看看你的哪类内容<strong>最容易引发共鸣</strong>，哪类内容大家“不太在意”；</li>
<li>看看是否有人愿意<strong>因为你，而选择参与某个项目或团队</strong>。</li>
</ul>
<p>这些反馈，就是你的“用户数据”。</p>
<h3 id="第四步：设计一两个“可复制”的正式产品"><a href="#第四步：设计一两个“可复制”的正式产品" class="headerlink" title="第四步：设计一两个“可复制”的正式产品"></a>第四步：设计一两个“可复制”的正式产品</h3><p>当你发现某些输出已经稳定受到欢迎，就可以往前迈一步，把它们封装成更“正式”的产品形态：</p>
<ul>
<li>面向内部：可以是一门系统化的小课、一套工具库、一套最佳实践手册；</li>
<li>面向外部：可以是系列文章、线上微课、开源项目、Newsletter 等。</li>
</ul>
<p>关键是两个字：</p>
<ul>
<li><strong>可复制</strong>：不依赖你每次从头做，而是可以被他人复用；</li>
<li><strong>可规模化</strong>：一份投入可以服务更多人，而不只是单点服务。</li>
</ul>
<p>从评委视角看，这一步非常关键——当一个人能围绕某个议题建立起<strong>稳定、持续的价值输出体系</strong>时，他在组织里的标签就会从“能干活”升级为“这块领域可以找他”。</p>
<h3 id="第五步：选择合适的杠杆，逐步放大"><a href="#第五步：选择合适的杠杆，逐步放大" class="headerlink" title="第五步：选择合适的杠杆，逐步放大"></a>第五步：选择合适的杠杆，逐步放大</h3><p>纳瓦尔把杠杆分为三类：<strong>人力、资本、代码 &#x2F; 媒体</strong>。对大多数职场人来说，可以循序渐进地用：</p>
<ul>
<li><strong>人力杠杆</strong>：带新人、组小团队，通过教会别人来放大自己的方法论；</li>
<li><strong>代码 &#x2F; 媒体杠杆</strong>：写工具、写文档、写文章、做分享，让“你不在场时，你的价值还在场”；</li>
<li><strong>资本杠杆</strong>：随着积累，适度投资在自己的继续教育、个人品牌建设或小项目上。</li>
</ul>
<p>不必一开始就“all in”，而是每年为自己设计一个小目标：</p>
<ul>
<li>今年,我至少完成一门系统化的内部分享;</li>
<li>今年,我至少把一个零散的能力沉淀成一份可复用的”产品”;</li>
<li>今年,我至少通过输出,认识 X 个领域内的同行或前辈。</li>
</ul>
<p><img src="/2025/12/29/thought/cong-nian-di-ren-cai-pan-dian-ping-wei-xi-kan-da-gong-ren-wei-shi-me-yao-ba-zi-ji-chan-pin-hua/%E4%B8%AA%E4%BA%BA%E4%BA%A7%E5%93%81%E5%8C%96%E8%BF%AD%E4%BB%A3%E8%B7%AF%E5%BE%84.png" alt="个人产品化迭代路径"></p>
<h2 id="五、常见误区-评委视角给你的几点提醒"><a href="#五、常见误区-评委视角给你的几点提醒" class="headerlink" title="五、常见误区:评委视角给你的几点提醒"></a>五、常见误区:评委视角给你的几点提醒</h2><p>在评委席上，我看到不少“自我提升”做得很用力，但方向明显跑偏的案例，大致集中在几类误区：</p>
<ul>
<li><p><strong>把“副业”当“产品”</strong>：</p>
<ul>
<li>做微商、跑网约车、做纯体力型兼职，本质上还是在“卖时间”；</li>
<li>真正的产品化，是让你的专业能力、认知和影响力，通过某种形式沉淀下来，持续创造价值。</li>
</ul>
</li>
<li><p><strong>急于定价收费</strong>：</p>
<ul>
<li>分享了几篇文章、帮几个人答疑，就迫不及待做付费课、卖咨询；</li>
<li>在信任和口碑还没建立之前，这种行为往往会损害你的长期品牌。</li>
</ul>
</li>
<li><p><strong>只看短期 ROI，忽视长期品牌</strong>：</p>
<ul>
<li>有的人只愿意做“当天有数据”的事情，不愿意做“慢热但复利”的积累；</li>
<li>但在人才盘点时，我们看的往往是<strong>过去两三年的整体成长轨迹</strong>和在关键战役中的表现，而不是你某一次“爆款”。</li>
</ul>
</li>
<li><p><strong>把产品化理解成“个人包装”甚至“人设运营”</strong>：</p>
<ul>
<li>这会导致你不敢暴露问题，不愿意承认自己还在学习；</li>
<li>但对评委来说，真正加分的往往是：你能否正视自己的短板，并且拿出<strong>清晰的自我迭代计划</strong>。</li>
</ul>
</li>
</ul>
<h2 id="结语：把自己当成一个长期项目"><a href="#结语：把自己当成一个长期项目" class="headerlink" title="结语：把自己当成一个长期项目"></a>结语：把自己当成一个长期项目</h2><p>纳瓦尔说：“致富不是靠运气，而是一套可以学习的技能。”在我看来，“学会经营自己、把自己产品化”正是这套技能在职场中的具体落地方式。</p>
<p>回到最开始的人才盘点现场：</p>
<ul>
<li>有的人，在 PPT 上堆满了“参与了哪些项目”；</li>
<li>有的人，则能清晰讲出三件事——自己在这几年里到底解决了什么关键问题、沉淀了什么可复制的资产、如何用这些资产去拥抱下一轮机会。</li>
</ul>
<p>评委的选择，往往就藏在这两种叙事的差异里。</p>
<p><strong>你可以从今天开始，给自己做三件小事：</strong></p>
<ol>
<li>写下你的“价值主张”一句话版本；</li>
<li>选出一段最能代表你优势的经历，把过程和方法写成一篇文章或一份分享提纲；</li>
<li>约一位同事或朋友，认真聊一次“你眼中的我哪里最有价值”。</li>
</ol>
<p>当你愿意以“产品经理”的视角来经营自己，愿意为自己的“版本迭代”负责时，你就已经从大多数被动等待评估的打工人中走了出来。接下来要做的，只是稳步迭代，而时间，会在不知不觉间，站到你这一边。</p>
]]></content>
      <categories>
        <category>thought</category>
      </categories>
      <tags>
        <tag>个人成长</tag>
        <tag>产品化</tag>
        <tag>自我管理</tag>
        <tag>认知升级</tag>
        <tag>复盘</tag>
      </tags>
  </entry>
  <entry>
    <title>到了一定年龄，低配生活，高配灵魂</title>
    <url>/2022/03/03/thought/dao-liao-yi-ding-nian-ling-di-pei-sheng-huo-gao-pei-ling-hun/</url>
    <content><![CDATA[<blockquote>
<p>本文摘录自新华社夜读文章: <a href="https://mp.weixin.qq.com/s/mij2iW2C0UTIhWtl4lzdCQ">到了一定年龄，低配生活，高配灵魂</a></p>
</blockquote>
<blockquote>
<h1 id="part-1"><a href="#part-1" class="headerlink" title="part 1"></a>part 1</h1></blockquote>
<p>有位作家说：<font color="#FF0000">“简朴的生活、高贵的灵魂，是人生的至高境界。”</font></p>
<p>年轻时，我们总以为人生就是要追求“高配置”的生活，追求豪华的车子、高档的房子、体面的工作……</p>
<p>渐渐地，聪明的人懂得：如果过于追求物质的“高配”，身体累，心更累；适当减减配置，人生才能活得自在从容。</p>
<p>看过一句话：“拥有就是被拥有。”意思是说，一旦我们拥有了某样东西，从那一刻起，我们也被这个东西所拥有。</p>
<p>比如，你拥有了一辆汽车，你同时被这辆汽车拥有，你常担心它被剐蹭、被偷，你要给它买保险、做保养。</p>
<p>比如，你拥有了一件奢侈品衣服，你同时也被这件衣服拥有，脏了要洗、皱了要烫、破了要修。</p>
<p>我们拥有的东西越多，需要担心和关注的外部事物就越多。</p>
<p>相反，如果我们在物质上追求简单，注意力就不会被太多的外物分散，就能集中精力去做自己喜欢的事。</p>
<p>很认可一句话：“简单的生活，不是苦行僧式的自虐，而是一种更为人性化的、经济的、环保的、轻松愉悦的生活。”</p>
<p>我们总是尝试拥有更多，却很少问问自己：拥有这么多之后，我就会幸福吗？</p>
<p>所谓物质低配，不是让你降低生活质量，而是在这个充满选择与欲望的世界里，学会辨别与舍弃。</p>
<p>低配物质生活，更能有力地掌控自己的人生。</p>
<blockquote>
<h1 id="part-2"><a href="#part-2" class="headerlink" title="part 2"></a>part 2</h1></blockquote>
<p>有一句话很经典：<font color="#FF0000">“当你的能力、地位、资源配不上你的社交野心，你所做的不过是无效社交。”</font></p>
<p>生活中，有些人逢人就添加好友，以为这就算拥有了人脉。</p>
<p>但当你有求于人时，发现自身不厉害，认识再多厉害的人也是徒劳。</p>
<p>人到了一定年龄，要懂得给自己的圈子做减法，减少能耗，把更多的时间留给自己，留给家人。</p>
<p>人的精力是有限的。时间在哪里，成就也就在哪里。</p>
<p>如果把所有的时间都用来去攀附所谓的“牛人圈子”，哪有时间去提升自己呢？</p>
<p>真正有质量的人生，都不是靠拼命社交建立起来的。</p>
<p>与其讨好攀附高配的圈子，不如过好自己的人生。</p>
<blockquote>
<h1 id="part-3"><a href="#part-3" class="headerlink" title="part 3"></a>part 3</h1></blockquote>
<p>有人曾说：<font color="#FF0000">“一个人对外在的物质要求越低，他对内在的要求越高。”</font></p>
<p>一个人只活在物质世界里，会一生劳碌、心灵空虚。</p>
<p>当我们不再追求物质的高配，而是保持宁静的心态，就容易做到灵魂的高配。</p>
<p>“非淡泊无以明志，非宁静无以致远。”</p>
<p>淡泊与宁静，是一种宠辱不惊的淡然与豁达，是一种成熟与从容，也是灵魂高配的一种境界。</p>
<p>到了一定年龄，请过“低配”生活。“低配”不是不思进取，而是张弛有度，不攀不比，不想太多。</p>
<p>衣服不一定要穿名牌，舒适就好；房子不一定要豪华，干净就好；车子不一定要高档，能代步就好；圈子不一定高端，有三五个知心朋友就好。</p>
<h1 id="一点点想法"><a href="#一点点想法" class="headerlink" title="一点点想法"></a>一点点想法</h1><p>新华社的夜读文章总是引人深思，“低配生活，高配灵魂”这种思想更是引起了我的共鸣，在这不久之前，自己喜欢买一些小物件以及一些流行的东西，喜欢把桌子摆的满满当当的。遇到一些喜欢的小物件，总是想买来摆在屋里。<br>最近读了《活出生命的意义》、《极简主义》这两本书，忽然内心生出一丝明悟，在人生有限的时间里，到底什么才是对自己来说比较重要的东西？在当代物欲横流的社会，存在着多少物质上的富人，精神上的穷人呢？<br>随着经历人生的种种事情，我对一个人的强大有了新的定义：一个真正强大的人，不是他身居高位、也不是他拥有多少财富，而是他面对任何事情的宠辱不惊的淡然与豁达。而这种淡然与豁达是经历了多少艰难险阻、刻骨铭心的经历了之后练就的，<br>人生是一场修炼，趁着年轻多去经历一些好的坏的事情，追求自己真正想要的幸福，努力成长为一个淡然与豁达的人。</p>
]]></content>
      <categories>
        <category>thought</category>
      </categories>
      <tags>
        <tag>低配生活</tag>
        <tag>高配灵魂</tag>
      </tags>
  </entry>
  <entry>
    <title>名言名句 &amp; 思考感悟</title>
    <url>/2024/04/06/thought/ming-yan-ming-ju-si-kao-gan-wu/</url>
    <content><![CDATA[<blockquote>
<p>最近几年读了一些书，经历了一些事，想清楚了一些事，这篇文章记录日常中能够引起共鸣的一些名言名句以及自我的一些思考、认知和感悟。</p>
</blockquote>
<h1 id="一、名言名句"><a href="#一、名言名句" class="headerlink" title="一、名言名句"></a>一、名言名句</h1><p>幸福不是拥有你想要的，而是想要你已经拥有的。</p>
<p>灵魂所需的必需品，一件也不需要用钱去买。把目光朝向内心，你就会看到，你心中有千个地区尚未被发现。到这些地方去旅行吧，成为内心宇宙志的专家。</p>
<p>高山仰止，景行行止，虽不能至，心向往之。</p>
<p>让时光在指尖转动。</p>
<p>视此虽近，邈若山河。</p>
<p>曾国藩座右铭：物来顺应，未来不迎，当时不杂，既过不恋。</p>
<p>世上只有一种英雄主义，就是在认清生活真相之后依然热爱生活。</p>
<p>回头看，轻舟已过万重山；<br>向前看，长路漫漫亦灿灿；<br>抬头看，万里明灯照人间；<br>低头看，脚下黄士千年绵；<br>人心看，满腔热血为国燃；</p>
<p>世人慌慌张张，不过是图碎银几两；偏偏这碎银几两，能解世间万般惆怅。</p>
<p>牢骚太盛防肠断，风物长宜放眼量。——毛泽东</p>
<p>真正美丽的东西从不刻意求关注，美一旦自知便容易滑向造作。</p>
<p>一个人所说的必须真实，但没有义务把所有的真实都说出来——康德</p>
<p>向阳而生，逐光而行；心有暖阳，满目芬芳，何惧人生沧桑。</p>
<p>父爱则母静，母静则子安，子安则家和，家和万事兴；<br>父恶则母苦，母苦则子惧，子惧则家衰，家衰败三代。</p>
<p>一辈子太长，只争朝夕。</p>
<h1 id="二、思考感悟"><a href="#二、思考感悟" class="headerlink" title="二、思考感悟"></a>二、思考感悟</h1><p>不要用行动上的勤奋掩盖思想上的懒惰。</p>
<p>不要以战术的勤奋来掩盖战略的懈怠——雷军</p>
<p>不要沉湎于解决问题，而要能够抓住战略性的机会。</p>
<p>那些只知念书，不肯生产的人，坐享别人的金蛋，自己永远不敢面对现实。</p>
<p>一个人的上限，并非由努力程度决定的，而是取决于学习方法和目标定位。</p>
<p>真正贫穷的家庭，往往不是金钱上的匮乏，而是认知上的贫瘠。</p>
<p>而且是环境改变人的思维，思维会进一步改变境遇，反过来再改变思维。</p>
<p>傅盛说，“人跟人之间最大的差别，就是认知上的不同。”人和人最终比拼的，是对一件事情的理解和对行业的洞察。</p>
<p>我不但充分利用自己的智慧，还竭尽所能去借用他人的智慧。</p>
<p>逆境是考验人的真实能力的机会，只有挺过逆境的人才能被称作是强者。</p>
<p>所谓能力问题，80%都是态度问题。</p>
<p>再好的东西，他也很快就习惯了，感受不到丝毫的刺激与愉悦。他渐渐明白，原来幸福并不来自外部的物质财富，而是一种内心的感受。</p>
<p>世界的本质是一个迷宫，一楼的人，不管怎么努力奔跑，都走不出迷宫。他们既不提升认知，也不寻求外力，还有太多的父母，一直活在地底下，住在地下室，从来没走出去过。</p>
<p>照片只是热爱的副产品。</p>
<p>done is better than perfect.</p>
<h1 id="三、碎碎念"><a href="#三、碎碎念" class="headerlink" title="三、碎碎念"></a>三、碎碎念</h1><h2 id="1-你是如何被打败的？"><a href="#1-你是如何被打败的？" class="headerlink" title="1.你是如何被打败的？"></a>1.你是如何被打败的？</h2><p>人生不可能100%正确，甚至连50%的正确都无法保证。但是人门却从心底里希望着能够100%正确的人生，于是乎我们小心翼翼的选择，害怕一点点的错误和失败，甚至很多时候我们不敢做出选择，直到时间所剩无多的时候发现自己错过了太多，心有不甘却有无可奈何。在选择时错过或者是过错时，我往往选择了错过。是啊！选择“错过”至少没有会受到伤害，但是选择“过错”或将是心如刀绞亦或是心如死灰。这么看来在“错过”与“过错”之间，选择“错过”无疑是不错的选择。但是当你选择错过后，同时也将改变和成长的机会拒之门外，成长总是被随着阵痛，人只有经历过挫折和苦难方能改变和成长。每个成功的故事背后，都有着无数的失败，没有人可以不经历失败就获得成功。因为不经努力而获得的成功毫无成就感，更谈不上什么成功。</p>
<h2 id="2-读书有什么用呢？"><a href="#2-读书有什么用呢？" class="headerlink" title="2.读书有什么用呢？"></a>2.读书有什么用呢？</h2><p>一个书友举了一个生动的例子。就像小时候吃的饭，我已经不记得曾吃过什么，但是那些吃进去的东西变成我的血与肉。读书也是一样，我已经无法明确记得到底读过哪些书，但是这些读过的书变成我今天思考、行动的准则。</p>
<h2 id="3-停止抱怨"><a href="#3-停止抱怨" class="headerlink" title="3.停止抱怨"></a>3.停止抱怨</h2><p>今天上班的时候，发现同事总是在说：烦死了。那一刻我忽然发现自己的心态有了新的变化，那就是我停止了抱怨，而是在麻烦到来的时候做我力所能及的事。</p>
<p>改变你能改变的，对于不能改变的我们认清其本质，是我们的能力不够，还是存在的客观事实无法改变，从中发现自己的薄弱点，形成一个观念并在日后的生活工作中使用刻意练习的习惯强化自己。</p>
<p>反思能促使我做出以上改变的应该是这样一句话：悲观者总是正确的，但是悲观者的观点并不会对局势做出有利的改变，而是杞人忧天；反而是乐观者总是尝试通过各种途径去解决问题，不断探索突破，但乐观不是盲目乐观而是要有所行动。我想我要做的是一个勇于探索突破的乐观者，这一点我从我母亲身上看到的，并深受其影响。</p>
<h2 id="4-为官之道"><a href="#4-为官之道" class="headerlink" title="4.为官之道"></a>4.为官之道</h2><p>官场之中，行事过于方刚者，表面上似乎是强者，实际上却是弱者。这片土地上真正的强者，是表面上看起来柔弱退让、含蓄包容之人。</p>
<h2 id="5-人生最美的风景"><a href="#5-人生最美的风景" class="headerlink" title="5.人生最美的风景"></a>5.人生最美的风景</h2><p>我们曾如此渴望命运的波澜，到最后才发现，人生最曼妙的风景，竟是内心的淡定与从容。我们曾如此期盼外界的认可，到最后才知道，世界是自己的，与他人毫无关系。</p>
<h1 id="四、思维理论"><a href="#四、思维理论" class="headerlink" title="四、思维理论"></a>四、思维理论</h1><p>锚定效应</p>
<p>折中效应</p>
<p>通人性</p>
]]></content>
      <categories>
        <category>thought</category>
      </categories>
      <tags>
        <tag>名言名句</tag>
        <tag>思考感悟</tag>
      </tags>
  </entry>
  <entry>
    <title>如何高效提问</title>
    <url>/2022/10/31/thought/ru-he-gao-xiao-ti-wen/</url>
    <content><![CDATA[<h1 id="如何高效提问——分享PPT"><a href="#如何高效提问——分享PPT" class="headerlink" title="如何高效提问——分享PPT"></a>如何高效提问——分享PPT</h1><span id="more"></span>
<div class="pdf-container" style="width: 100%; height: 600px; margin: 20px 0; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
    <iframe src="./如何高效提问.pdf" width="100%" height="100%" frameborder="0" style="border: none; border-radius: 8px;">
      <div style="padding: 20px; text-align: center; background-color: #f8f9fa; border-radius: 8px;">
        <p style="margin: 0; color: #666;">您的浏览器不支持显示PDF文件</p>
        <a href="./如何高效提问.pdf" target="_blank" style="color: #409eff; text-decoration: none; font-weight: 500;">📥 点击这里下载PDF文件</a>
      </div>
    </iframe>
  </div>]]></content>
      <categories>
        <category>thought</category>
      </categories>
      <tags>
        <tag>提问</tag>
        <tag>如何提问</tag>
        <tag>高效提问</tag>
      </tags>
  </entry>
  <entry>
    <title>张一鸣：牛逼的人找方法，傻逼的人找借口</title>
    <url>/2022/01/18/thought/zhang-yi-ming-niu-bi-de-ren-zhao-fang-fa-sha-bi-de-ren-zhao-jie-kou/</url>
    <content><![CDATA[<blockquote>
<h2 id="转载说明"><a href="#转载说明" class="headerlink" title="转载说明"></a>转载说明</h2><p>内容来源：本文为公众号仟语仟寻（ID：huoqian2014）首发，转载自笔记侠（ID：Notesman）<br>原文地址：<a href="https://mp.weixin.qq.com/s/HJLStYr-UO1Y02lEA6EOGQ">张一鸣：牛逼的人找方法，傻逼的人找借口</a></p>
</blockquote>
<p>伴随成长，我们会遇到很多问题，在不断思考，今天读到的这篇文章中许多观点引起了我的共鸣，更从中看到了一些值得去探索的方法。</p>
<blockquote>
<h2 id="商业思维"><a href="#商业思维" class="headerlink" title="商业思维"></a>商业思维</h2><p>编者按：<br>这几天抽空把张一鸣所有的微博看了一遍，2010年的微博是他30岁左右时候发的，那时候他刚创业没多久，在微博上认真分享自己的思考和观点。到了2012年附近，开始做今日头条。从他的微博中，我试图找到他成功的钥匙，仅仅是这些只言片语，我都觉得对我的启发很大。一个有趣的故事是，早年张一鸣曾把马化腾的所有微博读了一遍；而今天，张一鸣的微博也被人仔细研读，试图摸索出他成就背后的思维逻辑。<br>围观他的微博，结论就是张一鸣真的太厉害了，发现他说得最多的关键词：延迟满足感，自控，理性，反省，创新，学习。<br>本文是从他微博中摘录的231句话，绝大多数都是他创业初期的思考，我们可以看下10年前的想创业的张一鸣在想什么，在思考什么，是怎么鞭策自己的。有点长，希望大家耐心看完，一定会有所收获的。</p>
</blockquote>
<h1 id="一、关于成长"><a href="#一、关于成长" class="headerlink" title="一、关于成长"></a>一、关于成长</h1><p>1.人常会不自觉地记下对自己有利的部分，这是形成委屈的重要原因。</p>
<p>2.延迟满足感程度在不同量级的人是没法有效讨论问题的，因为他们愿意触探停留的深度不一样。</p>
<p>3.做不好的就别做了，要做就必须做到非常好。</p>
<p>4.当感到沟通困难的时候，最好的沟通方法不是想太多技巧和说法，而是：更坦诚的沟通</p>
<p>5.有感：人生的差距就是在自我感觉良好中拉开的。——与朋友共诫勉</p>
<p>6.经验：当无法选择或判断的时候，离远一步，远到用更重要的原则和更长的时间尺度来衡量就清楚了。</p>
<p>7.沟通中没听明白的话，常因为这些话用了“这个”，“那样”等代词，或笼统的名词，含糊的形容词、副词、量词替换掉往往“本身还模糊或有分歧的内容”。虽然句子是完整了，但是意思不清楚。然而如果替换的部分是清楚的，并不会听不明白。你要做的就是抓住这个词，还给他们。</p>
<p>8.练习保持耐心，即使是快节奏和压力的情况下。</p>
<p>9.今天听王兴演讲的的比喻：人生，和谁一起在路上，看什么风景。我最近也是在想，以后要让小孩多看看传记，包括电视剧《阿信》那样的也可以，看看别人的风景和旅程，更容易想清楚自己的选择。</p>
<p>10.应该让肾上腺素和理智一起发挥作用。</p>
<p>11.谋事不求易成，具备强烈的成功动机和韧性才能成功。</p>
<p>12.路径依赖的强弱可表征延迟满足感。</p>
<p>13.参考别人的意见，只是判断线索，不可作为决定的决心。</p>
<p>14.老子说祸兮福之所倚，福兮祸之所伏。幸运的时候不要忘形，失意的时候也不要绝望，相信事情总会有转机。那这句话是唯心的还是唯物的呢？当然是唯物的，告诉你忘形和失意都无助于事，做有意义的事情，关注事情的变化。</p>
<p>15.与智慧的常见敌人：未延迟的满足感，经验带来的麻痹或恐惧。</p>
<p>16.很多时候不是不理解，甚至不是认识不到，只是不愿意深刻认识到。这往往还是隐隐的主观在作怪。</p>
<p>17.最贵的是“学费”。</p>
<p>18.三年前和朋友聊天，问他对合作者对人才看重什么，其它点我已经记不住了，唯记住：不装B。当时楞了一下，随后越发觉得有道理。经常要提醒自己，这也是延迟满足感的一种锻炼。</p>
<p>19.不停地想应该如何让未来更精彩。</p>
<p>20.年轻人不要试图追求安全感，特别是年轻的时候，周遭环境从来都不会有绝对的安全感，如果你觉得安全了，很有可能开始暗藏危机。真正的安全感，来自你对自己的信心，是你每个阶段性目标的实现，而真正的归属感，在于你的内心深处，对自己命运的把控，因为你最大的对手永远是自己。</p>
<p>21.如果给过去5年的自己一个建议，就是激进再激进一点。</p>
<p>22.快50岁，思路清晰深入，细节敏感，执行又高举高打，很好地控制自己情绪。晚上参加活动看到别人的优点。</p>
<p>23.短期交往说话忽悠会有溢价，长期交往说话实在会有溢价。</p>
<p>24.用心认真的折腾是没有风险的。</p>
<p>25.看缺点有难度，权衡缺点看优点更难；避免犯错有难度，接受犯错以成功更难。</p>
<p>26.选择比努力更重要，观念比选择更重要。</p>
<p>27.遇到一本好书，很愉快，和遇到一个非常值得交往的朋友是相似的。</p>
<p>28.在北京6年住了6个地方：回龙观，双榆树，知春里，和平里，惠新西街，西土城。你住过哪儿？</p>
<p>29.多修炼，期早达：耳顺、知天命、从心所欲不逾矩。想起一个朋友的msn（国外的通讯软件）签名：三十耳顺，当时没注意，现在想到已经了不起了，提前了一半。</p>
<p>30.在不来劲的时候来劲，在太来劲的时候淡定。</p>
<p>31.谦虚的人能看到自己的不足，自信的人能在知道不足的情况下依然积极。</p>
<p>32.你最终会成为你想要的样子——如果你真的非常想。虽然听起来有点唯心，但是强大的愿望确实非常重要。</p>
<p>33.稻盛要辞职离开快倒闭的公司，遭兄长棒喝：“在这样没人干活的公司你都做不出点成绩来，你还能干什么？洛克菲勒感觉再也无法忍受日复一日枯燥的工作，提出换岗，遭主管冷言“要么好好干、要么另谋出路”。同样的道理，不同的说法，却像雷一样击中并成就了两个商业巨匠。还是那句，不抱怨、想方法。</p>
<p>34.关于消费：买书、健身、学习都属于资金成本边际成本很低，对于很多人，只要你能真正完成这些消费，资金都不是主要成本而值得大力投入的消费。综上，我非常建议大家买书、买电子书、ipad、智能手机、买健身卡、游泳卡…还有类似的消费吗？</p>
<p>35.“独立思考忠实于自己的内心”“越朴素不虚荣，所做出的选择会越实际而可行”。</p>
<p>36.听说有人每天能看一本书，问题还不在看书速度，而是在知易行难，实践的速度赶不上所知的要求，欠账很多。</p>
<p>37.卓有成效如果有什么秘诀的话，那就是善于集中精力。—《卓有成效的管理》</p>
<p>38.研究聪明人如何犯错误，回报率很高。聪明人易犯错误包括：第一，嫉妒他人成功；第二，自命不凡；第三，过于相信自己判断；第四，停止学习；第五，认为世界是静止的，生活在过去荣耀中；第六，任何事情都有自己一套言之有据、且深信不疑的说法和理论：忘记了没有调查研究，就没有发言权。你符合吗？</p>
<p>39.坚持原则很多时候是经济的，可以看做是一种短期浮亏的长期受益的投资。</p>
<p>40.知行合一真难，中间差的是什么？</p>
<p>41.既会庆幸做了什么，也会庆幸没做什么。</p>
<p>42.加强专注力训练，它是优先级管理的保证，同时持续专注力的一个基础是体力和精力，锻炼修炼。</p>
<p>43.晚上看书，看书—带着悔恨的心情和克制悔恨的努力。</p>
<p>44.发现保持体力充沛精力旺盛是一项基础工作～</p>
<p>45.昨天和朋友聊天，总结到：在这个信息流动越来越快越来越透明的社会，从经济的角度来看，做一个表里不一的人成本越来越高，龌龊的人会越来越倒霉，不装不但是一个道德品性优选，而且也是更经济的。很多人还未意识到这点。</p>
<p>46.某项较长时间不如人意的工作，终于有了起色，耐心很重要。凡事都有原因，只要认真找原因并努力改进，就会有效果。</p>
<p>47.今天会谈提到感性理性，我的观点：感性深化放在深处，理性实化放在前锋。</p>
<p>48.上午北京大学周其仁教授发言非常精彩。他认为一个持久得到别人信任的人，收入就越高。有比知识、技能更加重要的东西，那就是信任。他们的团队在研究了农民工的收入以后发现，收入最高的人，往往并不是体力最好、技能最好的时候，而是最受信任的人。所以，成为一个受人信任的人，非常重要。</p>
<p>49.改变你目前能改变的，专注到circle of influence（影响圈）：现在最重要的是放松，睡觉去。</p>
<p>50.最近感想：口碑很重要，人品很重要，信用很重要，越老越重要，原则要坚定。</p>
<p>51.上帝不可能骗得了我，因为所有的欺骗都有漏洞。——笛卡尔</p>
<p>52.将事情做满，还是将事情做好，其实是很不一样的。我们容易看到将事情做满，但是容易忽略把事情做好。</p>
<p>53.指标系统：为什么刷牙不能坚持认真刷，为什么在跑步机上能坚持跑步。有许多事情不容易做好和不被重视的原因就是因为没有指标系统。比如，如果健康有准确方便度量的指标，那么大家的身体素质一定会提高。但是指标不见得好提炼，提炼指标的过程，本身是分解事物特征的过程。而且指标要常测量。比如说：当我今天发现眼睛度数上升100度的时候，才发现眼睛过疲劳了，用眼不注意了，在手机上看书是非常不恰当的行为。关键是今天才知道哇…</p>
<p>54.大多数人，确实一开始就想绕过困难。好的问题就是一半的答案，剩下一半答案就是奋斗。</p>
<p>55.你们读了哪些传记？想起2年前朋友说：如果不知道让小孩阅读什么，最适合的就是传记。最近在思考与回忆：关于品格、理想、动机的形成，觉得确实如此。</p>
<p>56.我去年自己有一个感想：觉得之前的老板都对我不太苛刻啊。否则我当时能做的更好。当然很可能是他们认为，已经做的好，太苛刻人就跑了，其实对于会自我驱动的人是不会的。</p>
<p>57.关于感性，或忧或悲，但你看到人生不容易十之八九，当你看到生活的真实面目时：你会悲，但就不会因表象而伤感；你会喜，也不会而浮华而极乐。生活中有时候猛然听到残酷而又真实有穿透力的话，看到本有违世界观而又有理的书，直到你自己会下意识的去看生活本来面目，你的感性就变化了。</p>
<p>58.玩德州扑克看人性的弱点：第一，贪玩（一开始拿烂牌但是不fold，fold:认输）；第二，侥幸（希望等低概率事件）；第三，不能舍（因过去付出而不放弃）；第四，过度概括（只看一个例子就下结论）。其实，德州扑克和人生一样：应该：第一，理解不确定性；第二，专注有可能的事情；第三，理智评估概率；第四，能舍才能得；第五，避免意气用事。</p>
<p>59.在知乎上看到很多IT行业聪明爱思考的人的思考，密度很高。感觉是氛围尚不是模式带来的，喜欢和聪明思考的人共处。</p>
<p>60.终于把《如何阅读一本书》阅读完了。美国人就是认真，把阅读的问题方法刨根究底。这不是一本资讯娱乐类的书，是需要和增进理解的书。</p>
<p>61.一件事情上，在心里想对方自私的时候，想一想自己：多数发现自己也蛮自私的。在骂对方贪婪的时候，想一想自己：多数发现自己也同样贪婪。</p>
<p>62.做个理性人，很多事情就不必做。感性做人，理性做事的态度有其意义。</p>
<p>63.今天手机报上有一段话:“独处是一次心灵按摩”静坐在斗室里，漫步在小道上，平躺在沙滩上…有意识的面对自己，和内心对话。喜欢独处的人，和别人在一起时，往往也会处理的更好。交流和独处相辅相成，才能让内心成熟和强大。</p>
<p>64.凡事就怕不认真，不思考。好多问题我应该能知道的，只是之前没有认真看，认真想，想当然（不是没时间）。延迟满足感是一项长期修炼。</p>
<p>65.台风来的时候，猪都会飞起来。所以，真的飞起来时一定要清楚的知道是因为自已能飞，还是外力使然。靠台风飞起来的猪迟早是会掉下来的。</p>
<p>66.有人问比尔·盖茨：什么是你最大的恐惧？盖茨回答：我最恐惧的是那些正在破车库里没日没夜捣鼓新名堂的年轻人。</p>
<p>67.写完文档准备睡觉，想起今天看的《facebook 效应》，突然想起《普通生物学》介绍的一个物质：多巴胺。最近愈发想起人与人之间的状态区别，是否有激情，是否自我激励，是否是由这类物质的代谢水平决定了基本面。肖恩·帕克是多巴胺水平很高的典型？</p>
<p>68.想做的事情太多，经常要抑制自己的激动。</p>
<p>69.沟通，听一个人说话：你是否知道他在说什么，你是否知道他知道他在说什么，你是否知道他们知道他在说什么。</p>
<p>70.今天晚上的时候，每个周五晚上下班的时候，我常会和同事说：我明天假期我们再把xxx做好。每次突然想这句话矛盾啊，不能这样要求。嗯，生活工作要平衡。不过，别人腐败的时候我们在努力，别人消磨时光的时候我们在学习，那么延迟的满足一定会厚积薄发来到。</p>
<p>71.延迟满足感经验：涵蓄情绪，让自己静止，不要在沟通交流的时候走动、晃动，情绪跳动，思维失去精确控制。</p>
<p>72.寻找错误或者问题可以从发现自我矛盾点做起，如果能理性地使用逻辑。</p>
<p>73.注意力也可以开源节流的，欲望和杂念分散注意力要节流，锻炼身体和注意力训练是开源。</p>
<p>74.人不逼一下自己，永远不知道自己潜力有多大。很多事情非不能也，是不为也。</p>
<p>75.我最近经常问自己：马上有什么可行动，你是行动派吗？很多问题它不会消失，不动(犹豫&#x2F;抱怨&#x2F;感叹)肯定是错误，行动就有力量，哪怕是行动的准备行动，唯有行动才能改变事情。</p>
<p>76.《如何阅读一本书》一书在谈技能之外，更多的是讲学习的态度和沟通的方法。比如赞同和反对一章，其实标题亦可写为，关于沟通的赞同和反对。</p>
<p>77.好的问题就是一半的的答案。</p>
<p>78.乔布斯说stay hungry，我以为饥渴有三个层次：贪婪、成就动机、好奇心 。三者分别关注：瞬间的结果，持续的过程，和远大的未知。三者也恰好对应了三种人：卑劣的投机者，艰辛的攀登者，与幸福的探索者。</p>
<p>79.有不少留言说不理解这段话。研究快乐的专家告诉我们，快乐有三种：pleasure（欢乐）,passion（热情）,higherpurpose（理想、有意义）。其中欢乐是最短暂的，热情其次，而最长久的是理想。</p>
<p>80.想学的东西很多，吾生有涯知无涯，以有涯追无涯，怠也。有两种理解，积极的理解是应该有优先级的规划学习。</p>
<p>81.做减法最不容易也最容易。</p>
<p>82.现在年轻人部分流行把三四十岁退休作为理想，我不认同，我觉得理想是一直有机会创造、实现想法，有机会学习，修炼，创造到老。为什么会想退休？想退休说明你认为现在是在“忍”。我还有很多很多想法想做，希望三四十岁更多条件去实现想法。</p>
<p>83.人群总有一些人xx素比普通人高(很好)有精神有斗志，爱学习，爱创造，爱折腾。下午和一个在某顶级互联网公司的老朋友聊天，他又要出来创业了。</p>
<p>84.发现最近，不论是一起公司的同事，或是投资人，还是老同学都不约而同提到一点：过去一年，我变化很大。我相信他们是能感觉到或者观察到，但是变化的心路只有自己才知道，所以自己觉得很自然。</p>
<p>85.保证足够睡眠是积极高效的第一步。</p>
<p>86.自我实现，自我修炼是最高层次。</p>
<p>87.生活中不是缺少美，而是缺少分享。</p>
<p>88.很多很好的想法自己都非常认真，现在都被人实现或者通往实现的路上了。真希望自己能分身体几个同时努力，这样人生多精确。但是分身是不可能的，所以只能①根据情况排优先级；②找到志同道合的人。</p>
<p>89.今天M.A.D会议，听到一个关于SEO人物介绍，提到某人非常洒脱。我对人物介绍倒没有感觉到特别。但是对洒脱这个词，突然有点感想。效率和竞争往往把人变得很精确、严谨、注重细节、强调计划和控制，这些都没错，但是大家要注意保留一份洒脱，性格和人生观别职业被带入另一个胡同。</p>
<p>90.最近IPO（首次公开募股）的公司一堆一堆的，但是大家一定要耐得住寂寞，他们今天的成功是他们的过去已经决定的，属于他们。我们的成功是我们的现在和将来决定的。我发现很多事情经常是这样的：今天和明天已经由昨天决定，你还可以决定后天。</p>
<p>91.应届生应该推崇自信，诚实，努力，相信成功可通过学习和努力获得。别太讨巧，走捷径。事实上面试大多不是因为技能不行，而是人品和性格不行。</p>
<p>92.一连串有想象力且恰当的比喻连续使用是讲道理的好方法。</p>
<p>93.通货膨胀正在洗劫你的钱包，同学问怎么办？三个办法，一是尽可能地提高家庭负债率，当今之世能借到钱的就是英雄；二是配置资源性财产，能够抵抗通涨的只有三个东西，黄金房产和农产品；三是象傻瓜一样的长期持有，眼前的涨跌都是对耐心的考验。除非天下大乱，否则以上三条应是规律。</p>
<p>94.我今天的处境都是因为我有些应该做的事情我没有做，不应该做的事情我就全做，所以要改变现状，就要从自己开始。</p>
<p>95.有百分之多少的把握你会开始创业，有多深的感觉你会对另外一个人说我爱你，有多么的确信会让你有精神上的信仰。你不必等一切都100%确定了才开始创业，去爱一个人和建立信仰。其实我们的确信度永远达不到100%，那么你会一直等吗？今天，你如果不做一个肯定的决定可能会失去得更多。</p>
<p>96.一个困扰我们很长的时间技术诡异问题，同事们这两天集中时间集中精力分析、求助、排查、尝试终于解决。想起稻盛和夫的说的：用尽全力，异常认真，神明就会来相助。其实神明未必相助，但是你会更接近问题的本质，从而解决问题。</p>
<p>97.系统地运动锻炼需要抗身体的惰性，锻炼久了之后，不但身体好，而且锻炼的积极性也好，容易启动，养成习惯，最近觉得读书学习也很类似。</p>
<p>98.看完《如何阅读一本书》这一章：如何做一个自我要求的读者。也即阅读应该是有自我要求的具主动状态的。阅读两字换成其它很多词也适用。</p>
<p>99.执行力到底是什么？我认为的执行力是：说到做到，不找借口，完成别人都能完成的事。而更强的人可以做到：完成别人完不成的事。同样的一件事，交给不同的员工，会有不同的结果，完不成的人都会有各种理由来说服自己说服领导，将一个小困难由点到面扩大化看待。做一个NB的人，从此刻开始，不再找借口。</p>
<p>100.向成功找方法和为失败找理由，也是人的一个方面的两种习惯和素质。</p>
<p>101.今天和同事讨论效率，说到表达模糊影响效率和沟通的问题。很有同感，我一直就觉得类似以下含糊说法在工作中应避免：“应该差不多吧，过两三天大概就可以了，估计再要一点时间就接近好了，这个东西也还行吧，最好能 xxxx吧，差不多也都行，我过一段弄一下，这样也还是可以的”。</p>
<p>102.最近三个月身体锻炼的进展：腰背少严重疼了，一次跑五公里，一次游一公里都很轻松了。近期目标，自由泳学习中，健身学习中，羽毛球提高。</p>
<p>103.一个人在他的信仰上站得越不牢固，他就越要用双臂紧紧抱住那些使之区分于其他信仰的教条不放；相反，一个人在他的信念上站得越牢固，他就越可以自由地把双手伸向那些与他信仰不同的人。——弗兰克。早安，各位。</p>
<p>104.说到自我修炼，由于懒惰(体力的、思考的、情绪的)是万恶之源，所以修炼很多时候就是在克服惰性。</p>
<p>105.不断给自己小的承诺并努力达到。Be Proactive （变得积极）的修炼方法之一。</p>
<p>106.喜欢最近地铁里的一句广告词：we trust learning（我们要相信学习）。</p>
<p>107.平庸有重力，需要逃逸速度。</p>
<p>108.不怕犯错误，不怕坏方法，甚至不怕坏习惯。只要你会会自我改正。你习惯改正吗？</p>
<p>109.单身的人是有一些好处的，比如更多自由独立思考的环境和时间，孤独往往使人更加深邃和广阔，非单身的人想想如何避免非单身的缺点。</p>
<p>110.快到30岁了，感觉这几年又再重新学习&#x2F;补习本应在青少年时间学习的东西：如何阅读、如何了解自己、如何与人沟通、如何安排时间、如何正确的看待别人意见、如何激励自己、如何写作、如何坚持锻炼身体、如何耐心。</p>
<p>111.今天见了一个5年未见的同学和半年未见的同学。期间有位同学说工作生活最近很没意思。其实5年变化已经很大，不过我觉得还不够大，生活的意思完全可以自己找，自己改变人生意思就很大。不要等意思来找你。借用奥巴马的话说 change，yes we can.</p>
<p>112.未雨绸缪其实很难的，大多数情况都是事情推人走，而且往往能容易被推动的人已经不错了。</p>
<p>113.互联网让会学习爱学习的人和相反的差距拉的更大，这并不仅限于互联网行业。只不过互联网行业这种趋势先开始而已。现在好多初中生、高中生比大学生、博士生还博学。我见过2个中学生，自己用wiki整理所学过的、自学的各种知识。我怎么生的这么早…</p>
<p>114.延迟满足感和坚决告别惰性，是“优秀”的最重要两块基石。</p>
<p>115.当某人开始深入认识自己、研究自己的时候，说明此人开始有了哲学的思考，预示着此人开始迈入一个新的人生阶段。</p>
<p>116.非常同意自控力（也就是反惰性）是优秀的标准。确实马拉松不是高标准，思维意识情绪的自控更难。</p>
<p>117.牛逼的人找方法，傻逼的人找借口。</p>
<p>118.昨天公司内部做时间管理的交流，是我推动大家的。不过说实话惭愧，最近2-3周我自己的时间管理的目标下降了。惰性是万恶之源。从今天开始又有意识地加强了。</p>
<p>119.只有当你离开自己的舒适区时，你才会挑战自己的极限。</p>
<p>120.“积极主动”是广泛优秀的素质的基础。</p>
<p>121.看年轻人的潜力，看他周末几点起，周末在干嘛，下班在干嘛。甚至不一定要干嘛，只要看想些什么。</p>
<p>122.高中刚开始学物理的时候，老师反复强调不要想当然、凭感觉，应该要推理。其实线性思维是常见的一种想当然，也许许多事物的常态是类线性的，但是常态或者普通事物往往不是关键，需要面对的情况往往是非常态，所以要注意避免线性地”想当然。</p>
<p>123.低落的状态时情况往往没有感受的难，松懈的时候其实不如想象的容易，人往往难理性。</p>
<p>124.避免的常用含糊词：“难免会”，“差不多都这样”。</p>
<p>125.对很多事情我挺有自己观点和想法，目前不能解决问题，没有效果，所以不应该去展开和评论，要想想现在能有效果和价值的事情。我甚至时常要提醒自己：你这样想是没有错的也是没有用的，赶紧做许多又很有用又没有错的事情。</p>
<p>126.最近感觉忙碌多，思考学习反省又少了，观察问题也不够深入和耐心，在 speed up（加速）和激动干劲足的时候，保持一份 slow down（慢下来）的心态很重要。</p>
<p>127.对现实隐忍，对未来有期待，在当下有作为。</p>
<p>128.内向但精力充沛有企图心的人。性格内向的人更易成功：美国MSNBC网站报道称，一项研究发现，内向害羞大多与生俱来，而且，内向的人在工作中更容易成功。在做决策时，他们愿意花大量时间思考，不喜欢闲扯其他的话题，更能专心致志地奔着一个目标努力，因此他们成功的几率也相应增大。</p>
<p>129.很多复杂问题是更高维度简单问题的投影，比如说打篮球动作变形、速度慢、配合差是很多时候体力不行；写程序烂、bug多、时间长是抽象分解问题做的不好；还有比如海军说的“很多管理问题都是假象，本质是能力问题”。而解决这些本质问题，需要更大代价和决心的。</p>
<p>130.今天早点睡，明天早上起来看书。本周的学习计划快完不成了。创业过程中不断的学习又能尝试是感觉很好的体验。</p>
<p>131.人欲望太强的时候就容易短视，太自我中心的时候就容易盲目。</p>
<p>132.以前一直都没觉得找人自信很重要，现在发现越来越重要。惰性、依赖、拖拉、保守很多也都是不自信导致的。自信的人，自然会和自我高要求联系起来。</p>
<p>133.常说机会总是青睐有准备的人，其实更多时候是机会已经来了只是还没凸显，往往自己没珍惜。</p>
<p>134.不抬杠，要抓住主要问题，任何办法都是在一定时空下对真理的近似实现，时空条件越具体，办法法就越有效。如果去抬杠“近似”，那么就更难在这个时空条件下实施。</p>
<p>135.很多事情都是这样既没有你设想的容易，也没有你想象的难。睡觉～～</p>
<p>136.所谓门槛，过去了是门，过不去则是槛。人生的悲哀往往是，你想两肋插刀，刀却只有一把。怀旧，不是那个时代有多好，而是那时你年轻。觉得不快乐，是因为我们追求的不是“幸福”，而是“比别人幸福”。两人的感情就像织毛衣，建立时一针一线，拆除时只需轻轻一拉。</p>
<p>137.成熟感悟：成熟就是从inside-out（由内向外）更多的变成outside-in（由外向内），就是在需要时常能变成忍者神龟，在另一些时候又能变成动感超人。</p>
<p>138.昨天父亲节，和爸妈视频聊天，他们在广东经商，这几年竞争压力内部意见纠纷不小，有时想建议他们别经营了，退休养老，但办公司往往欲退不能。昨天爸爸说还想投入更多一搏，我想既然劝退不行不如鼓励他放手一搏，信任就是鼓励。我不能回去帮忙就要把自己的事情做好，让他不要有担心。</p>
<p>139.关于勤奋，就我所知，罕有成功者不是工作时间极长的：通用电气的CEO 每周工作一百小时，坚持了至少十年。巴菲特为了最早看到次日的华尔街日报，经常在凌晨四点去取报纸。勤奋不是一种形式，而是一种心理状态：享受挑战极限的过程，保持热情和好奇心，坚持不屑。</p>
<p>140.哈佛有一个著名的理论：人的差别在于业余时间，而一个人的命运决定于晚上8点到10点之间。每晚抽出2个小时的时间用来阅读、进修、思考或参加有意的演讲、讨论，你会发现，你的人生正在发生改变，坚持数年之后，成功会向你招手。</p>
<p>141.今天公司进行读书交流会，其中提到《别做正常的傻瓜》一书，大家对是否理性的态度有分歧。</p>
<p>142.人生吧，0岁出场，10岁快乐成长；20为情彷徨；30基本定向；40拼命打闯；50回头望望；60告老还乡；70搓搓麻将；80晒晒太阳；90躺在床上；100 挂在墙上。</p>
<p>143.人生的本质是追寻自我的提升。包括思想、能力、意志等等。这些发展好了，一切随之而来。偏偏大多数人追求的是短期的公司、职位、薪水，运气好的能有所发展，运气差的会迷失方向流于平庸。</p>
<p>144.周末参加一个朋友婚礼，发现新郎最近去了中央某监管结构的信息处，博士新娘回到新郎故乡担干部。他们已经两地分居5年了，为了珍惜机会还要继续分开。这样我是做不到的，也不赞同，人生在世就应该尽可能实现价值体验生活，为了静态的收益而去“忍”损失生活，损失很大，不是创造的人生。</p>
<p>145.不满足之后有几种反应。第一，努力提高自己；第二，尝试安慰自己；第三，抱怨牢骚记在其它人事身上。</p>
<p>146.强烈的动机比方法更根本。</p>
<p>147.不爱表达观点的人，总是容易被人认为没想法不聪明，而部分强势之人更爱发表意见，所以看其他人大多不如自己聪明，其以总爱发表关于他人是否聪明的意见之人为甚。</p>
<p>148.聪明又耐心是有一些矛盾的优点，同时具备两点的人却非常优秀。</p>
<p>149.一点不要含糊，含糊代表着侥幸、代表着自我欺骗、代表着自我感觉飘然。</p>
<p>150.一次别以看一本为目标，比如看5页为目标，关于自己无法耐心看书的问题：如果说哪里来了一个高人每次都会听得很仔细，听完以后觉得很有收获；而看书则是完全不同的心情了。电脑里的经典书籍堆翻天了，却从来没有仔细翻过，真是书非借不能读啊。真是应该给自己一个规划，用看待约会和讲座的心情来看待每一次阅读。</p>
<p>151.不知道其它人看《活法》一书是怎么样一个真实感受，我有时觉得书中的要求太高以致不想去想。</p>
<p>152.“很奇怪”“很诡异”“太奇怪”，有这些想法说明自己还不懂，而且常常还想把原因归咎于“奇怪”以release（免责）。没有什么太奇怪的东西，仔细去找学习的途径，你常常能找到。</p>
<p>153.最近重读到稻盛和夫的《活法》，其中提到专注投入，其中举的陶瓷工艺改进的例子尤其另我印象深刻。我们做每一件事（写一段程序，写一封邮件，写一个策划）的时候是否在想自己是否投入全力以赴的认真做了，结果真的不一样？请试试：你能有多专注？</p>
<p>154.我给自己贴了创业、技术、管理、创新、自省标签。</p>
<p>155.执行力这个词一度很流行，在我理解来看就是态度和能力。不断筛选和提高大家的态度、能力就是提高执行力。</p>
<p>156.习惯：把要做的事情迅速分配在calendar（日历）上，会变化没关系，多调整。</p>
<p>157.你是在松懈状态还是在挑战状态？（这是第一条微博）</p>
<h1 id="二、关于管理"><a href="#二、关于管理" class="headerlink" title="二、关于管理"></a>二、关于管理</h1><p>1.三顾茅庐已经不适用了，必须得四顾。</p>
<p>2.我自己的方法：忘掉资历，集中精力用能力和潜力来评估。资历是个锚点，但未必准确。</p>
<p>3.有个同事提到多招女生来活跃气氛，我晕，果然小年轻的想法，这是分心不是活跃，难道学支付宝美腿招聘么。周末想了想，应该是其实能看到产品在进步、用户体验在提高，自己在修炼进步，交流沟通中有智慧有火花，个人回报满意有提高，就是high的关键。</p>
<p>4.别装，做个坦诚真实的人。团队中都是坦诚真实的人，沟通成本将小很多。</p>
<p>5.能否坦诚沟通是公司团队管理的主要问题。</p>
<p>6.对于创业者来说，找合适的人常常是个不作为的借口，事实是合适的人是永远不存在的，要让自己变成最合适的人。创业者永远要作为半个HR存在。</p>
<p>7.据多家公司统计，团队淘汰个人的顺序往往如下：第一批，明显缺陷者、众人厌恶的说谎者；第二批，不愿交流者、不合群者；第三批，有能力但慵懒者、妄图坐享其成者；第四批，居功自傲者，蔑视同僚者。</p>
<p>8.他解答团队中部分人不能跟上公司发展的处理要点，三点原则：第一，以德为主，德有大问题则需离开，话说清楚不含糊、好好说，先鼓励给机会、不要让团队意外、猜测担心。第三，德具备、才落后或者不匹配的情况，要给降下的人降落伞，降落伞要有含金量，要替人考虑好。</p>
<p>9.当你给一个人足够的信任和压力的时候，他总能比原来做的更好。</p>
<p>10.开会的时候总有些大忙人在那里闷头回邮件玩短信，认为讨论的那些别人的事和自己无关，这是极端错误的。让你参会说明领导认为会议的内容你需要知道并希望听到你的意见，如果发现你不会倾听又对会议无所贡献，慢慢你就不会再被要求参会，久而久之在组织中也就被边缘化了。</p>
<p>11.公平的文化和公平的信任是非常重要的，奖罚分明，这样大家才相信游戏规则存在，才会挑战自己更大回报，才不会有侥幸心理。类似这样的原则CEO要谨记不忘。</p>
<p>12.对组织而言需要把优秀的标准清晰无误的传递且不断精进。含糊和混淆其实是牺牲。</p>
<p>13.加入我们并不代表眼下的这一份工作。万一我说万一，这一票不成功，加入了我们，你会发现，世界上还有很多事值得我们去做。只是看你有没有足够的视野和激情。</p>
<p>14.对于一名CEO而言，最艰难的事可能就是抵制住想自己解决问题的欲望。你曾身经百战，你也许是最有经验，最有资格去解决问题的人。但是这样一来却无法建立一个优秀的管理团队。将机会留给别人期待他们能解决问题十分艰难，但也十分值得。这样一来，整个团队的能力都可以有所提升。</p>
<p>15.经常看到职位蛮漂亮的人，但细看发现他每次升职都是换工作的时候发生的。这会让我警惕，因为好的人，老板会加薪升职来挽留。如果一个人在同一公司多次升职，让我会放心很多，因为比我了解他多得多的人看好他给他更多的责任，而且他一次次胜任。换工作才升职，有可能是外强中干，忽悠了新老板。</p>
<p>16.亚马逊卖书起家，现在他不卖书也很赚钱，360做搜索起家，现在不搜索也很强大，而一些公司，比如迅雷从p2sp、客户端起家却没在这个领域持续拓展创新。这就是是团队的差异。</p>
<p>17.一个身价两百多亿的老板不作秀、不爬山、不吹牛、不打口水仗、不接受采访、不上电视杂志，以身作则像一个基层员工一样每天脚踏实地测试产品， 无止境地改进产品的体验。这才是腾讯成功的最大原因。而被腾讯打败的 Loser们始终没有认识到这一点，要么骂它靠抄袭，要么说它靠QQ才能成功。</p>
<p>18.创业企业在中国越来越普及，优秀的人才也会在之间杜比。况且好的机制也是重要竞争力，我建议所有创业者都以好的心态和机制和团队分享创业过程和结果而不要“忽悠”，这样创业公司才会更容易吸引人才。</p>
<p>19.今天完成期权发放准备，下周给第一批加入的优秀成员发放。开始制定发放计划时，我和其它董事有一些分歧：我强调希望以极低的行权价发放期权，其它董事则强调会计评估问题。最终采用我的方案，因为我非常了解创业团队成员的心态。一个早期公司成员的心态和状态是最根本的，其它问题只是“技术问题”。</p>
<p>20.选择越高级影响越大的人才越要看一些基本素质：理性、逻辑、修养、企图心、自我控制力。</p>
<p>21.其实我挺想知道团队成员周末都在干嘛。。。总希望大家把时间充分有效利用了。。当然我说的不是只工作，是指优先利用学习、休息、娱乐、锻炼、交流，思考上。并且可以一起活动。</p>
<p>22.职场总结：工作基本上是一个积累信誉的过程。自己今天的工作一直在为自己的明天积累信誉。工作中总是掉链子、需要人提醒就是不断的丢掉自己的信誉。We are what we repeatedly do，not we repeatedly think or want or say（我们是我们反复做的，而不是我们反复想或想或说的）。</p>
<p>23.没有免费的午餐。创业公司要出人头地就要求非常优秀高的自我要求。告别“差不多”、“还行”、“先这样吧”、告别工作掉链子、拖拉、80分。很多创业公司还不如大公司努力要求高就沉浸“创业”的状态，或者是只沉浸在工作时间长的伪“创业”状态。</p>
<p>24.姜子牙81岁才当上三军总司令，人家前80年就做两件事：好好学习和锻炼身体。</p>
<p>25.一个公司最强的敌人是什么？韦尔奇说，是“坦率”。深表认同。幸好，坦率是可以培育的。</p>
<p>26.我觉得以后团队的工作，不论大小，应把工作的目标定义并分解后，邮件发出来。第一，这样可以别人提意见；第二，可以避免重复的工作；第三，避免定义清楚理解有误差；第四，同时能估计工作量、评估效率方法。清楚不含糊要成为公司的文化。</p>
<p>27.【职场】昨晚请多玩优秀员工吃饭，聊了几点职场体会。第一，把自己当老板看， 象老板一样拼命干活，能力自然就提高了。有了能力，假如多玩不能给你好的回 报，其他公司一定会给。第二，不是每次付出就一定有回报，但是不断付出就一定会有回报。李学凌补充了一点：像你的老板一样思考，能力会提高得更快。</p>
<p>28.有人问我如何突破自己的职业瓶颈，我说：你的瓶颈就在于你的心。你的心更宽，心态更好，遇到问题将自己拨高一层去看问题，把你心里的那些小纠结小疑惑小算盘小私心，统统打破，你就没有瓶颈。</p>
<p>29.最近大家 review 了九九房半年的进展并讨论每个人的总结和设想，对我们的信心更加增强。和同事曾讨论：创业要经常自省，避免自我强化和催眠。所以要区别信心和“YY”，真正信心源于看到自己的进步和潜力，可以分成两个方面：第一，对事情本身判断的信心；第二，对自己和团队的信心。</p>
<p>30.周六凌晨一点，收到一位创业者短信：大家讨论的结论，极致就是把自己逼疯、把别人逼死！那时，他们正在为自己的梦想通宵达旦的打拼。我理解的极致就是做出超越自己能力的东西，只有极致的东西才能超越用户的想象，才会有良好的口碑。</p>
<p>31.能在细微关键之处自我要求和互相challenge（挑战）是好团队的特质之一。比如平时时间分配、工作状态、思维训练、沟通表达、小习惯。</p>
<p>32.招人最简单莫过于招干过这个事的人。不过能找到特质最具合适特质的人更重要。特别是创新企业，很多岗位未必有成熟的人对应，或者业界的普通标准并不特别适合，或者具体的岗位有一些特别的要求。这时候通过对岗位的理解而去招具备性格技能爱好特质的人就特别重要。</p>
<p>33.其实加入一个优秀的早期公司有一个明显的好处：公司会想尽办法帮你提高，因为公司有很多事情要做，而人员又有限。这个时候就会对有潜质的人提出各种高的要求，帮助提高。在大公司你的老板即使愿意(不一定)花时间和精力coach（教练）你，肯定没有创业公司多。</p>
<p>34.这周面了十几个人终于确定一个实习生。最近一个多月可能面试了50多人，总共只有2个非常有意向的人选，其中失败一个，一个还在谈。每当想放低要求的时候，我就提醒自己一定不能往低走而要往高走，我们要做的出彩，而不是完成的事情。而尤其在早期，核心几个人的能力、素质、态度是最关键的。</p>
<p>35.一个好的团队，是应该能够不断创新突破的团队。</p>
<p>36.有2个朋友2年前10万元起步创业令我佩服，今天见到一个创业者3年前0元起步创业令我惊讶。</p>
<p>37.公司的激励制度和考核制度非常重要，我不知道我看的是否是特例，了解到好些公司的重要岗位管理者长期一边拿着不错的回报，一边把精力重放在折腾自己想的事情。一定要避免这种情况。（不会有人觉得这种情况存在也合理吧）</p>
<p>38.以前面试选拔人的时候一直没有觉得自信这个特质很重要，现在发现在一般的简单的事情和工作自信不是一个重要特质，但是对于一些关键事情和职责自信就是重要区别的特质，真正困难或有挑战的事往往是反向操作的或者是相对孤独的。</p>
<p>39.中午亮哥说创业公司早期只能辛苦多面试人来淘人才。老王说自己的第一职位是hr（人力资源管理）。我觉得他们说的很对。</p>
<p>40.上线大概半年，经常觉得进度太慢。速度、质量、成本三者是不能都同时达到的，当然团队成长速度也是一个重要因素。</p>
<p>41.今天，把半年来每次与不同团队成员1:1沟通中得到的对我和对公司的意见建议作了个回顾，并作划分分为已解决、部分解决、问题依旧。恩，改进的还不够好。</p>
<p>42.结婚有一个不短谈恋爱的过程才领证，而找创业伙伴的时间缺短非常多。如果结婚是合作60年，创业是合作六七年，那么是否应该用 1&#x2F;10 的时间谈谈“恋爱”？</p>
<p>43.长期回报重点是股份期权。但这方面国内的还不规范：即使是早期核心成员也不被告知自己的期权占公司总股本的比例，更是没有普及优先偿还，行权价、行权条件限等概念，所以很多公司董事会把总股数做很大，让员工听起来好听。我想这个情况不会持久，我们不会这么做。</p>
<p>44.如何吸引人才：我总结（总结不表示我做好了，而是认识到要做好）四个要素：【短期回报】、【长期回报】、【个人成长】、【精神生活】。从左到右，从易到难，其中丰富不一般的人生体验和精神生活是最综合要求最高的，要不断反思追求，九九房会努力做好！欢迎优秀的技术人才、产品人才加入一起共事。</p>
<p>45.有一些人可用追求卓越来鼓舞，另一些人应以现实回报作激励，但是其实两种方法可以关联起来。我是这样关联的，如：“只要我能改进耐心不足的缺点就相当于个人将增值30%了”。</p>
<h1 id="三、关于商业"><a href="#三、关于商业" class="headerlink" title="三、关于商业"></a>三、关于商业</h1><p>1.堆砌的产品没有安全感，准确的抉择才有。</p>
<p>2.组织的成果都在组织之外，所以不要把做完了某某项目说成成果，而应该始终关注对外体现的成果，如：用户在什么方面体验得到了提升，公司在业界得到了什么益处。</p>
<p>3.微博的验证码是什么东西，怎么都答不对，这么重要的东西就这样质量就上线了。引以为戒。</p>
<p>4.创业就要像生小孩一样：准备好体力，用长劲，快速换气；喊疼和抱怨没用，专注在努力，关键时候坚持再坚持一把！</p>
<p>5.重视服务，重视感受，是重要的机会，随着收入水平提高，怕麻烦，希望高质量服务将成为付费动力。帮用户省钱不再是唯一思路，甚至不是最佳思路。</p>
<p>非常强的改善体验的技术应用，靠技术的强劲推动力，让不可能变成可能。</p>
<p>6.对产品经理的常用问题：有什么好处，重要吗，怎么知道的，达到这个好处有好的做法吗？</p>
<p>7.如果你很有才华，在某些方面又有一技之长，请先不要急于露出锋芒，如果你只是以普通身份而不是以领导身份到新单位去的，那就更不能锋芒太露。一个人新到一个单位，就像一粒石子投入一潭平静的池水，往往会引入注目，一举一动，一言一行，都在别人的视野之中。</p>
<p>8.发现问题总是又高兴又郁闷，高兴：解决问题；郁闷：为什么是我发现，为计么现在才发现</p>
<p>9.做产品一定要坚持面对事实仔细辨析小心求证，不绕弯不侥幸不鸵鸟，延迟满足感。</p>
<p>10.创业忌：未思进，先思退。</p>
<p>11.我也快看完了，推荐。我的分享内部交流。之前还看了一本《从零到百亿》，虽然中美环境差别挺大，但是关于创业和人生的差别不大。</p>
<p>12.大半夜来点给力的，创业四原则：刚才又一位出来创业的兄弟 msn 上跟我聊。再次诚恳分享给他：一，凡事只能靠自己；二，万事皆有解，且只有唯一正解；三，凡是担心的事一定会发生；四，从创业的第一天开始，享受！</p>
<p>13.未来会有更多的输入输出的创新让信息可流动，更多分发推荐的机制转动起来。</p>
<p>14.我从小到大遇到过2个大忽悠(不是某件事忽悠，忽悠成性的那种人)，一个中学同学，一个是今年，我的总结是一定不要和大忽悠交往合作，否则即使利益不受损，口碑也会受损。甚至连敷衍都不要去敷衍，那也会浪费你时间。</p>
<p>15.林彪研究战略更研究战术。46年共军初到东北，一个师打不过国军一个团。他冒死亲赴战场观战，研究出班的三三制战斗队形、一点两面等战术方法。并亲 自讲课推广，缩小了与国军战斗力差距。没有林彪，共党很可能失掉东北，改变战争进程。一个企业，如果战略家太多不是好事，抓细节的人越多越好。</p>
<p>16.创业公司周末上班是依靠中策，希望能做到依靠上策：非常主动，高峰状态，时间管理；Procative，Mindfull，Sensitive（练习、正念、敏捷）。</p>
<p>17.看马化腾的腾讯微博，真是超级注重用户体验的产品经理项目经理。</p>
<p>18.明天是9月的第1天。去年的今天，我离开了上一个团队开始筹备 99fang.com。过去的一年表现有优秀有不足，但是打下了很好的产品&#x2F;用户&#x2F;市场&#x2F;&#x2F;技术&#x2F;团队基础，尤其是我能明显感觉到团队的进步。从明天开始，我们要对自己有更高的挑战和要求。</p>
<p>19.今天公司一位同事用了G2一周后感言：虽然我还很多功能不会用，但是我觉得5年后肯定全部人都用智能手机，很高兴现在用上了。类似的话在公司再一次听到，这次是一个非it背景的同事预测。使用智能手机是一个的生活态度和方式的变化，而尝试新生活本身是积极的态度，而积极的态度是可以互相感染的。</p>
<p>20.反复反复反复体会需求体验产品，高强度的使用产品。</p>
<p>21.非理性让社会存在各种商业机会，非理性让创业公司错过这些机会。不要非理性，要非常理性。</p>
<p>22.互联网行业往往是 Winner Takes All（赢家通吃），即使是传统行业也往往是120%的努力的人获得200%的回报。这个是可以社会有利的，社会需要激励顶尖、极致、创新来带动社会发展。所以每天出门前问问自己如何才能全力以赴了做到杰出。</p>
<p>23.战略很重要，但是团队也相当重要，我自己有切身体会的。酷讯和去哪儿竞争，方向很清楚，但是差距越来越大。当年海内和开心竞争，对开心的数据产品也很了解，可惜就是眼睁睁看着对手从产品到推广上的节节胜利。回到现在团购网站，模式非常简单也没有什么门槛，但是也能拉开这么大的差距。</p>
<p>24.中午见到了一个在做音频信息处理的很有意思的团队，我相信信息的聚合、检索、关联、推荐有很大的空间。</p>
<p>25.模式、方向、战略提的很多，但是许多公司其实死在非常重要但是容易被忽略的基础点或细节上。</p>
<p>26.每天坚持抽看并跟踪10条用户反馈，避免问题疏忽。</p>
<p>27.京东商城“不上楼”的做法其实在很多行业都用过，比如不设导购，不收桌子，不负责安装，这种做减法非常正确和自信。学习。</p>
<p>28.刚刚做完用户可用性测试，发现很多问题。可用性测试是让团队近距离客观细致观察用户的使用体验，发现团队在工作期间想当然或者因为熟悉而忽略的问题。创业过程中出现愿望式思考并自我强化，是我时时提醒自己避免的。</p>
<p>29.创业公司的常见问题：技术怨产品、产品怨战略、战略怨市场。但是往往这种情况的公司技术产品、产品、产品都做的不怎么样。</p>
]]></content>
      <categories>
        <category>thought</category>
      </categories>
      <tags>
        <tag>张一鸣</tag>
      </tags>
  </entry>
  <entry>
    <title>目标与计划管理</title>
    <url>/2024/07/13/thought/mu-biao-yu-ji-hua-guan-li/</url>
    <content><![CDATA[<p>管理者的必修课——目标与计划管理。</p>
<p>一、工作目标是用来干什么的？<br>1.证明自己的努力是有结果的<br>2.给自己的奔跑找一个加油站<br>3.人们总是在不断的认可中前进<br>4.用节点的目标评估自己走过的路<br>5.用来评定工作绩效标准</p>
<p>1.1给自己一个努力的理由<br>1.强迫自己有计划有方向的努力<br>2.用以激励和鼓舞自己和团队</p>
<p>统一一群人的节奏</p>
<p>二、为什么目标年年长？</p>
<p>三、目标和任务的区别</p>
<p>四、怎样制定工作目标</p>
<p>五、怎样表述工作目标</p>
<p>生气是用别人的错误来惩罚自己。</p>
<p>二、如何分解任务</p>
<p>2.1 目标和任务之间的关系<br>1.一个目标需要分解成多个任务<br>2.一个大任务需要分解成N个小任务<br>3.每个任务必须有一个负责人<br>4.如果任务有交叉，主线负责人为主</p>
<p>2.2 任务的人接逻辑<br>逐级向下分解</p>
<p>2.3 部门、个人目标如何获得<br>公司愿景-》公司目标-》部门目标-》个人目标</p>
<p>2.4 分解原则<br>1.上一级负责本级的任务分解<br>2.负责辅导和审核下一集的任务分解</p>
<p>2.5 分解的层次<br>1.业务目标逐层分解<br>2.其它三个维度的目标在本层内具体（以BSC为例）</p>
<p>2.6 不同管理层级的分解动作略有不同<br>1.管理者也分为带带多编制队伍和多岗位队伍的差异<br>2.生产销售的基层管理者队伍位岗位少，编织多的特点，按照岗位人数分解任务</p>
<p>你的任务都涉及哪些维度</p>
<p>管理者的两个维度<br>1.团队任务<br>2.部门任务</p>
<p>一般任务的维度<br>1.财务&#x2F;业务维度——营收、成本、利润、事务<br>2.建立&#x2F;维护关系维度——建立起关系、维护好关系、满意度、转介绍等<br>3.内部管理——制度流程建设与完善，绩效考核岗位操作手册，规章制度，安全管理，质量管理等<br>4.岗位胜任度——学习提升，绩效改善，工具使用</p>
<p>如何分解任务</p>
<p>确定关键任务<br>1.根据任务和岗位职能<br>2.罗列出所有可能的任务<br>3.你和岗位人员单独罗列，然后汇总<br>4.岗位人员自己罗列（熟练员工）</p>
<p>著名的二八理论</p>
<p>任务如何表述<br>1.</p>
<p>如何确定任务</p>
<p>1.任务要和当事人商定吗<br>（1）认同的到位，比绝对的精确耕种阿红<br>共识</p>
]]></content>
      <categories>
        <category>thought</category>
      </categories>
      <tags>
        <tag>目标</tag>
        <tag>计划</tag>
        <tag>管理</tag>
      </tags>
  </entry>
  <entry>
    <title>非人力资源经理的人力资源管理</title>
    <url>/2022/03/24/thought/fei-ren-li-zi-yuan-jing-li-de-ren-li-zi-yuan-guan-li/</url>
    <content><![CDATA[<h1 id="一、人力资源管理的技巧"><a href="#一、人力资源管理的技巧" class="headerlink" title="一、人力资源管理的技巧"></a>一、人力资源管理的技巧</h1><p>人力资源管理的核心：选、育、用、留</p>
<h2 id="1-1-人力日常资源管理（HRM）"><a href="#1-1-人力日常资源管理（HRM）" class="headerlink" title="1.1 人力日常资源管理（HRM）"></a>1.1 人力日常资源管理（HRM）</h2><ul>
<li>招聘与选材（Staffing）</li>
<li>薪酬与福利（C&amp;B）</li>
<li>员工关系管理（Employee Relations）</li>
<li>绩效管理（Performance Management）</li>
<li>人力资源电子化管理（E-HR）</li>
</ul>
<h2 id="1-2-人力资源管理谁来做？"><a href="#1-2-人力资源管理谁来做？" class="headerlink" title="1.2 人力资源管理谁来做？"></a>1.2 人力资源管理谁来做？</h2><ol>
<li>所有有下述的人都是公司的人力资源管理者</li>
<li>人力资源部门负责提供有力工具协助管理人力资源</li>
<li>公司老大就是首席人力资源管理者</li>
<li>人力资源管理成败关键<strong>中层管理者</strong></li>
</ol>
<h1 id="二、选材实操篇"><a href="#二、选材实操篇" class="headerlink" title="二、选材实操篇"></a>二、选材实操篇</h1><ul>
<li>一慢：清理成年人在选材方面的定式&#x2F;偏见</li>
<li>二慢：看看所招岗位需要什么素质</li>
<li>三通过: 通过行为面试法看人不走眼</li>
<li>我怎样综合评估候选人？</li>
</ul>
<h2 id="2-1-一慢：清理成年人在选材方面的定式-偏见"><a href="#2-1-一慢：清理成年人在选材方面的定式-偏见" class="headerlink" title="2.1 一慢：清理成年人在选材方面的定式&#x2F;偏见"></a>2.1 一慢：清理成年人在选材方面的定式&#x2F;偏见</h2><ul>
<li>对一些人&#x2F;事的刻板印象<br>1、年龄<br>2、性别<br>3、学生会干部</li>
<li>试图寻找“超人”</li>
<li>校园招聘忽略应届生情商和逆商</li>
</ul>
<h2 id="2-2-二慢：看看所招岗位需要什么素质"><a href="#2-2-二慢：看看所招岗位需要什么素质" class="headerlink" title="2.2 二慢：看看所招岗位需要什么素质"></a>2.2 二慢：看看所招岗位需要什么素质</h2><ul>
<li>简单工作分析——他上班后要做什么</li>
<li>提炼关键事件——要做的工作中最困难的是什么</li>
<li>确定胜任核心素质——要克服最困难的事需要什么素质</li>
</ul>
<h2 id="2-3-三通过-通过行为面试法看人不走眼"><a href="#2-3-三通过-通过行为面试法看人不走眼" class="headerlink" title="2.3 三通过: 通过行为面试法看人不走眼"></a>2.3 三通过: 通过行为面试法看人不走眼</h2><p>STAR行为面试法：多问过去，少问将来</p>
<ul>
<li>情景：Situation</li>
<li>目标&#x2F;任务: Target&#x2F;Task</li>
<li>行动：Action</li>
<li>结果：Result</li>
</ul>
<h1 id="三、育才实操篇"><a href="#三、育才实操篇" class="headerlink" title="三、育才实操篇"></a>三、育才实操篇</h1><ul>
<li>培训篇：一个中心与两个基本点</li>
<li>辅导篇：做员工的最佳教练</li>
<li>培训篇：与公司同成长的4种规划方式</li>
</ul>
<h2 id="3-1-培训篇：一个中心与两个基本点"><a href="#3-1-培训篇：一个中心与两个基本点" class="headerlink" title="3.1 培训篇：一个中心与两个基本点"></a>3.1 培训篇：一个中心与两个基本点</h2><p>一个中心：员工<br>第一个基本点：培训需求分析<br>第二个基本点：培训效果追踪</p>
<h3 id="第一个基本点：培训需求分析"><a href="#第一个基本点：培训需求分析" class="headerlink" title="第一个基本点：培训需求分析"></a>第一个基本点：培训需求分析</h3><table>
<thead>
<tr>
<th>分析</th>
<th>目的</th>
</tr>
</thead>
<tbody><tr>
<td>组织分析</td>
<td>决定组织种哪里要培训</td>
</tr>
<tr>
<td>任务分析</td>
<td>决定培训什么内容</td>
</tr>
<tr>
<td>人员分析</td>
<td>决定谁该接受培训</td>
</tr>
</tbody></table>
<h3 id="第二个基本点：培训效果评估"><a href="#第二个基本点：培训效果评估" class="headerlink" title="第二个基本点：培训效果评估"></a>第二个基本点：培训效果评估</h3><p>反应：针对学员对课程及学习过程的满意度进行评估。<br>学习：针对学员完成课程后，所保留的学习成效进行评估。<br>行为：针对学员回岗位后，其行为或绩效是否因培训而有改变进行评估。<br>结果：针对培训的整体投资报酬率进行评估。</p>
<h2 id="3-2-辅导篇：做员工的最佳教练"><a href="#3-2-辅导篇：做员工的最佳教练" class="headerlink" title="3.2 辅导篇：做员工的最佳教练"></a>3.2 辅导篇：做员工的最佳教练</h2><p>接受：认识到培训重要，允许员工去培训<br>鼓励：调整工作安排鼓励员工参加培训<br>强化：培训完与其探讨如何支持其新技能<br>给机会：员工学到新技能后有实践机会<br>教练：作为教练全程辅导</p>
<h2 id="3-3-培训篇：与公司同成长的4种规划方式"><a href="#3-3-培训篇：与公司同成长的4种规划方式" class="headerlink" title="3.3 培训篇：与公司同成长的4种规划方式"></a>3.3 培训篇：与公司同成长的4种规划方式</h2><p>个人职业规划，确保个人在组织种的进步，其表现和潜力符合组织的需要：<br>1、升职<br>2、轮岗<br>3、工作扩大化<br>4、工作丰富化</p>
<h1 id="四、用才篇——绩效管理"><a href="#四、用才篇——绩效管理" class="headerlink" title="四、用才篇——绩效管理"></a>四、用才篇——绩效管理</h1><h2 id="4-1-员工绩效为什么不高？"><a href="#4-1-员工绩效为什么不高？" class="headerlink" title="4.1 员工绩效为什么不高？"></a>4.1 员工绩效为什么不高？</h2><h3 id="绩效反馈反面"><a href="#绩效反馈反面" class="headerlink" title="绩效反馈反面"></a>绩效反馈反面</h3><ul>
<li>无反馈或无效反馈</li>
</ul>
<h3 id="平时的阻碍"><a href="#平时的阻碍" class="headerlink" title="平时的阻碍"></a>平时的阻碍</h3><ul>
<li>身体生病</li>
<li>精神压力大</li>
<li>感情受挫</li>
<li>被要求在同一时间完成相矛盾的工作</li>
<li>缺乏足够的资源来做事</li>
</ul>
<h3 id="绩效标准方面"><a href="#绩效标准方面" class="headerlink" title="绩效标准方面"></a>绩效标准方面</h3><ul>
<li>绩效标准不量化</li>
<li>没跟员工沟通而直接派活</li>
<li>绩效标准太高</li>
</ul>
<h3 id="绩效后果方面"><a href="#绩效后果方面" class="headerlink" title="绩效后果方面"></a>绩效后果方面</h3><ul>
<li>考完后没有重奖重罚</li>
<li>绩效后果不刺激员工行为</li>
</ul>
<h3 id="员工本身的技能方面"><a href="#员工本身的技能方面" class="headerlink" title="员工本身的技能方面"></a>员工本身的技能方面</h3><ul>
<li>员工不知道怎样做</li>
</ul>
<h2 id="4-2-如何设定量化指标，并分解给部门"><a href="#4-2-如何设定量化指标，并分解给部门" class="headerlink" title="4.2 如何设定量化指标，并分解给部门?"></a>4.2 如何设定量化指标，并分解给部门?</h2><ul>
<li>Specific: 特定的</li>
<li>Measurable：可衡量的</li>
<li>Agreed：双方同意的</li>
<li>Realistic：现实的</li>
<li>Time-bond：有时间限制的</li>
</ul>
<blockquote>
<h3 id="绩效目标"><a href="#绩效目标" class="headerlink" title="绩效目标"></a>绩效目标</h3></blockquote>
<ul>
<li>对要达成的结果的一个表述</li>
<li>更适于经理们和专业员工等涉及个人项目的工作</li>
</ul>
<blockquote>
<h3 id="绩效标准"><a href="#绩效标准" class="headerlink" title="绩效标准"></a>绩效标准</h3></blockquote>
<ul>
<li>是一种延续的，须一次又一次遵守的准则</li>
<li>更适用于从事日常需要及重复性作业的工作</li>
</ul>
<h2 id="4-3-建设性反馈方法"><a href="#4-3-建设性反馈方法" class="headerlink" title="4.3 建设性反馈方法"></a>4.3 建设性反馈方法</h2><p>“汉堡”原则</p>
<ul>
<li>先表扬特定的成就，给予真心的肯定</li>
<li>然后提出需要改进的“特定”的行为表现</li>
<li>最后肯定和支持结果</li>
</ul>
<h2 id="4-4-如何友好地结束面谈"><a href="#4-4-如何友好地结束面谈" class="headerlink" title="4.4 如何友好地结束面谈"></a>4.4 如何友好地结束面谈</h2><ol>
<li>确认员工理解你的每一个评估</li>
<li>可以请员工在面谈记录上签字确认</li>
<li>永远以积极的言谈结束谈话</li>
</ol>
<p><font clolor="#ff0000">！！！不要轻易许诺你不确认的事</font></p>
<h1 id="五、留才篇——多用“薪”不如多用“心”"><a href="#五、留才篇——多用“薪”不如多用“心”" class="headerlink" title="五、留才篇——多用“薪”不如多用“心”"></a>五、留才篇——多用“薪”不如多用“心”</h1><h2 id="5-1-激励是管理中的核心问题"><a href="#5-1-激励是管理中的核心问题" class="headerlink" title="5.1 激励是管理中的核心问题"></a>5.1 激励是管理中的核心问题</h2><blockquote>
<p><font color="#ff0000">危机激励</font>: 负强化，企业必须要做的事    </p>
</blockquote>
<ol>
<li>物质激励</li>
<li>精神激励</li>
<li>培训激励</li>
<li>目标激励</li>
<li>参与激励</li>
<li>情感激励</li>
<li>信任激励</li>
<li>晋升激励</li>
<li>荣誉激励</li>
<li>榜样激励</li>
</ol>
<h2 id="5-2-Maslow-马斯洛——需求层次理论"><a href="#5-2-Maslow-马斯洛——需求层次理论" class="headerlink" title="5.2 Maslow 马斯洛——需求层次理论"></a>5.2 Maslow 马斯洛——需求层次理论</h2><h3 id="更适合激励核心员工-20"><a href="#更适合激励核心员工-20" class="headerlink" title="更适合激励核心员工(20%)"></a><font color="#ff000">更适合激励核心员工</font>(20%)</h3><ol>
<li>生理需求</li>
<li>安全需求</li>
<li>归属需求</li>
<li>尊重需求</li>
<li>自我实现需求</li>
</ol>
<h2 id="5-3-三种高管适用的个人激励方法"><a href="#5-3-三种高管适用的个人激励方法" class="headerlink" title="5.3 三种高管适用的个人激励方法"></a>5.3 三种高管适用的个人激励方法</h2><ol>
<li>制度激励——让优秀员工与众不同</li>
<li>职业生涯规划激励（升职；轮岗；工作扩大化；工作丰富化）</li>
<li>企业文化留人</li>
</ol>
<h2 id="5-4-四种中层管理者适用的个人激励方法"><a href="#5-4-四种中层管理者适用的个人激励方法" class="headerlink" title="5.4 四种中层管理者适用的个人激励方法"></a>5.4 四种中层管理者适用的个人激励方法</h2><ol>
<li>期望留人-罗森塔尔效应——我知道你可以的</li>
<li>工作扩大化与丰富化——让员工有机会进步（工作轮换，工作扩大化，工作丰富化）</li>
<li>得人心者得天下——感情激励</li>
<li>巧用团体压力——团队激励（群体动力学）</li>
</ol>
<h1 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h1><p>人力资源管理得核心事：选、育、用、留。</p>
<ul>
<li>选：行为面试法结合STAR法则</li>
<li>育：围绕员工这个核心，分析要培训什么，追踪培训效果，做好员工的帮、扶、带</li>
<li>用：基于SMART法则设定量化目标，做好绩效面谈及反馈</li>
<li>留：观察员工得需求，采用适当得激励方式</li>
</ul>
]]></content>
      <categories>
        <category>thought</category>
      </categories>
      <tags>
        <tag>人力资源管理</tag>
      </tags>
  </entry>
  <entry>
    <title>高效执行与持续优化</title>
    <url>/2024/05/16/thought/gao-xiao-zhi-xing-yu-chi-xu-you-hua/</url>
    <content><![CDATA[<h1 id="一、高效执行与持续优化"><a href="#一、高效执行与持续优化" class="headerlink" title="一、高效执行与持续优化"></a>一、高效执行与持续优化</h1><h2 id="1-1-独立人格"><a href="#1-1-独立人格" class="headerlink" title="1.1 独立人格"></a>1.1 独立人格</h2><ol>
<li>独立承担责任</li>
<li>独立坚守原则</li>
</ol>
<h2 id="1-2-什么是执行力"><a href="#1-2-什么是执行力" class="headerlink" title="1.2 什么是执行力"></a>1.2 什么是执行力</h2><p>以规则为标注，第一时间把目标变成结果的行动。 </p>
<h2 id="1-3-预见结果的4A工具"><a href="#1-3-预见结果的4A工具" class="headerlink" title="1.3 预见结果的4A工具"></a>1.3 预见结果的4A工具</h2><p>1.目标（Aim）<br>2.指标（Advocacy）<br>3.行动措施（Action）<br>4.承诺（Acceptance）</p>
<h2 id="1-4-执行的是三种状态"><a href="#1-4-执行的是三种状态" class="headerlink" title="1.4 执行的是三种状态"></a>1.4 执行的是三种状态</h2><ul>
<li>机械执行：只看行为是否发生</li>
<li>热情执行：看行为质量如何去做</li>
<li>同理执行：按照需求倒退实施</li>
</ul>
<h2 id="1-5-任务与结果的三大区别"><a href="#1-5-任务与结果的三大区别" class="headerlink" title="1.5 任务与结果的三大区别"></a>1.5 任务与结果的三大区别</h2><h3 id="任务是三事"><a href="#任务是三事" class="headerlink" title="任务是三事"></a>任务是三事</h3><ul>
<li>例行公事：该走的程序都走了</li>
<li>完成差事：该做的行动都做了</li>
<li>敷衍了事：该干的任务都干了</li>
</ul>
<h3 id="结果是三有"><a href="#结果是三有" class="headerlink" title="结果是三有"></a>结果是三有</h3><ul>
<li>有时间：凡事有期限</li>
<li>有价值：凡事被需要</li>
<li>有证据：凡事能检查</li>
</ul>
<h1 id="二、如何做执行人才"><a href="#二、如何做执行人才" class="headerlink" title="二、如何做执行人才"></a>二、如何做执行人才</h1><h2 id="2-1-执行人才的特点"><a href="#2-1-执行人才的特点" class="headerlink" title="2.1 执行人才的特点"></a>2.1 执行人才的特点</h2><p>百分百责任<br>1.客户、领导、同事、岗位</p>
<h2 id="2-2-执行团队是那个统一"><a href="#2-2-执行团队是那个统一" class="headerlink" title="2.2 执行团队是那个统一"></a>2.2 执行团队是那个统一</h2><ol>
<li>统一思想：把需求和目标进行结合</li>
<li>统一声音：声音一致，避免杂音</li>
<li>统一动作：以思想和声音统一为前提</li>
</ol>
<h2 id="2-3-主动反馈的六大时机"><a href="#2-3-主动反馈的六大时机" class="headerlink" title="2.3 主动反馈的六大时机"></a>2.3 主动反馈的六大时机</h2><ol>
<li>任务执行完后</li>
<li>阶段性结果完成后</li>
<li>执行中遇到困难需要领导支持</li>
<li>执行中遇到更好的资源、机会、信息</li>
<li>领导格外关注的环节完成后</li>
<li>例行反馈</li>
</ol>
<h2 id="2-4-执行人才的三大素养"><a href="#2-4-执行人才的三大素养" class="headerlink" title="2.4 执行人才的三大素养"></a>2.4 执行人才的三大素养</h2><ol>
<li>服从</li>
<li>主动</li>
<li>自律</li>
</ol>
<h2 id="2-5-如何区分紧急"><a href="#2-5-如何区分紧急" class="headerlink" title="2.5 如何区分紧急"></a>2.5 如何区分紧急</h2><ol>
<li>如果现在不做就会错过做这件事的机会</li>
</ol>
<h2 id="2-6-执行人才的表现"><a href="#2-6-执行人才的表现" class="headerlink" title="2.6 执行人才的表现"></a>2.6 执行人才的表现</h2><ul>
<li>说到做到不吹牛</li>
<li>内省反思不外求</li>
<li>主动反馈不依赖</li>
<li>准时准确不等待</li>
<li>遵守规矩不犹豫</li>
<li>承担责任不逃避</li>
</ul>
<h1 id="三、执行流程三段论"><a href="#三、执行流程三段论" class="headerlink" title="三、执行流程三段论"></a>三、执行流程三段论</h1><ol>
<li>执行前：对</li>
<li>执行中：快</li>
<li>执行后：好</li>
</ol>
<h2 id="3-1-执行前的“三确”"><a href="#3-1-执行前的“三确”" class="headerlink" title="3.1 执行前的“三确”"></a>3.1 执行前的“三确”</h2><ul>
<li>确认：4W模型（when、where、what、who）</li>
<li>确信：决心第一成败第二</li>
<li>确保：思考如何达成目标和应对突发情况</li>
</ul>
<h2 id="3-2-执行中的“三时”"><a href="#3-2-执行中的“三时”" class="headerlink" title="3.2 执行中的“三时”"></a>3.2 执行中的“三时”</h2><ul>
<li>即时：立即行动</li>
<li>及时：及时纠正</li>
<li>适时：适时汇报</li>
</ul>
<h3 id="3-2-1-汇报五个流程"><a href="#3-2-1-汇报五个流程" class="headerlink" title="3.2.1 汇报五个流程"></a>3.2.1 汇报五个流程</h3><ol>
<li>说结果</li>
<li>找原因</li>
<li>拿策略</li>
<li>要资源</li>
<li>做承诺</li>
</ol>
<h2 id="3-3-执行后的“三交”"><a href="#3-3-执行后的“三交”" class="headerlink" title="3.3 执行后的“三交”"></a>3.3 执行后的“三交”</h2><ul>
<li>交结果</li>
<li>交总结</li>
<li>交想法</li>
</ul>
<h1 id="四、提升执行力的三大方法"><a href="#四、提升执行力的三大方法" class="headerlink" title="四、提升执行力的三大方法"></a>四、提升执行力的三大方法</h1><h2 id="方法一：复述承诺法"><a href="#方法一：复述承诺法" class="headerlink" title="方法一：复述承诺法"></a>方法一：复述承诺法</h2><p>先复述，再承诺，让领导放心。</p>
<h2 id="方法二：分解法"><a href="#方法二：分解法" class="headerlink" title="方法二：分解法"></a>方法二：分解法</h2><ul>
<li>复杂问题简单化</li>
<li>简单问题弱智化</li>
</ul>
<h3 id="个人战略规划工具"><a href="#个人战略规划工具" class="headerlink" title="个人战略规划工具"></a>个人战略规划工具</h3><ol>
<li>未来五年远景</li>
<li>个人发展战略所需要解决的根本矛盾</li>
<li>个人核心价值观</li>
<li>未来两年目标</li>
<li>2024年主题（包含家庭主题）</li>
<li>2024行动计划（包含家庭目标达成计划）</li>
<li>需要放弃的资源</li>
</ol>
<h2 id="方法三：寻求协助法"><a href="#方法三：寻求协助法" class="headerlink" title="方法三：寻求协助法"></a>方法三：寻求协助法</h2><ol>
<li>明确目标：想获得什么帮助</li>
<li>打好基础： 积累情感账户</li>
<li>关键时刻： 提出多个选择方案</li>
</ol>
<blockquote>
<p>寻求协助时，很多情况下我们缺乏情感账户的积累，所以明确目标和提出多个选择方案是我们寻求协助成功的关键条件。</p>
</blockquote>
<h1 id="五、执行的方向——客户价值"><a href="#五、执行的方向——客户价值" class="headerlink" title="五、执行的方向——客户价值"></a>五、执行的方向——客户价值</h1><p>客户价值：站在客户的角度，为客户提供满意和超值的结果，是执行的方向！</p>
<ul>
<li>满意的结果产生满意的用户</li>
<li>超值的结果产生忠诚的用户</li>
</ul>
<h2 id="内部客户价值"><a href="#内部客户价值" class="headerlink" title="内部客户价值"></a>内部客户价值</h2><p>企业内部客户关系</p>
<ul>
<li>从生产流程看： 下道工序是上道工序的客户</li>
<li>从工作结果看： 上级是下级的客户</li>
<li>从成长机会看： 下级是上级的客户</li>
</ul>
<h2 id="销售部与市场部关于政策的矛盾解决"><a href="#销售部与市场部关于政策的矛盾解决" class="headerlink" title="销售部与市场部关于政策的矛盾解决"></a>销售部与市场部关于政策的矛盾解决</h2><h3 id="市场部"><a href="#市场部" class="headerlink" title="市场部"></a>市场部</h3><ul>
<li>邀请参与</li>
<li>详细讲解</li>
<li>制定机制</li>
<li>专人负责</li>
<li>持续更新</li>
</ul>
<h3 id="销售部"><a href="#销售部" class="headerlink" title="销售部"></a>销售部</h3><ul>
<li>内部分享</li>
<li>信任培训</li>
<li>管理流程</li>
<li>专人对接</li>
<li>持续更新</li>
</ul>
<h1 id="六、执行力段位"><a href="#六、执行力段位" class="headerlink" title="六、执行力段位"></a>六、执行力段位</h1><p>九段秘书测试</p>
<ul>
<li>一段发通知</li>
<li>二段抓落实</li>
<li>三段重检查</li>
<li>四段勤准备</li>
<li>五段提前量</li>
<li>六段总记录</li>
<li>七段发纪要</li>
<li>八段定责任</li>
<li>九段做流程</li>
</ul>
<h1 id="思考与收获"><a href="#思考与收获" class="headerlink" title="思考与收获"></a>思考与收获</h1><ol>
<li>承认问题是解决问题的开始</li>
<li>小孩讲对与错，成年人讲得与失</li>
<li>人才和人手的区别：不可替代性</li>
<li>向内看，少评判</li>
</ol>
<blockquote>
<p>如果完全按照这个课程执行，是否是变成一个完美的工具人；高效执行背后的核心价值是什么呢？我认为是高效完成工作,认真享受生活。</p>
</blockquote>
]]></content>
      <categories>
        <category>thought</category>
      </categories>
      <tags>
        <tag>管理</tag>
        <tag>执行</tag>
        <tag>领导</tag>
      </tags>
  </entry>
</search>
