<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Nginx负载均衡失败重试 | 逐光の博客</title><meta name="author" content="逐光"><meta name="copyright" content="逐光"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="一、问题背景在对一个接口进行反向代理时，nginx总是会打印error日志，但是请求是正常的。根据nginx的error日志，发现是请求到ipv6地址失败，但是最终的代理请求是成功的，所以接下来分析一下nginx的负载均衡及失败重试机制。 nginx配置文件如下： server &amp;#123; ..."><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Nginx负载均衡失败重试",
  "url": "https://www.mpoom.cn/2021/04/26/nginx/nginx-fu-zai-jun-heng-shi-bai-chong-shi/",
  "image": "https://www.mpoom.cn/2021/04/26/nginx/nginx-fu-zai-jun-heng-shi-bai-chong-shi/cover.jpg",
  "datePublished": "2021-04-25T16:00:00.000Z",
  "dateModified": "2021-04-25T16:00:00.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "逐光",
      "url": "https://www.mpoom.cn"
    }
  ]
}</script><link rel="shortcut icon" href="/images/theme/avatar.png"><link rel="canonical" href="https://www.mpoom.cn/2021/04/26/nginx/nginx-fu-zai-jun-heng-shi-bai-chong-shi/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.3"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Nginx负载均衡失败重试',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 5.4.2"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/images/theme/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">106</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">179</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">20</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/categories/book/"><i class="fa-fw fa fa-book"></i><span> 读书</span></a></div><div class="menus_item"><a class="site-page" href="/categories/thought/"><i class="fa-fw fa fa-lightbulb"></i><span> 思考感悟</span></a></div><div class="menus_item"><a class="site-page" href="/skills/"><i class="fa-fw fas fa-code"></i><span> 专业能力</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/images/theme/avatar.png" alt="Logo"><span class="site-name">逐光の博客</span></a><a class="nav-page-title" href="/"><span class="site-name">Nginx负载均衡失败重试</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/categories/book/"><i class="fa-fw fa fa-book"></i><span> 读书</span></a></div><div class="menus_item"><a class="site-page" href="/categories/thought/"><i class="fa-fw fa fa-lightbulb"></i><span> 思考感悟</span></a></div><div class="menus_item"><a class="site-page" href="/skills/"><i class="fa-fw fas fa-code"></i><span> 专业能力</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">Nginx负载均衡失败重试</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-04-25T16:00:00.000Z" title="发表于 2021-04-26 00:00:00">2021-04-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2026-01-15T10:15:24.751Z" title="更新于 2026-01-15 18:15:24">2026-01-15</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%BF%90%E7%BB%B4/">运维</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">2.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>10分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="container post-content" id="article-container"><h1 id="一、问题背景"><a href="#一、问题背景" class="headerlink" title="一、问题背景"></a>一、问题背景</h1><p>在对一个接口进行反向代理时，nginx总是会打印error日志，但是请求是正常的。根据nginx的error日志，发现是请求到ipv6地址失败，但是最终的代理请求是成功的，所以接下来分析一下nginx的负载均衡及失败重试机制。</p>
<p>nginx配置文件如下：</p>
<pre class="line-numbers language-none"><code class="language-none">server &#123;
    listen       9000;
    server_name  localhost;
    #proxy_next_upstream off;
    location &#x2F;ncs&#x2F;telecom&#x2F;phone-verify &#123;
        proxy_pass https:&#x2F;&#x2F;open.e.189.cn&#x2F;auth&#x2F;verifyinfo.do;
        proxy_read_timeout 300;
        proxy_connect_timeout 300;
        proxy_redirect off;
    
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host &#39;open.e.189.cn&#39;;
        proxy_set_header X-Real-IP $remote_addr;
    &#125;
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>nginx error日志内容如下：</p>
<pre class="line-numbers language-none"><code class="language-none">[error] 3587705#0: *3471 connect() to [240e:698:100::2]:443 failed (101: Network is unreachable) while connecting to upstream, client: 127.0.0.1, server: localhost, request: &quot;GET &#x2F;ncs&#x2F;telecom&#x2F;phone-verify HTTP&#x2F;1.1&quot;, upstream: &quot;https:&#x2F;&#x2F;[240e:698:100::2]:443&#x2F;auth&#x2F;verifyinfo.do&quot;, host: &quot;localhost:9000&quot;
[error] 3587705#0: *3471 connect() to [240e:698:100::4]:443 failed (101: Network is unreachable) while connecting to upstream, client: 127.0.0.1, server: localhost, request: &quot;GET &#x2F;ncs&#x2F;telecom&#x2F;phone-verify HTTP&#x2F;1.1&quot;, upstream: &quot;https:&#x2F;&#x2F;[240e:698:100::4]:443&#x2F;auth&#x2F;verifyinfo.do&quot;, host: &quot;localhost:9000&quot;
[error] 3587705#0: *3471 connect() to [240e:698:100::5]:443 failed (101: Network is unreachable) while connecting to upstream, client: 127.0.0.1, server: localhost, request: &quot;GET &#x2F;ncs&#x2F;telecom&#x2F;phone-verify HTTP&#x2F;1.1&quot;, upstream: &quot;https:&#x2F;&#x2F;[240e:698:100::5]:443&#x2F;auth&#x2F;verifyinfo.do&quot;, host: &quot;localhost:9000&quot;
[error] 3587705#0: *3471 connect() to [240e:698:100::3]:443 failed (101: Network is unreachable) while connecting to upstream, client: 127.0.0.1, server: localhost, request: &quot;GET &#x2F;ncs&#x2F;telecom&#x2F;phone-verify HTTP&#x2F;1.1&quot;, upstream: &quot;https:&#x2F;&#x2F;[240e:698:100::3]:443&#x2F;auth&#x2F;verifyinfo.do&quot;, host: &quot;localhost:9000&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="二、proxy-pass"><a href="#二、proxy-pass" class="headerlink" title="二、proxy_pass"></a>二、<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass">proxy_pass</a></h1><blockquote>
<p>Syntax:	proxy_pass URL;<br>Default:	—<br>Context:	location, if in location, limit_except</p>
</blockquote>
<p>Sets the protocol and address of a proxied server and an optional URI to which a location should be mapped. As a protocol, “http” or “https” can be specified. The address can be specified as a domain name or IP address, and an optional port:</p>
<blockquote>
<p>proxy_pass <a target="_blank" rel="noopener" href="http://localhost:8000/uri/">http://localhost:8000/uri/</a>;</p>
</blockquote>
<p>or as a UNIX-domain socket path specified after the word “unix” and enclosed in colons:</p>
<blockquote>
<p>proxy_pass <a target="_blank" rel="noopener" href="http://unix/tmp/backend.socket:/uri/">http://unix:/tmp/backend.socket:/uri/</a>;</p>
</blockquote>
<p>If a domain name resolves to several addresses, all of them will be used in a round-robin fashion. In addition, an address can be specified as a server group.</p>
<p>Parameter value can contain variables. In this case, if an address is specified as a domain name, the name is searched among the described server groups, and, if not found, is determined using a resolver.</p>
<p>根据<code>proxy_pass</code>的说明，我们的代理地址可以是域名或IP地址，如果地址是域名并且这个域名被解析到多个地址时，nginx以轮询的方式访问解析后的这些地址。<br>此外，可以将这个地址指定为一个server group，即我们的代理地址时一个域名的时候，域名解析后的地址将会被转换为一个<code>upstream</code>服务组，以默认轮询的方式提供服务。</p>
<p>代理地址的参数中可以包含变量，当代理地址被指定为一个域名的时候，则在描述的服务器组中搜索该名称，如果没有找到，则使用域名解析器确定。</p>
<h1 id="三、resolver"><a href="#三、resolver" class="headerlink" title="三、resolver"></a>三、<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_core_module.html#resolver">resolver</a></h1><blockquote>
<p>Syntax:	resolver address … [valid&#x3D;time] [ipv6&#x3D;on|off] [status_zone&#x3D;zone];<br>Default:	—<br>Context:	http, server, location</p>
</blockquote>
<p>Configures name servers used to resolve names of upstream servers into addresses, for example:</p>
<blockquote>
<p>resolver 127.0.0.1 [::1]:5353;</p>
</blockquote>
<p>The address can be specified as a domain name or IP address, with an optional port (1.3.1, 1.2.2). If port is not specified, the port 53 is used. Name servers are queried in a round-robin fashion.</p>
<blockquote>
<p>Before version 1.1.7, only a single name server could be configured. Specifying name servers using IPv6 addresses is supported starting from versions 1.3.1 and 1.2.2.</p>
</blockquote>
<p>By default, nginx will look up both IPv4 and IPv6 addresses while resolving. If looking up of IPv6 addresses is not desired, the ipv6&#x3D;off parameter can be specified.</p>
<blockquote>
<p>Resolving of names into IPv6 addresses is supported starting from version 1.5.8.</p>
</blockquote>
<p>By default, nginx caches answers using the TTL value of a response. An optional valid parameter allows overriding it:</p>
<blockquote>
<p>resolver 127.0.0.1 [::1]:5353 valid&#x3D;30s;</p>
</blockquote>
<p>通过<code>proxy_pass</code>的说明我们知道，在nginx中可以配置resolver对域名进行解析，并关闭ipv6的解析。</p>
<p>所以nginx代理的的配置文件如下：</p>
<pre class="line-numbers language-none"><code class="language-none">server &#123;
    listen       9000;
    server_name  localhost;
    resolver 114.114.114.114 valid&#x3D;60s ipv6&#x3D;off;
    
    location &#x2F;ncs&#x2F;telecom&#x2F;phone-verify &#123;
        set $telecom open.e.189.cn;
        proxy_pass https:&#x2F;&#x2F;$telecom&#x2F;auth&#x2F;verifyinfo.do;
        proxy_read_timeout 300;
        proxy_connect_timeout 300;
        proxy_redirect off;

        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host &#39;open.e.189.cn&#39;;
        proxy_set_header X-Real-IP $remote_addr;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过上述配置（注意：必须将<code>proxy_pass</code>参数中的域名设置为变量)，我们指定代理地址中的域名每间隔60s进行解析一次，解析时排除掉域名中的ipv6地址。</p>
<p>域名open.e.189.cn解析后的IP地址如下：</p>
<pre class="line-numbers language-none"><code class="language-none">[root@10-13-149-183 conf.d]# nslookup open.e.189.cn
Server:         10.13.255.1
Address:        10.13.255.1#53

Non-authoritative answer:
open.e.189.cn   canonical name &#x3D; open.e-189.21cn.com.
Name:   open.e-189.21cn.com
Address: 42.123.76.75
Name:   open.e-189.21cn.com
Address: 42.123.76.52
Name:   open.e-189.21cn.com
Address: 42.123.76.87
Name:   open.e-189.21cn.com
Address: 240e:698:100::3
Name:   open.e-189.21cn.com
Address: 240e:698:100::2
Name:   open.e-189.21cn.com
Address: 240e:698:100::5
Name:   open.e-189.21cn.com
Address: 240e:698:100::4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>修改nginx配置后重启，发现error日志中已经没有报错了，至此nginx代理请求ipv6报错的问题已经解决了。</p>
<p>前面我们看到，即使在nginx打印了请求ipv6的失败的情况下，但我们的请求最后仍是成功的，这是由于nginx的失败重试机制，接下来我们分析一下nginx的失败重试机制。</p>
<h1 id="四、upstream"><a href="#四、upstream" class="headerlink" title="四、upstream"></a>四、<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_upstream_module.html">upstream</a></h1><p>nginx的<code>ngx_http_upstream_module</code>的模块时用来定义一个服务组的，这个服务组可以被<code>proxy_pass</code>等模块引用。<br>前面在<code>proxy_pass</code>中提到，当我们的代理地址是一个域名的时候，域名解析后的地址将被转换位一个<code>upstream</code>服务组。<br><code>upstream</code>的配置示例如下：</p>
<pre class="line-numbers language-none"><code class="language-none">resolver 10.0.0.1;

upstream dynamic &#123;
    zone upstream_dynamic 64k;

    server backend1.example.com      weight&#x3D;5;
    server backend2.example.com:8080 fail_timeout&#x3D;5s slow_start&#x3D;30s;
    server 192.0.2.1                 max_fails&#x3D;3;
    server backend3.example.com      resolve;
    server backend4.example.com      service&#x3D;http resolve;

    server backup1.example.com:8080  backup;
    server backup2.example.com:8080  backup;
&#125;

server &#123;
    location &#x2F; &#123;
        proxy_pass http:&#x2F;&#x2F;dynamic;
        health_check;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>Syntax:	server address [parameters];<br>Default:	—<br>Context:	upstream</p>
</blockquote>
<ul>
<li><p>max_fails&#x3D;number<br>sets the number of unsuccessful attempts to communicate with the server that should happen in the duration set by the fail_timeout parameter to consider the server unavailable for a duration also set by the fail_timeout parameter. By default, the number of unsuccessful attempts is set to 1. The zero value disables the accounting of attempts. What is considered an unsuccessful attempt is defined by the proxy_next_upstream, fastcgi_next_upstream, uwsgi_next_upstream, scgi_next_upstream, memcached_next_upstream, and grpc_next_upstream directives.</p>
</li>
<li><p>fail_timeout&#x3D;time<br>sets the time during which the specified number of unsuccessful attempts to communicate with the server should happen to consider the server unavailable;<br>and the period of time the server will be considered unavailable.<br>By default, the parameter is set to 10 seconds.</p>
</li>
</ul>
<p>nginx默认使用轮询机制请求server group中服务，通过<code>max_fails</code>和<code>fail_timeout</code>两个参数控制<code>upstream</code>下的服务是否可用。<br>这个两个参数表示在<code>fail_timeout</code>时间内，一个服务累计的失败次数超过<code>max_fails</code>，则这个服务在接一下来的<code>fail_timeout</code>时间内不可用。<br><code>max_fails</code>默认值为1，设置为0表示不限制。<code>fail_timeout</code>默认值为10，即默认一个服务在10s内失败一次，则在接一下来的10s内，这个服务将变为不可用。</p>
<p>当server group中的一个server请求失败时，nginx的会进行失败重试，参见<code>proxy_next_upstream</code>模块。</p>
<h1 id="五、proxy-next-upstream"><a href="#五、proxy-next-upstream" class="headerlink" title="五、proxy_next_upstream"></a>五、<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_next_upstream">proxy_next_upstream</a></h1><blockquote>
<p>Syntax:	proxy_next_upstream error | timeout | invalid_header | http_500 | http_502 | http_503 | http_504 | http_403 | http_404 | http_429 | non_idempotent | off …;<br>Default:	<br>proxy_next_upstream error timeout;<br>Context:	http, server, location</p>
</blockquote>
<p>Specifies in which cases a request should be passed to the next server:</p>
<ul>
<li>error<br>an error occurred while establishing a connection with the server, passing a request to it, or reading the response header;</li>
<li>timeout<br>a timeout has occurred while establishing a connection with the server, passing a request to it, or reading the response header;</li>
</ul>
<p>One should bear in mind that passing a request to the next server is only possible if nothing has been sent to a client yet. That is, if an error or timeout occurs in the middle of the transferring of a response, fixing this is impossible.</p>
<p>The directive also defines what is considered an unsuccessful attempt of communication with a server. The cases of error, timeout and invalid_header are always considered unsuccessful attempts, even if they are not specified in the directive. The cases of http_500, http_502, http_503, http_504, and http_429 are considered unsuccessful attempts only if they are specified in the directive. The cases of http_403 and http_404 are never considered unsuccessful attempts.</p>
<p>根据上述说明nginx遇到<code>error</code>、<code>timeout</code>等错误时，会下一个server进行重试。我们之前遇到的请求的ipv6的错误属于<code>errror</code>情况，nignx会进行重试。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>根据上述说明，我们对域名地址进行反向代理时，域名解析后的地址会被转为一个<code>upstream</code>的server group，并以轮询的方式进行访问；我们可以通过配置<code>resolver</code>来设置域名解析服务器地址、同时可以关闭ipv6的解析；<br>nginx对server group中的server进行访问时，会根据<code>max_fails</code>和<code>fail_timeout</code>连个参数判断服务是否可用，在server请求失败后，会根据错误类型判断是否使用下一个server进行失败重试。</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass">Nginx官网——proxy_pass</a><br><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_core_module.html#resolver">Nginx官网——resolver</a><br><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_upstream_module.html">Nginx官网——upstream</a><br><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_next_upstream">Nginx官网——proxy_next_upstream</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://www.mpoom.cn">逐光</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://www.mpoom.cn/2021/04/26/nginx/nginx-fu-zai-jun-heng-shi-bai-chong-shi/">https://www.mpoom.cn/2021/04/26/nginx/nginx-fu-zai-jun-heng-shi-bai-chong-shi/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://www.mpoom.cn" target="_blank">逐光の博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Nginx/">Nginx</a></div><div class="post-share"><div class="social-share" data-image="/2021/04/26/nginx/nginx-fu-zai-jun-heng-shi-bai-chong-shi/cover.jpg" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2021/05/30/book/ren-jian-shi-ge/" title="《人间失格》"><img class="cover" src="/images/%E4%BA%BA%E9%97%B4%E5%A4%B1%E6%A0%BC.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">《人间失格》</div></div><div class="info-2"><div class="info-item-1"> 简介《人间失格》 —— “无赖派”文学大师太宰治饱受争议的破灭之书  [日]太宰治 —— 著杨伟 —— 译  之前并不了解太宰治，是被书名吸引的才开始读的。在了解到作者的过往经历后，对这本的书的兴趣愈发浓厚。 太宰治的一生充满的传奇色彩，他出身豪门，一生立志文学，师从井伏鳟二等小说名家；大学时代曾积极投身左翼运动，却中途逃脱；生活放荡不羁，却热心于阅读《圣经》；五度自杀，四度殉情未遂，三十九岁时与最后一位情人投水自尽。以至于他说”回收往昔，我的人生充斥着耻辱”（《人间失格》），”生而为人，对不起”（《二十世纪旗手》），”上帝选民的不安与恍惚俱存于吾身”（《叶》）。这些格言式的短语七号成了太宰治人生和文学的最好注脚，也从某个角度勾勒除了他一生的心理轨迹。 《人间失格》一书中的主人公大庭叶藏通过「扮丑」逗笑周围人的来进行「自我救赎」。但是最终承受不住这样的压抑和无奈，在同学堀木的影响下一步一步走向堕落，利用酒精和毒品麻醉神经，用女性的肉体安抚自身的肉体，依靠女人维系基本生活。 太宰治以”私小说”的方式，将自己的一生的投影都折射在叶藏身上。  读完这本书后，内心仿佛有什么东西被触动了...</div></div></div></a><a class="pagination-related" href="/2021/04/11/book/huo-chu-sheng-ming-de-yi-yi/" title="《活出生命的意义》"><img class="cover" src="/images/%E6%B4%BB%E5%87%BA%E7%94%9F%E5%91%BD%E7%9A%84%E6%84%8F%E4%B9%89.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">《活出生命的意义》</div></div><div class="info-2"><div class="info-item-1">《活出生命的意义》（Man’s Search for Meaning）—— 借着意义的寻找，将自己超拔出来去重新爱。 简介《活出生命的意义》（Man’s Search for Meaning）  [美]维克多·弗兰克尔 —— 著吕娜 —— 译  著名的心里学家弗兰克尔是20世纪的一个奇迹。纳粹时期，作为犹太人，他的全家都被关进奥斯维辛集中营，他的父母、妻子、哥哥全都死于毒气室中，只有他和妹妹幸存。弗兰克尔不但超越了这炼狱半的痛苦,更将自己的经验与学术结合，开创了意义疗法，替人们找到绝处再生的意义，也留下了人性史上最富光彩的见证。 弗兰克尔一生对生命充满了极大的热情，67岁仍开始学习驾驶飞机，并在几个月后领到驾照。一直到80岁还登上了阿尔卑斯山。这《活出生命的意义》曾经感动千千万万的人，它被美国国会图书馆评选为具有影响力的十本著作之一。到今天，这部作品销售已达1200万册，被翻译成24种语言。他并不是当年集中营里被编号为119104的待决囚徒，而是让人的可能性得以扩大的圣者。 原文摘录这本书主要分为两个部分，书的第一部分是自传部分（集中营的经历），第二部分是理论部分（存在意义分析治...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2020/08/04/nginx/nginx-dai-li-pei-zhi-zhong-de-dns-huan-cun-wen-ti/" title="Nginx代理配置中的DNS缓存问题"><img class="cover" src="/2020/08/04/nginx/nginx-dai-li-pei-zhi-zhong-de-dns-huan-cun-wen-ti/dns%E8%A7%A3%E6%9E%90.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-08-04</div><div class="info-item-2">Nginx代理配置中的DNS缓存问题</div></div><div class="info-2"><div class="info-item-1">一、问题背景客户内网环境不允许应用服务器直接访问外网，必须通过跳板机访问外网，所在使用Nginx代理访问外网，部署架构图可参考Nginx反向代理HTTP header自定义参数丢失问题。在部署完成后，测试代理接口都正常，但是一段时间过后，就出现了外网接口访问超时的问题。 二、问题排查Nginx代理的外网接口都是通过域名进行访问，发现请求超时后，直接在服务器上ping请求地址中的域名，发现域名是可以ping通的，后面继续观察请求超时的情况，发现每次出现请求超时时，在服务器都是能直接ping通请求中的域名，但是服务器每次ping命令解析后的IP与上一次不同，在服务器则无法ping通上次解析后的IP，所以怀疑是不是Nginx缓存了DNS解析。通过查阅文档，发现Nginx在启动时会检查域名是否能够解析，在第一次请求时会缓存DNS解析记录，并且忽略了DNS中的TTL值永久缓存。  注意：在使用Nginx进行反向代理时，如果配置的是域名，突然出现了404问题时，可以查看域名绑定的IP是否发生了变更，如果这种变更不频繁，可以重启Nginx解决，重启Nginx后域名会重新进行解析。  三、问题分...</div></div></div></a><a class="pagination-related" href="/2020/07/13/nginx/nginx-fan-xiang-dai-li-404-wen-ti/" title="Nginx反向代理404问题"><img class="cover" src="/2020/07/13/nginx/nginx-fan-xiang-dai-li-404-wen-ti/cover.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-13</div><div class="info-item-2">Nginx反向代理404问题</div></div><div class="info-2"><div class="info-item-1">一、问题背景   在测试web应用的时候，前端需要进行跨域访问后端接口，由于服务端跨域访问功能不完善，所以打算通过反向代理临时解决跨域问题，但是反向代理配置成功后，访问时浏览器端返回404，在nginx的访问日志中也提示404，Nginx配置如下。 1.1 Nginx反向代理配置server &#123;     listen     80;     server_name h5-verify.mpoom.cn;     location / &#123;         proxy_set_header Host $http_host;         proxy_set_header X-Real-IP $remote_addr;         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;          proxy_pass http://127.0.0.1:8000;     &#125; &#125;  server &#123;     listen       8000;     ser...</div></div></div></a><a class="pagination-related" href="/2020/07/31/nginx/nginx-fan-xiang-dai-li-http-de-header-zi-ding-yi-can-shu-diu-shi-wen-ti/" title="Nginx反向代理HTTP header自定义参数丢失问题"><img class="cover" src="/2020/07/31/nginx/nginx-fan-xiang-dai-li-http-de-header-zi-ding-yi-can-shu-diu-shi-wen-ti/nginx_proxy_pass_architecture_diagram.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-31</div><div class="info-item-2">Nginx反向代理HTTP header自定义参数丢失问题</div></div><div class="info-2"><div class="info-item-1">一、问题背景客户内网服务器不能直接访问外网，需要通过一台跳板机才能访问外网，在跳板机安装Nginx反向代理外网接口服务，架构图如下：代理设置完成后，在联调过程中请求外网接口返回参数错误，但是外网环境下不经过Nginx代理直接访问外网接口则能正常访问，说明在经过Nginx代理时，部分参数丢失了。 二、问题排查根据接口报错，定位到是HTTPheader中的一个自定义参数client_id参数经过Nginx代理时没有转发出去,问题出现在Nginx代理上。  Nginx主配置文件nginx.conf内容如下  user  root; worker_processes  1;  error_log  logs&#x2F;error.log; error_log  logs&#x2F;error.log  notice; error_log  logs&#x2F;error.log  info;  pid        logs&#x2F;nginx.pid;   events &#123;     worker_connections  1024; &#125;   http &#123;...</div></div></div></a><a class="pagination-related" href="/2020/05/24/nginx/nginx-chi-xian-an-zhuang/" title="Nginx离线安装"><img class="cover" src="/2020/05/24/nginx/nginx-chi-xian-an-zhuang/gcc-requires.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-05-24</div><div class="info-item-2">Nginx离线安装</div></div><div class="info-2"><div class="info-item-1">一、概览 服务器无法访问外网的情况下，Nginx只能离线安装，安装主要步骤如下：   安装gcc、g++ 安装pcre、zlib 安装nginx  二、安装gcc、g++gcc --version g++ --version  使用gcc --version g++ --version查看服务器是否已经安装过gcc、g++。 2.1 下载如果未安装，请下载gcc、**g++**及其依赖包进行安装，下面为Centos7 x86_64下 gcc 与 **g++ ** 4.8.5的依赖包:  gcc依赖包详见:gcc-4.8.5-39.el7.x86_64.rpm     g++依赖包详见：gcc-c++-4.8.5-39.el7.x86_64.rpm   根据上述依赖包列表下载安装包，下载地址：Centos Mirrors 、 阿里云 、网易,下载后的依赖包如下图所示：  上述安装包已分享至天翼云盘gcc g++ rpm安装包  注意 上图下载的依赖包有一些是gcc g++依赖包列表中不存在的，是因为那部分安装包是gcc g++ 依赖包的依赖包，这里参考网上下载了缺少的一些包  2....</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF"><span class="toc-number">1.</span> <span class="toc-text">一、问题背景</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81proxy-pass"><span class="toc-number">2.</span> <span class="toc-text">二、proxy_pass</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81resolver"><span class="toc-number">3.</span> <span class="toc-text">三、resolver</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81upstream"><span class="toc-number">4.</span> <span class="toc-text">四、upstream</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81proxy-next-upstream"><span class="toc-number">5.</span> <span class="toc-text">五、proxy_next_upstream</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">6.</span> <span class="toc-text">总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">6.1.</span> <span class="toc-text">参考文章</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2017 - 2026 By 逐光</span></div><div class="footer_custom_text"><div class="icp"><span><img src="/images/theme/icp_icon.png"/><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/#/Integrated/index">陕ICP备19021337号-1</span></a></div></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.3"></script><script src="/js/main.js?v=5.5.3"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const config = mermaidSrc.dataset.config ? JSON.parse(mermaidSrc.dataset.config) : {}
      if (!config.theme) {
        config.theme = theme
      }
      const mermaidThemeConfig = `%%{init: ${JSON.stringify(config)}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@11.12.2/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const initValine = (el, path) => {
    if (isShuoshuo) {
      window.shuoshuoComment.destroyValine = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    const valineConfig = {
      el: '#vcomment',
      appId: 'f5WSKiyRgMriw1qIicgn1Dbu-gzGzoHsz',
      appKey: 'c9Jx92rNNJ0RzzaxLNCqu4rR',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      visitor: false,
      ...option,
      path: isShuoshuo ? path : (option && option.path) || window.location.pathname
    }

    new Valine(valineConfig)
  }

  const loadValine = async (el, path) => {
    if (typeof Valine === 'function') {
      initValine(el, path)
    } else {
      await btf.getScript('https://cdn.jsdelivr.net/npm/valine@1.5.3/dist/Valine.min.js')
      initValine(el, path)
    }
  }

  if (isShuoshuo) {
    'Valine' === 'Valine'
      ? window.shuoshuoComment = { loadComment: loadValine }
      : window.loadOtherComment = loadValine
    return
  }

  if ('Valine' === 'Valine' || !true) {
    if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script></div><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>